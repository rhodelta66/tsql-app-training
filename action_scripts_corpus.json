{
    "metadata": {
        "source": "init_full_run",
        "last_updated": "2025-05-25T00:38:11.732227"
    },
    "scripts": [
        {
            "sql_source": "--RH210215 BEZIG DOWNLOAD ALS CSV ER BIJ.. lukt nofg niet..\nDECLARE @date nvarchar(128),@date2 nvarchar(128),@button nvarchar(128),@button2 nvarchar(128),@companyname nvarchar(128), @FileName nvarchar(128)\nset @date = dbo.workDate()\nset @date2 = dbo.workDate()\nSET @companyname = (select CompanyName from xcompany where id = @id)\nset @Filename=concat(@Companyname,'.csv')\n/*EXEC sp_api_modal_text 'Zoek op transport bedrijf'\nEXEC sp_api_modal_input @name='Transporteur',@value = @TransComp OUT,@focus=1,@select=1 -- zoek veld\n*/\nEXEC sp_api_modal_text 'Van:'\nEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-24',@focus=1,@select=1  -- zoek veld\nEXEC sp_api_modal_text 'Tot en met:'\nEXEC sp_api_modal_date @name='Date2',@value = @date2 OUT,@class='w-24' -- zoek veld\n--SET @date2 = CONCAT(@date2,' 23:59:59.999')\nSET @button = 'Intrastat_Melding'\nEXEC sp_api_modal_button @name='button',@value = 'Intrastat_Melding',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\nEXEC sp_api_modal_button @name='button',@value = 'Excel_CSV',@valueout = @button OUT,@class = 'btn-primary',@key = 'F5'\nEXEC sp_api_modal_text @companyname,N'h4 text-muted',@printonly=1\nEXEC sp_api_modal_print\n\nIF @button =  'Intrastat_Melding'\nBEGIN\nSELECT distinct [QUANTITY@] = sum(QUANTITY@), [ARTICLE~col-sm-5] = ARTICLE, LAND, INTRASTAT_CODE, [NETT_WEIGHT@] = sum(NETT_WEIGHT@), ISO, [AMOUNT@] = sum(AMOUNT@)\nINTO #Intrastat_Melding\nFROM          RV_INTRASTAT_MELDING\nWHERE\t\t(INTRASTAT_CODE is not NULL) AND (CompanyID = @id) AND (TransactionDate BETWEEN @date AND @date2) AND (THTDT = 2)\nGROUP BY ARTICLE,LAND,INTRASTAT_CODE,ISO\nEXEC sp_api_modal_table @tmptable=N'#Intrastat_Melding',@orderby=N'ORDER BY 2 ASC',@print=1\n\nEND \n\t\n\nIF @button =  'Excel_CSV'\nBEGIN\nSELECT distinct [QUANTITY] = sum(QUANTITY@), [ARTICLE] = ARTICLE, LAND, INTRASTAT_CODE, [NETT_WEIGHT] = sum(NETT_WEIGHT@), ISO, [AMOUNT] = sum(AMOUNT@)\nINTO #Intrastat_CSV\nFROM          RV_INTRASTAT_MELDING\nWHERE\t\t(INTRASTAT_CODE is not NULL) AND (CompanyID = @id) AND (TransactionDate BETWEEN @date AND @date2) AND (THTDT = 2)\nGROUP BY ARTICLE,LAND,INTRASTAT_CODE,ISO\n--EXEC sp_api_modal_table @tmptable=N'#Intrastat_CSV',@print=1\n--EXEC sp_api_modal_csv\t@tmptable = '#Intrastat_CSV'\t,@filename = @filename\t,@sep = ';'\n\n--EXEC sp_api_modal_table @tmptable=N'#Intrastat_CSV'\nEXEC sp_api_modal_csv @tmptable=N'#Intrastat_CSV',@ansi =1,@filename=@FileName\n\nEND \n\n\n\n\n\n\n\n",
            "action_id": 1,
            "action_name": "INTRASTAT_MELDING",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.cthFase @ID, N'closedSaleReadyForInvoice'",
            "action_id": 2,
            "action_name": "klaar voor facturatie",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.cthFase @ID, N'closedSaleReadyForInvoice'",
            "action_id": 3,
            "action_name": "klaar voor facturatie",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @MES NVARCHAR(200)\r\nSET @MES=concat(N'Verloop van de koers ',{[currency].CodeISO})\r\nif @MES IS NULL SET @MES=concat(N'Verloop van de waarde ''',{[xvalrate].code},''' voor ',(select companyname from xCompany where id={[xvalrate].contextID}))\r\nEXEC sp_api_modal_text @text = @MES,@class = 'h3 text-muted'\r\nSELECT TOP 100 code as [code*],startdate, enddate,f as [koers] INTO #table1 FROM xValrate where code={[xvalrate].code} and contextID={[xvalrate].contextID}\r\nEXEC sp_api_modal_table @tmptable=N'#table1'\r\n",
            "action_id": 4,
            "action_name": "koerslijst",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.[dbo].[Create_CTR_ForOwnNegativeStock] @ID",
            "action_id": 5,
            "action_name": "Koop alles (neg)",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @clone_id INT, @sure nvarchar(255), @text nvarchar(255)\r\nEXEC sp_api_modal_get N'my_last_clone_id',@text OUT\r\nEXEC sp_api_modal_text @text,'h1'\r\nEXEC sp_api_modal_text @basetable,'h1'\r\nEXEC sp_api_modal_button @name='Sure',@value = 'Clone? (Esc=Nee)', @valueout = @sure OUT,@class='btn-danger',@key='Enter'\r\nIF @sure is not null\r\n\tBEGIN\r\n\t\tEXEC sp_api_modal_clear\r\n\t\t--EXEC @clone_id = sp_clone_record @basetable,@ids\r\n\t\tEXEC @clone_id = sp_clone_record @basetable,@ids,N'size=''EDIT'', stock=0'\r\n\t\tSET @path = @path+'/'+dbo.nv(@clone_id)\r\n\t\tEXEC sp_api_toast @text = N'Record cloned'\r\n\t\tEXEC sp_api_modal_route @name = N'Ga met Enter naar de kopie en vul de nieuwe maat in',@pathname=@path,@search='?focus=7377' ,@class = N'btn-danger' ,@key='Enter'\r\n\tEND\r\n",
            "action_id": 6,
            "action_name": "kopieer-artikel",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast N'leveringsbevestiging....' \n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\t--dit is nu alleen voor tellers en checks, zodat we weten dat het report al is gemaakt:\n\t\t--was\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'CTH'\t,@Context_Key_ID=@cid,@Report_CODE=N'CONF_DELIVERY' -- zie runreport \n\t\t--nu\n\t\tEXEC @main_db.dbo.SetDelConf @cid --210224 Registreer verzending van DeliveryConfirmation via xMarker\n\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select Counterparty_id from xtransactionheader where id=@cid)\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = 'deliveryconfirmation_out' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@fixedprinter_ID=2\n\t\t\t,@test=0\n\n\n\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 12,
            "action_name": "leveringsbevestiging",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @wat nvarchar(200), @linktoME int,@text nvarchar(max)\n\nIF {[ctr2].cth_fase} NOT IN (N'openSale','openPrice')\n\tBEGIN\n\tEXEC sp_api_modal_Alert N'Let op!', N'De verkoop is reeds gesloten. U kan niet meer de toewijzing wijzigen.' \n\tEXEC sp_api_modal_clear\n\tRETURN\n\tEND\n\nSET @linktoME ={[ctr2].id}\n--201028 erbij ivm overbrengen..\nif @LinkToMe is NULL set @LinkToMe={[ctr_overbrengen].id}\n\nDECLARE @maxTeLinken INT,@maxBeschikbaar INT\nSELECT @maxTeLinken = (ctrAmount-IVTOTAL) FROM Q_xTransactionDetail WHERE ID=@LinkToME\n\nIF @maxTeLinken = 0\n\tBEGIN\n\t\tEXEC sp_api_modal_alert N'Regel is al volledig toegewezen'\n\t\tEXEC\t sp_api_go2 1 -- 1 stap terug (+list view; detailviewgebruik EXEC sp_api_go2 1,0)\n\t\tRETURN;\n\tEND\n\n\nSET @maxBeschikbaar = {[ctr1_toewijsbaar].available}\nIF @maxBeschikbaar < @maxTeLinken\n\tBEGIN\n\t\tdeclare @Melding nvarchar(200)\n\t\tset @Melding = concat(N'Niet genoeg beschikbaar! Te linken:',N' ',@maxTeLinken)\n\t\tEXEC sp_api_modal_text @Melding,N'h4 text-muted'\n\t\tSET @text = CONCAT('U kunt maximaal ',@maxBeschikbaar,' van de ',@maxTeLinken,' linken')\n\t\tEXEC sp_api_modal_text @text,N'm-4'\n\t\tSET @maxTeLinken = @maxBeschikbaar\n\tEND\n\nIF @maxTeLinken < 0\n\tBEGIN\n\t\tEXEC sp_api_modal_alert N'Probleem!',N'Regel heeft meer toegewezen dan mag. Ga naar de toewijzing (IV link) en verlaag deze.'\n\t\tEXEC sp_api_modal_clear\n\tEND\n\nDECLARE @aantalTeLinken INT = @maxTeLinken\n\t,@button nvarchar(50)\n\nEXEC sp_api_modal_input @name='Aantal',@value = @aantalTeLinken OUT,@focus=1,@select=1\nEXEC sp_api_modal_button @name='button',@value = 'Link aantal',@valueout=@button OUT,@key=N'Enter'\nIF @button IS NULL RETURN\nset @wat=N'Gekozen ID: '+str(@ID)+' wordt gekoppeld aan CTR: '+str(@LinktoME)\nexec sp_api_toast @wat\n--RETURN; --test\n\nif @linktoME is not null\n\tBEGIN\n\t\texec @main_db.dbo.map @linktoME,@ID, @aantalTeLinken\n\t\t\n\t\t--zet return path\n\t\tSET @ctr2_id = {[ctr2].id}\n\t\tSET @verkoop_id = {[verkoop].id}\n\t\tIF @ctr2_id IS NOT NULL AND @verkoop_id IS NOT NULL AND @aantalTeLinken = @maxTeLinken\n\t\t\tBEGIN\n\t\t\t\tSET @goto = CONCAT('/verkoop/',@verkoop_id,'/ctr2/',@ctr2_id,'/iv2')\n\t\t\t\tSET @referer_path = CONCAT('/verkoop/',@verkoop_id,'/ctr2')\n\t\t\t\tSET @referer_search = CONCAT(N'?id=',@ctr2_id)\n\t\t\t\tEXEC sp_api_toast N'Regel(s) is/zijn gelink bla',N'alert-primary'\t\t\t\t\n\t\t\t\tEXEC sp_api_goto @goto,@referer_path=@referer_path,@referer_search=@referer_search\n\t\t\tEND\n\t\t--210115 \n--\t\texec sp_api_go3\n\t\texec sp_api_modal_clear\n\tEND\n\n\n--if @parent_card_name='ctr2'\n--\tBEGIN\n--\t\texec @main_db.dbo.map @ID, @Parent_ID\n--\tEND\n--else --neem aan parent_parent...\n--\tBEGIN\n--\t\texec @main_db.dbo.map @ID, @Parent_Parent_ID\n--\tEND\n\n--EXEC sp_api_goto @path",
            "action_id": 13,
            "action_name": "link_this",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_text @ids",
            "action_id": 14,
            "action_name": "LinkActionGroterDan",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @ctrtoloc int, @ctrfromloc int ,@checkamt int-- (oorspronkelijke) advieslokaties\ndeclare @Direct int=1\ndeclare @Normaal int=2\ndeclare @isEqual bit=0\n\nselect @ctrtoloc =tocloc_id, @ctrfromloc=frmloc_id,@checkamt=iif(stockmut=1,amount,0) from xtransactiondetail where id=@ID\nupdate xtransactiondetail set Flowmodel_id=@Normaal where id=@ID\nupdate xlfctr set ltrtoloc=@ctrtoloc,ltrfromloc=@ctrfromloc, @isEqual=iif(lfctr_amount-@checkamt=0,1,0) where ctr_id=@ID and lfctr_amount=@checkamt -- let op: dit gaat alleen goed bij volledige ctr op lfctr!\n\n\nif @isEqual=1 begin\n\t--pas ook de lfctr aan van de aan deze inkoopregel gelinkte verkoopregels\n\tDECLARE @cursor_ids CURSOR,@cid INT\n\tSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR (select ITD as ivCTR from xivlink where vtd=@ID UNION select VTD as ivCTR from xivlink where itd=@ID) --SELECT value FROM string_split(@ids,',')\n\tOPEN @cursor_ids;\n\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tWHILE @@FETCH_STATUS = 0\n\t\tBEGIN\n\t\t\t--geef de lfctr van de verkoop ctr een nieuwe laadlokatie\n\t\t\tupdate xtransactiondetail set Flowmodel_id=@Normaal where id=@cid\n\t\t\tupdate xlfctr set ltrfromloc=@ctrtoloc where ctr_id=@cid\n\t\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\t\tEND\n\tCLOSE @cursor_ids;\n\tDEALLOCATE @cursor_ids;\n\nend",
            "action_id": 16,
            "action_name": "Loods Verlading (normaal)",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "update xlandfreight SET transport_id = NULL WHERE id ={[xlandfreight].id}",
            "action_id": 17,
            "action_name": "Maak Los Van Transport",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC @main_db.dbo.UndoUnloading_LP @xLotPallet_ID=@ID ",
            "action_id": 18,
            "action_name": "Maak Uitlossing Ongedaan",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "SET @path = REPLACE(@path,'/lotpallets','/lotartsize')\r\nEXEC sp_api_goto @path\r\n",
            "action_id": 19,
            "action_name": "maten",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @VerkoopPath nvarchar(200) \nSET @VerkoopPath=concat(N'/verkoop/',{[verkoop].id},N'/ctr2')\nEXEC SP_API_GOTO @VerkoopPath",
            "action_id": 26,
            "action_name": "naar CTR",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "SELECT * INTO #globecsv FROM calc_exact_globe_csv WHERE datum IS NOT NULL ORDER BY factuurnum,dagboek,regel\nEXEC sp_api_modal_csv @tmptable=N'#globecsv',@ansi =1,@filename=N'exact_globe.csv',@orderby=N'ORDER BY factuurnum,dagboek,regel'",
            "action_id": 27,
            "action_name": "Naar ExactGlobe CSV_voor210112",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "\nIF @id<>@ids --BULK naar Exact\n\tBEGIN\n\t\tDECLARE @cursor CURSOR,@idval INT,@count int = 0,@seconds int = 0\n\t\tSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\n\t\tOPEN @cursor;\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\n\t\t\t\tSET @seconds+=6\n\t\t\t\tSET @subject = CONCAT(\n\t\t\t\t\t(SELECT [xCompany].[Code] FROM [xCompany] WHERE [id] = (SELECT [Q_xInvoice].[fromCompany_ID] FROM [Q_xInvoice] WHERE [id] = @idval))\n\t\t\t\t\t,' - ',(SELECT [Q_xInvoice].[dateInvoice] FROM [Q_xInvoice] WHERE [id] = @idval)\n\t\t\t\t\t,' - ',(SELECT [Q_xInvoice].[calcLegal] FROM [Q_xInvoice] WHERE [id] = @idval)\n\t\t\t\t\t)\n\t\t\t\tSET @sql = CONCAT(N'DECLARE @base64 nvarchar(max),@filename nvarchar(4000)\n', --EXEC sp_api_report_download_base64 @context = ''invoice_out'', @context_id = ',@idval,' , @filename =  @filename OUT, @base64 =  @base64 OUT\n'BEGIN TRY\n\tEXEC @main_db.dbo.sp_iu_finance_invoice ',@idval,',@groupbycostcodes = 1\nEND TRY BEGIN CATCH\n\tUPDATE xInvoice SET status = ''Exact Error'',statusHistory = ERROR_MESSAGE() WHERE id = ',@idval,'\nEND CATCH') -- = @filename,@subject = ',dbo.escape_string(@subject),',@base64 = @base64')\n\t\t\t\tSET @subject = N'To Exact: ' + @subject\n\t\t\t\tEXEC sp_api_add_sql_task @sql=@sql,@description=@subject,@seconds = @seconds\n\t\t\t\tUPDATE xInvoice SET status='Sending to Exact' WHERE id = @idval\n\t\t\t\tSET @count+=1\n\t\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\tEND\n\t\tCLOSE @cursor;\n\t\tDEALLOCATE @cursor;\n\t\texecute sp_api_modal_clear\n\t\tIF @count > 0 EXEC sp_api_toast N'Verzenden is ingepland, F5 voor refresh'\n\t\tEXEC sp_api_modal_select_all_clear\n\t\tRETURN\n\tEND\n\nBEGIN TRY\n\tEXEC @main_db.dbo.sp_iu_finance_invoice @id, @groupbycostcodes = 1\nEND TRY BEGIN CATCH\n\tDECLARE @text nvarchar(max) = ERROR_MESSAGE(),@ERROR_SEVERITY int = ERROR_SEVERITY()\n\tIF @ERROR_SEVERITY = 17\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_url @text\n\t\t\tRETURN\n\t\tEND\n\tEXEC sp_api_modal_text @text\n\tDECLARE @valueout nvarchar(128)\n\tEXEC sp_api_modal_button @name='Retry',@value = 'Retry', @valueout = @valueout OUT\n\t\t,@class='btn-primary',@key='Enter'\nEND CATCH",
            "action_id": 28,
            "action_name": "Naar ExactOnline",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "\nIF @id<>@ids --BULK naar Exact\n\tBEGIN\n\t\tDECLARE @cursor CURSOR,@idval INT,@count int = 0,@seconds int = 0\n\t\tSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\n\t\tOPEN @cursor;\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\n\t\t\t\tSET @seconds+=6\n\t\t\t\tSET @subject = CONCAT(\n\t\t\t\t\t(SELECT [xCompany].[Code] FROM [xCompany] WHERE [id] = (SELECT [Q_xInvoice].[toCompany_ID] FROM [Q_xInvoice] WHERE [id] = @idval))\n\t\t\t\t\t,' - ',(SELECT [Q_xInvoice].[dateInvoice] FROM [Q_xInvoice] WHERE [id] = @idval)\n\t\t\t\t\t,' - ',(SELECT [Q_xInvoice].[calcLegal] FROM [Q_xInvoice] WHERE [id] = @idval)\n\t\t\t\t\t)\n\t\t\t\tSET @sql = CONCAT(N'DECLARE @base64 nvarchar(max),@filename nvarchar(4000)\n', --EXEC sp_api_report_download_base64 @context = ''invoice_out'', @context_id = ',@idval,' , @filename =  @filename OUT, @base64 =  @base64 OUT\n'BEGIN TRY\n\tEXEC @main_db.dbo.sp_iu_finance_invoice ',@idval,',@groupbycostcodes = 1\nEND TRY BEGIN CATCH\n\tUPDATE xInvoice SET status = ''Exact Error'',statusHistory = ERROR_MESSAGE() WHERE id = ',@idval,'\nEND CATCH') -- = @filename,@subject = ',dbo.escape_string(@subject),',@base64 = @base64')\n\t\t\t\tSET @subject = N'To Exact: ' + @subject\n\t\t\t\tEXEC sp_api_add_sql_task @sql=@sql,@description=@subject,@seconds = @seconds\n\t\t\t\tUPDATE xInvoice SET status='Sending to Exact' WHERE id = @idval\n\t\t\t\tSET @count+=1\n\t\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\tEND\n\t\tCLOSE @cursor;\n\t\tDEALLOCATE @cursor;\n\t\texecute sp_api_modal_clear\n\t\tIF @count > 0 EXEC sp_api_toast N'Verzenden is ingepland, F5 voor refresh'\n\t\tEXEC sp_api_modal_select_all_clear\n\t\tRETURN\n\tEND\n\nBEGIN TRY\n\tEXEC @main_db.dbo.sp_iu_finance_invoice @id, @groupbycostcodes = 1\nEND TRY BEGIN CATCH\n\tDECLARE @text nvarchar(max) = ERROR_MESSAGE(),@ERROR_SEVERITY int = ERROR_SEVERITY()\n\tIF @ERROR_SEVERITY = 17\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_url @text\n\t\t\tRETURN\n\t\tEND\n\tEXEC sp_api_modal_text @text\n\tDECLARE @valueout nvarchar(128)\n\tEXEC sp_api_modal_button @name='Retry',@value = 'Retry', @valueout = @valueout OUT\n\t\t,@class='btn-primary',@key='Enter'\nEND CATCH",
            "action_id": 29,
            "action_name": "Naar ExactOnline",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @S nvarchar(200), @P nvarchar(200)\r\nSET @P =N'/invoice'\r\nSET @S=concat(N'?id=',{[xinvcth].invoice_id})\r\n--EXEC sp_api_toast @S22\r\nEXEC sp_api_goto  @P, @S",
            "action_id": 30,
            "action_name": "naar Factuur",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @invoice_id nvarchar(40) = (SELECT TOP 1 invoice_id FROM xinvrow WHERE cth_id = @id)\nIF @invoice_id IS NULL\n\tEXEC sp_api_toast N'Geen invoice gevonden'\nELSE\n\tBEGIN\n\t\tSET @invoice_id = N'?id=' + @invoice_id\n\t\tEXEC sp_api_goto N'/invoice',@invoice_id\n\tEND",
            "action_id": 31,
            "action_name": "Naar factuur",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @invoice_id nvarchar(40) = (SELECT TOP 1 invoice_id FROM xinvrow WHERE cth_id = @id)\r\nIF @invoice_id IS NULL\r\n\tEXEC sp_api_toast N'Geen invoice gevonden'\r\nELSE\r\n\tBEGIN\r\n\t\tSET @invoice_id = N'?id=' + @invoice_id\r\n\t\tEXEC sp_api_goto N'/invoice',@invoice_id\r\n\tEND",
            "action_id": 32,
            "action_name": "Naar factuur van de order",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @LF int = {[xlandfreight].id}\nif @LF is null\n\tbegin\n\t\texec sp_api_toast N'Er is geen landvracht om op te boeken'\n\t\treturn;\n\tend\n\nDECLARE @mes nvarchar(200), @aantal nvarchar(20) --='100'\nset @Mes =N'Overnemen van een (deel van) de vracht'\n\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\nEXEC sp_api_modal_text 'Aantal'\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1\n\nDECLARE @button nvarchar(128)\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\nIF @button IS NOT NULL\n\tBEGIN\n\t\tIF \tTRY_CAST(@aantal as int) >\t 0 \n\t\t\tBEGIN\n\n\t\t\t\texec @main_db.dbo.ExtraVracht_lfctr @LFCTR_ID=@ID ,@Landfreight_ID=@LF ,@TransferAmount=@Aantal\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\tRETURN\n\t\t\tEND\n\t\tELSE\n\t\t\tEXEC sp_api_modal_text 'Aantal is niet geldig!','text-danger'\n\tEND\n",
            "action_id": 34,
            "action_name": "Neem over",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--EXEC sp_api_toast @parent_parent_id\r\n--exec sp_api_toast @User\r\n\t\r\nDECLARE @CTHID INT = {[ompakken].id} --200818 curly\r\nIF @CTHID IS NULL begin\r\n\t\tEXEC sp_api_toast 'Kan geen [ompakken2] vinden'\r\n\t\tRETURN;\r\n\t\tend\r\n--ELSE EXEC sp_api_toast @CTHID\r\n\r\nIF {[ompakken].status} not in ('openRepack') BEGIN\r\n\tEXEC sp_api_modal_alert 'Toevoegen alleen bij status: openRepack'\r\n\tEXEC sp_api_modal_clear\t\t\r\n\tRETURN;\t\r\n\tend\r\n\r\n-- 200629 Uitbreiding inkoop vanuit diverse contexten: Zoek CTH ; bijv als we afkomstig zijn van een regel, dan is CTH te vinden in de regel\r\n--if @parent_card_name ='verkoop'\tset @CTHID=@parent_id\r\n--if @parent_card_name = 'ctr2' set @CTHID=(select TransactionHeader_ID from xtransactiondetail where xtransactiondetail.id=@parent_id)\r\n\r\nDECLARE @mes nvarchar(200), @FustSaldo int, @CoreType nvarchar(10),@FustID int, @xDesc nvarchar(200)\r\nSELECT @xDesc=x.[Description],@mes= concat('Ompak in ' , x.[Description]) ,@Coretype= x.coretype,@FustID=x.Fust_ID from xstock x where x.id=@ID --@main_db.dbo.\r\n--EXEC sp_api_modal_text @mes,'h2 text-primary'\r\n------\r\nIF @coretype in('CRATE','PALLET')\r\n\tBEGIN\r\n\t\tSELECT @Fustsaldo=Fustsaldo from @main_db.dbo.FustSaldo_FC(@FustID,{[verkoop].Counterparty_ID})\r\n\t\tEXEC sp_api_toast @Fustsaldo\r\n\t\t-- breid DECLARE message uit met het fust-saldo\r\n\t\tIF @FustSaldo is not NULL\r\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') actueel saldo bij deze klant: ',@fustsaldo)\r\n\t\tELSE\r\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') => let op: deze klant heeft dit fust nooit eerder gehad!')\r\n\tEND\r\n\r\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\r\nDECLARE @aantal nvarchar(20),@opmerking nvarchar(50) --='100'\r\nDECLARE @CounterpartyID int\r\nDECLARE @FlowModel int\r\nDECLARE @THDT INT\r\nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=FlowModel_ID,@THDT=TDT From xTransactionHeader CTH where CTH.ID=@CTHID\r\n--200630 was@parent_id\r\n\r\n--200708 => ??? WAAROM GAAT DIT NIET ??? select @Prijs= @main_db.dbo.StockPrice(@ID,@CTHID,NULL,NULL,NULL,NULL,NULL,NULL,NULL)\r\n\r\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\r\nEXEC sp_api_modal_text 'Aantal'\r\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1\r\nEXEC sp_api_modal_text 'Opm. loods'\r\nEXEC sp_api_modal_input @name='opmerking',@value = @opmerking OUT\r\nDECLARE @button nvarchar(128)\r\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\r\nIF @button IS NOT NULL\r\n\tBEGIN\r\n\t\tIF \t\t--TRY_CAST(@prijs as decimal) > 0 AND \r\n\t\t\t\tTRY_CAST(@aantal as int) > 0 \r\n\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\r\n\t\t\tBEGIN\r\n\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=NULL,@Logistic=@Opmerking, @User=@User,@forcedTDT=1\r\n\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\r\n\t\t\t\texec sp_api_toast @mes\r\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\r\n\r\n\t\t\tEND\r\n\t\tELSE\r\n\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\r\n\tEND",
            "action_id": 42,
            "action_name": "SelectAmountOUT",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @CTHID INT = {[inkoop].id} --200818 curly\r\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\r\nDECLARE @aantal nvarchar(20) --='100'\r\nDECLARE @intAantal int\r\nDECLARE @MaxAantal int -- beschikbare hoeveelheid op de lokatie\r\nDECLARE @CounterpartyID int\r\nDECLARE @FlowModel int\r\nDECLARE @THDT INT\r\nDECLARE @LFID INT = {[xlandfreight].id}\r\n\r\nIF @CTHID IS NULL begin\r\n\t\tEXEC sp_api_toast 'Kan geen [inkoop] partij vinden'\r\n\t\tRETURN;\r\n\t\tend\r\nIF @LFID IS NULL begin\r\n\t\tEXEC sp_api_toast 'Kan geen landfreight vinden (moet open staan!)'\r\n\t\tRETURN;\r\n\t\tend\r\n\r\n\r\nDECLARE @mes nvarchar(200), @xDesc nvarchar(200)\r\nSELECT @maxAantal= (Amount-ivtotal)---(select stock from @main_db.dbo.RealStock(x.stock_id ,{[Xlandfreight].From_Location_ID}))\r\n\t\t,@xDesc=concat( x.[Detail],' ',x.[ExtraDetail]),@mes= concat('Overbrengen van ' , x.[Detail],' ',x.[ExtraDetail]) from Q_xtransactiondetail x where x.id=@ID \r\n\r\nset @Aantal=@maxAantal \r\n\r\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\r\nEXEC sp_api_modal_text 'Aantal'\r\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1\r\n\r\nDECLARE @button nvarchar(128)\r\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\r\n\r\nIF @button IS NOT NULL\r\n\tBEGIN\r\n\t\tset @intAantal=TRY_CAST(@aantal as int)\r\n\t\tIF\t@intAantal > 0 and @intaantal <= @maxAantal\r\n\t\t\tBEGIN\r\n\t\t\t\texec @main_db.[dbo].[Add_LFCTR_TO_LF]\t@LF_ID=@LFID,@CTR_ID =@ID ,@Amount =@intaantal\r\n\r\n\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ concat(x.[Detail],' ',x.[ExtraDetail])+' toegevoegd aan de overbrenging' from Q_xTransactiondetail x where x.id=@ID\r\n\t\t\t\texec sp_api_toast @mes\r\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\r\n\t\t\t\tRETURN\r\n\t\t\tEND\r\n\t\tELSE\r\n\t\t\tEXEC sp_api_modal_text 'Aantal is niet geldig!','text-danger'\r\n\tEND\r\n\r\n",
            "action_id": 43,
            "action_name": "Selecteer",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "\tDECLARE @ClientCode_ID INT, @GroupSubid int\r\n\t\r\n\tSELECT @ClientCode_ID = ClientCode_ID, @Groupsubid=GroupSub_ID FROM [xProduct] WHERE [id] = (SELECT id FROM #parents WHERE card_name = N'botanic')\r\n\tIF @ClientCode_ID is not null AND @GroupSubID is not NULL BEGIN\r\n--\t\tEXEC sp_api_toast N'COCO'  \t\t\t\r\n\t\tupdate xproduct SET ClientCode_ID = @ClientCode_ID WHERE ClientCode_ID is null AND GroupSub_ID=@GroupSubID\r\n\t\tEND\r\n\r\n ",
            "action_id": 44,
            "action_name": "Set ClientCode",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.xStockSetSeek\nexec sp_api_toast N'Zoekveld [Seek] is opnieuw ingesteld'",
            "action_id": 45,
            "action_name": "Set Seek Veld",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--UPDATE xTransactionHeader SET transactiondate = GETDATE() WHERE id = @id\r\nEXEC sp_api_foreach_id N'UPDATE xTransactionHeader SET advTransportDep= dbo.workdate(), transactiondate = dbo.workdate() WHERE id = @id',@ids\r\nEXEC sp_api_toast N'Today set!'",
            "action_id": 47,
            "action_name": "set to workdate",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @D DateTime\r\nSET @D={[abcCalendar].date} \r\nEXEC sp_api_modal_set N'workdate',@D",
            "action_id": 48,
            "action_name": "Set_Workdate",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "UPDATE xTransactiondetail\r\nSET TDT = 1\r\nWHERE @id = id",
            "action_id": 49,
            "action_name": "SetIN",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "UPDATE xTransactiondetail\r\nSET TDT = 2\r\nWHERE id=@id",
            "action_id": 51,
            "action_name": "SetOUT",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "/* bla bla {[verkoop].id} */\nDECLARE @cid int,@reducer nvarchar(max),@value nvarchar(128), @button nvarchar(128)\n,@from nvarchar(128) = NULL -- maar dit legt hier weer meer complexiteit neer, wat mij betreft dus allemaal om het even... als het default (=null) naar 'vansdaag' gaat is best, maar als ik ook maak blanco (= N'') kan meegeven dan.. PRIMA, mooi want dan wijzigd er niets voor bestaande boel\n\n,@to nvarchar(128) = N'' -- N'2021-01-12'--? misschien try\nSELECT @cid = id FROM api_card WHERE name = 'klant'\n\nEXEC sp_api_modal_date_from_to @from = @from OUT,@to = @to OUT\nEXEC sp_api_modal_text @from\nEXEC sp_api_modal_text @to\nEXEC sp_api_modal_button @name='Sure',@value = 'Ja', @valueout = @button OUT,@class='btn-danger',@key='Enter'\nRETURN\nEXEC sp_api_modal_select @card_name = N'country',@value = @value OUT,@focus = 1\nIF @value IS NOT NULL\n\tBEGIN\n\t\tSET @reducer = N'Country_ID = ' + @value\n\t\tEXEC sp_api_modal_table @card_id = @cid ,@reducer = @reducer --'' ,@class = 'h-auto' ,@tmptable = '#modaltable' ,@orderby = ''\n\tEND\nRETURN\nDECLARE @json nvarchar(max)\nSET @json = (SELECT * FROM fn_api_get_related_items_json_list(383,NULL))\nEXEC sp_api_modal_text @json,N'json'",
            "action_id": 53,
            "action_name": "Show Related List",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @T nvarchar(200)\r\nset @T=(select L from @main_db.dbo.[GetCompanySettings]('useDayprice'))\r\nexec sp_api_toast @T",
            "action_id": 54,
            "action_name": "showsetting",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "UPDATE xTransactionHeader SET status='closedPurchase' WHERE id IN ({@ids})\r\n/*\r\nDECLARE @currState nvarchar(50)\r\nSET @currstate = (SELECT status FROM xtransactionheader cth WHERE id=@ID)\r\nIF @currState='openPurchase'\r\n\tBEGIN\r\n\t\tupdate xtransactionheader SET status='closedPurchase' WHERE ID=@ID\r\n\tEND\r\nIF @currState='closedPurchase'\r\n\tBEGIN\r\n\t\tupdate xtransactionheader SET status='openPurchase' WHERE ID=@ID\r\n\tEND\r\n*/",
            "action_id": 55,
            "action_name": "sluit inkoop",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @CTHID INT \nDECLARE @mes nvarchar(200), @FustSaldo int, @CoreType nvarchar(10),@FustID int, @xDesc nvarchar(200)\nSELECT @xDesc=x.[Description],@mes= concat('Quick Purchase ' , x.[Description]) ,@Coretype= x.coretype,@FustID=x.Fust_ID from xstock x where x.id=@ID --@main_db.dbo.\n\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\nDECLARE @prijs nvarchar(20),@aantal nvarchar(20) --='100'\nDECLARE @CounterpartyID int\nDECLARE @FlowModel int\nDECLARE @THDT INT\nDECLARE @FRAFOT Nvarchar(3) -- 'FRA' OF 'FOT'\nDECLARE @SrcID int -- let op: slechts 'advies'\nDECLARE @DstID INT\n\n---- TEST: set supplier:\n--set @CounterpartyID =(select top 1 id from xcompany where companyname like '%4%') --4 fruit?\n\n--\tget supplier:\nDECLARE @value nvarchar(max),@SupplierID nvarchar(max)\nEXEC sp_api_modal_text N'Kies de leverancier',N'h3'\nEXEC sp_api_modal_select @card_name=N'leverancier',@value = @SupplierID OUT,@focus=1,@placeholder=N'Kies de leverancier voor de snelle inkoop'\nif @SupplierID is not NULL \n\tset @CounterpartyID=convert(int, @SupplierID)\nelse return --ga niet verder; maak (nog) geen cth1\n\n--bepaal hoe het bedrijf werkt, met of zonder dagprijzensysteem\ndeclare @dayprice bit\nset @dayprice=isnull((select L from @main_db.dbo.[GetCompanySettings]('useDayprice')),0)\nexec sp_api_toast @dayprice\n\n--pak de eerste de beste inkooporder van de geselecteerde leverancier; deze wordt gebruikt als hulp voor prijsbepaling\nset @CTHID=(select top 1 id from xtransactionheader where tdt=1 and counterparty_ID=@CounterpartyID) -- LET OP: DUMMY; dus zeer waarschijnlijk NIET het ID waarop geboekt gaat worden\nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=cth.FlowModel_ID,@THDT=cth.TDT,@FRAFOT=cth.FRAFOT, @srcID=cth.source_ID,@DstID=cth.Destination_ID From q_xTransactionHeader CTH where CTH.ID=@CTHID\n\n\nif isnull(@Prijs,0)=0\n\tbegin\n\t\tset @prijs=(select @main_db.dbo.stockprice(\t@ID --48482 --stock_ID\n\t\t\t\t\t\t\t,@CTHID --3761\t--CTH_ID\n\t\t\t\t\t\t\t,@CounterpartyID --161418\t--Counterparty_ID\n\t\t\t\t\t\t\t,@FlowModel --null\t--Flowmodel_ID\n\t\t\t\t\t\t\t,@THDT --2\t\t--DaTDT\n\t\t\t\t\t\t\t,@SrcID --NULL --SupplierLocation_ID\n\t\t\t\t\t\t\t,@DstID --NULL -- 7945\t--Receiverlocation_ID\n\t\t\t\t\t\t\t,IIF(@FRAFOT='FOT',1,0)\t\t--isFOT\n\t\t\t\t\t\t\t,@dayprice --0-- use dayprice\n\t\t\t\t\t\t)\n\t\t\t\t\t)\n\n\tend\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\nEXEC sp_api_modal_text 'Aantal'\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1\nIF @coretype in('FOOD')\n\tBEGIN\n\t\tEXEC sp_api_modal_text 'Prijs'\n\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT\n\tEND\nDECLARE @button nvarchar(128)\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\nIF @button IS NOT NULL\n\tBEGIN\n\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.')\n\t\tIF \tTRY_CAST(@aantal as int) >\t 0 \n\n\t\t\tBEGIN\n\t\t\t\t--zoek een open CTH1 of maak een nieuwe ...\n\t\t\t\tset @CTHID=(select top 1 id from xtransactionheader where tdt=1 and counterparty_ID=@CounterpartyID and status='openPurchase')\n\t\t\t\tif @CTHID IS NULL\tEXEC @main_db.dbo.CreateCTH1 @CounterpartyID, @new_identity = @CTHID OUTPUT;\n\n\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs, @User=@User\n\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\n\t\t\t\texec sp_api_toast @mes\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\tRETURN\n\t\t\tEND\n\t\tELSE\n\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\tEND\n\n",
            "action_id": 56,
            "action_name": "Snel Inkopen",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @stock_id nvarchar(32),@button nvarchar(128),@valueout nvarchar(128)\n,@reducer nvarchar(max) = '1=1'\nEXEC sp_api_modal_button @name='button', @value=N'Stock of PER',@valueout=@button OUT,@key=N'F1'\nEXEC sp_api_modal_button @name='button', @value=N'Alles',@valueout=@button OUT,@key=N'F2'\nIF @button = N'Stock of PER'\n\tSET @reducer = N'stock <> 0 or (id in (select DISTINCT Stock_id from p_PriceentryRow where activeCount >0 AND (pricehi<>0 OR pricelo<>0)))'\n\nEXEC sp_api_modal_select @card_name = N'xstock_geert_test',@value = @stock_id OUT,@focus = 1,@top=50,@reducer=@reducer\nEXEC sp_api_modal_text @stock_id\nEXEC sp_api_modal_input @name='asdfafd',@value=@valueout OUT\n",
            "action_id": 59,
            "action_name": "stock_search",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@date2 nvarchar(128),@button nvarchar(128), @ProdCode nvarchar(128), @ProdCode2 nvarchar(128),@land nvarchar(128)\nset @date = dbo.workDate()\nset @date2 = dbo.workDate()\n--SET @button = 'StockSoldList'\n--EXEC sp_api_modal_modal @class = 'w75'\nEXEC sp_api_modal_text 'Lvo:'\nEXEC sp_api_modal_select @card_name = N'Country',@value = @land OUT, @focus=1\nEXEC sp_api_modal_text 'Van:'\nEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-24'  -- zoek veld\nEXEC sp_api_modal_text 'Tot en met:'\nEXEC sp_api_modal_date @name='Date2',@value = @date2 OUT,@class='w-24' -- zoek veld\n--SET @date2 = CONCAT(@date2,' 23:59:59.999')\n\nEXEC sp_api_modal_text 'Van ProdCode:'\n--EXEC sp_api_modal_select @card_name=N'xstock',@value = @ProdCode OUT,@placeholder=N'Zoek...'\nEXEC sp_api_modal_input @name='ProdCode',@value = @ProdCode OUT,@class='w-24' -- zoek veld\nEXEC sp_api_modal_text 'Tot en met ProdCode:'\n--EXEC sp_api_modal_select @card_name=N'xstock',@value = @ProdCode2 OUT,@placeholder=N'Zoek...'\nEXEC sp_api_modal_input @name='ProdCode2',@value = @ProdCode2 OUT,@class='w-24' -- zoek veld\n\nEXEC sp_api_modal_button @name='button',@value = 'StockSoldList',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print @keycode='F9'\n\nIF @button =  'StockSoldList'\nBEGIN\nEXEC sp_api_toast @land\nSELECT [Amount@] = Amount, [Description*] = Description, [Contentdesc*] = ContentDesc, LVO, xProdCode, TransactionDate\nINTO #StockSoldList\nFROM          RV_StockSold\nWHERE\t\t(TDTDT = 2) \nAND (TransactionDate BETWEEN @date AND @date2) AND (Origin_ID = @land OR @land is null)\n\n\nAND ((@ProdCode is NULL OR @ProdCode = '') AND (@ProdCode2 is NULL OR @ProdCode2 = '') AND (Origin_ID = @land OR @land is null)\nOR (xProdCode between @ProdCode AND @ProdCode2) AND (Origin_ID = @land OR @land is null))\n\nEXEC sp_api_modal_table @tmptable=N'#StockSoldList',@orderby=N'ORDER BY 2,5,4 ASC',@print=1\nEND \n",
            "action_id": 61,
            "action_name": "StockSold",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 63,
            "action_name": "sys_curly_search_and_insert",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 64,
            "action_name": "sys_curly_search_and_insert",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--200930\r\nDECLARE @maatcode nvarchar(20), @mes nvarchar(100)=N'Nieuwe maat toevoegen'\r\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\r\nEXEC sp_api_modal_text 'Nieuwe Maat-code'\r\nEXEC sp_api_modal_input @name='maatcode',@value = @maatcode OUT,@focus=1\r\nDECLARE @button nvarchar(128)\r\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\r\nIF @button IS NOT NULL\r\n\tBEGIN\r\n\t\tIF @maatCode >N''\r\n\t\t\tBEGIN\r\n\t\t\t\tEXEC sp_api_toast @maatcode\r\n\t\t\t\t  exec @main_db.[dbo].[SP_IINE_xStock_LP] @xLotPalletID=@ID ,@AddSize =@maatcode\r\n\t\t\tEND\r\n\r\n\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\r\n\r\n\tEND\r\n",
            "action_id": 66,
            "action_name": "nieuwe maat",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @Code nvarchar(50) --CURRENCY, DIESEL, ...\nDECLARE @ContextID INT -- context van de huidige kaart\nDECLARE @mes nvarchar(200)--, @xDesc nvarchar(200)\nDECLARE @prijs nvarchar(20),@aantal nvarchar(20) --='100'\n\nDECLARE @xValRateID INT = {[xValRate].id}\n\nif isnull(@xValRateID,0) = 0 -- 0 bij splinternieuwe kaart, dan geen koersen zetten op deze manier\n\tBEGIN\n\n\t\t\n\n\t\t--EXEC SP_API_TOAST N'Er kan geen nieuwe waarde worden toegevoegd. Dit kan alleen op bestaande xValrate kaarten.'\n\t\t--RETURN;\n\t\tdeclare @xCURR_ID int = {[currency].id}\n\t\tdeclare @xVALID int \n\t\tif @xCURR_ID is not null\n\t\t\tselect @xVALID = id from xValue where code='CURRENCY' and ContextID=@xCURR_ID and returntype='F'\n\n\t\tif @xVALID is not null\n\t\t\tbegin\n\t\t\t\tINSERT INTO [dbo].[xValrate]\n        \t   ([xVal_ID]\n           \t\t,[code]\n           \t\t,[contextID]\n           \t\t,[F]\n           \t\t,[StartDate]\n           \t\t,[ReturnType]\n           \t\t,[EndDate])\nselect \t[ID]\n          ,[code]\n          ,[contextID]\n          ,[F]\n          ,@main_db.dbo.ABCBOM()\n          ,[ReturnType]\n          ,NULL\nfrom xvalue where id=@xVALID\n\n\t\nreturn; -- nieuw record. stoppen. Als men een koers wil ingeven, dan nog een keer klikken..\n\t\t-- we kunnen ook het nieuwe inserted ID  hier in @ContextID stoppen...\n\n\t\t\tend\n\n\t\t\t\t\n\tEND\n\n\nselect @Code=code\n\t\t, @ContextID=ContextID\n\t\t--, @CardStartDate =startdate \n\tfrom xvalrate where ID=@xValrateID\nexec sp_api_toast @code\n--return;\n\ndeclare @datum nvarchar(512)\t--input\nDECLARE @koers nvarchar(20)\t\t--input\nset @mes=N'Invoeren van een nieuwe waarde'\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\nEXEC sp_api_modal_text 'Datum'\nSET @datum = dbo.strdate(getdate())--'2020-10-30'\nEXEC sp_api_modal_date @name='Ingangsdatum:',@value= @datum OUT,@class = 'w-25' ,@focus=1\nEXEC sp_api_toast @datum\n\nEXEC sp_api_modal_text 'Waarde op deze datum:'\nEXEC sp_api_modal_input @name='koers',@value = @koers OUT\nIF @Koers>N'' SET @Koers=replace(@Koers, ',', '.') -- zorg dat punten en komma's als dec. seperator zijn toegestaan..\n\n\nDECLARE @button nvarchar(128)\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\nIF @button IS NOT NULL\n\tBEGIN\n\t\texec @main_db.dbo.SetxValRate_F \t@Code = @Code\t,@ContextID =@ContextID\t,@StartDate =@datum\t,@F =@koers\n\t\tEXEC sp_api_modal_clear\t\t\n\t\tif @Code=N'CURRENCY'\n\t\t\tbegin\n\t\t\t\tdeclare @TT nvarchar(200)=concat(N'CTHTOTALS: currency ',@ContextID,'  naar: ',@koers)\n\t\t\t\texec @main_db.dbo._Writelog @TT\n\t\t\t\tupdate T  set t.currencyXrate=@koers \n\t\t\t\tfrom xcthtotals T inner join xtransactionheader cth on cth.id=t.cth_id\n\t\t\t\twhere t.lfdate>=@datum and cth.currency_id=@contextID\n\t\t\tend\t\t\n\t\tRETURN\n\tEND\n",
            "action_id": 67,
            "action_name": "Nieuw Tarief",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@date2 nvarchar(128),@button nvarchar(128)\n--set @date = dbo.workDate()\n/*EXEC sp_api_modal_text 'Zoek op transport bedrijf'\nEXEC sp_api_modal_input @name='Transporteur',@value = @TransComp OUT,@focus=1,@select=1 -- zoek veld\n*/\nEXEC sp_api_modal_text 'Van:'\nEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-24',@focus=1,@select=1  -- zoek veld\nEXEC sp_api_modal_text 'Tot en met:'\nEXEC sp_api_modal_date @name='Date2',@value = @date2 OUT,@class='w-24' -- zoek veld\n--SET @date2 = CONCAT(@date2,' 23:59:59.999')\nSET @button = 'OpenOmpakLijst'\nEXEC sp_api_modal_button @name='button',@value = 'OpenOmpakLijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_button @name='button',@value = 'GeslotenOmpakLijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F2'\n\nIF @button =  'OpenOmpakLijst'\nBEGIN\nSELECT [IN/UIT], AMOUNT, DETAIL, KGN, KGB, Size, ContentDesc, BrandName, FustCode, LVO, logistic,[TID*],[cthkgninCAP*],[cthkgnin*],[seperate*],[cthkgnout CAP*],[cthkgnout*]--,Status,THTDT\nINTO #OpenOmpakLijst\nFROM          RV_OMPAKBON\nWHERE\t\t(Status = 'openRepack') AND (THTDT = 3) AND (TransactionDate BETWEEN @date AND @date2)\nEXEC sp_api_modal_table @tmptable=N'#OpenOmpakLijst',@orderby=N'ORDER BY [TID*],[cthkgninCAP*],[cthkgnin*],[seperate*],[cthkgnout CAP*],[cthkgnout*],DETAIL ASC'\nEND \n\nIF @button =  'GeslotenOmpakLijst'\nBEGIN\nSELECT [IN/UIT], AMOUNT, DETAIL, KGN, KGB, Size, ContentDesc, BrandName, FustCode, LVO, logistic,[TID*],[cthkgninCAP*],[cthkgnin*],[seperate*],[cthkgnout CAP*],[cthkgnout*]--,Status,THTDT\nINTO #GeslotenOmpakLijst\nFROM          RV_OMPAKBON\nWHERE\t\t(Status = 'closeRepack') AND (THTDT = 3) AND (TransactionDate BETWEEN @date AND @date2)\nEXEC sp_api_modal_table @tmptable=N'#GeslotenOmpakLijst',@orderby=N'ORDER BY [TID*],[cthkgninCAP*],[cthkgnin*],[seperate*],[cthkgnout CAP*],[cthkgnout*],DETAIL ASC'\nEND ",
            "action_id": 69,
            "action_name": "OMPAKBON",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE  @P nvarchar(200)\r\nSET @P=concat('/',(SELECT name FROM api_card WHERE id=@ID))\r\nEXEC sp_api_goto @path=@P",
            "action_id": 72,
            "action_name": "Open",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE  @P nvarchar(200)\nSET @P=concat('/',(SELECT name FROM api_card WHERE id=@ID))\nEXEC sp_api_goto @path=@P",
            "action_id": 74,
            "action_name": "OpenCardlist",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC @main_db.dbo.CTH2INVOICE @CTHID=@ID ",
            "action_id": 75,
            "action_name": "order_factureren",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC @main_db.dbo.CTH2INVOICE @CTHID=@ID ",
            "action_id": 76,
            "action_name": "order_factureren",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--EXEC @main_db.dbo.CTH2INVOICE @CTHID=@ID ",
            "action_id": 77,
            "action_name": "order_factureren",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC @main_db.dbo.CTH2INVOICE @CTHID=@ID ",
            "action_id": 78,
            "action_name": "order_factureren",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @sys_report_key nvarchar(50) = N'confirmation_out'\ndeclare @test bit =1 -- 0:LIVE ; 1=TEST\nEXEC sp_api_toast @sys_report_key--N'Orderbevestiging' \n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\t--EXEC sp_api_toast @cid\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select Counterparty_id from xtransactionheader where id=@cid)\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = @sys_report_key--'confirmation_out' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@test=@test\n\n\t\t--dit is nu alleen voor tellers en checks:\n\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'CTH'\t,@Context_Key_ID=@cid,@Report_CODE=N'CONF'\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 79,
            "action_name": "orderbevestiging",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @sys_report_key nvarchar(50) = N'confirmation_out'\ndeclare @test bit =0 -- 0:LIVE ; 1=TEST\nEXEC sp_api_toast @sys_report_key--N'Orderbevestiging' \n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\t--EXEC sp_api_toast @cid\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select Counterparty_id from xtransactionheader where id=@cid)\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = @sys_report_key--'confirmation_out' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@test=@test\n\n\t\t--dit is nu alleen voor tellers en checks:\n\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'CTH'\t,@Context_Key_ID=@cid,@Report_CODE=N'CONF'\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 80,
            "action_name": "orderbevestiging",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--text, class, translate (bit)\r\nEXEC sp_api_modal_text 'Kies Enter om de vorige prijzen te gebruiken.',@translate=1 --vertaalbaar\r\nDECLARE @button nvarchar(128) --button nodig om DECLARE oude SET nog te hebben.\r\nEXEC sp_api_modal_button @name='button',@value = 'Okay!',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter' --is initieel leeg\r\nEXEC sp_api_modal_button @name='button2',@value = 'Nah',@valueout = @button OUT,@class = 'btn-primary',@key = 'Escape' --is initieel leeg\r\nIF @button IS NULL EXEC sp_api_modal_select_all --STEP 1 SELECT all\r\n -- na klik\r\nIF @button = 'Nah' OR @button = 'Okay!'\r\n\tBEGIN\r\n\t\tEXEC sp_api_modal_clear -- einde formweergave; handel alleen nog de CURSOR af\r\n\t\tEXEC sp_api_modal_select_all_clear --STEP 2 SELECT clear all en de rest\r\n\tEND\r\nIF @button = 'Okay!'\r\n\tBEGIN\r\n\r\n\t\tDECLARE @cursor_ids CURSOR,@cid INT\r\n\t\t-- onderbreek de actie alos er meer dan 1 leverancier in DECLARE selectie voor komt\r\n\t\tif\t(SELECT count( distinct supplier_ID) FROM p_PriceEntryRow where id in (SELECT value FROM string_split(@ids,','))) > 1\r\n\t\t\tBEGIN\r\n\t\t\t\tEXEC sp_api_modal_alert N'Selecteer niet meer dan 1 leverancier!'\r\n\t\t\t\tEXEC sp_api_modal_clear \r\n\t\t\t\treturn;\r\n\t\t\tEND\r\n\r\n\t\tSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\r\n\t\tOPEN @cursor_ids;\r\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\r\n\t\tWHILE @@FETCH_STATUS = 0\r\n\t\t\tBEGIN\r\n\t\t\t\tUPDATE p_PriceEntryRow SET PriceHi = OldPriceHi, PriceLo = OldPriceLo WHERE id = @cid\r\n\t\t\t\tFETCH NEXT FROM @cursor_ids INTO @cid\r\n\t\t\tEND\r\n\t\tCLOSE @cursor_ids;\r\n\t\tDEALLOCATE @cursor_ids;\r\n\r\n\tEND\r\n\r\n",
            "action_id": 83,
            "action_name": "oude prijzen",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--bewaren!\nif {[relocate].id} is null\n\tbegin\n\t\texec SP_API_MODAL_ALERT N'Dit kan alleen bij Overbrengen van goederen'\n\t\texec SP_API_MODAL_CLEAR\n\t\treturn\n\tend\n\nDECLARE @CTHID INT = {[relocate].id} --cth_id van de overbrenging\nDECLARE @xStock_ID INT ={[voorraad_op_overbrenglokatie].xStock_ID}\n--SELECT @xStock_ID = xstock_id FROM xstockLoc WHERE id=@ID\n\nIF @CTHID IS NULL \n\tbegin\n\t\tEXEC sp_api_toast 'Kan geen [verkoop] vinden'\n\t\tRETURN;\n\tend\n\n\n\nDECLARE @mes nvarchar(200)  --, @FustSaldo int, @CoreType nvarchar(10),@FustID int\n\t\t, @xDesc nvarchar(200)\nSELECT @xDesc=x.[Description],@mes= concat('Overbrengen ' , x.[Description]) --,@Coretype= x.coretype,@FustID=x.Fust_ID \n\tfrom xstock x where x.id=@xStock_ID \n--EXEC sp_api_modal_text @mes,'h2 text-primary'\n\nIF {[relocate].status} not in ('openRelocation') \n\tBEGIN \n\t\tEXEC sp_api_modal_alert 'U mag niet toevoegen OPEN deze overbrenging, want DECLARE status is ongelijk aan ''openRelocation'''\n\t\tEXEC sp_api_modal_clear\t\t\n\t\tRETURN;\t\n\tend\n\n\n\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\n\nDECLARE @aantal nvarchar(20) --='100'\nDECLARE @CounterpartyID int\nDECLARE @FlowModel int\nDECLARE @THDT INT\nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=FlowModel_ID,@THDT=TDT From xTransactionHeader CTH where CTH.ID=@CTHID\n\n\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\nEXEC sp_api_modal_text 'Aantal'\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1\nDECLARE @button nvarchar(128)\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\nIF @button IS NOT NULL\n\tBEGIN\n\n\t\tIF \tTRY_CAST(@aantal as int) >\t 0 \n\t\t\tBEGIN\n--\t\t\t\tDECLARE @mappartijregel int\n--\t\t\t\tSET @mappartijregel=(select @main_db.dbo.FustIV_VTD(@FustID))\n\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@xStock_ID,@Amount=@Aantal,@Price=NULL, @User=@User--,@mapctr_id=@mappartijregel,@Pricetype='ZERO'\n\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de overbrenging' from xstock x where x.id=@xStock_ID\n\t\t\t\texec sp_api_toast @mes\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\tRETURN\n\t\t\tEND\n\t\tELSE\n\t\t\tEXEC sp_api_modal_text 'Aantal is ongeldig!','text-danger'\n\tEND\n\n",
            "action_id": 84,
            "action_name": "Overbrengen",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "if {[relocate].id} is null\n\tbegin\n\t\texec SP_API_MODAL_ALERT N'Dit kan alleen bij Overbrengen van goederen'\n\t\texec SP_API_MODAL_CLEAR\n\t\treturn\n\tend\n\nDECLARE @CTHID INT = {[relocate].id} --cth_id van de overbrenging\nDECLARE @xStock_ID INT ={[voorraadlokatie].xStock_ID}\n--SELECT @xStock_ID = xstock_id FROM xstockLoc WHERE id=@ID\n\nIF @CTHID IS NULL \n\tbegin\n\t\tEXEC sp_api_toast 'Kan geen [verkoop] vinden'\n\t\tRETURN;\n\tend\n\n\n\n\n\nDECLARE @mes nvarchar(200)  --, @FustSaldo int, @CoreType nvarchar(10),@FustID int\n\t\t, @xDesc nvarchar(200)\nSELECT @xDesc=x.[Description],@mes= concat('Overbrengen ' , x.[Description]) --,@Coretype= x.coretype,@FustID=x.Fust_ID \n\tfrom xstock x where x.id=@xStock_ID \n--EXEC sp_api_modal_text @mes,'h2 text-primary'\n\nIF {[relocate].status} not in ('openRelocation') \n\tBEGIN \n\t\tEXEC sp_api_modal_alert 'U mag niet toevoegen OPEN deze overbrenging, want DECLARE status is ongelijk aan ''openRelocation'''\n\t\tEXEC sp_api_modal_clear\t\t\n\t\tRETURN;\t\n\tend\n\n\n\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\n\nDECLARE @aantal nvarchar(20) --='100'\nDECLARE @CounterpartyID int\nDECLARE @FlowModel int\nDECLARE @THDT INT\nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=FlowModel_ID,@THDT=TDT From xTransactionHeader CTH where CTH.ID=@CTHID\n\n\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\nEXEC sp_api_modal_text 'Aantal'\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1\nDECLARE @button nvarchar(128)\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\nIF @button IS NOT NULL\n\tBEGIN\n\n\t\tIF \tTRY_CAST(@aantal as int) >\t 0 \n\t\t\tBEGIN\n--\t\t\t\tDECLARE @mappartijregel int\n--\t\t\t\tSET @mappartijregel=(select @main_db.dbo.FustIV_VTD(@FustID))\n\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@xStock_ID,@Amount=@Aantal,@Price=NULL, @User=@User--,@mapctr_id=@mappartijregel,@Pricetype='ZERO'\n\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de overbrenging' from xstock x where x.id=@xStock_ID\n\t\t\t\texec sp_api_toast @mes\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\tRETURN\n\t\t\tEND\n\t\tELSE\n\t\t\tEXEC sp_api_modal_text 'Aantal is ongeldig!','text-danger'\n\tEND\n\n",
            "action_id": 85,
            "action_name": "Overbrengen",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @company_id nvarchar(32),@button nvarchar(128),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000)\n,@button1 nvarchar(128) = N'Nieuwe verkoop'\n,@button2 nvarchar(128) = N'Laatste open verkoop'\n\nEXEC sp_api_modal_select @card_name = N'klant',@value = @company_id OUT,@focus = 1\nIF @company_id > 0\nBEGIN\n\tEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Insert'\n\tIF EXISTS (SELECT * FROM xTransactionHeader WHERE status=N'openSale' AND CounterParty_ID = @company_id)\n\t\tEXEC sp_api_modal_button @name='button',@value=@button2,@valueout = @button OUT,@key='Enter'\n\n\tIF @button = @button1\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'CounterParty_ID',@company_id,0\n\t\t\tEXEC @new_id = sp_api_modal_save N'verkoop',0\n\t\t\tIF @new_id > 0\n\t\t\t\tBEGIN\n\t\t\t\t\tSET @goto = N'/verkoop/'+@new_id+'/stock_ctr2'\n\t\t\t\t\tEXEC sp_api_toast N'Nieuwe verkoop gestart',N'alert-primary'\n\t\t\t\t\tSET @search = N'?id='+@new_id\n\t\t\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/verkoop',@referer_search=@search\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tEXEC sp_api_toast N'Error nieuwe verkoop',N'alert-danger'\n\t\t\tEXEC sp_api_modal_clear\n\t\tEND\n\tIF @button = @button2\n\t\tBEGIN\n\t\t\tSET @new_id = (SELECT TOP 1 id FROM xTransactionHeader WHERE status=N'openSale' AND CounterParty_ID = @company_id ORDER BY id DESC)\n\t\t\tSET @goto = N'/verkoop/'+@new_id+'/stock_ctr2'\n\t\t\tSET @search = N'?id='+@new_id\n\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/verkoop',@referer_search=@search\n\t\tEND\nEND\n",
            "action_id": 86,
            "action_name": "sys_new_action",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @LinkAantal INT = {[ivhistory].LinkAantal}\nDECLARE @LinkPrice INT = {[ivhistory].iCTR_Price}\n--SET @LinkAantal = (SELECT [code_IVlinked_ctrFromTo].[LinkAantal] FROM [code_IVlinked_ctrFromTo] WHERE [id] = (SELECT id FROM #parents WHERE card_name = N'ivhistory'))\nDECLARE @ReturnAmount nvarchar(max) = @LinkAantal\nDECLARE @ReturnPrice nvarchar(max) = @LinkPrice\n,@valueout nvarchar(max) \nEXEC sp_api_modal_text N'Kies het aantal dat gecrediteerd moet worden'\nEXEC sp_api_modal_input @name='Retour colli',@max=6, @value= @ReturnAmount OUT,@focus=1\nEXEC sp_api_modal_text N'Prijs'\nEXEC sp_api_modal_input @name='Retour prijs',@max=6, @value= @ReturnPrice OUT\n\nEXEC sp_api_modal_button @name='Sure',@value = 'Boek retour', @valueout = @valueout OUT\n\t,@class='btn-primary',@key='Enter'\nIF @valueout IS NOT NULL AND TRY_CAST(@ReturnAmount as int) BETWEEN 1 AND @LinkAantal\n\tBEGIN\n\t\tEXEC sp_api_toast @ReturnAmount\n\t\tEXEC @main_db.dbo.sp_create_return_sale @id,@ReturnAmount\n\t\tEXEC sp_api_modal_clear\n\tEND\n",
            "action_id": 87,
            "action_name": "takeback",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--UPDATE xTransactionHeader SET status='openSale' WHERE id IN (SELECT * FROM string_split(@ids,','))\r\nUPDATE xTransactionHeader SET status='openSale' WHERE id IN ({@ids})",
            "action_id": 88,
            "action_name": "terug naar open verkoop",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--UPDATE xTransactionHeader SET status='openSale' WHERE id IN (SELECT * FROM string_split(@ids,','))\r\nUPDATE xTransactionHeader SET status='openSale' WHERE id IN ({@ids})",
            "action_id": 89,
            "action_name": "terug naar open verkoop",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--UPDATE xTransactionHeader SET status='openSale' WHERE id IN (SELECT * FROM string_split(@ids,','))\nUPDATE xTransactionHeader SET status='openSale' WHERE id IN ({@ids})\n\n",
            "action_id": 90,
            "action_name": "terug naar open verkoop",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--UPDATE xTransactionHeader SET status='openSale' WHERE id IN (SELECT * FROM string_split(@ids,','))\r\nUPDATE xTransactionHeader SET status='openSale' WHERE id IN ({@ids})",
            "action_id": 91,
            "action_name": "terug naar open verkoop",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC SP_API_GOTO @previous_path",
            "action_id": 92,
            "action_name": "terug naar orderkop",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec sp_api_toast N'hallo'\r\n",
            "action_id": 93,
            "action_name": "test bve",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @text nvarchar(max) = {[inkoop].Counterparty_ID.Country_ID.Name_0}\r\nEXEC sp_api_modal_text @text\r\nEXEC sp_api_modal_text 'Wijzig Bruto'\r\nDECLARE @valueout nvarchar(max) = {[lotartsize].Bruto} \r\n--DECLARE @valueout nvarchar(max) = {Bruto}\r\nEXEC sp_api_modal_input @name='Naam',@max=5, @value= @valueout OUT,@focus=1\r\n{@valueout->[lotartsize].Bruto}",
            "action_id": 94,
            "action_name": "test geert",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @TC nvarchar(50)={[verkoop2].CounterParty_ID.Currency_ID}\r\nEXEC sp_api_toast @text=@TC",
            "action_id": 96,
            "action_name": "toast_curr",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @TC nvarchar(50)={[verkoop2].CounterParty_ID.Currency_ID}\r\nEXEC sp_api_toast @text=@TC",
            "action_id": 97,
            "action_name": "toast_curr",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @wat nvarchar(200), @LinkToME int\r\nSET @LinkToME ={[ctr1].id}\r\nIF @linkToME IS NULL RETURN;\r\n\r\nIF (SELECT (ctrAmount-IVTOTAL) FROM Q_xTransactionDetail WHERE ID=@LinkToME ) = 0 BEGIN\r\n\tEXEC sp_api_modal_alert N'Deze partijregel is al volledig verkocht (aan verkoopregels toegewezen)'\r\n\tEXEC sp_api_modal_Clear\r\n\r\n-- 200929 hier=>\tEXEC sp_api_goto @parentpath --idee? --go2\r\n\tRETURN;\r\n\tend\r\n\r\nset @wat=concat(N'MAP ID: ',@LinkToME,' aan ID: ',@ID)\r\nexec sp_api_toast @wat\r\nexec @main_db.dbo.map @ID,@LinkToME--,@ID -- link al het mogelijke\r\n",
            "action_id": 100,
            "action_name": "toewijzen",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "-- {[ctr2].Amount} \r\nDECLARE @count_iv2 INT = (SELECT sum(linkaantal) FROM xIvlink WHERE ITD = @id)\r\nIF @count_iv2 <>{[ctr_coco_verkoop].Amount}*iif({[ctr_coco_verkoop].stockmut}=0,0,1)--= 0\r\nBEGIN\r\nEXECUTE sp_api_toast 'Nu volgens mij moet er iets gebeuren'\r\nEND \r\nELSE\r\nBEGIN \r\nEXECUTE sp_api_toast 'anders nu'\r\nEND \r\n/*\tSET @path = @path+'/'+@id+'/ctr1_toewijsbaar'\r\nELSE\r\n\tSET @path = @path+'/'+@id+'/iv2'\r\n\r\nEXEC sp_api_goto @path\r\n*/\r\n/*\r\n\r\n\r\n\r\nIF @count_iv2 = 0\r\n\tEXEC sp_api_keypress N'F4'\r\nELSE\r\n\tEXEC sp_api_keypress N'Alt+T'\r\n*/",
            "action_id": 101,
            "action_name": "Toewijzen",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "-- {[ctr2].Amount} \n\n--EXEC sp_api_modal_set N'bewaar_kruimel_path',N'/inkoop' --@path\n--EXEC sp_api_modal_set N'bewaar_kruimel_search',N'?id=123' --@path\nif {[ctr2].Amount} is not null --we zitten op ctr2\n\tbegin\n\n\t\tDECLARE @count_iv2 INT = (SELECT sum(linkaantal) FROM xIvlink WHERE ITD = @id or vtd = @id)-- RH210116 OR vtd.. er bij (er was een overmatige toewijzing)\n\t\tDECLARE @DIFF INT \n\t\tset @DIFF=\t( select isnull({[ctr2].Amount}*iif({[ctr2].stockmut}=0,0,1),0) - @count_iv2)\n\t\tEXEC SP_API_TOAST @diff\n\t\tIF ISNULL(@count_iv2,0)=0 or @DIFF > 0 --@count_iv2 <>isnull({[ctr2].Amount}*iif({[ctr2].stockmut}=0,0,1),0)--= 0\n\t\t\tBEGIN\n\t\t\t\tIF NOT EXISTS (select * from @main_db.dbo.ctr1_Assignable(NULL,@id))\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tEXEC sp_api_modal_alert N'Geen partij met voorraad beschikbaar!'\n\t\t\t\t\t\tEXEC sp_api_modal_clear\n\t\t\t\t\t\tRETURN\n\t\t\t\t\tEND\n\t\t\t\tSET @path = @path+'/'+@id+'/ctr1_toewijsbaar'\n\t\t\tEND\n\t\tELSE\n\t\t\tBEGIN\n\t\t\t\tIF @DIFF < 0 -- meer toegewezen dan de ctr groot is\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tEXEC sp_api_modal_alert N'Er is te veel toegewezen!, verlaag de toewijzing of verwijder een toewijzing!'\t\n\t\t\t\t\tEND\t\n\t\t\t\tSET @path = @path+'/'+@id+'/iv2'\n\t\t\tEND\n\t\n\t\tEXEC sp_api_goto @path\n\tend\n\nelse\n EXEC SP_API_TOAST @card_name\n\n/*\n\n\n\nIF @count_iv2 = 0\n\tEXEC sp_api_keypress N'F4'\nELSE\n\tEXEC sp_api_keypress N'Alt+T'\n*/\n\n/* WAS: \n-- {[ctr2].Amount} \n\n--EXEC sp_api_modal_set N'bewaar_kruimel_path',N'/inkoop' --@path\n--EXEC sp_api_modal_set N'bewaar_kruimel_search',N'?id=123' --@path\nif {[ctr2].Amount} is not null --we zitten op ctr2\n\tbegin\n\n\t\tDECLARE @count_iv2 INT = (SELECT sum(linkaantal) FROM xIvlink WHERE ITD = @id)\n\t\t--EXEC SP_API_TOAST @count_iv2\n\t\tIF ISNULL(@count_iv2,0)=0 or @count_iv2 <>isnull({[ctr2].Amount}*iif({[ctr2].stockmut}=0,0,1),0)--= 0\n\t\t\tBEGIN\n\t\t\t\tIF NOT EXISTS (select * from @main_db.dbo.ctr1_Assignable(NULL,@id))\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tEXEC sp_api_modal_alert N'Geen partij met voorraad beschikbaar!'\n\t\t\t\t\t\tEXEC sp_api_modal_clear\n\t\t\t\t\t\tRETURN\n\t\t\t\t\tEND\n\t\t\t\tSET @path = @path+'/'+@id+'/ctr1_toewijsbaar'\n\t\t\tEND\n\t\tELSE\n\t\t\tSET @path = @path+'/'+@id+'/iv2'\n\t\t\n\t\tEXEC sp_api_goto @path\n\tend\n\nelse\n EXEC SP_API_TOAST @card_name\n\n*/",
            "action_id": 102,
            "action_name": "Toewijzen/Toewijzing",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "-- {[ctr2].Amount} \nDECLARE @count_iv2 INT = (SELECT sum(linkaantal) FROM xIvlink WHERE ITD = @id)\nIF @count_iv2 <>{[ctr2].Amount}*iif({[ctr2].stockmut}=0,0,1)--= 0\n\tSET @path = @path+'/'+@id+'/ctr1_toewijsbaar'\nELSE\n\tSET @path = @path+'/'+@id+'/iv2'\n\nEXEC sp_api_goto @path\n/*\n\n\n\nIF @count_iv2 = 0\n\tEXEC sp_api_keypress N'F4'\nELSE\n\tEXEC sp_api_keypress N'Alt+T'\n*/",
            "action_id": 103,
            "action_name": "Toewijzing",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--\t201124 let op: dit is de simpele verkoop indicator wissel voor direct.. \n--;\tBij inkloop is dit veel complexer!! \ndeclare @Direct int\nselect @Direct=iif(isnull(Flowmodel_ID,2)=2,1,NULL) from xtransactiondetail where id=@ID\nupdate xtransactiondetail set Flowmodel_id=@Direct where id=@ID\n",
            "action_id": 104,
            "action_name": "Direct wel/niet",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "set @testmodus =1 --0=live; 1=test!\n\nEXEC sp_api_toast N'Transport-instructie naar Transporteur' \nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\t--dit is nu alleen voor tellers en checks:\n\n\t\t--even niet registreren dat er wordt afgedrukt\n\t\t--EXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'LF'\t,@Context_Key_ID=@cid,@Report_CODE=N'TRANSPORT' --transportorder\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = {[xlandfreight].transportCompany_ID}\n\t\t--DECLARE @error INT\n\t\t\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = 'transport-out' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@test=@testmodus\n\t\t\t\n\t\t--IF @error > 0 RAISERROR(N'Er is een probleem')\n\t\t\n\t\t--set @reptxt=concat(N'to transporter: ',@toCompany_ID)\n\t\t--execute sp_api_toast @reptxt\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 105,
            "action_name": "Transportorder",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @T nvarchar(100)\r\nSET @T=N'Zet de setting UseCalculator op de default lokatie van '+(SELECT companyname FROM xcompany WHERE id=@ID)+' AAN'\r\nEXEC sp_api_toast @T\r\nupdate xlocation SET useCalculator=1 WHERE company_ID=@ID AND isdefault=1",
            "action_id": 107,
            "action_name": "Use Calculator",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @search nvarchar(2000),@CalendarID INT\r\nSELECT @CalendarID = CalendarID FROM abcCalendar WHERE [Date] = dbo.abcdate()\r\nSET @search=N'?id=' + dbo.nv(@CalendarID)\r\nEXEC sp_api_goto @path,@search",
            "action_id": 108,
            "action_name": "vandaag",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @Origin_Code nvarchar(max) = {[xstock].Origin_Code}\nDECLARE @ContentDesc nvarchar(max) = {[xstock].ContentDesc}\nDECLARE @Description nvarchar(max) = {[xstock].Description} \nDECLARE @xProduct_ID nvarchar(max) = {[xstock].xProduct_ID}  \nDECLARE @Size nvarchar(max) = {[xstock].Size}\n\nDECLARE @search nvarchar(max) = N'?filter=detail.swhas(+'+@Description+'),contentdesc.swhas(+'+@ContentDesc+'),origin_code.swhas(+'+@Origin_Code+'),size.swhas(+'+@Size+')'\nSET @path+='/'+@id+'/ctr_editor'\nEXEC sp_api_goto @path,@search\n",
            "action_id": 116,
            "action_name": "verkocht",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 117,
            "action_name": "Verkoop vanaf lokatie",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 118,
            "action_name": "Verkoop vanaf lokatie",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "IF EXISTS (SELECT * FROM Q_xtransactionheader where DeliveryCode_ID = 2 and id IN ({@ids})) AND NOT EXISTS (SELECT * FROM Q_xCostRegistration WHERE (syskey_id = 2000 OR syskey_id = 10001000) AND Transaction_ID IN ({@ids}))\nBEGIN\n\tEXEC sp_api_modal_alert N'Let op!',N'\u00c9\u00e9n van de geselecteerde verkoop orders heeft een aflevermethode Franko. U dient eerst vracht kosten te boeken via de Workflow!'\n\tEXEC sp_api_modal_clear\n\tRETURN\nEND\n\nupdate xtransactionheader set status ='ReadyForInvoice' where id IN ({@ids})\nEXEC sp_api_toast N'verkoop is gesloten'",
            "action_id": 119,
            "action_name": "verkoop_sluiten",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "update xtransactionheader set status ='ReadyForInvoice' where id IN(select * FROM string_split(@IDS,','))\nEXEC sp_api_toast N'verkoop is gesloten'\nexec sp_api_modal_select_all_clear -- wis de selectie (SvR 210115)",
            "action_id": 120,
            "action_name": "verkoop_sluiten",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "update xtransactionheader set status ='ReadyForInvoice' where id IN(select * FROM string_split(@IDS,','))\r\nEXEC sp_api_toast N'verkoop is gesloten'",
            "action_id": 121,
            "action_name": "verkoop_sluiten",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "update xtransactionheader set status ='ReadyForInvoice' where id IN(select * FROM string_split(@IDS,','))\nEXEC sp_api_toast N'verkoop is gesloten'\nexec sp_api_modal_select_all_clear -- wis de selectie (SvR 210115)",
            "action_id": 122,
            "action_name": "verkoop_sluiten",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "/*\nUpdate xtransactiondetail set amount = 0, price = 0 where id = @id\n\nEXEC @main_db.dbo.DeleteCTR @ID\n*/\n/*\nIF {[verkoop].status} NOT IN ('openSale')\n\tBEGIN\n\t\tEXEC sp_api_toast N'Status is not openSale!'\n\t\tRETURN\n\tEND\n\nEXEC sp_api_modal_alert N'Zeker weten?',N'Het aantal wordt op 0 gezet, en daarna geheel verwijderd!'\nUPDATE xTransactionDetail SET amount = 0 WHERE id = @id\nEXEC @main_db.dbo.DeleteCTR @ID\nEXEC sp_api_toast N'Regel verwijderd'\nEXEC sp_api_modal_clear\n*/\nDECLARE @TH_ID int, @button nvarchar(128)\nSET @TH_ID = {[ctr2].TransactionHeader_ID}\n\nEXEC sp_api_modal_alert N'Zeker weten?',N'Het aantal wordt op 0 gezet, en daarna geheel verwijderd!'\nDECLARE @cursor CURSOR,@idval INT\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @idval\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\n\t\tDECLARE @detail nvarchar(255), @detaildelete nvarchar(255), @detailwarning nvarchar(255)\n\t\tSET @detail = (SELECT concat(Amount,' ',detail) from q_xtransactiondetail where id = @idval)\n\t\tSET @detaildelete = concat('Het transport(Pallet/Landfreight) staat op \"Departed\". U kan ',@detail,' niet verwijderen.')\n\t\tSET @detailwarning = concat('Een deel van deze regel is reeds klaargezet, Informeer de loods indien u het artikel verwijdert ',@detail,' Druk op \"OK\"(Enter) om het artikel te verwijderen')\n\t\nIF (SELECT COUNT(ID) FROM xlfctr WHERE CTR_ID = @idval AND LF_ID IN (SELECT id FROM xLandfreight WHERE STATUS = 'Departed' AND id = xlfctr.LF_ID)) > 0 /*EXISTS (SELECT id FROM xLandfreight WHERE STATUS = 'Departed' AND id = LF_ID)) > 0 */\nAND (SELECT COUNT(ID) FROM xlfctr WHERE CTR_ID = @idval AND LF_ID IN (SELECT id FROM xLandfreight WHERE STATUS = 'Loading' AND id = xlfctr.LF_ID)) = 0 /*EXISTS (SELECT id FROM xLandfreight WHERE STATUS = 'Loading' AND id = LF_ID)) = 0 */\n\tBEGIN\n\t\tEXEC sp_api_modal_Alert N'Let op!',@detaildelete\n\t\t--EXEC sp_api_modal_clear\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\tCONTINUE\n\t\tRETURN\n\tEND\n\t\nIF (SELECT COUNT(ID) FROM xlfctr WHERE CTR_ID = @idval AND LF_ID IN (SELECT id FROM xLandfreight WHERE STATUS = 'Loading' AND i_away = 1 AND id = xlfctr.LF_ID)) > 0 /*EXISTS (SELECT id FROM xLandfreight WHERE STATUS = 'Loading' AND i_away = 1 AND id = LF_ID)) > 0 AND {[verkoop].status} = 'OpenSale'*/\n\tBEGIN\n\tEXEC sp_api_modal_Alert N'Let op!',@detailwarning\n\tEND\n\n\t\tSET @TH_id = (SELECT transactionheader_id from q_xtransactiondetail where id = @idval)\n\t\tDECLARE @textlog nvarchar(255) = concat(N'actie [Verwijder] gestart op order: ',@TH_id,' op product: ',@detail)\n\t\tEXEC @main_db.dbo.actielog @Card_name , @textlog\n\t\t\n\t\tEXEC @main_db.dbo.DeleteCTR @idval\n\t\t\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\nEXEC sp_api_modal_clear\nEXEC sp_api_modal_select_all_clear\n",
            "action_id": 123,
            "action_name": "Verwijder",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "SP_API_MODAL_ALERT 'LET OP!','U gaat een bedrijf verwijderen. Weet u het zeker? Druk OK(ENTER) om door te gaan.'--,@key = 'F1'\nexec @main_db.dbo.DeleteCompany @ID\nEXEC sp_api_modal_clear\nEXEC sp_api_modal_select_all_clear",
            "action_id": 124,
            "action_name": "verwijder bedrijf",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "UPDATE xTransactionHeader SET status = N'ReadyForInvoice' WHERE id IN (SELECT DISTINCT cth_id FROM xInvRow WHERE invoice_id=@ID)\ndelete FROM xinvrow WHERE invoice_id=@ID\n",
            "action_id": 125,
            "action_name": "Verwijder de regels_voor210112",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @delresult int\nexec @DelResult=@main_db.dbo.[Delete_LF_IF_NO_LFCTR] @ID\nif @DelResult = -1\n\texec sp_api_Toast N'Er kan geen landfreight worden verwijderd, omdat er nog detailregels bestaan'\nEXEC sp_api_go2\n",
            "action_id": 126,
            "action_name": "Verwijder Landfreight",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "if not exists(select id from xstock where xproduct_id = @ID) -- multi maken?\n\tbegin\n\t\tdelete from xlotartsize where xproduct_id =@ID\t--210424\n\t\tdelete from xlotartmodel where xproduct_id =@ID\t--210424\n\t\tdelete from xproductlang where xproduct_id =@ID\n\t\tdelete from xproduct where id =@ID\n\tend\nelse exec sp_api_toast N'U mag niet verwijderen, er bestaan artikelen in xStock'",
            "action_id": 128,
            "action_name": "Verwijder product",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.DeleteCTH @ID ",
            "action_id": 131,
            "action_name": "Verwijder_Order",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.DeleteCTH @ID",
            "action_id": 132,
            "action_name": "Verwijder_Order",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--EXEC @main_db.dbo.DeleteCTH @CTHID=@ID\r\nDECLARE @cursor_ids CURSOR,@cid INT\r\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\r\nOPEN @cursor_ids;\r\nFETCH NEXT FROM @cursor_ids INTO @cid\r\nWHILE @@FETCH_STATUS = 0\r\n\tBEGIN\r\n\t\tEXEC @main_db.dbo.DeleteCTH @CTHID=@cID -- delete enkel id\r\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\r\n\tEND\r\nCLOSE @cursor_ids;\r\nDEALLOCATE @cursor_ids;",
            "action_id": 133,
            "action_name": "Verwijder_Order",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--EXEC @main_db.dbo.DeleteCTH @CTHID=@ID\r\nDECLARE @cursor_ids CURSOR,@cid INT\r\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\r\nOPEN @cursor_ids;\r\nFETCH NEXT FROM @cursor_ids INTO @cid\r\nWHILE @@FETCH_STATUS = 0\r\n\tBEGIN\r\n\t\tEXEC @main_db.dbo.DeleteCTH @CTHID=@cID -- delete enkel id\r\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\r\n\tEND\r\nCLOSE @cursor_ids;\r\nDEALLOCATE @cursor_ids;",
            "action_id": 134,
            "action_name": "Verwijder_Order",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC @main_db.dbo.DeleteCTH @ID ",
            "action_id": 135,
            "action_name": "Verwijder_Order",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "Update xtransactiondetail set amount = 0, price = 0 where id = @id\r\n\r\nEXEC @main_db.dbo.DeleteCTR @ID ",
            "action_id": 136,
            "action_name": "Verwijder_regel",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "delete FROM xPriceMoment WHERE 1=1",
            "action_id": 137,
            "action_name": "VerwijderAllePrijsmomenten",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 138,
            "action_name": "Vessel",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--210629 RH BUSY !! koppel de ctr aan de customsrow van deze order (als die bestaat)\nupdate Q_xtransactiondetail set cthCustomsRows_ID ={[xcthcustomsrows].id} \n\twhere ID=@ID  --belangrijk alleen deze ctr!\n\t\tAND\tcthCustomsRows_ID is null \n\t\t--AND xproduct_ID={[xcthcustomsrows].xProduct_ID} \n\t\tAND  transactionHeader_ID={[xcthcustomsrows].CTH_ID} \n\t\t",
            "action_id": 141,
            "action_name": "Add Orphans",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_post @card = N'apicard',@column=N'unparsed_crud_create',@value=N'dbo.hasRole(''admin'') > 0',@id=@id\nEXEC sp_api_modal_post @card = N'apicard',@column=N'unparsed_crud_read',@value=N'dbo.hasRole(''admin'') > 0',@id=@id\nEXEC sp_api_modal_save @card = N'apicard',@id=@id",
            "action_id": 142,
            "action_name": "Admin Only",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @cth_id INT \r\nSET @cth_id = {[inkoop].id}\r\nEXEC @main_db.dbo.sp_Uitlossen_CTH @cth_id",
            "action_id": 143,
            "action_name": "AllesUitlossen",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "update xlandfreight SET transport_ID={[transport].id} WHERE xlandfreight.Transport_ID is null AND (xlandfreight.Transportcompany_ID={[transport].transporter_ID} OR xlandfreight.Transportcompany_ID is null)",
            "action_id": 144,
            "action_name": "Auto Add Landfreight",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @NewID INT, @Endtxt nvarchar(200)\nexec @newID=@main_db.dbo.Create_CTR_ForOwnNegativeStock_CTH @CTH_ID=@ID\nif @newID is not NULL\n\tbegin\n\t\tset @EndTxt= N''+str(@newID)+N' regels toegevoegd aan de inkoop.'\n\t\texec sp_api_toast @text=@endtxt\n\tend",
            "action_id": 145,
            "action_name": "auto-inkoop-neg-stock",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_goto @path='/xbol'\r\n",
            "action_id": 146,
            "action_name": "B/L",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_text 'Calculator',N'mt-4 h5'\r\nDECLARE @calc nvarchar(256) = '0',@button nvarchar(128),@result nvarchar(1000),@sql nvarchar(1000)\r\nEXEC sp_api_modal_input @name='calc',@value = @calc OUT,@focus=1,@select=1\r\n\r\nEXEC sp_api_modal_button @name='button',@value = 'Bereken',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\r\nBEGIN TRY\r\n\r\nDECLARE @KeepValues nvarchar(50) = N'%[^0-9+*/().-]%'\r\n    While PATINDEX(@KeepValues, @calc) > 0\r\n        Set @calc = Stuff(@calc, PatIndex(@KeepValues, @calc), 1, '')\r\n\tSET @result = @calc +' = '\r\n\tSET @sql = N'SET @calc = TRY_CAST((1.0*'+@calc+') as decimal(18,2))'\r\n\tSET @calc = 0\r\n\tEXEC sp_executesql @sql,N'@calc decimal(18,2) OUT',@calc OUT\r\n\tSET @result+= @calc\r\nEND TRY BEGIN CATCH\r\n\tSET @result+= 'Err'\r\n END CATCH\r\nEXEC sp_api_modal_text @result\r\n",
            "action_id": 150,
            "action_name": "Calculator",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--update xlfctr SET ischecked=iif(ischecked=0,1,0) WHERE id=@ID;\n--EXEC sp_api_toast 'LFCTR Check gewijzigd'\nDECLARE @idval int, @docdesc nvarchar(128)\n\n-- CVG 21/10/19 Controleer of de LFCTR reeds al gelinkt is aan een verkoop welke niet meer status \"openSale\" heeft. Indien dit zo is mag ik niet meer ge unchecked worden.\nIF EXISTS (SELECT TOP 100 * FROM xIVLINK IVL WHERE EXISTS (SELECT * FROM Q_xTransactionDetail ctr where \nEXISTS (SELECT * FROM xTransactionHeader cth WHERE cth.[status] != 'openSale' AND id = ctr.transactionheader_id) \nAND ctr.id = IVL.ITD AND IVL.VTD IN (SELECT CTR_ID FROM XLFCTR WHERE ischecked = 1 AND ID IN ({@ids})))) \n\tBEGIN\n\tEXEC sp_api_modal_alert N'LET OP!',N'Regels zijn reeds toegewezen aan een verkoop welke niet meer de status \"openSale\" heeft. U kan de regel niet meer van \"checked\" afhalen.'\n\tEXEC sp_api_modal_clear\n\tRETURN\n\tEND\n\t\nIF {[inkomende_landfreight].To_Location_ID} IN (SELECT ID FROM xLocation WHERE isEntrepot = 1)\n\tBEGIN\n\t\tEXEC sp_api_modal_alert N'De regel wordt gelost op een transito lokatie!',N'Enkel (Richard of Sabine mogen dit uitlossen!)'\n\t\tEXEC sp_api_modal_clear\n\t\tRETURN\n\tEND\n\nDECLARE @cursor_xLFCTR CURSOR\n\nIF EXISTS (SELECT * FROM xlfctr where id IN ({@ids}) AND ischecked = 0)\n\tBEGIN\n\t\tSET @action = 1\n\tEND\nELSE\n\tBEGIN\n\t\tSET @action = 0\n\t\tIF {[inkomende_landfreight].id} is not null\n\t\tBEGIN\n\t\tUPDATE XLANDFREIGHT SET i_selected = 0 where ID = {[inkomende_landfreight].id}\n\t\tEND\n\tEND\n\nIF @action = 0 AND EXISTS (SELECT * FROM xlfctr where id IN ({@ids}) AND ischecked = 1)\n\tBEGIN\n\t\tEXEC sp_api_modal_text N'Deze geselecteerde regels staan al op checked:'\n\t\tSET @cursor_xLFCTR = CURSOR LOCAL FAST_FORWARD FOR SELECT id FROM xlfctr where id IN ({@ids}) AND ischecked = 1\n\t\tOPEN @cursor_xLFCTR;\n\t\tFETCH NEXT FROM @cursor_xLFCTR INTO @idval\n\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\n\t\t\t\tSET @text = (SELECT docDescription FROM xlfctr where id = @idval)\n\t\t\t\tEXEC sp_api_modal_text @text\n\t\t\t\tFETCH NEXT FROM @cursor_xLFCTR INTO @idval\n\t\t\tEND\n\t\tCLOSE @cursor_xLFCTR;\n\t\tDEALLOCATE @cursor_xLFCTR;\n\t\tEXEC sp_api_modal_button @name='@button',@value = 'Doorgaan', @valueout = @button OUT,@class='btn-danger',@key='Enter'\n\t\tIF @button IS NULL RETURN\n\tEND\n\t\n\tSET @cursor_xLFCTR = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\n\tOPEN @cursor_xLFCTR;\n\tFETCH NEXT FROM @cursor_xLFCTR INTO @idval\n\tWHILE @@FETCH_STATUS = 0\n\t\tBEGIN\n\t\t\t--IF (SELECT ischecked FROM xlfctr where id = @idval) = 0\n\t\t\t--BEGIN\n\t\t\t\tUPDATE xlfctr SET ischecked = @action WHERE id = @idval\n\t\t\t\t/*\n\t\t\t\tEXEC sp_api_modal_post N'xlfctr',N'ischecked',@action,@idval\n\t\t\t\tEXEC sp_api_modal_save N'xlfctr',@idval\n\t\t\t\t*/\n/*\t\t\tEND\n\t\t\tELSE\n\t\t\tBEGIN\n\t\t\t\tSET @docdesc = concat('Een geselecteerde regel staat al op checked zie: ',(SELECT docDescription FROM xlfctr where id = @idval))\n\t\t\t\tEXEC sp_api_modal_alert N'Zeker weten?',@docdesc\n\t\t\t\tEXEC sp_api_modal_post N'xlfctr',N'ischecked',0,@idval\n\t\t\t\tEXEC sp_api_modal_save N'xlfctr',@idval\n\t\t\tEND\n*/\n\t\t--UPDATE xlfctr SET ischecked=iif(ischecked=0,1,0) WHERE id=@ID;\n\t\t\t\n\t\tFETCH NEXT FROM @cursor_xLFCTR INTO @idval\n\t\tEND\nCLOSE @cursor_xLFCTR;\nDEALLOCATE @cursor_xLFCTR;\n\nEXEC sp_api_modal_clear\nEXEC sp_api_modal_select_all_clear\n",
            "action_id": 151,
            "action_name": "CheckUncheck",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @days nvarchar(32) = 7,@button nvarchar(32)\nEXEC sp_api_modal_input @name='Days',@max=5, @value= @days OUT,@focus=1,@select=1\n\nDECLARE @text nvarchar(max) = N'Completed tasks (without errors) older then '+@days+' days will be cleaned'\nEXEC sp_api_modal_text N'Clean Tasks',N'h4 text-muted'\nEXEC sp_api_modal_text @text,N'm-4 text-muted'\nEXEC sp_api_modal_button @name='Remove',@value = 'Clean', @valueout = @button OUT,@class='btn-danger',@key='Enter'\n\nIF TRY_CAST(@days as INT) IS NOT NULL AND @button IS NOT NULL\n\tBEGIN\n\t\tDELETE FROM api_sql_tasks WHERE DATEDIFF(day, completed, GETDATE()) > (@days-1)\n\t\tEXEC sp_api_modal_clear\n\tEND",
            "action_id": 154,
            "action_name": "Clean Tasks",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @set nvarchar(max) = N'name=name+''_clone''' -- CUSTOMIZE THIS!!!\n\nEXEC sp_api_modal_alert N'Clone',N'Create a clone of this record?'\nDECLARE @clone_id nvarchar(32)\nEXEC @clone_id = sp_clone_record @basetable,@ids,@set=@set\nEXEC sp_api_modal_clear\nSET @path = @path+'/'+@clone_id\nEXEC sp_api_modal_text N'Record cloned',N'h4 text-muted'\nEXEC sp_api_modal_route @name = N'Go to clone',@pathname=@path,@key='Enter'\n",
            "action_id": 155,
            "action_name": "clone",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 156,
            "action_name": "clone",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec dbo.sp_clone_record N'xLotArtSize', @ID, 'Size=NULL, xBrand_ID = NULL ' --Name_1=null,Name_0=Name_0+''_rick'',[FreeText] = 0-CAST(CountryNumber as int)'\r\n --",
            "action_id": 157,
            "action_name": "Clone",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.[dbo].[CloseCTH8] @ID",
            "action_id": 159,
            "action_name": "Close Relocation",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast N'CMR afdrukken' \n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\t--dit is nu alleen voor tellers en checks:\n\n\t\t--even niet registreren dat er wordt afgedrukt\n\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'LF'\t,@Context_Key_ID=@cid,@Report_CODE=N'CMR'\n\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select top 1 id from xTenantKey) -- een CRM wordt naar tenant gestuurd/geprint\n\t\t--DECLARE @error INT\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = 'cmr' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\n\t\t--IF @error > 0 RAISERROR(N'Er is een probleem')\n\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 160,
            "action_name": "CMR",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_alert N'COCO'\r\nEXEC sp_api_modal_clear\r\nEXEC sp_api_toast @ID\r\n\r\nIF {[verkoop2].status} not in ('openSale') BEGIN\r\n\tEXEC sp_api_modal_alert 'Toevoegen alleen bij status: openSale'\r\n\tEXEC sp_api_modal_clear\t\t\r\n\tRETURN;\t\r\n\tend",
            "action_id": 161,
            "action_name": "coco alert",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--EXEC sp_api_toast @Parent_ID\nDECLARE @COPYFROMCOMPANY INT, @button nvarchar(200)\nEXEC sp_api_modal_select @card_name = N'adres',@value = @COPYFROMCOMPANY OUT,@focus = 1\n\nEXEC sp_api_modal_button @name='@button',@value = 'Opslaan', @valueout = @button OUT,@class='btn-danger',@key='Enter'\nIF @button IS NOT NULL \nBEGIN\n\tEXEC @main_db.dbo.SP_CopyCostSettings @FromCompany= @COPYFROMCOMPANY, @ToCompany = @Parent_ID\n\tEXEC sp_api_modal_clear\nEND",
            "action_id": 166,
            "action_name": "Copy Csettings from Other Company",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @NEWID INT\r\n--201007 herschrijf DECLARE size als dze niet in overeenstemming is met DE lot art size\r\nDECLARE @lasSize nvarchar(20) =(SELECT size FROM xlotartsize WHERE id=(SELECT xLotArtSize_ID FROM xlotpallets WHERE id=@ID))\r\nIF (SELECT rsize FROM xlotpallets WHERE id=@ID) <> @lasSize\r\n\tBEGIN\r\n\t\tupdate xlotpallets SET LinkedStockID = NULL, rsize=@lasSize WHERE id=@ID\r\n\tend\r\nIF 1=1 --(SELECT CTRS FROM Q_xLotpallets WHERE id=@ID)=0 \r\n\tBEGIN\r\n\r\n\t\tEXEC @NEWID=@main_db.dbo.SP_IINE_xStock_LP @ID\r\n\t\t-- binnen SP_IINE_xStock_LP wordt het stock_id gekoppeld aan DE LP als er maar precies 1 stock_id mogelijk is\r\n\tend\r\n\r\nELSE\r\n\tEXEC sp_api_toast 'CTRS moet op 0 staan. Zorg tevens dat u een unieke combinatie van velden heeft.'\r\n",
            "action_id": 167,
            "action_name": "Create StockID",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "UPDATE xmoment SET FetchPrices=1 WHERE ID= @ID\r\nEXEC sp_api_toast 'TIMER TAAK IS GEMAAKT!'\r\n--dit doet SP_AGFX nu: exec dbo.sp_CreatePriceMoment_For_Moment @MomentID\r\n--SET @TX2= (SELECT count(*) FROM tpwComm)",
            "action_id": 168,
            "action_name": "CreateMoment",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @R nvarchar(50),@P nvarchar(50),@ctrID int\r\nSET @ctrID={[lotpallets].linkedctrid}\r\nIF @ctrID is null BEGIN\r\n\tEXEC sp_api_Toast N'ER IS NOG GEEN CTR'\r\n\tEND\r\nELSE BEGIN\r\n\tSET @P=concat(N'/view_ctr1/',@ctrID)\r\n\tEXEC sp_api_goto @P\r\nEND ",
            "action_id": 170,
            "action_name": "CTR1",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @text nvarchar(max) = {[verkoop].status}--Counterparty_ID.CompanyName\r\nEXEC sp_api_toast @text ",
            "action_id": 171,
            "action_name": "curlytest",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_goto @path='/xcustomsoffice'",
            "action_id": 172,
            "action_name": "CustomsOffice",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.SP_Curs_SwapDelayCTH @ID",
            "action_id": 175,
            "action_name": "Delayed On/Off",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.DeleteCompany @ID ",
            "action_id": 176,
            "action_name": "Delete Company",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.DeleteLocation @ID",
            "action_id": 179,
            "action_name": "Delete Location",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "/*EXEC sp_api_modal_alert N'Delete',N'Regel(s) verwijderen?'\nDECLARE @cursor CURSOR,@idval INT\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @idval\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\t--DECLARE @task nvarchar(max) = CONCAT('UPDATE xtransactiondetail set amount = 0, price = 0 where id = ',@idval,';EXEC @main_db.dbo.DeleteCTR ',@idval)\n\t\t--EXEC sp_api_add_sql_task @task\n\t\t--Update xtransactiondetail set amount = 0, price = 0 where id = @idval\n\t\tEXEC @main_db.dbo.DeleteCTR @idval\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\nEXEC sp_api_modal_clear\nEXEC sp_api_modal_select_all_clear\n*/\n\nIF EXISTS (SELECT * FROM xIVLINK  where (ITD IN({@IDS}) OR VTD IN({@IDS})) AND EXISTS (SELECT * FROM xtransactionheader WHERE [status] = 'openPrice'))\n\tBEGIN\n\t\tEXEC sp_api_modal_alert N'De inkoop is toegewezen aan een commissie verkoop!',N'De regel kan niet verwijderd worden!'\n\t\tEXEC sp_api_modal_clear\n\t\tRETURN;\n\tEND\n\t\nIF {[inkoop].status} IN('openPurchase','openPurchaseC') OR {[inkoop_loods].status} IN('openPurchase','openPurchaseC') OR {[ctr1].CTH_fase} IN('openPurchase','openPurchaseC')\n\tBEGIN\n\t\tEXEC sp_api_modal_alert N'Zeker weten?',N'Het aantal wordt op 0 gezet, en daarna geheel verwijderd!'\n\t\tDECLARE @cursor CURSOR,@idval INT\n\t\tSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\n\t\tOPEN @cursor;\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\t\n\t\t\t\tIF EXISTS (SELECT * FROM code_ctr_at_location WHERE ctr_id = @idval GROUP BY ctr_id HAVING SUM(amount) = SUM(available))\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tDECLARE @detail nvarchar(255), @TH_id nvarchar(255)\n\t\t\t\t\t\tSET @detail = (SELECT concat(Amount,' ',detail) from q_xtransactiondetail where id = @idval)\n\t\t\t\t\t\tSET @TH_id = (SELECT transactionheader_id from q_xtransactiondetail where id = @idval)\n\t\t\t\t\t\tDECLARE @textlog nvarchar(255) = concat(N'actie [Verwijder] gestart op order: ',@TH_id,' op product: ',@detail)\n\t\t\t\t\t\tEXEC @main_db.dbo.actielog @Card_name , @textlog\n\t\t\t\t\t\t\n\t\t\t\t\t\tEXEC @main_db.dbo.DeleteCTR @idval\n\t\t\t\t\tEND\n\t\t\t\tELSE\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tEXEC sp_api_toast N'Kan ctr niet verwijderen: deels overgebracht of toegewezen'\n\t\t\t\t\tEND\n\t\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\tEND\n\t\tCLOSE @cursor;\n\t\tDEALLOCATE @cursor;\n\t\tEXEC sp_api_modal_clear\n\t\tEXEC sp_api_modal_select_all_clear\n\tEND\n\tELSE\n\tBEGIN\n\t\tEXEC sp_api_modal_alert N'De inkoop is gesloten',N'De regel kan niet verwijderd worden!'\n\t\tEXEC sp_api_modal_clear\n\t\tRETURN;\n\tEND\n",
            "action_id": 180,
            "action_name": "Verwijder",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 181,
            "action_name": "Deurbel",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 182,
            "action_name": "Deurbel Ding Dong2",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--\tCONTEXT: CTR\n--\t============\n\n--declare @ctrtoloc int, @ctrfromloc int ,@checkamt int-- (oorspronkelijke) advieslokaties\n--declare @Direct int=1\n--declare @Normaal int=2\n--select @ctrtoloc =tocloc_id, @ctrfromloc=frmloc_id,@checkamt=iif(stockmut=1,amount,0) from xtransactiondetail where id=@ID\n--update xtransactiondetail set Flowmodel_id=@Direct where id=@ID\n--update xlfctr set ltrtoloc=ltrfromloc where ctr_id=@ID and lfctr_amount=@checkamt -- let op: dit gaat alleen goed bij volledige ctr op lfctr!\n\n-- hierboven was de oude, zonder meenemen van iv-gelinkte  verkoop\n\ndeclare @ctrtoloc int, @ctrfromloc int ,@checkamt int-- (oorspronkelijke) advieslokaties\ndeclare @Direct int=1\ndeclare @Normaal int=2\ndeclare @isEqual bit=0\n\n--210330 op deze plaats toegevoegd: Check op volledige en enkelvoudige IVLINK\ndeclare @linkCount int, @linkAmount int\nselect @linkCount=linkCount, @linkAmount=linked from @main_db.dbo.ctr_linkinfo(@ID) \nDECLARE @ThisAmount int\ndeclare @ThisTDT int\nselect @ThisAmount=Amount, @ThisTDT=tdt from xtransactiondetail where id=@ID\n\nif @linkCount <> 1 OR @linkAmount<>@ThisAmount\n\tbegin\n\t\texecute sp_api_modal_alert N'De IV link is niet volledig en enkelvoudig. Omzetten naar Direct kan nog niet...'\n\t\texecute sp_api_modal_clear\n\t\treturn; -- klaar kappen\n\tend\n\n--we zijn hier, dus hebben we een volledige link\ndeclare @CounterCTR int\nselect @CounterCTR= iif(itd=@id,vtd,itd) from xivlink where itd=@id or vtd=@id\n\n\n\nselect @ctrtoloc =tocloc_id, @ctrfromloc=frmloc_id,@checkamt=iif(stockmut=1,amount,0) from xtransactiondetail where id=@ID\nupdate xtransactiondetail set Flowmodel_id=@Direct where id=@ID\nupdate xlfctr set ltrtoloc=@ctrfromloc,ltrfromloc=@ctrfromloc, @isEqual=iif(lfctr_amount-@checkamt=0,1,0) where ctr_id=@ID and lfctr_amount=@checkamt \n-- let op: dit gaat alleen goed bij volledige ctr op lfctr!\n\n\nif @isEqual=1\n\tbegin\n\t\t--pas ook de lfctr aan van de aan deze inkoopregel gelinkte verkoopregels\n\t\tDECLARE @cursor_ids CURSOR,@cid INT\n\t\tSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR (select ITD as ivCTR from xivlink where vtd=@ID UNION select VTD as ivCTR from xivlink where itd=@ID) \n\t\tOPEN @cursor_ids;\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\n\t\t\t\t--geef de lfctr van de verkoop ctr een nieuwe laadlokatie\n\t\t\t\tupdate xtransactiondetail set Flowmodel_id=@Direct where id=@cid\n\t\t\t\t-- als er voor de gewijzigde lfctr lokaties geen LF is, wordt deze aangemaakt. zie trigger xlfctr\n\t\t\t\tupdate xlfctr set ltrfromloc=@ctrfromloc where ctr_id=@cid -- schrijf de fromloc van de inkooplokatie in de from van de verkoop lfctr\n\t\t\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\t\t\tEND\n\t\tCLOSE @cursor_ids;\n\t\tDEALLOCATE @cursor_ids;\n\t\t\n\n\n\t/*\t\n\t\t--210330 extra trucje hier: europalletregels toevoegen en koppelen\n\t\tdeclare @Europallet_stockID int , @NewID int , @NewEuroCTR int\n\t\tset @Europallet_stockID=78867 -- of ingewikkeld doen door iets te zoeken...(select top 1 id from xstock where .... )\n\t\texecute @NewID = @main_db.dbo.Clone_CTR_to_StockID @IDS=@ID, @Stock_ID=@Europallet_stockID, @FromLocID=@ctrfromloc\n\t\t\n\t\t--en de counter copy\n\t\texecute @NewEuroCTR = @main_db.dbo.Clone_CTR_to_StockID @IDS=@CounterCTR, @Stock_ID=@Europallet_stockID\n\t\tif @NewID >0 AND @NewEuroCTR >0\n\t\t\tinsert into xivlink(itd,vtd,stock_id,linkAantal) \n\t\t\t\tvalues (\n\t\t\t\t\tiif(@ThisTDT=1,@NewEuroCTR,@NewID)\n\t\t\t\t\t,iif(@ThisTDT=1,@NewID,@NewEuroCTR)\n\t\t\t\t\t,@Europallet_stockID\n\t\t\t\t\t,1 -- 1 pallet!\n\t\t\t\t\t)\n\n*/\n\tend\n\n\n",
            "action_id": 183,
            "action_name": "Directe verlading",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @search nvarchar(2000) = N'',@button nvarchar(128)\n--SELECT * INTO #modaltable FROM fn_api_get_curly_params_by_search(@search)\nEXEC sp_api_modal_select_curly @value = @search OUT\nEXEC sp_api_modal_button @name='button',@value=N'Parse',@valueout=@button OUT,@key='Insert'\nIF @button IS NOT NULL\n\tBEGIN\n\t\tDECLARE @sql nvarchar(max) = N'{'+@search+'}'\n\t\tEXEC sp_api_card_curly_replace @card_id = @card_id, @string = @sql OUT\n\t\tEXEC sp_api_modal_text @sql,N'code'\n--\t\tEXEC sp_api_modal_field_insert @card_field_id,@search\n--\t\tEXEC sp_api_modal_clear\n\tEND\n--EXEC sp_api_modal_field_insert @card_field_id,N'Afleveren bij loods 5'\n/*\nreturn\n--DECLARE @rawdata varbinary(max) = (SELECT * FROM OPENROWSET(BULK 'C:\\Beheer\\backup\\tracy_fka_proj.bak', SINGLE_BLOB) as f)\nDECLARE @rawdata varbinary(max) = (SELECT * FROM OPENROWSET(BULK 'C:\\Windows\\explorer.exe', SINGLE_BLOB) as f)\nEXEC sp_api_modal_download @rawdata=@rawdata,@filename=N'abc.zip'\n*/",
            "action_id": 184,
            "action_name": "dl file",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--als er vrije LF is, maak dan een nieuwe docset END stop alle vrije LF er in\r\n--IF exists()\r\nSET @path = @path+'/'+@ID+'/tdocset'--+dbo.nv(@clone_id)\r\nEXEC sp_api_goto @path ",
            "action_id": 185,
            "action_name": "doc",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @filename nvarchar(1024) = concat(dbo.strdate(NULL),'-test.csv')\nSELECT top 10 * INTO #temptable FROM xstock\nEXEC sp_api_modal_csv @tmptable=N'#temptable', @filename=@filename\n\n--select TOP 10000 * into #cities FROM xCity --WHERE country_id = 151\n--exec sp_api_modal_csv @tmptable=N'#cities', @filename=N'yoyo cities.csv'\n--select * into #modaltable13 FROM xCountry\n--exec sp_api_modal_csv @tmptable=N'#modaltable13', @filename=N'yoyo country456.csv'\n",
            "action_id": 186,
            "action_name": "download csv",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @search nvarchar(128) ,@button nvarchar(128), @datumtijd nvarchar(50)\nDECLARE @filename nvarchar(1024) \n,@VroegNegatiefdownload nvarchar(128) = dbo.strdate(NULL) +'_'+ 'VroegNegatief.csv'\n,@Negatiefdownload nvarchar(128) = dbo.strdate(NULL) +'_'+ 'Negatief.csv'\n,@Reserveddownload nvarchar(128) = dbo.strdate(NULL) +'_'+ 'Gereserveerd.csv'\n,@Notzerodownload nvarchar(128) = dbo.strdate(NULL) +'_'+ 'Voorraad.csv'\nSET @datumtijd = FORMAT(getdate(),'dd MMM yyyy HH:mm')\n\n--EXEC sp_api_modal_input @name='search',@value = @search OUT,@focus=1 -- zoek veld\nEXEC sp_api_modal_modal @class = 'w100'\nSET @button = 'VroegNegatief'\nEXEC sp_api_modal_button @name='button',@value = 'VroegNegatief',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_button @name='button',@value = 'Negatief',@valueout = @button OUT,@class = 'btn-primary',@key = 'F2'\nEXEC sp_api_modal_button @name='button',@value = 'Gereserveerd',@valueout = @button OUT,@class = 'btn-primary',@key = 'F3'\nEXEC sp_api_modal_button @name='button',@value = 'Alles',@valueout = @button OUT,@class = 'btn-primary',@key = 'F4'\nEXEC sp_api_modal_button @name='button',@value = 'VolledigeLijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F5'\nEXEC sp_api_modal_button @name='button',@value = 'Partijvoorraad',@valueout = @button OUT,@class = 'btn-primary',@key = 'F6'\nEXEC sp_api_modal_print @keycode='F9'\nEXEC sp_api_modal_text @datumtijd, @printonly=1\n\nIF @button =  'VroegNegatief'\nBEGIN\nSELECT DISTINCT [Description~col-sm-5] = Description, Origin_Code, Size, xBrandName, ContentDesc, FustCode, 'Vroeg Negatief' AS [CAP*]\n\t,[verwacht@g] = VoorraadVerwacht@, [Voorraad@g] = Voorraad@\nINTO #VroegNegatief\nFROM          RV_IR_Voorraad\nWHERE        (Voorraad@ < 0) AND ([EndTime*] = 'Vroeg') AND (CoreType = 'FOOD')\nEXEC sp_api_modal_table @tmptable=N'#VroegNegatief',@orderby=N'ORDER BY [CAP*],1 ASC',@print=1\nEXEC sp_api_modal_button @name='button',@value = 'VroegNegatiefNaarCSV',@valueout = @button OUT,@class = 'btn-success'\nEND \n\nIF @button =  'VroegNegatiefNaarCSV'\nBEGIN\nSELECT DISTINCT Voorraad@, VoorraadVerwacht@, Description, Origin_Code, Size, xBrandName, ContentDesc, FustCode, 'Vroeg Negatief' AS [CAP*]\nINTO #VroegNegatiefdownload\nFROM          RV_IR_Voorraad\nWHERE        (Voorraad@ < 0) AND ([EndTime*] = 'Vroeg') AND (CoreType = 'FOOD')\nEXEC sp_api_modal_csv @tmptable=N'#VroegNegatiefdownload',@orderby=N'ORDER BY [CAP*],Description ASC', @filename= @VroegNegatiefdownload,@ansi=1\nEND \n\n\nIF @button =  'Negatief'\nBEGIN\nSELECT DISTINCT [Description~col-sm-5] = Description, Origin_Code, Size, xBrandName, ContentDesc, FustCode, 'Negatief' AS [CAP*]\n\t,[verwacht@g] = VoorraadVerwacht@, [Voorraad@g] = Voorraad@\nINTO #Negatief\nFROM          RV_IR_Voorraad\nWHERE        (Voorraad@ < 0) AND (CoreType = 'FOOD')\nEXEC sp_api_modal_table @tmptable=N'#Negatief',@orderby=N'ORDER BY [CAP*],1 ASC',@print=1\nEXEC sp_api_modal_button @name='button',@value = 'NegatiefNaarCSV',@valueout = @button OUT,@class = 'btn-success'\nEND \n\nIF @button =  'NegatiefNaarCSV'\nBEGIN\nSELECT DISTINCT Voorraad@, VoorraadVerwacht@, Description, Origin_Code, Size, xBrandName, ContentDesc, FustCode, 'Negatief' AS [CAP*]\nINTO #Negatiefdownload\nFROM          RV_IR_Voorraad\nWHERE        (Voorraad@ < 0) AND (CoreType = 'FOOD')\nEXEC sp_api_modal_csv @tmptable=N'#Negatiefdownload',@orderby=N'ORDER BY [CAP*],Description ASC', @filename= @Negatiefdownload,@ansi=1\nEND \n\nIF @button =  'Gereserveerd'\nBEGIN\nSELECT DISTINCT ReservedIn@, ReservedOut@, [Description~col-sm-5] = Description, Origin_Code, Size, xBrandName, ContentDesc, FustCode, 'Gereserveerd' AS [CAP*]\n\t,[verwacht@g] = VoorraadVerwacht@, [Voorraad@g] = Voorraad@\nINTO #Gereserveerd\nFROM          RV_IR_Voorraad\nWHERE        (ReservedIn@ <> 0 OR ReservedOut@ <> 0) AND (CoreType = 'FOOD')\nEXEC sp_api_modal_table @tmptable=N'#Gereserveerd',@orderby=N'ORDER BY [CAP*],3 ASC',@print=1\nEXEC sp_api_modal_button @name='button',@value = 'GereserveerdNaarCSV',@valueout = @button OUT,@class = 'btn-success'\nEND \n\nIF @button =  'GereserveerdNaarCSV'\nBEGIN\nSELECT DISTINCT Voorraad@, VoorraadVerwacht@, ReservedIn@, ReservedOut@, Description, Origin_Code, Size, xBrandName, ContentDesc, FustCode, 'Gereserveerd' AS [CAP*]\nINTO #GereserveerdNaarCSV\nFROM          RV_IR_Voorraad\nWHERE        (ReservedIn@ <> 0 OR ReservedOut@ <> 0) AND (CoreType = 'FOOD')\nEXEC sp_api_modal_csv @tmptable=N'#GereserveerdNaarCSV',@orderby=N'ORDER BY [CAP*],Description ASC', @filename= @Reserveddownload,@ansi=1\nEND \n\nIF @button =  'Alles'\nBEGIN\nSELECT DISTINCT [Description~col-sm-5] = Description, Origin_Code, Size, xBrandName, ContentDesc, FustCode, 'Alles' AS [CAP*]\n\t,[verwacht@g] = VoorraadVerwacht@, [Voorraad@g] = Voorraad@ --, [Correctie] = '         '\nINTO #Notzero\nFROM          RV_IR_Voorraad\nWHERE        (Voorraad@ <> 0) AND (CoreType = 'FOOD')\nSET @datumtijd = FORMAT(getdate(),'dd MMM yyyy HH:mm')\nDECLARE @sql nvarchar(max) = N'ALTER TABLE #Notzero ADD ' + QUOTENAME(@datumtijd+'~col-sm-2') +' nvarchar(128)'\nEXEC (@sql)\nEXEC sp_api_modal_table @tmptable=N'#Notzero',@orderby=N'ORDER BY [CAP*],1 ASC',@fontsize='120%',@print=1\nEXEC sp_api_modal_button @name='button',@value = 'AllesNaarCSV',@valueout = @button OUT,@class = 'btn-success'\nEND \n\n--\n\nIF @button =  'Partijvoorraad'\nBEGIN\nSELECT CatSub_0 as [CatSub*], Variety_0 as [Botanic~col-sm-2 wrap],ContentDesc as [inhoud~col-sm-1],Size as [maat~col-sm-1],Detail_0 as [Detail~col-sm-1],Origin_Code as [LVO~col-sm-1-2] ,KGN as [Kgn~col-sm-1],FustCode as [Fustcode~col-sm-1],TransactionHeader_ID as [InkNr:0~col-sm-1] \n,\tleft(counter_code,8) as [Lev~col-sm-1],\tLEFT((select CONVERT(VARCHAR, LFDATE , 13)), 6) as [Datum~col-sm-1]\n,\tVoorraad as [Stock:0~col-sm-1]\n\nINTO #PartijStock\nFROM          @main_db.dbo.StockPerLot_date(dbo.abcdate()) -- alles verkocht t/m vandaag!\nwhere [catsub_0] > N'' -- RH210209 hiermee wordt fust weggelaten\nEXEC sp_api_modal_table @tmptable=N'#PartijStock'\n,@orderby=N'ORDER BY [catsub*],[Botanic~col-sm-2 wrap]  ASC'\n,@fontsize='100%',@print=1\nEND \n\n\nIF @button =  'AllesNaarCSV'\nBEGIN\nSELECT DISTINCT Voorraad@, VoorraadVerwacht@, Description, Origin_Code, Size, xBrandName, ContentDesc, FustCode, 'Negatief' AS [CAP*]\nINTO #Notzerodownload\nFROM          RV_IR_Voorraad\nWHERE        (Voorraad@ <> 0) AND (CoreType = 'FOOD')\nEXEC sp_api_modal_csv @tmptable=N'#Notzerodownload',@orderby=N'ORDER BY [CAP*],Description ASC', @filename= @Notzerodownload,@ansi=1\nEND \n\nIF @button =  'VolledigeLijst'\n\tBEGIN\n\t\tDECLARE @datum nvarchar(128),@button2 nvarchar(128)\n\t\tEXEC sp_api_modal_text N'Kies de datum voor de voorraadlijst (dit is een lange lijst!!)'\n\t\tEXEC sp_api_modal_date @name='datum',@value = @datum OUT\n\t\tEXEC sp_api_modal_button @name='button2',@value = 'Laad lijst',@valueout = @button2 OUT,@class = 'btn-success',@key = 'Enter'\n\n\t\tIF @button2 IS NOT NULL\n\t\t\tBEGIN\n\t\t\t\tSELECT *\n\t\t\t\tINTO #VolledigeLijst\n\t\t\t\tFROM @main_db.dbo.stockByDate(@datum)\n\t\t\t\tEXEC sp_api_modal_table @tmptable=N'#VolledigeLijst',@orderby=N'ORDER BY ARTIKEL ASC'\n\t\t\tEND\n\tEND",
            "action_id": 189,
            "action_name": "Voorraad Lijsten",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @Naam nvarchar(200)=(select size from xstock where id=@ID)\ndeclare @xbol_ID INT ={[xbol].id}\nif @xBol_ID is not null update xbol set DocNumber=@naam where id=@xBol_ID\n\nexec sp_api_go2",
            "action_id": 194,
            "action_name": "vul BOL",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.Fill_xPerArtSelection",
            "action_id": 195,
            "action_name": "Vul PER bronlijst met historische Artikelen",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.[dbo].[Fill_xPerArtSelection]",
            "action_id": 196,
            "action_name": "vul_vanuit_orderhistorie",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "----------------------------------------------------------------------------------------\n--\tAuthor:\t\t\tRH\n--\tDate: \t\t\t191120\n--\tAction: \t\tIngeven van een nieuwe wisselkoers\n--\tContext card: \tCurrency\n--\tpre declare:\tnone\n--\tDIT IS MODELCODE VOOR VERGELIJKBARE OMGEVINGEN ALS DIESELTOESLAG EN DOUANE TARIEVEN\n----------------------------------------------------------------------------------------\nDECLARE @mes nvarchar(200), @FustSaldo int, @CoreType nvarchar(10),@FustID int, @xDesc nvarchar(200)\n\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\nDECLARE @prijs nvarchar(20),@aantal nvarchar(20) --='100'\nDECLARE @xCurrencyID INT={[currency].id}\nDECLARE @ISO nvarchar(10)={[currency].codeISO}\nif @xCurrencyID IS NULL \n\tBEGIN\n\t\tEXEC SP_API_TOAST N'Er is geen Currency kaart geopend.'\n\t\tRETURN;\n\tEND\nif @ISO =N'EUR'\t\n\tbegin\n\t\texec sp_api_modal_alert N'U kunt geen koers van de euro opgeven, die is namelijk altijd 1,00000 '\n\t\treturn;\n\tend\n\n\nDECLARE @FlowModel int\nDECLARE @THDT INT\n\ndeclare @datum nvarchar(512)\nDECLARE @koers nvarchar(20)\nset @mes=N'Invoeren van een nieuwe wisselkoers'\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\nEXEC sp_api_modal_text 'Datum'\nSET @datum = '2020-10-30'\nEXEC sp_api_modal_date @name='Ingangsdatum:',@value= @datum OUT,@class = 'w-25'\nEXEC sp_api_toast @datum\n\ndeclare @Txt1 nvarchar(200)=concat(N'Wisselkoers: (de waarde van 1 ',@ISO,N') in euro''s opgeven')\nEXEC sp_api_modal_text @txt1\nEXEC sp_api_modal_input @name='koers',@value = @koers OUT\nIF @Koers>N'' SET @Koers=replace(@Koers, ',', '.') -- zorg dat punten en komma's als dec. seperator zijn toegestaan..\n\nDECLARE @button nvarchar(128)\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\nIF @button IS NOT NULL\n\tBEGIN\n\t\texec @main_db.dbo.SetxValRate_F \t@Code = N'CURRENCY'\t,@ContextID =@xCurrencyID\t,@StartDate =@datum\t,@F =@koers\n\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\tRETURN\n\tEND\n\n\n",
            "action_id": 197,
            "action_name": "Waarde/koers ingeven",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "if ({[inkoop].ivtotal})<>0 \n\tbegin\n\t\texec sp_api_toast N'Er is al verkocht, kan Loslokatie niet wijzigen '\n\t\treturn\n\tend\n\ndeclare @LocID nvarchar(200)\nEXEC sp_api_modal_select @card_name=N'xlocation',@value = @locID OUT,@focus=1,@placeholder=N'Kies de verwachte loslokatie'\n\nIF @locID > 0\n\t\tBEGIN\n\t\t\tUPDATE xtransactionheader SET Destination_ID = @LocID WHERE id = @id\n\t\t\tDECLARE @idval INT\n\t\t\tDECLARE @cursor CURSOR\n\t\t\t\tSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT id from xtransactiondetail where transactionheader_id = @id\n\t\t\t\tOPEN @cursor;\n\t\t\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\t\t\tWHILE @@FETCH_STATUS = 0\n\t\t\t\t\tBEGIN\n\t\t\t\t\tUPDATE xtransactiondetail SET TocLoc_ID = @LocID WHERE id = @idval\n\t\t\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\t\t\tEND\n\t\t\t\t\t\n\t\t\t\tCLOSE @cursor;\n\t\t\t\tDEALLOCATE @cursor;\n\t\t\t--EXEC sp_api_modal_clear\n\t\t\t--EXEC sp_api_modal_select_all_clear\n\nEND\n\n\nIF @locID > 0\n\t\tBEGIN\n\t\t\tDECLARE @LFidval INT\n\t\t\tDECLARE @LFcursor CURSOR\n\t\t\t\tSET @LFcursor = CURSOR LOCAL FAST_FORWARD FOR SELECT id from xlandfreight where transactionheader_id = @id AND typeCode = 'PURCHTRANS'\n\t\t\t\tOPEN @LFcursor;\n\t\t\t\t\tFETCH NEXT FROM @LFcursor INTO @LFidval\n\t\t\t\t\tWHILE @@FETCH_STATUS = 0\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\n\t\t\t\t\tUPDATE xlandfreight SET To_Location_ID = @LocID WHERE id = @LFidval\n\t\t\t\t\t--EXEC sp_api_modal_post N'inkomende_landfreight',N'To_Location_ID',@LocID,@LFidval\n\t\t\t\t\t--EXEC sp_api_modal_save N'inkomende_landfreight',@LFidval\n\t\t\t\t\t\n\t\t\t\t\tFETCH NEXT FROM @LFcursor INTO @LFidval\n\t\t\t\t\tEND\n\t\t\t\t\t\n\t\t\t\tCLOSE @LFcursor;\n\t\t\t\tDEALLOCATE @LFcursor;\n\t\t\tEXEC sp_api_modal_clear\n\t\t\tEXEC sp_api_modal_select_all_clear\n\nEND\n\n/*\nif @locID is not NULL\n\tbegin\n\t\tupdate xTransactionHeader set Destination_ID = @LocID\twhere id=@ID\n\t\tupdate xtransactiondetail SET Tocloc_id = @LocID WHERE transactionheader_ID = @id\n\t\tupdate xLandfreight set xlandfreight.To_Location_ID = @LocID where xLandfreight.TransactionHeader_ID =@ID\n\t\texec sp_api_modal_clear;\n\tend\n*/",
            "action_id": 201,
            "action_name": "Wijzig Loslokatie",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @SID INT,@text nvarchar(255)\r\nselect @SID=supplier_id from p_PriceEntryRow PER where PER.ID=@ID\r\nEXEC sp_api_modal_alert N'Leverancier wordt via Timer ge-wiped'\r\nexec @main_db.dbo.PER_WIPE @SID\r\nSET @text=N'Supplier_id '+ dbo.nv(@SID) + ' wiped!'\r\nEXEC sp_api_toast @text\r\nEXEC sp_api_modal_select_all_clear\r\n--EXEC sp_api_modal_text N'ok'\r\nEXEC sp_api_modal_reload\r\n-- Ctrl+S en F5",
            "action_id": 202,
            "action_name": "Wipe Supplier",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @LOC int, @name nvarchar(200)\nset @loc=(select top 1 id  from @main_db.dbo.PossibleLocationsForXLFCTR(@ID))\nselect @name=concat(locationcode,' -> ',locationname) from xlocation where id=@loc\nexec sp_api_toast @name\nupdate xlfctr set ltrfromloc=@loc where id=@ID\n",
            "action_id": 203,
            "action_name": "WL",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @ThisID int=@ID\r\ndeclare @Context int, @Code nvarchar(50)\r\nselect @Context=contextid, @Code=code from xValRate where id=@ThisID\r\nupdate xValRate set enddate =null where id=@ThisID\r\n",
            "action_id": 207,
            "action_name": "zet open",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast @Parent_Card_Name\r\n\r\nIF @Parent_Card_Name=N'inkoop'\r\nbegin\r\n\tIF not exists(SELECT * FROM xLotbase WHERE xCTH=@Parent_ID AND xLAM=@ID)\r\n\t\tinsert into xLotbase(xCTH,xLAM) values (@Parent_ID,@ID)\r\n\tELSE\r\n\t\tdelete FROM xlotbase WHERE xCTH=@Parent_ID AND xLAM=@ID\r\nEND\r\n\r\nIF @Parent_Card_Name=N'lotbase'\r\nbegin\r\n\tIF not exists(SELECT * FROM xLotbase WHERE xCTH=(SELECT xCTH FROM xLotbase WHERE ID=@Parent_ID) AND xLAM=@ID)\r\n\t\tinsert into xLotbase(xCTH,xLAM) values ((SELECT xCTH FROM xLotbase WHERE ID=@Parent_ID),@ID)\r\n\tELSE\r\n\t\t--veiligheid er omheen: Als men vanaf een lotbase_ID het eigen id probeert te verwijderen, dan dat tegenhouden \r\n\t\tIF @ID <> (SELECT xLAM FROM xLotbase WHERE ID=@Parent_ID)\r\n\t\t\tdelete FROM xlotbase WHERE xCTH=(SELECT xCTH FROM xLotbase WHERE ID=@Parent_ID) AND xLAM=@ID\r\n\t\tELSE\r\n\t\t\tEXEC sp_api_toast N'U kunt dit artikel alleen verwijderen vanaf LOTBASE'\r\nEND\r\n\r\n\r\n",
            "action_id": 208,
            "action_name": "(de)Select",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.cthFase @ID, N'closedSaleReadyForInvoice'",
            "action_id": 211,
            "action_name": "_dnu? klaar voor facturatie",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @filename nvarchar(1024) = dbo.strdate(NULL)+'-xCompany.csv'\nSELECT * INTO #xCompany FROM xCompany\nEXEC sp_api_modal_csv @tmptable=N'#xCompany',@orderby=N'ORDER BY CompanyName', @filename=@filename\n\n--select TOP 10000 * into #cities FROM xCity --WHERE country_id = 151\n--exec sp_api_modal_csv @tmptable=N'#cities', @filename=N'yoyo cities.csv'\n--select * into #modaltable13 FROM xCountry\n--exec sp_api_modal_csv @tmptable=N'#modaltable13', @filename=N'yoyo country456.csv'\n",
            "action_id": 214,
            "action_name": "2csv",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.SP_CURS_SetStockPER",
            "action_id": 228,
            "action_name": "Eigen voorraad naar PER",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.SP_End_Sum_CTH @ID",
            "action_id": 229,
            "action_name": "EndSum",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.SP_End_Sum_CTH @ID",
            "action_id": 230,
            "action_name": "EndSum",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.sp_end_sum_cth @ID",
            "action_id": 231,
            "action_name": "EndSumCTH",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.sp_end_sum_ctr @ID\n--exec @main_db.dbo.actielog @Cardname=@Card_name ,@message=N'Actie [EndSumCTR] gestart' --zie card: actielog",
            "action_id": 232,
            "action_name": "EndSumCTR",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.sp_end_sum_ctr @ID",
            "action_id": 233,
            "action_name": "EndSumCTR",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @EndTime nvarchar(max) = {[verkoop2].EndTime}\r\nEXEC sp_api_toast @EndTime",
            "action_id": 234,
            "action_name": "EndTime",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @finance_reference nvarchar(128)\n--BEGIN TRY\n\tEXEC @main_db.dbo.sp_iu_finance_account @id,@finance_reference OUT\n\tEXEC sp_api_toast @finance_reference\n/*END TRY BEGIN CATCH\n\t--SET @finance_reference = ERROR_NUMBER()\n\t--EXEC sp_api_toast @finance_reference\n\tIF ERROR_SEVERITY() = 17 -- redirect = 17!!!\n\t\tBEGIN\n\t\t\tDECLARE @valueout nvarchar(128)\n\t\t\t\t, @json nvarchar(max) = N'{\"type\":\"open_url_in_new_tab\",\"url\":\"'+ERROR_MESSAGE()+'\",\"windowFeatures\":\"width=500,height=500,scrollbars=on\"}'\n\t\t\tEXEC sp_api_modal_dispatch @json\n\t\t\tEXEC sp_api_modal_text N'Login to Exact Online, then try again',N'h4 mb-4'\n\t\t\tEXEC sp_api_modal_button @name='Retry',@value = 'Retry', @valueout = @valueout OUT,@class='btn-primary',@key='Enter'\n\t\tEND\nEND CATCH\n*/",
            "action_id": 235,
            "action_name": "Export naar Exact",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.ExtraVracht @ID",
            "action_id": 236,
            "action_name": "Extra Vracht Maken",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_modal @class=N'w100'\n\nDECLARE @value nvarchar(max),@country_id nvarchar(max),@city_id nvarchar(max),@menu_id nvarchar(max),@company_id nvarchar(max),@reducer nvarchar(max)\n/*EXEC sp_api_modal_text N'Menu voorbeeld, ga naar card:',N'h3'\n\nSET @reducer=N'in_main_menu = 1'\n\nEXEC sp_api_modal_select @card_name=N'menu',@value = @menu_id OUT,@focus=1,@reducer=@reducer,@placeholder=N'Zoek een card...'--,@table=N'#country'\n\n--DECLARE @text = (\nIF @menu_id IS NULL RETURN\nSELECT @path = CONCAT('/',name) FROM api_card WHERE id = @menu_id\nEXEC sp_api_goto @path\n\nreturn \n*/\n\nEXEC sp_api_modal_text N'Land, stad, klant reducer voorbeeld:',N'h3'\n\nEXEC sp_api_modal_select @card_name=N'country',@value = @country_id OUT,@focus=1,@placeholder=N'Kies een land'--,@table=N'#country'\n\nSET @reducer=N'country_id = ' + @country_id\nEXEC sp_api_modal_select @card_name=N'city',@value = @city_id OUT,@reducer=@reducer,@focus=1,@placeholder=N'Kies een stad'--,@table=N'#country'\n\nSET @reducer=N'city_id = ' + @city_id\nEXEC sp_api_modal_select @card_name=N'klant',@value = @company_id OUT,@reducer=@reducer,@focus=1,@placeholder=N'Kies een klant'--,@table=N'#country'\n\n\nSET @country_id = CONCAT(N'Het land id is: ' , @country_id)\nSET @city_id = CONCAT(N'Het stad id is: ' , @city_id)\nSET @company_id = CONCAT(N'Het klant id is: ' , @company_id)\nEXEC sp_api_modal_text @country_id\nEXEC sp_api_modal_text @city_id\nEXEC sp_api_modal_text @company_id\n--DECLARE @json nvarchar(max) = (SELECT * FROM #country FOR JSON AUTO,INCLUDE_NULL_VALUES)\n--EXEC sp_api_toast @json\nRETURN\n\n\n\nEXEC sp_api_modal_text N'File upload...'\nEXEC sp_api_modal_file_input @name =N'File'\t,@value =@value OUT\nIF @value IS NOT NULL\n\tEXEC sp_api_modal_text @value\n",
            "action_id": 237,
            "action_name": "File Upload",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @value nvarchar(128)\nEXEC sp_api_modal_text N'File upload...'\nEXEC sp_api_modal_file_input @name =N'File'\t,@value =@value OUT\nIF @value IS NOT NULL\n\tEXEC sp_api_modal_text @value",
            "action_id": 238,
            "action_name": "file_upload_2",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXECUTE @main_db.dbo.FlashxStock @ID ",
            "action_id": 240,
            "action_name": "Flash",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @RETURNORDER INT\nEXEC @RETURNORDER=@main_db.dbo.SP_Create_CrateReturnOrder @ID\nIF @RETURNORDER is not null \n\tBEGIN\n\t\t--EXEC sp_api_toast @RETURNORDER\n\t\tDECLARE @R nvarchar(200),@P nvarchar(200)\n\t\tSET @P=concat(N'/klant/',{[klant].id},N'/verkoop?id=',@RETURNORDER)\n\t\tEXEC sp_api_goto @P\tEND\n",
            "action_id": 242,
            "action_name": "Fustretour order (negatief boeken)",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_card_import_csv @card_name",
            "action_id": 244,
            "action_name": "Geert Test Import",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC @main_db.dbo.sp_create_invoice_rows @THDT = 1",
            "action_id": 245,
            "action_name": "Generate incoming",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @THDT INT = IIF({[invoice].id} IS NULL,1,2) -- if no invoice.id then incoming_invoice\r\nEXEC @main_db.dbo.sp_create_invoice_rows @THDT",
            "action_id": 247,
            "action_name": "Genereer facturen (verkoop)",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @R nvarchar(50),@P nvarchar(50)\r\nSET @P=concat(N'/inkoop/',{[inkoop].id},N'/lotbase')\r\nEXEC sp_api_goto @P\r\n--EXEC sp_api_toast @P",
            "action_id": 248,
            "action_name": "GoToLotbase",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast N'Hallo'",
            "action_id": 250,
            "action_name": "Hallo",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@date2 nvarchar(128),@button nvarchar(128)\r\n\r\nEXEC sp_api_modal_text 'Van:'\r\nEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-24',@focus=1,@select=1  -- zoek veld\r\nEXEC sp_api_modal_text 'Tot en met:'\r\nEXEC sp_api_modal_date @name='Date2',@value = @date2 OUT,@class='w-24' -- zoek veld\r\n--EXEC sp_api_modal_input @name='ProdCode',@value = @ProdCode OUT,@class='w-24' -- zoek veld\r\n\r\nSET @button = 'Opensale'\r\nEXEC sp_api_modal_button @name='button',@value = 'Opensale',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\r\n\r\nIF @button =  'Opensale'\r\nBEGIN\r\nSELECT Status, InsUser, TransactionDate\r\nINTO #Opensale\r\nFROM        xtransactionheader\r\nWHERE\t\t(TDT = 2) AND (TransactionDate BETWEEN @date AND @date2) AND Status = 'Opensale'\r\nEXEC sp_api_modal_table @tmptable=N'#Opensale', @orderby=N'ORDER BY TransactionDate ASC'\r\nEND \r\n",
            "action_id": 253,
            "action_name": "henk_test_instant",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC @main_db.dbo.PER_HI_TO_LO ",
            "action_id": 254,
            "action_name": "High to Low",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC @main_db.dbo.SP_Create_CrateReturnOrderAsPurchase @ID",
            "action_id": 256,
            "action_name": "Inkoop Fust (Retour)",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @aantal nvarchar(128),@aantalCol nvarchar(128),@new_id INT,@text nvarchar(128), @size nvarchar(128)\r\nDECLARE @button nvarchar(128)\r\n \r\nIF (SELECT size FROM xlotartsize WHERE id=@id) is null OR (SELECT cp120 FROM xlotartsize WHERE id=@id) is null\r\n\tBEGIN\r\n\t\t--EXEC sp_api_toast N'MAAT END C.P.P. IS VERPLICHT BIJ xLOTARTSIZE',N'bg-danger text-white p-4 center'\r\n\t\tEXEC sp_api_modal_alert N'Voordat u Lotpallets kunt ingeven, moeten de velden MAAT en C.P.P. ingevuld zijn bij xLotArtSize'\r\n\t\t--EXEC sp_api_modal_alert N'MAAT END C.P.P. IS VERPLICHT BIJ xLOTARTSIZE2222'\r\n\t\t--EXEC sp_api_modal_alert N'MAAT END C.P.P. IS VERPLICHT BIJ xLOTARTSIZE223333322'\r\n\r\n\t\tDECLARE @search nvarchar(2000) = N'?focus=10240'\r\n\t\tSET @path = @path + '/' + @id\r\n\t\tEXEC sp_api_goto @path,@search\r\n\t\treturn\r\n\tend\r\n\r\nEXEC sp_api_modal_text N'Aantal Pallets'\r\nEXEC sp_api_modal_input @name='adv. pallets',@value = @aantal OUT,@focus=1\r\nSET @Aantal = isnull(@Aantal,0)--201007 zet het pallet-aantal OP 0 als er wel collis zijn\r\n\r\nEXEC sp_api_modal_text N'Aantal Colli'\r\nEXEC sp_api_modal_input @name='adv. Colli',@value = @aantalCol OUT\r\n\r\n\r\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\r\nIF @button IS NOT NULL AND (TRY_CAST(@aantal as INT) IS NOT NULL OR TRY_CAST(@aantal as INT) IS NOT NULL)\r\nBEGIN\r\n\tDECLARE @LotBase_ID INT = {[lotbase].id}\r\n\tEXEC sp_api_toast @id\r\n\tEXEC sp_api_toast @aantal\r\n\tEXEC sp_api_toast @LotBase_ID\r\n\r\n\tEXEC @main_db.dbo.FillxLotpalletFromLAS @xLotArtSize_ID = @id,@Pallets = @aantal,@Colli = @aantalCol, @LotBase_ID = @LotBase_ID, @new_id = @new_id OUT\r\nEND\r\n\r\nIF @button IS NOT NULL \r\n\tBEGIN\r\n\t\tIF @Aantal >0 --202007 alleen als er pallets zijn ingevuld direct door naar lotpallets, niet bij losse colli..\r\n\t\t\tbegin\r\n\t\t\t\tSET @path = REPLACE(@path,'/lotartsize','/lotpallets')\r\n\t\t\t\tSET @text = N'?ord=&id=' + dbo.nv(@new_id )\r\n\t\t\t\tEXEC sp_api_modal_pathname @pathname = @path,@search = @text\r\n\t\t\t\t--EXEC sp_api_goto @path\r\n\t\t\tEND\r\n\r\n\t\tEXEC sp_api_modal_clear\r\n\tEND\r\n\r\n\r\n\r\n\r\n",
            "action_id": 257,
            "action_name": "Insert Advice",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @company_id nvarchar(32),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000), @location_id nvarchar(32), @reducer nvarchar(max), @date nvarchar(128), @opmerking nvarchar(128), @opmerkingrelation nvarchar(128)\n,@transactiondate nvarchar(128)\n,@button nvarchar(128)\n,@button1 nvarchar(128) = N'Nieuwe verkoop'\n,@button2 nvarchar(128) = N'Laatste open verkoop'\n,@button3 nvarchar(128) = N'Gereserveerde verkoop'\n,@button4 nvarchar(128) = N'Naar lokaties'\n,@button5 nvarchar(128) = N'Eigen lokaties'\n,@button6 nvarchar(128) = N'Werk lokaties'\n,@buttonescape nvarchar(128) = N'Ga terug'\n,@buttongoahead nvarchar(128) = N'Ga door'\nset @date = dbo.workDate()\nSET @transactiondate = dbo.abcdate()\n\nIF dbo.workDate() <> dbo.abcdate() AND @button IS NULL\n\tBEGIN\n\tEXEC sp_api_modal_text 'LET OP! DE WERKDATUM STAAT NIET OP VANDAAG.','text-danger font-weight-bold'\n\tEXEC sp_api_modal_button @name='@button',@value=@buttongoahead,@valueout = @button OUT,@key='Pagedown',@class='bg-danger text-light'\n\tEXEC sp_api_modal_button @name='@button',@value=@buttonescape,@valueout = @button OUT,@key='ESCAPE',@class='bg-danger text-light'\n\t\tIF @button = @buttonescape\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_clear\n\t\tEND\n\tEND\n\t\nIF @button = @buttongoahead OR dbo.workdate() = dbo.abcdate()\n\tBEGIN\n\tEXEC sp_api_modal_clear\n\tEXEC sp_api_modal_text 'Kies een klant:','text-primary'\n\t--SET @reducer = CONCAT('company_id = ',@company_id)\n\tSET @reducer = 'isDisabled = 0'\n\tEXEC sp_api_modal_select @card_name = N'klant',@value = @company_id OUT,@reducer = @reducer,@focus = 1\n\tEND\n\t\nIF @company_id > 0 \n\nBEGIN\n\t--DECLARE @only_new_is_possible BIT = 0\n\tDECLARE @reducer_location nvarchar(max) = N'Company_ID = ' + @company_id + ' OR id IN (SELECT Location_ID FROM xCompanyxLocation WHERE Company_ID =' + @company_id + ')'\n--\tDECLARE @reducer_location nvarchar(max) = N'id IN (SELECT Location_ID FROM xCompanyxLocation WHERE Company_ID =' + @company_id + ')'\n\tIF (SELECT LOCATIONS = count(Location_ID) FROM xCompanyxLocation WHERE Company_ID = @company_id) > 1\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_text 'Vertrek Datum:','text-primary'\n\t\t\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3',@focus=1\n\t\t\tEXEC sp_api_modal_input @name='Logistic',@value = @opmerking OUT,@placeholder = N'Opmerking voor loods'\n\t\t\tEXEC sp_api_modal_input @name='Relation',@value = @opmerkingrelation OUT,@placeholder = N'Referentie voor klant'\n\t\t\tEXEC sp_api_modal_text 'Kies een sublocatie van klant:','text-primary'\n\t\t\tEXEC sp_api_modal_select @card_name = N'xlocation',@value = @location_id OUT,@reducer = @reducer_location\n\t\t\t/*\n\t\t\t\tIF @location_id > 0\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3',@focus=1\n\t\t\t\t\tEND\n\t\t\t*/\n\t\tEND\n\tIF (SELECT LOCATIONS = count(Location_ID) FROM xCompanyxLocation WHERE Company_ID = @company_id) = 1 AND (SELECT LOCATIONS = count(id) FROM xLocation WHERE Company_ID = @company_id) = 1\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_text 'Vertrek Datum:','text-primary'\n\t\t\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3',@focus=1\n\t\t\tEXEC sp_api_modal_input @name='Logistic',@value = @opmerking OUT,@placeholder = N'Opmerking voor loods'\n\t\t\tEXEC sp_api_modal_input @name='Relation',@value = @opmerkingrelation OUT,@placeholder = N'Referentie voor klant'\n\t\tEND\n\t/*\n\tSELECT id = xLocation.id, name=LocationCode\n\t\tINTO #locations\n\t\tFROM xLocation WHERE Company_ID = @company_id OR id IN (SELECT Location_ID FROM xCompanyxLocation WHERE Company_ID = @company_id)\n\tEXEC sp_api_modal_select_table @tmptable = N'#locations',@value = @location_id OUT,@focus=1,@class='mt-3'\n\t*/\n\n\t--IF @location_id > 0\n\n\tEXEC sp_api_modal_text 'Kies een optie:','text-primary font-weight-bold display-4 text-center'\n\tEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Enter'\n\t\n\tIF EXISTS (SELECT * FROM xTransactionHeader WHERE status=N'openSale' AND CounterParty_ID = @company_id AND Transactiondate <= @date)\n\t\tBEGIN\n\t\tEXEC sp_api_modal_button @name='button',@value=@button2,@valueout = @button OUT,@key='F2'\n\t\tEND\n\t\t\n\tEXEC sp_api_modal_button @name='button',@value=@button4,@valueout = @button OUT,@key='F1'\n\tIF @button = @button4\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_clear\n\t\t\tEXEC sp_api_modal_button @name='button',@value=@button5,@valueout = @button OUT,@key='1'\n\t\t\tEXEC sp_api_modal_button @name='button',@value=@button6,@valueout = @button OUT,@key='2'\n\t\tEND\n\t\t\tIF @button = @button5\n\t\t\t\tBEGIN\n\t\t\t\t\tDECLARE @GotoOwnLocatie nvarchar(2000)\n\t\t\t\t\tSET @GotoOwnLocatie = N'/adres/'+@company_id+'/xlocation'\n\t\t\t\t\tEXEC sp_api_goto @GotoOwnLocatie,@referer_path=N'/verkoop'\n\t\t\t\tEND\n\t\t\tIF @button = @button6\n\t\t\t\tBEGIN\n\t\t\t\t\tDECLARE @GotoWorkLocatie nvarchar(2000)\n\t\t\t\t\tSET @GotoWorkLocatie = N'/adres/'+@company_id+'/company_locations'\n\t\t\t\t\tEXEC sp_api_goto @GotoWorkLocatie,@referer_path=N'/verkoop'\n\t\t\t\tEND\n\t\t\n\t\t/*\n\tIF EXISTS (SELECT * FROM xTransactionHeader WHERE status=N'openSale' AND CounterParty_ID = @company_id AND Transactiondate > @date)\n\t\tBEGIN\n\t\tEXEC sp_api_modal_button @name='button',@value=@button3,@valueout = @button OUT,@key='F2'\n\t\t\tSELECT TOP 1\n\t\t\t\ttv_companyname\n\t\t\t\t,transactiondate\n\t\t\t\t,[GERESERVEERD*] = 'GERESERVEERD'\n\t\t\t\t,id\n\t\t\t\tINTO #LASTORDER\n\t\t\tFROM q_xtransactionheader\n\t\t\tWHERE status=N'openSale' AND CounterParty_ID = @company_id AND Transactiondate > @date ORDER BY id DESC\n\t\t\tEXEC sp_api_modal_table @tmptable=N'#LASTORDER',@orderby=N'ORDER BY 3 ASC'\n\t\tEND\n\t\t*/\n/*\t\t\nELSE\n\t\tIF (select COUNT(id) from xlocation where company_id = @company_id ) = 1 \n\t\t\tBEGIN\n\t\t\t\tSET @only_new_is_possible = 1\n\t\t\tEND\n*/ \n\tIF @button = @button1 --OR @only_new_is_possible = 1\n\t\tBEGIN\n\t\tDELETE FROM api_storage WHERE card_id = (SELECT id FROM api_card WHERE name = N'verkoop') AND child_id = 0 AND user_id = @user_id\n\t\tEXEC sp_api_modal_clear\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'CounterParty_ID',@company_id,0\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'Destination_ID',@location_id,0\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'TransactionDate',@transactiondate,0\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'advTransportDep',@date,0\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'unloadingdate',@date,0\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'loadingdate',@date,0\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'Logistic',@opmerking,0\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'Relation',@opmerkingrelation,0\n\t\t\tEXEC @new_id = sp_api_modal_save N'verkoop',0\n\t\t\tIF @new_id > 0\n\t\t\t\tBEGIN\n\t\t\t\t\t/*SET @goto = N'/verkoop/'+@new_id+'/stock_ctr2'*/\n\t\t\t\t\tSET @goto = N'/verkoop/'+@new_id+'/ctr2/0/stockloc_ctr2'\n\t\t\t\t\tEXEC sp_api_toast N'Nieuwe verkoop gestart',N'alert-primary'\n\t\t\t\t\t--SET @search = N'?id='+@new_id\n\t\t\t\t\tSET @search = N'/verkoop/'+@new_id+'/ctr2'\n\t\t\t\t\tDECLARE @update_current_search nvarchar(4000) =CONCAT(N'?id=',@new_id)\n\t\t\t\t\tEXEC sp_api_goto @goto,@referer_path=@search,@referer_search=N'',@update_current_search=@update_current_search\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tEXEC sp_api_toast N'Error nieuwe verkoop',N'alert-danger'\n\t\t\tEXEC sp_api_modal_clear\n\t\tEND\n\tIF @button = @button2\n\t\tBEGIN\n\t\t\tSET @new_id = (SELECT TOP 1 id FROM xTransactionHeader WHERE status=N'openSale' AND CounterParty_ID = @company_id AND Transactiondate <= @date ORDER BY id DESC)\n\t\t\t/*SET @goto = N'/verkoop/'+@new_id+'/stock_ctr2'*/\n\t\t\tSET @goto = N'/verkoop/'+@new_id+'/ctr2/0/stockloc_ctr2'\n\t\t\tSET @search = N'/verkoop/'+@new_id+'/ctr2'\n\t\t\tEXEC sp_api_goto @goto,@referer_path=@search,@referer_search=N''\n\t\t\t--SET @search = N'?id='+@new_id\n\t\t\t--EXEC sp_api_goto @goto,@referer_path=N'/verkoop',@referer_search=@search\n\t\tEND\n\tIF @button = @button3\n\t\tBEGIN\n\t\t\tSET @new_id = (SELECT TOP 1 id FROM xTransactionHeader WHERE status=N'openSale' AND CounterParty_ID = @company_id AND Transactiondate > @date ORDER BY id DESC)\n\t\t\t/*SET @goto = N'/verkoop/'+@new_id+'/stock_ctr2'*/\n\t\t\tSET @goto = N'/verkoop/'+@new_id+'/ctr2/0/stockloc_ctr2'\n\t\t\tSET @search = N'/verkoop/'+@new_id+'/ctr2'\n\t\t\tEXEC sp_api_goto @goto,@referer_path=@search,@referer_search=N''\n\t\t\t--SET @search = N'?id='+@new_id\n\t\t\t--EXEC sp_api_goto @goto,@referer_path=N'/verkoop',@referer_search=@search\n\t\tEND\n\tEXEC sp_api_modal_button @name='button',@value=@buttonescape,@valueout = @button OUT,@key='ESCAPE',@class='bg-danger text-light'\n\tIF @button = @buttonescape\n\tBEGIN\n\tEXEC sp_api_modal_clear\n\tRETURN;\n\tEND\nEND\n",
            "action_id": 258,
            "action_name": "Insert Order",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @company_id nvarchar(32),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000), @location_id nvarchar(32), @reducer nvarchar(max), @date nvarchar(128), @opmerking nvarchar(128), @opmerkingrelation nvarchar(128)\n,@button1 nvarchar(128) = N'Nieuwe verkoop'\n,@button2 nvarchar(128) = N'Laatste open verkoop'\n,@button3 nvarchar(128) = N'Gereserveerde verkoop'\n,@buttonescape nvarchar(128) = N'Ga terug'\n,@buttongoahead nvarchar(128) = N'Ga door'\nset @date = dbo.workDate()\n\nIF dbo.workDate() <> dbo.abcdate() AND @button IS NULL\n\tBEGIN\n\tEXEC sp_api_modal_text 'LET OP! DE WERKDATUM STAAT NIET OP VANDAAG.','text-danger font-weight-bold'\n\tEXEC sp_api_modal_button @name='@button',@value=@buttongoahead,@valueout = @button OUT,@key='+',@class='bg-danger text-light'\n\tEXEC sp_api_modal_button @name='@button',@value=@buttonescape,@valueout = @button OUT,@key='ESCAPE',@class='bg-danger text-light'\n\t\tIF @button = @buttonescape\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_clear\n\t\tEND\n\tEND\n\t\nIF @button = @buttongoahead OR dbo.workdate() = dbo.abcdate()\n\tBEGIN\n\tEXEC sp_api_modal_clear\n\tEXEC sp_api_modal_text 'Kies een klant:','text-primary'\n\tEXEC sp_api_modal_select @card_name = N'klant',@value = @company_id OUT,@focus = 1\n\tSET @reducer = CONCAT('company_id = ',@company_id)\n\tEND\n\t\nIF @company_id > 0 \n\nBEGIN\n\t--DECLARE @only_new_is_possible BIT = 0\n\tDECLARE @reducer_location nvarchar(max) = N'Company_ID = ' + @company_id + ' OR id IN (SELECT Location_ID FROM xCompanyxLocation WHERE Company_ID =' + @company_id + ')'\n--\tDECLARE @reducer_location nvarchar(max) = N'id IN (SELECT Location_ID FROM xCompanyxLocation WHERE Company_ID =' + @company_id + ')'\n\tIF (SELECT LOCATIONS = count(Location_ID) FROM xCompanyxLocation WHERE Company_ID = @company_id) > 1\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3',@focus=1\n\t\t\tEXEC sp_api_modal_input @name='Logistic',@value = @opmerking OUT\n\t\t\tEXEC sp_api_modal_input @name='Relation',@value = @opmerkingrelation OUT\n\t\t\tEXEC sp_api_modal_text 'Kies een sublocatie van klant:','text-primary'\n\t\t\tEXEC sp_api_modal_select @card_name = N'xlocation',@value = @location_id OUT,@reducer = @reducer_location\n\t\t\t/*\n\t\t\t\tIF @location_id > 0\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3',@focus=1\n\t\t\t\t\tEND\n\t\t\t*/\n\t\tEND\n\tIF (SELECT LOCATIONS = count(Location_ID) FROM xCompanyxLocation WHERE Company_ID = @company_id) = 1\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3',@focus=1\n\t\t\tEXEC sp_api_modal_input @name='Logistic',@value = @opmerking OUT\n\t\t\tEXEC sp_api_modal_input @name='Relation',@value = @opmerkingrelation OUT\n\t\tEND\n\t/*\n\tSELECT id = xLocation.id, name=LocationCode\n\t\tINTO #locations\n\t\tFROM xLocation WHERE Company_ID = @company_id OR id IN (SELECT Location_ID FROM xCompanyxLocation WHERE Company_ID = @company_id)\n\tEXEC sp_api_modal_select_table @tmptable = N'#locations',@value = @location_id OUT,@focus=1,@class='mt-3'\n\t*/\n\n\t--IF @location_id > 0\n\n\tEXEC sp_api_modal_text 'Kies een optie:','text-primary font-weight-bold display-4 text-center'\n\tEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Insert'\n\t\n\tIF EXISTS (SELECT * FROM xTransactionHeader WHERE status=N'openSale' AND CounterParty_ID = @company_id AND Transactiondate <= @date)\n\t\tBEGIN\n\t\tEXEC sp_api_modal_button @name='button',@value=@button2,@valueout = @button OUT,@key='F1'\n\t\tEND\n\t\t\n\tIF EXISTS (SELECT * FROM xTransactionHeader WHERE status=N'openSale' AND CounterParty_ID = @company_id AND Transactiondate > @date)\n\t\tBEGIN\n\t\tEXEC sp_api_modal_button @name='button',@value=@button3,@valueout = @button OUT,@key='F2'\n\t\t\tSELECT TOP 1\n\t\t\t\ttv_companyname\n\t\t\t\t,transactiondate\n\t\t\t\t,[GERESERVEERD*] = 'GERESERVEERD'\n\t\t\t\t,id\n\t\t\t\tINTO #LASTORDER\n\t\t\tFROM q_xtransactionheader\n\t\t\tWHERE status=N'openSale' AND CounterParty_ID = @company_id AND Transactiondate > @date ORDER BY id DESC\n\t\t\tEXEC sp_api_modal_table @tmptable=N'#LASTORDER',@orderby=N'ORDER BY 3 ASC'\n\t\tEND\n/*\t\t\nELSE\n\t\tIF (select COUNT(id) from xlocation where company_id = @company_id ) = 1 \n\t\t\tBEGIN\n\t\t\t\tSET @only_new_is_possible = 1\n\t\t\tEND\n*/ \n\tIF @button = @button1 --OR @only_new_is_possible = 1\n\t\tBEGIN\n\t\tDELETE FROM api_storage WHERE card_id = (SELECT id FROM api_card WHERE name = N'verkoop') AND child_id = 0 AND user_id = @user_id\n\t\tEXEC sp_api_modal_clear\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'CounterParty_ID',@company_id,0\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'Destination_ID',@location_id,0\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'TransactionDate',@date,0\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'advTransportDep',@date,0\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'unloadingdate',@date,0\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'loadingdate',@date,0\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'Logistic',@opmerking,0\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'Relation',@opmerkingrelation,0\n\t\t\tEXEC @new_id = sp_api_modal_save N'verkoop',0\n\t\t\tIF @new_id > 0\n\t\t\t\tBEGIN\n\t\t\t\t\tSET @goto = N'/verkoop/'+@new_id+'/stock_ctr2'\n\t\t\t\t\tEXEC sp_api_toast N'Nieuwe verkoop gestart',N'alert-primary'\n\t\t\t\t\tSET @search = N'?id='+@new_id\n\t\t\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/verkoop',@referer_search=@search\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tEXEC sp_api_toast N'Error nieuwe verkoop',N'alert-danger'\n\t\t\tEXEC sp_api_modal_clear\n\t\tEND\n\tIF @button = @button2\n\t\tBEGIN\n\t\t\tSET @new_id = (SELECT TOP 1 id FROM xTransactionHeader WHERE status=N'openSale' AND CounterParty_ID = @company_id AND Transactiondate <= @date ORDER BY id DESC)\n\t\t\tSET @goto = N'/verkoop/'+@new_id+'/stock_ctr2'\n\t\t\tSET @search = N'?id='+@new_id\n\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/verkoop',@referer_search=@search\n\t\tEND\n\tIF @button = @button3\n\t\tBEGIN\n\t\t\tSET @new_id = (SELECT TOP 1 id FROM xTransactionHeader WHERE status=N'openSale' AND CounterParty_ID = @company_id AND Transactiondate > @date ORDER BY id DESC)\n\t\t\tSET @goto = N'/verkoop/'+@new_id+'/stock_ctr2'\n\t\t\tSET @search = N'?id='+@new_id\n\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/verkoop',@referer_search=@search\n\t\tEND\n\tEXEC sp_api_modal_button @name='button',@value=@buttonescape,@valueout = @button OUT,@key='ESCAPE',@class='bg-danger text-light'\n\tIF @button = @buttonescape\n\tBEGIN\n\tEXEC sp_api_modal_clear\n\tRETURN;\n\tEND\nEND\n",
            "action_id": 259,
            "action_name": "Insert Order",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@date2 nvarchar(128),@button nvarchar(128),@TransComp nvarchar(128)\r\n--set @date = dbo.workDate()\r\nEXEC sp_api_modal_text 'Zoek op transport bedrijf'\r\nEXEC sp_api_modal_input @name='Transporteur',@value = @TransComp OUT,@focus=1,@select=1 -- zoek veld\r\nEXEC sp_api_modal_text 'Van:'\r\nEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-24' -- zoek veld\r\nEXEC sp_api_modal_text 'Tot en met:'\r\nEXEC sp_api_modal_date @name='Date2',@value = @date2 OUT,@class='w-24' -- zoek veld\r\n--SET @date2 = CONCAT(@date2,' 23:59:59.999')\r\nSET @button = 'DepartingPalletsLijst'\r\nEXEC sp_api_modal_button @name='button',@value = 'DepartingPalletsLijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\r\nEXEC sp_api_modal_button @name='button',@value = 'ArrivedPalletsLijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F2'\r\n\r\nIF @button =  'DepartingPalletsLijst'\r\nBEGIN\r\nSELECT *\r\nINTO #DepartingPalletsLijst\r\nFROM          RV_TransportPalletLijst\r\nWHERE\t\t(TransportStatus = 'Departing') AND (TransportDate BETWEEN @date AND @date2) AND (@TransComp is NULL OR [TransComp*] LIKE @TransComp+'%')\r\nEXEC sp_api_modal_table @tmptable=N'#DepartingPalletsLijst',@orderby=N'ORDER BY [TransComp*] ASC'\r\nEND \r\n\r\nIF @button =  'ArrivedPalletsLijst'\r\nBEGIN\r\nSELECT *\r\nINTO #ArrivedPalletsLijst\r\nFROM          RV_TransportPalletLijst\r\nWHERE\t\t(TransportStatus = 'Arrived') AND (TransportDate BETWEEN @date AND @date2) AND (@TransComp is NULL OR [TransComp*] LIKE @TransComp+'%')\r\nEXEC sp_api_modal_table @tmptable=N'#ArrivedPalletsLijst',@orderby=N'ORDER BY [TransComp*] ASC'\r\nEND \r\n",
            "action_id": 260,
            "action_name": "Pallet Lijst",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--EXEC sp_api_toast @parent_parent_id\n--exec sp_api_toast @User\n\t\nDECLARE @CTHID INT = {[verkoop].id} --200818 curly\nIF @CTHID IS NULL begin\n\t\tEXEC sp_api_toast 'Kan geen [verkoop] vinden'\n\t\tRETURN;\n\t\tend\n--ELSE EXEC sp_api_toast @CTHID\n\nDECLARE @mes nvarchar(200), @FustSaldo int, @CoreType nvarchar(10),@FustID int, @xDesc nvarchar(200), @StockID int, @Lotnumber nvarchar(200), @UnMapped nvarchar(20)\n--stock_id er bij, want nu wordt vanuit partij-ctr verkocht...\nSELECT @xDesc=p.[Detail]\n\t\t,@mes= concat('Verkoop uit Partij ',p.Lotnumber,':  ' , p.[Detail]) \n\t\t,@Coretype= p.coretype\n\t\t,@FustID=p.Fust_ID\n\t\t,@StockID=p.Stock_ID\n\t\t,@Lotnumber=p.Lotnumber \n\t\t,@UnMapped=p.UnMapped\n\tfrom Q_xTransactiondetail p where p.id=@ID --@main_db.dbo.\n--EXEC sp_api_modal_text @mes,'h2 text-primary'\n\nIF {[verkoop].status} not in ('openSale') AND @Coretype='FOOD' BEGIN --200924 fust mag wel worden bij of afgeboekt\n\tEXEC sp_api_modal_alert 'U kunt alleen (retour-)FUST toevoegen, want de order is definitief.'\n\tEXEC sp_api_modal_clear\t\t\n\tRETURN;\t\n\tend\n\n-- 200629 Uitbreiding inkoop vanuit diverse contexten: Zoek CTH ; bijv als we afkomstig zijn van een regel, dan is CTH te vinden in de regel\n--if @parent_card_name ='verkoop'\tset @CTHID=@parent_id\n--if @parent_card_name = 'ctr2' set @CTHID=(select TransactionHeader_ID from xtransactiondetail where xtransactiondetail.id=@parent_id)\n\n\n------\nIF @coretype in('CRATE','PALLET')\n\tBEGIN\n\t\tSELECT @Fustsaldo=Fustsaldo from @main_db.dbo.FustSaldo_FC(@FustID,{[verkoop].Counterparty_ID})\n\t\tEXEC sp_api_toast @Fustsaldo\n\t\t-- breid DECLARE message uit met het fust-saldo\n\t\tIF @FustSaldo is not NULL\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') actueel saldo bij deze klant: ',@fustsaldo)\n\t\tELSE\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') => let op: deze klant heeft dit fust nooit eerder gehad!')\n\tEND\n\n\n\n\n\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\nDECLARE @prijs nvarchar(20),@aantal nvarchar(20),@opmerking nvarchar(50) --='100'\nDECLARE @CounterpartyID int\nDECLARE @FlowModel int\nDECLARE @THDT INT\nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=FlowModel_ID,@THDT=TDT From xTransactionHeader CTH where CTH.ID=@CTHID\n--200630 was@parent_id\n\n--200708 => ??? WAAROM GAAT DIT NIET ??? select @Prijs= @main_db.dbo.StockPrice(@ID,@CTHID,NULL,NULL,NULL,NULL,NULL,NULL,NULL)\n\nif isnull(@Prijs,0)=0\n\tbegin\n\t\tSELECT top 1 @prijs = ctr.ctrPRICE FROM xctrtotals ctr WHERE ctr.ctrprice > 0 AND\n\t\tctr.Counterparty_ID=@CounterpartyID AND ctr.ctrStock_ID =@ID ORDER BY ctr.id DESC -- laatste prijs!\n\tend\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\nEXEC sp_api_modal_text 'Aantal'\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1\nIF @coretype in('FOOD')\n\tBEGIN\n\t\tEXEC sp_api_modal_text 'Prijs'\n\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT\n\tEND\n\t\tEXEC sp_api_modal_text 'Opm. loods'\n\t\tEXEC sp_api_modal_input @name='opmerking',@value = @opmerking OUT\nDECLARE @button nvarchar(128)\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\n\nIF (SELECT PATINDEX('%[^0-9.,-]%', @prijs)) > 0 OR (SELECT PATINDEX('%[^0-9-]%', @aantal)) > 0\n\tBEGIN\n\tEXEC sp_api_modal_clear\t\n\t\t/*\n\t\tIF @id = ANY (select stock_id from xtransactiondetail where TransactionHeader_ID = @CTHID AND stock_id = @id) \n\t\tBEGIN\n\t\t\tSELECT @QTYCTR = sum(Amount) from xTransactiondetail where @id = stock_id AND TransactionHeader_ID = @CTHID\n\t\t\tEXEC sp_api_modal_text 'Let op! Dit artikel bestaat al in de bestelling!','text-danger font-weight-bold h2 text-center'\n\t\t\tEXEC sp_api_modal_text 'Momenteel in bestelling:','text-danger font-weight-bold h2 text-center'\n\t\t\tEXEC sp_api_modal_text @QTYCTR,@class = 'text-danger font-weight-bold display-4 text-center'\n\t\tEND\n\t\t*/\n\t\tEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\n\t\t\n\t\tIF (SELECT PATINDEX('%[^0-9-]%', @aantal)) > 0\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text 'Aantal niet goed ingevuld','text-danger'\n\t\t\t\tEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@class = 'is-invalid',@focus=1\n\t\t\tEND\n\t\tELSE\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text 'Aantal'\n\t\t\t\tEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT\n\t\t\tEND\n\t\tIF (SELECT PATINDEX('%[^0-9.,-]%', @prijs)) > 0\n\t\t\tBEGIN\n\t\t\tIF @coretype in('FOOD','SERVICE')\n\t\t\t\tBEGIN\n\t\t\t\t\tEXEC sp_api_modal_text 'Prijs niet goed ingevuld','text-danger'\n\t\t\t\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT,@class = 'is-invalid',@focus=1\n\t\t\t\tEND\n\t\t\tEND\n\t\tELSE\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text 'Prijs'\n\t\t\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT\n\t\t\tEND\n\t\tEXEC sp_api_modal_text 'Opm. loods'\n\t\tEXEC sp_api_modal_input @name='opmerking',@value = @opmerking OUT\n\t\tEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\n\t\n\t\tIF (select count(id) from view_coco_prijshistory where {[Stock_ctr2].ID} = Stock_ID AND xCompanyID = {[verkoop].counterparty_id} AND TDT = 2) > 0\n\t\tBEGIN\n\t\tselect\n\t\t\tAmount\n\t\t\t,Price\n\t\t\t,insUser\n\t\t\t,[order_NR] = id\n\t\t\t,TransactionDate\n\t\t\tINTO #prijshistory2\n\t\t\tFROM view_coco_prijshistory\n\t\twhere {[Stock_ctr2].ID} = Stock_ID AND xCompanyID = {[verkoop].counterparty_id} AND TDT = 2\n\t\tEXEC sp_api_modal_table @tmptable=N'#prijshistory2',@orderby=N'ORDER BY TransactionDate DESC OFFSET 0 ROWS FETCH NEXT 8 ROWS ONLY'\n\t\tEND\n\t\tRETURN\n\tEND\n\nDECLARE @FromLoc nvarchar(200) = {[stockloc_ctr2].xLocation_ID} \n\nIF @button IS NOT NULL\n\tBEGIN\n\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') -- 200924 zorg dat je ook komma mag gebruiken als decimaal scheidingsteken\n\t\tIF \t\t--TRY_CAST(@prijs as decimal) > 0 AND \n\t\t\t\tTRY_CAST(@aantal as int) > 0 AND TRY_CAST(@aantal as int) <= TRY_CAST(@UnMapped as int) -- 210506 CG Mag geen groter aantal dan beschikbaar toewijzen vanaf een partij \n\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\n\t\t\tBEGIN\n\t\t\t\tDECLARE @mapfustpartijregel int, @newVerkoopCTR_ID int\n\t/* NORMAAL */\n\t\t\t\tIF @coretype in('FOOD') --agf handel geselecteerd\n\t\t\t\t\tBEGIN \n\t\t\t\t\t\texec @newVerkoopCTR_ID=@main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@StockID,@Amount=@Aantal,@Price=@Prijs, @User=@User,@Logistic=@Opmerking,@source_ID=@FromLoc\n\t\t\t\t\t\t--map gelijk tegen deze partijregel\n\t\t\t\t\t\tIF @newVerkoopCTR_ID is not null\tEXECUTE @main_db.dbo.map @newVerkoopCTR_ID,@ID -- = IVmap\n\t\t\t\t\t\t--\tEN anders zo:\n\t\t\t\t\t\t--\tinsert into xivlink(linkAantal,itd,vtd) values (@Aantal,@newVerkoopCTR_ID,@ID)\n\t\t\t\t\t\tselect @mes = concat('PARTIJVERKOOP: ',@Aantal, ' colli ',@xDesc,' toegevoegd aan de order')\n\t\t\t\t\t\texec sp_api_toast @mes\n\t\t\t\t\tEND\n\t/* FUST!! */\n\t\t\t\tIF @coretype in('CRATE','PALLET') --leeg fust geselecteerd\n\t\t\t\t\tBEGIN \n\t\t\t\t\t\tSET @mapfustpartijregel=(select @main_db.dbo.FustIV_VTD(@FustID))\n\t\t\t\t\t\tIF @mapfustpartijregel is not null \n\t\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\t\texec @newVerkoopCTR_ID=@main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@StockID,@Amount=@Aantal,@Price=@Prijs, @User=@User,@Logistic=@Opmerking,@source_ID=@FromLoc\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t--MAP retour fust aan FUSTPARTIJ\n\t\t\t\t\t\t\t\tinsert into xivlink(linkAantal,itd,vtd) values (@Aantal,@newVerkoopCTR_ID,@mapfustpartijregel)\n\n\t\t\t\t\t\t\t\tselect @mes = concat('Er zijn ',@Aantal, ' colli FUST toegevoegd aan de order')\n\t\t\t\t\t\t\t\texec sp_api_toast @mes\n\t\t\t\t\t\t\tend\n\n\t\t\t\t\tEND\n\n\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\n\t\t\tEND\n\t\tELSE\n\n\t\t\tIF TRY_CAST(@aantal as int) > TRY_CAST(@UnMapped as int)\n\t\t\t\tBEGIN\n\t\t\t\t\tEXEC sp_api_modal_text 'Ingevulde aantal is groter dan aantal beschikbaar!','text-danger'\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\t\t\t\tEND\n\tEND \n",
            "action_id": 261,
            "action_name": "Partij verkoop",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @LastStart datetime\r\nselect @laststart=startdate from xvalrate where endDate is null and code={[xvalrate].code} and contextID={[xvalrate].contextID}\r\nif @laststart is not NULL update xvalrate set enddate=@laststart -1 where ID=@ID",
            "action_id": 262,
            "action_name": "Pas einddatum aan",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 264,
            "action_name": "PER_clone_mag_niet",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "Declare @sys_Report_Key nvarchar(200)='picklist' \ndeclare @test bit = 0 -- 0:LIVE; 1=TEST\nDECLARE @FixedPrinter_ID INT = 3\n\nIF (select count(id) from q_xtransactionheader where id in (select transactionheader_id from Q_xTransactionDetail where delayed = 1) AND id IN ({@ids})) > 0\nBEGIN\n\tEXEC sp_api_modal_text N'Een order is gereserveerd, Orders moeten eerst worden vrijgegeven!', N'h5'\nRETURN;\nEND\n\nEXEC sp_api_toast @sys_Report_Key\n\n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\n--ALS ER 1 geselecteerd is, kijk dan of er multi-bestemming gedefinieerd is..\n\nIF @IDS=@ID \n\tBEGIN \n\t\t--exec SP_API_Toast N'single id, dus evt keuze optie'\n\t\t\n\t\tDECLARE\t@ReportName nvarchar(200), @ReportSQL nvarchar(max) ,@RepDef_ID INT\n\n\t\t--210103 print naar van geest! (TO)\n\t\tSET @toCompany_ID = (select Counterparty_id from xtransactionheader where id=@ID)\n\n\t\tset @Repdef_ID = (SELECT TOP 1 id FROM xRepDef WHERE sys_report_key = @sys_Report_Key)\n\t\tif @RepDef_ID is null \n\t\t\tBEGIN\n\t\t\t\tdeclare @Yell nvarchar(100)\n\t\t\t\tset @Yell = Concat(N'Er is geen report definitie voor ',@sys_Report_Key)\n\t\t\t\texec sp_api_toast @Yell\n\t\t\t\treturn;\n\t\t\tEND\n\tEND\n\n--MULTI\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\t--dit is nu alleen voor tellers en checks:\n\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select Counterparty_id from xtransactionheader where id=@cid)\n\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = @Sys_Report_Key--'picklist' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@test = @test --hiermee schakel je tussen productie en test-modus\n\t\t\t,@FixedPrinter_ID = @FixedPrinter_ID\n\t\t--even registreren dat er wordt afgedrukt\n\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'CTH'\t,@Context_Key_ID=@cid,@Report_CODE=N'PICK'\n\n\t\t--210104 end sum voor alles bijwerken\n\t\texecute @main_db.dbo.CTH_Endsum @cid\n\n\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;\n\n",
            "action_id": 266,
            "action_name": "pickbon",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "Declare @sys_Report_Key nvarchar(200)='picklist' \ndeclare @test bit =0 -- 0:LIVE; 1=TEST\ndeclare @ForcedAction_ID INT =31 -- (een ID of NULL) => GAAT NU FIXED NAAR xRepAction 31 print op loods\nDECLARE @FixedPrinter_ID INT = 4\nIF (select count(id) from q_xtransactionheader where id in (select transactionheader_id from Q_xTransactionDetail where delayed = 1) AND id IN ({@ids})) > 0\nBEGIN\n\tEXEC sp_api_modal_text N'Een order is gereserveerd, Orders moeten eerst worden vrijgegeven!', N'h5'\nRETURN\nEND\n\t\nEXEC sp_api_toast @sys_Report_Key\n\n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\ndeclare @FixedRepAction_ID int \t\n\n--ALS ER 1 geselecteerd is, kijk dan of er multi-bestemming gedefinieerd is..\n\nif @IDS=@ID \n\tbegin \n\t\t--exec SP_API_Toast N'single id, dus evt keuze optie'\n\t\t\n\t\tDECLARE\t@ReportName nvarchar(200), @ReportSQL nvarchar(max) ,@RepDef_ID INT\n\n\t\t--210103 print naar van geest! (TO)\n\t\tSET @toCompany_ID = (select Counterparty_id from xtransactionheader where id=@ID)\n\n\t\tset @Repdef_ID = (SELECT TOP 1 id FROM xRepDef WHERE sys_report_key = @sys_Report_Key)\n\t\tif @RepDef_ID is null \n\t\t\tbegin\n\t\t\t\tdeclare @Yell nvarchar(100)\n\t\t\t\tset @Yell = Concat(N'Er is geen report definitie voor ',@sys_Report_Key)\n\t\t\t\texec sp_api_toast @Yell\n\t\t\t\treturn;\n\t\t\tend\n\t\t\n\t\t-- als er meer dan 1 RepAction is, dan vragen welke...\n\t\t--if (select count(id) FROM xRepAction WHERE ReportName_ID = @RepDef_ID AND ToCompany_ID = @ToCompany_ID AND fromCompany_ID = @fromCompany_ID\tand isAlternative=1) >= 1 \n\n--210104 ALS FORCED IS OPGEGEVEN, GA DAN ALTIJD DAAR HEEN!\nIF @ForcedAction_ID IS NOT NULL SET @FixedRepAction_ID=@ForcedAction_ID\n\nIF @ForcedAction_ID IS NULL\n\t\t\tbegin --meerdere opties!! dus kiezen\n\t\t\t\tEXEC sp_api_modal_text N'Standaard bestemming(en):', N'h5'\n\t\t\t\tDECLARE @FixedRepAction_ID_choosen int, @sbutton nvarchar(128)\n\t\t\t\t\t,@reducer nvarchar(max) = CONCAT('ISNULL(isAlternative,0) = 0 AND ReportName_ID = ',@RepDef_ID,' AND ToCompany_ID = '\n\t\t\t\t\t\t\t\t,@ToCompany_ID,' AND fromCompany_ID = ',@fromCompany_ID)\n\n\t\t\t\tEXEC sp_api_modal_table @card_name = 'repaction', @reducer = @reducer\n\t\t\t\tEXEC sp_api_modal_button @name='Kies',@value = 'Kies standaard', @valueout = @sbutton OUT,@class='btn-primary',@key='F1'\n\t\t\t\tSET @reducer = CONCAT('ReportName_ID = ',@RepDef_ID,' AND ToCompany_ID = ',@ToCompany_ID,' AND fromCompany_ID = ',@fromCompany_ID)\n\t\t\t\tEXEC sp_api_modal_select @card_name = 'repaction',@value = @FixedRepAction_ID_choosen OUT,@focus = 1,@reducer = @reducer\n\t\t\t\t--EXEC sp_api_modal_text @FixedRepAction_ID\n\t\t\t\tIF @FixedRepAction_ID_choosen IS NOT NULL\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tEXEC sp_api_modal_button @name='Kies',@value = 'Kies alternatief', @valueout = @sbutton OUT,@class='btn-primary',@key='F2'\n\t\t\t\t\t\tIF @sbutton = 'Kies alternatief' SET @FixedRepAction_ID = @FixedRepAction_ID_choosen\n\t\t\t\t\tEND\n\t\t\t\tIF @sbutton IS NULL RETURN\n\t\t\tend\n\tend\n\n--MULTI\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\t--dit is nu alleen voor tellers en checks:\n\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select Counterparty_id from xtransactionheader where id=@cid)\n\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = @Sys_Report_Key--'picklist' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@FixedRepAction_ID=@FixedRepAction_ID --210102 Je kan nu hard een id mee geven \n\t\t\t,@test = @test --hiermee schakel je tussen productie en test-modus\n\t\t\t,@FixedPrinter_ID = @FixedPrinter_ID\n\t\t--even registreren dat er wordt afgedrukt\n\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'CTH'\t,@Context_Key_ID=@cid,@Report_CODE=N'PICK'\n\n\t\t--210104 end sum voor alles bijwerken\n\t\texecute @main_db.dbo.CTH_Endsum @cid\n\n\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;\n\n",
            "action_id": 267,
            "action_name": "pickbon",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @PriceLo FLOAT,@PriceHi FLOAT, @save nvarchar(10),@text nvarchar(max)\r\nSELECT * INTO #ids FROM string_split(@ids,',')\r\nSELECT @PriceLo = AVG(PriceLo),@PriceHi = AVG(PriceHi) FROM p_PriceEntryRow WHERE id IN(SELECT * FROM #ids)\r\nSET @text = N'Prijs '+CAST((SELECT count(*) FROM #ids) as nvarchar)+' producten'\r\nEXEC sp_api_modal_text @text ,'h4'\r\nEXEC sp_api_modal_text 'Laag'\r\nEXEC sp_api_modal_input @name='PriceLo', @value= @PriceLo OUT,@focus=1 \r\nEXEC sp_api_modal_text 'Hoog'\r\nEXEC sp_api_modal_input @name='PriceHi', @value= @PriceHi OUT\r\nEXEC sp_api_modal_button @name='Save',@value = 'Opslaan', @valueout = @save OUT,@class='btn-danger',@key='Enter'\r\nIF @save is not null\r\n\tBEGIN\r\n\t\tUPDATE p_PriceEntryRow SET PriceLo = @PriceLo, PriceHi =@PriceHi WHERE id IN (SELECT * FROM #ids)\r\n\t\tEXEC sp_api_modal_clear\r\n\tEND\r\n",
            "action_id": 270,
            "action_name": "prijs",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 271,
            "action_name": "Prijs Bijwerken",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @SID INT, @SupplierName nvarchar(200), @TaskAllowed bit\r\nselect @SID=supplier_id from p_PriceEntryRow PER where PER.ID=@ID\r\nEXEC sp_api_toast N'SupplierID is...'\r\nEXEC sp_api_toast @SID\r\n--EXECUTE @main_db.dbo.DO_TouchPrice @SID\r\n\r\nSELECT @taskAllowed=@main_db.dbo.TaskAllowed(N'DO_TouchPrice')\r\nIF @taskAllowed=0 EXEC sp_api_toast 'TAAK IS NIET TOEGESTAAN!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!'\r\n\r\nEXECUTE @main_db.dbo.AddTask @TaskCode=N'DO_TouchPrice', @Supplier_ID=@SID\r\n                    -- AddTask @taskcode=N'DO_TouchPrice', @Supplier_ID=156648\r\nselect @SupplierName=N'TIMER TAAK: Leverancier '+companyname+' (ID='+dbo.nv(@SID)+') is nu doorgezet naar Tracy'  from xcompany where xcompany.id=@SID\r\nEXEC sp_api_toast @SupplierName",
            "action_id": 272,
            "action_name": "Prijzen2Tracy",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @toCompany_ID INT = {[invoice].toCompany_ID}\nDECLARE @fromCompany_ID INT = {[invoice].fromCompany_ID}\nEXEC sp_api_report_generate @id = @id\n\t,@sys_report_key = 'invoice_out'\n\t,@toCompany_ID = @toCompany_ID\n\t,@fromCompany_ID = @fromCompany_ID\n",
            "action_id": 273,
            "action_name": "Print factuur_voor210112",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @toCompany_ID INT = {[invoice].toCompany_ID}\nDECLARE @fromCompany_ID INT = {[invoice].fromCompany_ID}\nEXEC sp_api_report_generate @id = @id\n\t,@sys_report_key = 'invoice_out_test'\n\t,@toCompany_ID = @toCompany_ID\n\t,@fromCompany_ID = @fromCompany_ID\n",
            "action_id": 274,
            "action_name": "Print test factuur ",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--EXEC sp_api_toast @user\n--ER WORDT MET @stockID UIT GEGAAN DAT ER VANAF xSTOCK WORDT GEWERKT, MAAR VEILIGER IS DIT OM TE ZETTEN NAAR @STOCK_ID ( via {[xStock].ID} )\nDECLARE @stockID INT = {[stock_ctr1].ID}\nIF @stockID is null\n\tBEGIN\n\t\texec sp_api_toast N'Eh...? Niets te doen...'\n\tEND\n\n--EXEC sp_api_toast @parent_parent_id\nDECLARE @CTHID INT = {[inkoop].id} --200818 curly\nIF @CTHID IS NULL begin\n\t\tEXEC sp_api_toast 'IS_NULL'\n\t\tRETURN;\n\t\tend\nELSE --EXEC sp_api_toast @CTHID\n--RETURN\n\nDECLARE @GIP nvarchar(10)\nselect @GIP= av from @main_db.dbo.gip(@stockID)\n\n-- 200629 Uitbreiding inkoop vanuit diverse contexten: Zoek CTH ; bijv als we afkomstig zijn van een regel, dan is CTH te vinden in de regel\n--if @parent_card_name ='inkoop'\tset @CTHID=@parent_id\n--if @parent_card_name = 'ctr1' set @CTHID=(select TransactionHeader_ID from xtransactiondetail where xtransactiondetail.id=@parent_id)\n--if @cthid is null RAISERROR(N'Unknown Context; config by consultant needed to find CTH',13,1)\n--exec sp_api_toast @parent_card_name\n\nDECLARE @mes nvarchar(200), @currStock int\nSELECT @mes= concat('Purchasing ' , x.[Description],' (GIP:',TRY_CAST(@GIP as decimal(8,2)),')'), @currStock=stock from xstock x where x.id=@stockID --@main_db.dbo.\n--EXEC sp_api_modal_text @mes,'h2 text-primary'\n------\n\n\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\nDECLARE @prijs nvarchar(20),@aantal nvarchar(20) --='100'\nDECLARE @CounterpartyID int\nDECLARE @FlowModel int\nDECLARE @THDT int\nDECLARE @FRAFOT Nvarchar(3) -- 'FRA' OF 'FOT'\nDECLARE @SrcID int -- let op: slechts 'advies'\nDECLARE @DstID int\n\nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=cth.FlowModel_ID,@THDT=cth.TDT,@FRAFOT=cth.FRAFOT, @srcID=cth.source_ID,@DstID=cth.Destination_ID From q_xTransactionHeader CTH where CTH.ID=@CTHID\ndeclare @dayprice bit\nset @dayprice=isnull((select L from @main_db.dbo.[GetCompanySettings]('useDayprice')),0)\n--was @parent_id\n\n--BEPALEN VAN DE INKOOPPRIJS: \n--===========================\n--200630 er voor: PER check\nif @dayprice = 1 \n\tBEGIN\n\t\tselect top 1 @Prijs=per.pricehi from p_PriceEntryRow per where per.Stock_ID=@stockID and per.Supplier_ID=@CounterpartyID and per.activeCount>0\n\tEND\n\nif @prijs is null --201022\n\tbegin\n\t\t--201022\n\t\t--exec sp_api_toast @dayprice\n\t\t--exec sp_api_toast @dstID\n\t\t\t\tset @prijs=(select @main_db.dbo.stockprice(\t@stockID --48482 --stock_ID\n\t\t\t\t\t\t\t,@CTHID --3761\t--CTH_ID\n\t\t\t\t\t\t\t,@CounterpartyID --161418\t--Counterparty_ID\n\t\t\t\t\t\t\t,@FlowModel --null\t--Flowmodel_ID\n\t\t\t\t\t\t\t,@THDT --2\t\t--DaTDT\n\t\t\t\t\t\t\t,@SrcID --NULL --SupplierLocation_ID\n\t\t\t\t\t\t\t,@DstID --NULL -- 7945\t--Receiverlocation_ID\n\t\t\t\t\t\t\t,IIF(@FRAFOT='FOT',1,0)\t\t--isFOT\n\t\t\t\t\t\t\t,@dayprice --0-- use dayprice\n\t\t\t\t\t\t)\n\t\t\t\t\t)\n\tend\n\n/*\nif @prijs is null\n\tbegin\n\t\tselect @prijs = xCompanyStockID.FixedPrice from xCompanyStockID where xCompanyStockID.xstock_id = @stockID AND xCompanyStockID.xcompany_id = @CounterpartyID\n\tend\nif @prijs is null -- terug vallen naar laatste prijs..\n\tbegin\n\t\tSELECT top 1 @prijs = ctr.ctrPRICE FROM xctrtotals ctr WHERE ctr.ctrprice > 0 AND\n\t\t\tctr.Counterparty_ID=@CounterpartyID AND ctr.ctrStock_ID =@stockID ORDER BY ctr.id DESC -- laatste prijs!\n\tEND\n*/\n\nDECLARE @can_set_realprice BIT = 0,@can_set_delayed BIT = 0 \nIF dbo.hasClaims('role=admin,sub=jan@vgibv.nl,sub=rene@vgibv.nl,sub=pvg@vgibv.nl,sub=wim@vgibv.nl,sub=jeffrey@vgibv.nl,sub=anja@vgibv.nl,sub=nicky@vgibv.nl,sub=chris@vgibv.nl') > 0 SET @can_set_realprice = 1\nIF dbo.ABCDATE() < dbo.workDate() OR dbo.ABCDATE() < {[inkoop].TransactionDate} SET @can_set_delayed = 1\nDECLARE @realprice nvarchar(20),@new_id INT\n\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\nEXEC sp_api_modal_text 'Aantal'\nIF @currStock<0 \n\tBEGIN\n\t\tSET @aantal=@currStock * -1 \n\tEND\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1, @select=1\nEXEC sp_api_modal_text 'Prijs'\nEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT\nIF @can_set_realprice = 1\n\tBEGIN\n\t\tEXEC sp_api_modal_text 'Real price'\n\t\tEXEC sp_api_modal_input @name='Real price',@value = @realprice OUT\n\tEND\n\nDECLARE @button nvarchar(128)\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\n\n/*21-05-07 CG Nieuwe code toegevoegd om duidelijk aan te geven dat er een verkeerd input is ingegeven.*/\n\nIF (SELECT PATINDEX('%[^0-9.,-]%', @prijs)) > 0 OR (SELECT PATINDEX('%[^0-9-]%', @aantal)) > 0 OR (SELECT PATINDEX('%[^0-9.,-]%', @realprice)) > 0\n\tBEGIN\n\tEXEC sp_api_modal_clear\t\n\n\t\tEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\n\t\t\n\t\tIF (SELECT PATINDEX('%[^0-9-]%', @aantal)) > 0\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text 'Aantal niet goed ingevuld','text-danger'\n\t\t\t\tEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@class = 'is-invalid',@focus=1\n\t\t\tEND\n\t\tELSE\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text 'Aantal'\n\t\t\t\tEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT\n\t\t\tEND\n\t\tIF (SELECT PATINDEX('%[^0-9.,-]%', @prijs)) > 0\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text 'Prijs niet goed ingevuld','text-danger'\n\t\t\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT,@class = 'is-invalid',@focus=1\n\t\t\tEND\n\t\tELSE\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text 'Prijs'\n\t\t\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT\n\t\t\tEND\n\t\tIF @can_set_realprice = 1\n\t\t\tBEGIN\n\t\t\t\tIF (SELECT PATINDEX('%[^0-9.,-]%', @realprice)) > 0\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tEXEC sp_api_modal_text 'Real Prijs niet goed ingevuld','text-danger'\n\t\t\t\t\t\tEXEC sp_api_modal_input @name='Real price',@value = @realprice OUT,@class = 'is-invalid',@focus=1\n\t\t\t\t\tEND\n\t\t\t\tELSE\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tEXEC sp_api_modal_text 'Real price'\n\t\t\t\t\t\tEXEC sp_api_modal_input @name='Real price',@value = @realprice OUT\n\t\t\t\t\tEND\n\t\t\tEND\n\t\t\t\n\t\tEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\n\t\n\t\tIF (select count(id) from view_coco_prijshistory where {[Stock_ctr1].ID} = Stock_ID AND xCompanyID = {[inkoop].counterparty_id} AND TDT = 1) > 0\n\t\tBEGIN\n\t\tselect\n\t\t\tAmount\n\t\t\t,Price\n\t\t\t,insUser\n\t\t\t,[order_NR] = id\n\t\t\t,TransactionDate\n\t\t\tINTO #prijshistory2\n\t\t\tFROM view_coco_prijshistory\n\t\twhere {[Stock_ctr1].ID} = Stock_ID AND xCompanyID = {[inkoop].counterparty_id} AND TDT = 1\n\t\tEXEC sp_api_modal_table @tmptable=N'#prijshistory2',@orderby=N'ORDER BY TransactionDate DESC OFFSET 0 ROWS FETCH NEXT 8 ROWS ONLY'\n\t\tEND\n\t\tRETURN\n\tEND\n\n/*21-05-07 CG Einde: Nieuwe code toegevoegd om duidelijk aan te geven dat er een verkeerd input is ingegeven.*/\n\nIF (select count(id) from view_coco_prijshistory where {[Stock_ctr1].ID} = Stock_ID AND xCompanyID = {[inkoop].counterparty_id} AND TDT = 1) > 0\nBEGIN\nselect\n\tAmount\n\t,Price\n\t,insUser\n\t,[order_NR] = id\n\t,TransactionDate\n\tINTO #prijshistory\n\tFROM view_coco_prijshistory\nwhere {[Stock_ctr1].ID} = Stock_ID AND xCompanyID = {[inkoop].counterparty_id} AND TDT = 1\nEXEC sp_api_modal_table @tmptable=N'#prijshistory',@orderby=N'ORDER BY TransactionDate DESC OFFSET 0 ROWS FETCH NEXT 8 ROWS ONLY'\nEND\n\nIF @button IS NOT NULL\n\tBEGIN\n\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') -- zorg dat je ook komma mag gebruiken als decimaal scheidingsteken\n\t\tIF isnull(TRY_CAST(@prijs as decimal),0) >= 0 AND  TRY_CAST(@aantal as int) > 0\n\t\t\tBEGIN\n\t\t\t\tSET @user = @main_db.dbo.abcleft(@user,'@')\n\t\t\t\texec @new_id =  @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@stockID,@Amount=@Aantal,@Price=@Prijs\n\t\t\t\t\t\t\t\t, @User=@User, @priceType='FIXED'--,@flowmodel_ID=1 --losse inkoop fixed price!\n\t\t\t\tIF @new_id > 0 AND @can_set_realprice = 1 AND @realprice IS NOT NULL\n\t\t\t\t\tUPDATE xTransactionDetail SET realprice = @realprice WHERE id = @new_id\n\t\t\t\tIF @new_id > 0 AND @can_set_delayed = 1\n\t\t\t\t\tBEGIN\n\t\t\t\t\tUPDATE xTransactionDetail SET delayed = @can_set_delayed WHERE id = @new_id\n\t\t\t\t\texec sp_api_toast N'Gereserveerd!'\n\t\t\t\t\tEND\n\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de inkoop/partij' from xstock x where x.id=@stockID\n\t\t\t\texec sp_api_toast @mes\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\tEND\n\t\tELSE\n\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\tEND\n",
            "action_id": 275,
            "action_name": "purchase_from_stock_VGI",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXECUTE @main_db.dbo.RebuildLandfreight @ID ",
            "action_id": 276,
            "action_name": "RebuildLandfreight",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @valueout nvarchar(max),@option nvarchar(max),@search nvarchar(max),@tmptable nvarchar(128)\r\nEXEC sp_api_modal_text N'Kies een iets...',N'h4'\r\n\r\nSET @option = 'Land'\r\nEXEC sp_api_modal_input @name='Naam',@max=20, @value= @search OUT,@focus=1\r\n\r\nEXEC sp_api_modal_button @name='search',@value = 'Zoek', @valueout = @valueout OUT,@key='Enter'\r\nEXEC sp_api_modal_text N'Kies een optie...',N'h4'\r\nEXEC sp_api_modal_button @name='option',@value = 'Land', @valueout = @option OUT\r\nEXEC sp_api_modal_button @name='option',@value = 'Product', @valueout = @option OUT\r\nEXEC sp_api_modal_button @name='option',@value = 'Klant', @valueout = @option OUT--,@key='Enter'\r\n\r\nIF @option = 'Land'\r\n\tSELECT name_0,name_1,name_2,name_4,[grp*] = {CountryGroupID.Name} INTO #modaltable_land FROM xCountry this WHERE name_0 LIKE '%'+isnull(@search,'')+'%'\r\nIF @option = 'Product'\r\n\tSELECT Variety_0,Variety_1,Variety_2,Variety_3,Variety_4,Variety_5,Variety_6 INTO #modaltable_product FROM xProduct this WHERE Variety_0 LIKE '%'+isnull(@search,'')+'%'\r\nIF @option = 'Klant'\r\n\tSELECT Code,CompanyName,CompleteAddress INTO #modaltable_company FROM xCompany this WHERE CompanyName LIKE '%'+isnull(@search,'')+'%'\r\n\r\nIF @option = 'Land'\r\n\tEXEC sp_api_modal_table @tmptable = '#modaltable_land'\r\nIF @option = 'Product'\r\n\tEXEC sp_api_modal_table @tmptable = '#modaltable_product'\r\nIF @option = 'Klant'\r\n\tEXEC sp_api_modal_table @tmptable = '#modaltable_company'\r\n\r\n\r\n\r\n",
            "action_id": 284,
            "action_name": "Rel List",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "delete from [xinvRow] where Invoice_ID=@ID\n\nIF not exists(SELECT * FROM xinvRow WHERE xinvRow.Invoice_ID=@ID) \n\tBEGIN \n\t\tdelete from [xInvCTH] where Invoice_ID=@ID\n\t\tdelete from [xInvVatTotals] where invoice_id=@ID\n\t\tdelete FROM [xInvoice] where id=@ID -- beter: zet naar herbruikbare status\n\tEND\nELSE\n\tEXEC sp_api_toast N'Invoice has rows!'",
            "action_id": 285,
            "action_name": "Verwijder Factuur",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast 'Delete not allowed here.'\r\n\r\n",
            "action_id": 286,
            "action_name": "Remove Delete",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast 'No delete allowed here!'\r\n\r\n",
            "action_id": 287,
            "action_name": "RemoveDelete",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast 'No delete allowed here!'\n\n",
            "action_id": 288,
            "action_name": "RemoveDelete",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--update xcthtotals set pickcheck=-1, ordercheck=-1 where cth_id= @ID\nEXEC Orderbev_Undo_Last @CTH2_ID = @ID\nEXEC picklist_Undo_Last @CTH2_ID = @ID",
            "action_id": 289,
            "action_name": "reset pick/orderbev",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "update xcthtotals set pickcheck=-1, ordercheck=-1 where cth_id= @ID",
            "action_id": 290,
            "action_name": "reset pick/orderbev",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "UPDATE api_sql_tasks SET started = NULL,completed = NULL,error = NULL WHERE id IN ({@ids})\nEXEC sp_api_modal_select_all_clear",
            "action_id": 293,
            "action_name": "Run Again",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--EXEC sp_api_toast @parent_parent_id\n--exec sp_api_toast @User\nIF @id is NULL\n\tBEGIN\n\t\tEXEC sp_api_modal_clear N'Geen artikel gekozen'\n\t\t--EXEC sp_api_modal_clear\n\t\tRETURN\n\tEND\nDECLARE @CTHID INT = {[verkoop].id} --200818 curly\nIF @CTHID IS NULL begin\n\t\tEXEC sp_api_toast 'Kan geen [verkoop] vinden'\n\t\tRETURN;\n\t\tend\n--ELSE EXEC sp_api_toast @CTHID\n\n--DECLARE @CTRID INT \n--SELECT @CTRID=id from xtransactiondetail where TransactionHeader_ID = @CTHID\n\n/*\nDECLARE @GIP nvarchar(10)\nselect @GIP= av from @main_db.dbo.gip(@ID)\n*/\nDECLARE @heffing nvarchar(200),@rollend nvarchar(200)\nSELECT @heffing=heffing FROM @main_db.dbo.Heffing_xStock_indicator(@id)\n\n-- ANACO is OWNER_ID 147036\nSET @rollend = (SELECT sum(Expected) from Q_xStockLoc where xStock_ID = @id AND owner_ID = 147036)\n\nDECLARE @mes nvarchar(200), @FustSaldo int, @CoreType nvarchar(10),@FustID int, @xDesc nvarchar(200)\nSELECT @xDesc=x.[Description],@mes= concat('Selling ' , x.[Description],' Huidige Voorraad: ',x.[stock],' Rollend: ', @rollend/*,' (GIP:',TRY_CAST(@GIP as decimal(8,2)),')',' Heffing GB: ',@heffing*/),@Coretype= x.coretype,@FustID=x.Fust_ID from xstock x where x.id=@id --@main_db.dbo.\n--EXEC sp_api_modal_text @mes,'h2 text-primary'\n\nIF {[verkoop].status} not in ('openSale') AND @Coretype='FOOD' BEGIN --200924 fust mag wel worden bij of afgeboekt\n\tEXEC sp_api_modal_alert 'U kunt alleen leeg FUST toevoegen/terugnemen, want de order is definitief.'\n\tEXEC sp_api_modal_clear\t\t\n\tRETURN;\t\n\tend\n\n-- 200629 Uitbreiding inkoop vanuit diverse contexten: Zoek CTH ; bijv als we afkomstig zijn van een regel, dan is CTH te vinden in de regel\n--if @parent_card_name ='verkoop'\tset @CTHID=@parent_id\n--if @parent_card_name = 'ctr2' set @CTHID=(select TransactionHeader_ID from xtransactiondetail where xtransactiondetail.id=@parent_id)\nIF @coretype in('CRATE','PALLET')\n\tBEGIN\n\t\tSELECT @Fustsaldo=Fustsaldo from @main_db.dbo.FustSaldo_FC(@FustID,{[verkoop2].Counterparty_ID})\n\t\t-- EXEC sp_api_toast @Fustsaldo\n\t\t-- breid DECLARE message uit met het fust-saldo\n\t\tIF @FustSaldo is not NULL\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') actueel saldo bij deze klant: ',@fustsaldo)\n\t\tELSE\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') => let op: deze klant heeft dit fust nooit eerder gehad!')\n\tEND\n\t\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\nDECLARE @prijs nvarchar(20),@aantal nvarchar(20),@opmerking nvarchar(50),@stock nvarchar(50), @Pricetype nvarchar(10) --='100' --RH210113 opmerking 50 gemaakt, was 10!\nDECLARE @CounterpartyID int\nDECLARE @FlowModel int\nDECLARE @THDT INT\nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=FlowModel_ID,@THDT=TDT From xTransactionHeader CTH where CTH.ID=@CTHID\n--200630 was@parent_id\n\n--200708 => ??? WAAROM GAAT DIT NIET ??? select @Prijs= @main_db.dbo.StockPrice(@ID,@CTHID,NULL,NULL,NULL,NULL,NULL,NULL,NULL)\nDECLARE @FRAFOT Nvarchar(3) -- 'FRA' OF 'FOT'\nDECLARE @SrcID int -- let op: slechts 'advies'\nDECLARE @DstID INT\n\n\n--201022\ndeclare @dayprice bit\nset @dayprice=isnull((select L from @main_db.dbo.[GetCompanySettings]('useDayprice')),0)\n-- exec sp_api_toast @dayprice\n\n--210525\nSET @stock = (SELECT stock from xstock where id = @id)\n\nif @dayprice = 1 \n\tBEGIN\n\t\tselect top 1 @Prijs=per.pricehi from p_PriceEntryRow per where per.Stock_ID=@ID and per.Supplier_ID=@CounterpartyID and per.activeCount>0\n\tEND\n\nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=cth.FlowModel_ID,@THDT=cth.TDT,@FRAFOT=cth.FRAFOT, @srcID=cth.source_ID,@DstID=cth.Destination_ID From q_xTransactionHeader CTH where CTH.ID=@CTHID\n-- exec sp_api_toast @dstID\n--200630 was@parent_id\n\nif isnull(@Prijs,0)=0\n\tbegin\n\t\t--SELECT top 1 @prijs = ctr.ctrPRICE FROM xctrtotals ctr WHERE ctr.ctrprice > 0 AND ctr.Counterparty_ID=@CounterpartyID AND ctr.ctrStock_ID =@ID ORDER BY ctr.id DESC -- laatste prijs!\n\n\t\tset @prijs=(select @main_db.dbo.stockprice(\t@ID --48482 --stock_ID\n\t\t\t\t\t\t\t,@CTHID --3761\t--CTH_ID\n\t\t\t\t\t\t\t,@CounterpartyID --161418\t--Counterparty_ID\n\t\t\t\t\t\t\t,@FlowModel --null\t--Flowmodel_ID\n\t\t\t\t\t\t\t,@THDT --2\t\t--DaTDT\n\t\t\t\t\t\t\t,@SrcID --NULL --SupplierLocation_ID\n\t\t\t\t\t\t\t,@DstID --NULL -- 7945\t--Receiverlocation_ID\n\t\t\t\t\t\t\t,IIF(@FRAFOT='FOT',1,0)\t\t--isFOT\n\t\t\t\t\t\t\t,@dayprice --0-- use dayprice\n\t\t\t\t\t\t)\n\t\t\t\t\t)\n\n\tend\n\nDECLARE @can_set_delayed BIT = 0 \nIF dbo.ABCDATE() < dbo.workDate() OR dbo.ABCDATE() < {[verkoop].TransactionDate}\nBEGIN\n\tSET @can_set_delayed = 1\nEND\nDECLARE @new_id INT\n\nIF @id = ANY (select stock_id from xtransactiondetail where TransactionHeader_ID = @CTHID AND stock_id = @id) BEGIN\n\tDECLARE @QTYCTR nvarchar(20)\n\tSELECT @QTYCTR = sum(Amount) from xTransactiondetail where @id = stock_id AND TransactionHeader_ID = @CTHID\n\tEXEC sp_api_modal_text 'Let op! Dit artikel bestaat al in de bestelling!','text-danger font-weight-bold h2 text-center'\n\tEXEC sp_api_modal_text 'Momenteel in bestelling:','text-danger font-weight-bold h2 text-center'\n\tEXEC sp_api_modal_text @QTYCTR,@class = 'text-danger font-weight-bold display-4 text-center'\nEND\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\nEXEC sp_api_modal_text 'Aantal'\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1,@select=1\nIF @coretype in('FOOD','SERVICE')\n\tBEGIN\n\t\tEXEC sp_api_modal_text 'Prijs'\n\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT\n\tEND\nEXEC sp_api_modal_text 'Opm. loods'\nEXEC sp_api_modal_input @name='opmerking',@value = @opmerking OUT\nDECLARE @button nvarchar(128), @KiesPartijbutton nvarchar(128),@goto nvarchar(2000),@search nvarchar(2000),@goback nvarchar(2000)\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\nEXEC sp_api_modal_button @name='button',@value = 'Kies een Partij',@valueout = @KiesPartijbutton OUT,@class = 'btn-primary',@key = 'ArrowRight'\n\nIF (SELECT PATINDEX('%[^0-9.,-]%', @prijs)) > 0 OR (SELECT PATINDEX('%[^0-9-]%', @aantal)) > 0\n\tBEGIN\n\tEXEC sp_api_modal_clear\t\n\t\n\t\tIF @id = ANY (select stock_id from xtransactiondetail where TransactionHeader_ID = @CTHID AND stock_id = @id) BEGIN\n\t\t\tSELECT @QTYCTR = sum(Amount) from xTransactiondetail where @id = stock_id AND TransactionHeader_ID = @CTHID\n\t\t\tEXEC sp_api_modal_text 'Let op! Dit artikel bestaat al in de bestelling!','text-danger font-weight-bold h2 text-center'\n\t\t\tEXEC sp_api_modal_text 'Momenteel in bestelling:','text-danger font-weight-bold h2 text-center'\n\t\t\tEXEC sp_api_modal_text @QTYCTR,@class = 'text-danger font-weight-bold display-4 text-center'\n\t\tEND\n\t\tEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\n\t\t\n\t\tIF (SELECT PATINDEX('%[^0-9-]%', @aantal)) > 0\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text 'Aantal niet goed ingevuld','text-danger'\n\t\t\t\tEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@class = 'is-invalid',@focus=1\n\t\t\tEND\n\t\tELSE\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text 'Aantal'\n\t\t\t\tEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT\n\t\t\tEND\n\t\tIF (SELECT PATINDEX('%[^0-9.,-]%', @prijs)) > 0\n\t\t\tBEGIN\n\t\t\tIF @coretype in('FOOD','SERVICE')\n\t\t\t\tBEGIN\n\t\t\t\t\tEXEC sp_api_modal_text 'Prijs niet goed ingevuld','text-danger'\n\t\t\t\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT,@class = 'is-invalid',@focus=1\n\t\t\t\tEND\n\t\t\tEND\n\t\tELSE\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text 'Prijs'\n\t\t\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT\n\t\t\tEND\n\t\tEXEC sp_api_modal_text 'Opm. loods'\n\t\tEXEC sp_api_modal_input @name='opmerking',@value = @opmerking OUT\n\t\tEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\n\t\tEXEC sp_api_modal_button @name='button',@value = 'Kies een Partij',@valueout = @KiesPartijbutton OUT,@class = 'btn-primary',@key = 'ArrowRight'\n\t\t\n\t\tIF @KiesPartijbutton = 'Kies een Partij'\n\t\tBEGIN\n\t\t\tSET @goback = @path\n\t\t\tSET @goto = @path+'/'+@id+'/voorraad_partijregels'\n\t\t\tEXEC sp_api_toast N'Naar Partij',N'alert-primary'\n\t\t\tSET @search = N'?id='+@id\n\t\t\tEXEC sp_api_goto @goto,@referer_path=@goback,@referer_search=@search\n\t\tEND\n\t\n\t\tIF (select count(id) from view_coco_prijshistory where {[Stock_ctr2].ID} = Stock_ID AND xCompanyID = {[verkoop].counterparty_id} AND TDT = 2) > 0\n\t\tBEGIN\n\t\tselect\n\t\t\tAmount\n\t\t\t,Price\n\t\t\t,insUser\n\t\t\t,[order_NR] = id\n\t\t\t,TransactionDate\n\t\t\tINTO #prijshistory2\n\t\t\tFROM view_coco_prijshistory\n\t\twhere {[Stock_ctr2].ID} = Stock_ID AND xCompanyID = {[verkoop].counterparty_id} AND TDT = 2\n\t\tEXEC sp_api_modal_table @tmptable=N'#prijshistory2',@orderby=N'ORDER BY TransactionDate DESC OFFSET 0 ROWS FETCH NEXT 8 ROWS ONLY'\n\t\tEND\n\t\tRETURN\n\tEND\n\nIF (select count(id) from view_coco_prijshistory where {[Stock_ctr2].ID} = Stock_ID AND xCompanyID = {[verkoop].counterparty_id} AND TDT = 2) > 0\nBEGIN\nselect\n\tAmount\n\t,Price\n\t,insUser\n\t,[order_NR] = id\n\t,TransactionDate\n\tINTO #prijshistory\n\tFROM view_coco_prijshistory\nwhere {[Stock_ctr2].ID} = Stock_ID AND xCompanyID = {[verkoop].counterparty_id} AND TDT = 2\nEXEC sp_api_modal_table @tmptable=N'#prijshistory',@orderby=N'ORDER BY TransactionDate DESC OFFSET 0 ROWS FETCH NEXT 8 ROWS ONLY'\nEND\n\nDECLARE @mapfustpartijregel int\n\n\tBEGIN\n\t\tIF dbo.str2dec(@prijs) > 100 BEGIN -- groter dan 100\n\t\tEXEC sp_api_modal_clear\t\n\t\tEXEC sp_api_modal_text 'LET OP! PRIJS IS GROTER DAN:','text-danger font-weight-bold text-center'\n\t\tEXEC sp_api_modal_text '100,00', 'text-danger font-weight-bold display-4 text-center'\n\t\tEXEC sp_api_modal_text 'DRUK (INSERT) OM TOCH DOOR TE GAAN OF VUL EEN ANDERE PRIJS IN:','text-danger font-weight-bold text-center'\n\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT,@focus=1,@select=1\n\t\tDECLARE @button2 nvarchar(128)\n\t\tEXEC sp_api_modal_button @name='button2',@value = 'Doorgaan',@valueout = @button2 OUT,@class = 'btn-danger',@key = 'Insert'\n\t\tEXEC sp_api_modal_text 'DRUK OP (ESC) OM DIT SCHERM TE VERLATEN','text-Secondary text-right blockquote-footer'\n\t\tIF @button2 IS NOT NULL BEGIN\n\t\t\tIF @button IS NOT NULL\n\t\t\tBEGIN\n\t\t\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') \n\t\t\t\tIF \t\tdbo.str2dec(@prijs) > 0 OR dbo.str2dec(@prijs) = 0 AND \n\t\t\t\t\t\tdbo.str2dec(@aantal) > 0 \n\t\t\t\t\t\tOR @FustSaldo is not NULL \n\t\t\t\t\tBEGIN\n\t\t\t\t\t\texec @new_id = @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs,@Logistic=@Opmerking, @User=@User\n\t\t\t\t\t\t/* -- automatisch op delayed als datum anders is dan werkdatum uitgezet. Anaco maakt hier geen gebruik van.\n\t\t\t\t\t\tIF @new_id > 0 AND @can_set_delayed = 1\n\t\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\tUPDATE xTransactionDetail SET delayed = @can_set_delayed WHERE id = @new_id\n\t\t\t\t\t\t\texec sp_api_toast N'Gereserveerd!'\n\t\t\t\t\t\t\tEND\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\n\t\t\t\t\t\texec sp_api_toast @mes\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\t\tEND\n\t\t\t\tELSE\n\t\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\t\t\t\tEND \t\t\n\t\t\tEND\n\t\tEND\n\n\t\tIF dbo.str2dec(@prijs) BETWEEN 0 AND 1 BEGIN -- kleiner dan 1\n\t\tEXEC sp_api_modal_clear\n\t\tEXEC sp_api_modal_text 'LET OP! PRIJS IS KLEINER DAN:','text-danger font-weight-bold text-center'\n\t\tEXEC sp_api_modal_text '1,00','text-danger font-weight-bold display-4 text-center'\n\t\tEXEC sp_api_modal_text 'DRUK (INSERT) OM TOCH DOOR TE GAAN OF VUL EEN ANDERE PRIJS IN:','text-danger font-weight-bold text-center'\n\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT,@focus=1,@select=1\n\t\tDECLARE @button3 nvarchar(128)\n\t\tEXEC sp_api_modal_button @name='button3',@value = 'Doorgaan',@valueout = @button3 OUT,@class = 'btn-danger',@key = 'Insert'\n\t\tEXEC sp_api_modal_text 'DRUK OP (ESC) OM DIT SCHERM TE VERLATEN','text-Secondary text-right blockquote-footer'\n\t\tIF @button3 IS NOT NULL BEGIN\n\t\t\tIF @button IS NOT NULL\n\t\t\tBEGIN\n\t\t\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') \n\t\t\t\tIF \t\tdbo.str2dec(@prijs) > 0 OR dbo.str2dec(@prijs) = 0 AND \n\t\t\t\t\t\tdbo.str2dec(@aantal) > 0 \n\t\t\t\t\t\tOR @FustSaldo is not NULL \n\t\t\t\t\tBEGIN\n\t\t\t\t\t\texec @new_id = @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs,@Logistic=@Opmerking, @User=@User\n\t\t\t\t\t\t/* -- automatisch op delayed als datum anders is dan werkdatum uitgezet. Anaco maakt hier geen gebruik van.\n\t\t\t\t\t\tIF @new_id > 0 AND @can_set_delayed = 1\n\t\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\tUPDATE xTransactionDetail SET delayed = @can_set_delayed WHERE id = @new_id\n\t\t\t\t\t\t\texec sp_api_toast N'Gereserveerd!'\n\t\t\t\t\t\t\tEND\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\n\t\t\t\t\t\texec sp_api_toast @mes\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\t\tEND\n\t\t\t\tELSE\n\t\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\t\t\t\tEND \t\t\n\t\t\tEND\n\t\tEND\n\tEND\n\nIF @button IS NOT NULL AND dbo.str2dec(@prijs) BETWEEN 1 AND 100 AND dbo.str2dec(@aantal) <= dbo.str2dec(@stock)-- tussen 1 en 100\n\t\t\tBEGIN\n\t\t\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') -- dit vertaalt een komma in een punt, waardoor iemand 123,85 kan intikken END ook 123.85\n\t\t\t\tIF \t\tdbo.str2dec(@prijs) > 0 AND \n\t\t\t\t\t\tdbo.str2dec(@aantal) > 0 \n\t\t\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\texec @new_id = @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs,@Logistic=@Opmerking, @User=@User\n\t\t\t\t\t\t/* -- automatisch op delayed als datum anders is dan werkdatum uitgezet. Anaco maakt hier geen gebruik van.\n\t\t\t\t\t\tIF @new_id > 0 AND @can_set_delayed = 1\n\t\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\tUPDATE xTransactionDetail SET delayed = @can_set_delayed WHERE id = @new_id\n\t\t\t\t\t\t\texec sp_api_toast N'Gereserveerd!'\n\t\t\t\t\t\t\tEND\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\n\t\t\t\t\t\texec sp_api_toast @mes\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\t\tEND\n\t\t\t\tELSE\n\t\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\t\t\t\tEND\n\t\t\t\t\nIF @button IS NOT NULL AND @coretype in('CRATE','PALLET') -- fust\n\t\t\tBEGIN\n\t\t\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') -- dit vertaalt een komma in een punt, waardoor iemand 123,85 kan intikken END ook 123.85\n\t\t\t\tIF \t\t--dbo.str2dec(@prijs) > 0 AND \n\t\t\t\t\t\tdbo.str2dec(@aantal) > 0 \n\t\t\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\n\t\t\t\t\tBEGIN\n\t\t\t\tSET @mapfustpartijregel=(select @main_db.dbo.FustIV_VTD(@FustID))\n\t\t\t\t\t\texec @new_id = @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs,@Logistic=@Opmerking, @User=@User,@mapctr_id=@mapfustpartijregel\n\t\t\t\t\t\t/* -- automatisch op delayed als datum anders is dan werkdatum uitgezet. Anaco maakt hier geen gebruik van.\n\t\t\t\t\t\tIF @new_id > 0 AND @can_set_delayed = 1\n\t\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\tUPDATE xTransactionDetail SET delayed = @can_set_delayed WHERE id = @new_id\n\t\t\t\t\t\t\texec sp_api_toast N'Gereserveerd!'\n\t\t\t\t\t\t\tEND\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\n\t\t\t\t\t\texec sp_api_toast @mes\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\t\tEND\n\t\t\t\tELSE\n\t\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\t\t\t\tEND\n\t\t\t\t\nIF @button IS NOT NULL AND dbo.str2dec(@aantal) > 0  AND dbo.str2dec(@prijs) is NULL AND dbo.str2dec(@aantal) <= dbo.str2dec(@stock)-- aantal groter dan 0 en price niet ingevuld.\n\t\t\tBEGIN\n\t\t\t\t--IF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') -- dit vertaalt een komma in een punt, waardoor iemand 123,85 kan intikken END ook 123.85\n\t\t\t\tIF \t\t--dbo.str2dec(@prijs) > 0 AND \n\t\t\t\t\t\tdbo.str2dec(@aantal) > 0 \n\t\t\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\n\t\t\t\t\tBEGIN\n\t\t\t\tSET @mapfustpartijregel=(select @main_db.dbo.FustIV_VTD(@FustID))\n\t\t\t\t\t\texec @new_id = @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs,@Pricetype='FIXED',@Logistic=@Opmerking, \t\t\t \n   \t\t\t\t\t\t@User=@User,@mapctr_id=@mapfustpartijregel\n   \t\t\t\t\t\t/* -- automatisch op delayed als datum anders is dan werkdatum uitgezet. Anaco maakt hier geen gebruik van.\n\t\t\t\t\t\tIF @new_id > 0 AND @can_set_delayed = 1\n\t\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\tUPDATE xTransactionDetail SET delayed = @can_set_delayed WHERE id = @new_id\n\t\t\t\t\t\t\texec sp_api_toast N'Gereserveerd!'\n\t\t\t\t\t\t\tEND\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\n\t\t\t\t\t\texec sp_api_toast @mes\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\t\tEND\n\t\t\t\tELSE\n\t\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\t\t\t\tEND\n\t\t\t\t\nIF dbo.str2dec(@aantal) > dbo.str2dec(@stock) -- aantal groter dan huidige voorraad.\n\t\tBEGIN\n\t\tEXEC sp_api_modal_clear\n\t\tEXEC sp_api_modal_text 'LET OP! AANTAL IS GROTER DAN VOORRAAD:','text-danger font-weight-bold text-center'\n\t\tEXEC sp_api_modal_text 'DRUK (INSERT) OM TOCH DOOR TE GAAN OF VUL EEN ANDER AANTAL IN:','text-danger font-weight-bold text-center'\n\t\tEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1,@select=1\n\t\tDECLARE @button4 nvarchar(128)\n\t\tEXEC sp_api_modal_button @name='button4',@value = 'Doorgaan',@valueout = @button4 OUT,@class = 'btn-danger',@key = 'Insert'\n\t\tEXEC sp_api_modal_text 'DRUK OP (ESC) OM DIT SCHERM TE VERLATEN','text-Secondary text-right blockquote-footer'\n\t\tIF @button4 IS NOT NULL BEGIN\n\t\t\tIF @button IS NOT NULL\n\t\t\tBEGIN\n\t\t\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') \n\t\t\t\tIF \t\tdbo.str2dec(@prijs) > 0 OR (dbo.str2dec(@prijs) = 0 OR dbo.str2dec(@prijs) is NULL) AND \n\t\t\t\t\t\tdbo.str2dec(@aantal) > 0 \n\t\t\t\t\t\tOR @FustSaldo is not NULL \n\t\t\t\t\tBEGIN\n\t\t\t\t\t\texec @new_id = @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs,@Logistic=@Opmerking, @User=@User\n\t\t\t\t\t\t/* -- automatisch op delayed als datum anders is dan werkdatum uitgezet. Anaco maakt hier geen gebruik van.\n\t\t\t\t\t\tIF @new_id > 0 AND @can_set_delayed = 1\n\t\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\tUPDATE xTransactionDetail SET delayed = @can_set_delayed WHERE id = @new_id\n\t\t\t\t\t\t\texec sp_api_toast N'Gereserveerd!'\n\t\t\t\t\t\t\tEND\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\n\t\t\t\t\t\texec sp_api_toast @mes\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\t\tEND\n\t\t\t\tELSE\n\t\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\t\t\t\tEND \t\t\n\t\t\tEND\n\t\tEND\n\t\t\t\t\nIF @KiesPartijbutton = 'Kies een Partij'\n\tBEGIN\n\t\tSET @goback = @path\n\t\tSET @goto = @path+'/'+@id+'/voorraad_partijregels'\n\t\tEXEC sp_api_toast N'Naar Partij',N'alert-primary'\n\t\tSET @search = N'?id='+@id\n\t\tEXEC sp_api_goto @goto,@referer_path=@goback,@referer_search=@search\n\tEND",
            "action_id": 294,
            "action_name": "SelectAmount",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--EXEC sp_api_toast @parent_parent_id\r\n--exec sp_api_toast @User\r\n\t\r\nDECLARE @CTHID INT = {[verkoop2].id} --200818 curly\r\nIF @CTHID IS NULL begin\r\n\t\tEXEC sp_api_toast 'Kan geen [verkoop] vinden'\r\n\t\tRETURN;\r\n\t\tend\r\n--ELSE EXEC sp_api_toast @CTHID\r\n\r\n--DECLARE @CTRID INT \r\n--SELECT @CTRID=id from xtransactiondetail where TransactionHeader_ID = @CTHID\r\n\r\nDECLARE @mes nvarchar(200), @FustSaldo int, @CoreType nvarchar(10),@FustID int, @xDesc nvarchar(200)\r\nSELECT @xDesc=x.[Description],@mes= concat('Selling ' , x.[Description]) ,@Coretype= x.coretype,@FustID=x.Fust_ID from xstock x where x.id=@ID --@main_db.dbo.\r\n--EXEC sp_api_modal_text @mes,'h2 text-primary'\r\n\r\nIF {[verkoop2].status} not in ('openSale') AND @Coretype='FOOD' BEGIN --200924 fust mag wel worden bij of afgeboekt\r\n\tEXEC sp_api_modal_alert 'U kunt alleen leeg FUST toevoegen/terugnemen, want de order is definitief.'\r\n\tEXEC sp_api_modal_clear\t\t\r\n\tRETURN;\t\r\n\tend\r\n\r\n-- 200629 Uitbreiding inkoop vanuit diverse contexten: Zoek CTH ; bijv als we afkomstig zijn van een regel, dan is CTH te vinden in de regel\r\n--if @parent_card_name ='verkoop'\tset @CTHID=@parent_id\r\n--if @parent_card_name = 'ctr2' set @CTHID=(select TransactionHeader_ID from xtransactiondetail where xtransactiondetail.id=@parent_id)\r\nIF @coretype in('CRATE','PALLET')\r\n\tBEGIN\r\n\t\tSELECT @Fustsaldo=Fustsaldo from @main_db.dbo.FustSaldo_FC(@FustID,{[verkoop2].Counterparty_ID})\r\n\t\t-- EXEC sp_api_toast @Fustsaldo\r\n\t\t-- breid DECLARE message uit met het fust-saldo\r\n\t\tIF @FustSaldo is not NULL\r\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') actueel saldo bij deze klant: ',@fustsaldo)\r\n\t\tELSE\r\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') => let op: deze klant heeft dit fust nooit eerder gehad!')\r\n\tEND\r\n\t\r\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\r\nDECLARE @prijs nvarchar(20),@aantal nvarchar(20),@opmerking nvarchar(10), @Pricetype nvarchar(10) --='100'\r\nDECLARE @CounterpartyID int\r\nDECLARE @FlowModel int\r\nDECLARE @THDT INT\r\nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=FlowModel_ID,@THDT=TDT From xTransactionHeader CTH where CTH.ID=@CTHID\r\n--200630 was@parent_id\r\n\r\n--200708 => ??? WAAROM GAAT DIT NIET ??? select @Prijs= @main_db.dbo.StockPrice(@ID,@CTHID,NULL,NULL,NULL,NULL,NULL,NULL,NULL)\r\nDECLARE @FRAFOT Nvarchar(3) -- 'FRA' OF 'FOT'\r\nDECLARE @SrcID int -- let op: slechts 'advies'\r\nDECLARE @DstID INT\r\n\r\n\r\n--201022\r\ndeclare @dayprice bit\r\nset @dayprice=isnull((select L from @main_db.dbo.[GetCompanySettings]('useDayprice')),0)\r\n-- exec sp_api_toast @dayprice\r\n\r\nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=cth.FlowModel_ID,@THDT=cth.TDT,@FRAFOT=cth.FRAFOT, @srcID=cth.source_ID,@DstID=cth.Destination_ID From q_xTransactionHeader CTH where CTH.ID=@CTHID\r\n-- exec sp_api_toast @dstID\r\n--200630 was@parent_id\r\n\r\nif isnull(@Prijs,0)=0\r\n\tbegin\r\n\t\t--SELECT top 1 @prijs = ctr.ctrPRICE FROM xctrtotals ctr WHERE ctr.ctrprice > 0 AND ctr.Counterparty_ID=@CounterpartyID AND ctr.ctrStock_ID =@ID ORDER BY ctr.id DESC -- laatste prijs!\r\n\r\n\t\tset @prijs=(select @main_db.dbo.stockprice(\t@ID --48482 --stock_ID\r\n\t\t\t\t\t\t\t,@CTHID --3761\t--CTH_ID\r\n\t\t\t\t\t\t\t,@CounterpartyID --161418\t--Counterparty_ID\r\n\t\t\t\t\t\t\t,@FlowModel --null\t--Flowmodel_ID\r\n\t\t\t\t\t\t\t,@THDT --2\t\t--DaTDT\r\n\t\t\t\t\t\t\t,@SrcID --NULL --SupplierLocation_ID\r\n\t\t\t\t\t\t\t,@DstID --NULL -- 7945\t--Receiverlocation_ID\r\n\t\t\t\t\t\t\t,IIF(@FRAFOT='FOT',1,0)\t\t--isFOT\r\n\t\t\t\t\t\t\t,@dayprice --0-- use dayprice\r\n\t\t\t\t\t\t)\r\n\t\t\t\t\t)\r\n\r\n\tend\r\n\r\nIF @id = ANY (select stock_id from xtransactiondetail where TransactionHeader_ID = @CTHID AND stock_id = @id) BEGIN\r\n\tDECLARE @QTYCTR nvarchar(20)\r\n\tSELECT @QTYCTR = sum(Amount) from xTransactiondetail where @id = stock_id AND TransactionHeader_ID = @CTHID\r\n\tEXEC sp_api_modal_text 'Let op! Dit artikel bestaat al in de bestelling!','text-danger font-weight-bold h2 text-center'\r\n\tEXEC sp_api_modal_text 'Momenteel in bestelling:','text-danger font-weight-bold h2 text-center'\r\n\tEXEC sp_api_modal_text @QTYCTR,@class = 'text-danger font-weight-bold display-4 text-center'\r\nEND\r\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\r\nEXEC sp_api_modal_text 'Aantal'\r\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1,@select=1\r\nIF @coretype in('FOOD')\r\n\tBEGIN\r\n\t\tEXEC sp_api_modal_text 'Prijs'\r\n\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT\r\n\tEND\r\nEXEC sp_api_modal_text 'Opm. loods'\r\nEXEC sp_api_modal_input @name='opmerking',@value = @opmerking OUT\r\nDECLARE @button nvarchar(128)\r\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\r\nDECLARE @mapfustpartijregel int\r\n\r\n\tBEGIN\r\n\t\tIF dbo.str2dec(@prijs) > 100 BEGIN -- groter dan 100\r\n\t\tEXEC sp_api_modal_clear\t\r\n\t\tEXEC sp_api_modal_text 'LET OP! PRIJS IS GROTER DAN:','text-danger font-weight-bold text-center'\r\n\t\tEXEC sp_api_modal_text '100,00', 'text-danger font-weight-bold display-4 text-center'\r\n\t\tEXEC sp_api_modal_text 'DRUK (INSERT) OM TOCH DOOR TE GAAN OF VUL EEN ANDERE PRIJS IN:','text-danger font-weight-bold text-center'\r\n\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT,@focus=1,@select=1\r\n\t\tDECLARE @button2 nvarchar(128)\r\n\t\tEXEC sp_api_modal_button @name='button2',@value = 'Doorgaan',@valueout = @button2 OUT,@class = 'btn-danger',@key = 'Insert'\r\n\t\tEXEC sp_api_modal_text 'DRUK OP (ESC) OM DIT SCHERM TE VERLATEN','text-Secondary text-right blockquote-footer'\r\n\t\tIF @button2 IS NOT NULL BEGIN\r\n\t\t\tIF @button IS NOT NULL\r\n\t\t\tBEGIN\r\n\t\t\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') \r\n\t\t\t\tIF \t\tdbo.str2dec(@prijs) > 0 OR dbo.str2dec(@prijs) = 0 AND \r\n\t\t\t\t\t\tdbo.str2dec(@aantal) > 0 \r\n\t\t\t\t\t\tOR @FustSaldo is not NULL \r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs,@Logistic=@Opmerking, @User=@User\r\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\r\n\t\t\t\t\t\texec sp_api_toast @mes\r\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\r\n\t\t\t\t\tEND\r\n\t\t\t\tELSE\r\n\t\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\r\n\t\t\t\tEND \t\t\r\n\t\t\tEND\r\n\t\tEND\r\n\r\n\t\tIF dbo.str2dec(@prijs) BETWEEN 0 AND 1 BEGIN -- kleiner dan 1\r\n\t\tEXEC sp_api_modal_clear\r\n\t\tEXEC sp_api_modal_text 'LET OP! PRIJS IS KLEINER DAN:','text-danger font-weight-bold text-center'\r\n\t\tEXEC sp_api_modal_text '1,00','text-danger font-weight-bold display-4 text-center'\r\n\t\tEXEC sp_api_modal_text 'DRUK (INSERT) OM TOCH DOOR TE GAAN OF VUL EEN ANDERE PRIJS IN:','text-danger font-weight-bold text-center'\r\n\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT,@focus=1,@select=1\r\n\t\tDECLARE @button3 nvarchar(128)\r\n\t\tEXEC sp_api_modal_button @name='button3',@value = 'Doorgaan',@valueout = @button3 OUT,@class = 'btn-danger',@key = 'Insert'\r\n\t\tEXEC sp_api_modal_text 'DRUK OP (ESC) OM DIT SCHERM TE VERLATEN','text-Secondary text-right blockquote-footer'\r\n\t\tIF @button3 IS NOT NULL BEGIN\r\n\t\t\tIF @button IS NOT NULL\r\n\t\t\tBEGIN\r\n\t\t\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') \r\n\t\t\t\tIF \t\tdbo.str2dec(@prijs) > 0 OR dbo.str2dec(@prijs) = 0 AND \r\n\t\t\t\t\t\tdbo.str2dec(@aantal) > 0 \r\n\t\t\t\t\t\tOR @FustSaldo is not NULL \r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs,@Logistic=@Opmerking, @User=@User\r\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\r\n\t\t\t\t\t\texec sp_api_toast @mes\r\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\r\n\t\t\t\t\tEND\r\n\t\t\t\tELSE\r\n\t\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\r\n\t\t\t\tEND \t\t\r\n\t\t\tEND\r\n\t\tEND\r\n\tEND\r\n\r\nIF @button IS NOT NULL AND dbo.str2dec(@prijs) BETWEEN 1 AND 100 -- tussen 1 en 100\r\n\t\t\tBEGIN\r\n\t\t\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') -- dit vertaalt een komma in een punt, waardoor iemand 123,85 kan intikken END ook 123.85\r\n\t\t\t\tIF \t\tdbo.str2dec(@prijs) > 0 AND \r\n\t\t\t\t\t\tdbo.str2dec(@aantal) > 0 \r\n\t\t\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs,@Logistic=@Opmerking, @User=@User\r\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\r\n\t\t\t\t\t\texec sp_api_toast @mes\r\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\r\n\t\t\t\t\tEND\r\n\t\t\t\tELSE\r\n\t\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\r\n\t\t\t\tEND\r\nIF @button IS NOT NULL AND @coretype in('CRATE','PALLET') -- fust\r\n\t\t\tBEGIN\r\n\t\t\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') -- dit vertaalt een komma in een punt, waardoor iemand 123,85 kan intikken END ook 123.85\r\n\t\t\t\tIF \t\t--dbo.str2dec(@prijs) > 0 AND \r\n\t\t\t\t\t\tdbo.str2dec(@aantal) > 0 \r\n\t\t\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\tSET @mapfustpartijregel=(select @main_db.dbo.FustIV_VTD(@FustID))\r\n\t\t\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs,@Logistic=@Opmerking, @User=@User,@mapctr_id=@mapfustpartijregel\r\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\r\n\t\t\t\t\t\texec sp_api_toast @mes\r\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\r\n\t\t\t\t\tEND\r\n\t\t\t\tELSE\r\n\t\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\r\n\t\t\t\tEND\r\nIF @button IS NOT NULL AND dbo.str2dec(@aantal) > 0  AND dbo.str2dec(@prijs) is NULL -- aantal groter dan 0 en price niet ingevuld.\r\n\t\t\tBEGIN\r\n\t\t\t\t--IF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') -- dit vertaalt een komma in een punt, waardoor iemand 123,85 kan intikken END ook 123.85\r\n\t\t\t\tIF \t\t--dbo.str2dec(@prijs) > 0 AND \r\n\t\t\t\t\t\tdbo.str2dec(@aantal) > 0 \r\n\t\t\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\tSET @mapfustpartijregel=(select @main_db.dbo.FustIV_VTD(@FustID))\r\n\t\t\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs,@Pricetype='FIXED',@Logistic=@Opmerking, \t\t\t \r\n   \t\t\t\t\t\t@User=@User,@mapctr_id=@mapfustpartijregel\r\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\r\n\t\t\t\t\t\texec sp_api_toast @mes\r\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\r\n\t\t\t\t\tEND\r\n\t\t\t\tELSE\r\n\t\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\r\n\t\t\t\tEND",
            "action_id": 295,
            "action_name": "SelectAmount",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_text 'Filter prijzen',N'mt-4 h5'\r\nDECLARE @search nvarchar(128) = {[verkoop].CounterParty_ID.Code} ,@button nvarchar(128),@Description nvarchar(max)\r\nEXEC sp_api_modal_input @name='search',@value = @search OUT,@focus=0,@select=1\r\nEXEC sp_api_modal_input @name='search1',@value = @search OUT,@focus=0,@select=0\r\nEXEC sp_api_modal_input @name='search3',@value = @search OUT,@focus=0,@select=0\r\n\r\nSET @button = 'Historie'\r\nEXEC sp_api_modal_button @name='button',@value = 'Historie',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\r\nEXEC sp_api_modal_button @name='button',@value = 'Hell',@valueout = @button OUT,@class = 'btn-primary',@key = 'F2'\r\n\r\nDECLARE @CounterParty_ID INT = {[verkoop].CounterParty_ID}\r\nDECLARE @xProduct_ID INT = {[stock_ctr2].xProduct_ID}\r\n\r\nIF @button = 'Historie'\r\n\tBEGIN\r\n\r\n\t\tSET @Description = CONCAT(N'Historie', ' - ' + {[stock_ctr2].Description})\r\n\t\tEXEC sp_api_modal_text @text = @Description,@class = 'h3 text-muted'\r\n\t\tSELECT [Datum*]=ctr.TransactionDate,ctr.Amount, ctr.Price,ctr.Origin_Code,ctr.Counterparty INTO #klant_historie FROM Q_xTransactionDetail ctr\r\n\t\t\tWHERE Stock_ID IN (SELECT id FROM xStock WHERE xProduct_ID = @xProduct_ID) AND Price > 0 ORDER BY ctr.TransactionDate DESC\r\n\t\tEXEC sp_api_modal_table @tmptable=N'#klant_historie'\r\n\tEND\r\n\r\nIF @button = 'Hell'\r\n\tBEGIN\r\n\t\tSET @Description = N'Hell suppliers'\r\n\r\nSELECT\r\n\t[Supplier*] = (SELECT CONCAT(Code,' - ',CompanyName) FROM xCompany WHERE id = Supplier_ID)\r\n\t,Receiver = (SELECT CONCAT(Code,' - ',CompanyName) FROM xCompany WHERE id = Receiver_ID)\r\n\t,[inPrice] = inPrice\r\n\t,Pallet = IIF(FullPalletPrice=1,'Full Pallet','')\r\n\t\tINTO #modaltable FROM t_Price this WHERE Art_ID = @id AND (\r\n\t\t\t(SELECT CONCAT(Code,' - ',CompanyName) FROM xCompany WHERE id = Supplier_ID) LIKE '%'+@search+'%'\r\n\t\t\t\tOR\r\n\t\t\t(SELECT CONCAT(Code,' - ',CompanyName) FROM xCompany WHERE id = Receiver_ID) LIKE '%'+@search+'%'\r\n\t)\r\nEXEC sp_api_modal_table\r\nEND\r\n\r\nreturn\t\r\n\r\n\r\nDECLARE @CTHID INT = {[verkoop].id} --200818 curly\r\nIF @CTHID IS NULL begin\r\n\t\tEXEC sp_api_toast 'Kan geen [verkoop] vinden'\r\n\t\tRETURN;\r\n\t\tend\r\n--ELSE EXEC sp_api_toast @CTHID\r\n\r\nDECLARE @mes nvarchar(200), @FustSaldo int, @CoreType nvarchar(10),@FustID int, @xDesc nvarchar(200)\r\nSELECT @xDesc=x.[Description],@mes= concat('Selling ' , x.[Description]) ,@Coretype= x.coretype,@FustID=x.Fust_ID from xstock x where x.id=@ID --@main_db.dbo.\r\n--EXEC sp_api_modal_text @mes,'h2 text-primary'\r\n\r\nIF {[verkoop].status} not in ('openSale') AND @Coretype='FOOD' BEGIN --200924 fust mag wel worden bij of afgeboekt\r\n\tEXEC sp_api_modal_alert 'U kunt alleen leeg FUST toevoegen/terugnemen, want de order is definitief.'\r\n\tEXEC sp_api_modal_clear\t\t\r\n\tRETURN;\t\r\n\tend\r\n\r\n-- 200629 Uitbreiding inkoop vanuit diverse contexten: Zoek CTH ; bijv als we afkomstig zijn van een regel, dan is CTH te vinden in de regel\r\n--if @parent_card_name ='verkoop'\tset @CTHID=@parent_id\r\n--if @parent_card_name = 'ctr2' set @CTHID=(select TransactionHeader_ID from xtransactiondetail where xtransactiondetail.id=@parent_id)\r\n\r\n\r\n------\r\nIF @coretype in('CRATE','PALLET')\r\n\tBEGIN\r\n\t\tSELECT @Fustsaldo=Fustsaldo from @main_db.dbo.FustSaldo_FC(@FustID,{[verkoop].Counterparty_ID})\r\n\t\tEXEC sp_api_toast @Fustsaldo\r\n\t\t-- breid DECLARE message uit met het fust-saldo\r\n\t\tIF @FustSaldo is not NULL\r\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') actueel saldo bij deze klant: ',@fustsaldo)\r\n\t\tELSE\r\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') => let op: deze klant heeft dit fust nooit eerder gehad!')\r\n\tEND\r\n\r\n\r\n\r\n\r\n\r\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\r\nDECLARE @prijs nvarchar(20),@aantal nvarchar(20) --='100'\r\nDECLARE @CounterpartyID int\r\nDECLARE @FlowModel int\r\nDECLARE @THDT INT\r\nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=FlowModel_ID,@THDT=TDT From xTransactionHeader CTH where CTH.ID=@CTHID\r\n--200630 was@parent_id\r\n--BEGIN \r\n--200708 => ??? WAAROM GAAT DIT NIET ??? select @Prijs= @main_db.dbo.StockPrice(@ID,@CTHID,NULL,NULL,NULL,NULL,NULL,NULL,NULL)\r\n\r\nif isnull(@Prijs,0)=0\r\n\tbegin\r\n\t\tSELECT top 1 @prijs = ctr.ctrPRICE FROM xctrtotals ctr WHERE ctr.ctrprice > 0 AND\r\n\t\tctr.Counterparty_ID=@CounterpartyID AND ctr.ctrStock_ID =@ID ORDER BY ctr.id DESC -- laatste prijs!\r\n\tend\r\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\r\nEXEC sp_api_modal_text 'Aantal'\r\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1\r\nIF @coretype in('FOOD')\r\n\tBEGIN\r\n\t\tEXEC sp_api_modal_text 'Prijs'\r\n\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT\r\n\tEND\r\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\r\nIF @button IS NOT NULL\r\n\tBEGIN\r\n\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') -- 200924 zorg dat je ook komma mag gebruiken als decimaal scheidingsteken\r\n\t\tIF \t\t--try_cast(@prijs as decimal(10,2)) > 0 AND \r\n\t\t\tTRY_CAST(@aantal as int) >\t 0 \r\n\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\r\n\t\t\tBEGIN\r\n\t\t\t\tDECLARE @mapfustpartijregel int\r\n\t\t\t\tSET @mapfustpartijregel=(select @main_db.dbo.FustIV_VTD(@FustID))\r\n\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs, @User=@User,@mapctr_id=@mapfustpartijregel\r\n\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\r\n\t\t\t\texec sp_api_toast @mes\r\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\r\n\t\t\t\tRETURN\r\n\t\t\tEND\r\n\t\tELSE\r\n\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\r\n\tEND\r\n\r\n\r\n",
            "action_id": 296,
            "action_name": "SelectAmount2",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--EXEC sp_api_toast @parent_parent_id\r\n--exec sp_api_toast @User\r\n\t\r\nDECLARE @CTHID INT = {[ompakken].id} --200818 curly\r\nIF @CTHID IS NULL begin\r\n\t\tEXEC sp_api_toast 'Kan geen [ompakken2] vinden'\r\n\t\tRETURN;\r\n\t\tend\r\n--ELSE EXEC sp_api_toast @CTHID\r\n\r\nIF {[ompakken].status} not in ('openRepack') BEGIN\r\n\tEXEC sp_api_modal_alert 'Toevoegen alleen bij status: openRepack'\r\n\tEXEC sp_api_modal_clear\t\t\r\n\tRETURN;\t\r\n\tend\r\n\r\n-- 200629 Uitbreiding inkoop vanuit diverse contexten: Zoek CTH ; bijv als we afkomstig zijn van een regel, dan is CTH te vinden in de regel\r\n--if @parent_card_name ='verkoop'\tset @CTHID=@parent_id\r\n--if @parent_card_name = 'ctr2' set @CTHID=(select TransactionHeader_ID from xtransactiondetail where xtransactiondetail.id=@parent_id)\r\n\r\nDECLARE @mes nvarchar(200), @FustSaldo int, @CoreType nvarchar(10),@FustID int, @xDesc nvarchar(200)\r\nSELECT @xDesc=x.[Description],@mes= concat('Ompak in ' , x.[Description]) ,@Coretype= x.coretype,@FustID=x.Fust_ID from xstock x where x.id=@ID --@main_db.dbo.\r\n--EXEC sp_api_modal_text @mes,'h2 text-primary'\r\n------\r\nIF @coretype in('CRATE','PALLET')\r\n\tBEGIN\r\n\t\tSELECT @Fustsaldo=Fustsaldo from @main_db.dbo.FustSaldo_FC(@FustID,{[verkoop].Counterparty_ID})\r\n\t\tEXEC sp_api_toast @Fustsaldo\r\n\t\t-- breid DECLARE message uit met het fust-saldo\r\n\t\tIF @FustSaldo is not NULL\r\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') actueel saldo bij deze klant: ',@fustsaldo)\r\n\t\tELSE\r\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') => let op: deze klant heeft dit fust nooit eerder gehad!')\r\n\tEND\r\n\r\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\r\nDECLARE @aantal nvarchar(20),@opmerking nvarchar(50) --='100'\r\nDECLARE @CounterpartyID int\r\nDECLARE @FlowModel int\r\nDECLARE @THDT INT \r\nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=FlowModel_ID,@THDT=TDT From xTransactionHeader CTH where CTH.ID=@CTHID\r\n--200630 was@parent_id\r\n\r\n--200708 => ??? WAAROM GAAT DIT NIET ??? select @Prijs= @main_db.dbo.StockPrice(@ID,@CTHID,NULL,NULL,NULL,NULL,NULL,NULL,NULL)\r\n\r\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\r\nEXEC sp_api_modal_text 'Aantal'\r\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1\r\nEXEC sp_api_modal_text 'Opm. loods'\r\nEXEC sp_api_modal_input @name='opmerking',@value = @opmerking OUT\r\nDECLARE @button nvarchar(128)\r\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\r\nIF @button IS NOT NULL\r\n\tBEGIN\r\n\t\tIF \t\t--TRY_CAST(@prijs as decimal) > 0 AND \r\n\t\t\t\tTRY_CAST(@aantal as int) > 0 \r\n\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\r\n\t\t\tBEGIN\r\n\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=NULL,@Logistic=@Opmerking, @User=@User, @forcedTDT=2\r\n\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\r\n\t\t\t\texec sp_api_toast @mes\r\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\r\n\r\n\t\t\tEND\r\n\t\tELSE\r\n\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\r\n\tEND ",
            "action_id": 298,
            "action_name": "SelectAmountIN",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 299,
            "action_name": "Alles automatisch toewijzen",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @debug_identity_column nvarchar(128),@debug_table_name nvarchar(128),@debug_column_name nvarchar(128),@debug_record_id nvarchar(128),@debug_old_value nvarchar(max)\n\t,@sql nvarchar(max)\nSELECT @debug_table_name = table_name ,@debug_column_name = column_name ,@debug_record_id = record_id ,@debug_old_value = old_value\n\tFROM [__debug_trigger_trace] WHERE id = @id\nSELECT @debug_identity_column = name FROM @main_db.sys.columns WHERE object_id = (SELECT object_id FROM @main_db.sys.objects WHERE name = @debug_table_name) AND is_identity = 1\nIF TRY_CAST(@debug_record_id AS INT) > 0\n\tBEGIN\n\t\tEXEC sp_api_modal_text N'Direct Edit / Update record',N'h4 text-muted'\n\t\tEXEC sp_api_modal_input @name='Waarde',@value=@debug_old_value OUT,@focus=1,@select=1\n\t\tSET @sql = N'USE @main_db;\nUPDATE '+QUOTENAME(@debug_table_name)\n\t\t\t+ ' SET ' + QUOTENAME(@debug_column_name) + ' = ' +ISNULL(dbo.escape_string(@debug_old_value),'NULL')\n\t\t\t+ ' WHERE ' + QUOTENAME(@debug_identity_column) + ' = ' + @debug_record_id\n\t\tEXEC sp_api_modal_text @sql,N'code'\n\t\tDECLARE @button nvarchar(128)\n\t\tEXEC sp_api_modal_button @name='button',@value='Update',@valueout=@button OUT,@key='Enter'\n\t\tIF @button IS NOT NULL\n\t\t\tBEGIN\n\t\t\t\tEXEC(@sql)\n\t\t\t\tEXEC sp_api_modal_clear\n\t\t\tEND\n\tEND\nELSE\n\tEXEC sp_api_toast N'We need a proper ID as INT to update here'\n\t",
            "action_id": 300,
            "action_name": "Direct Edit",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "TRUNCATE TABLE @main_db.dbo.__debug_trigger_trace",
            "action_id": 301,
            "action_name": "Truncate",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @cursor_ids CURSOR,@cid INT, @tekst NVARCHAR(100),@sqltask nvarchar(max)\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tSET @TEKST=CONCAT(N'Toewijzen order ',@cid)\n\t\tEXEC sp_api_toast @TEKST\n\t\t/*\n\t\t------------------single action---------------------------------------------------\n\t\texec @main_db.dbo.SP_CURSED_MAPPER_CTH @CTH_ID =@cid ,@MAPINKOOP =1,@MAPVERKOOP =1\n\t\t--zet tevens landfreight op checked\n\t\texec @main_db.dbo.SP_CURS_SetChecked_CTH @cid\n\t\t--@onlySameDay =1 --210324 VGI alleen dezelfde dag..\n\t\t--@sameDayOrOlder = 1 --210324 VGI alleen dezelfde dag of eerder..\n\t\t----------------------------------------------------------------------------------\n\t\t*/\n\t\tSET @sqltask = CONCAT(N'\n\t\texec @main_db.dbo.SP_CURSED_MAPPER_CTH @CTH_ID =',@cid,' ,@MAPINKOOP =1,@MAPVERKOOP =1, @sameDayOrOlder =1\n\t\texec @main_db.dbo.SP_CURS_SetChecked_CTH ',@cid)\n\t\tEXEC sp_api_add_sql_task @sql=@sqltask,@description=@TEKST --N'Verstuur facturen'\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;\n\n--wis als laatste alle markeringen\nEXEC sp_api_modal_select_all_clear \n\n\n\n\n",
            "action_id": 302,
            "action_name": "Alles automatisch toewijzen",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast N'leveringsbevestiging....' \n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\t--dit is nu alleen voor tellers en checks, zodat we weten dat het report al is gemaakt:\n\t\t--was\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'CTH'\t,@Context_Key_ID=@cid,@Report_CODE=N'CONF_DELIVERY' -- zie runreport \n\t\t--nu\n\t\tEXEC SetDelConf @cid --210224 Registreer verzending van DeliveryConfirmation via xMarker\n\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select Counterparty_id from xtransactionheader where id=@cid)\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = 'deliveryconfirmation_out' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\n\n\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 304,
            "action_name": "leveringsbevestiging",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @cursor CURSOR,@idval INT\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @idval\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tDECLARE @remainder float,@registered_costs float,@new_costs float\n\t\tSELECT @remainder = rowPriceRemainder,@registered_costs = ISNULL(Costs,0) FROm view_lot_ctr WHERE id = @idval\n\t\tIF @remainder IS NOT NULL AND @remainder <> 0\n\t\t\tBEGIN\n\t\t\t\tSET @new_costs = @remainder + @registered_costs\n\t\t\t\tUPDATE view_lot_ctr SET Costs = @new_costs WHERE id = @idval\n\t\t\t\t--EXEC sp_api_modal_text @new_costs\n\t\t\t\tEXEC sp_api_modal_select_all_clear\n\t\t\tEND\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;",
            "action_id": 305,
            "action_name": "Neem Restant",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "WITH cte AS (SELECT rn = ROW_NUMBER() OVER (PARTITION BY name,lang,display,context ORDER BY id)\n\t,*\n\tFROM api_global_fields\n)\nDELETE FROM cte WHERE rn>1",
            "action_id": 306,
            "action_name": "Remove Duplicates",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @new_id int,@retour_cth_id int,@retour_ctr_id int,@inkoop_ctr_id int\nDECLARE @clonesettings nvarchar(max)\nDECLARE @ctr_id int = {[ctr2].id}\nDECLARE @cth_id nvarchar(max) = {[ctr2].cth_id}\nDECLARE @amount int = {[ctr2].Amount}\nDECLARE @Stock_ID int = {[ctr2].Stock_ID}\nDECLARE @Destination_ID int = {[ctr2].TransactionHeader_ID.Source_ID}\nDECLARE @Source_ID int = {[ctr2].TransactionHeader_ID.Destination_ID}\nSET @clonesettings = CONCAT(N'TDT=102,Source_ID=',@Source_ID,',Destination_ID=',@Destination_ID)\nEXEC @retour_cth_id = dbo.sp_clone_record N'xTransactionHeader',@cth_id,@clonesettings\n--EXEC sp_api_modal_text @Source_ID\nDECLARE @retour_amount int = 5\nSET @clonesettings = CONCAT('TDT=1,Amount=',@retour_amount,',TransactionHeader_ID=',@retour_cth_id)\nEXEC @retour_ctr_id = dbo.sp_clone_record N'xTransactionDetail',@ctr_id,@clonesettings\nSELECT TOP 1 @inkoop_ctr_id = VTD FROM xIVLINK WHERE ITD = @ctr_id\nINSERT xIVLINK (ITD,VTD,LinkAantal,Stock_ID) VALUES(@retour_ctr_id,@inkoop_ctr_id,@retour_amount * -1,@Stock_ID)\n\n--EXEC sp_api_modal_text @clonesettings\nDECLARE @search nvarchar(2000) = CONCAT('?id=',@retour_cth_id)\nEXEC sp_api_goto @path=N'/verkoop_retour',@search = @search\n",
            "action_id": 308,
            "action_name": "Retour",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 309,
            "action_name": "Schrijf Easy Costsettings",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @New_CTHIdentity int,@New_CTH1Identity int,@New_CTRIdentity int,@new_CTR1identity int\n,@Artikel_ID1 int\n,@Artikel_ID2 int\n,@Artikel_ID3 int\n, @Klant_ID int, @Artikel_ID int,@supplier_id INT;\n\n--kies 3 dingen\nSELECT TOP 1 @Artikel_ID1=id FROM @main_db.dbo.xStockWithDescriptionLike('') ORDER BY newid()\nSELECT TOP 1 @Artikel_ID2=id FROM @main_db.dbo.xStockWithDescriptionLike('') ORDER BY newid()\nSELECT TOP 1 @Artikel_ID3=id FROM @main_db.dbo.xStockWithDescriptionLike('') ORDER BY newid()\n\n--inkoop:\nSELECT TOP 1 @supplier_id = id FROM @main_db.dbo.suppliers() ORDER BY newid()\nEXEC @main_db.dbo.CreateCTH1 @supplier_id, @new_identity = @new_CTH1identity OUTPUT--, @advTransporterID=159988;\nEXEC @main_db.dbo.CreateCTR @new_CTH1identity, @Artikel_ID1,1,100,N'losse regel',1, @new_identity = @new_CTR1identity OUTPUT;\n\nSELECT TOP 1 @supplier_id = id FROM @main_db.dbo.suppliers() ORDER BY newid()\nEXEC @main_db.dbo.CreateCTH1 @supplier_id, @new_identity = @new_CTH1identity OUTPUT--, @advTransporterID=159988;\nEXEC @main_db.dbo.CreateCTR @new_CTH1identity, @Artikel_ID2,1,200,N'losse regel',2, @new_identity = @new_CTR1identity OUTPUT;\n\nSELECT TOP 1 @supplier_id = id FROM @main_db.dbo.suppliers() ORDER BY newid()\nEXEC @main_db.dbo.CreateCTH1 @supplier_id, @new_identity = @new_CTH1identity OUTPUT--, @advTransporterID=159988;\nEXEC @main_db.dbo.CreateCTR @new_CTH1identity, @Artikel_ID3,1,300,N'losse regel',3, @new_identity = @new_CTR1identity OUTPUT;\n\n\n\n--verkoop\nSELECT TOP 1 @klant_ID = id FROM @main_db.dbo.Debtors() ORDER BY newid()\nEXEC @main_db.dbo.CreateCTH2 @klant_ID, @new_identity = @new_CTHidentity OUTPUT--, @advTransporterID=159988;\n--select * from xTransactionHeader where id=@new_CTHidentity \n\n--02\n--voeg een regel toe op de net aangemaakte cth met id: @new_identity\nDECLARE @count int = 0\nWHILE @count < 30\n\tBEGIN\n\t\tEXEC @main_db.dbo.CreateCTR @new_CTHidentity, @Artikel_ID1,1,10,N'losse regel 1',2, @new_identity = @new_CTRidentity OUTPUT;\n\t\tEXEC @main_db.dbo.CreateCTR @new_CTHidentity, @Artikel_ID2,1,20,N'losse regel 2',4, @new_identity = @new_CTRidentity OUTPUT;\n\t\tEXEC @main_db.dbo.CreateCTR @new_CTHidentity, @Artikel_ID3,1,30,N'losse regel 3',6, @new_identity = @new_CTRidentity OUTPUT;\n\t\tSET @count=@count+1\n\tEND\nDECLARE @search nvarchar(2000) = CONCAT(N'?id=',@new_CTHidentity)\nEXEC sp_api_goto @path = @path,@search = @search\n--zoek createcth2\n--select * from xCompany where companyname like '%trans%' --159988\n--select top 2 * from Q_xtransactiondetail order by id desc\n--select top 2  * from Q_xtransactionheader order by id desc\n\n--select * from CTH_xCTRStatus(@new_CTHIdentity)\n--select * from CTH_xCTRStatus(3192) \n--select TOP 5 * from xIVLINK ORDER BY id DESC\n--zoek 'map%xIVLINK'\n--zoek 'update xCTRTotals%ctrstatus'\n--select * from tf_code_xTransactionDetail(0) where calcctrstatus=0 and ctrStatus <>0\n--IS DUS NIET INCOMPLEET !!!!!\n-- RH/GB/TODO: \n-- deze update zorgt dat de ctrstatus correct wordt weergegeven...\n--update xCTRTotals set ctrstatus=0 where ctr_ID in(select id from tf_code_xTransactionDetail(0) where calcctrstatus=0 and ctrStatus <>0) --> zet alle repareerbare ctrstatus op 0\n-- nog een keer\n--select * from CTH_xCTRStatus(@new_CTHIdentity)\n\n\n\n",
            "action_id": 310,
            "action_name": "Random in/verkoop",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 313,
            "action_name": "clone",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 316,
            "action_name": "clone",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_text N'This is a success!',N'h4 text-muted'--,@print=1\nEXEC sp_api_modal_text N'Stocklijst',N'h4 text-muted',@printonly=1\nEXEC sp_api_modal_text N'g wert wer sdfgw er gsdgs wer tserfg sgaer ',N'font-weight-bold text-muted',@printonly=1\n\nSELECT @card_id = id FROM api_card WHERE name='repaction'\nEXEC sp_api_modal_table @card_id = @card_id ,@print=1",
            "action_id": 324,
            "action_name": "Print table",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_text N'This is NOT printed!',N'h4 text-muted'\nEXEC sp_api_modal_text N'This is printed (and displayed)!',N'h4 text-muted',@print=1\nEXEC sp_api_modal_text N'This is ONLY printed!',N'h4 text-muted',@printonly=1\n\nEXEC sp_api_modal_print @escape = 1\n\nDECLARE @reducer nvarchar(max) = CONCAT('Invoice_ID = ',@id,' AND ShowOutput = ''Y''')\nSELECT @card_id = id FROM api_card WHERE name = 'invrow'\nEXEC sp_api_modal_table @card_id = @card_id ,@reducer = @reducer ,@print=1,@fontsize=N'50%'\n",
            "action_id": 326,
            "action_name": "Lokaal printen",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DELETE FROM api_sql_tasks WHERE sql LIKE 'EXEC @main_db.dbo.sp_debug_triggers %'\nEXEC @main_db.dbo.sp_debug_triggers 0\nEXEC sp_api_toast N'DEBUGGER UIT'",
            "action_id": 329,
            "action_name": "Debugger Uit",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_add_sql_task N'EXEC @main_db.dbo.sp_debug_triggers 1,1'\nEXEC sp_api_toast N'DEBUGGER WORDT AANGEZET DOOR TIMER'\nEXEC sp_api_add_sql_task N'EXEC @main_db.dbo.sp_debug_triggers 0',@seconds = 300\nEXEC sp_api_toast N'DEBUGGER STOP AUTOMATISCH NA 300 SECONDEN'",
            "action_id": 334,
            "action_name": "Debugger Aan",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_text N'Sleep',N'h4 text-muted'\nEXEC sp_api_modal_text N'Sleep for some seconds to test blocking transactions',N'm-4'\nDECLARE @button nvarchar(128)\nEXEC sp_api_modal_button @name='b1',@value = '00:00:05', @valueout = @button OUT,@key='F1'\nEXEC sp_api_modal_button @name='b1',@value = '00:00:10', @valueout = @button OUT,@key='F2'\nEXEC sp_api_modal_button @name='b1',@value = '00:00:15', @valueout = @button OUT,@key='F3'\nEXEC sp_api_modal_button @name='b1',@value = '00:00:20', @valueout = @button OUT,@key='F4'\nEXEC sp_api_modal_button @name='b1',@value = '00:00:25', @valueout = @button OUT,@key='F5'\nEXEC sp_api_modal_button @name='b1',@value = '00:00:30', @valueout = @button OUT,@key='F6'\nIF @button IS NOT NULL\n\tBEGIN\n\t\tWAITFOR DELAY @button\n\t\tSET @button = @button+' has passed'\n\t\tEXEC sp_api_modal_text @button,N'm-4'\n\tEND",
            "action_id": 338,
            "action_name": "Sleep",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--EXEC sp_api_toast @parent_parent_id\n--exec sp_api_toast @User\n\nDECLARE @Repack_ID INT = {[corrections].id}\nDECLARE @cth1_id INT\nDECLARE @cth2_id INT\n\nEXEC @main_db.dbo.GetCTHForRepack @Repack_ID = @Repack_ID, @cth1_id = @cth1_id OUT, @cth2_id = @cth2_id OUT\n\nIF {[corrections].status} not in ('open_correction') BEGIN\n\tEXEC sp_api_modal_alert 'Toevoegen alleen bij status: open_correction'\n\tEXEC sp_api_modal_clear\t\t\n\tRETURN\nEND\n\nDECLARE @mes nvarchar(200), @FustSaldo int, @CoreType nvarchar(10),@FustID int, @xDesc nvarchar(200)\n/*\nSELECT @xDesc=x.[Description],@mes= concat('Ompak in ' , x.[Description]) ,@Coretype= x.coretype,@FustID=x.Fust_ID from xstock x where x.id=@ID --@main_db.dbo.\n--EXEC sp_api_modal_text @mes,'h2 text-primary'\n------\nIF @coretype in('CRATE','PALLET')\n\tBEGIN\n\t\tSELECT @Fustsaldo=Fustsaldo from @main_db.dbo.FustSaldo_FC(@FustID,{[verkoop].Counterparty_ID})\n\t\tEXEC sp_api_toast @Fustsaldo\n\t\t-- breid DECLARE message uit met het fust-saldo\n\t\tIF @FustSaldo is not NULL\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') actueel saldo bij deze klant: ',@fustsaldo)\n\t\tELSE\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') => let op: deze klant heeft dit fust nooit eerder gehad!')\n\tEND\n*/\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\nDECLARE @aantal nvarchar(20),@opmerking nvarchar(40) --='100'\n\t,@stock int\n\nSELECT @xDesc=x.[Description],@mes= concat('Artikel: ' , x.[Description]),@stock=stock ,@Coretype= x.coretype,@FustID=x.Fust_ID from xstock x where x.id=@ID --@main_db.dbo.\nSET @aantal = @stock\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\nEXEC sp_api_modal_text 'Gecorrigeerde voorraad:'\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1,@select=1\nEXEC sp_api_modal_text 'Opm. loods'\nEXEC sp_api_modal_input @name='opmerking',@value = @opmerking OUT\nDECLARE @button nvarchar(128)\nEXEC sp_api_modal_button @name='button',@value = 'Opslaan',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\nIF @button = 'Opslaan'\n\tBEGIN\n\t\tSET @opmerking = CONCAT(@stock,'->',@aantal,' ',@opmerking)\n\t\tIF \tTRY_CAST(@aantal as int) >= 0 -- OR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\n\t\t\tBEGIN\n\t\t\t\tIF @aantal < @stock\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tSET @aantal = @stock - CAST(@aantal as int)\n\t\t\t\t\t\tEXEC @main_db.dbo.CreateCTR @CTH_ID=@cth2_id, @stock_ID=@ID,@Amount=@Aantal,@Price=NULL,@Logistic=@Opmerking, @User=@User,@Repack_ID = @Repack_ID\n\t\t\t\t\tEND\n\t\t\t\tIF @aantal > @stock\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tSET @aantal = CAST(@aantal as int) - @stock\n\t\t\t\t\t\tEXEC @main_db.dbo.CreateCTR @CTH_ID=@cth1_id, @stock_ID=@ID,@Amount=@Aantal,@Price=NULL,@Logistic=@Opmerking, @User=@User,@Repack_ID = @Repack_ID\n\t\t\t\t\tEND\n--\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\n--\t\t\t\texec sp_api_toast @mes\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\n\t\t\tEND\n\t\tELSE\n\t\t\tEXEC sp_api_modal_text 'Aantal niet geldig!','text-danger'\n\tEND \n/*IF @button = 'OUT'\n\tBEGIN\n\t\tIF \t\t--TRY_CAST(@prijs as decimal) > 0 AND \n\t\t\t\tTRY_CAST(@aantal as int) > 0 \n\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\n\t\t\tBEGIN\n\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@cth2_id, @stock_ID=@ID,@Amount=@Aantal,@Price=NULL,@Logistic=@Opmerking, @User=@User,@Repack_ID = @Repack_ID --, @forcedTDT=1\n\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\n\t\t\t\texec sp_api_toast @mes\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\n\t\t\tEND\n\t\tELSE\n\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\tEND\n*/",
            "action_id": 356,
            "action_name": "SelectStockCount",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @CTH1 int, @CTH2 int\nset @cth1=(select top 1 id from xtransactionheader where Repack_ID=@ID AND TDT=1)\nexecute @main_db.dbo.DeleteCTR_for_CTH @CTH1\nexecute @main_db.dbo.deleteCTH @CTH1\n\nset @cth2=(select top 1 id from xtransactionheader where Repack_ID=@ID AND TDT=2 )--and status =N'OPEN')\nexecute @main_db.dbo.DeleteCTR_for_CTH @CTH2\nexecute @main_db.dbo.deleteCTH @CTH2\n\ndelete from xRepack where ID=@ID",
            "action_id": 361,
            "action_name": "sys_delete",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "-- ==============================================================================================\n-- LET OP! Deze action alleen wijzigen in xrepack en universeel houden voor xrepack & corrections\n-- ==============================================================================================\n\n\n\n\n\n\n\nDECLARE @company_id nvarchar(32),@button nvarchar(128),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000)\n, @location_id nvarchar(32), @reducer nvarchar(max), @date nvarchar(128)\n,@button1 nvarchar(128)\n,@button2 nvarchar(128)\n,@open_status nvarchar(128)\n--set @date = dbo.workDate()\n\n-- onderste twee regels aangezet omdat anaco ompakken op andere locaties laat doen.\nEXEC sp_api_modal_select @card_name = N'packer',@value = @company_id OUT,@focus = 1\nSET @reducer = CONCAT('company_id = ',@company_id)\n\n/* --Uitgezet Anaco laat ompakken op andere locaties doen.\nIF @card_name = 'xrepack' SET @company_id = 159778\n*/\nIF @card_name = 'corrections' SET @company_id = 159786\nIF @company_id > 0\nBEGIN\n\tIF @card_name = 'xrepack' SET @button1 = N'Nieuwe ompakken'\n\tIF @card_name = 'xrepack' SET @button2 = N'Laatste open ompakken'\n\tIF @card_name = 'xrepack' SET @open_status = N'open_repack'\n\tIF @card_name = 'corrections' SET @button1 = N'Nieuwe correctie starten'\n\tIF @card_name = 'corrections' SET @button2 = N'Laatste open correctie'\n\tIF @card_name = 'corrections' SET @open_status = N'open_correction'\n\n\n\n\tDECLARE @reducer_location nvarchar(max) = N'id IN (SELECT Location_ID FROM xCompanyxLocation WHERE Company_ID =' + @company_id + ')'\n\tIF (SELECT LOCATIONS = count(Location_ID) FROM xCompanyxLocation WHERE Company_ID = @company_id) > 1 OR (SELECT LOCATIONS = count(id) FROM xLocation WHERE Company_ID = @company_id) > 1\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_text 'Kies een ompak locatie:','text-primary'\n\t\t\tEXEC sp_api_modal_select @card_name = N'xlocation',@value = @location_id OUT,@focus=1,@reducer = @reducer_location\n\t\t\t\tIF @location_id > 0\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3',@focus=1\n\t\t\t\t\tEND\n\t\tEND\n\tIF (SELECT LOCATIONS = count(Location_ID) FROM xCompanyxLocation WHERE Company_ID = @company_id) = 1 OR (SELECT LOCATIONS = count(id) FROM xLocation WHERE Company_ID = @company_id) = 1\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3',@focus=1\n\t\tEND\n\n\t--DECLARE @only_new_is_possible BIT = 0\n\t--EXEC sp_api_modal_select @card_name = N'xlocation',@reducer = @reducer,@value = @location_id OUT,@class='mt-3',@focus = 1\n\t--IF @location_id > 0\n\t--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3'\n\n\tEXEC sp_api_modal_text 'Kies een optie:','text-primary font-weight-bold display-4 text-center'\n\tEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Insert'\n\t\tIF EXISTS (SELECT * FROM xRepack WHERE status=@open_status AND PackDate = @date AND Company_ID = @company_id)\n\t\t\tEXEC sp_api_modal_button @name='button',@value=@button2,@valueout = @button OUT,@key='F1'\n/*\t\t\nELSE\n\t\tIF (select COUNT(id) from xlocation where company_id = @company_id ) = 1 \n\t\t\tBEGIN\n\t\t\t\tSET @only_new_is_possible = 1\n\t\t\tEND\n*/\n\tIF @button = @button1 --OR @only_new_is_possible = 1\n\t\tBEGIN\n\t\tDELETE FROM api_storage WHERE card_id = (SELECT id FROM api_card WHERE name = N'xrepack') AND child_id = 0 AND user_id = @user_id\n\t\tEXEC sp_api_modal_clear\n\t\t\tEXEC sp_api_modal_post N'xrepack',N'Company_ID',@company_id,0\n\t\t\t--EXEC sp_api_modal_post N'xrepack',N'Destination_ID',@location_id,0\n\t\t\tEXEC sp_api_modal_post N'xrepack',N'PackDate',@date,0\n\t\t\tEXEC sp_api_modal_post N'xrepack',N'Status',@open_status,0\n\t\t\t--EXEC sp_api_modal_post N'xrepack',N'advTransportDep',@date,0\n\t\t\tEXEC @new_id = sp_api_modal_save N'xrepack',0\n\t\t\tIF @new_id > 0\n\t\t\t\tBEGIN\n\t\t\t\t\tSET @goto = N'/xrepack/'+@new_id+'/xstock_ctr_ompak'\n\t\t\t\t\tEXEC sp_api_toast N'Nieuwe gestart',N'alert-primary'\n\t\t\t\t\tSET @search = N'?id='+@new_id\n\t\t\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/xrepack',@referer_search=@search\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tEXEC sp_api_toast N'Error nieuw',N'alert-danger'\n\t\t\tEXEC sp_api_modal_clear\n\t\tEND\n\tIF @button = @button2\n\t\tBEGIN\n\t\t\tSET @new_id = (SELECT TOP 1 id FROM xRepack WHERE status=@open_status AND PackDate = @date AND Company_ID = @company_id ORDER BY id DESC)\n\t\t\tSET @goto = N'/xrepack/'+@new_id+'/xstock_ctr_ompak'\n\t\t\tSET @search = N'?id='+@new_id\n\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/xrepack',@referer_search=@search\n\t\tEND\nEND",
            "action_id": 405,
            "action_name": "Insert Order",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@date2 nvarchar(128),@button nvarchar(128)\nset @date = dbo.workDate()\nset @date2 = dbo.workDate()\n/*EXEC sp_api_modal_text 'Zoek op transport bedrijf'\nEXEC sp_api_modal_input @name='Transporteur',@value = @TransComp OUT,@focus=1,@select=1 -- zoek veld\n*/\nEXEC sp_api_modal_text 'Van:'\nEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-24',@focus=1,@select=1  -- zoek veld\nEXEC sp_api_modal_text 'Tot en met:'\nEXEC sp_api_modal_date @name='Date2',@value = @date2 OUT,@class='w-24' -- zoek veld\n--SET @date2 = CONCAT(@date2,' 23:59:59.999')\nSET @button = 'OpenOmpakLijst'\nEXEC sp_api_modal_button @name='button',@value = 'OpenOmpakLijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\n--EXEC sp_api_modal_button @name='button',@value = 'GeslotenOmpakLijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F2'\nEXEC sp_api_modal_print @keycode = 'F9'\n\nIF @button =  'OpenOmpakLijst'\nBEGIN\nSELECT [IN/UIT], AMOUNT, [DETAIL~col-sm-3] = DETAIL, KGN, KGB, Size, ContentDesc, BrandName, FustCode, LVO, logistic,[TID*]--,[cthkgninCAP*],[cthkgnin*],[seperate*],[cthkgnout CAP*],[cthkgnout*]--,Status,THTDT\nINTO #OpenOmpakLijst\nFROM          RV_OMPAKBON\nWHERE\t\t(Status = 'open_repack') AND (TransactionDate BETWEEN @date AND @date2) AND [delayed] = 0 -- (Status = 'open_repack')\nEXEC sp_api_modal_table @tmptable=N'#OpenOmpakLijst',@orderby=N'ORDER BY [TID*],3 ASC',@print=1\nEND \n/*\nIF @button =  'GeslotenOmpakLijst'\nBEGIN\nSELECT [IN/UIT], AMOUNT, [DETAIL~col-sm-3] = DETAIL, KGN, KGB, Size, ContentDesc, BrandName, FustCode, LVO, logistic,[TID*],[cthkgninCAP*],[cthkgnin*],[seperate*],[cthkgnout CAP*],[cthkgnout*]--,Status,THTDT\nINTO #GeslotenOmpakLijst\nFROM          RV_OMPAKBON\nWHERE\t\t(Status = 'open_repack') AND (TransactionDate BETWEEN @date AND @date2)\nEXEC sp_api_modal_table @tmptable=N'#GeslotenOmpakLijst',@orderby=N'ORDER BY [TID*],[cthkgninCAP*],[cthkgnin*],[seperate*],[cthkgnout CAP*],[cthkgnout*],3 ASC',@print=1\nEND \n*/",
            "action_id": 406,
            "action_name": "OMPAKBON",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @new_identity INT;\ndeclare @OmpakCompany_ID int={[xrepack].Company_ID}\nDECLARE @newCTH1 int, @newCTH2 int\n\nSELECT @newCTH1 = id FROM xTransactionHeader WHERE Repack_ID = @id AND TDT = 1\n\nIF @newCTH1 IS NULL\n\tBEGIN\n\t\texecute @main_db.dbo.CreateCTH1\n\t\t@Supplier_ID =@OmpakCompany_ID\n\t\t\t,@new_identity = @newCTH1 OUTPUT\n\t\t--\t,@FlowModel_ID int=2 -- (default=2) 200311 erbij ivm directe verkoop-inkoop koppeling, waarbij tijdens de verkoop-regel een inkoop kop kan worden aangemaakt\n\t\t--\t,@SourceID int = NULL\n\t\t--\t,@DestinationID int = NULL\n\t\t--\t,@deliverycodeID int = NULL\n\t\t\t,@Status =N'system_repack_open'--200924\n\t\t\t,@Repack_ID=@ID\n\tEND\nSELECT @newCTH2 = id FROM xTransactionHeader WHERE Repack_ID = @id AND TDT = 2\nIF @newCTH2 IS NULL\n\tBEGIN\n\t\texecute @main_db.dbo.CreateCTH2\n\t\t\t@Client_ID = @OmpakCompany_ID\n\t\t\t,@new_identity  = @newCTH2 OUTPUT\n\t\t--\t,@advTransporterID int = NULL --erbij 191107\n\t\t--\t,@deliverycodeID int = NULL\n\t\t\t,@Repack_ID=@ID\n\tEND\n\n\n",
            "action_id": 409,
            "action_name": "CTH1-2",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @CTH1 int, @CTH2 int\nset @cth1=(select top 1 id from xtransactionheader where Repack_ID=@ID AND TDT=1)\nexecute @main_db.dbo.DeleteCTR_for_CTH @CTH1\nexecute @main_db.dbo.deleteCTH @CTH1\n\nset @cth2=(select top 1 id from xtransactionheader where Repack_ID=@ID AND TDT=2 )--and status =N'OPEN')\nexecute @main_db.dbo.DeleteCTR_for_CTH @CTH2\nexecute @main_db.dbo.deleteCTH @CTH2\n\ndelete from xRepack where ID=@ID",
            "action_id": 413,
            "action_name": "sys_delete",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @company_id nvarchar(32),@button nvarchar(128),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000)\n, @location_id nvarchar(32), @reducer nvarchar(max), @date nvarchar(128)\n,@button1 nvarchar(128)\n,@button2 nvarchar(128)\n,@open_status nvarchar(128)\n\nset @date = dbo.workDate()\nSET @company_id = @main_db.dbo.GetTenantSetting(N'CorrectionCompany')\nIF @company_id IS NULL\n\tBEGIN\n\t\tEXEC sp_api_modal_alert N'No tenant CorrectionCompany defined'\n\t\tEXEC sp_api_modal_clear\n\t\tRETURN\n\tEND\n\nSET @button1 = N'Nieuwe correctie'\nSET @button2 = N'Laatste correctie'\nSET @open_status = N'open_correction'\n\nEXEC sp_api_modal_text 'Kies een optie:','text-muted h4'\nEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Insert'\n\tIF EXISTS (SELECT * FROM xRepack WHERE status=@open_status AND PackDate = @date AND Company_ID = @company_id)\n\t\tEXEC sp_api_modal_button @name='button',@value=@button2,@valueout = @button OUT,@key='F2'\n\n\n\nIF @button = @button1\n\tBEGIN\n\tDELETE FROM api_storage WHERE card_id = (SELECT id FROM api_card WHERE name = N'corrections') AND child_id = 0 AND user_id = @user_id\n\tEXEC sp_api_modal_clear\n\tEXEC sp_api_modal_post N'corrections',N'Company_ID',@company_id,0\n\tEXEC sp_api_modal_post N'corrections',N'PackDate',@date,0\n\tEXEC sp_api_modal_post N'corrections',N'Status',@open_status,0\n\tEXEC @new_id = sp_api_modal_save N'corrections',0\n\tIF @new_id > 0\n\t\tBEGIN\n\t\t\tSET @goto = N'/corrections/'+@new_id+'/xstock_corrections'\n\t\t\tEXEC sp_api_toast N'Nieuwe correctie gestart',N'alert-primary'\n\t\t\tSET @search = N'?id='+@new_id\n\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/corrections',@referer_search=@search\n\t\tEND\n\tELSE\n\t\tEXEC sp_api_toast N'Error nieuwe correctie',N'alert-danger'\n\tEXEC sp_api_modal_clear\nEND\nIF @button = @button2\n\tBEGIN\n\t\tSET @new_id = (SELECT TOP 1 id FROM xRepack WHERE status=@open_status AND PackDate = @date AND Company_ID = @company_id ORDER BY id DESC)\n\t\tSET @goto = N'/corrections/'+@new_id+'/xstock_corrections'\n\t\tSET @search = N'?id='+@new_id\n\t\tEXEC sp_api_goto @goto,@referer_path=N'/corrections',@referer_search=@search\n\tEND\n",
            "action_id": 415,
            "action_name": "Insert Corrections",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC @main_db.dbo._coding_examples",
            "action_id": 419,
            "action_name": "Coding Examples",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @CTX nvarchar(50)=N'xStock'\nDECLARE @MarkID int = (SELECT ID FROM @main_db.dbo.xMarker WHERE Context = @ctx AND FKID=@ID)\n   IF @MARKID IS NULL\n\t   BEGIN\n\t\t\tINSERT INTO @main_db.dbo.xMarker (Context,FKID)\n\t\t\tVALUES (@ctx,@ID)\n\t   END\n   IF @MARKID IS NOT NULL\n\t   BEGIN\n\t\t\tDELETE FROM @main_db.dbo.xMarker WHERE id=@markid\n\t   END\t\n\n",
            "action_id": 425,
            "action_name": "markeer",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "if ({[inkoop].ivtotal})<>0 \n\tbegin\n\t\texec sp_api_toast N'Er is al verkocht, kan Loslokatie niet wijzigen '\n\t\treturn\n\tend\n\ndeclare @LocID nvarchar(200)\nEXEC sp_api_modal_select @card_name=N'xlocation',@value = @locID OUT,@focus=1,@placeholder=N'Kies de verwachte loslokatie'\nif @locID is not NULL\n\tbegin\n\t\tupdate xTransactionHeader set Destination_ID = @LocID\twhere id=@ID\n\t\tupdate xLandfreight set xlandfreight.To_Location_ID = @LocID where xLandfreight.TransactionHeader_ID =@ID\n\t\texec sp_api_modal_clear;\n\tend",
            "action_id": 426,
            "action_name": "Wijzig Loslokatie",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @NewID INT, @Endtxt nvarchar(200)\nexec @newID=@main_db.dbo.Create_CTR_ForOwnNegativeStock_CTH @CTH_ID=@ID\nif @newID is not NULL\n\tbegin\n\t\tset @EndTxt= N''+str(@newID)+N' regels toegevoegd aan de inkoop.'\n\t\texec sp_api_toast @text=@endtxt\n\tend",
            "action_id": 428,
            "action_name": "auto-inkoop-neg-stock",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_goto @path='/xbol'\n",
            "action_id": 429,
            "action_name": "B/L",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_goto @path='xcustomsoffice'",
            "action_id": 430,
            "action_name": "CustomsOffice",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.sp_end_sum_cth @ID",
            "action_id": 431,
            "action_name": "EndSumCTH",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.[dbo].[Create_CTR_ForOwnNegativeStock] @ID",
            "action_id": 433,
            "action_name": "Koop alles (neg)",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @currState nvarchar(50)\nSET @currstate = (SELECT status FROM xtransactionheader cth WHERE id=@ID)\nIF @currState='openPurchase'\n\tBEGIN\n\t\tupdate xtransactionheader SET status='closedPurchase' WHERE ID=@ID\n\tEND\nIF @currState='closedPurchase'\n\tBEGIN\n\t\tupdate xtransactionheader SET status='openPurchase' WHERE ID=@ID\n\tEND\n",
            "action_id": 435,
            "action_name": "sluit inkoop",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--EXEC @main_db.dbo.DeleteCTH @CTHID=@ID\nDECLARE @cursor_ids CURSOR,@cid INT\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\tEXEC @main_db.dbo.DeleteCTH @CTHID=@cID -- delete enkel id\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 437,
            "action_name": "Verwijder Order",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 438,
            "action_name": "Vessel",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--voeg evt de standaard companycostsettings toe:\ndeclare @CheckTo int={[factuurcontrole_inkoop].counterparty_id}\nEXEC @main_db.dbo.SP_CopyCostSettings @FromCompany= NULL, @ToCompany = @CheckTo\n----------------------------------------------------------------------------------\n\n\n\n--DECLARE @date nvarchar(128) = dbo.workDate()\nDECLARE @F1Text nvarchar(50) ='Financiele samenvatting van de inkoop'\nDECLARE @F1button nvarchar(128)= @F1Text\nDeclare @infotext nvarchar(512) = concat('Samenvatting van inkoop: ',@ids) --{[factuurcontrole_inkoop].id}\nEXEC sp_api_modal_text @text=@infotext,@class = 'h4 text-muted'\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n\nEXEC sp_api_modal_button @name='button',@value = 'Overzicht',@valueout = @F1button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print\n\nIF @F1button =  @F1Text\nBEGIN\n\tSELECT *\n\tINTO #ColliVerkocht\n\tfrom Calc_Finrows_Summed_CTH where cth_id IN({@ids}) -- dit wordt ala curly replaced met een lijst van ids\n\t\tEXEC sp_api_modal_table @tmptable=N'#ColliVerkocht',@print=1\nEND \n",
            "action_id": 448,
            "action_name": "Fin. Samenvatting Inkoop",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "/*\nIF NOT (dbo.hasClaims('sub=sylvester@vgibv.nl,sub=joke@vgibv.nl') > 0 OR dbo.hasRole('admin') > 0)  --todo niet zo uiteindelijk...maar role!!\n\tBEGIN\n\t\tEXEC sp_api_modal_text N'U mag dit niet doen!','h2 text-danger font-weight-bold text-center'\n\t\tRETURN\n\tEND\n*/\t\nIF (SELECT COUNT(DISTINCT Counterparty_ID) FROM xTransactionHeader WHERE id IN({@ids})) > 1\n\tBEGIN\n\t\tEXEC sp_api_modal_text N'Meerdere leveranciers geselecteerd'\n\t\tRETURN\n\tEND\nSET @text = (SELECT [xCompany].[CompanyName] FROM [xCompany] WHERE [id] = (SELECT TOP 1 [Q_xTransactionHeader].[CounterParty_ID] FROM [Q_xTransactionHeader] WHERE [id] IN ({@ids})))\nSET @text = N'Boeken op ' + @text + ' voor inkooporders: {@ids}'\nIF @ids <> @id EXEC sp_api_modal_text @text,N'h4 text-muted'\nSELECT id, Factuurnummer,paraaf, Opmerking,[cth_id ]=cth_id--, [Username ] = Username --,Aantal = CAST(NULL as decimal(18,4)) \n\tINTO #modalupdate FROM xCTH_Check where CTH_ID IN ({@ids}) AND (trim(isnull(Factuurnummer,N'')) > N'' OR trim(isnull(Paraaf,N'')) > N'' OR trim(isnull(Opmerking,N'')) > N'') --ORDER BY 2\n\t--zet een leeg nieuw record er bij\n--OUD:\tINSERT #modalupdate (Factuurnummer, Opmerking, cth_id as [cth_id ], [username ]) values(NULL,NULL,@ID,@User) --DEFAULT VALUES --maak evt. een nieuw record\nEXEC sp_api_modal_table_update @tmptable = N'#modalupdate',@addnew=1\n\n-- hier heb je bijgewerkte data\nDECLARE @button1 nvarchar(128),@button_text1 nvarchar(128) = 'Opslaan'\nEXEC sp_api_modal_button @name='button1',@value = @button_text1, @valueout = @button1 OUT ,@class='btn-danger',@key='Enter'\n--DECLARE @code nvarchar(100)= (SELECT TOP 1 code from #modalupdate ORDER BY code DESC )\n--EXEC sp_api_modal_text @code\nIF @button1 IS NULL RETURN\n--test:EXEC sp_api_modal_text N'Result:',N'h4 text-muted'\n--EXEC sp_api_modal_table @tmptable = N'#modalupdate'\n--RETURN\n--cursortje\nDECLARE @Factuurnummer nvarchar(128)\n\t\t,@Paraaf nvarchar(10)--210122\n\t\t,@Opmerking nvarchar(128)\n\t\t,@checkid int\n\t\t--,@RealID int\n\t\t,@isNew int\n\tDECLARE @cursor_xCTH_Check CURSOR\n\tSET @cursor_xCTH_Check = CURSOR LOCAL FAST_FORWARD FOR\nSELECT Factuurnummer,paraaf, Opmerking, id,isNew FROM #modalupdate \n\tOPEN @cursor_xCTH_Check;\n\tFETCH NEXT FROM @cursor_xCTH_Check INTO\n\t\t@Factuurnummer\n\t\t,@Paraaf\n\t\t,@Opmerking\n\t\t,@checkid\n\t\t,@isNew\n\tWHILE @@FETCH_STATUS = 0\n\t\tBEGIN\n\t\t\tif 1=1 -- RH210111 geen conditie meer, ivm leeg kunnen maken van een nummer!\n\t\t\t\tBEGIN\n\t\t\t\t\t--select @Realid=id from xcth_check where id=@checkid and cth_id=@ID\n\t\t\t\t\tif @isNew = 1\n\t\t\t\t\t\t--ADD\n\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\tDECLARE @cursor CURSOR,@idval INT\n\t\t\t\t\t\t\tSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\n\t\t\t\t\t\t\tOPEN @cursor;\n\t\t\t\t\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\t\t\t\t\tWHILE @@FETCH_STATUS = 0\n\t\t\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\t\t    insert into xcth_check (Factuurnummer, Paraaf,Opmerking,cth_id,username) values (@Factuurnummer,@Paraaf,@Opmerking,@idval,@User)\n\t\t\t\t\t\t\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\t\t\t\t\t\tEND\n\t\t\t\t\t\t\tCLOSE @cursor;\n\t\t\t\t\t\t\tDEALLOCATE @cursor;\n\t\t\t\t\t\tend\n\t\t\t\t\tif @isNew = 0\n\t\t\t\t\t\t--UPDATE\n\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\tupdate xcth_check\n\t\t\t\t\t\t\t\tset Factuurnummer=@Factuurnummer\n\t\t\t\t\t\t\t\t\t,Paraaf=@Paraaf\n\t\t\t\t\t\t\t\t\t,Opmerking=@Opmerking\n\t\t\t\t\t\t\t\twhere id=@checkid\n--\t\t\t\t\t\t\t\tset @RealID = NULL --moet niet nodig zijn..\n\t\t\t\t\t\tend\n\t\t\t\tEND\t\t\t\t\t\n\t\t\t\t\t\t\t\n\t\t\tFETCH NEXT FROM @cursor_xCTH_Check INTO\n\t\t\t\t@Factuurnummer\n\t\t\t\t,@Paraaf\n\t\t\t\t,@Opmerking\n\t\t\t\t,@checkid\n\t\t\t\t,@isNew\n\t\tEND\n\tCLOSE @cursor_xCTH_Check;\n\tDEALLOCATE @cursor_xCTH_Check;\n\t\n\t--210111 VERWIJDER RECORDS WAAR GEEN FACTUURNUMMER OF OPMERKING STAAT !\n\tdelete from xcth_Check where  cth_id IN ({@ids}) AND trim(isnull(Factuurnummer,N''))=N'' AND  trim(isnull(Paraaf,N''))=N''  AND  trim(isnull(Opmerking,N''))=N''\n\t--return\n\tif @Button1 is NOT NULL\n\t\tEXEC sp_api_modal_clear\n\n",
            "action_id": 465,
            "action_name": "BOEK",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "/*\nDECLARE @button23 nvarchar(max) ,@buttongeert nvarchar(max) \n--EXEC sp_api_modal_button @name='buttongeert',@value = 'hidden', @valueout = @buttongeert OUT\nEXEC sp_api_modal_text @button23\nIF @buttongeert IS NOT NULL EXEC sp_api_modal_text N'werewrtwetwertwertwe'\n\n\nEXEC sp_api_modal_button @name='@buttongeert',@value = 'hidden', @valueout = @buttongeert OUT\n\n\n\nEXEC sp_api_modal_choose @list = N'a,b,c, dirk,pieter,derkje',@value = @button23 OUT,@startkey=5 --,@keyprefix=N'Alt+'\n\nEXEC sp_api_modal_button @name='buttongeert',@value = 'Tralalala', @valueout = @buttongeert OUT ,@class='btn-danger',@key='Enter'\n\n\nEXEC sp_api_modal_text @button23\n--RETURN\n*/\n\nSELECT TOP 5 id, Code, CompanyName,invoiceEmail,Aantal = CAST(NULL as decimal(18,4)) INTO #modalupdate FROM xCompany ORDER BY 2\n--INSERT #modalupdate DEFAULT VALUES --maak evt. een nieuw record\nEXEC sp_api_modal_table_update @tmptable = N'#modalupdate',@addnew=2\n\n-- hier heb je bijgewerkte data\nDECLARE @button1 nvarchar(128),@button_text1 nvarchar(128) = 'Opslaan'\nEXEC sp_api_modal_button @name='button1',@value = @button_text1, @valueout = @button1 OUT ,@class='btn-danger',@key='Enter'\nDECLARE @code nvarchar(100)= (SELECT TOP 1 code from #modalupdate ORDER BY code DESC )\nEXEC sp_api_modal_text @code\nEXEC sp_api_modal_text N'Result:',N'h4 text-muted'\nEXEC sp_api_modal_table @tmptable = N'#modalupdate'\nRETURN\n--cursortje\nDECLARE @compid int\n\t\t,@cCode nvarchar(12)\n\t\t,@cCompanyName nvarchar(50)\n\t\tDECLARE @cursor_xCompany CURSOR\n\tSET @cursor_xCompany = CURSOR LOCAL FAST_FORWARD FOR\nselect id, Code, CompanyName from #modalupdate\n\tOPEN @cursor_xCompany;\n\tFETCH NEXT FROM @cursor_xCompany INTO\n\t\t@compid\n\t\t,@cCode\n\t\t,@cCompanyName\n\t\t\n\tWHILE @@FETCH_STATUS = 0\n\t\tBEGIN\n\t\t\t\n\t\t\tupdate xCompany set code=@cCode, CompanyName=@cCompanyname where id=@compid\n\t\t\t\n\t\t\tFETCH NEXT FROM @cursor_xCompany INTO\n\t\t\t\t@compid\n\t\t\t\t,@cCode\n\t\t\t\t,@cCompanyName\n\t\t\t\n\t\tEND\n\tCLOSE @cursor_xCompany;\n\tDEALLOCATE @cursor_xCompany;\n\n\n",
            "action_id": 473,
            "action_name": "table_update",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @pathname nvarchar(2000) = CONCAT('/klant/',{[verkoop].Counterparty_ID},'/company_locations')\nEXEC sp_api_goto @pathname",
            "action_id": 484,
            "action_name": "Naar Werklocaties",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @company_id nvarchar(32),@Countercompany nvarchar(32),@button nvarchar(128),@button2 nvarchar(128),@new_id nvarchar(32)\n,@goto nvarchar(2000),@search nvarchar(2000), @location_id nvarchar(32), @reducer nvarchar(max), @date nvarchar(128)\n,@LFCTR_Amount nvarchar(128),@Amount nvarchar(128), @Transportinfo nvarchar(32)\n,@button1 nvarchar(128) --= N'Set Pallets'\n--\tEXEC sp_api_modal_modal @class=N'w-100'\n\n\nSELECT \n\tid\n\t,[CTR_ID] = [CTR_ID]\n\t,[Bedrijf ] = (SELECT CONCAT([xCompany].[Code],'-',CompanyName) FROM [xCompany] WHERE [id] = (SELECT [xlandfreight].[Counterparty_ID] from [xLandfreight] where id = [XLFCTR].[LF_ID]))\n\t,[LFCTR_Amount] = [LFCTR_Amount]\n\t,[Amount] = (SELECT [Q_xTransactionDetail].[Amount] FROM [Q_xTransactionDetail] where [id] = (select [xLFCTR].[CTR_ID]))\n\tINTO #modalupdate\nFROM xLFCTR WHERE id = @id\nEXEC sp_api_modal_table_update @tmptable = N'#modalupdate',@focusx = 1,@focusy = 1\n\nDECLARE @button_text1 nvarchar(128) = 'Opslaan'\nEXEC sp_api_modal_button @name='button1',@value = @button_text1, @valueout = @button1 OUT ,@class='btn-primary',@key='Enter'\nIF @button1 IS NOT NULL\n\tBEGIN\n\n\t\tDECLARE @lfctrid int\n\t\tDECLARE @CTR_ID int\n\t\tDECLARE @cursor_xLFCTR CURSOR\n\t\tSET @cursor_xLFCTR = CURSOR LOCAL FAST_FORWARD FOR SELECT id, CTR_ID, LFCTR_Amount, Amount FROM #modalupdate\n\t\tOPEN @cursor_xLFCTR;\n\t\tFETCH NEXT FROM @cursor_xLFCTR INTO @lfctrid,@CTR_ID,@LFCTR_Amount,@Amount\n\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_post 'xlfctr','LFCTR_Amount',@LFCTR_Amount,@lfctrid\n\t\t\t\tEXEC sp_api_modal_post 'ctr2','Amount',@Amount,@CTR_ID\n\t\t\t\tEXEC sp_api_modal_save 'xlfctr',@lfctrid\n\t\t\t\tEXEC sp_api_modal_save 'ctr2',@CTR_ID\n\t\t\t\tFETCH NEXT FROM @cursor_xLFCTR INTO @lfctrid,@CTR_ID,@LFCTR_Amount,@Amount\n\t\t\tEND\n\t\tCLOSE @cursor_xLFCTR;\n\t\tDEALLOCATE @cursor_xLFCTR;\n\t\tEXEC sp_api_modal_clear\n\tEND\nRETURN\n/*\nSELECT TOP 1 @Euro = Euro, @Blok = Blok FROM xLandfreight WHERE Transactionheader_ID = @id\n\n\tEXEC sp_api_modal_text 'Aantal Blok:','text-primary font-weight-bold h4' --display-4 text-center\n\tEXEC sp_api_modal_input @name='Blok',@value = @Blok OUT,@class='w-25 mt-3'\n\tEXEC sp_api_modal_text 'Aantal Euro:','text-primary font-weight-bold h4' --display-4 text-center\n\tEXEC sp_api_modal_input @name='Euro',@value = @Euro OUT,@class='w-25 mt-3'\n\tEXEC sp_api_modal_text 'Kies een optie:','text-primary font-weight-bold h4' --display-4 text-center\n\tEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Enter'\n\nIF @button = @button1\n\tBEGIN\n\t\tDECLARE @lfid int\n\t\t\tDECLARE @cursor_xLandfreight CURSOR\n\t\t\tSET @cursor_xLandfreight = CURSOR LOCAL FAST_FORWARD FOR SELECT id FROM xLandfreight WHERE Transactionheader_ID = @id\n\t\t\tOPEN @cursor_xLandfreight;\n\t\t\tFETCH NEXT FROM @cursor_xLandfreight INTO @lfid\n\t\t\tWHILE @@FETCH_STATUS = 0\n\t\t\t\tBEGIN\n\t\t\t\t\tEXEC sp_api_modal_post 'xlandfreight','Blok',@Blok,@lfid\n\t\t\t\t\tEXEC sp_api_modal_post 'xlandfreight','Euro',@Euro,@lfid\n\t\t\t\t\tEXEC sp_api_modal_save 'xlandfreight',@lfid\n\t\t\t\t\tFETCH NEXT FROM @cursor_xLandfreight INTO @lfid\n\t\t\t\tEND\n\t\t\tCLOSE @cursor_xLandfreight;\n\t\t\tDEALLOCATE @cursor_xLandfreight;\n\tEND\n\nSELECT Bedrijf = (SELECT [xCompany].[Code] FROM [xCompany] WHERE [id] = [xlandfreight].[Counterparty_ID])\n\t,Naam = (SELECT [xCompany].[CompanyName] FROM [xCompany] WHERE [id] = [xlandfreight].[Counterparty_ID])\n\t--,Palcalc = (SELECT [xLandfreight].[lft_PalCalc] FROM [xLandfreight] WHERE [Transactionheader_ID] = @id)\n\t,[Order] = (SELECT [xtransactionheader].[id] FROM [xtransactionheader] WHERE [id] = @id)\n\t, Blok, Euro INTO #tmptable FROM xLandfreight WHERE Transactionheader_ID = @id\nEXEC sp_api_modal_table  @tmptable = '#tmptable'\n/*\nSET @reducer = N'Transport_ID = ' + @id\nEXEC sp_api_modal_table @card_name = N'uitgaande_pallets',@reducer= @reducer\n*/\nRETURN\n\n*/",
            "action_id": 496,
            "action_name": "ChangeAmount",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "SET @text = N'You pressed: '+ISNULL(@button,'[nothing, eg. NULL]')\nEXEC sp_api_modal_text @text\nEXEC sp_api_modal_choose @list=N'ABC,DEF,GHI,JLK', @name = '@button', @value = @button OUT",
            "action_id": 499,
            "action_name": "Pre Declare",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @cursor CURSOR,@idval INT\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @idval\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tupdate xinvoice set status='exported' where status='sent' and ID=@idval\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\n\n\n",
            "action_id": 500,
            "action_name": "Bevestig import Exact",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "SELECT * INTO #globecsv \n\t\t\tFROM calc_exact_globe_csv \n\t\t\tWHERE inv_id in (@IDS) --datum IS NOT NULL \n\t\t\tORDER BY factuurnum,dagboek,regel\nEXEC sp_api_modal_csv @tmptable=N'#globecsv',@ansi =1,@filename=N'exact_globe.csv',@orderby=N'ORDER BY factuurnum,dagboek,regel'",
            "action_id": 501,
            "action_name": "Enkele Factuur naar globe",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "SELECT * INTO #exactdos FROM calc_exact_dos_csv WHERE inv_id IN (SELECT * FROM STRING_SPLIT(@ids,',')) ORDER BY Factuurnummer,rn\nALTER TABLE #exactdos DROP COLUMN inv_id\nEXEC sp_api_modal_csv @tmptable=N'#exactdos',@ansi =1,@filename=N'exact_dos.csv',@orderby=N'ORDER BY Factuurnummer,rn',@useheaders=0,@usequotes=1,@usequotesfornull=1,@sep=','",
            "action_id": 505,
            "action_name": "Naar ExactDos CSV",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--DIT IS DE PREVIEW NAAR DE USER\n\nDECLARE @test int = 1 -- LAAT OP 1 0=LIVE; 1=TEST\n\nDECLARE @cursor CURSOR\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @id\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\n\t\tDECLARE @toCompany_ID INT = NULL\n\t\tDECLARE @fromCompany_ID INT = NULL\n\t\tDECLARE @StateOK bit\n\n\t\tSELECT @toCompany_ID = toCompany_ID, @fromCompany_ID = fromCompany_ID FROM [xInvoice] WHERE [id] = @id\n\n\t\tEXEC sp_api_report_generate @id = @id\n\t\t\t,@sys_report_key = 'invoice_out'\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@test=@test\n\n--UIT LATEN !! DIT IS DE PREVIEW NAAR JEZELF DUS WIL JE GEEN FASE VERSCHUIVING\n--\t\texec  @main_db.dbo.Fase_INV @ID=@id,@Fase=N'sent' ,@StateOK = @StateOK OUT\n--\t\tif @StateOK=0 exec sp_api_toast N'LET OP: DE FASE ''sent'' is nog niet toegestaan in xFASE...'\n\n\t\tFETCH NEXT FROM @cursor INTO @id\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\n",
            "action_id": 506,
            "action_name": "Preview (naar jezelf mailen)",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @test int = 0 -- 0=LIVE; 1=TEST\n\n\t,@count int = 0\nDECLARE @cursor CURSOR\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @id\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tDECLARE @toCompany_ID INT = NULL\n\t\tDECLARE @fromCompany_ID INT = NULL\n\t\tDECLARE @StateOK bit\n\t\tDECLARE @description nvarchar(max)\n\n\t\tSELECT @toCompany_ID = toCompany_ID, @fromCompany_ID = fromCompany_ID\n\t\t\t\t,@description = CONCAT('Send invoice to: ',(SELECT companyname FROM xcompany WHERE id = toCompany_ID))\n\t\t\t FROM [xInvoice] WHERE [id] = @id\n\t\tDECLARE @sqltask nvarchar(max) = CONCAT('EXEC sp_api_report_generate @id = ',@id,',@sys_report_key = ''invoice_out'',@toCompany_ID = ',@toCompany_ID\n\t\t\t,',@fromCompany_ID = ',@fromCompany_ID,',@test=',@test)\n\t\tSET @sqltask = CONCAT(@sqltask,CHAR(13) ,N'EXEC @main_db.dbo.Fase_INV @ID=',@id,',@Fase=N''Sent''')\n\t\tEXEC sp_api_add_sql_task @sql=@sqltask,@description=@description --N'Verstuur facturen'\n\t\tEXEC @main_db.dbo.Fase_INV @ID=@id,@Fase=N'Sending',@StateOK = @StateOK OUT\n\t\t--EXEC sp_api_toast @StateOK\n\t\tSET @count+=1\n\t\tFETCH NEXT FROM @cursor INTO @id\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\nexecute sp_api_modal_clear\nEXEC sp_api_modal_select_all_clear\nIF @count > 0 EXEC sp_api_toast N'Verzenden is ingepland, F5 voor refresh'\n",
            "action_id": 507,
            "action_name": "Printen / Verzenden",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "Declare @infotext nvarchar(512) = concat('Samenvatting voor factuur: ',{[invoice].InvoiceNumber_F})\nEXEC sp_api_modal_text @text=@infotext,@class = 'h3 text-muted'\n\nEXEC sp_api_modal_print\nSELECT * INTO #ColliVerkocht from @main_db.dbo._FinRows(@ID,1,1,1)\nEXEC sp_api_modal_table @tmptable=N'#ColliVerkocht',@print=1\n",
            "action_id": 508,
            "action_name": "Samenvatting",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "IF @id <> @ids EXEC sp_api_modal_alert N'Alle regels verwijderen van alle geselecteerde facturen?'\n\nDECLARE @cursor CURSOR,@idval INT\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @idval\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tIF EXISTS (SELECT * FROM xInvoice WHERE id=@idval AND status = 'draft')\n\t\t\tBEGIN\n--MISSCHIEN VERSTANDIGER ALS DIT NAAR EEN SP GAAT\t\t\t\n--===============================================\n\t\t\t\tUPDATE xTransactionHeader SET status = N'ReadyForInvoice' WHERE id IN (SELECT DISTINCT cth_id FROM xInvRow WHERE invoice_id=@idval)\n\t\t\t\t--RH210222 AANPASSING: DIRECTE REGELS NOOIT WERKELIJK VERWIJDEREN, MAAR ALLEEN NULLIFY INVOICE_ID \n\t\t\t\tdelete FROM xinvrow WHERE invoice_id=@idval AND left(groupcode,6) <> 'DIRECT'  \n\t\t\t\tupdate xInvRow_total set invvattotals_id = null  where xInvRow_id in (select id from xinvrow  where invoice_id=@idval AND left(groupcode,6) = 'DIRECT' )\n\t\t\t\tupdate xinvrow set invoice_ID = NULL, invVatTotals_ID = null WHERE invoice_id=@idval AND left(groupcode,6) = 'DIRECT'\n\t\t\t\t\n\t\t\tEND\n\t\tELSE\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_toast N'Invoice niet in status ''Draft'''\n\t\t\tEND\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\nEXEC sp_api_modal_clear\nEXEC sp_api_modal_select_all_clear\n\n\n",
            "action_id": 509,
            "action_name": "Verwijder de regels",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "IF dbo.hasClaims('sub=sylvester@vgibv.nl,role=admin,role=directie,role=finance') > 0\nBEGIN\n\tupdate xinvoice set status='Draft' where id =@ID\nEND\t\n\n\t",
            "action_id": 510,
            "action_name": "Zet Draft",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_choose @list = N'Draft,Sent,Exact',@value = @button_choose OUT\n\nIF @button_choose IS NOT NULL\n\tBEGIN\n\t\tUPDATE xInvoice set status = @button_choose WHERE id IN ({@ids})\n\t\tEXEC sp_api_modal_clear\n\t\t--EXEC sp_api_modal_select_all_clear --juist even niet!\n\tEND\t",
            "action_id": 511,
            "action_name": "Status naar ...",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_clear",
            "action_id": 525,
            "action_name": "Refresh",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128), @datumrange nvarchar(50)\nset @date = dbo.workDate()\n\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\nEXEC sp_api_modal_date_from_to @from=@from out, @to=@to out\nSET @button = 'OmzetLijst'\nSET @datumrange = concat(@from, ' - ', @to)\nEXEC sp_api_modal_text @datumrange, @printonly=1\nEXEC sp_api_modal_button @name='button',@value = 'OmzetLijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print\n\n-- \tSELECT TransactionDate, TV_CompanyName,[currencyISO*] = currencyISO,id, [totalProductPrice@] = totalProductPrice, [DATE*] = concat(@from, ' - ', @to)\n\nIF @button =  'OmzetLijst'\nBEGIN\n\tSELECT distinct \n\t[Debtor Nr] = (select debtorNumber from xcompany where id = CounterParty_ID)\n\t, [TV_CompanyName] = concat((select code from xcompany where id = CounterParty_ID),' ',TV_CompanyName)\n\t, [currencyISO*] = currencyISO\n\t, [Sum Colli@] = sum(COLFTOTALCTH)\n\t, [Sum Palcalc@] = sum(ctrPalCalcTotal)\n\t,[ValutaPrice@:2] = isnull(sum(totalProductPrice) \n\t--kortingen\n\t/ 100 * \n\t--Factuur korting percentage\n\t(isnull((select setting from xCompanyCostSettings where description_ID = 1 AND GroupCode = 'KORTING_P' and xCompany_ID = q_xtransactionheader.CounterParty_ID),0) \n\t--Rabat korting percentage \n\t+ isnull((select setting from xCompanyCostSettings where xCompany_ID = q_xtransactionheader.CounterParty_ID and description_ID = 200),0) + 100)\n\t--Rabat per collo\n\t+ ISNULL(((select setting from xCompanyCostSettings where description_ID = 210 and xCompany_ID = CounterParty_ID) * \n\t(select sum(Amount) from Q_xTransactionDetail where Q_xTransactionDetail.Counterparty_ID = q_xtransactionheader.CounterParty_ID and TransactionDate BETWEEN @from AND @to)),0)\n\t--korting per collo\n\t+ ISNULL(((select setting from xCompanyCostSettings where description_ID = 8 and xCompany_ID = CounterParty_ID) * \n\t(select sum(Amount) from Q_xTransactionDetail where Q_xTransactionDetail.Counterparty_ID = q_xtransactionheader.CounterParty_ID and TransactionDate BETWEEN @from AND @to)),0)\n\t,ISNULL(sum(totalProductPrice),0))\n\t\n\t,[totalPriceEuro@:2] = isnull(sum(totalProductPrice * currency_rate) \n\t--kortingen\n\t/ 100 * \n\t--Factuur korting percentage\n\t(isnull((select setting from xCompanyCostSettings where description_ID = 1 AND GroupCode = 'KORTING_P' and xCompany_ID = q_xtransactionheader.CounterParty_ID),0) \n\t--Rabat korting percentage \n\t+ isnull((select setting from xCompanyCostSettings where xCompany_ID = q_xtransactionheader.CounterParty_ID and description_ID = 200),0) + 100)\n\t--Rabat per collo\n\t+ ISNULL(((select setting from xCompanyCostSettings where description_ID = 210 and xCompany_ID = CounterParty_ID) * \n\t(select sum(Amount) from Q_xTransactionDetail where Q_xTransactionDetail.Counterparty_ID = q_xtransactionheader.CounterParty_ID and TransactionDate BETWEEN @from AND @to)),0)\n\t--korting per collo\n\t+ ISNULL(((select setting from xCompanyCostSettings where description_ID = 8 and xCompany_ID = CounterParty_ID) * \n\t(select sum(Amount) from Q_xTransactionDetail where Q_xTransactionDetail.Counterparty_ID = q_xtransactionheader.CounterParty_ID and TransactionDate BETWEEN @from AND @to)),0)\n\t,ISNULL(sum(totalProductPrice),0))\n\t\n\n\tINTO #OmzetLijst\n\tfrom q_xtransactionheader \n\tCROSS APPLY(select currency_rate = F FROM @main_db.[dbo].[GETVALUE]('CURRENCY',currency_id,transactiondate)) rate\n\twhere TDT = 2 AND (specialType = 1001 OR specialType IS NULL) AND Repack_ID is null AND (TransactionDate BETWEEN @from AND @to)\n\tGROUP BY currencyISO,TV_CompanyName,CounterParty_ID\n\tEXEC sp_api_modal_table @tmptable=N'#OmzetLijst',@orderby=N'ORDER BY 3,2 ASC',@print=1\nEND \n",
            "action_id": 547,
            "action_name": "Omzet lijst",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @company_id nvarchar(32),@Countercompany nvarchar(32),@button nvarchar(128),@button2 nvarchar(128),@new_id nvarchar(32)\n,@goto nvarchar(2000),@search nvarchar(2000), @location_id nvarchar(32), @reducer nvarchar(max), @date nvarchar(128)\n,@Euro nvarchar(128),@Blok nvarchar(128), @Transportinfo nvarchar(32)\n,@button1 nvarchar(128),@updateinfo nvarchar(128)\n--= N'Set Pallets'\n--\tEXEC sp_api_modal_modal @class=N'w-100'\n\n\nSELECT \n\tid\n\t,[Bedrijf ] = (SELECT CONCAT([xCompany].[Code],'-',CompanyName) FROM [xCompany] WHERE [id] = [xlandfreight].[Counterparty_ID])\n\t,[lft_PalCalc ] = lft_PalCalc\n\t, Blok, Euro\n\tINTO #modalupdate\nFROM xLandfreight WHERE Transactionheader_ID = @id AND (status != 'Departed')\nEXEC sp_api_modal_table_update @tmptable = N'#modalupdate',@focusx = 3,@focusy = 1\n\nDECLARE @button_text1 nvarchar(128) = 'Opslaan'\nEXEC sp_api_modal_button @name='button1',@value = @button_text1, @valueout = @button1 OUT ,@class='btn-primary',@key='Enter'\nIF @button1 IS NOT NULL\n\tBEGIN\n\t\tSET @updateinfo = {[verkoop].logistic}\n\t\tIF CHARINDEX('B:',@updateinfo) > 0 SET @updateinfo = LEFT(@updateinfo,CHARINDEX('B:',@updateinfo)-1)\n\t\tSET @updateinfo = TRIM(@updateinfo)\n\t\tDECLARE @lfid int\n\t\tDECLARE @cursor_xLandfreight CURSOR\n\t\tSET @cursor_xLandfreight = CURSOR LOCAL FAST_FORWARD FOR SELECT id, Blok, Euro FROM #modalupdate\n\t\tOPEN @cursor_xLandfreight;\n\t\tFETCH NEXT FROM @cursor_xLandfreight INTO @lfid,@Blok,@Euro\n\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_post 'uitgaande_landfreight','Blok',@Blok,@lfid\n\t\t\t\tEXEC sp_api_modal_post 'uitgaande_landfreight','Euro',@Euro,@lfid\n\t\t\t\tEXEC sp_api_modal_save 'uitgaande_landfreight',@lfid\n\t\t\t\tSET @updateinfo = CONCAT(@updateinfo,' B:',@blok,' E:',@Euro)\n\t\t\t\tFETCH NEXT FROM @cursor_xLandfreight INTO @lfid,@Blok,@Euro\n\t\t\tEND\n\t\tCLOSE @cursor_xLandfreight;\n\t\tDEALLOCATE @cursor_xLandfreight;\n\t\tEXEC sp_api_modal_post 'verkoop','logistic',@updateinfo,@id\n\t\tEXEC sp_api_modal_save 'verkoop',@id\n\t\tEXEC sp_api_modal_clear\n\tEND\nRETURN\n/*\nSELECT TOP 1 @Euro = Euro, @Blok = Blok FROM xLandfreight WHERE Transactionheader_ID = @id\n\n\tEXEC sp_api_modal_text 'Aantal Blok:','text-primary font-weight-bold h4' --display-4 text-center\n\tEXEC sp_api_modal_input @name='Blok',@value = @Blok OUT,@class='w-25 mt-3'\n\tEXEC sp_api_modal_text 'Aantal Euro:','text-primary font-weight-bold h4' --display-4 text-center\n\tEXEC sp_api_modal_input @name='Euro',@value = @Euro OUT,@class='w-25 mt-3'\n\tEXEC sp_api_modal_text 'Kies een optie:','text-primary font-weight-bold h4' --display-4 text-center\n\tEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Enter'\n\nIF @button = @button1\n\tBEGIN\n\t\tDECLARE @lfid int\n\t\t\tDECLARE @cursor_xLandfreight CURSOR\n\t\t\tSET @cursor_xLandfreight = CURSOR LOCAL FAST_FORWARD FOR SELECT id FROM xLandfreight WHERE Transactionheader_ID = @id\n\t\t\tOPEN @cursor_xLandfreight;\n\t\t\tFETCH NEXT FROM @cursor_xLandfreight INTO @lfid\n\t\t\tWHILE @@FETCH_STATUS = 0\n\t\t\t\tBEGIN\n\t\t\t\t\tEXEC sp_api_modal_post 'xlandfreight','Blok',@Blok,@lfid\n\t\t\t\t\tEXEC sp_api_modal_post 'xlandfreight','Euro',@Euro,@lfid\n\t\t\t\t\tEXEC sp_api_modal_save 'xlandfreight',@lfid\n\t\t\t\t\tFETCH NEXT FROM @cursor_xLandfreight INTO @lfid\n\t\t\t\tEND\n\t\t\tCLOSE @cursor_xLandfreight;\n\t\t\tDEALLOCATE @cursor_xLandfreight;\n\tEND\n\nSELECT Bedrijf = (SELECT [xCompany].[Code] FROM [xCompany] WHERE [id] = [xlandfreight].[Counterparty_ID])\n\t,Naam = (SELECT [xCompany].[CompanyName] FROM [xCompany] WHERE [id] = [xlandfreight].[Counterparty_ID])\n\t--,Palcalc = (SELECT [xLandfreight].[lft_PalCalc] FROM [xLandfreight] WHERE [Transactionheader_ID] = @id)\n\t,[Order] = (SELECT [xtransactionheader].[id] FROM [xtransactionheader] WHERE [id] = @id)\n\t, Blok, Euro INTO #tmptable FROM xLandfreight WHERE Transactionheader_ID = @id\nEXEC sp_api_modal_table  @tmptable = '#tmptable'\n/*\nSET @reducer = N'Transport_ID = ' + @id\nEXEC sp_api_modal_table @card_name = N'uitgaande_landfreight',@reducer= @reducer\n*/\nRETURN\n\n*/",
            "action_id": 550,
            "action_name": "Landfreight doorgeven",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @sys_report_key nvarchar(50) = N'confirmation_out'\ndeclare @test bit =1 -- 0:LIVE ; 1=TEST\nEXEC sp_api_toast @sys_report_key--N'Orderbevestiging' \n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\t--EXEC sp_api_toast @cid\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select Counterparty_id from xtransactionheader where id=@cid)\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = @sys_report_key--'confirmation_out' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@test=@test\n\n\t\t--dit is nu alleen voor tellers en checks:\n\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'CTH'\t,@Context_Key_ID=@cid,@Report_CODE=N'CONF'\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;\nEXEC sp_api_modal_clear\nEXEC sp_api_modal_select_all_clear",
            "action_id": 551,
            "action_name": "Stuur Orderbevestiging",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "Declare @sys_Report_Key nvarchar(200)='picklist' \ndeclare @test bit = 0 -- 0:LIVE; 1=TEST\nDECLARE @FixedPrinter_ID INT = 36\nDECLARE @NED INT,@Country_id INT\n\nIF (select count(id) from q_xtransactionheader where id in (select transactionheader_id from Q_xTransactionDetail where delayed = 1) AND id IN ({@ids})) > 0\nBEGIN\n\tEXEC sp_api_modal_text N'Een order is gereserveerd, Orders moeten eerst worden vrijgegeven!', N'h5'\nRETURN;\nEND\n\nEXEC sp_api_toast @sys_Report_Key\n\n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\nDECLARE @GreeveRegels INT, @AnacoRegels INT, @AnacoPrinter INT, @GreevePrinter INT\n--ALS ER 1 geselecteerd is, kijk dan of er multi-bestemming gedefinieerd is..\n\nIF @IDS=@ID \n\tBEGIN \n\t\t--exec SP_API_Toast N'single id, dus evt keuze optie'\n\t\t\n\t\tDECLARE\t@ReportName nvarchar(200), @ReportSQL nvarchar(max) ,@RepDef_ID INT\n\n\t\t--210103 print naar van geest! (TO)\n\t\tSET @toCompany_ID = (select Counterparty_id from xtransactionheader where id=@ID)\n\n\t\tset @Repdef_ID = (SELECT TOP 1 id FROM xRepDef WHERE sys_report_key = @sys_Report_Key)\n\t\tif @RepDef_ID is null \n\t\t\tBEGIN\n\t\t\t\tdeclare @Yell nvarchar(100)\n\t\t\t\tset @Yell = Concat(N'Er is geen report definitie voor ',@sys_Report_Key)\n\t\t\t\texec sp_api_toast @Yell\n\t\t\t\treturn;\n\t\t\tEND\n\tEND\n\n--MULTI\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\t--dit is nu alleen voor tellers en checks:\n\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select Counterparty_id from xtransactionheader where id=@cid)\n\t\t\n\t\tSET @NED = 151\n\t\tSET @Country_id = (SELECT Country = (SELECT Country_ID FROM xCompany WHERE id = CounterParty_ID) FROM Q_xTransactionHeader WHERE id = @cid)\n\t\t\n\t\t-- CG 210816 Check of er regels zijn welke from advies anaco of greeve hebben en afhankelijk van resultaat wordt printer aangestuurd.\n\t\tSET @GreeveRegels = (SELECT COUNT(id) FROM xTransactionDetail where transactionheader_id = @cid AND frmloc_id IN (17321,11112,17322))\n\t\tSET @AnacoRegels = (SELECT COUNT(id) FROM xTransactionDetail where transactionheader_id = @cid AND frmloc_id NOT IN (17321,11112,17322))\n\t\t\n\t\tIF @GreeveRegels > 0\n\t\tBEGIN\n\t\t SET @GreevePrinter = 32\n\t\tEND\n\t\t\n\t\tIF @AnacoRegels > 0\n\t\tBEGIN\n\t\t SET @AnacoPrinter = 40\n\t\tEND\n\t\t\n\t\tIF @AnacoPrinter IS NOT NULL\n\t\tBEGIN\n\t\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t\t,@sys_report_key = @Sys_Report_Key--'picklist' --zie xrepdef\n\t\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t\t,@test = @test --hiermee schakel je tussen productie en test-modus\n\t\t\t\t,@FixedPrinter_ID = @AnacoPrinter\n\t\t\t--even registreren dat er wordt afgedrukt\n\t\t\t\n\t\t\tIF @NED = @Country_id\n\t\t\t\tBEGIN\t\t\n\t\t\t\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t\t\t\t,@sys_report_key = 'deliverynote'\n\t\t\t\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t\t\t\t,@test = @test --hiermee schakel je tussen productie en test-modus\n\t\t\t\t\t\t,@FixedPrinter_ID = @AnacoPrinter\n\t\t\t\t\t\t,@PrinterCopies = 2\n\t\t\t\tEND\n\t\t\t\n\t\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'CTH'\t,@Context_Key_ID=@cid,@Report_CODE=N'PICK'\n\t\tEND\n\t\t\n\t\tIF @GreevePrinter IS NOT NULL\n\t\tBEGIN\n\t\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t\t,@sys_report_key = @Sys_Report_Key--'picklist' --zie xrepdef\n\t\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t\t,@test = @test --hiermee schakel je tussen productie en test-modus\n\t\t\t\t,@FixedPrinter_ID = @GreevePrinter\n\t\t\t\t\n\t\t\tIF @NED = @Country_id\n\t\t\t\tBEGIN\t\n\t\t\t\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t\t\t\t,@sys_report_key = 'deliverynote'\n\t\t\t\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t\t\t\t,@test = @test --hiermee schakel je tussen productie en test-modus\n\t\t\t\t\t\t,@FixedPrinter_ID = @GreevePrinter\n\t\t\t\t\t\t,@PrinterCopies = 2\n\t\t\t\tEND\n\t\t\t\t\n\t\t\t--even registreren dat er wordt afgedrukt\n\t\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'CTH'\t,@Context_Key_ID=@cid,@Report_CODE=N'PICK'\n\t\tEND\n\t\t--210104 end sum voor alles bijwerken\n\t\texecute @main_db.dbo.CTH_Endsum @cid\n\n\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;\nEXEC sp_api_modal_clear\nEXEC sp_api_modal_select_all_clear\n",
            "action_id": 552,
            "action_name": "Print Pickbon",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128)\nset @date = dbo.workDate()\n\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\nEXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\nSET @button = 'ColliVerkocht'\nEXEC sp_api_modal_button @name='button',@value = 'ColliVerkocht',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print\n\nIF @button =  'ColliVerkocht'\nBEGIN\n\tSELECT [Aantal colli verkocht] = sum(Amount) \n\tINTO #ColliVerkocht\n\tfrom Q_xTransactionDetail \n\twhere (TransactionDate BETWEEN @from AND @to) and Repack_ID is null and TDT = 2\n\tEXEC sp_api_modal_table @tmptable=N'#ColliVerkocht',@print=1\nEND \n",
            "action_id": 556,
            "action_name": "Verkocht aantal colli",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--EXEC sp_api_modal_text N'EVEN AFLBIJVEN AUB! BEZIG MET TESTEN',N'h1 mb-3'\n\nDECLARE @company_id nvarchar(32)\n\t,@button nvarchar(128)\n\t,@ctr_id_without_cost_settings INT\n\t,@button_name1 nvarchar(128) = N'Genereer'\n\t,@button_name2 nvarchar(128)\n--\t,@button2 nvarchar(128)\n\t,@reducer nvarchar(max) = N'id IN(SELECT counterparty_id FROM xTransactionHeader WHERE TDT = 2 and status in (''ReadyForInvoice'',''openClaim''))'\n\n--EXEC sp_api_modal_button @name='button',@value='hidden',@valueout = @button OUT\n\n\tEXEC sp_api_modal_text N'Kies een specifieke klant:',N'h4 mt-4 text-muted'\n\tEXEC sp_api_modal_select @card_name = N'klant',@value = @company_id OUT,@reducer = @reducer ,@focus=1\n\n\tIF @company_id IS NOT NULL\n\t\tBEGIN\n\t\t\t(SELECT @button_name1+= N' '+[xCompany].[Code] FROM [xCompany] WHERE [id] = @company_id)\n\t\t\tEXEC sp_api_modal_button @name='button',@value=@button_name1,@valueout = @button OUT,@key='Enter'\n\t\t\tIF @button IS NULL RETURN\n\t\t\tBEGIN TRY\n\t\t\t\tEXEC @ctr_id_without_cost_settings = @main_db.dbo.sp_create_invoice_rows @THDT = 2,@Counterparty_ID = @company_id\n\t\t\tEND TRY BEGIN CATCH\n\t\t\tEND CATCH\n\t\t\tIF @ctr_id_without_cost_settings > 0\n\t\t\t\tBEGIN\n\t\t\t\t\tDECLARE @Counterparty nvarchar(400),@Counterparty_ID nvarchar(32)\n\t\t\t\t\tSELECT @Counterparty = d.Counterparty,@Counterparty_ID=Counterparty_ID FROM Q_xTransactionDetail d WHERE id = @ctr_id_without_cost_settings\n\t\t\t\t\tSET @text =CONCAT(N'Missing cost settings for ',@Counterparty)\n\t\t\t\t\tEXEC sp_api_modal_text @text,N'h4 mb-3'\n\t\t\t\t\tDECLARE @pathname nvarchar(2000) = '/klant/'+@Counterparty_ID+'/company_cost_settings'\n\t\t\t\t\tEXEC sp_api_modal_route @name=N'Edit cost settings',@pathname=@pathname,@key='Enter'\n\t\t\t\t\tRETURN\n\t\t\t\t\n\t\t\t\tEND\n\t\t\tEXEC sp_api_modal_clear\n\t\tEND\n",
            "action_id": 560,
            "action_name": "Genereer factuur (select)",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @test int = 1 -- 0=LIVE; 1=TEST\n\nIF @id <> @ids EXEC sp_api_modal_alert N'Waarschuwing',N'De selectie wordt naar jezelf verstuurd.'\n\nDECLARE @cursor CURSOR\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @id\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\n\t\tDECLARE @toCompany_ID INT = NULL\n\t\tDECLARE @fromCompany_ID INT = NULL\n\t\tDECLARE @StateOK bit\n\t\tDECLARE @description nvarchar(max)\n\t\tSELECT @toCompany_ID = toCompany_ID, @fromCompany_ID = fromCompany_ID\n\t\t\t\t,@description = CONCAT('Email invoice to myself: ',(SELECT companyname FROM xcompany WHERE id = toCompany_ID))\n\t\t\t FROM [xInvoice] WHERE [id] = @id\n\t\tDECLARE @sqltask nvarchar(max) = CONCAT('EXEC sp_api_report_generate @id = ',@id,',@sys_report_key = ''invoice_out'',@toCompany_ID = ',@toCompany_ID\n\t\t\t,',@fromCompany_ID = ',@fromCompany_ID,',@test=0 ,@fixedEmail=',dbo.escape_string(@user_name) )\n\t\tIF @id <> @ids\n\t\t\tEXEC sp_api_add_sql_task @sql=@sqltask,@description=@description --N'Verstuur facturen'\n\t\tELSE\n\t\t\tEXEC(@sqltask)\n--UIT LATEN !! DIT IS DE PREVIEW NAAR JEZELF DUS WIL JE GEEN FASE VERSCHUIVING\n--\t\texec @main_db.dbo.Fase_Guard @ID=@ID,@Fase=N'sent' ,@StateOK = @StateOK OUT,@Context =N'INV' --210113 DEZE METHODE GEBRUIKEN VOOR ALLE FASE WIJZIGINGEN IN AGFX !\n--\t\tif @StateOK=0 exec sp_api_toast N'LET OP: DE FASE ''sent'' is (nog) niet toegestaan in xFASE...'\n\n\t\tFETCH NEXT FROM @cursor INTO @id\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\nEXEC sp_api_modal_clear",
            "action_id": 561,
            "action_name": "Mail naar jezelf",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @test int = 0 -- 0=LIVE; 1=TEST\n\nIF @id <> @ids EXEC sp_api_modal_alert N'Waarschuwing',N'De selectie wordt opnieuw naar klanten verstuurd.'\n\nDECLARE @cursor CURSOR\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @id\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\n\t\tDECLARE @toCompany_ID INT = NULL\n\t\tDECLARE @fromCompany_ID INT = NULL\n\t\tDECLARE @StateOK bit\n\n\t\tSELECT @toCompany_ID = toCompany_ID, @fromCompany_ID = fromCompany_ID FROM [xInvoice] WHERE [id] = @id\n\n\t\tEXEC sp_api_report_generate @id = @id\n\t\t\t,@sys_report_key = 'invoice_out'\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@test=@test\n\n\t\t\n--\t\texec @main_db.dbo.Fase_INV   @ID=@id,@Fase=N'sent' ,@StateOK = @StateOK OUT\n\t\texec @main_db.dbo.Fase_Guard @ID=@ID,@Fase=N'sent' ,@StateOK = @StateOK OUT,@Context =N'INV' --210113 DEZE METHODE GEBRUIKEN VOOR ALLE FASE WIJZIGINGEN IN AGFX !\n\t\tif @StateOK=0 exec sp_api_toast N'LET OP: DE FASE ''sent'' is (nog) niet toegestaan in xFASE...'\n\n\t\tFETCH NEXT FROM @cursor INTO @id\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\n",
            "action_id": 562,
            "action_name": "Opnieuw Printen / Verzenden",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--DIT IS DE PREVIEW NAAR DE USER\n\nDECLARE @test int = 1 -- LAAT OP 1 0=LIVE; 1=TEST\n\nEXEC sp_api_modal_alert N'Waarschuwing',N'De selectie wordt naar jezelf verstuurd.'\n\nDECLARE @cursor CURSOR\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @id\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\n\t\tDECLARE @toCompany_ID INT = NULL\n\t\tDECLARE @fromCompany_ID INT = NULL\n\t\tDECLARE @StateOK bit\n\n\t\tSELECT @toCompany_ID = toCompany_ID, @fromCompany_ID = fromCompany_ID FROM [xInvoice] WHERE [id] = @id\n\n\t\tEXEC sp_api_report_generate @id = @id\n\t\t\t,@sys_report_key = 'invoice_out'\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@test=@test\n\n--UIT LATEN !! DIT IS DE PREVIEW NAAR JEZELF DUS WIL JE GEEN FASE VERSCHUIVING\n--\t\texec  @main_db.dbo.Fase_INV @ID=@id,@Fase=N'sent' ,@StateOK = @StateOK OUT\n--\t\tif @StateOK=0 exec sp_api_toast N'LET OP: DE FASE ''sent'' is nog niet toegestaan in xFASE...'\n\n\t\tFETCH NEXT FROM @cursor INTO @id\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\n",
            "action_id": 563,
            "action_name": "Preview (naar jezelf)",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @set nvarchar(max) = N'name=name+''_clone'''\n\nEXEC sp_api_modal_alert N'Clone',N'Create a clone of this record?'\nDECLARE @clone_id nvarchar(32)\nEXEC @clone_id = sp_clone_record @basetable,@ids,@set=@set\nEXEC sp_api_modal_clear\nSET @path = @path+'/'+@clone_id\nEXEC sp_api_modal_text N'Record cloned',N'h4 text-muted'\nEXEC sp_api_modal_route @name = N'Go to clone',@pathname=@path,@key='Enter'\n",
            "action_id": 567,
            "action_name": "clone",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_text N'Set Record Limit & Threshold',N'h4 text-muted'\nEXEC sp_api_modal_input @name='@limit',@value = @limit OUT,@focus=1\nEXEC sp_api_modal_input @name='@threshold',@value = @threshold OUT\nEXEC sp_api_modal_button @name='@button',@value='Set',@valueout = @button OUT,@key='Enter'\nIF @button IS NULL RETURN\nUPDATE api_card SET record_limit = TRY_CAST(@limit as int) WHERE id IN({@ids})\nUPDATE api_card SET record_threshold = TRY_CAST(@threshold as int) WHERE id IN({@ids})\nEXEC sp_api_modal_clear",
            "action_id": 571,
            "action_name": "Record Limit/Threshold",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@button1 nvarchar(128) = N'Voeg transporten toe',@STRING VARCHAR(MAX),@SEPARATOR CHAR(1)\n\nEXEC sp_api_modal_date @name='Datum voor Transporten:',@value = @date OUT,@class='w-25 mt-3'\nEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Insert'\n\nSET @date = dbo.workdate()\n/*\nSET @SEPARATOR=',' \nSET @STRING=(N'VGI 1 - Andre Barendse,VGI 2 - Leo Beekenkamp,VGI 3 - Renee Vink,VGI 4 - Wim Vermeulen,VGI 6 - Jacob Mauritz,VGI 7 - Eliza Vollebregt,\nVGI 8 - Marcel Brussaard,VGI 9 - Paul Jansen,95-BKJ-6,LOLA GREEN OU,HANNON,TRUNIC - Jan,TRUNIC - Nick,TRUNIC - Kelvin,TRUNIC - Mitch,GROUPAGE,Augma,\nFreight-Line,DLG,Hartman Expeditie,DUIJN,J.P. VIS,TOMPREX,H.Z.')\n*/\n\nIF @button = @button1\n\tBEGIN\n\t\t/*\nINSERT INTO xTransport (Transportinfo, Transporter_ID, TransportDate, TransportStatus,TDT,FullTruckTariff)\nSELECT \t\t\tTransportinfo = value,\n\t\t        Transporter_ID = 147036,\n\t\t       \tTransportDate = @date,\n\t\t        TransportStatus = 'Departing',\n\t\t\t\tTDT = 2,\n\t\t\t\tFullTruckTariff = 0\nFROM \nSTRING_SPLIT(@STRING,@SEPARATOR)\n\t\t    */\n\tdelete from xTransport where id not in (select isnull(Transport_ID,0) from xlandfreight)\n\t\n-- simpelere manier:\n\t\tINSERT INTO xTransport(\n\t\t    Transportinfo,\n\t\t    Transporter_ID,\n\t\t    TransportDate,\n\t\t    TransportStatus,\n\t\t\tTDT,\n\t\t\tFullTruckTariff\n\t\t)\n\t\tVALUES\n\t\t-- Van Geest international wagens\n\t\t    (\n\t\t        'VGI 1 - Andre Barendse',\n\t\t        147036,\n\t\t       \t@date,\n\t\t        'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t    (\n\t\t        'VGI 2 - Leo Beekenkamp',\n\t\t        147036,\n\t\t        @date,\n\t\t        'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t    (\n\t\t        'VGI 3 - Renee Vink',\n\t\t        147036,\n\t\t        @date,\n\t\t        'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'VGI 5 - Wim Vermeulen',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'VGI 6 - Jacob Mauritz',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'VGI 7 - Eliza Vollebregt',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'VGI 8 - Marcel Brussaard',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'VGI 9 - Paul Jansen',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'95-BKJ-6',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t-- Overige wagens\n\t\t\t(\n\t\t\t\t'LOLA GREEN OU',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'HANNON',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'TRUNIC - Jan',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'TRUNIC - Nick',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'TRUNIC - Kelvin',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'TRUNIC - Mitch',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'GROUPAGE',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'Augma',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'Freight-Line',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'DLG',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'Hartman Expeditie',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'DUIJN',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'J.P. VIS',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'TOMPREX',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'H.Z.',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    );\n\t\t    EXEC sp_api_modal_clear\n\t\tEND",
            "action_id": 586,
            "action_name": "StandaardAuto's",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @Allowed BIT = 0 \nIF dbo.hasClaims('sub=sylvester@vgibv.nl,sub=joke@vgibv.nl,sub=nicky@vgibv.nl') > 0 OR dbo.hasRole('admin') > 0\nBEGIN\nSET @Allowed = 1\nEND\n\nIF @Allowed = 1\nBEGIN\n--100% kopie van xCTH_Check; CTH vervangen door LF\n\nSELECT id, Factuurnummer, Opmerking,[FactuurTotaal ] = FactuurTotaal,[LF_id ]=LF_id--, [Username ] = Username --,Aantal = CAST(NULL as decimal(18,4)) \n\tINTO #modalupdatetotal FROM xLF_Check where ISNULL(FactuurTotaal,'') > '' AND LF_ID=@ID --AND (trim(isnull(Factuurnummer,N'')) > N'' OR trim(isnull(Opmerking,N'')) > N'')\nEXEC sp_api_modal_table_update @tmptable = N'#modalupdatetotal'--,@addnew=1\n\nSELECT id, Factuurnummer, Opmerking,FactuurTotaal,[LF_id ]=LF_id--, [Username ] = Username --,Aantal = CAST(NULL as decimal(18,4)) \n\tINTO #modalupdate FROM xLF_Check where ISNULL(FactuurTotaal,'') = '' AND  LF_ID=@ID --AND (trim(isnull(Factuurnummer,N'')) > N'' OR trim(isnull(Opmerking,N'')) > N'')\nEXEC sp_api_modal_table_update @tmptable = N'#modalupdate',@addnew=1,@showheader = 0\n\n-- hier heb je bijgewerkte data\nDECLARE @button1 nvarchar(128),@button_text1 nvarchar(128) = 'Opslaan'\nEXEC sp_api_modal_button @name='button1',@value = @button_text1, @valueout = @button1 OUT ,@class='btn-danger',@key='Enter'\n--DECLARE @code nvarchar(100)= (SELECT TOP 1 code from #modalupdate ORDER BY code DESC )\n--EXEC sp_api_modal_text @code\nIF @button1 IS NULL RETURN\n--test:EXEC sp_api_modal_text N'Result:',N'h4 text-muted'\n--EXEC sp_api_modal_table @tmptable = N'#modalupdate'\n--RETURN\n--cursortje\nDECLARE @Factuurnummer nvarchar(128)\n\t\t,@Opmerking nvarchar(128)\n\t\t,@FactuurTotaal nvarchar(128)\n\t\t,@checkid int\n\t\t--,@RealID int\n\t\t,@isNew int\n\tDECLARE @cursor_xLF_Check CURSOR\n\tSET @cursor_xLF_Check = CURSOR LOCAL FAST_FORWARD FOR\nSELECT Factuurnummer, Opmerking,FactuurTotaal, id,isNew FROM #modalupdate UNION SELECT Factuurnummer, Opmerking,FactuurTotaal, id,isNew=0 FROM #modalupdatetotal\n\tOPEN @cursor_xLF_Check;\n\tFETCH NEXT FROM @cursor_xLF_Check INTO\n\t\t@Factuurnummer\n\t\t,@Opmerking\n\t\t,@FactuurTotaal\n\t\t,@checkid\n\t\t,@isNew\n\tWHILE @@FETCH_STATUS = 0\n\t\tBEGIN\n\t\t\tif 1=1 -- RH210111 geen conditie meer, ivm leeg kunnen maken van een nummer!\n\t\t\t\tbegin\n\t\t\t\t\t--select @Realid=id from xLF_check where id=@checkid and LF_id=@ID\n\t\t\t\t\tif @isNew = 1\n\t\t\t\t\t\t--ADD\n\t\t\t\t\t\tbegin\n\t\t\t\t\t\t    insert into xLF_check (Factuurnummer, Opmerking,FactuurTotaal,LF_id,username) values (@Factuurnummer,@Opmerking,@FactuurTotaal,@ID,@User)\n\t\t\t\t\t\tend\n\t\t\t\t\tif @isNew = 0\n\t\t\t\t\t\t--UPDATE\n\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\tupdate xLF_check\n\t\t\t\t\t\t\t\tset Factuurnummer=@Factuurnummer\n\t\t\t\t\t\t\t\t\t,Opmerking=@Opmerking\n\t\t\t\t\t\t\t\t\t,FactuurTotaal=@FactuurTotaal\n\t\t\t\t\t\t\t\twhere id=@checkid\n--\t\t\t\t\t\t\t\tset @RealID = NULL --moet niet nodig zijn..\n\t\t\t\t\t\tend\n\t\t\t\tend\t\t\t\t\t\n\t\t\t\t\t\t\t\n\t\t\tFETCH NEXT FROM @cursor_xLF_Check INTO\n\t\t\t\t@Factuurnummer\n\t\t\t\t,@Opmerking\n\t\t\t\t,@FactuurTotaal\n\t\t\t\t,@checkid\n\t\t\t\t,@isNew\n\t\tEND\n\tCLOSE @cursor_xLF_Check;\n\tDEALLOCATE @cursor_xLF_Check;\n\t\n\t--210111 VERWIJDER RECORDS WAAR GEEN FACTUURNUMMER OF OPMERKING STAAT !\n\tdelete from xLF_Check where  LF_id=@ID AND trim(isnull(Factuurnummer,N''))=N'' AND  trim(isnull(Opmerking,N''))=N''\n\t--return\n\tif @Button1 is NOT NULL\n\t\tEXEC sp_api_modal_clear\n\t\t\nEND\n\nIF @Allowed = 0\nBEGIN\nEXEC sp_api_modal_text N'U mag dit niet doen!','h2 text-danger font-weight-bold text-center'\nEND",
            "action_id": 594,
            "action_name": "Boek_Vrachtfactuur",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_get N'bewaar_kruimel_path',@p1 OUT --@path\nEXEC sp_api_modal_get N'bewaar_kruimel_search',@s1 OUT\nEXEC sp_api_modal_set N'bewaar_kruimel_path' --CLEAR\nEXEC sp_api_modal_set N'bewaar_kruimel_search' --CLEAR\nIF @p1 IS NOT NULL EXEC sp_api_goto @p1,@s1\n",
            "action_id": 613,
            "action_name": "kruimel test",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_input '@input1',@input1 OUT\nEXEC sp_api_modal_input '@input2',@input2 OUT\nEXEC sp_api_modal_input '@input3',@input3 OUT\nEXEC sp_api_modal_select @card_name = N'klant',@value = @klant OUT\nEXEC sp_api_modal_button '@button','OK', @button OUT,@class='btn-danger',@key='Enter'\n\nEXEC sp_api_modal_text @input1\nEXEC sp_api_modal_text @input2\nEXEC sp_api_modal_text @input3\nEXEC sp_api_modal_text @klant\n\nEXEC sp_api_modal_text @lastFocus\nIF ISNULL(@input3,'') = '' SET @lastFocus = '@input3'\nIF ISNULL(@input2,'') = '' SET @lastFocus = '@input2'\nIF ISNULL(@input1,'') = '' SET @lastFocus = '@input1'\nEXEC sp_api_modal_text @lastFocus\n\n",
            "action_id": 637,
            "action_name": "Focus example",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "SET @reducer = N'id IN (SELECT counterparty_id FROM xtransactionheader WHERE tdt = 2)'\nEXEC sp_api_modal_select @card_name = N'klant',@value = @company_id OUT,@focus = 1, @reducer = @reducer\nIF @company_id > 0 --IS NOT NULL\n\tBEGIN\n\t\tSET @reducer = CONCAT('counterparty_id  = ',@company_id)\n\t\tEXEC sp_api_modal_select @card_name = N'verkoop',@value = @cth_id OUT,@focus = 1, @reducer = @reducer,@fieldname=N'CTH_NR'\n\t\tIF @cth_id IS NOT NULL\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_button @name='@button1',@value = 'Alles Retour', @valueout = @button1 OUT,@class='btn-danger',@key='F1'\n\t\t\t\tSET @reducer = CONCAT('transactionheader_id = ',@cth_id)\n\t\t\t\tEXEC sp_api_modal_table @card_name = 'ctr2', @reducer = @reducer\n\t\t\tEND\n\t\t\n\tEND\n\n\n",
            "action_id": 640,
            "action_name": "sys_insert",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @Res int\nexecute @res = @main_db.dbo.Credit_Invoice_inv @ID\nif @res =-2 exec sp_api_modal_text N'Er bestaat al een credit-factuur!'",
            "action_id": 648,
            "action_name": "Crediteer de totale factuur",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "SELECT TOP 1 @Counterparty_ID = Counterparty_ID ,@Base_CTH_ID = id FROM xTransactionHeader\n\tWHERE TDT = 2 AND EXISTS (SELECT * FROM xTransactionDetail WHERE transactionheader_id = xTransactionHeader.id)\n\tORDER BY newid()\n\nEXEC @main_db.dbo.CreateCTH102 @Counterparty_ID ,@retour_cth_id OUTPUT, @Base_CTH_ID = @Base_CTH_ID\n\nSELECT @ctr_id = id, @retour_amount = -1*Amount FROM xTransactionDetail WHERE Amount > 0 AND TransactionHeader_ID IN (SELECT id FROM xTransactionHeader WHERE Counterparty_ID = @Counterparty_ID AND TDT = 2)\nSET @clonesettings = CONCAT('TDT=2,Amount=',@retour_amount,',TransactionHeader_ID=',@retour_cth_id)\nEXEC @retour_ctr_id = dbo.sp_clone_record N'xTransactionDetail',@ctr_id,@clonesettings\n\n\n/*\nDECLARE @new_id int,@retour_cth_id int,@retour_ctr_id int,@inkoop_ctr_id int\nDECLARE @clonesettings nvarchar(max)\nDECLARE @ctr_id int = {[ctr2].id}\nDECLARE @cth_id nvarchar(max) = {[ctr2].cth_id}\nDECLARE @amount int = {[ctr2].Amount}\nDECLARE @Stock_ID int = {[ctr2].Stock_ID}\nDECLARE @Destination_ID int = {[ctr2].TransactionHeader_ID.Source_ID}\nDECLARE @Source_ID int = {[ctr2].TransactionHeader_ID.Destination_ID}\nSET @clonesettings = CONCAT(N'TDT=102,Source_ID=',@Source_ID,',Destination_ID=',@Destination_ID)\nEXEC @retour_cth_id = dbo.sp_clone_record N'xTransactionHeader',@cth_id,@clonesettings\n--EXEC sp_api_modal_text @Source_ID\nDECLARE @retour_amount int = 5\nSET @clonesettings = CONCAT('TDT=1,Amount=',@retour_amount,',TransactionHeader_ID=',@retour_cth_id)\nEXEC @retour_ctr_id = dbo.sp_clone_record N'xTransactionDetail',@ctr_id,@clonesettings\nSELECT TOP 1 @inkoop_ctr_id = VTD FROM xIVLINK WHERE ITD = @ctr_id\nINSERT xIVLINK (ITD,VTD,LinkAantal,Stock_ID) VALUES(@retour_ctr_id,@inkoop_ctr_id,@retour_amount * -1,@Stock_ID)\n\n--EXEC sp_api_modal_text @clonesettings\nDECLARE @search nvarchar(2000) = CONCAT('?id=',@retour_cth_id)\nEXEC sp_api_goto @path=N'/verkoop_retour',@search = @search\n\n*/\n\n\n",
            "action_id": 651,
            "action_name": "Random Retour",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_alert N'Delete selected CTH''s?'\nDECLARE @cursor CURSOR,@idval INT\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @idval\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC @main_db.dbo.DeleteCTH @idval\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\nEXEC sp_api_modal_clear\n",
            "action_id": 655,
            "action_name": "Delete Retour(s)",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_alert N'Delete CTR''s?'\nDECLARE @cursor CURSOR,@idval INT\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @idval\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC @main_db.dbo.DeleteCTR @idval\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\nEXEC sp_api_modal_clear",
            "action_id": 660,
            "action_name": "Delete CTR(s)",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 667,
            "action_name": "sys_clone",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 672,
            "action_name": "Maak een kopie",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "if @id is not null\n\tbegin\n\t\tselect @thiskey=reportkey,@thisotype=otype,@thisprinter=printer_id from xreprouting where id=@id\n\t\tif @thiskey is not null and @thisotype is not null and @thisprinter is not null\n\t\tbegin\t\n\t\t\tupdate xreprouting \n\t\t\t\tset printer_id=@thisprinter\n\t\t\twhere printer_id is NULL \n\t\t\t\t\tand otype=@thisotype and \treportkey=@thiskey\t\t\n\t\t\texecute sp_api_toast @thisprinter\n\t\tend\t\n\tend",
            "action_id": 680,
            "action_name": "Zet ALLE Lege printers op deze printerinstelling",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "IF @ids IS NULL OR @ids = ''\n\tBEGIN\n\t\tEXEC sp_api_modal_alert N'Unable to delete, contact your admin'\n\t\tEXEC sp_api_modal_clear\n\t\tRETURN\n\tEND\nIF @tablename LIKE 'api_%' EXEC sp_api_modal_alert N'Delete project records',N'Are you sure?'\nIF @id <> @ids EXEC sp_api_modal_alert N'Multi Delete',N'Delete multiple records - Are you sure?'\nDECLARE @sql nvarchar(max) \n--kijk of het product nog niet gebruikt is in xstock!\nif exists(SELECT * FROM xStock where xproduct_ID IN ({@IDS}))\n\tbegin\n\t\texec sp_api_modal_alert N'Artikel is al gebruikt in xStock, u kunt het daarom niet verwijderen. (Verwijder het eventueel uit xStock)'\n\t\texec sp_api_modal_clear\n\t\tEXEC sp_api_modal_select_all_clear\n\t\treturn;\n\tend\n-- test return\n\n-- verwijder xproductLang\nset @sql = N'DELETE FROM xProductLang where xProduct_ID IN (' + @ids +')'\nEXEC(@sql);\n\n-- verwijder xproduct\nset @sql = N'DELETE FROM xProduct where ID IN (' + @ids +')'\nEXEC(@sql);\n\n--verwijder botanic\nEXEC sp_api_modal_clear\nEXEC sp_api_modal_select_all_clear\n--EXEC sp_api_go2\n",
            "action_id": 686,
            "action_name": "Delete ",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast 'No delete allowed here!'\n\n",
            "action_id": 702,
            "action_name": "RemoveDelete",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--EXEC sp_api_toast @parent_parent_id\r\n--exec sp_api_toast @User\r\n\t\r\nDECLARE @CTHID INT = {[ompakken].id} --200818 curly\r\nIF @CTHID IS NULL begin\r\n\t\tEXEC sp_api_toast 'Kan geen [ompakken] vinden'\r\n\t\tRETURN;\r\n\t\tend\r\n--ELSE EXEC sp_api_toast @CTHID\r\n\r\nIF {[ompakken].status} not in ('openRepack') BEGIN\r\n\tEXEC sp_api_modal_alert 'Toevoegen alleen bij status: openRepack'\r\n\tEXEC sp_api_modal_clear\t\t\r\n\tRETURN;\t\r\n\tend\r\n\r\n-- 200629 Uitbreiding inkoop vanuit diverse contexten: Zoek CTH ; bijv als we afkomstig zijn van een regel, dan is CTH te vinden in de regel\r\n--if @parent_card_name ='verkoop'\tset @CTHID=@parent_id\r\n--if @parent_card_name = 'ctr2' set @CTHID=(select TransactionHeader_ID from xtransactiondetail where xtransactiondetail.id=@parent_id)\r\n\r\nDECLARE @mes nvarchar(200), @FustSaldo int, @CoreType nvarchar(10),@FustID int, @xDesc nvarchar(200)\r\nSELECT @xDesc=x.[Description],@mes= concat('Ompak in ' , x.[Description]) ,@Coretype= x.coretype,@FustID=x.Fust_ID from xstock x where x.id=@ID --@main_db.dbo.\r\n--EXEC sp_api_modal_text @mes,'h2 text-primary'\r\n------\r\nIF @coretype in('CRATE','PALLET')\r\n\tBEGIN\r\n\t\tSELECT @Fustsaldo=Fustsaldo from @main_db.dbo.FustSaldo_FC(@FustID,{[verkoop].Counterparty_ID})\r\n\t\tEXEC sp_api_toast @Fustsaldo\r\n\t\t-- breid DECLARE message uit met het fust-saldo\r\n\t\tIF @FustSaldo is not NULL\r\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') actueel saldo bij deze klant: ',@fustsaldo)\r\n\t\tELSE\r\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') => let op: deze klant heeft dit fust nooit eerder gehad!')\r\n\tEND\r\n\r\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\r\nDECLARE @aantal nvarchar(20),@opmerking nvarchar(50) --='100'\r\nDECLARE @CounterpartyID int\r\nDECLARE @FlowModel int\r\nDECLARE @THDT INT \r\nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=FlowModel_ID,@THDT=TDT From xTransactionHeader CTH where CTH.ID=@CTHID\r\n--200630 was@parent_id\r\n\r\n--200708 => ??? WAAROM GAAT DIT NIET ??? select @Prijs= @main_db.dbo.StockPrice(@ID,@CTHID,NULL,NULL,NULL,NULL,NULL,NULL,NULL)\r\n\r\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\r\nEXEC sp_api_modal_text 'Aantal'\r\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1\r\nEXEC sp_api_modal_text 'Opm. loods'\r\nEXEC sp_api_modal_input @name='opmerking',@value = @opmerking OUT\r\nDECLARE @button nvarchar(128)\r\nEXEC sp_api_modal_button @name='button',@value = 'IN',@valueout = @button OUT,@class = 'btn-primary',@key = '+'\r\nEXEC sp_api_modal_button @name='button',@value = 'OUT',@valueout = @button OUT,@class = 'btn-primary',@key = '-'\r\nIF @button = 'IN'\r\n\tBEGIN\r\n\t\tIF \t\t--TRY_CAST(@prijs as decimal) > 0 AND \r\n\t\t\t\tTRY_CAST(@aantal as int) > 0 \r\n\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\r\n\t\t\tBEGIN\r\n\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=NULL,@Logistic=@Opmerking, @User=@User, @forcedTDT=2\r\n\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\r\n\t\t\t\texec sp_api_toast @mes\r\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\r\n\r\n\t\t\tEND\r\n\t\tELSE\r\n\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\r\n\tEND \r\nIF @button = 'OUT'\r\n\tBEGIN\r\n\t\tIF \t\t--TRY_CAST(@prijs as decimal) > 0 AND \r\n\t\t\t\tTRY_CAST(@aantal as int) > 0 \r\n\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\r\n\t\t\tBEGIN\r\n\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=NULL,@Logistic=@Opmerking, @User=@User, @forcedTDT=1\r\n\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\r\n\t\t\t\texec sp_api_toast @mes\r\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\r\n\r\n\t\t\tEND\r\n\t\tELSE\r\n\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\r\n\tEND",
            "action_id": 703,
            "action_name": "SelectAmount",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--EXEC sp_api_toast @parent_parent_id\n--exec sp_api_toast @User\n\t\nDECLARE @CTHID INT = {[ompakken].id} --200818 curly\nIF @CTHID IS NULL begin\n\t\tEXEC sp_api_toast 'Kan geen [ompakken] vinden'\n\t\tRETURN;\n\t\tend\n--ELSE EXEC sp_api_toast @CTHID\n\nIF {[ompakken].status} not in ('openRepack') BEGIN\n\tEXEC sp_api_modal_alert 'Toevoegen alleen bij status: openRepack'\n\tEXEC sp_api_modal_clear\t\t\n\tRETURN;\t\n\tend\n\n-- 200629 Uitbreiding inkoop vanuit diverse contexten: Zoek CTH ; bijv als we afkomstig zijn van een regel, dan is CTH te vinden in de regel\n--if @parent_card_name ='verkoop'\tset @CTHID=@parent_id\n--if @parent_card_name = 'ctr2' set @CTHID=(select TransactionHeader_ID from xtransactiondetail where xtransactiondetail.id=@parent_id)\n\nDECLARE @mes nvarchar(200), @FustSaldo int, @CoreType nvarchar(10),@FustID int, @xDesc nvarchar(200)\nSELECT @xDesc=x.[Description],@mes= concat('Ompak in ' , x.[Description]) ,@Coretype= x.coretype,@FustID=x.Fust_ID from xstock x where x.id=@ID --@main_db.dbo.\n--EXEC sp_api_modal_text @mes,'h2 text-primary'\n------\nIF @coretype in('CRATE','PALLET')\n\tBEGIN\n\t\tSELECT @Fustsaldo=Fustsaldo from @main_db.dbo.FustSaldo_FC(@FustID,{[verkoop].Counterparty_ID})\n\t\tEXEC sp_api_toast @Fustsaldo\n\t\t-- breid DECLARE message uit met het fust-saldo\n\t\tIF @FustSaldo is not NULL\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') actueel saldo bij deze klant: ',@fustsaldo)\n\t\tELSE\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') => let op: deze klant heeft dit fust nooit eerder gehad!')\n\tEND\n\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\nDECLARE @aantal nvarchar(20),@opmerking nvarchar(50) --='100'\nDECLARE @CounterpartyID int\nDECLARE @FlowModel int\nDECLARE @THDT INT \nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=FlowModel_ID,@THDT=TDT From xTransactionHeader CTH where CTH.ID=@CTHID\n--200630 was@parent_id\n\n--200708 => ??? WAAROM GAAT DIT NIET ??? select @Prijs= @main_db.dbo.StockPrice(@ID,@CTHID,NULL,NULL,NULL,NULL,NULL,NULL,NULL)\n\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\nEXEC sp_api_modal_text 'Aantal'\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1\nEXEC sp_api_modal_text 'Opm. loods'\nEXEC sp_api_modal_input @name='opmerking',@value = @opmerking OUT\nDECLARE @button nvarchar(128)\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\nIF @button IS NOT NULL\n\tBEGIN\n\t\tIF \t\t--TRY_CAST(@prijs as decimal) > 0 AND \n\t\t\t\tTRY_CAST(@aantal as int) > 0 \n\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\n\t\t\tBEGIN\n\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=NULL,@Logistic=@Opmerking, @User=@User, @forcedTDT=2\n\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\n\t\t\t\texec sp_api_toast @mes\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\n\t\t\tEND\n\t\tELSE\n\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\tEND ",
            "action_id": 704,
            "action_name": "SelectAmountIn",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--EXEC sp_api_toast @parent_parent_id\n--exec sp_api_toast @User\n\t\nDECLARE @CTHID INT = {[ompakken].id} --200818 curly\nIF @CTHID IS NULL begin\n\t\tEXEC sp_api_toast 'Kan geen [ompakken] vinden'\n\t\tRETURN;\n\t\tend\n--ELSE EXEC sp_api_toast @CTHID\n\nIF {[ompakken].status} not in ('openRepack') BEGIN\n\tEXEC sp_api_modal_alert 'Toevoegen alleen bij status: openRepack'\n\tEXEC sp_api_modal_clear\t\t\n\tRETURN;\t\n\tend\n\n-- 200629 Uitbreiding inkoop vanuit diverse contexten: Zoek CTH ; bijv als we afkomstig zijn van een regel, dan is CTH te vinden in de regel\n--if @parent_card_name ='verkoop'\tset @CTHID=@parent_id\n--if @parent_card_name = 'ctr2' set @CTHID=(select TransactionHeader_ID from xtransactiondetail where xtransactiondetail.id=@parent_id)\n\nDECLARE @mes nvarchar(200), @FustSaldo int, @CoreType nvarchar(10),@FustID int, @xDesc nvarchar(200)\nSELECT @xDesc=x.[Description],@mes= concat('Ompak in ' , x.[Description]) ,@Coretype= x.coretype,@FustID=x.Fust_ID from xstock x where x.id=@ID --@main_db.dbo.\n--EXEC sp_api_modal_text @mes,'h2 text-primary'\n------\nIF @coretype in('CRATE','PALLET')\n\tBEGIN\n\t\tSELECT @Fustsaldo=Fustsaldo from @main_db.dbo.FustSaldo_FC(@FustID,{[verkoop].Counterparty_ID})\n\t\tEXEC sp_api_toast @Fustsaldo\n\t\t-- breid DECLARE message uit met het fust-saldo\n\t\tIF @FustSaldo is not NULL\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') actueel saldo bij deze klant: ',@fustsaldo)\n\t\tELSE\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') => let op: deze klant heeft dit fust nooit eerder gehad!')\n\tEND\n\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\nDECLARE @aantal nvarchar(20),@opmerking nvarchar(50) --='100'\nDECLARE @CounterpartyID int\nDECLARE @FlowModel int\nDECLARE @THDT INT\nDECLARE @TDT int = 2\nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=FlowModel_ID,@THDT=TDT From xTransactionHeader CTH where CTH.ID=@CTHID\n--200630 was@parent_id\n\n--200708 => ??? WAAROM GAAT DIT NIET ??? select @Prijs= @main_db.dbo.StockPrice(@ID,@CTHID,NULL,NULL,NULL,NULL,NULL,NULL,NULL)\n\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\nEXEC sp_api_modal_text 'Aantal'\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1\nEXEC sp_api_modal_text 'Opm. loods'\nEXEC sp_api_modal_input @name='opmerking',@value = @opmerking OUT\nDECLARE @button nvarchar(128)\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\nIF @button IS NOT NULL\n\tBEGIN\n\t\tIF \t\t--TRY_CAST(@prijs as decimal) > 0 AND \n\t\t\t\tTRY_CAST(@aantal as int) > 0 \n\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\n\t\t\tBEGIN\n\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=NULL,@Logistic=@Opmerking, @User=@User, @forcedTDT=1\n\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\n\t\t\t\texec sp_api_toast @mes\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\n\t\t\tEND\n\t\tELSE\n\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\tEND",
            "action_id": 705,
            "action_name": "SelectAmountOut",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--EXEC sp_api_toast @parent_parent_id\n--exec sp_api_toast @User\n\nDECLARE @Repack_ID INT = {[xrepack].id} , @repack_card nvarchar(128)  = 'xrepack'\nIF @Repack_ID IS NULL\n\tBEGIN\n\t\tSET @Repack_ID = {[corrections].id} --200818 curly\n\t\tSET @repack_card = 'corrections'\n\tEND\nIF @Repack_ID IS NULL\n\tBEGIN\n\t\tEXEC sp_api_toast N'Repack ID bestaat niet!!!'\n\t\tRETURN\n\tEND\nDECLARE @cth1_id INT\nDECLARE @cth2_id INT\n\nEXEC @main_db.dbo.GetCTHForRepack @Repack_ID = @Repack_ID, @cth1_id = @cth1_id OUT, @cth2_id = @cth2_id OUT\n/*\nDECLARE @CTHID INT = {[xrepack].id} --200818 curly\nIF @CTHID IS NULL begin\n\t\tEXEC sp_api_toast 'Kan geen [ompakken] vinden'\n\t\tRETURN;\n\t\tend\n--ELSE EXEC sp_api_toast @CTHID\n*/\nIF {[xrepack].status} not in ('open_repack') BEGIN\n\tEXEC sp_api_modal_alert 'Toevoegen alleen bij status: open_repack'\n\tEXEC sp_api_modal_clear\t\t\n\tRETURN;\t\n\tend\n\n-- 200629 Uitbreiding inkoop vanuit diverse contexten: Zoek CTH ; bijv als we afkomstig zijn van een regel, dan is CTH te vinden in de regel\n--if @parent_card_name ='verkoop'\tset @CTHID=@parent_id\n--if @parent_card_name = 'ctr2' set @CTHID=(select TransactionHeader_ID from xtransactiondetail where xtransactiondetail.id=@parent_id)\n\nDECLARE @mes nvarchar(200), @FustSaldo int, @CoreType nvarchar(10),@FustID int, @xDesc nvarchar(200)\nSELECT @xDesc=x.[Description],@mes= concat('Geselecteerd artikel: ' , x.[Description]) ,@Coretype= x.coretype,@FustID=x.Fust_ID from xstock x where x.id=@ID --@main_db.dbo.\n--EXEC sp_api_modal_text @mes,'h2 text-primary'\n------\nIF @coretype in('CRATE','PALLET')\n\tBEGIN\n\t\tSELECT @Fustsaldo=Fustsaldo from @main_db.dbo.FustSaldo_FC(@FustID,{[verkoop].Counterparty_ID})\n\t\tEXEC sp_api_toast @Fustsaldo\n\t\t-- breid DECLARE message uit met het fust-saldo\n\t\tIF @FustSaldo is not NULL\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') actueel saldo bij deze klant: ',@fustsaldo)\n\t\tELSE\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') => let op: deze klant heeft dit fust nooit eerder gehad!')\n\tEND\n\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\nDECLARE @aantal nvarchar(20),@opmerking nvarchar(50) --='100'\n/*\nDECLARE @CounterpartyID int\nDECLARE @FlowModel int\nDECLARE @THDT INT \nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=FlowModel_ID,@THDT=TDT From xTransactionHeader CTH where CTH.ID=@CTHID\n*/\n--200630 was@parent_id\n\n--200708 => ??? WAAROM GAAT DIT NIET ??? select @Prijs= @main_db.dbo.StockPrice(@ID,@CTHID,NULL,NULL,NULL,NULL,NULL,NULL,NULL)\n--SET @aantal = TODO\n\nDECLARE @can_set_delayed BIT = 0 \nIF dbo.ABCDATE() < dbo.workDate() OR dbo.ABCDATE() < {[xrepack].PackDate}\nBEGIN\n\tSET @can_set_delayed = 1\nEND\nDECLARE @new_id INT\n\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\nEXEC sp_api_modal_text 'Aantal'\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1\nEXEC sp_api_modal_text 'Opm. loods'\nEXEC sp_api_modal_input @name='opmerking',@value = @opmerking OUT\nDECLARE @button nvarchar(128)\nEXEC sp_api_modal_button @name='button',@value = 'IN',@valueout = @button OUT,@class = 'btn-primary',@key = 'Pageup'\nEXEC sp_api_modal_button @name='button',@value = 'OUT',@valueout = @button OUT,@class = 'btn-primary',@key = 'Pagedown'\nIF @button = 'IN'\n\tBEGIN\n\t\tIF \t\t--TRY_CAST(@prijs as decimal) > 0 AND \n\t\t\t\tTRY_CAST(@aantal as int) > 0 \n\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\n\t\t\tBEGIN\n\t\t\t\texec @new_id = @main_db.dbo.CreateCTR @CTH_ID=@cth2_id, @stock_ID=@ID,@Amount=@Aantal,@Price=NULL,@Logistic=@Opmerking, @User=@User,@Repack_ID = @Repack_ID\n\t\t\t\t/* --Anaco Reserveerd geen ompakken. \n\t\t\t\tIF @new_id > 0 AND @can_set_delayed = 1\n\t\t\t\t\tBEGIN\n\t\t\t\t\tUPDATE xTransactionDetail SET delayed = @can_set_delayed WHERE id = @new_id\n\t\t\t\t\texec sp_api_toast N'Gereserveerd!'\n\t\t\t\t\tEND\n\t\t\t\t*/\n\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\n\t\t\t\texec sp_api_toast @mes\n\t\t\t\tEXEC sp_api_modal_clear\t\t\n\n\t\t\tEND\n\t\tELSE\n\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\tEND \nIF @button = 'OUT'\n\tBEGIN\n\t\tIF \t\t--TRY_CAST(@prijs as decimal) > 0 AND \n\t\t\t\tTRY_CAST(@aantal as int) > 0 \n\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\n\t\t\tBEGIN\n\t\t\t\texec @new_id = @main_db.dbo.CreateCTR @CTH_ID=@cth1_id, @stock_ID=@ID,@Amount=@Aantal,@Price=NULL,@Logistic=@Opmerking, @User=@User,@Repack_ID = @Repack_ID\n\t\t\t\t/* --Anaco Reserveerd geen ompakken. \n\t\t\t\tIF @new_id > 0 AND @can_set_delayed = 1\n\t\t\t\t\tBEGIN\n\t\t\t\t\tUPDATE xTransactionDetail SET delayed = @can_set_delayed WHERE id = @new_id\n\t\t\t\t\texec sp_api_toast N'Gereserveerd!'\n\t\t\t\t\tEND\n\t\t\t\t*/\n\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\n\t\t\t\texec sp_api_toast @mes\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\n\t\t\tEND\n\t\tELSE\n\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\tEND",
            "action_id": 706,
            "action_name": "SelectAmountRepack",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "UPDATE xTransactiondetail\r\nSET TDT = 1\r\nWHERE @id = id",
            "action_id": 709,
            "action_name": "SetIN",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "UPDATE xTransactiondetail\r\nSET TDT = 2\r\nWHERE id=@id",
            "action_id": 710,
            "action_name": "SetOUT",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @CTX nvarchar(50)=N'ctr_corrections'\nDECLARE @MarkID int = (SELECT ID FROM @main_db.dbo.xMarker WHERE Context = @ctx AND FKID=@ID)\n   IF @MARKID IS NULL\n\t   BEGIN\n\t\t\tINSERT INTO @main_db.dbo.xMarker (Context,FKID)\n\t\t\tVALUES (@ctx,@ID)\n\t   END\n   IF @MARKID IS NOT NULL\n\t   BEGIN\n\t\t\tDELETE FROM @main_db.dbo.xMarker WHERE id=@markid\n\t   END\t",
            "action_id": 712,
            "action_name": "Markeer",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128),@detail nvarchar(128),@aantal nvarchar(128),@text nvarchar(128)\nEXEC sp_api_modal_modal @class = 'w75'\nSET @date = dbo.workDate()\nSET @aantal = (SELECT stock from xstock where id = @id)\nSET @detail = (SELECT description from xstock where id = @id)\nSELECT @text = 'History van: ' + @detail + ' Huidige voorraad: ' + @aantal\nEXEC sp_api_modal_text 'INKOOP HISTORY', 'text-primary font-weight-bold text-center display-4'\nEXEC sp_api_modal_text @text, 'text-primary font-weight-bold text-center display-4'\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n--EXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\nSET @button = 'InkoopHistory'\n--EXEC sp_api_modal_button @name='button',@value = 'InkoopHistory',@valueout = @button OUT,@class = 'btn-primary',@key = '1'\n\nIF @button =  'InkoopHistory'\nBEGIN\n\tSELECT TOP 10 [Amount] = Amount,[Counterparty~col-sm-3] = Counterparty,[Verkocht aan] = MappedCompanies,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id\n\tINTO #InkoopHistory\n\tfrom Q_xTransactionDetail \n\t/*where TDT = 1 AND Stock_ID = @id*/ \n\twhere TDT = 1 AND Stock_ID = @id AND delayed != 1 AND TransactionHeader_ID not in (select id from q_xtransactionheader where specialType = 1001)\n\tORDER BY id DESC\n\tALTER TABLE #InkoopHistory\n\tDROP COLUMN [Stock_ID],[TDT]\n\tEXEC sp_api_modal_table @tmptable=N'#InkoopHistory',@orderby=N'ORDER BY TransactionDate DESC'\n\t\n\t\tIF (SELECT count(id) from Q_xTransactionDetail where TDT = 1 AND Stock_ID = @id AND delayed = 1) > 0\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_text ' ', 'mt-3'\n\t\t\tSELECT TOP 10 [Amount@g] = Amount,[Counterparty~col-sm-3] = Counterparty,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id,[Reserved*] = case WHEN delayed = 1 THEN 'RESERVED' WHEN delayed = 0 THEN '' END\n\t\t\tINTO #InkoopHistorydelayed\n\t\t\tfrom Q_xTransactionDetail \n\t\t\twhere TDT = 1 AND Stock_ID = @id AND delayed = 1 AND TransactionHeader_ID not in (select id from q_xtransactionheader where specialType = 1001)\n\t\t\tORDER BY id DESC\n\t\t\tALTER TABLE #InkoopHistorydelayed\n\t\t\tDROP COLUMN [Stock_ID],[TDT]\n\t\t\tEXEC sp_api_modal_table @tmptable=N'#InkoopHistorydelayed',@orderby=N'ORDER BY TransactionDate DESC'\n\t\tEND\t\nEND \n",
            "action_id": 713,
            "action_name": "Inkoop History",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128),@detail nvarchar(128),@aantal nvarchar(128),@text nvarchar(128)\nEXEC sp_api_modal_modal @class = 'w75'\nSET @date = dbo.workDate()\nSET @aantal = (SELECT stock from xstock where id = @id)\nSET @detail = (SELECT description from xstock where id = @id)\nSELECT @text = 'History van: ' + @detail + ' Huidige voorraad: ' + @aantal\nEXEC sp_api_modal_text 'VERKOOP HISTORY', 'text-primary font-weight-bold text-center display-4'\nEXEC sp_api_modal_text @text, 'text-primary font-weight-bold text-center display-4'\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n--EXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\nSET @button = 'VerkoopHistory'\n\nIF @button =  'VerkoopHistory'\nBEGIN\n\tSELECT TOP 20 [Amount] = Amount,[Counterparty] = Counterparty,[MappedCompanies] = MappedCompanies,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id\n\tINTO #VerkoopHistory\n\tfrom Q_xTransactionDetail \n\twhere TDT = 2 AND Stock_ID = @id and delayed != 1 AND TransactionHeader_ID not in (select id from q_xtransactionheader where specialType = 1001)--AND dbo.daysago(TransactionDate,NULL) < 1\n\tORDER BY id DESC\n\tALTER TABLE #VerkoopHistory\n\tDROP COLUMN [Stock_ID],[TDT]\n\tEXEC sp_api_modal_table @tmptable=N'#VerkoopHistory',@orderby=N'ORDER BY TransactionDate DESC'\n\t\n\t\t\nIF (SELECT count(id) from Q_xTransactionDetail where TDT = 2 AND Stock_ID = @id and delayed = 1) > 0\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_text ' ', 'mt-3'\n\t\t\tSELECT [Amount@g] = Amount,[Counterparty] = Counterparty,[MappedCompanies] = MappedCompanies,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id,[Opmerking] = logistic,[Reserved*] = case WHEN delayed = 1 THEN 'GERESERVEERDE VERKOOP' WHEN delayed = 0 THEN '' END\n\t\t\tINTO #VerkoopHistorydelayed\n\t\t\tfrom Q_xTransactionDetail \n\t\t\twhere TDT = 2 AND Stock_ID = @id and delayed = 1 AND TransactionHeader_ID not in (select id from q_xtransactionheader where specialType = 1001)\n\t\t\t--AND dbo.daysago(TransactionDate,NULL) < 1\n\t\t\tORDER BY id DESC\n\t\t\tALTER TABLE #VerkoopHistorydelayed\n\t\t\tDROP COLUMN [Stock_ID],[TDT]\n\t\t\tEXEC sp_api_modal_table @tmptable=N'#VerkoopHistorydelayed',@orderby=N'ORDER BY TransactionDate DESC'\n\t\tEND\nEND \n",
            "action_id": 714,
            "action_name": "Verkoop History",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@date2 nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128)\nset @date = dbo.workDate()\nset @date2 = dbo.workDate()\n\nEXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24' -- zoek veld\n\nSET @button = 'Correctiebon'\nEXEC sp_api_modal_button @name='button',@value = 'Correctiebon',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_button @name='button',@value = 'CorrectiebonVolledig',@valueout = @button OUT,@class = 'btn-primary',@key = 'F2'\nEXEC sp_api_modal_print\nEXEC sp_api_modal_text N'Correctie Bon',N'h4 text-muted',@print=1\n\n/* [Amount~col-sm-1] = [Amount],[detailgroup*] = [detail],[CorID],[KGN*] = concat('KGN ',[KGN]),[KGB*] = concat('KGB ',[KGB]),[Size] = [Size], [Origin*] = [Origin_Code], [Brand*] = [xBrandCode], [Contentdesc*] = [ContentDesc], [logistic~col-sm-4] = [logistic],[User~col-sm-2] = [User], \n[Veranderd op~col-sm-2] = FORMAT([Veranderd op],'dd MMM yyyy HH:mm'),[verschil] */\n\n\nIF @button =  'Correctiebon'\nBEGIN\nselect \n[verschil~col-sm-1] = [verschil],[Artikel~col-sm-4] = concat([detail],' ',[Size],' ',[Origin_Code],' ',[xBrandCode],' ',[ContentDesc]),[CorID],[logistic] = [logistic],[User~col-sm-2] = [User], \n[Veranderd op~col-sm-2] = FORMAT([Veranderd op],'dd MMM yyyy HH:mm')\nINTO #CorrectieBon\nFROM CODE_CorrectieBon\nwhere CorID in (select Repack_ID from Q_xTransactionDetail) AND (datum BETWEEN @from AND @to) and Status = 'open_correction' \nAND EXISTS (SELECT * FROM @main_db.dbo.xMarker WHERE Context = N'ctr_corrections' AND FKID=CTR_ID)\nALTER TABLE #CorrectieBon\nDROP COLUMN [CorID]\nEXEC sp_api_modal_table @tmptable=N'#CorrectieBon',@orderby=N'ORDER BY 2 ASC',@print=1 -- @fontsize='90%'\n--EXEC sp_api_modal_table @tmptable=N'#OpenOmpakLijst',@orderby=N'ORDER BY [TID*],[cthkgninCAP*],[cthkgnin*],[seperate*],[cthkgnout CAP*],[cthkgnout*],3 ASC',@print=1\nEND \n\nIF @button =  'CorrectiebonVolledig'\nBEGIN\nselect \n[verschil~col-sm-1] = [verschil],[Artikel~col-sm-4] = concat([detail],' ',[Size],' ',[Origin_Code],' ',[xBrandCode],' ',[ContentDesc]),[CorID],[logistic] = [logistic],[User~col-sm-2] = [User], \n[Veranderd op~col-sm-2] = FORMAT([Veranderd op],'dd MMM yyyy HH:mm')\nINTO #CorrectiebonVolledig\nFROM CODE_CorrectieBon\nwhere CorID in (select Repack_ID from Q_xTransactionDetail) AND (datum BETWEEN @from AND @to) and Status = 'open_correction' \nALTER TABLE #CorrectiebonVolledig\nDROP COLUMN [CorID]\nEXEC sp_api_modal_table @tmptable=N'#CorrectiebonVolledig',@orderby=N'ORDER BY 2 ASC',@print=1 -- @fontsize='90%'\n--EXEC sp_api_modal_table @tmptable=N'#OpenOmpakLijst',@orderby=N'ORDER BY [TID*],[cthkgninCAP*],[cthkgnin*],[seperate*],[cthkgnout CAP*],[cthkgnout*],3 ASC',@print=1\nEND \n",
            "action_id": 715,
            "action_name": "Correctie bon",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--RH210121 Extra claimrecord maken\nset @Counterparty={[verkoop].Counterparty_ID}\nset @CTR={[ctr2].ID}\n\nif {[ctr2].Amount} is not null --we zitten op ctr2\n\tAND @Counterparty is not null \n\tbegin\n\t\tselect @CTH=transactionheader_id,@Claimamount=ctr.amount,@ClaimPrice=ctr.Price from xtransactiondetail ctr where ctr.id=@CTR\n\t\tExecute @NewClaim_ID=@main_db.dbo.CreateClaim @ctr_id=@CTR, @ClaimAmount=@ClaimAmount, @Claimprice=@ClaimPrice, @Client_ID=@Counterparty,@cth_id=@CTH,@user_name=@user_name\n\t\t\n\t\tSET @path = concat(@path,'/',@NewClaim_ID)\t\t\n\t\tEXEC sp_api_goto @path\n\t\t\n\tend\n\n",
            "action_id": 719,
            "action_name": "Extra Claim registreren",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @F_ReductionPerc decimal(18,2)\nEXEC sp_api_modal_input_decimal @name='Percentage', @value= @F_ReductionPerc OUT,@focus=1\n\nEXEC sp_api_modal_button @name='@button',@value = 'Opslaan', @valueout = @button OUT,@class='btn-danger',@key='Enter'\n\nIF @button IS NOT NULL AND @F_ReductionPerc IS NULL EXEC sp_api_modal_text N'Ongeldige waarde'\nIF @button IS NOT NULL AND @F_ReductionPerc IS NOT NULL\n\tBEGIN\n\t\tDECLARE @cursor CURSOR,@idval INT\n\t\tSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\n\t\tOPEN @cursor;\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\n\t\t\t\tUPDATE xCompany SET F_ReductionPerc = case when @F_ReductionPerc<0 then -1 * @F_ReductionPerc else @F_ReductionPerc end WHERE id = @idval\n\t\t\t\tUPDATE xcompanycostsettings SET setting = case when @F_ReductionPerc>0 then -1 * @F_ReductionPerc else @F_ReductionPerc end\n\t\t\t\t\tWHERE xCompany_ID =@idval and xCompanyLinkField=N'F_ReductionPerc'\n\t\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\tEND\n\t\tCLOSE @cursor;\n\t\tDEALLOCATE @cursor;\n\t\tEXEC sp_api_modal_clear\n\t\tEXEC sp_api_modal_select_all_clear\n\tEND",
            "action_id": 722,
            "action_name": "Korting op factuur",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "SET @path = CONCAT(@path,'/',@ID,'/ctr2/0/stock_ctr2')\nEXEC sp_api_goto @path",
            "action_id": 726,
            "action_name": "Regels toevoegen",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 730,
            "action_name": "Nieuwe op basis van Clone",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 734,
            "action_name": "nieuw bedrijf via Clone",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @sys_report_key nvarchar(50) = N'purchase_order'\ndeclare @test bit =1 -- 0:LIVE ; 1=TEST\nEXEC sp_api_toast @sys_report_key--N'Orderbevestiging' \n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\t--EXEC sp_api_toast @cid\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select Counterparty_id from xtransactionheader where id=@cid)\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = @sys_report_key--'confirmation_out' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@test=@test\n\n\t\t--dit is nu alleen voor tellers en checks:\n\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'CTH'\t,@Context_Key_ID=@cid,@Report_CODE=N'CONF'\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 742,
            "action_name": "Inkoop order",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_text @uri\nEXEC sp_api_modal_table @tmptable='#context'",
            "action_id": 746,
            "action_name": "Params",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @claimAmount int\nDECLARE @claimPrice float\nDECLARE @retourAmount int\nDECLARE @ctrAmount float\nDECLARE @ctrPrice float\n\nSET @ctrPrice = {[xclaim].ctr_price}\n\n\nSELECT @ctr_id = ctr_id\n \t\t,@claimReason = claimReason\n \t\t,@claimAmount = ISNULL(claimAmount,0)\n \t\t,@claimPrice = claimPrice\n \t\t,@retourAmount = ISNULL(retourAmount,0)\n \t\t--,@Description = Description\n \t\t,@client_id = client_id\n \t\t,@cth_id = cth_id\n \t\t,@counter_ctr_id = counter_ctr_id\n \t\t,@new_ctr_id = new_ctr_id FROM xClaim WHERE id = @id\n\n-- RH210212 ALS HET EEN INKOOPP CTH IS DAN HIER AFBREKEN MET EEN MELDING??... want dit is verkoop claim afhandeling..\n\nIF @claimAmount > 0 AND (@claimPrice = @ctrPrice OR @claimPrice IS NULL)\n\tBEGIN\n\t\tEXEC sp_api_modal_clear N'Prijs is nul icm korting aantal!'\n\t\tRETURN\n\tEND\n\n \nIF @new_ctr_id IS NOT NULL OR @counter_ctr_id IS NOT NULL\n\tBEGIN\n\t\tEXEC sp_api_modal_clear N'Claim is reeds afgehandeld' \n\t\tRETURN\n\tEND\n--SET @ctr_id = {[xclaim].ctr_id}\nSET @ctrAmount = {[xclaim].ctr_amount}\nSET @Description = {[xclaim].Description}\n/*SET @claimReason = {[xclaim].claimReason}*/\nSET @class = N'h5 text-muted'\nSET @text = CONCAT(N'Claim afhandelen - ',@Description)\nEXEC sp_api_modal_text @text,N'h3 text-muted'\n\nSET @text = CONCAT(N'Claim reden: ',@claimReason)\nEXEC sp_api_modal_text @text,@class\n\nSET @text = CONCAT(N'Korting aantal: ',@claimAmount)\nEXEC sp_api_modal_text @text,@class\n\nSET @text = CONCAT(N'Retour aantal: ',@retourAmount)\nEXEC sp_api_modal_text @text,@class\n\nSELECT id,[Leverancier ] = Leverancier,[LinkAantal ]=LinkAantal,Retour = 0,Korting = 0  INTO #ivlink FROM Q_IVLINK WHERE ITD = @ctr_id ORDER BY id\nUPDATE #ivlink SET Retour = @retourAmount,Korting = @claimAmount WHERE id = (SELECT min(id) FROM #ivlink)\nEXEC sp_api_modal_table_update @tmptable='#ivlink',@focusx=3\n\nDECLARE @claimAmountTodo int = @claimAmount\nDECLARE @retourAmountTodo int = @retourAmount\n\nDECLARE @isOk BIT = 1\nDECLARE @cursor CURSOR,@idval int,@LinkAantal int,@Retour int,@Korting int\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT id,[LinkAantal ],Retour,Korting FROM #ivlink\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @idval,@LinkAantal,@Retour,@Korting\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tIF((@Retour + @Korting) > @LinkAantal) OR @Retour < 0 OR @Korting < 0  SET @isOk = 0\n\t\tSET @claimAmountTodo-=@Korting\n\t\tSET @retourAmountTodo-=@Retour\n\t\tFETCH NEXT FROM @cursor INTO @idval,@LinkAantal,@Retour,@Korting\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\nSET @button_text = 'Verwerken'\nEXEC sp_api_modal_button @name='@button',@value = @button_text, @valueout = @button OUT,@class='btn-primary',@key='Enter'\nSET @class = N'h5 text-danger'\nIF @isOk = 0 EXEC sp_api_modal_text N'De verdeling is nog incorrect!',@class\nIF @claimAmountTodo <> 0 EXEC sp_api_modal_text N'De korting verdeling is incorrect!',@class\nIF @retourAmountTodo <> 0 EXEC sp_api_modal_text N'De retour verdeling is incorrect!',@class\n\nIF @button = @button_text AND @isOk = 1 AND @claimAmountTodo = 0 AND @retourAmountTodo = 0\n\tBEGIN\n\t\t--EXEC sp_api_modal_table @tmptable='#ivlink'\n\n\t\tSET @claim_cth_id = (SELECT min(id) FROM xTransactionHeader WHERE CounterParty_ID = @client_id AND status IN('openClaim','ReadyForInvoice') AND specialType = 1001)\n\t\t--SELECT @xIVLINKs = STRING_AGG(CAST(id as nvarchar(max)),',') FROM xIVLINK WHERE ITD = @ctr_id\n\n\t\tIF @claim_cth_id IS NULL\n\t\t\tBEGIN\n\t\t\t\t--DECLARE @specialType int = @main_db.dbo.CthSpecialType('claim')\n\t\t\t\tEXEC @claim_cth_id = @main_db.dbo.CreateCTH2 @Client_ID = @client_id,@Status = 'ReadyForInvoice',@specialType = 'claim'\n\t\t\tEND\n\n\t\tIF @counter_ctr_id IS NULL\n\t\t\tBEGIN\n\t\t\t\tSET @set = CONCAT(N'stockMut=1,Amount = -Amount,TransactionHeader_ID = ',@claim_cth_id)\n\t\t\t\tEXEC @counter_ctr_id = sp_clone_record N'xTransactionDetail',@ctr_id,@set\n\t\t\t\tUPDATE xClaim SET counter_ctr_id = @counter_ctr_id WHERE id = @id\n\t\t\tEND\n\t\tIF @claimAmount > 0\n\t\t\tBEGIN\n\t\t\t\tSET @set = CONCAT(N'stockMut=1,Amount = ',@claimAmount,',Price=',@claimPrice,',TransactionHeader_ID = ',@claim_cth_id)\n\t\t\t\tEXEC @new_ctr_id = sp_clone_record N'xTransactionDetail',@ctr_id,@set\n\t\t\t\tUPDATE xClaim SET new_ctr_id = @new_ctr_id WHERE id = @id\n\t\t\tEND\n\t\tDECLARE @NietRetour int = (@ctrAmount - @claimAmount) - @retourAmount\n\t\tIF @NietRetour > 0\n\t\t\tBEGIN\n\t\t\t\tSET @set = CONCAT(N'stockMut=1,Amount = ',@NietRetour,',Price=',@ctrPrice,',TransactionHeader_ID = ',@claim_cth_id)\n\t\t\t\tEXEC @new_retour_ctr_id = sp_clone_record N'xTransactionDetail',@ctr_id,@set\n\t\t\t\tUPDATE xClaim SET new_ctr_id = @new_retour_ctr_id WHERE id = @id\n\t\t\tEND\n\t\t\n\n\t\tSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT id,[LinkAantal ],Retour,Korting FROM #ivlink\n\t\tOPEN @cursor;\n\t\tFETCH NEXT FROM @cursor INTO @xIVLINK_id,@LinkAantal,@Retour,@Korting\n\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\n\t\t\t\tIF @LinkAantal > 0\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tSET @set = CONCAT(N'LinkAantal = -',@LinkAantal,',SK_ID = NULL, ITD = ',@counter_ctr_id)\n\t\t\t\t\t\tEXEC sp_clone_record N'xIVLINK',@xIVLINK_id,@set\n\t\t\t\t\tEND\n\t\t\t\tIF @Korting > 0\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tSET @set = CONCAT(N'LinkAantal = ',@Korting,',SK_ID = NULL, ITD = ',@new_ctr_id)\n\t\t\t\t\t\tEXEC sp_clone_record N'xIVLINK',@xIVLINK_id,@set\n\t\t\t\t\tEND\n\t\t\t\tIF @Retour < (@LinkAantal - @Korting)\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tSET @NietRetour = (@LinkAantal - @Korting) - @Retour\n\t\t\t\t\t\tSET @set = CONCAT(N'LinkAantal = ',@NietRetour,',SK_ID = NULL, ITD = ',@new_retour_ctr_id)\n\t\t\t\t\t\tEXEC sp_clone_record N'xIVLINK',@xIVLINK_id,@set\n\t\t\t\t\tEND\n\t\t\t\tFETCH NEXT FROM @cursor INTO @xIVLINK_id,@LinkAantal,@Retour,@Korting\n\t\t\tEND\n\t\tCLOSE @cursor;\n\t\tDEALLOCATE @cursor;\n\t\tEXEC sp_api_modal_post N'xclaim','status','Processed',@id\n\t\tEXEC sp_api_modal_save N'xclaim',@id\n\t\tEXEC sp_api_modal_clear\n\t\t\n\tEND\n",
            "action_id": 751,
            "action_name": "Afhandelen",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "SET @referenced_card_id = {[api_card_templates].referenced_card_id.name}\nDECLARE @search nvarchar(2000) = CONCAT('[',@referenced_card_id,'].'),@button nvarchar(128)\n\nEXEC sp_api_modal_select_curly @value = @search OUT\nEXEC sp_api_modal_text N'',@class=N'm-3'\nEXEC sp_api_modal_button @name='button',@value=N'Insert',@valueout=@button OUT,@key='Insert'\nIF @button IS NOT NULL\n\tBEGIN\n\t\tEXEC sp_api_modal_clear\n\t\tSET @search=N'{'+@search+'}'\n\t\tEXEC sp_api_modal_field_insert @card_field_id,@search\n\tEND",
            "action_id": 754,
            "action_name": "Curly insert",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "SET @referenced_card_id = {[api_card_templates].referenced_card_id}\nEXEC sp_api_modal_select @card_id = @referenced_card_id,@value = @preview_id OUT,@focus = 1\nIF @preview_id IS NOT NULL\n\tBEGIN\n\t\tEXEC sp_api_modal_post N'api_card_templates',N'preview_id',@preview_id,@id\n\t\tEXEC sp_api_modal_save N'api_card_templates',@id\n\t\tEXEC sp_api_modal_clear\n\tEND\n",
            "action_id": 761,
            "action_name": "Select preview",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @set nvarchar(max) = N'lng=null'\n\nEXEC sp_api_modal_alert N'Clone',N'Create a clone of this record?'\nDECLARE @clone_id nvarchar(32)\nEXEC @clone_id = sp_clone_record @basetable,@ids,@set=@set\nEXEC sp_api_modal_clear\nSET @path = @path+'/'+@clone_id\nEXEC sp_api_modal_text N'Record cloned',N'h4 text-muted'\nEXEC sp_api_modal_route @name = N'Go to clone',@pathname=@path,@key='Enter'\n",
            "action_id": 764,
            "action_name": "sys_clone",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "\nEXEC sp_api_modal_download_report @context = 'anaco_invoice_FV',@context_id = @id\n\n/*SELECT @RequestKey = RequestKey FROM api_report_server_log WHERE MetaReportName LIKE 'anaco_invoice_FV' AND MetaContextID = @id\nEXEC sp_api_modal_text @RequestKey\nDECLARE @file varbinary(max)\nEXEC sp_api_report_server_download 'b7cb4d42-4245-43a0-b74f-55f2f96b35ce',@file OUT\n*/\n--EXEC sp_api_report_server_download @RequestKey,@file OUT\n\n--EXEC sp_api_modal_download @filename='geert.pdf',@mimetype='application/pdf',@rawdata = @rawdata",
            "action_id": 767,
            "action_name": "Download invoice",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @CTR_ID int = {[xFustreturned].ReturnCTR_ID}\ndeclare @invoice_id int = {[xFustreturned].invoice_id}\ndeclare @CTH_ID int = (select transactionheader_id from xtransactiondetail where id=@CTR_ID )\nif @CTH_ID >0\n\tbegin\n\t\tif @invoice_id is null\n\t\t--210206 was: (select status from xtransactionheader where id=@CTH_ID AND SpecialType=@main_db.dbo.CthSpecialtype('fust') )=N'ReadyForInvoice' -- alleen UNDO mogelijk als het retour nog niet gefactureerd is!\n\t\t\tbegin\n\t\t\t\tupdate xtransactiondetail set amount=0 where id=@CTR_ID\n\t\t\t\tupdate xfustreturned set Amount=0 where id=@id\n\t\t\t\tdelete from xfustreturned where id=@id\n\t\t\t\tdelete from xtransactiondetail where id=@CTR_ID\n\t\t\t\t--210206 ook cth verwijderen als er geen fustregels meer zijn\n\t\t\t\tif not exists (select * from xtransactiondetail where transactionheader_id=@cth_id) execute @main_db.dbo.deleteCTH @CTHID=@CTH_ID\n\t\t\tend\n\t\telse execute sp_api_toast N'KAN NIET MEER ONGEDAAN GEMAAKT WORDEN (AL GEFACTUREERD?)'\t\t\n\tend",
            "action_id": 776,
            "action_name": "Undo",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--RH210131 Boek retourfust in order die direct klaar staat voor facturatie\n--Er is nu geen toewijzing nodig voor fust, maar dit komt eventueel nog wel..\n--Transport wordt geskipped\n\nDECLARE @company_id nvarchar(32),@button nvarchar(128),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000)\nDECLARE @RetourAantal int -- moet altijd NEGATIEF worden (gemaakt)\nDECLARE @STOCKID int --fustdrager van het fust\nSET @b1_text = N'Fust Retour Boeken'\nset @b3_text = N'Verwerk de retourboeking'\n--SELECT_CUSTOMER:\n--set @company_id={[verkoop].Counterparty_ID}\n--if @company_id is null \nEXEC sp_api_modal_select @name = 'klant_submit', @card_name = N'klant',@value = @company_id OUT,@focus = 1\n\tif @company_id > 0 AND not exists(select * from @main_db.dbo.tf_code_FustSaldo(@Company_ID) )--where FustSaldo <> 0) \n\t\tbegin\n\t\t\texec sp_api_modal_text N'Klant heeft geen fustsaldo'\n--\t\t\tRETURN\n\t\t\tEXEC sp_api_modal_clear\n\t\t\tEXEC sp_api_modal_button @name = 'klant_submit',@value = 'Opnieuw zoeken', @valueout = @button4 OUT ,@class='btn-danger',@key='Enter'\n--\t\t\tIF @button4 = 'Opnieuw zoeken' GOTO SELECT_CUSTOMER;\n\t\t\tRETURN\n\t\tend\t\nIF @company_id > 0\nBEGIN\n--\tEXEC sp_api_modal_button @name='@button1',@value=@b1_text,@valueout = @button1 OUT,@key='Insert'\n\n--\tIF @button1 = @b1_text\n--\t\tBEGIN\n\n\t\t\t\n\n\t\t\tEXEC sp_api_modal_clear --verwijder button1\n\t\t\tset @head_1 = concat(N'Geef het retour-aantal per fustsoort in voor klant ',(select companyname from xcompany where id=@company_id))\n\t\t\texec sp_api_modal_text @head_1\n\t\t\tselect id=fust_id, [Retour]=0, [Saldo ]=FustSaldo,\t[Fustcode ]=FUSTCODE\n\t\t\tINTO #modalupdate from @main_db.dbo.tf_code_FustSaldo(@Company_ID) \n\t\t\tEXEC sp_api_modal_table_update @tmptable = N'#modalupdate',@addnew=0\n\n\n\t\t\t--test: toon de temp data\n\t\t\t--EXEC sp_api_modal_table @tmptable = N'#modalupdate', @print=1\n\t\t\t\n\n\t\t\t\n\t\t\t-- hier heb je bijgewerkte data\n\t\t\tset @b2_text = 'Refresh' \n\t\t\tEXEC sp_api_modal_button @name='@button2',@value = @b2_text, @valueout = @button2 OUT ,@class='btn-danger',@key='Enter'\n\t\t\tIF @button2 is null RETURN\n\t\t\t--EXEC sp_api_modal_clear\n\n\t\t\t--210208 opmerking er bij\n\t\t\tEXEC sp_api_modal_input @name='Referentie/datum fustretour',@value = @opmerking OUT\t\t\t\n\t\t\tEXEC sp_api_modal_button @name='@button3',@value=@b3_text,@valueout = @button3 OUT,@key='F10'\n\t\t\t\n\t\t\tif @button3=@b3_text AND EXISTS(select * from #modalupdate where isnull(retour,0) <> 0 )\n\t\t\t\tbegin\n\t\t\t\t\n\t\t\t\t--zorg voor een CTH (kop)\n\t\t\t\t\tSET @new_id = (SELECT TOP 1 id FROM xTransactionHeader WHERE status=N'ReadyForInvoice' AND CounterParty_ID = @company_id AND Specialtype=1002 ORDER BY id DESC)\n\t\t\t\t\tif @new_id > 0 GOTO JMP_1;\n\t\t\t\t\tif @new_id is NULL \n\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\t--210131 direct aanmaken van de CTH in status ReadyForInvoice...\n\t\t\t\t\t\t\texecute @main_db.dbo.[CreateCTH2] @Client_ID= @company_id\n\t\t\t\t\t\t\t\t\t\t\t\t\t,@new_identity =@new_id OUT\n\t\t\t\t\t\t\t\t\t\t\t\t\t,@Status = N'ReadyForInvoice'\n\t\t\t\t\t\t\t\t\t\t\t\t\t,@xCludeLFCTH = 0\n\t\t\t\t\t\t\t\t\t\t\t\t\t,@Specialtype='fust' --,@Specialtype=1002 --'fust'\n\t\t\t\t\t\t\t\t\t\t\t\t\t,@Relation=@Opmerking -- referentie voor op de factuur aan de klant\n\t\t\t\t\t\tend\n\t\t\t\t\n\t\t\t\t\tJMP_1:\n\t\t--\t\t\t======\n\t\t\t\t\n\t\t\t\t \t--cursortje om de regels te verwerken\n\t\t\t\t\tDECLARE @checkid int\n\t\t\t\t\t\t\t,@Retour int\n\t\t\t\t\t\t\t,@ReturnCTR_ID int\n\t\t\t\t\tDECLARE @cursor_xCTH_Check CURSOR\n\t\t\t\t\tSET @cursor_xCTH_Check = CURSOR LOCAL FAST_FORWARD FOR\n\t\t\t\t\t\tSELECT id, Retour FROM #modalupdate \n\t\t\t\t\t\tOPEN @cursor_xCTH_Check;\n\t\t\t\t\t\tFETCH NEXT FROM @cursor_xCTH_Check INTO\n\t\t\t\t\t\t\t@checkid\n\t\t\t\t\t\t\t,@Retour\n\t\t\t\t\t\tWHILE @@FETCH_STATUS = 0\n\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\tif @main_db.dbo.isInteger(@Retour) =1 \n\t\t\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\t\t\tset @RetourAantal = convert(int,@Retour) --exec sp_api_TOAST @retour\n\t\t\t\t\t\t\t\t\tif @RetourAantal > 0 SET @RetourAantal = -1* @RetourAantal -- maak negatief\n\t\t\t\t\t\t\t\t\tif @RetourAantal < 0 -- let op: kan hierboven net negatief zijn gemaakt !!\n\t\t\t\t\t\t\t\t\t\tbegin --retourboeking!\n\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\tExecute @StockID=@main_db.dbo.Fust_To_StockID @CheckID --LET OP STOREC PROC ALS FUNTIE MISBRUIKT haal/maak-en-haal de fustdrager \n\t\t\t\t\t\t\t\t\t\t\tif @StockID >0\n\t\t\t\t\t\t\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\t\t\t\t\t\t\tset @ReturnCTR_ID = NULL -- reset steeds\n\t\t\t\t\t\t\t\t\t\t\t\t\texecute @main_db.dbo.CreateCTR  @CTH_ID=@new_id\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,@Stock_ID=@StockID\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t--,@advPalletType_ID=1\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,@Amount=@RetourAantal\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,@Detail=N'retour fust'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,@Price=0\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,@new_identity = @ReturnCTR_ID OUTPUT\n\t\t\t\t\t\t\t\t\t\t\t\t\tif @ReturnCTR_ID >0\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tif not exists( select id from xFustReturned\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\twhere Company_ID = @company_id\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tand Fust_ID = @checkid\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tand ReturnCTR_ID = @ReturnCTR_ID\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tand Amount = @RetourAantal   --and Username,Date,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tand Stock_ID = @StockID)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tinsert into xFustReturned(Company_ID,Fust_ID,ReturnCTR_ID,Amount,Username,Date,Stock_ID)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvalues(@company_id,@checkid,@ReturnCTR_ID,@RetourAantal,@user_name,GETDATE(),@StockID)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tend\t\t\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\tend\t\t\n\t\t\t\t\t\t\t\t\t\tend\n\t\t\t\t\t\t\t\tend\t\n\t\t\t\t\n\t\t\t\t\t\t\tFETCH NEXT FROM @cursor_xCTH_Check INTO\n\t\t\t\t\t\t\t\t@checkid\n\t\t\t\t\t\t\t\t,@Retour\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\tEND\n\t\t\t\t\tCLOSE @cursor_xCTH_Check;\n\t\t\t\t\tDEALLOCATE @cursor_xCTH_Check;\n\t\t\n\t\t\t\tEXEC sp_api_modal_clear\n\n/*\n\t\t\t\t--TOON EVENTUEEL DE FUSTREGELS IN DE RETOURBOEKING\n\t\t\t\tSET @goto = N'/verkoop/'+@new_id+'/ctr2'\n\t\t\t\t\tSET @search = N'?id='+@new_id\n\t\t\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/verkoop',@referer_search=@search\n\t\n*/\t\t\t\t\t\n\t\t\tend\n\t\t\nEND",
            "action_id": 788,
            "action_name": "Fust_Inname",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @sys_report_key nvarchar(50) = N'purchase_order'\ndeclare @test bit =1 -- 0:LIVE ; 1=TEST\nEXEC sp_api_toast @sys_report_key--N'Orderbevestiging' \n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\t--EXEC sp_api_toast @cid\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select Counterparty_id from xtransactionheader where id=@cid)\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = @sys_report_key--'confirmation_out' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@test=@test\n\n\t\t--dit is nu alleen voor tellers en checks:\n\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'CTH'\t,@Context_Key_ID=@cid,@Report_CODE=N'CONF'\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 789,
            "action_name": "Inkoop order",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @Sys_Report_Key nvarchar(50) = N'sales_pricelist'\ndeclare @test int =0\ndeclare @text1 nvarchar(200)= concat(N'prijslijst voor context ',@id)\ndeclare @toCompany_ID int\n\nexec sp_api_toast @text1\n\n\t\tSET @toCompany_ID = {[t_commcontact].xCompany_id} --(select Counterparty_id from xtransactionheader where id=@cid)\n\n\t\tEXEC sp_api_report_generate @id = @id --@cid\n\t\t\t,@sys_report_key = @Sys_Report_Key--'picklist' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n--210202 FIXED MOET IN REPDEF WORDEN INGESTELD ...\t\t\t,@FixedRepAction_ID=@FixedRepAction_ID --210102 Je kan nu hard een id mee geven \n\t\t\t,@test = @test --hiermee schakel je tussen productie en test-modus\n--\t\t\t,@fixedEmail =N'rick12@tracy.nu'\n\t\t\t\n",
            "action_id": 796,
            "action_name": "Test een prijslijst",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.ExtraVracht @ID",
            "action_id": 803,
            "action_name": "Extra Vracht Maken",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.[LF_Voltooien] @ID",
            "action_id": 805,
            "action_name": "Landfreight Voltooien",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "update xlandfreight SET transport_id = NULL WHERE id ={[xlandfreight].id}",
            "action_id": 806,
            "action_name": "Maak Los Van Transport",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXECUTE @main_db.dbo.RebuildLandfreight @ID ",
            "action_id": 809,
            "action_name": "RebuildLandfreight",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "set @testmodus =1 --0=live; 1=test!\n\nEXEC sp_api_toast N'Transport-instructie naar Transporteur' \nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\t--dit is nu alleen voor tellers en checks:\n\n\t\t--even niet registreren dat er wordt afgedrukt\n\t\t--EXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'LF'\t,@Context_Key_ID=@cid,@Report_CODE=N'TRANSPORT' --transportorder\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = {[xlandfreight].transportCompany_ID}\n\t\t--DECLARE @error INT\n\t\t\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = 'transport-out' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@test=@testmodus\n\t\t\t\n\t\t--IF @error > 0 RAISERROR(N'Er is een probleem')\n\t\t\n\t\t--set @reptxt=concat(N'to transporter: ',@toCompany_ID)\n\t\t--execute sp_api_toast @reptxt\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 811,
            "action_name": "Transportorder",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @delresult int\nexec @DelResult=@main_db.dbo.[Delete_LF_IF_NO_LFCTR] @ID\nif @DelResult = -1\n\texec sp_api_Toast N'Er kan geen landfreight worden verwijderd, omdat er nog detailregels bestaan'\nEXEC sp_api_go2\n",
            "action_id": 813,
            "action_name": "Verwijder Landfreight",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @cth_id int = @id\n\nIF EXISTS (SELECT * FROM xTransactionHeader WHERE id = @cth_id AND status IN('ReadyForInvoice','openClaim') AND specialType = @main_db.dbo.CthSpecialType('claim'))\n\tBEGIN\n\t\tEXEC sp_api_modal_alert N'Waarschuwing!',N'Alle claimregels van deze kop worden verwijderd en de claim status gaat terug naar ''New'''\n\t\tDECLARE @cursor CURSOR,@idval INT\n\t\tSET @cursor = CURSOR LOCAL FAST_FORWARD FOR\n\t\t\tSELECT id FROM xClaim WHERE counter_ctr_id IN (SELECT id FROM xTransactionDetail WHERE TransactionHeader_ID = @cth_id)\n\t\tOPEN @cursor;\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\n\t\t\t\tUPDATE xClaim SET status = 'New',counter_ctr_id = NULL,new_ctr_id = NULL WHERE id = @idval\n\t\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\tEND\n\t\tCLOSE @cursor;\n\t\tDEALLOCATE @cursor;\n\n\t\tSET @cursor = CURSOR LOCAL FAST_FORWARD FOR\n\t\t\tSELECT id FROM xTransactionDetail WHERE TransactionHeader_ID = @cth_id\n\t\tOPEN @cursor;\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\n\t\t\t\tEXEC @main_db.dbo.DeleteCTR @idval\n\t\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\tEND\n\t\tCLOSE @cursor;\n\t\tDEALLOCATE @cursor;\n\tEND\nELSE\n\tEXEC sp_api_toast N'Ongeldige status om te verwijderen'\n\nEXEC sp_api_modal_clear\n",
            "action_id": 814,
            "action_name": "Verwijder alle claimregels",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "SELECT * INTO #country FROM xcountry\nEXEC sp_api_modal_csv @tmptable=N'#country'--TMPTABLE HEADER\nEXEC sp_api_modal_csv @tmptable=N'#country',@useheaders=0 --GEEN HEADER\nEXEC sp_api_modal_csv @tmptable=N'#country',@startrow='Ho ho ho!' --EIGEN HEADER\nEXEC sp_api_modal_csv @tmptable=N'#country',@startrow='Ho ho ho!',@useheaders=0 --EIGEN HEADER, GEEN TMPTABLE HEADER",
            "action_id": 816,
            "action_name": "sp_api_modal_csv",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 819,
            "action_name": "sys_curly_search_and_insert",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 823,
            "action_name": "_sample_instant_report",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "IF {[xClaim].status} = N'New'\n\tBEGIN\n\t\tEXEC sp_api_modal_alert N'Claim verwijderen?'\n\t\tDELETE FROM xClaim WHERE id = @id\n\t\tEXEC sp_api_modal_clear\n\tEND\nELSE\n\tBEGIN\n\t\tEXEC sp_api_toast N'Alleen claims in status ''New'' kunnen worden verwijderd.'\n\tEND\n",
            "action_id": 831,
            "action_name": "Verwijder Claim",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--RH210131 Boek retourfust in order die direct klaar staat voor facturatie\n--Er is nu geen toewijzing nodig voor fust, maar dit komt eventueel nog wel..\n--Transport wordt geskipped\n\nDECLARE @company_id nvarchar(32),@button nvarchar(128),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000)\nDECLARE @RetourAantal int -- moet altijd NEGATIEF worden (gemaakt)\nDECLARE @STOCKID int --fustdrager van het fust\nSET @b1_text = N'Fust Retour Boeken'\nset @b3_text = N'Verwerk de retourboeking'\n\nEXEC sp_api_modal_select @card_name = N'klant',@value = @company_id OUT,@focus = 1\nIF @company_id > 0\nBEGIN\n--\tEXEC sp_api_modal_button @name='@button1',@value=@b1_text,@valueout = @button1 OUT,@key='Insert'\n\n--\tIF @button1 = @b1_text\n--\t\tBEGIN\n\t\t\tEXEC sp_api_modal_clear --verwijder button1\n\t\t\tset @head_1 = concat(N'Geef het retour-aantal per fustsoort in voor klant ',(select companyname from xcompany where id=@company_id))\n\t\t\texec sp_api_modal_text @head_1\n\t\t\tselect id=fust_id, [Retour]=0, [Saldo ]=FustSaldo,\t[Fustcode ]=FUSTCODE\n\t\t\tINTO #modalupdate from @main_db.dbo.tf_code_FustSaldo(@Company_ID) \n\t\t\tEXEC sp_api_modal_table_update @tmptable = N'#modalupdate',@addnew=0\n\n\n\t\t\t--test: toon de temp data\n\t\t\t--EXEC sp_api_modal_table @tmptable = N'#modalupdate', @print=1\n\t\t\t\n\n\t\t\t\n\t\t\t-- hier heb je bijgewerkte data\n\t\t\tset @b2_text = 'Refresh' \n\t\t\tEXEC sp_api_modal_button @name='@button2',@value = @b2_text, @valueout = @button2 OUT ,@class='btn-danger',@key='Enter'\n\t\t\tIF @button2 is null RETURN\n\t\t\t--EXEC sp_api_modal_clear\n\n\t\t\tEXEC sp_api_modal_button @name='@button3',@value=@b3_text,@valueout = @button3 OUT,@key='F10'\n\t\t\tif @button3=@b3_text AND EXISTS(select * from #modalupdate where isnull(retour,0) <> 0 )\n\t\t\t\tbegin\n\t\t\t\t\n\t\t\t\t--zorg voor een CTH (kop)\n\t\t\t\t\tSET @new_id = (SELECT TOP 1 id FROM xTransactionHeader WHERE status=N'ReadyForInvoice' AND CounterParty_ID = @company_id ORDER BY id DESC)\n\t\t\t\t\tif @new_id > 0 GOTO JMP_1;\n\t\t\t\t\tif @new_id is NULL \n\t\t\t\t\t\tbegin\n\t\t/* --ik wil een order direct in de status ReadyForInvoice aanmaken, dus buiten het normale pad om...\n\t\t\t\t\t\t\tDELETE FROM api_storage WHERE card_id = (SELECT id FROM api_card WHERE name = N'verkoop') AND child_id = 0 AND user_id = @user_id\n\t\t\t\t\t\t\tEXEC sp_api_modal_clear\n\t\t\t\t\t\t\tEXEC sp_api_modal_post N'verkoop',N'CounterParty_ID',@company_id,0\n\t\t\t\t\t\t\tEXEC @new_id = sp_api_modal_save N'verkoop',0\n\t\t*/\n\t\t\t\t\t\t\t--210131 direct aanmaken van de CTH...\n\t\t\t\t\t\t\texecute @main_db.dbo.[CreateCTH2] @Client_ID= @company_id\n\t\t\t\t\t\t\t\t\t\t\t\t\t,@new_identity =@new_id OUT\n\t\t\t\t\t\t\t\t\t\t\t\t\t,@Status = N'ReadyForInvoice'\n\t\t\t\t\t\t\t\t\t\t\t\t\t,@xCludeLFCTH = 0\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\tend\n\t\t\t\t\n\t\t\t\t\tJMP_1:\n\t\t--\t\t\t======\n\t\t\t\t\n\t\t\t\t \t--cursortje om de regels te verwerken\n\t\t\t\t\tDECLARE @checkid int\n\t\t\t\t\t\t\t,@Retour int\n\t\t\t\t\t\t\t,@ReturnCTR_ID int\n\t\t\t\t\tDECLARE @cursor_xCTH_Check CURSOR\n\t\t\t\t\tSET @cursor_xCTH_Check = CURSOR LOCAL FAST_FORWARD FOR\n\t\t\t\t\t\tSELECT id, Retour FROM #modalupdate \n\t\t\t\t\t\tOPEN @cursor_xCTH_Check;\n\t\t\t\t\t\tFETCH NEXT FROM @cursor_xCTH_Check INTO\n\t\t\t\t\t\t\t@checkid\n\t\t\t\t\t\t\t,@Retour\n\t\t\t\t\t\tWHILE @@FETCH_STATUS = 0\n\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\tif @main_db.dbo.isInteger(@Retour) =1 \n\t\t\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\t\t\tset @RetourAantal = convert(int,@Retour) --exec sp_api_TOAST @retour\n\t\t\t\t\t\t\t\t\tif @RetourAantal > 0 SET @RetourAantal = -1* @RetourAantal -- maak negatief\n\t\t\t\t\t\t\t\t\tif @RetourAantal < 0 -- let op: kan hierboven net negatief zijn gemaakt !!\n\t\t\t\t\t\t\t\t\t\tbegin --retourboeking!\n\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\tExecute @StockID=@main_db.dbo.Fust_To_StockID @CheckID --LET OP STOREC PROC ALS FUNTIE MISBRUIKT haal/maak-en-haal de fustdrager \n\t\t\t\t\t\t\t\t\t\t\tif @StockID >0\n\t\t\t\t\t\t\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\t\t\t\t\t\t\tset @ReturnCTR_ID = NULL -- reset steeds\n\t\t\t\t\t\t\t\t\t\t\t\t\texecute @main_db.dbo.CreateCTR  @CTH_ID=@new_id\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,@Stock_ID=@StockID\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t--,@advPalletType_ID=1\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,@Amount=@RetourAantal\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,@Detail=N'retour fust'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,@Price=0\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,@new_identity = @ReturnCTR_ID OUTPUT\n\t\t\t\t\t\t\t\t\t\t\t\t\tif @ReturnCTR_ID >0\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tif not exists( select id from xFustReturned\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\twhere Company_ID = @company_id\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tand Fust_ID = @checkid\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tand ReturnCTR_ID = @ReturnCTR_ID\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tand Amount = @RetourAantal   --and Username,Date,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tand Stock_ID = @StockID)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tinsert into xFustReturned(Company_ID,Fust_ID,ReturnCTR_ID,Amount,Username,Date,Stock_ID)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tvalues(@company_id,@checkid,@ReturnCTR_ID,@RetourAantal,@user_name,GETDATE(),@StockID)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tend\t\t\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\tend\t\t\n\t\t\t\t\t\t\t\t\t\tend\n\t\t\t\t\t\t\t\tend\t\n\t\t\t\t\n\t\t\t\t\t\t\tFETCH NEXT FROM @cursor_xCTH_Check INTO\n\t\t\t\t\t\t\t\t@checkid\n\t\t\t\t\t\t\t\t,@Retour\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\tEND\n\t\t\t\t\tCLOSE @cursor_xCTH_Check;\n\t\t\t\t\tDEALLOCATE @cursor_xCTH_Check;\n\t\t\n\t\t\t\tEXEC sp_api_modal_clear\n\n/*\n\t\t\t\t--TOON EVENTUEEL DE FUSTREGELS IN DE RETOURBOEKING\n\t\t\t\tSET @goto = N'/verkoop/'+@new_id+'/ctr2'\n\t\t\t\t\tSET @search = N'?id='+@new_id\n\t\t\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/verkoop',@referer_search=@search\n\t\n*/\t\t\t\t\t\n\t\t\tend\n\t\t\nEND",
            "action_id": 842,
            "action_name": "Registreer Fust Inname",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_modal @class=N'w75'\nSET @button_name1  = N'Genereer alles'\n/*\nSET @button_name1b  = N'Genereer claims'\nSET @button_name1c  = N'Genereer fust'\n*/\nSET @button_name2 = N'Refresh taaklijst'\nSET @button_name3 = N'Klaar'\n\nEXEC sp_api_modal_text N'Genereer alle facturen (als geplande taak)',N'h4 mt-4 text-muted'\n\nIF @button IS NULL\n\tBEGIN\n\t\tEXEC sp_api_modal_button @name='@button',@value=@button_name1,@valueout = @button OUT,@key='F1',@class=N'btn-danger'\n\t\t--EXEC sp_api_modal_button @name='@button',@value=@button_name1b,@valueout = @button OUT,@key='F2',@class=N'btn-danger'\n\t\t--EXEC sp_api_modal_button @name='@button',@value=@button_name1c,@valueout = @button OUT,@key='F3',@class=N'btn-danger'\n\t\t--RETURN\n\tEND\nIF @button = @button_name1 --,@button_name1b)\n\tBEGIN\n\t\t--DECLARE @specialType int = 0\n\t\t--SET @specialType = IIF(@button = @button_name1b ,@main_db.dbo.CthSpecialType('claim'),@specialType)\n\t\t--SET @specialType = IIF(@button = @button_name1c ,@main_db.dbo.CthSpecialType('fust'),@specialType)\n\t\tDECLARE @cursor CURSOR,@Counterparty_ID nvarchar(32)\n\t\t/* CVG 220201 Robert wilt graag enkel orders in die in het verleden liggen factureren. */\n\t\t--SET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT DISTINCT Counterparty_ID FROM xTransactionHeader WHERE TDT = 2 and status in ('ReadyForInvoice')\n\t\tSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT DISTINCT Counterparty_ID FROM xTransactionHeader WHERE TDT = 2 and status in ('ReadyForInvoice') AND advTransportDep < dbo.abcdate()\n\t\t\t--AND ISNULL(specialType,0) = @specialType\n\t\tOPEN @cursor;\n\t\tFETCH NEXT FROM @cursor INTO @Counterparty_ID\n\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\n\t\t\t\tSELECT @Code = Code,@CompanyName = CompanyName,@debtorNumber = debtorNumber FROM xCompany WHERE id = @Counterparty_ID --AND id = 147321\n\t\t\t\tSET @sql = CONCAT(N'@main_db.dbo.sp_create_invoice_rows @THDT = 2 ,@Counterparty_ID = ' , @Counterparty_ID) --,', @specialType = ',@specialType)\n\t\t\t\tSET @description = CONCAT(N'Genereer facturen voor: [', @Code,'] ',@CompanyName)\n\t\t\t\tIF NOT EXISTS(SELECT id FROM xCompanyCostSettings WHERE groupcode = N'BASIS_AGF' AND xCompany_id = @Counterparty_ID)\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tEXEC sp_api_modal_text @description,N'h4 my-4 text-muted'\n\t\t\t\t\t\tEXEC sp_api_modal_text N'Geen Company Cost Settings gevonden!',N'my-4 text-danger'\n\t\t\t\t\t\tSET @pathname = CONCAT(N'/klant/',@Counterparty_ID,'/company_cost_settings')\n\t\t\t\t\t\tEXEC sp_api_modal_route @name=N'Naar Cost Settings', @pathname = @pathname,@key='Enter'\n\t\t\t\t\t\tRETURN\n\t\t\t\t\tEND\n\t\t\t\tIF NOT (ISNULL(@debtorNumber,'') > '')\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tEXEC sp_api_modal_text @description,N'h4 my-4 text-muted'\n\t\t\t\t\t\tEXEC sp_api_modal_text N'Geen debiteurennummer gevonden!',N'my-4 text-danger'\n\t\t\t\t\t\tSET @pathname = CONCAT(N'/klant/',@Counterparty_ID,'?focus=',dbo.fn_api_get_field_id('klant','debtorNumber'))\n\t\t\t\t\t\tEXEC sp_api_modal_route @name=N'Naar debiteurennummer', @pathname = @pathname,@key='Enter'\n\t\t\t\t\t\tRETURN\n\t\t\t\t\tEND\n\t\t\t\tEXEC sp_api_add_sql_task @sql=@sql,@description=@description --N'Genereer facturen voor orders klaar voor facturatie'\n\t\t\t\tFETCH NEXT FROM @cursor INTO @Counterparty_ID\n\t\t\tEND\n\t\tCLOSE @cursor;\n\t\tDEALLOCATE @cursor;\n\tEND\n\nIF @button IS NOT NULL EXEC sp_api_modal_button @name='@button',@value=@button_name2,@valueout = @button OUT,@key='F1',@class=N'btn-success'\nEXEC sp_api_modal_button @name='@button',@value=@button_name3,@valueout = @button OUT,@key='Escape',@class=N'btn-success'\nSET @reducer = N'start_at BETWEEN DATEADD(HOUR,-8,GETDATE()) AND GETDATE() AND user_id = ' + @user_id\nEXEC sp_api_modal_table @card_name='api_sql_tasks',@reducer=@reducer -- order by van related order op card\nIF @button_name3 = @button\n\tBEGIN\n\t\tEXEC sp_api_modal_clear\n\tEND\n",
            "action_id": 843,
            "action_name": "Genereer alle facturen",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 860,
            "action_name": "sys_curly_search_and_insert",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_input @name='Zoek', @value= @valueout OUT,@focus=1,@select=1\n\nSELECT id,[fustcode ]=fustcode, retour = 0 INTO #fust FROM xFust WHERE meermalig = 1\n\nEXEC sp_api_modal_table_update @tmptable = '#fust'\n",
            "action_id": 864,
            "action_name": "Fustzoeker",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @company_id nvarchar(32),@button nvarchar(128),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000)\n,@button1 nvarchar(128) = N'Nieuwe factuur'\n,@button2 nvarchar(128) = N'Verder met bestaande factuur'\n\nEXEC sp_api_modal_select @card_name = N'klant',@value = @company_id OUT,@focus = 1\nIF @company_id > 0\nBEGIN\n\tDECLARE @only_new_is_possible BIT = 0\n\tEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='F1'\n\tIF EXISTS (SELECT * FROM xInvoice WHERE isManual=1 AND status=N'Draft' AND ToCompany_ID = @company_id)  -- alleen bij manual!\n\t\tEXEC sp_api_modal_button @name='button',@value=@button2,@valueout = @button OUT,@key='F2'\n\tELSE\n\t\tSET @only_new_is_possible = 1\n\n\tIF @button = @button1 OR @only_new_is_possible = 1\n\t\tBEGIN\n\t\t\t--create invoice functie\n\t\t\texecute sp_api_toast N'hier create...'\n\t\t\t--oude naam execute @New_ID= @main_db.dbo.sp_create_invoice_out @Company_ID \n\t\t\texecute @New_ID= @main_db.dbo.sp_create_direct_invoice @Company_ID \n\n\t\t\tSET @goto = N'/invoice/'+@new_id --+'/stock_ctr2'\n\t\t\tSET @search = N'?id='+@new_id\n\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/invoice',@referer_search=@search\n\t\tEND\n\tIF @button = @button2\n\t\tBEGIN\n\t\t\tSET @new_id = (SELECT TOP 1 id FROM xInvoice WHERE status=N'Draft' AND ToCompany_ID = @company_id ORDER BY id DESC)\n\t\t\tSET @goto = N'/invoice/'+@new_id +'/invrow_manual'\n\t\t\t--https://anaco.tracy.nu/invoice/1124/invrow_manual\n\t\t\tSET @search = N'?id='+@new_id\n\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/invoice',@referer_search=@search\n\t\tEND\nEND",
            "action_id": 872,
            "action_name": "Handmatige Factuur",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\t--dit is nu alleen voor tellers en checks, zodat we weten dat het report al is gemaakt:\n\t\t--EXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'CTH'\t,@Context_Key_ID=@cid,@Report_CODE=N'CONF_DELIVERY' -- zie runreport \n\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select Counterparty_id from xtransactionheader where id=@cid)\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = 'deliverynote' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@PrinterCopies = 2\n\t\t\t,@test = 0\n\t\t\t,@FixedPrinter_ID = 32\n\n\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 893,
            "action_name": "afleverbon",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "Declare @Status nvarchar(50), @NextLine bit\nupdate xcontainer set @status=case status \n\twhen N'Sea' then N'Terminal'\n\twhen N'Terminal' then N'Road'\n\twhen N'Road' then N'Arrived'\n\twhen N'Arrived' then N'Road'\n\telse N'Sea'\n\tend\n\t,Status=@Status\n\t,@NextLine=iif(isnull(status,N'') > N'',1,0)\n\t,StatusHistory=trim(concat(StatusHistory,iif(@NextLine=1,Char(13)+Char(10),N''),GETDATE(),N' ',@User,N' Status naar: ',@Status))\nwhere id=@ID\t\n\t",
            "action_id": 911,
            "action_name": "NextState",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_post N'xcthcustomsrows',N'KGDoc_Brut','13678.67',0\n--EXEC sp_api_modal_modal @style=N' .container{background-color: white !important;}'\n--EXEC sp_api_modal_text N'test',@print=1\n--EXEC sp_api_modal_download_report @context = 'invoice',@context_id = 1200",
            "action_id": 914,
            "action_name": "Download Report",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--RH210121 Een opmerking op de CTH registraren (kan begin van een claim zijn, zie evt claims)\ndeclare @NewRemark_ID INT\ndeclare @CTH INT\n\nset @CTH={[inkoop].id}\nif @cth is null -- geen inkoop; misschien verkoop?\n\tbegin\n\t\tset @CTH={[verkoop].id}\n\tend\n\nif @CTH  is not null \n\tbegin\n\n\t\tIF isnull((SELECT count(id) FROM xcth_remark WHERE CTH_ID = @CTH ),0)=0\n\t\t\tBEGIN\n\t\t\t\tEXEC @NewRemark_ID=@main_db.dbo.CreateRemark @CTH_ID =@CTH,\t@Remark = NULL,\t@user_name =@user_name\n\n\t\t\t\tSET @path = concat(@path,'/',@CTH,'/xcth_remark/',@NewRemark_ID)\t--NEW IN FORM\n\t\t\tEND\n\t\tELSE \tSET @path = concat(@path,'/',@CTH,'/xcth_remark')\t\t\n\n\t\tEXEC sp_api_goto @path\n\tend\n",
            "action_id": 921,
            "action_name": "Remark",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--------------------------------------------------------------------------------------------------------------------------------------\n--\tRH 210219 OPPASSEN !!\n--\tDeze code wordt vanuit diverse contexten gebruikt (verkoop - facturatie - ??)\n--\tOpletten: Bij verkoop kunnen ook directe regels worden gemaakt, deze komen direct in xInvRow, maar hebben dan nog geen invoice_id; \n--\tAls de order op een later tijdstip wordt gefactureerd moet het invoice_id aan de directe regels worden gekoppeld\n--------------------------------------------------------------------------------------------------------------------------------------\n\n\nEXEC sp_api_modal_modal @class=N'w75'\n\nDECLARE @Description nvarchar(512)\nDECLARE @Counterparty_ID INT ={[invoice].ToCompany_ID}\n\ndeclare @ModelPrice float\ndeclare @ModelText nvarchar(200)\n\n\nselect \t@ModelPrice=Price\n\t\t,@ModelText=Description \n\tfrom xinvrowmodel where id=@ID\n\n--in te tikken prijs\nDECLARE @prijs nvarchar(20),@aantal nvarchar(20) \n\n--button\nDECLARE @button nvarchar(128)\nDECLARE @buttonvalue nvarchar(128) = 'Toevoegen'\n\nDECLARE @text nvarchar(max)\t\n\t\nDECLARE @CONTEXT INT\t\n\n--TRY CONTEXT FACTUUR:\t\n--====================\nDECLARE @INVID INT \nSET @CONTEXT = {[invoice].id} --200818 curly\nIF @CONTEXT IS NOT NULL SET @INVID=@CONTEXT\nIF @CONTEXT IS NOT NULL AND isnull({[invoice].isManual},0)=0 \n\tbegin\t-- 210219 breek af als de factuur niet 'isManual' is...\n\t\t\t--de invoice is geen handmatige factuur, niet toestaan!\n\t\texec sp_api_modal_alert N'Dit is GEEN directe factuur waarop handmatig kan worden toegevoegd. Maak hiervoor een handmatige (vrije) factuur aan.'\n\t\texec sp_api_modal_clear\n\t\treturn;\n\tend\nIF @INVID is not NULL GOTO INVOICE_MANUALLY; \n--------------------------------------------\n\n\t\n--TRY CONTEXT CTH:\n--================\nDECLARE @CTH2ID INT \nSET @CONTEXT = ISNULL({[verkoop].id},{[verkoop_loods].id}) --200818 curly\nIF @CONTEXT IS NOT NULL SET @CTH2ID=@CONTEXT\n\n--check: select isnull((select l from dbo.[GetCompanySettings](N'ADI_on_CTH2')),0)\n\nIF @CTH2ID is not NULL GOTO DIRECT_INVOICE_TO_SALES;\n----------------------------------------------------\n\n--FINALLY:\nIF @CONTEXT IS NULL\t\n\tbegin\n\t\texec sp_api_modal_Alert N'Dit is geen juiste plek om de regels te boeken'\n\t\texec sp_api_modal_clear\n\t\tRETURN;\n\tend\t\nRETURN;\n\n--------------------------------------------------------------------------------------------------------------------------------------\nINVOICE_MANUALLY:\n---------------------------------------------------\n--\tDEZE KOMEN OP EEN APARTE HANDMATIGE FACTUUR (M)\n---------------------------------------------------\n\n\nDECLARE @Status nvarchar(50)\nDECLARE @THDT INT\n\nSELECT @Status=INV.Status,@THDT=INV.InvoiceType_ID \n\tFrom q_xInvoice INV where INV.ID=@INVID\n\nDECLARE @invrow_id int \nset @invrow_id =(select id from xinvrow where invoice_id=@INVID and xinvRow.rowtext=@ModelText )\n\nDECLARE @mes nvarchar(200)\n\nIF @Status not in ('Draft') \n\tbegin\n\t\tEXEC sp_api_modal_alert 'U kunt alleen boeken op nieuwe handmatige facturen'\n\t\tEXEC sp_api_modal_clear\t\t\n\t\tRETURN;\t\n\tend\n\nIF @invrow_id IS NOT NULL \n\tBEGIN\t\t-- haal waardes op uit eerdere invoer\n\t\tSET @buttonvalue = 'Bijwerken'\n\t\tselect @Aantal=Amount, @Prijs=Price from xinvrow where id=@invrow_id\n\tEND\nELSE\n\tBEGIN\n\t\tset @prijs=@ModelPrice\n\tEND\n\nSET @text = (select companyname from xcompany where id={[invoice].toCompany_ID})\nEXEC sp_api_modal_text @text\n\nset @ModelText=@ModelText+ N' ' + isnull(@buttonvalue,N'')  --normaal of +'bijwerken'\nEXEC sp_api_modal_text @text = @Modeltext,@class = 'h3 text-muted'\n\nSET @text = N'Aantal x Prijs'\nEXEC sp_api_modal_text @text\n\nDECLARE @focus BIT = IIF(@invrow_id IS NULL,1,0)\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=@focus,@inline = 1\n\nDECLARE @selected BIT = IIF(@invrow_id IS NULL,0,1)\nSET @focus = IIF(@invrow_id IS NULL,0,1)\nEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT,@focus=@focus,@inline = 1,@select=@selected\nexec sp_api_modal_text N'(gebruik de letter x bij aantal om een regel te verwijderen)'\nEXEC sp_api_modal_button @name='button',@value = @buttonvalue,@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\n\n\n\nIF @button IS NOT NULL\n\tBEGIN\n\n\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') \n\t\tIF \t--((ISNULL(@Prijs,N'')=N'' OR\ttry_cast(@prijs as decimal(10,2)) > 0) \n\t\t\t\t((try_cast(@prijs as decimal(10,2)) <> 0)\n\t\t\tAND (TRY_CAST(@aantal as int) <> 0 OR @aantal = 'x') ) --leuke truc !\n\n\t\t\tBEGIN\n\t\t\t\tIF @aantal = 'x' SET @aantal = 0\n\t\t\t\tIF @invrow_id IS NOT NULL\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tif @Aantal = 0 DELETE from xinvrow WHERE id = @invrow_id --DELETE DE DIRECTE REGEL (DRAFT CHECK IS AL EERDER, DUS OK)\n\t\t\t\t\t\tif @Aantal<> 0\n\t\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\t\tUPDATE xinvrow SET amount = @aantal, price = @Prijs WHERE id = @invrow_id\n\t\t\t\t\t\t\t\tselect @mes = 'Nieuw aantal: '+@Aantal\n\t\t\t\t\t\t\t\texec sp_api_toast @mes\n\t\t\t\t\t\t\tend\t\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\t\t\tRETURN\n\t\t\t\t\tEND\n\t\t\t\tELSE\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\texec @main_db.dbo.CreateINVRow_fromModel @ID,@aantal,@PRijs, @INVID\n--\t\t\t\t\t\tset @mes = concat('Er zijn ',@Aantal, ' colli toegevoegd aan factuur ',@INVID) \n--\t\t\t\t\t\texec sp_api_toast @mes\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\t\t\tRETURN\n\t\t\t\t\tEND\n\t\t\tEND\n\t\tELSE\n\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\tEND\n\nRETURN;\n--------------------------------------------------------------------------------------------------------------------------------------------------\n\n\n\n--210219\nDIRECT_INVOICE_TO_SALES:\n---------------------------------------------------\n--\tDEZE KOMEN MEE OP DE NORMALE VERKOOPFACTUUR !!!\n---------------------------------------------------\n--exec sp_api_modal_alert N'hallo'\n--exec sp_api_modal_clear\n\nDECLARE @invrow_direct_id int \nset @invrow_direct_id =(select id from xinvrow where cth_id=@CTH2ID and xinvRow.rowtext=@ModelText and invoice_id is NULL ) --210219 LET OP: NU OOK GEWOON IN INVROW !!!\n\nIF @invrow_direct_id IS NOT NULL \n\tBEGIN\t-- haal waardes op uit eerdere invoer\n\t\tSET @buttonvalue = 'Bijwerken'\n\t\tselect @Aantal=Amount, @Prijs=Price from xinvrow where id=@invrow_direct_id\n\tEND\nELSE\n\tBEGIN\n\t\tset @prijs=@ModelPrice --prijs uit het model\n\tEND\n\nDECLARE @counterparty INT = ISNULL({[verkoop].Counterparty_ID},{[verkoop_loods].Counterparty_ID})\nSET @text = (select companyname from xcompany where id= @counterparty)\nEXEC sp_api_modal_text @text\n\nset @ModelText=@ModelText+ N' ' + isnull(@buttonvalue,N'')  --normaal of +'bijwerken'\nEXEC sp_api_modal_text @text = @Modeltext,@class = 'h3 text-muted'\n\nSET @text = N'Aantal x Prijs'\nEXEC sp_api_modal_text @text\n\n\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=@focus,@inline = 1\nEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT,@focus=@focus,@inline = 1,@select=@selected\nexec sp_api_modal_text N'(gebruik de letter x bij aantal om een regel te verwijderen)'\nset @button =NULL\nEXEC sp_api_modal_button @name='button',@value = @buttonvalue,@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\n\nIF @button IS NOT NULL\n\tBEGIN\n\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') \n--\t\tIF \t((ISNULL(@Prijs,N'')=N'' OR\ttry_cast(@prijs as decimal(10,2)) > 0) AND (TRY_CAST(@aantal as int) >\t 0 OR @aantal = 'x') ) \n\t\tIF \t((try_cast(@prijs as decimal(10,2)) <> 0)\n\t\t\tAND (TRY_CAST(@aantal as int) <> 0 OR @aantal = 'x') ) --leuke truc !\n\t\t\t\n\t\t\tBEGIN\n\t\t\t\tIF @aantal = 'x' SET @aantal = 0\n\t\t\t\tIF @invrow_direct_id IS NOT NULL\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tif @Aantal=0 DELETE from xinvrow WHERE id = @invrow_direct_id --DELETE DE DIRECTE REGEL (DRAFT CHECK IS AL EERDER, DUS OK)\n\t\t\t\t\t\tif @Aantal<>0\n\t\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\t\tUPDATE xinvrow SET amount = @aantal, price = @Prijs WHERE id = @invrow_direct_id \n\t\t\t\t\t\t\t\tselect @mes = 'Nieuw aantal: '+@Aantal\n\t\t\t\t\t\t\t\texec sp_api_toast @mes\n\t\t\t\t\t\t\tend\t\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\t\t\tRETURN\n\t\t\t\t\tEND\n\t\t\t\tELSE\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\texec @main_db.dbo.Create_InvRow_direct_from_Model @Model_ID =@ID,\t@Amount=@Aantal,@Price=@Prijs,@CTH2_ID=@CTH2ID\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\t\t\tRETURN\n\t\t\t\t\tEND\n\t\t\tEND\n\t\tELSE\n\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\tEND\n\nRETURN;\n",
            "action_id": 926,
            "action_name": "Selecteer",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "\nEXEC sp_api_modal_choose @list = N'Leverancier,Periode,Beide',@value = @button_choose OUT--,@startkey=NULL\n\nDECLARE @company_id nvarchar(32)\n\n\nDECLARE @date nvarchar(128),@button nvarchar(128)/*,@from nvarchar(128),@to nvarchar(128),*/\n\t,@datumrange nvarchar(50)\nset @date = dbo.workDate()\n\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\nIF @button_choose IN ('Beide','Periode')\n\tBEGIN\n\t\tIF @startdate IS NULL SET @startdate = @main_db.dbo.abcbom()\n\t\t--IF @enddate IS NULL SET @startdate = @main_db.dbo.abceom()\n\t\tEXEC sp_api_modal_date_from_to @from=@startdate out, @to=@enddate out,@class='w-24'\n\tEND\nIF @button_choose IN ('Beide','Leverancier')\n\tBEGIN\n\t\tEXEC sp_api_modal_select @card_name = N'leverancier',@value = @company_id OUT ,@focus = 1,@top = 3--,@select = 1\n\t\tIF @company_id IS NULL RETURN\n\tEND\n--IF @company_id IS NOT NULL EXEC sp_api_modal_focus N'geert' --blurr\nSET @button = '*KIES*'\nSET @datumrange = concat(@startdate, ' - ', @enddate)\nEXEC sp_api_modal_text @datumrange, @printonly=1\n--EXEC sp_api_modal_button @name='button',@value = 'SalesPerLot',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print @keycode = N'Ctrl+P'\n\n-- \tSELECT TransactionDate, TV_CompanyName,[currencyISO*] = currencyISO,id, [totalProductPrice@] = totalProductPrice, [DATE*] = concat(@from, ' - ', @to)\n\nIF @button_choose IS NOT NULL --=  'SalesPerLot'\nBEGIN\n\n\n\nSELECT \n\n--HENK: KOLOMMEN\nRegionName as [Regio*], Variety_0 , VTH_CODE as [VTH_CODE] ,\tContentDesc,\tSize,Detail_0\t,KGN,Origin_Code,V_AMT_IV as [Aantal@:0],V_EUR,\tFustCode\n--,\tLFDate,ITH_CODE, VTH_CODE,\tITHDT,VTHDT,\tStock_ID,\tcompleteAddress as V_ADDR\t,\t\tI_RATE,\tV_RATE, i_comp_id, V_Comp_ID,I_AMT_CTR, I_EUR\n\n\n\tINTO #RV_SalesPerLot_base\n\nFROM [dbo].[RV_SalesPerLot_base] \n\twhere ithdt=1 \n\t\tand ((@Company_ID is NULL) OR i_comp_ID=@Company_ID) --counter_code like '%looy%'\n\t\tand ((@startdate IS NULL AND @enddate IS NULL) OR (LFDATE BETWEEN @startdate AND @enddate))\n\torder by RegionName,VTH_CODE, Variety_0,ContentDesc\t\n\t\n\tSET @filename = CONCAT(N'SalesPerLot',@datumrange,'.csv')\n--to csv\n\tEXEC sp_api_modal_button @name='@button_csv',@value = N'CSV', @valueout = @button_csv OUT ,@class='btn-danger',@key='F4'\n\tIF @button_csv IS NOT NULL EXEC sp_api_modal_csv @tmptable = N'#RV_SalesPerLot_base',@filename=@filename\n--print\n\tEXEC sp_api_modal_table @tmptable=N'#RV_SalesPerLot_base',@print=1 ,@orderby=N'ORDER BY 1,2,3 ASC'\nEND \n",
            "action_id": 934,
            "action_name": "Verkoop van Leverancier",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "\n--EXEC sp_api_modal_choose @list = N'Transporteur',@value = @button_choose OUT--,@startkey=NULL\n\nDECLARE @company_id nvarchar(32)\n\n\nDECLARE @date nvarchar(128),@button nvarchar(128)/*,@from nvarchar(128),@to nvarchar(128),*/\n\t,@datumrange nvarchar(50)\nset @date = dbo.workDate()\n\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n--IF @button_choose IN ('Beide','Periode')\n--\tBEGIN\n--\t\tIF @startdate IS NULL SET @startdate = @main_db.dbo.abcbom()\n--\t\t--IF @enddate IS NULL SET @startdate = @main_db.dbo.abceom()\n--\t\tEXEC sp_api_modal_date_from_to @from=@startdate out, @to=@enddate out,@class='w-24'\n--\tEND\n\t\nIF 1=1 --@button_choose IN ('Transporteur')\n\tBEGIN\n\t\tEXEC sp_api_modal_select @card_name = N'transporteur',@value = @company_id OUT ,@focus = 1,@top = 3--,@select = 1\n\t\tIF @company_id IS NULL RETURN\n\tEND\n--IF @company_id IS NOT NULL EXEC sp_api_modal_focus N'geert' --blurr\n\nSET @button = '*KIES*'\n--SET @datumrange = concat(@startdate, ' - ', @enddate)\n--EXEC sp_api_modal_text @datumrange, @printonly=1\n\nEXEC sp_api_modal_button @name='button',@value = 'Toon de lijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print @keycode = N'Ctrl+P'\n\n-- \tSELECT TransactionDate, TV_CompanyName,[currencyISO*] = currencyISO,id, [totalProductPrice@] = totalProductPrice, [DATE*] = concat(@from, ' - ', @to)\n\nIF --@button_choose IS NOT NULL --=  'SalesPerLot'\n\t-- simpel: \n\t@Button='Toon de lijst'\nBEGIN\n\n\n\nSELECT \n\n--HENK: KOLOMMEN\n--select * from  tracy_fkt.dbo.Oprijvracht_fn(dbo.abcdate()-27,NULL,159794,NULL)\nN'INKOOP: ' as [O*],CTH1_ID as [Order*],\tN'LOKATIE: ' as [L*], LocationCode as [LOK*], N'LAADREF: ' as [LR*],\tPickupRef as [Pickupref*],\t'TEL:' as [t*],\tphone as [phone*],\tchar(13)+char(10) as [ch13*], N'TRANSPORTEUR: ' as [TRAN*],Transp_Code as [Transp*],\tN'BLOK: ' as [BL*], Blok as [Blok*], \tN'EURO: ' as [EU*],Euro as [EUR*],\tN'EXTRA OPMERKING: '\tas [extra*], pickupRemarks as [Rem*~wrap], LEFT(CONVERT(VARCHAR, [datum] , 106), 13) as [Datum*], LFCTR_Amount,\tDescription, ContentDesc\tSize,\tKGN,\tDetail_0,\tOrigin_Code as[oc~center],Fustcode\n\n\n\tINTO #Oprijvracht_fn\n\nFROM @main_db.dbo.Oprijvracht_fn(@date,NULL,@company_id,NULL)\n--\torder by VTH_CODE, Stock_ID,  Variety_0,ContentDesc\t,RegionCode\n\t\n\tSET @filename = CONCAT(N'Oprijvracht_fn',@date,'.csv')\n--to csv\n\tEXEC sp_api_modal_button @name='@button_csv',@value = N'CSV', @valueout = @button_csv OUT ,@class='btn-danger',@key='F4'\n\tIF @button_csv IS NOT NULL EXEC sp_api_modal_csv @tmptable = N'#Oprijvracht_fn',@filename=@filename\n--print\n\tEXEC sp_api_modal_table @tmptable=N'#Oprijvracht_fn',@print=1 ,@orderby=N'ORDER BY 1,2,3 ASC'\nEND \n",
            "action_id": 941,
            "action_name": "Oprijvracht",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "set @testmodus =1 --0=live; 1=test!\n\nEXEC sp_api_toast N'Transport-overzicht voor Transporteur' \nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\nDECLARE @TrComp_ID int\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\t--dit is nu alleen voor tellers en checks:\n\n\t\t--even niet registreren dat er wordt afgedrukt\n\t\t--EXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'LF'\t,@Context_Key_ID=@cid,@Report_CODE=N'TRANSPORT' --transportorder\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = {[xlandfreight].transportCompany_ID}\n\t\t--DECLARE @error INT\n\t\tset @trComp_ID = (select TransportCompany_ID from @main_db.dbo.xlandfreight where id=@cid)\n\t\t\n\t\tif @trComp_ID is NOT NULL\n\t\t\tEXEC sp_api_report_generate @id = @trComp_ID\n\t\t\t\t,@sys_report_key = 'transport-overview' --zie xrepdef\n\t\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t\t,@test=@testmodus\n\t\telse execute sp_api_modal_alert N'IK HEB GEEN TRANSPORTCOMPANY OP LANDFREIGHT'\t\n\t\t--IF @error > 0 RAISERROR(N'Er is een probleem')\n\t\t\n\t\t--set @reptxt=concat(N'to transporter: ',@toCompany_ID)\n\t\t--execute sp_api_toast @reptxt\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 942,
            "action_name": "Overzicht Transport",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "update xinvoice set  interval_key=NULL, DateDue=NULL,DateInvoice=NULL , printedLegalTotal =NULL, printedVATTotal=NULL ,status='Empty'\n\twhere not exists(select * from xinvRow where invoice_ID=@ID)\n\t\tand status in ('Draft','Empty') and ID=@ID",
            "action_id": 955,
            "action_name": "Hergebruik deze lege factuur",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @THDT INT = IIF({[invoice].id} IS NULL,1,2) -- if no invoice.id then incoming_invoice\nEXEC @main_db.dbo.sp_create_invoice_rows @THDT",
            "action_id": 956,
            "action_name": "Genereer facturen (verkoop)",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--RH 210217 Actie voor Child-keuze\nIF isnull({[invoice].isManual},0) =1 \n\tBEGIN\n\t\texec sp_api_modal_alert N'U gaat nu naar een handmatige factuur..'\n\t\texec sp_api_modal_clear\n\t\tSET @path = @path+'/'+@id+'/invrow_manual'\n\tEND\nELSE\n\tBEGIN\n\t\tSET @path = @path+'/'+@id+'/invrow'\n\tEND\n\t\nEXEC sp_api_goto @path\n",
            "action_id": 961,
            "action_name": "Invrow",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @GLBASE int =  isnull({[invrow].CCS_ID.GLBase_ID},{[invrow].CostCode_ID.GLBase_ID}) --bij vrije regels dus de gl-base van de costcode\ndeclare @fromCountry_ID int = {[invoice].FromCompany_ID.Country_ID}--(SELECT fromCountry_ID FROM xCTHTotals WHERE cth_id = {[invrow].ctr_id.TransactionHeader_ID})\ndeclare @toCountry_ID int = {[invoice].toCompany_ID.Country_ID}--(SELECT toCountry_ID FROM xCTHTotals WHERE cth_id = {[invrow].ctr_id.TransactionHeader_ID})\n\nexec sp_api_toast @GLBASE\nexec sp_api_toast @fromCountry_ID \nexec sp_api_toast @toCountry_ID ",
            "action_id": 965,
            "action_name": "info",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec sp_api_modal_alert N'Door op ENTER te klikken, maakt u van deze factuurregel een ''MODEL'' voor vrije regels.'\nexec sp_api_modal_clear\nexec @main_db.dbo.RowToModel @InvRow_ID =@ID",
            "action_id": 971,
            "action_name": "Row to Model",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec sp_api_modal_alert N'Door op ENTER te klikken, maakt u van deze factuurregel een ''MODEL'' voor vrije regels.'\nexec sp_api_modal_clear\nexec @main_db.dbo.RowToModel @InvRow_ID =@ID",
            "action_id": 972,
            "action_name": "Row to Model",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @sys_report_key nvarchar(50) = N'claimconfirmation_out'\ndeclare @test bit =1 -- 0:LIVE ; 1=TEST\nEXEC sp_api_toast @sys_report_key--N'Orderbevestiging' \n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\t--EXEC sp_api_toast @cid\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select Counterparty_id from xtransactionheader where id=@cid)\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = @sys_report_key--'claimconfirmation_out' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@test=@test\n\n\t\t--dit is nu alleen voor tellers en checks:\n\t\t--EXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'CTH'\t,@Context_Key_ID=@cid,@Report_CODE=N'CONF'\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 979,
            "action_name": "Mail Claimbevestiging",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--RH210121 Een opmerking op de CTH registraren (kan begin van een claim zijn, zie evt claims)\ndeclare @NewRemark_ID INT\ndeclare @CTH INT\n\nset @CTH={[inkoop].id}\nif @cth is null -- geen inkoop; misschien verkoop?\n\tbegin\n\t\tset @CTH={[verkoop].id}\n\tend\n\nif @CTH  is not null \n\tbegin\n\n\t\tIF isnull((SELECT count(id) FROM xcth_remark WHERE CTH_ID = @CTH ),0)=0\n\t\t\tBEGIN\n\t\t\t\tEXEC @NewRemark_ID=@main_db.dbo.CreateRemark @CTH_ID =@CTH,\t@Remark = NULL,\t@user_name =@user_name\n\n\t\t\t\tSET @path = concat(@path,'/',@CTH,'/xcth_remark/',@NewRemark_ID)\t--NEW IN FORM\n\t\t\tEND\n\t\tELSE \tSET @path = concat(@path,'/',@CTH,'/xcth_remark')\t\t\n\n\t\tEXEC sp_api_goto @path\n\tend\n",
            "action_id": 980,
            "action_name": "Remark",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128),@detail nvarchar(128),@aantal nvarchar(128),@text nvarchar(128),@datumrange nvarchar(50)\nEXEC sp_api_modal_modal @class = 'w75'\nSET @date = dbo.workDate()\nSET @aantal = (SELECT stock from xstock where id = {[ctr2].stock_ID})\nSET @detail = (SELECT description from xstock where id = {[ctr2].stock_ID})\nSELECT @text = 'History van: ' + @detail + ' Huidige voorraad: ' + @aantal\nEXEC sp_api_modal_text 'INKOOP HISTORY', 'text-primary font-weight-bold text-center display-4'\nEXEC sp_api_modal_text @text, 'text-primary font-weight-bold text-center display-4'\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n--EXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\n\nDECLARE @simpelhistory BIT = 0\nIF dbo.hasClaims('sub=nicky@vgibv.nl') > 0 /*OR dbo.hasClaims('sub=colin@tracy.nu') > 0*/\nBEGIN\nSET @simpelhistory = 1\nEND\n\nIF @simpelhistory = 0\n\tBEGIN\n\t\tSET @from = DATEADD(week, -1, dbo.workDate())\n\t\tEXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\n\t\tSET @datumrange = concat(@from, ' - ', @to)\n\t\tEXEC sp_api_modal_button @name='button',@value = 'InkoopHistory',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\n\tEND\n\nSET @button = 'InkoopHistory'\n\nIF @button =  'InkoopHistory'\nBEGIN\n\tIF @simpelhistory = 0\n\t\tBEGIN\n\t\tSELECT /*TOP 10*/ [Amount@g] = Amount,[Price] = Price,[currencyISO] = currencyISO,[Counterparty~col-sm-3] = Counterparty,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id\n\t\tINTO #InkoopHistory\n\t\tfrom Q_xTransactionDetail \n\t\twhere TDT = 1 AND Stock_ID = {[ctr2].stock_ID} AND delayed != 1 AND TransactionHeader_ID not in (select id from q_xtransactionheader where specialType = 1001)\n\t\tAND (Q_xTransactionDetail.TransactionDate BETWEEN @from AND @to)\n\t\tORDER BY id DESC\n\t\tALTER TABLE #InkoopHistory\n\t\tDROP COLUMN [Stock_ID],[TDT]\n\t\tEXEC sp_api_modal_table @tmptable=N'#InkoopHistory',@orderby=N'ORDER BY TransactionDate DESC'\n\t\t\n\t\tIF (SELECT count(id) from Q_xTransactionDetail where TDT = 1 AND Stock_ID = {[ctr2].stock_ID} AND delayed = 1) > 0\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text ' ', 'mt-3'\n\t\t\t\tSELECT TOP 10 [Amount@g] = Amount,[Price] = Price,[currencyISO] = currencyISO,[Counterparty~col-sm-3] = Counterparty,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id,[Reserved*] = case WHEN delayed = 1 THEN 'RESERVED' WHEN delayed = 0 THEN '' END\n\t\t\t\tINTO #InkoopHistorydelayed\n\t\t\t\tfrom Q_xTransactionDetail \n\t\t\t\twhere TDT = 1 AND Stock_ID = {[ctr2].stock_ID} AND delayed = 1 AND TransactionHeader_ID not in (select id from q_xtransactionheader where specialType = 1001)\n\t\t\t\tORDER BY id DESC\n\t\t\t\tALTER TABLE #InkoopHistorydelayed\n\t\t\t\tDROP COLUMN [Stock_ID],[TDT]\n\t\t\t\tEXEC sp_api_modal_table @tmptable=N'#InkoopHistorydelayed',@orderby=N'ORDER BY TransactionDate DESC'\n\t\t\tEND\n\t\tEND\n\tIF @simpelhistory = 1\n\t\tBEGIN\n\t\tSELECT TOP 10 [Amount@g] = Amount,[Price] = Price,[currencyISO] = currencyISO,[Counterparty~col-sm-3] = Counterparty,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id\n\t\tINTO #InkoopHistory2\n\t\tfrom Q_xTransactionDetail \n\t\twhere TDT = 1 AND Stock_ID = {[ctr2].stock_ID} AND delayed != 1 AND TransactionHeader_ID not in (select id from q_xtransactionheader where specialType = 1001)\n\t\tORDER BY id DESC\n\t\tALTER TABLE #InkoopHistory2\n\t\tDROP COLUMN [Stock_ID],[TDT]\n\t\tEXEC sp_api_modal_table @tmptable=N'#InkoopHistory2',@orderby=N'ORDER BY TransactionDate DESC'\n\t\t\n\t\tIF (SELECT count(id) from Q_xTransactionDetail where TDT = 1 AND Stock_ID = {[ctr2].stock_ID} AND delayed = 1) > 0\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text ' ', 'mt-3'\n\t\t\t\tSELECT TOP 10 [Amount@g] = Amount,[Price] = Price,[currencyISO] = currencyISO,[Counterparty~col-sm-3] = Counterparty,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id,[Reserved*] = case WHEN delayed = 1 THEN 'RESERVED' WHEN delayed = 0 THEN '' END\n\t\t\t\tINTO #InkoopHistorydelayed2\n\t\t\t\tfrom Q_xTransactionDetail \n\t\t\t\twhere TDT = 1 AND Stock_ID = {[ctr2].stock_ID} AND delayed = 1 AND TransactionHeader_ID not in (select id from q_xtransactionheader where specialType = 1001)\n\t\t\t\tORDER BY id DESC\n\t\t\t\tALTER TABLE #InkoopHistorydelayed2\n\t\t\t\tDROP COLUMN [Stock_ID],[TDT]\n\t\t\t\tEXEC sp_api_modal_table @tmptable=N'#InkoopHistorydelayed2',@orderby=N'ORDER BY TransactionDate DESC'\n\t\t\tEND\n\t\tEND\nEND \n",
            "action_id": 982,
            "action_name": "Inkoop History",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@detail nvarchar(128),@aantal nvarchar(128),@text nvarchar(128),@price nvarchar(128),@button1 nvarchar(128)\nEXEC sp_api_modal_modal @class = 'w75'\nSET @aantal = (SELECT stock from xstock where id = {[ctr2].stock_ID})\nSET @detail = (SELECT description from xstock where id = {[ctr2].stock_ID})\nSELECT @text = 'History van: ' + @detail + ' Huidige voorraad: ' + @aantal\n\nSET @button1 = 'InkoopHistory'\n\n/* {[ctr2].id343243} */\nif {[ctr2].cth_fase} in (N'openSale')\n\nbegin\n\tEXEC sp_api_modal_text 'INKOOP HISTORY', 'text-primary font-weight-bold text-center display-4'\n\tEXEC sp_api_modal_text @text, 'text-primary font-weight-bold text-center display-4'\n\tEXEC sp_api_modal_text N'Vul prijs in',N'h4 text-muted'\n\tSET @price = {[ctr2].price}\n\tEXEC sp_api_modal_input @name='@price',@max=100, @value= @price OUT,@focus=1\n\tEXEC sp_api_modal_button @name='@button',@value = 'Opslaan', @valueout = @button OUT,@class='btn-primary',@key='Enter'\n\t\tIF @button1 =  'InkoopHistory'\n\t\tBEGIN\n\t\t\t\tSELECT TOP 10 [Amount] = Amount,[Price] = Price,[currencyISO] = currencyISO,[Counterparty~col-sm-3] = Counterparty,[Verkocht aan] = MappedCompanies,\n\t\t\t\t[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id\n\t\t\t\tINTO #InkoopHistory\n\t\t\t\tfrom Q_xTransactionDetail \n\t\t\t\twhere TDT = 1 AND Stock_ID = {[ctr2].stock_ID}\n\t\t\t\tORDER BY id DESC\n\t\t\t\tALTER TABLE #InkoopHistory\n\t\t\t\tDROP COLUMN [Stock_ID],[TDT]\n\t\t\t\tEXEC sp_api_modal_table @tmptable=N'#InkoopHistory',@orderby=N'ORDER BY id DESC'\n\t\tEND \n\tIF @button IS NOT NULL\n\t\tBEGIN\n\t\t\tIF TRY_CAST(@price AS float) IS NOT NULL\n\t\t\t\tBEGIN\n\t\t\t\t\tEXEC sp_api_modal_post N'ctr2',N'price',@price,@id\n\t\t\t\t\tEXEC sp_api_modal_save N'ctr2',@id\n\t\t\t\t\tEXEC sp_api_modal_clear\n\t\t\t\tEND\n\t\tEND\n\nend\nelse execute sp_api_toast N'RH210117: Direct aantal ingave alleen bij open Orders!'\t\t\n",
            "action_id": 983,
            "action_name": "Prijs Invullen / Inkoop History",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @Currentstock nvarchar(128),@mes nvarchar(200)\nDECLARE @toewijzing int ,@TOE nvarchar(200)\nSET @Currentstock = {[ctr2].Stock_ID.Stock}\nSET @mes=concat('Vul aantal in. Huidige voorraad van artikel is: ',@Currentstock)\n/* {[ctr2].id343243} */\nif {[ctr2].cth_fase} in (N'openSale','openPrice')\nBEGIN\n/*\n\n\t\tDECLARE @detail nvarchar(255), @detaildelete nvarchar(255), @detailwarning nvarchar(255)\n\t\tSET @detail = (SELECT concat(Amount,' ',detail) from q_xtransactiondetail where id = @id)\n\t\tSET @detaildelete = concat('Het transport(Pallet/Landfreight) staat op \"Departed\". U kan ',@detail,' niet aanpassen.')\n\t\tSET @detailwarning = concat('Een deel van deze regel is reeds klaargezet, Informeer de loods indien u het aantal wilt aanpassen ',@detail,' Druk op \"OK\"(Enter) om het aantal aan te passen')\n\t\nIF (SELECT COUNT(ID) FROM xlfctr WHERE CTR_ID = @id AND LF_ID IN (SELECT id FROM xLandfreight WHERE STATUS = 'Departed' AND id = xlfctr.LF_ID)) > 0 \n\nAND (SELECT COUNT(ID) FROM xlfctr WHERE CTR_ID = @id AND LF_ID IN (SELECT id FROM xLandfreight WHERE STATUS = 'Loading' AND id = xlfctr.LF_ID)) = 0 \n\tBEGIN\n\t\tEXEC sp_api_modal_Alert N'Let op!',@detaildelete\n\t\tEXEC sp_api_modal_clear\n\t\tRETURN\n\tEND\n\t\nIF (SELECT COUNT(ID) FROM xlfctr WHERE CTR_ID = @id AND LF_ID IN (SELECT id FROM xLandfreight WHERE STATUS = 'Loading' AND i_away = 1 AND id = xlfctr.LF_ID)) > 0 \n\tBEGIN\n\tEXEC sp_api_modal_Alert N'Let op!',@detailwarning\n\tEXEC sp_api_modal_clear\n\tEND\n*/\n\n\tEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\n\t--EXEC sp_api_modal_text N'Vul aantal in',N'h4 text-muted'\n\tSET @aantal = {[ctr2].amount}\n\tset @orgaantal=@aantal -- spaart een onnodige UPDATE uit bij gelijk aantal\n    set @toewijzing =isnull({[ctr2].ivtotal},0)\n\tEXEC sp_api_modal_input @name='@aantal',@max=5, @value= @aantal OUT,@focus=1\n\tEXEC sp_api_modal_button @name='@button',@value = 'Opslaan', @valueout = @button OUT,@class='btn-primary',@key='Enter'\n\tIF @button IS NOT NULL\n\t\tBEGIN\n\t\t\n\t\t\tIF TRY_CAST(@aantal AS int) IS NOT NULL\n\n\t\t\tif @aantal < @toewijzing  --RH210322\n\n\t\t\t\tBEGIN\n\t\t\t\t\tset @TOE=concat(N'Toewijzing is ',@toewijzing,',dus hoger, druk op \"OK\" Enter om de toewijzing te verwijderen!') --eventueel gelijk IV aanpassen met een extra BUTTON??\n\t\t\t\t\tEXEC sp_api_modal_Alert @TOE\n\t\t\t\t\tDELETE FROM xivlink where ITD = @id\n\t\t\t\t\tEXEC sp_api_modal_post N'ctr2',N'amount',@aantal,@id\n\t\t\t\t\tEXEC sp_api_modal_save N'ctr2',@id\n\t\t\t\t\tEXEC sp_api_modal_clear\n\t\t\t\tEND\t\n\t\t\telse\t\n\n\t\t\t\tBEGIN\n\t\t\t\t\tif  @aantal<>@orgAantal\n\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\tEXEC sp_api_modal_post N'ctr2',N'amount',@aantal,@id\n\t\t\t\t\t\t\tEXEC sp_api_modal_save N'ctr2',@id\n\t\t\t\t\t\tend\t\n\t\t\t\t\t\t\tEXEC sp_api_modal_clear\n\t\t\t\t\t\t\t\n\t\t\t\tEND\n\n\t\tEND\nend\nelse execute sp_api_toast N'RH210117: Direct aantal ingave alleen bij open Orders!'\t\t",
            "action_id": 984,
            "action_name": "Verander Aantal",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @search nvarchar(128) ,@button nvarchar(128),@Stock_ID int\n--EXEC sp_api_modal_input @name='search',@value = @search OUT,@focus=1 -- zoek veld\nSET @Stock_ID = (select Stock_ID from Q_xtransactiondetail where id = @id)\nSET @button = 'StockMutOverzicht'\nEXEC sp_api_modal_button @name='button',@value = 'StockMutOverzicht',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_modal @class = 'w100'\n\nIF @button =  'StockMutOverzicht'\nBEGIN\nSELECT *\nINTO #StockMutOverzicht\nFROM         @main_db.dbo.tvf_RV_StockMutOverzicht(@Stock_ID)\n--WHERE       @id = Stock_ID\nEXEC sp_api_modal_table @tmptable=N'#StockMutOverzicht'\nEND ",
            "action_id": 985,
            "action_name": "Stock Mutatie Overzicht",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @prijs nvarchar(128),@button nvarchar(128)\nEXEC sp_api_modal_input @name='Prijs', @value= @prijs OUT,@focus=1,@select=1\nEXEC sp_api_modal_button @name='Kies',@value = 'Opslaan', @valueout = @button OUT,@class='btn-danger',@key='Enter'\nIF @button IS NOT NULL AND TRY_CAST(@prijs as float) IS NOT NULL\n\tBEGIN\n\t \tEXEC SP_API_MODAL_ALERT N'LET OP!', N'U gaat alle prijzen van de geselecteerde regels veranderen druk \"Enter\" om door te gaan.',@class = 'btn-danger'\n\t\tDECLARE @cursor CURSOR,@idval INT\n\t\tSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\n\t\tOPEN @cursor;\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_post @card_name ,'price' ,@prijs ,@idval\n\t\t\t\tEXEC sp_api_modal_save @card_name,@idval\n\t\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\tEND\n\t\tCLOSE @cursor;\n\t\tDEALLOCATE @cursor;\n\t\tEXEC sp_api_modal_clear\n\t\tEXEC sp_api_modal_select_all_clear\n\tEND\n\n",
            "action_id": 986,
            "action_name": "Set 1 Price For Multi",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--\t201124 let op: dit is de simpele verkoop indicator wissel voor direct.. \n--;\tBij inkloop is dit veel complexer!! \ndeclare @Direct int\nselect @Direct=iif(isnull(Flowmodel_ID,2)=2,1,NULL) from xtransactiondetail where id=@ID\nupdate xtransactiondetail set Flowmodel_id=@Direct where id=@ID\n",
            "action_id": 988,
            "action_name": "Toggle DV NV",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128),@detail nvarchar(128),@aantal nvarchar(128),@text nvarchar(128),@soldtoday nvarchar(128),@datumrange nvarchar(50)\nEXEC sp_api_modal_modal @class = 'w75'\nSET @date = dbo.workDate()\nSET @aantal = (SELECT stock from xstock where id = {[ctr2].stock_ID})\nSET @detail = (SELECT description from xstock where id = {[ctr2].stock_ID})\nSET @soldtoday = (SELECT SUM(Amount) from q_xtransactiondetail where TDT = 2 AND Stock_ID = {[ctr2].stock_ID} and delayed != 1 AND TransactionHeader_ID not in (select id from q_xtransactionheader where specialType = 1001) AND dbo.daysago(TransactionDate,NULL) < 1)\nSELECT @text = 'History van: ' + @detail + ' | Huidige voorraad: ' + @aantal + ' | Vandaag verkocht: ' + @soldtoday\nEXEC sp_api_modal_text 'VERKOOP HISTORY', 'text-primary font-weight-bold text-center display-4'\nEXEC sp_api_modal_text @text, 'text-primary font-weight-bold text-center h2'\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n--EXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\nEXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\nSET @datumrange = concat(@from, ' - ', @to)\nEXEC sp_api_modal_button @name='button',@value = 'VerkoopHistory',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\n\n\nSET @button = 'VerkoopHistory'\n\nIF @button =  'VerkoopHistory'\nBEGIN\n\tSELECT [Amount@g] = Amount,[Price] = Price,[currencyISO] = currencyISO,[Counterparty] = Counterparty,[MappedCompanies] = MappedCompanies,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id,[Opmerking] = logistic\n\tINTO #VerkoopHistory\n\tfrom Q_xTransactionDetail \n\twhere TDT = 2 AND THDT = 2 AND Stock_ID = {[ctr2].stock_ID} and delayed != 1 AND TransactionHeader_ID not in (select id from q_xtransactionheader where specialType = 1001)\n\tAND (Q_xTransactionDetail.TransactionDate BETWEEN @from AND @to)--dbo.daysago(TransactionDate,NULL) < 1\n\tORDER BY id DESC\n\tALTER TABLE #VerkoopHistory\n\tDROP COLUMN [Stock_ID],[TDT]\n\tEXEC sp_api_modal_table @tmptable=N'#VerkoopHistory',@orderby=N'ORDER BY TransactionDate DESC'\n\t\n\tIF (SELECT count(id) from Q_xTransactionDetail where TDT = 2 AND Stock_ID = {[ctr2].stock_ID} and delayed = 1) > 0\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_text ' ', 'mt-3'\n\t\t\tSELECT [Amount@g] = Amount,[Price] = Price,[currencyISO] = currencyISO,[Counterparty] = Counterparty,[MappedCompanies] = MappedCompanies,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id,[Opmerking] = logistic,[Reserved*] = case WHEN delayed = 1 THEN 'GERESERVEERDE VERKOOP' WHEN delayed = 0 THEN '' END\n\t\t\tINTO #VerkoopHistorydelayed\n\t\t\tfrom Q_xTransactionDetail \n\t\t\twhere TDT = 2 AND THDT = 2 AND Stock_ID = {[ctr2].stock_ID} and delayed = 1 AND TransactionHeader_ID not in (select id from q_xtransactionheader where specialType = 1001)\n\t\t\t--AND dbo.daysago(TransactionDate,NULL) < 1\n\t\t\tORDER BY id DESC\n\t\t\tALTER TABLE #VerkoopHistorydelayed\n\t\t\tDROP COLUMN [Stock_ID],[TDT]\n\t\t\tEXEC sp_api_modal_table @tmptable=N'#VerkoopHistorydelayed',@orderby=N'ORDER BY TransactionDate DESC'\n\t\tEND\nEND \n",
            "action_id": 989,
            "action_name": "Verkoop History",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--name: Afleverbon naar jezelf\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\nDECLARE @TEST BIT = 0\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\t--dit is nu alleen voor tellers en checks, zodat we weten dat het report al is gemaakt:\n\t\t--EXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'CTH'\t,@Context_Key_ID=@cid,@Report_CODE=N'CONF_DELIVERY' -- zie runreport \n\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select Counterparty_id from xtransactionheader where id=@cid)\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = 'deliverynote' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@fixedfrom ='test_action2318.990@tracy.nu'\n\t\t\t,@fixedEmail = @User_name --forceer mail naar de user toe\n\t\t\t--VOORBEELD VERZENDEN PER FAX: ,@fixedEmail = '+31 174 210 210'\t--of plat: ,@fixedEmail = '31174210210@efaxsend.com' \n\t\t\t,@test=0\n\n\n\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 990,
            "action_name": "afleverbon test fax naar anaco",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @sys_report_key nvarchar(50) = N'purchase_conf'\ndeclare @test bit =0 -- 0:LIVE ; 1=TEST\nEXEC sp_api_toast @sys_report_key--N'Orderbevestiging' \n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\t--EXEC sp_api_toast @cid\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select Counterparty_id from xtransactionheader where id=@cid)\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = @sys_report_key--'confirmation_out' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@test=@test\n\n\t\t--dit is nu alleen voor tellers en checks:\n\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'CTH'\t,@Context_Key_ID=@cid,@Report_CODE=N'CONF' -- MOET EIGEN TELLER KRIJGEN\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 991,
            "action_name": "Inkoop bevestiging",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--RH210223 Koop artikelen in op basis van een geselecteerde verkooporder\n--========================================================================\n\nDECLARE @cth2_id nvarchar(32),@button nvarchar(128),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000)\n,@button1 nvarchar(128) = N'Gebruik deze verkoop'\n\nEXEC sp_api_modal_select @card_name = N'Verkoop',@value = @cth2_id OUT,@focus = 1, @fieldname=N'select01'\nexec sp_api_toast @cth2_id\n\n\nexec @main_db.dbo.Create_CTR1_For_SalesOrder @CTH_ID=@ID, @CTH2_ID=@cth2_id\nif @cth2_id >0 exec sp_api_modal_clear;\n",
            "action_id": 997,
            "action_name": "kies verkoop",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast 'Updated!',@seconds=1",
            "action_id": 1018,
            "action_name": "sys_refresh",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @sys_report_key nvarchar(50) = N'purchase_conf'\ndeclare @test bit =0 -- 0:LIVE ; 1=TEST\nEXEC sp_api_toast @sys_report_key--N'Orderbevestiging' \n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\t--EXEC sp_api_toast @cid\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select Counterparty_id from xtransactionheader where id=@cid)\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = @sys_report_key--'confirmation_out' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@test=@test\n\n\t\t--dit is nu alleen voor tellers en checks:\n\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'CTH'\t,@Context_Key_ID=@cid,@Report_CODE=N'CONF' -- MOET EIGEN TELLER KRIJGEN\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 1019,
            "action_name": "Inkoop bevestiging",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--RH210223 Koop artikelen in op basis van een geselecteerde verkooporder\n--========================================================================\n\nDECLARE @cth2_id nvarchar(32),@button nvarchar(128),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000)\n,@button1 nvarchar(128) = N'Gebruik deze verkoop'\n\nEXEC sp_api_modal_select @card_name = N'Verkoop',@value = @cth2_id OUT,@focus = 1, @fieldname=N'select01'\nexec sp_api_toast @cth2_id\n\n\nexec @main_db.dbo.Create_CTR1_For_SalesOrder @CTH_ID=@ID, @CTH2_ID=@cth2_id\nif @cth2_id >0 exec sp_api_modal_clear;\n",
            "action_id": 1020,
            "action_name": "kies verkoop",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--RETOUR VIA VERKOOP AAN DE LEVERANCIER\nSET @text = CONCAT(N'Inkoop retour als verkoop aan ',{[inkoop].Counterparty_ID.CompanyName})\nEXEC sp_api_modal_text @text,N'h4 text-muted'\n\nDECLARE @maxAmount int,@inPrice float\nSET @maxAmount = {[ctr1].IVTOTAL}\nSET @inPrice = {[ctr1].price}\n\nIF @aantal IS NULL SET @aantal = @maxAmount\nIF @prijs IS NULL SET @prijs = @inPrice\n\nSET @text = CONCAT('Aantal (max. ',@maxAmount,')')\nEXEC sp_api_modal_text @text\nEXEC sp_api_modal_input_decimal @name='@aantal',@value= @aantal OUT ,@precision=18,@scale=0\n\nSET @text = CONCAT('Prijs (inkoop ',@inPrice,')')\nEXEC sp_api_modal_text @text\nEXEC sp_api_modal_input_decimal @name='@prijs',@value= @prijs OUT,@precision=18,@scale=2\n\nEXEC sp_api_modal_button @name='@button',@value = 'Retour', @valueout = @button OUT,@class='btn-danger',@key='Enter'\nIF @button IS NOT NULL\n\tBEGIN\n\t\tIF @maxAmount < @aantal\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text N'Het aantal is groter dan maximaal mogelijk!'\n\t\t\t\tRETURN\n\t\t\tEND\n\t\tDECLARE @Counterparty_ID int = {[inkoop].Counterparty_ID}\n\t\tDECLARE @new_CTHidentity int\n\t\tEXEC @main_db.dbo.CreateCTH2 @Counterparty_ID, @new_identity = @new_CTHidentity OUTPUT,@specialType = 'return_purchase'\n\t\tIF @new_CTHidentity IS NOT NULL\n\t\t\tBEGIN\n\t\t\t\tDECLARE @new_CTRidentity int\n\t\t\t\tDECLARE @old_CTRidentity int = {[ctr1].ID}\n\t\t\t\tDECLARE @Stock_ID int = {[ctr1].Stock_ID}\n\t\t\t\tEXEC @main_db.dbo.CreateCTR @CTH_ID = @new_CTHidentity, @Stock_ID = @Stock_ID,@Amount = @aantal, @Price = @prijs, @new_identity = @new_CTRidentity OUTPUT;\n\t\t\t\tINSERT INTO xIVLINK (ITD,VTD,LinkAantal,Stock_ID) VALUES(@new_CTRidentity,@old_CTRidentity,@aantal,@Stock_ID)\n\t\t\t\tEXEC sp_api_modal_clear\n\t\t\t\tSET @text = CONCAT(N'Inkoop retour als verkoop aan ',{[inkoop].Counterparty_ID.CompanyName})\n\t\t\t\tEXEC sp_api_modal_text @text,N'h4 text-muted'\n\t\t\t\tSET @text = CONCAT(N'/verkoop/?id=',@new_CTHidentity)\n\t\t\t\tEXEC  sp_api_modal_route @name = N'Naar verkoop',@pathname=@text,@class = N'btn-success' ,@key = N'Enter'\n\t\t\tEND\n\t\tELSE\n\t\t\tEXEC sp_api_modal_text N'Error, kan geen verkoop maken'\n\tEND\n ",
            "action_id": 1027,
            "action_name": "retour_inkoop",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @RestVoorraad int\nset @Restvoorraad = isnull({[ctr1].Amount},0) - isnull((select SumLinked from @main_db.dbo.ivtotal(@ID) ),0)\nexec sp_api_toast @Restvoorraad\nif @Restvoorraad >0 \n\tbegin\n\t\tDeclare @Klant_ID int={[ctr1].Counterparty_ID}\n\t\tDeclare @new_CTHidentity int\n\t\tEXEC @main_db.dbo.CreateCTH2 @klant_ID, @new_identity = @new_CTHidentity OUTPUT\n\t\tif @new_CTHidentity is null RETURN -- afbreken als het niet is gelukt\n\t\t\n\t\t\n\n\tend",
            "action_id": 1032,
            "action_name": "rick",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--RETOUR MET NEGATIEVE INKOOPREGEL\n\nSET @text = CONCAT(N'Inkoopregel retour aan ',{[inkoop].Counterparty_ID.CompanyName})\nEXEC sp_api_modal_text @text,N'h4 text-muted'\n\nDECLARE @maxAmount int,@inPrice float\n--SET @maxAmount = {[ctr1].IVTOTAL} --alleen vrij beschikbaar kan retour worden geboekt \nSET @maxAmount = isnull({[ctr1].Amount},0) - isnull({[ctr1].IVTOTAL},0)\nif @maxAmount <= 0 RETURN\n\nSET @inPrice = {[ctr1].price}\n\nIF @aantal IS NULL SET @aantal = @maxAmount\nIF @prijs IS NULL SET @prijs = @inPrice\n\nSET @text = CONCAT('Aantal (max. ',@maxAmount,')')\nEXEC sp_api_modal_text @text\nEXEC sp_api_modal_input_decimal @name='@aantal',@value= @aantal OUT ,@precision=18,@scale=0\n\nSET @text = CONCAT('Prijs (inkoop ',@inPrice,')')\nEXEC sp_api_modal_text @text\nEXEC sp_api_modal_input_decimal @name='@prijs',@value= @prijs OUT,@precision=18,@scale=2\n\nEXEC sp_api_modal_button @name='@button',@value = 'Retour', @valueout = @button OUT,@class='btn-danger',@key='Enter'\nIF @button IS NOT NULL\n\tBEGIN\n\t\tIF @maxAmount < @aantal\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text N'Het aantal is groter dan maximaal mogelijk!'\n\t\t\t\tRETURN\n\t\t\tEND\n\t\tDECLARE @new_CTHidentity int = {[inkoop].ID}\n\t\tDECLARE @new_CTRidentity int\n\t\tDECLARE @old_CTRidentity int = {[ctr1].ID}\n\t\tDECLARE @Stock_ID int = {[ctr1].Stock_ID}\n\t\tDECLARE @Amount int = -CAST(@aantal as int)\n\t\tEXEC @main_db.dbo.CreateCTR @CTH_ID = @new_CTHidentity, @Stock_ID = @Stock_ID,@Amount = @Amount, @Price = @prijs, @new_identity = @new_CTRidentity OUTPUT;\n\t\tINSERT INTO xIVLINK (ITD,VTD,LinkAantal,Stock_ID) VALUES(@old_CTRidentity,@new_CTRidentity,@aantal,@Stock_ID)\n\t\tEXEC sp_api_modal_clear\n\tEND",
            "action_id": 1041,
            "action_name": "retour_ctr",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--CARD \" HEFFINGTVERLOOP \"  \n\n----------------------------------------------------------------------------------------------------------------\n\nDECLARE @Code nvarchar(10) ='C_TARIFF' --GEEN UNICODE --CURRENCY, DIESEL, DOUANEHEFFING PER 100KG...\nDECLARE @ContextID INT = isnull({[customs_tariff].contextid},{[xprodtariff].id})-- context van de huidige kaart\nif @Code is null or @contextid is null\n\tbegin\n\t\texec sp_api_modal_Alert N'Context of code bestaat niet, raadpleeg uw consultant.'\n\t\treturn;\n\tend\n\nDECLARE @mes nvarchar(200)--, @xDesc nvarchar(200)\n--DECLARE @prijs nvarchar(20),@aantal nvarchar(20) --='100'\n\nDECLARE @xValRateID INT = {[heffingverloop].id} -- we moeten staan in kaart heffingverloop !\nif isnull(@xValRateID,0) = 0 -- 0 als er nog geen waardes zij, dan het eerste record aanmaken\n\tBEGIN\n\t\t--Nieuwe xValue aanmaken als xValue niet bestaat\t\n\t\tif not exists(select id from xValue where code=@Code and ContextID=@ContextID)\n\t\t\tinsert into xvalue (code, contextid, returntype) values (@Code,@ContextID,N'F')\n\n\t\t--xValue bestaat nu gegarandeerd!\n\t\tdeclare @xVALID int =(select top 1 id from xValue where code=@Code and ContextID=@ContextID)--  and returntype='F')\n\t\n\t\tdeclare @totext nvarchar(200) = concat(N'xval_ID=',@xvalid)\n\t\texecute sp_api_toast @totext\n\t\tif @xVALID is not null\n\t\t\tbegin\n\t\t\t\tINSERT INTO [dbo].[xValrate]\n        \t   ([xVal_ID]\n           \t\t,[code]\n           \t\t,[contextID]\n           \t\t,[F]\n--        \t\t,[F2]\n           \t\t,[StartDate]\n           \t\t,[ReturnType]\n           \t\t,[EndDate])\n\t\t\t\tselect \t@xValID\n        \t\t  ,@Code\n\t\t          ,@ContextID\n\t    \t      ,[F]--startwaarde\n        \t  \t  ,'01/01/2021'--het begin der Tracy AGFx Tijden...\n\t        \t  ,[ReturnType]--startwaarde\n    \t\t      ,NULL\n\t\t\t\tfrom xvalue where id=@xVALID\n\t\t\tend\n\treturn; -- nieuw record. stoppen. Als men een koers wil ingeven, dan nog een keer klikken..\n\t\t-- we kunnen ook het nieuwe inserted ID  hier in @ContextID stoppen...\n\texec sp_api_modal_clear;\n\n\t\t\n\tEND\n\t\n\t\t\n\n\t\t\n\nselect @Code=code\n\t\t, @ContextID=ContextID\n\t\t--, @CardStartDate =startdate \n\tfrom xvalrate where ID=@xValrateID --pak de eigenschappen van het record waar je op staat\nexec sp_api_toast @code\n--return;\n\ndeclare @datum nvarchar(512)\t--input\nDECLARE @Rate float\t\t--input\nDECLARE @Rate100K float\t\t\t\t--input\n\nset @mes=N'Invoeren nieuwe douanewaarde'\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\nEXEC sp_api_modal_text 'Datum'\nSET @datum = dbo.strdate(getdate())--'2020-10-30'\nEXEC sp_api_modal_date @name='Ingangsdatum:',@value= @datum OUT,@class = 'w-25' ,@focus=1\nEXEC sp_api_toast @datum\n\nEXEC sp_api_modal_text 'Waarde op deze datum:'\nEXEC sp_api_modal_input_decimal @name='Percentage',@value = @Rate OUT\nEXEC sp_api_modal_input_decimal @name='Heffing per 100 KGN',@value = @Rate100K OUT\n--IF @Rate>N'' SET @Rate=replace(@Rate, ',', '.') --zorg dat punten en kommas als dec. seperator zijn toegestaan..\n--IF @Rate100K>N'' SET @Rate100K=replace(@Rate100K, ',', '.') --zorg dat punten en kommas als dec. seperator zijn toegestaan..\nIF @Rate IS NULL SET @Rate = 0.0\nIF @Rate100K IS NULL SET @Rate100K = 0.0\nDECLARE @button nvarchar(128)\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\nIF @button IS NOT NULL\n\tBEGIN\n\t\texec @main_db.dbo.SetxValRate_F \t@Code = @Code\t,@ContextID =@ContextID\t,@StartDate =@datum\t,@F =@Rate, @F2=@Rate100K\n\t\t/*\n\t\tDECLARE @sql nvarchar(max)= CONCAT(N'exec @main_db.dbo.SetxValRate_F \t@Code = ',@Code,'\t,@ContextID =',@ContextID\n\t\t\t,'\t,@StartDate =',@datum,'\t,@F =',@Rate,', @F2=',@Rate100K)\n\t\tEXEC sp_api_toast @sql\n\t\t*/\n\t\tEXEC sp_api_modal_clear\t\t\n\t\tRETURN\n\tEND\n",
            "action_id": 1049,
            "action_name": "Wijzig Tarief",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @Code varchar(10) ='DIESEL'  --CURRENCY, DIESEL, ...\ndeclare @xValueID int ={[dieseltoeslag].ID}\nDECLARE @ContextID INT ={[dieseltoeslag].contextID} -- context van de huidige kaart\nDECLARE @mes nvarchar(200)--, @xDesc nvarchar(200)\nDECLARE @prijs nvarchar(20),@aantal nvarchar(20) --='100'\n\nDECLARE @xValRateID INT = {[dieselverloop].id}\n\nif isnull(@xValRateID,0) = 0 -- 0 bij splinternieuwe kaart, dan geen koersen zetten op deze manier\n\tBEGIN\n\n\t\t\n\n\t\t--EXEC SP_API_TOAST N'Er kan geen nieuwe waarde worden toegevoegd. Dit kan alleen op bestaande xValrate kaarten.'\n\t\t--RETURN;\n\t\n\n\t\tif @ContextID is not null AND @xValueID is NULL\n\t\t\tselect @xValueID = id from xValue where code='DIESEL' and ContextID=@ContextID and returntype='F'\n\n\t\tif @xValueID is not null\n\t\t\tbegin\n\t\t\t\tINSERT INTO [dbo].[xValrate]\n        \t   ([xVal_ID]\n           \t\t,[code]\n           \t\t,[contextID]\n           \t\t,[F]\n           \t\t,[StartDate]\n           \t\t,[ReturnType]\n           \t\t,[EndDate])\nselect \t[ID]\n          ,[code]\n          ,[contextID]\n          ,[F]\n          ,isnull([startdate],@main_db.dbo.ABCBOM())\n          ,[ReturnType]\n          ,NULL\nfrom xvalue where id=@xValueID\n\n\t\nreturn; -- nieuw record. stoppen. Als men een koers wil ingeven, dan nog een keer klikken..\n\t\t-- we kunnen ook het nieuwe inserted ID  hier in @ContextID stoppen...\n\n\t\t\tend\n\n\t\t\t\t\n\tEND\n\n\nselect @Code=code\n\t\t, @ContextID=ContextID\n\t\t--, @CardStartDate =startdate \n\tfrom xvalrate where ID=@xValrateID\nexec sp_api_toast @code\n--return;\n\ndeclare @datum nvarchar(512)\t--input\nDECLARE @koers nvarchar(20)\t\t--input\nset @mes=N'Invoeren van dieseltoeslag'\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\nEXEC sp_api_modal_text 'Datum'\nSET @datum = dbo.strdate(getdate())--'2020-10-30'\nEXEC sp_api_modal_date @name='Ingangsdatum:',@value= @datum OUT,@class = 'w-25' ,@focus=1\nEXEC sp_api_toast @datum\n\nEXEC sp_api_modal_text 'Waarde op deze datum:'\nEXEC sp_api_modal_input @name='koers',@value = @koers OUT\nIF @Koers>N'' SET @Koers=replace(@Koers, ',', '.') -- zorg dat punten en komma's als dec. seperator zijn toegestaan..\n\n\nDECLARE @button nvarchar(128)\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\nIF @button IS NOT NULL\n\tBEGIN\n\t\texec @main_db.dbo.SetxValRate_F \t@Code = @Code\t,@ContextID =@ContextID\t,@StartDate =@datum\t,@F =@koers\n\t\tEXEC sp_api_modal_clear\t\t\n\t\tif @Code=N'CURRENCY' -- maar dus bijvoorbeeld niet bij card 'dieselverloop'\n\t\t\tbegin\n\t\t\t\tdeclare @TT nvarchar(200)=concat(N'CTHTOTALS: currency ',@ContextID,'  naar: ',@koers)\n\t\t\t\texec @main_db.dbo._Writelog @TT\n\t\t\t\tupdate T  set t.currencyXrate=@koers \n\t\t\t\tfrom xcthtotals T inner join xtransactionheader cth on cth.id=t.cth_id\n\t\t\t\twhere t.lfdate>=@datum and cth.currency_id=@contextID\n\t\t\tend\t\t\n\t\tRETURN\n\tEND\n",
            "action_id": 1058,
            "action_name": "Nieuw tarief",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_select @name='@selected_card_id',@card_name='apicard', @value = @selected_card_id OUT\nSET @button_text = N'Import everything'\nIF @selected_card_id IS NOT NULL SET @selected_card_name = (SELECT name FROM api_card WHERE id = @selected_card_id)\nIF @selected_card_name IS NOT NULL SET @button_text = N'Import ' + @selected_card_name\nEXEC sp_api_modal_button @name='@button',@value = @button_text, @valueout = @button OUT,@class='btn-danger',@key='F1'\nIF @button IS NOT NULL\n\tBEGIN\n\t\tEXEC sp_api_import_from_master @card_name = @selected_card_name\n\t\tEXEC sp_api_modal_clear\n\tEND\n",
            "action_id": 1065,
            "action_name": "sys_import_config",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_date_from_to @from = @from OUT, @to = @to OUT\nEXEC sp_api_modal_action N'sp_api_modal_select_table2'",
            "action_id": 1073,
            "action_name": "date from to",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--maak een tdt=2 tegenboeking op de inkoop (zelfde partij)\ndeclare @ivtotal int, @amount int, @bronCTR int, @retourCTR int, @stockid int, @rest int, @bronCTH int\nset @ivtotal=isnull({[ctr1].ivtotal},0)\nset  @amount=isnull({[ctr1].amount},0)\nset @rest=@amount-@ivtotal\nset @bronCTR={[ctr1].id}\nset\t@stockid={[ctr1].stock_id}\nset\t@bronCTH ={[ctr1].transactionheader_id}\n\nexecute sp_api_toast @ivtotal\n\n--clone regel met rest retour\nDECLARE @sure nvarchar(255), @text nvarchar(255)\nEXEC sp_api_modal_get N'my_last_clone_id',@text OUT\n--EXEC sp_api_modal_text @text,'h1'\nEXEC sp_api_modal_text N'Als u de rest voorraad van deze inkoopregel wilt retourneren naar de leverancier, klik dan op ''Returneren'', anders ESC.','h2'\nEXEC sp_api_modal_button @name='Sure',@value = 'Retourneren', @valueout = @sure OUT,@class='btn-danger',@key='Enter'\nIF @sure is not null \n\tBEGIN\n\t\tif @rest <= 0 \n\t\t\tbegin\n\t\t\t\texec sp_api_modal_clear\n\t\t\t\treturn --afkappen, niets te doen..\n\t\t\tend\t\n\t\tEXEC sp_api_modal_clear\n\t\t\n\t\t\n\t\t\n\t\t--MAAK RETURN KOP 101\n\t\tDeclare @CTH101 int\n\t\texecute @CTH101 = @main_db.dbo.CreateCTH101 @Base_CTH_ID=@bronCTH\t\n\t\tif @cth101 is null\n\t\t\tbegin\n\t\t\t\texec sp_api_modal_alert N'GEEN CTH AANGEMAAKT..'\n\t\t\t\treturn\n\t\t\tend\n\t\t\n\t\t\n\t\t\n\t\t\n\t\t--DE REGEL\n\t\tdeclare @ResultTDT int = 2 \t\t\t\t--210422 was 2\n\t\tdeclare @ResultRest int =  @Rest\t--210422 was @Rest\n\t\t\n\t\tdeclare @ChangeFields nvarchar(512) =concat(N'TDT=',@ResultTDT,' ,Amount=', @ResultRest, ' , transactionheader_id=',@CTH101,' , advMapCtr_ID=',@bronctr)\n\t\t\n\t\tEXEC @retourCTR = sp_clone_record @tablename=@basetable,@ids=@ids,@set=@ChangeFields\n\t\t--SET @path = @path+'/'+dbo.nv(@clone_id)\n\t\t--EXEC sp_api_toast @text = N'Record cloned'\n\t\t--EXEC sp_api_modal_route @name = N'Ga met Enter naar de kopie en vul de nieuwe maat in',@pathname=@path,@search='?focus=7377' ,@class = N'btn-danger' ,@key='Enter'\n\t\tif @retourCTR is not NULL \n\t\t\tinsert into xivlink (stock_id,linkaantal,vtd,itd) values (@stockid,@ResultRest,@bronCTR,@retourCTR) -- 210422 nu resultrest!\t\n\tEND\n--execute sp_api_modal_clear\t",
            "action_id": 1098,
            "action_name": "Rest Retour",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "\n--EXEC sp_api_modal_choose @list = N'Transporteur',@value = @button_choose OUT--,@startkey=NULL\n\nDECLARE @company_id nvarchar(32)\n\n\nDECLARE @date nvarchar(128),@button nvarchar(128)/*,@from nvarchar(128),@to nvarchar(128),*/\n\t,@datumrange nvarchar(50)\nset @date = dbo.workDate()\n\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n--IF @button_choose IN ('Beide','Periode')\n--\tBEGIN\n--\t\tIF @startdate IS NULL SET @startdate = @main_db.dbo.abcbom()\n--\t\t--IF @enddate IS NULL SET @startdate = @main_db.dbo.abceom()\n--\t\tEXEC sp_api_modal_date_from_to @from=@startdate out, @to=@enddate out,@class='w-24'\n--\tEND\n\t\nIF 1=1 --@button_choose IN ('Transporteur')\n\tBEGIN\n\t\tEXEC sp_api_modal_select @card_name = N'transporteur',@value = @company_id OUT ,@focus = 1,@top = 3--,@select = 1\n\t\tIF @company_id IS NULL RETURN\n\tEND\n--IF @company_id IS NOT NULL EXEC sp_api_modal_focus N'geert' --blurr\n\nSET @button = '*KIES*'\n--SET @datumrange = concat(@startdate, ' - ', @enddate)\n--EXEC sp_api_modal_text @datumrange, @printonly=1\n\nEXEC sp_api_modal_button @name='button',@value = 'Toon de lijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print @keycode = N'Ctrl+P'\n\n-- \tSELECT TransactionDate, TV_CompanyName,[currencyISO*] = currencyISO,id, [totalProductPrice@] = totalProductPrice, [DATE*] = concat(@from, ' - ', @to)\n\nIF --@button_choose IS NOT NULL --=  'SalesPerLot'\n\t-- simpel: \n\t@Button='Toon de lijst'\nBEGIN\n\n\n\nSELECT \n\n--HENK: KOLOMMEN\n--select * from  tracy_fkt.dbo.Oprijvracht_fn(dbo.abcdate()-27,NULL,159794,NULL)\nN'INKOOP: ' as [O*],CTH1_ID as [Order*],\tN'LOKATIE: ' as [L*], LocationCode as [LOK*], N'LAADREF: ' as [LR*],\tPickupRef as [Pickupref*],\t'TEL:' as [t*],\tphone as [phone*],\tchar(13)+char(10) as [ch13*], N'TRANSPORTEUR: ' as [TRAN*],Transp_Code as [Transp*],\tN'BLOK: ' as [BL*], Blok as [Blok*], \tN'EURO: ' as [EU*],Euro as [EUR*],\tN'EXTRA OPMERKING: '\tas [extra*], pickupRemarks as [Rem*~wrap], LEFT(CONVERT(VARCHAR, [datum] , 106), 13) as [Datum*], LFCTR_Amount,\tDescription, ContentDesc\tSize,\tKGN,\tDetail_0,\tOrigin_Code as[oc~center],Fustcode\n\n\n\tINTO #Oprijvracht_fn\n\nFROM @main_db.dbo.Oprijvracht_fn(@date,NULL,@company_id,NULL)\n--\torder by VTH_CODE, Stock_ID,  Variety_0,ContentDesc\t,RegionCode\n\t\n\tSET @filename = CONCAT(N'Oprijvracht_fn',@date,'.csv')\n--to csv\n\tEXEC sp_api_modal_button @name='@button_csv',@value = N'CSV', @valueout = @button_csv OUT ,@class='btn-danger',@key='F4'\n\tIF @button_csv IS NOT NULL EXEC sp_api_modal_csv @tmptable = N'#Oprijvracht_fn',@filename=@filename\n--print\n\tEXEC sp_api_modal_table @tmptable=N'#Oprijvracht_fn',@print=1 ,@orderby=N'ORDER BY 1,2,3 ASC'\nEND \n",
            "action_id": 1099,
            "action_name": "Oprijvracht",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "set @testmodus =1 --0=live; 1=test!\n\nEXEC sp_api_toast N'Transport-overzicht voor Transporteur' \nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\nDECLARE @TrComp_ID int\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\t--dit is nu alleen voor tellers en checks:\n\n\t\t--even niet registreren dat er wordt afgedrukt\n\t\t--EXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'LF'\t,@Context_Key_ID=@cid,@Report_CODE=N'TRANSPORT' --transportorder\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = {[xlandfreight].transportCompany_ID}\n\t\t--DECLARE @error INT\n\t\tset @trComp_ID = (select TransportCompany_ID from @main_db.dbo.xlandfreight where id=@cid)\n\t\t\n\t\tif @trComp_ID is NOT NULL\n\t\t\tEXEC sp_api_report_generate @id = @trComp_ID\n\t\t\t\t,@sys_report_key = 'transport-overview' --zie xrepdef\n\t\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t\t,@test=@testmodus\n\t\telse execute sp_api_modal_alert N'IK HEB GEEN TRANSPORTCOMPANY OP LANDFREIGHT'\t\n\t\t--IF @error > 0 RAISERROR(N'Er is een probleem')\n\t\t\n\t\t--set @reptxt=concat(N'to transporter: ',@toCompany_ID)\n\t\t--execute sp_api_toast @reptxt\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 1100,
            "action_name": "Overzicht Transport",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 1101,
            "action_name": "Dag_Terug",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 1102,
            "action_name": "Dag_Verder",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "PRINT 'werwer' --gewrtwertwert;dfgs ger seg\n\n--SELECT dataset='raw', json=(SELECT * FROM xCountry FOR JSON PATH)",
            "action_id": 1106,
            "action_name": "Raw output attempt",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_alert N'Sure?',N'This will regenerate the apikey. You cannot undo this.'\nDECLARE @random varchar(max)\nSET @random = CONCAT(\n\tHASHBYTES('SHA2_512',CAST(newid() as varchar(max))),\n\tHASHBYTES('SHA2_512',CAST(newid() as varchar(max))),\n\tHASHBYTES('SHA2_512',CAST(newid() as varchar(max)))\n\t)\nSET @random = dbo.RemoveNonAlphaNum(@random COLLATE SQL_Latin1_General_CP1253_CS_AS)\nUPDATE api_data_set_keys SET apikey = @random WHERE id = @id\n--EXEC sp_api_modal_post 'api_data_set_keys','apikey',@random,@id\n--EXEC sp_api_modal_text @random",
            "action_id": 1112,
            "action_name": "generate_apikey",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "SET @url = {[api_data_set].urlinfo}\nSET @apikey = {[api_data_set].apikey.apikey}\nEXEC sp_api_modal_text 'Url',@class = N'mt-2'\nEXEC sp_api_modal_text @text = @url,@class = N'code'\nIF @apikey IS NOT NULL\n\tBEGIN\n\t\tEXEC sp_api_modal_text 'ApiKey',@class = N'mt-2'\n\t\tEXEC sp_api_modal_text @text = @apikey,@class = N'code'\n\tEND\nSET @json = CONCAT('{\"url\":\"',@url,'\",\"options\":{\"headers\":{\n\t\t\t\"Content-Type\":\"application/json\"\n\t\t\t',IIF(@apikey>'',',\"ApiKey\":\"'+@apikey+'\"',''),'\n\t\t}}}')\nEXEC sp_api_broker_request @type=N'fetch',@json=@json,@dataout = @dataout OUT,@wait = 15000\nEXEC sp_api_modal_text 'Result',@class = N'mt-2'\nSET @dataout = (SELECT value FROM OPENJSON(@dataout) WHERE [key] = 'data')\nEXEC sp_api_modal_text @text = @dataout,@class = N'json'\n",
            "action_id": 1116,
            "action_name": "test_api_data_set",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "/*\n\tpredeclare: @api_card_tablename,@api_card_basetable,@button,@name\n*/\nEXEC sp_api_modal_text N'Change table, view and/or basetable',N'h4 text-muted'\nEXEC sp_api_modal_text N'Warning, this is dangerous and may lead to issues. The main purpose is to change a table to a similar view.',N'p-4 text-danger font-weight-bold'\nSELECT @api_card_tablename = tablename, @api_card_basetable = basetable,@name=name FROM api_card WHERE id = @id\nIF @api_card_basetable IS NULL SET @api_card_basetable = @api_card_tablename\nEXEC sp_api_modal_text N'Table or view name'\nEXEC sp_api_modal_input @name='@api_card_tablename', @value= @api_card_tablename OUT,@select=1\nEXEC sp_api_modal_text N'Base table for view above (or leave empty)'\nEXEC sp_api_modal_input @name='@api_card_basetable', @value= @api_card_basetable OUT,@select=1\nEXEC sp_api_modal_text N'Card name'\nEXEC sp_api_modal_input @name='@name', @value= @name OUT,@select=1\nEXEC sp_api_modal_button @name='@button',@value = 'Save', @valueout = @button OUT,@class='btn-danger',@key='Enter'\nIF @button IS NOT NULL\n\tBEGIN\n\t\tIF TRIM(@api_card_basetable) = '' SET @api_card_basetable = NULL\n\t\tUPDATE api_card SET tablename = (SELECT name FROM sys_objects WHERE name = @api_card_tablename),basetable = @api_card_basetable,name=@name WHERE id = @id\n\t\tEXEC sp_api_populate_card @id\n\t\tEXEC sp_api_modal_clear\n\tEND",
            "action_id": 1132,
            "action_name": "sys_change_table",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--\tCONTEXT: CTR\n--\t============\n\n--declare @ctrtoloc int, @ctrfromloc int -- (oorspronkelijke) advieslokaties\n--declare @checkamt int\n--declare @Direct int=1\n--declare @Normaal int=2\n--select @ctrtoloc =tocloc_id, @ctrfromloc=frmloc_id,@checkamt=iif(stockmut=1,amount,0) from xtransactiondetail where id=@ID\n--update xtransactiondetail set Flowmodel_id=@Direct where id=@ID\n--update xlfctr set ltrtoloc=ltrfromloc where ctr_id=@ID and lfctr_amount=@checkamt -- let op: dit gaat alleen goed bij volledige ctr op lfctr!\n\n-- hierboven was de oude, zonder meenemen van iv-gelinkte  verkoop\n\ndeclare @ctrtoloc int, @ctrfromloc int -- (oorspronkelijke) advieslokaties\ndeclare @checkamt int\ndeclare @Direct int=1\ndeclare @Normaal int=2\ndeclare @isEqual bit=0\n\n--210330 op deze plaats toegevoegd: Check op volledige en enkelvoudige IVLINK\ndeclare @linkCount int, @linkAmount int\nselect @linkCount=linkCount, @linkAmount=linked from @main_db.dbo.ctr_linkinfo(@ID) \nDECLARE @ThisAmount int\ndeclare @ThisTDT int\nselect @ThisAmount=Amount, @ThisTDT=tdt from xtransactiondetail where id=@ID\n\nif @linkCount <> 1 OR @linkAmount<>@ThisAmount\n\tbegin\n\t\texecute sp_api_modal_alert N'De IV link is niet volledig en enkelvoudig. Omzetten naar Direct kan nog niet...'\n\t\texecute sp_api_modal_clear\n\t\treturn; -- klaar kappen\n\tend\n\n--we zijn hier, dus hebben we een volledige link\ndeclare @CounterCTR int\nselect @CounterCTR= iif(itd=@id,vtd,itd) from xivlink where itd=@id or vtd=@id\n\n\n\nselect @ctrtoloc =tocloc_id, @ctrfromloc=frmloc_id,@checkamt=iif(stockmut=1,amount,0) from xtransactiondetail where id=@ID\nupdate xtransactiondetail set Flowmodel_id=@Direct where id=@ID\nupdate xlfctr set ltrtoloc=@ctrfromloc,ltrfromloc=@ctrfromloc, @isEqual=iif(lfctr_amount-@checkamt=0,1,0) where ctr_id=@ID and lfctr_amount=@checkamt \n-- let op: dit gaat alleen goed bij volledige ctr op lfctr!\n\n\nif @isEqual=1\n\tbegin\n\t\t--pas ook de lfctr aan van de aan deze inkoopregel gelinkte verkoopregels\n\t\tDECLARE @cursor_ids CURSOR,@cid INT\n\t\tSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR (select ITD as ivCTR from xivlink where vtd=@ID UNION select VTD as ivCTR from xivlink where itd=@ID) \n\t\tOPEN @cursor_ids;\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\n\t\t\t\t--geef de lfctr van de verkoop ctr een nieuwe laadlokatie\n\t\t\t\tupdate xtransactiondetail set Flowmodel_id=@Direct where id=@cid\n\t\t\t\t-- als er voor de gewijzigde lfctr lokaties geen LF is, wordt deze aangemaakt. zie trigger xlfctr\n\t\t\t\tupdate xlfctr set ltrfromloc=@ctrfromloc where ctr_id=@cid -- schrijf de fromloc van de inkooplokatie in de from van de verkoop lfctr\n\t\t\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\t\t\tEND\n\t\tCLOSE @cursor_ids;\n\t\tDEALLOCATE @cursor_ids;\n\t\t\n\n\n\t\t\n\t\t--210330 extra trucje hier: europalletregels toevoegen en koppelen\n\t\tdeclare @Europallet_stockID int , @NewID int , @NewEuroCTR int\n\t\tset @Europallet_stockID=78867 -- of ingewikkeld doen door iets te zoeken...(select top 1 id from xstock where .... )\n\t\t--inkoop pallet:\n\t\texecute @NewID = @main_db.dbo.Clone_CTR_to_StockID @IDS=@ID, @Stock_ID=@Europallet_stockID, @FromLocID=@ctrfromloc, @toLocID=@ctrfromloc\n\t\t\n\t\t--verkoop pallet (de counterCTR)\n\t\texecute @NewEuroCTR = @main_db.dbo.Clone_CTR_to_StockID @IDS=@CounterCTR, @Stock_ID=@Europallet_stockID, @FromLocID=@ctrfromloc\n\t\tif @NewID >0 AND @NewEuroCTR >0\n\t\t\tinsert into xivlink(itd,vtd,stock_id,linkAantal) \n\t\t\t\tvalues (\n\t\t\t\t\tiif(@ThisTDT=1,@NewEuroCTR,@NewID)\n\t\t\t\t\t,iif(@ThisTDT=1,@NewID,@NewEuroCTR)\n\t\t\t\t\t,@Europallet_stockID\n\t\t\t\t\t,1 -- 1 pallet!\n\t\t\t\t\t)\n\n\n\tend\n\n\n",
            "action_id": 1136,
            "action_name": "rick test direct",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "update xlandfreight SET transport_ID={[transport].id} WHERE xlandfreight.Transport_ID is null AND (xlandfreight.Transportcompany_ID={[transport].transporter_ID} OR xlandfreight.Transportcompany_ID is null)",
            "action_id": 1137,
            "action_name": "Auto Add Landfreight",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @search nvarchar(128) ,@button nvarchar(128), @doctype nvarchar(128), @TransportID nvarchar(128) \nDECLARE @filename nvarchar(1024) = dbo.strdate(NULL)+'_'+@id+'_'+'CSI.csv'\n--EXEC sp_api_modal_input @name='search',@value = @search OUT,@focus=1 -- zoek veld\nSET @doctype = (select xtransportdoc.DocType from xtransportdoc where xtransportdoc.id = @id)\nSET @button = 'CSI'\n--EXEC sp_api_modal_button @name='button',@value = 'KCB',@valueout = @button OUT,@class = 'btn-primary',@key = '1'\nEXEC sp_api_modal_button @name='button',@value = 'NaarCSV',@valueout = @button OUT,@class = 'btn-success',@key = '1'\n\n\nIF @button =  'CSI'\nBEGIN\n\tSELECT *\n\tINTO #CSI\n\tFROM RV_CSIFRESHCSV\n\twhere Transport_ID = @id\n\tEXEC sp_api_modal_table @tmptable=N'#CSI'--,@orderby=N'ORDER BY [CAP*],Description ASC'\nEND\n\nIF @button =  'NaarCSV'\nBEGIN\n\t\tSELECT *--[x/nummer],[x/aantal],[x/product_naam],[x/artikelomschrijving_cft],[e/origine]\n\t\tINTO #CSICSV\n\t\tFROM          RV_CSIFRESHCSV\n\t\twhere Transport_ID = @id\n\t\tALTER TABLE #CSICSV drop column Transport_ID\n\t\tEXEC sp_api_modal_csv @tmptable=N'#CSICSV', @filename=@filename,@ansi=1 --,@eol=@eol--,@orderby=N'ORDER BY [x/nummer]'\n\t\tEXEC sp_api_modal_text 'Huidige regels zijn gedownload','text-primary font-weight-bold h2 text-center mt-5'\n\t\t\tSELECT *\n\t\t\tINTO #CSICSVD\n\t\t\tFROM          RV_CSIFRESHCSV\n\t\t\twhere Transport_ID = @id\n\t\t\tEXEC sp_api_modal_table @tmptable=N'#CSICSVD'--,@orderby=N'ORDER BY [CAP*],Description ASC'\nEND\n\n",
            "action_id": 1138,
            "action_name": "CSI-CSV",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "update xtransport set TransportStatus ='Departed' where id IN(select * FROM string_split(@IDS,','))\nupdate xlandfreight set [Status] ='Departed' where Transport_ID IN(select * FROM string_split(@IDS,','))\nEXEC sp_api_toast N'Transport en Pallets zijn gesloten'",
            "action_id": 1139,
            "action_name": "Departed",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @company_id nvarchar(32),@button nvarchar(128),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000), @location_id nvarchar(32), @reducer nvarchar(max), @date nvarchar(128), @docset nvarchar(32)\n,@button1 nvarchar(128) = N'Nieuwe Documenten set'\n,@button2 nvarchar(128) = N'Bestaande Documenten set'\nset @date = dbo.workDate()\n\nEXEC sp_api_modal_input @name = 'Kantoor van uitgang',@value = @docset OUT, @focus = 1\nEXEC sp_api_modal_text 'Kies een optie:','text-primary font-weight-bold display-4 text-center'\nEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Insert'\n\tIF EXISTS (SELECT * FROM xtransportdocset WHERE Transport_ID = @id)\n\tBEGIN\n\tEXEC sp_api_modal_button @name='button',@value=@button2,@valueout = @button OUT,@key='F1',@class='bg-danger text-light'\n\tEND\n\n\tIF @button = @button1\n\t\tBEGIN\n\t\tDELETE FROM api_storage WHERE card_id = (SELECT id FROM api_card WHERE name = N'uitgaand_transport') AND child_id = 0 AND user_id = @user_id\n\t\tEXEC sp_api_modal_clear\n\t\t\tEXEC sp_api_modal_post N'tdocset',N'Info',@docset,0\n\t\t\tEXEC sp_api_modal_post N'tdocset',N'Transport_ID',@id,0\n\t\t\tEXEC @new_id = sp_api_modal_save N'tdocset',0\n\t\t\tIF @new_id > 0\n\t\t\t\tBEGIN\n\t\t\t\t\tEXEC sp_api_modal_post N'xtransportdoc',N'TDocSet_ID',@new_id,0\n\t\t\t\t\tEXEC sp_api_modal_post N'xtransportdoc',N'DocType','KCB',0\n\t\t\t\t\tEXEC sp_api_modal_save N'xtransportdoc',0\n\t\t\t\t\tSET @goto = N'/uitgaand_transport/'+@id+'/tdocset/'+@new_id+'/tdslf/0/22257'\n\t\t\t\t\tEXEC sp_api_toast N'Nieuwe Docset',N'alert-primary'\n\t\t\t\t\tSET @search = N'?id='+@id\n\t\t\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/uitgaand_transport',@referer_search=@search\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tEXEC sp_api_toast N'Error nieuwe Docset',N'alert-danger'\n\t\t\tEXEC sp_api_modal_clear\n\t\tEND\n\tIF @button = @button2\n\t\tBEGIN\n\t\t\tSET @new_id = (SELECT TOP 1 id FROM xtransportdocset WHERE Transport_ID = @id ORDER BY id DESC)\n\t\t\tSET @goto = N'/uitgaand_transport/'+@id+'/tdocset/'+@new_id+'/tdslf/0/22257'\n\t\t\tSET @search = N'?id='+@id\n\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/uitgaand_transport',@referer_search=@search\n\t\tEND",
            "action_id": 1140,
            "action_name": "Insert Docset",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @company_id nvarchar(32),@button nvarchar(128),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000), @location_id nvarchar(32), @reducer nvarchar(max), @date nvarchar(128), @Transportinfo nvarchar(32)\r\n,@button1 nvarchar(128) = N'Nieuwe uitgaande transport'\r\n,@button2 nvarchar(128) = N'Laatste open-uitgaande transport'\r\nset @date = dbo.workDate()\r\nEXEC sp_api_modal_select @card_name = N'transporteur',@value = @company_id OUT,@focus = 1\r\nSET @reducer = CONCAT('company_id = ',@company_id)\r\n\r\nIF @company_id > 0\r\nBEGIN\r\n\t--DECLARE @only_new_is_possible BIT = 0\r\n\t--EXEC sp_api_modal_select @card_name = N'xlocation',@reducer = @reducer,@value = @location_id OUT,@class='mt-3',@focus = 1\r\n\t--IF @location_id > 0\r\n\tEXEC sp_api_modal_input @name = 'Transportinfo',@value = @Transportinfo OUT, @class = 'mt-3',@focus = 1\r\n\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3'\r\n\tEXEC sp_api_modal_text 'Kies een optie:','text-primary font-weight-bold display-4 text-center'\r\n\tEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Insert'\r\n\t\tIF EXISTS (SELECT * FROM xTransport WHERE TransportStatus=N'Departing' AND Transporter_ID = @company_id)\r\n\t\t\tEXEC sp_api_modal_button @name='button',@value=@button2,@valueout = @button OUT,@key='F1'\r\n/*\t\t\r\nELSE\r\n\t\tIF (select COUNT(id) from xlocation where company_id = @company_id ) = 1 \r\n\t\t\tBEGIN\r\n\t\t\t\tSET @only_new_is_possible = 1\r\n\t\t\tEND\r\n*/\r\n\tIF @button = @button1 --OR @only_new_is_possible = 1\r\n\t\tBEGIN\r\n\t\tDELETE FROM api_storage WHERE card_id = (SELECT id FROM api_card WHERE name = N'uitgaand_transport') AND child_id = 0 AND user_id = @user_id\r\n\t\tEXEC sp_api_modal_clear\r\n\t\t\tEXEC sp_api_modal_post N'uitgaand_transport',N'Transporter_ID',@company_id,0\r\n\t\t\tEXEC sp_api_modal_post N'uitgaand_transport',N'TransportDate',@date,0\r\n\t\t\tEXEC sp_api_modal_post N'uitgaand_transport',N'Transportinfo',@Transportinfo,0\r\n\t\t\tEXEC @new_id = sp_api_modal_save N'uitgaand_transport',0\r\n\t\t\tIF @new_id > 0\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @goto = N'/uitgaand_transport/'+@new_id+'/landfreightselection/0/14168'\r\n\t\t\t\t\tEXEC sp_api_toast N'Nieuwe uitgaande transport',N'alert-primary'\r\n\t\t\t\t\tSET @search = N'?id='+@new_id\r\n\t\t\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/uitgaand_transport',@referer_search=@search\r\n\t\t\t\tEND\r\n\t\t\tELSE\r\n\t\t\t\tEXEC sp_api_toast N'Error nieuwe uitgaande transport',N'alert-danger'\r\n\t\t\tEXEC sp_api_modal_clear\r\n\t\tEND\r\n\tIF @button = @button2\r\n\t\tBEGIN\r\n\t\t\tSET @new_id = (SELECT TOP 1 id FROM xTransport WHERE TransportStatus=N'Departing' AND Transporter_ID = @company_id ORDER BY id DESC)\r\n\t\t\tSET @goto = N'/uitgaand_transport/'+@new_id+'/landfreightselection/0/14168'\r\n\t\t\tSET @search = N'?id='+@new_id\r\n\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/uitgaand_transport',@referer_search=@search\r\n\t\tEND\r\nEND",
            "action_id": 1141,
            "action_name": "Insert Transport",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@date2 nvarchar(128),@button nvarchar(128),@TransComp nvarchar(128)\nset @date = dbo.workDate()\nset @date2 = dbo.workDate()\nEXEC sp_api_modal_text 'Zoek op transport bedrijf'\nEXEC sp_api_modal_select @card_name = N'transporteur',@value = @TransComp OUT,@focus = 1\nIF @TransComp > 0\n\tBEGIN\n\t\tEXEC sp_api_toast @TransComp\n\t\tEXEC sp_api_modal_clear\n\t\tEXEC sp_api_modal_text 'Van:'\n\t\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n\t\tEXEC sp_api_modal_text 'Tot en met:'\n\t\tEXEC sp_api_modal_date @name='Date2',@value = @date2 OUT -- zoek veld\n\t\t--SET @date2 = CONCAT(@date2,' 23:59:59.999')\n\t\tSET @button = 'DepartingPalletsLijst'\n\t\tEXEC sp_api_modal_button @name='button',@value = 'DepartingPalletsLijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\n\t\tEXEC sp_api_modal_button @name='button',@value = 'ArrivedPalletsLijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F2'\n\t\tEXEC sp_api_modal_print\n\n\t\tIF @button =  'DepartingPalletsLijst'\n\t\tBEGIN\n\t\tSELECT [TransportDate]\n\t\t      ,[LocCode]\n\t\t      ,[TransComp*]\n\t\t      ,[ToCompany]\n\t\t      ,[PalletsCalc@] = [PalletsCalc]\n\t\t      ,[Euro]\n\t\t      ,[Kentekencap*]\n\t\t      ,[Kenteken*]\n\t\t      ,[TransportStatus]\n\t\t      ,[Trans_ID]\n\t\t      ,[Transporteur_ID]\n\t\t      ,[TDT]\n\t\tINTO #DepartingPalletsLijst\n\t\tFROM          RV_TransportPalletLijst\n\t\tWHERE\t\t(TDT=2) AND (TransportDate BETWEEN @date AND @date2) AND [Transporteur_ID] = @TransComp\n\t\tALTER TABLE #DepartingPalletsLijst\n\t\tDROP COLUMN Transporteur_ID,Trans_ID,TDT\n\t\tEXEC sp_api_modal_table @tmptable=N'#DepartingPalletsLijst',@orderby=N'ORDER BY [TransComp*] ASC',@print=1\n\t\tEND \n\n\t\tIF @button =  'ArrivedPalletsLijst'\n\t\tBEGIN\n\t\tSELECT [TransportDate]\n\t\t      ,[LocCode]\n\t\t      ,[TransComp*]\n\t\t      ,[ToCompany]\n\t\t      ,[PalletsCalc@] = [PalletsCalc]\n\t\t      ,[Euro]\n\t\t      ,[Kentekencap*]\n\t\t      ,[Kenteken*]\n\t\t      ,[TransportStatus]\n\t\t      ,[Trans_ID]\n\t\t      ,[Transporteur_ID]\n\t\t      ,[TDT]\n\t\tINTO #ArrivedPalletsLijst\n\t\tFROM          RV_TransportPalletLijst\n\t\tWHERE\t\t(TDT=1) AND (TransportDate BETWEEN @date AND @date2) AND [Transporteur_ID] = @TransComp\n\t\tALTER TABLE #ArrivedPalletsLijst\n\t\tDROP COLUMN Transporteur_ID,Trans_ID,TDT\n\t\tEXEC sp_api_modal_table @tmptable=N'#ArrivedPalletsLijst',@orderby=N'ORDER BY [TransComp*] ASC',@print=1\n\t\tEND \n\tEND\n",
            "action_id": 1142,
            "action_name": "Pallet Lijst",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @company_id nvarchar(32),@button nvarchar(128),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000), @location_id nvarchar(32), @reducer nvarchar(max), @date nvarchar(128), @Transportinfo nvarchar(32)\n,@button1 nvarchar(128) = N'Nieuwe uitgaand transport'\nset @date = dbo.workDate()\nEXEC sp_api_modal_select @card_name = N'transporteur',@value = @company_id OUT,@focus = 1\nSET @reducer = CONCAT('company_id = ',@company_id)\n\nIF @company_id > 0\nBEGIN\n\t--DECLARE @only_new_is_possible BIT = 0\n\t--EXEC sp_api_modal_select @card_name = N'xlocation',@reducer = @reducer,@value = @location_id OUT,@class='mt-3',@focus = 1\n\t--IF @location_id > 0\n\tEXEC sp_api_modal_input @name = 'Transportinfo',@value = @Transportinfo OUT, @class = 'mt-3',@focus = 1\n\tEXEC sp_api_modal_text 'Kies een optie:','text-primary font-weight-bold display-4 text-center'\n\tEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Insert'\n/*\t\t\nELSE\n\t\tIF (select COUNT(id) from xlocation where company_id = @company_id ) = 1 \n\t\t\tBEGIN\n\t\t\t\tSET @only_new_is_possible = 1\n\t\t\tEND\n*/\n\tIF @button = @button1 --OR @only_new_is_possible = 1\n\t\tBEGIN\n\t\tDELETE FROM api_storage WHERE card_id = (SELECT id FROM api_card WHERE name = N'uitgaand_transport') AND child_id = 0 AND user_id = @user_id\n\t\tEXEC sp_api_modal_clear\n\t\t\tEXEC sp_api_modal_post N'uitgaand_transport',N'Transporter_ID',@company_id,0\n\t\t\tEXEC sp_api_modal_post N'uitgaand_transport',N'TransportDate',@date,0\n\t\t\tEXEC sp_api_modal_post N'uitgaand_transport',N'Transportinfo',@Transportinfo,0\n\t\t\tEXEC @new_id = sp_api_modal_save N'uitgaand_transport',0\n\t\t\tEXEC sp_api_modal_clear\n\t\tEND\nEND",
            "action_id": 1143,
            "action_name": "Quick Insert Transport",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @company_id nvarchar(32),@Transport_ID nvarchar(32),@button nvarchar(128),@button2 nvarchar(128),@new_id nvarchar(32)\n,@goto nvarchar(2000),@search nvarchar(2000), @location_id nvarchar(32), @reducer nvarchar(max), @date nvarchar(128)\n,@Pickupdate nvarchar(128),@Deliverydate nvarchar(128), @Transportinfo nvarchar(32)\n,@button1 nvarchar(128) = N'Set Date'\n--\tEXEC sp_api_modal_modal @class=N'w-100'\n\n\tSELECT TOP 1 @Pickupdate = Pickup, @Deliverydate = Delivery FROM xLandfreight WHERE Transport_ID = @id\n\n\tEXEC sp_api_modal_text 'Kies een Pickup date:','text-primary font-weight-bold h4' --display-4 text-center\n\tEXEC sp_api_modal_date @name='Pickup Date',@value = @Pickupdate OUT,@class='w-25 mt-3'\n\tEXEC sp_api_modal_text 'Kies een Delivery date:','text-primary font-weight-bold h4' --display-4 text-center\n\tEXEC sp_api_modal_date @name='Delivery Date',@value = @Deliverydate OUT,@class='w-25 mt-3'\n\tEXEC sp_api_modal_text 'Kies een optie:','text-primary font-weight-bold h4' --display-4 text-center\n\tEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Insert'\n\nIF @Pickupdate < = @Deliverydate AND @button = @button1\n\tBEGIN\n\t\tDECLARE @lfid int\n\t\t\tDECLARE @cursor_xLandfreight CURSOR\n\t\t\tSET @cursor_xLandfreight = CURSOR LOCAL FAST_FORWARD FOR SELECT id FROM xLandfreight WHERE Transport_ID = @id\n\t\t\tOPEN @cursor_xLandfreight;\n\t\t\tFETCH NEXT FROM @cursor_xLandfreight INTO @lfid\n\t\t\tWHILE @@FETCH_STATUS = 0\n\t\t\t\tBEGIN\n\t\t\t\t\tEXEC sp_api_modal_post 'uitgaande_pallets','Pickup',@Pickupdate,@lfid\n\t\t\t\t\tEXEC sp_api_modal_post 'uitgaande_pallets','Delivery',@Deliverydate,@lfid\n\t\t\t\t\tEXEC sp_api_modal_save 'uitgaande_pallets',@lfid\n\t\t\t\t\tFETCH NEXT FROM @cursor_xLandfreight INTO @lfid\n\t\t\t\tEND\n\t\t\tCLOSE @cursor_xLandfreight;\n\t\t\tDEALLOCATE @cursor_xLandfreight;\n\tEND\n\nSELECT Bedrijf = (SELECT [xCompany].[Code] FROM [xCompany] WHERE [id] = [xlandfreight].[Counterparty_ID])\n\t,Naam = (SELECT [xCompany].[CompanyName] FROM [xCompany] WHERE [id] = [xlandfreight].[Counterparty_ID])\n\t, Pickup, Delivery INTO #tmptable FROM xLandfreight WHERE Transport_ID = @id\nEXEC sp_api_modal_table  @tmptable = '#tmptable'\n/*\nSET @reducer = N'Transport_ID = ' + @id\nEXEC sp_api_modal_table @card_name = N'uitgaande_pallets',@reducer= @reducer\n*/\nRETURN\nset @date = dbo.workDate()\n\nEXEC sp_api_modal_select @card_name = N'uitgaand_transport',@value = @Transport_ID OUT,@focus = 1\nSET @reducer = CONCAT('company_id = ',@company_id)\n\nIF @Transport_ID > 0\nBEGIN\n\tEXEC sp_api_modal_text 'Kies een Pickup date:','text-primary font-weight-bold display-4 text-center'\n\tEXEC sp_api_modal_date @name='Pickup Date',@value = @Pickupdate OUT,@class='w-25 mt-3'\n\tEXEC sp_api_modal_text 'Kies een Delivery date:','text-primary font-weight-bold display-4 text-center'\n\tEXEC sp_api_modal_date @name='Delivery Date',@value = @Deliverydate OUT,@class='w-25 mt-3'\n\tEXEC sp_api_modal_text 'Kies een optie:','text-primary font-weight-bold display-4 text-center'\n\tEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Insert'\n\t\tIF EXISTS (SELECT Transporter_ID FROM xTransport WHERE TransportDate = @date AND Transporter_ID = @Transport_ID)\n\t\t\tEXEC sp_api_modal_button @name='button',@value=@button2,@valueout = @button OUT,@key='F1'\n/*\t\t\nELSE\n\t\tIF (select COUNT(id) from xlocation where company_id = @company_id ) = 1 \n\t\t\tBEGIN\n\t\t\t\tSET @only_new_is_possible = 1\n\t\t\tEND\n*/\n\tIF @button = @button1 --OR @only_new_is_possible = 1\n\t\tBEGIN\n\t\tDELETE FROM api_storage WHERE card_id = (SELECT id FROM api_card WHERE name = N'uitgaand_transport') AND child_id = 0 AND user_id = @user_id\n\t\tEXEC sp_api_modal_clear\n\t\t\tEXEC sp_api_modal_post N'uitgaand_transport',N'Transporter_ID',@company_id,0\n\t\t\tEXEC sp_api_modal_post N'uitgaand_transport',N'TransportDate',@date,0\n\t\t\tEXEC sp_api_modal_post N'uitgaand_transport',N'Transportinfo',@Transportinfo,0\n\t\t\tEXEC @new_id = sp_api_modal_save N'uitgaand_transport',0\n\t\t\tIF @new_id > 0\n\t\t\t\tBEGIN\n\t\t\t\t\tSET @goto = N'/uitgaand_transport/'+@new_id+'/landfreightselection/0/14168'\n\t\t\t\t\tEXEC sp_api_toast N'Nieuwe uitgaande transport',N'alert-primary'\n\t\t\t\t\tSET @search = N'?id='+@new_id\n\t\t\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/uitgaand_transport',@referer_search=@search\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tEXEC sp_api_toast N'Error nieuwe uitgaande transport',N'alert-danger'\n\t\t\tEXEC sp_api_modal_clear\n\t\tEND\nEND\n\n",
            "action_id": 1144,
            "action_name": "Set Pickup & Delivery date",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@button1 nvarchar(128) = N'Voeg transporten toe',@STRING VARCHAR(MAX),@SEPARATOR CHAR(1)\nSET @date = dbo.workdate()\nEXEC sp_api_modal_date @name='Datum voor Transporten:',@value = @date OUT,@class='w-25 mt-3',@focus=1,@select=1\nEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Insert'\n\n\n/* \n-- Slimme manier moet wellicht betere oplossing voor dit komen - COCO\nSET @SEPARATOR=',' \nSET @STRING=(N'VGI 1 - Andre Barendse,VGI 2 - Leo Beekenkamp,VGI 3 - Renee Vink,VGI 4 - Wim Vermeulen,VGI 6 - Jacob Mauritz,VGI 7 - Eliza Vollebregt,\nVGI 8 - Marcel Brussaard,VGI 9 - Paul Jansen,95-BKJ-6,LOLA GREEN OU,HANNON,TRUNIC - Jan,TRUNIC - Nick,TRUNIC - Kelvin,TRUNIC - Mitch,GROUPAGE,Augma,\nFreight-Line,DLG,Hartman Expeditie,DUIJN,J.P. VIS,TOMPREX,H.Z.')\n\nIF @button = @button1\n\tBEGIN\nINSERT INTO xTransport (Transportinfo, Transporter_ID, TransportDate, TransportStatus,TDT,FullTruckTariff)\nSELECT \t\t\tTransportinfo = value,\n\t\t        Transporter_ID = 147036,\n\t\t       \tTransportDate = @date,\n\t\t        TransportStatus = 'Departing',\n\t\t\t\tTDT = 2,\n\t\t\t\tFullTruckTariff = 0\nFROM \nSTRING_SPLIT(@STRING,@SEPARATOR)\n */\n\nDELETE FROM xTransport WHERE id NOT IN (SELECT isnull(Transport_ID,0) FROM xlandfreight) AND TransportDate != dbo.ABCDATE()\n\n-- simpelere manier:\nIF @button = @button1\n\tBEGIN\n\t\tINSERT INTO xTransport(\n\t\t    Transportinfo,\n\t\t    Transporter_ID,\n\t\t    TransportDate,\n\t\t    TransportStatus,\n\t\t\tTDT,\n\t\t\tFullTruckTariff\n\t\t)\n\t\tVALUES\n\t\t-- Van Geest international wagens\n\t\t    (\n\t\t        'Binnenland',\n\t\t        147036,\n\t\t        @date,\n\t\t        'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t    (\n\t\t        'VGI 1 - Andre Barendse',\n\t\t        147036,\n\t\t        @date,\n\t\t        'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t    (\n\t\t        'VGI 2 - Leo Beekenkamp (Dtsl)', -- BOOM vgi\n\t\t        161146,\n\t\t        @date,\n\t\t        'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t    (\n\t\t        'VGI 2 / 92-BPX-3 / Leo Beekenkamp (UK)', -- UK\n\t\t        161138,\n\t\t        @date,\n\t\t        'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t    (\n\t\t        'VGI 3 - Renee Vink (Dtsl)', -- BOOM vgi\n\t\t        161146,\n\t\t        @date,\n\t\t        'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t    (\n\t\t        'VGI 3 / 26-BLB-4 / Renee Vink (UK)', -- UK\n\t\t        161138,\n\t\t        @date,\n\t\t        'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'VGI 4 - Aniel van Dam',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'VGI 5 - Jacob Mauritz',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'VGI 6 - Eliza Vollebregt',\n\t\t\t\t161146,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'VGI 7 - Marcel Brussaard',\n\t\t\t\t147036,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'VGI 8 - Paul Jansen (Dtsl)', -- BOOM vgi\n\t\t\t\t161146,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'VGI 8 / 25-BLB-4 / Paul Jansen (UK)', -- UK vgi\n\t\t\t\t161138,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'95-BKJ-6 / ATMA', -- bakken\n\t\t\t\t161142,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t-- Overige wagens\n\t\t\t(\n\t\t\t\t'LOLA GREEN OU',\n\t\t\t\t159829,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'HANNON',\n\t\t\t\t157294,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'TRUNIC - Jan',\n\t\t\t\t157468,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'TRUNIC - Nick',\n\t\t\t\t157468,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'TRUNIC / 32-BRD-4 / Kelvin',\n\t\t\t\t157468,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'TRUNIC - Mitch',\n\t\t\t\t157468,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'GROUPAGE BOSDAALEN',\n\t\t\t\t157179,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'Augma',\n\t\t\t\t157586,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'Freight-Line',\n\t\t\t\t157248,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'DLG - A/C Levering',\n\t\t\t\t157205,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'DLG - Vroeg vertrek',\n\t\t\t\t157205,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'DLG - Middag vertrek',\n\t\t\t\t157205,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'DLG - Tunnel vertrek',\n\t\t\t\t157205,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'Hartman Expeditie',\n\t\t\t\t157298,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'DUIJN',\n\t\t\t\t157218,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'J.P. VIS',\n\t\t\t\t157481,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'TOMPREX',\n\t\t\t\t159833,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    ),\n\t\t\t(\n\t\t\t\t'H.Z.',\n\t\t\t\t156940,\n\t\t\t\t@date,\n\t\t\t\t'Departing',\n\t\t\t\t2,\n\t\t\t\t0\n\t\t    );\n\t\t    EXEC sp_api_modal_clear\n\t\tEND\n",
            "action_id": 1145,
            "action_name": "StandaardAuto",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "update xtransport set TransportStatus ='Departing' where id IN(select * FROM string_split(@IDS,','))\nupdate xlandfreight set [Status] ='Loading' where Transport_ID IN(select * FROM string_split(@IDS,','))\nEXEC sp_api_toast N'Transport en Pallets zijn terug naar Departing/Loading'",
            "action_id": 1146,
            "action_name": "Terug naar Departing",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "/* \nCVG 210802\nFunctie die beoordeeld of de orders die onder betreffende transport liggen naar status locked gezet kunnen worden.\nHier maakt Anaco GEEN gebruik van. \n*/\n\nDECLARE @button nvarchar(128)\nSET @button = ''\n\nIF (SELECT count(id) from xlandfreight LF where LF.TransactionHeader_ID in (select id from xtransactionheader where Repack_ID is null and id in (select transactionheader_id from Q_xTransactionDetail where (price is null or Price = 0))) and TDT = 2 and LF.Transport_ID = @id) > 0\n\t BEGIN\n\t EXEC sp_api_modal_text 'Prijzen zijn nog niet allemaal ingevuld:', 'text-primary font-weight-bold text-center display-4'\n\t EXEC sp_api_modal_text ' ', 'mt-3'\n\t /*\n\t\tselect \n\t\t[CompanyName] = (Select TV_CompanyName from Q_xtransactionheader where id = LF.TransactionHeader_ID)\n\t\t--,[Product] = (select detail from Q_xTransactionDetail where (price is null or Price = 0) and TransactionHeader_ID = LF.TransactionHeader_ID)\n\t\t,[Verkoper] = (Select insUser from Q_xtransactionheader where id = LF.TransactionHeader_ID)\n\t\t,[Verkoop id] = (select id from Q_xtransactionheader where id = LF.TransactionHeader_ID)\n\t\t,[transactiondate] = (Select format(TransactionDate,'yyyy-MM-dd') from Q_xtransactionheader where id = LF.TransactionHeader_ID)\n\t\tINTO #VerkoopPrijsControle\n\t\tfrom xlandfreight LF\n\t\twhere LF.TransactionHeader_ID in \n\t\t(select id from xtransactionheader where Repack_ID is null and id in (select transactionheader_id from Q_xTransactionDetail where (price is null or Price = 0))) \n\t\tand TDT = 2 and LF.Transport_ID = @id\n\t\tEXEC sp_api_modal_table @tmptable=N'#VerkoopPrijsControle',@orderby=N'ORDER BY CompanyName ASC'\n\t*/\n\t\tselect \n\t\t[CompanyName] = Counterparty\n\t\t,[Product] = detail\n\t\t,[Verkoper] = insUser\n\t\t,[Verkoop id] = TransactionHeader_ID \n\t\t,[transactiondate] = format(TransactionDate,'yyyy-MM-dd')\n\t\tINTO #VerkoopPrijsControle\n\t\tfrom Q_xTransactionDetail\n\t\twhere TransactionHeader_ID in (SELECT TransactionHeader_ID from xlandfreight lf where LF.TransactionHeader_ID in \n\t\t(select id from xtransactionheader where Repack_ID is null) \n\t\tand TDT = 2 and LF.Transport_ID = @id) and (price is null or Price = 0)\n\t\tEXEC sp_api_modal_table @tmptable=N'#VerkoopPrijsControle',@orderby=N'ORDER BY CompanyName ASC'\n\tRETURN\n\t END\nELSE\n\tBEGIN\n\tIF (SELECT count(id) from xlandfreight LF where (blok = 0 and euro = 0) and LF.Transport_ID = @id) > 0\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_text 'Er is een Pallet aantal niet ingevuld', 'text-primary font-weight-bold text-center display-4'\n\t\t\tSELECT id, datum, [Counterparty] = (select companyname from xcompany where id = Counterparty_ID)\n\t\t\tINTO #Landfreightcontrole\n\t\t\tfrom xlandfreight LF\n\t\t\twhere (blok = 0 and euro = 0) and LF.Transport_ID = @id\n\t\t\tEXEC sp_api_modal_table @tmptable=N'#Landfreightcontrole',@orderby=N'ORDER BY Counterparty ASC'\n\t\tRETURN\n\t\tEND\nELSE\n\tBEGIN\n\t\tIF (select count(id) from xtransactionheader where [Status] = 'openSale' AND id in (SELECT transactionheader_id from xLandfreight where Transport_ID = @id)) > 0\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text 'Alle orders van het huidige transport staan op status openSale', 'text-danger font-weight-bold text-center h3'\n\t\t\t\tEXEC sp_api_modal_text 'Klik op onderstaande knop om alle orders naar status Locked te zetten', 'text-danger font-weight-bold text-center h3'\n\t\t\t\tEXEC sp_api_modal_button @name='button',@value = 'Naar Locked',@valueout = @button OUT,@class = 'btn-danger',@key = '1'\n\t\t\t\t\tIF @button = 'Naar Locked'\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tSET @new_state = 'Locked'\n\t\t\t\t\t\tEXEC sp_api_modal_clear\n\t\t\t\t\tEND\n\t\t\t\t/*\n\t\t\t\tEXEC sp_api_modal_text 'Alle orders van transport zijn dichtgezet (Locked)', 'text-primary font-weight-bold text-center display-4'\n\t\t\t\t*/\n\t\t\tEND\n\t\tELSE IF (select count(id) from xtransactionheader where [Status] = 'Locked' AND id in (SELECT transactionheader_id from xLandfreight where Transport_ID = @id)) > 0\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text 'Alle orders van het huidige transport staan op status Locked', 'text-primary font-weight-bold text-center h3'\n\t\t\t\tEXEC sp_api_modal_text 'Klik op onderstaande knop om alle orders terug naar status openSale te zetten', 'text-primary font-weight-bold text-center h3'\n\t\t\t\tEXEC sp_api_modal_button @name='button',@value = 'TerugNaarOpen',@valueout = @button OUT,@class = 'btn-primary',@key = '1'\n\t\t\t\tIF @button = 'TerugNaarOpen'\n\t\t\t\tBEGIN\n\t\t\t\t\tSET @new_state = 'openSale'\n\t\t\t\t\tEXEC sp_api_modal_clear\n\t\t\t\tEND\n\t\t\tEND\n\t\tIF @new_state IS NOT NULL\n\t\t\tBEGIN\n\t\t\t\tDECLARE @cursor CURSOR,@idval INT\n\t\t\t\tSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT id FROM xTransactionheader\n\t\t\t\t\twhere id in (SELECT id FROM Q_xTransactionHeader where id in (SELECT TransactionHeader_ID from xlandfreight LF where Transport_ID = @id))\n\t\t\t\tOPEN @cursor;\n\t\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\t\tWHILE @@FETCH_STATUS = 0\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tUPDATE xTransactionheader SET [Status] = @new_state\tWHERE id = @idval\n\t\t\t\t\t\tIF EXISTS (SELECT * FROM @main_db.dbo.CTH_LF_Incomplete(@idval))\n\t\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\tEXEC @main_db.dbo.Create_ALL_Landfreight\n\t\t\t\t\t\t\tEXEC sp_api_toast N'Nu opnieuw gemaakt voor'\n\t\t\t\t\t\t\tEXEC sp_api_toast @idval\n\t\t\t\t\t\t\tEND\n\t\t\t\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\t\t\tEND\n\t\t\t\tCLOSE @cursor;\n\t\t\t\tDEALLOCATE @cursor;\n\t\t\t\tEXEC sp_api_modal_clear\n\t\t\tEND\n\tEND\nEND",
            "action_id": 1148,
            "action_name": "Verkoop Orders Gesloten",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128),@detail nvarchar(128)\nEXEC sp_api_modal_modal @class = 'w75'\nSET @date = dbo.workDate()\nEXEC sp_api_modal_text 'Orders waar geen prijs is ingevuld: ', 'text-primary font-weight-bold text-center display-4'\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n--EXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\nSET @button = 'VerkoopPrijsControle'\n\nIF @button =  'VerkoopPrijsControle'\nBEGIN\nEXEC sp_api_modal_text ' ', 'mt-3'\nselect \n\t[CompanyName] = (Select TV_CompanyName from Q_xtransactionheader where id = LF.TransactionHeader_ID)\n\t,[Product] = (select detail from Q_xTransactionDetail where (price is null or Price = 0) and TransactionHeader_ID = LF.TransactionHeader_ID)\n\t,[Verkoper] = (Select insUser from Q_xtransactionheader where id = LF.TransactionHeader_ID)\n\t,[Verkoop id] = (select id from Q_xtransactionheader where id = LF.TransactionHeader_ID)\n\t,[transactiondate] = (Select format(TransactionDate,'yyyy-MM-dd') from Q_xtransactionheader where id = LF.TransactionHeader_ID)\n\tINTO #VerkoopPrijsControle\n\tfrom xlandfreight LF\n\twhere LF.TransactionHeader_ID in \n\t(select id from xtransactionheader where Repack_ID is null and id in (select transactionheader_id from Q_xTransactionDetail where (price is null or Price = 0))) \n\tand TDT = 2 and LF.Transport_ID = @id\n\tORDER BY [CompanyName] DESC\n\tEXEC sp_api_modal_table @tmptable=N'#VerkoopPrijsControle',@orderby=N'ORDER BY CompanyName ASC'\nEND \n",
            "action_id": 1149,
            "action_name": "Verkoop Prijs Controle",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "/*\nDECLARE @toCompany_ID INT = {[verkooptransport].Transporter_ID}\nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\nEXEC sp_api_report_generate @id = @id\n\t,@sys_report_key = 'verladingsoverzicht'\n\t,@toCompany_ID = @toCompany_ID\n\t,@fromCompany_ID = @fromCompany_ID\n*/\nEXEC sp_api_toast N'verladingsoverzicht' \n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\t--dit is nu alleen voor tellers en checks:\n\n\t\t--even niet registreren dat er wordt afgedrukt\n\t\t--EXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'CTH'\t,@Context_Key_ID=@cid,@Report_CODE=N'PICK'\n\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select Transporter_ID from xTransport where id=@cid)\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = 'verladingsoverzicht' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\n\n\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 1150,
            "action_name": "Verlaadlijst",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 1151,
            "action_name": "Verwijder Transport",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @xml varbinary(max) = CONVERT(varbinary(max),(SELECT\n\t (SELECT\n\n\t\t----------------\n\t\t -- General --\n\t\t----------------\n\n\t\t(SELECT * FROM (SELECT\n\t\t\tCustomerID = '100058'\n\t\t\t,MessageID = id\n\t\t\t,OrderReference = concat([Orders].id ,'-', [Order].id)\n\t\t\t,StatusOrder = 'New'\n\t\t\t,Documents = (SELECT \n\t\t\t\tDocumentType = doctype \n\t\t\t\t,DocumentName = ''\n\t\t\t\t,DocumentFileLocation = ''\n\t\t\t\t,DocumentNumber = id\n\t\t\t\tFROM xTransportDoc [Document] WHERE TDocSet_ID IN (SELECT id FROM xTransportDocSet\n\t\t\t\t\tWHERE id IN (SELECT xTransportDocSet_ID FROm xTransportDocSetxLandfreight WHERE xLandfreight_ID = [Order].id))\n\t\t\t\tFOR XML AUTO, TYPE,ELEMENTS)\n\t\t\t,Remarks = ''\n\t\t\t,CustomsAgent = ''\n\t\t\t,CustomsAgentImport = ''\n\t\t\t,MRNNumber = ''\n\t\t\t,IncoTerms = 'DDP'\n\t\t\t,IncoTermsCity= (SELECT Name FROM xCity WHERE id = (SELECT City_ID FROM xLocation WHERE id = [Order].To_Location_ID))\n\t\t) General\n\t\tFOR XML AUTO, TYPE,ELEMENTS)\n\n\t\t----------------\n\t\t-- Pickupdata --\n\t\t----------------\n\n\t\t,(SELECT * FROM (SELECT\n\t\t\tPickupName = (SELECT companyname FROM xcompany WHERE id = (SELECT Company_ID FROM xLocation WHERE id = [Order].From_Location_ID))\n\t\t\t,PickupAddress = 'PickupAddress12345'--(SELECT completeAddress FROM xLocation WHERE id IN (SELECT From_Location_ID FROM xLandfreight where id = [Order].id))\n\t\t\t,PickupPostcode = '1234 AB'\n\t\t\t,PickupCity = (SELECT [Name] FROM xCity WHERE id = (SELECT City_ID FROM xLocation WHERE id = [Order].From_Location_ID))\n\t\t\t,PickupCountry = (SELECT IsoCode FROM xCountry WHERE CountryId = (SELECT Country_ID FROM xLocation WHERE id = [Order].From_Location_ID))\n\t\t\t,PickupUNLoCode = ''\n\t\t\t,PickupEORI = ''\n\t\t\t,PickupReference  = ''\n\t\t\t,PickupDate = format([Order].Pickup, 'yyyy-MM-dd')\n\t\t) PickupData\n\t\tFOR XML AUTO, TYPE,ELEMENTS)\n\n\t\t----------------\n\t   -- Deliverydata --\n\t\t----------------\n\n\t\t,(SELECT * FROM (SELECT\n\t\t\tDeliveryName = (SELECT companyname FROM xcompany WHERE id = (SELECT Counterparty_ID FROM xLocation WHERE id = [Order].To_Location_ID))\n\t\t\t,DeliveryAddress = 'DeliveryAddress12345'--(SELECT completeAddress FROM xLocation WHERE id IN (SELECT To_Location_ID FROM xLandfreight where id = [Order].id))\n\t\t\t,DeliveryPostcode = '1234 AB'\n\t\t\t,DeliveryCity = (SELECT [Name] FROM xCity WHERE id = (SELECT City_ID FROM xLocation WHERE id = [Order].To_Location_ID))\n\t\t\t,DeliveryCountry = (SELECT IsoCode FROM xCountry WHERE CountryId = (SELECT Country_ID FROM xLocation WHERE [id] = [Order].To_Location_ID))\n\t\t\t,DeliveryUNLoCode = ''\n\t\t\t,DeliveryEORI = ''\n\t\t\t,DeliveryReference = ''\n\t\t\t,DeliveryDate = format([Order].Delivery, 'yyyy-MM-dd')\n\t\t) DeliveryData\n\t\tFOR XML AUTO, TYPE,ELEMENTS)\n\n\t\t----------------\n\t    -- Orderlines --\n\t\t----------------\n\n\t\t,Orderlines = (SELECT \n\t\t\tMessageIDOrderLine = CONCAT('NR_' , [Orderline].id, '_' , ROW_NUMBER() over (ORDER BY (select 1)))\n\t\t\t,Quantity = case when [Orderline].Blok > 0 and [Orderline].Euro = 0 then [order].Blok \n\t\t\t\t\t\t\t when [Orderline].Blok = 0 and [Orderline].Euro > 0 then [order].Euro\n\t\t\t\t\t\t\t when [Orderline].Blok > 0 and [Orderline].Euro > 0 then [order].Euro + [order].Blok\n\t\t\t\t\t\t\t when [Orderline].Blok = 0 and [Orderline].Euro = 0 then 0\n\t\t\t\t\t\tEND\n\t\t\t,PackageID = case when [Orderline].Blok > 0 and [Orderline].Euro = 0 then 'Blok'\n\t\t\t\t\t\t\t  when [Orderline].Blok = 0 and [Orderline].Euro > 0 then 'Euro'\n\t\t\t\t\t\t\t  when [Orderline].Blok > 0 and [Orderline].Euro > 0 then 'Blok / Euro'\n\t\t\t\t\t\t\t  when [Orderline].Blok = 0 and [Orderline].Euro = 0 then 'Not specified'\n\t\t\t\t\t\t END\n\t\t\t,PalletType = ''\n\t\t\t,StatusOrderLine = 'New'\n\n\t\t----------------\n\t    -- Goodslines --\n\t\t----------------\n\n\t\t\t,Goodslines = (SELECT \n\t\t\t\tMessageIDGoodsline = CONCAT('NR_' , [Goodsline].id, '_' , ROW_NUMBER() over (ORDER BY (select 1)))\n\t\t\t\t,GoodsDesc = [Goodsline].docDescription\n\t\t\t\t,NumberOfBoxes = [Goodsline].LFCTR_Amount\n\t\t\t\t,UNCodeBox = 'BX'\n\t\t\t\t,Temp = ''\n\t\t\t\t,GrossWeight = CONVERT(DECIMAL(10,2),(SELECT ltrKGB FROM totals_lfctr WHERE xLFCTR_id = (SELECT id FROM xLFCTR WHERE id = [Goodsline].id)))\n\t\t\t\t,NettWeight = CONVERT(DECIMAL(10,2),(SELECT ltrKGN FROM totals_lfctr WHERE xLFCTR_id = (SELECT id FROM xLFCTR where id = [Goodsline].id)))\n\t\t\t\t,GoodsCode = (SELECT [ProductGN] = convert(nvarchar(8),ProdGN) FROM xProduct WHERE id = \n\t\t\t\t(SELECT xProduct_ID FROM xStock WHERE id =\n\t\t\t\t(SELECT Stock_ID FROM xTransactionDetail where id =\n\t\t\t\t(SELECT CTR_ID FROM xLFCTR WHERE id = (SELECT id FROM xLFCTR WHERE id = [Goodsline].id)\n\t\t\t\t))))\n\t\t\t\t,CountryOfOrigin = (SELECT IsoCode from xCountry WHERE CountryId = \n\t\t\t\t(select Origin_ID FROM xStock WHERE id =\n\t\t\t\t(SELECT Stock_ID FROM xTransactionDetail WHERE id =\n\t\t\t\t(SELECT CTR_ID FROM xLFCTR WHERE id = (SELECT id FROM xLFCTR WHERE id = [Goodsline].id)\n\t\t\t\t))))\n\t\t\t\t,Value = CONVERT(DECIMAL(10,2),(SELECT ctrAmount * ctrPrice AS Totalvalue from xCTRTotals where ctr_ID =\n\t\t\t\t(SELECT CTR_ID FROM xLFCTR WHERE id = (SELECT id FROM xLFCTR WHERE id = [Goodsline].id))))\n\t\t\t\t,ValueCurrency = (SELECT codeISO FROM xCurrency WHERE id = \n\t\t\t\t(SELECT Currency_ID FROM xTransactionHeader WHERE id =\n\t\t\t\t(SELECT TransactionHeader_ID from xTransactionDetail where id =\n\t\t\t\t(SELECT CTR_ID FROM xLFCTR WHERE id = (SELECT id FROM xLFCTR WHERE id = [Goodsline].id)\n\t\t\t\t))))\n\t\t\t\t,ItemDocuments = (SELECT\n\t\t\t\t\tItemDocumentType = ''\n\t\t\t\t\t,ItemDocumentName = ''\n\t\t\t\t\t,ItemDocumentFileLocation = ''\n\t\t\t\t\t,DocumentNumber = ''\n\t\t\t\tFROM xTransportDoc [ItemDocument] WHERE TDocSet_ID IN (SELECT id FROM xTransportDocSet WHERE id IN (\n\t\t\t\t\t\tSELECT xTransportDocSet_ID FROm xTransportDocSetxLandfreight WHERE xLandfreight_ID = [Orderline].id)\n\t\t\t\t\t)\n\t\t\t\tFOR XML AUTO, TYPE,ELEMENTS)\n\t\t\tFROM xLFCTR [Goodsline] WHERE [Orderline].id = [Goodsline].LF_ID FOR XML AUTO, TYPE,ELEMENTS)\n\t\tFROM xLandfreight [Orderline] WHERE [Order].id = [Orderline].id FOR XML AUTO, TYPE,ELEMENTS)\n\t FROM xLandfreight [Order] WHERE [Order].Transport_ID = [Orders].id FOR XML AUTO, TYPE,ELEMENTS)\nFROM xTransport [Orders] WHERE id = @id\nFOR XML AUTO,TYPE,ELEMENTS))\n\n\nDECLARE @filename nvarchar(1024) = dbo.strdate(NULL)+'_'+@id+'_'+'transport.xml'\nEXEC sp_api_modal_download @filename = @filename ,@mimetype = N'application/xml',@rawdata = @xml",
            "action_id": 1153,
            "action_name": "XML export Daily",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @xml varbinary(max) = CONVERT(varbinary(max),(SELECT\n\t (SELECT\n\n\t\t----------------\n\t\t -- General --\n\t\t----------------\n\n\t\t(SELECT * FROM (SELECT\n\t\t\tCustomerID = '00454'\n\t\t\t,MessageID = id\n\t\t\t,OrderReference = concat([Orders].id ,'-', [Order].id)\n\t\t\t,StatusOrder = 'New'\n\t\t\t,Documents = (SELECT \n\t\t\t\tDocumentType = doctype \n\t\t\t\t,DocumentName = ''\n\t\t\t\t,DocumentFileLocation = ''\n\t\t\t\t,DocumentNumber = id\n\t\t\t\tFROM xTransportDoc [Document] WHERE TDocSet_ID IN (SELECT id FROM xTransportDocSet\n\t\t\t\t\tWHERE id IN (SELECT xTransportDocSet_ID FROm xTransportDocSetxLandfreight WHERE xLandfreight_ID = [Order].id))\n\t\t\t\tFOR XML AUTO, TYPE,ELEMENTS)\n\t\t\t,Remarks = ''\n\t\t\t,CustomsAgent = ''\n\t\t\t,CustomsAgentImport = ''\n\t\t\t,MRNNumber = ''\n\t\t\t,IncoTerms = 'DDP'\n\t\t\t,IncoTermsCity= (SELECT Name FROM xCity WHERE id = (SELECT City_ID FROM xLocation WHERE id = [Order].To_Location_ID))\n\t\t) General\n\t\tFOR XML AUTO, TYPE,ELEMENTS)\n\n\t\t----------------\n\t\t-- Pickupdata --\n\t\t----------------\n\n\t\t,(SELECT * FROM (SELECT\n\t\t\tPickupName = (SELECT companyname FROM xcompany WHERE id = (SELECT Company_ID FROM xLocation WHERE id = [Order].From_Location_ID))\n\t\t\t,PickupAddress = 'PickupAddress12345'--(SELECT completeAddress FROM xLocation WHERE id IN (SELECT From_Location_ID FROM xLandfreight where id = [Order].id))\n\t\t\t,PickupPostcode = '1234 AB'\n\t\t\t,PickupCity = (SELECT [Name] FROM xCity WHERE id = (SELECT City_ID FROM xLocation WHERE id = [Order].From_Location_ID))\n\t\t\t,PickupCountry = (SELECT IsoCode FROM xCountry WHERE CountryId = (SELECT Country_ID FROM xLocation WHERE id = [Order].From_Location_ID))\n\t\t\t,PickupUNLoCode = ''\n\t\t\t,PickupEORI = ''\n\t\t\t,PickupReference  = ''\n\t\t\t,PickupDate = format([Order].Pickup, 'yyyy-MM-dd')\n\t\t) PickupData\n\t\tFOR XML AUTO, TYPE,ELEMENTS)\n\n\t\t----------------\n\t   -- Deliverydata --\n\t\t----------------\n\n\t\t,(SELECT * FROM (SELECT\n\t\t\tDeliveryName = (SELECT companyname FROM xcompany WHERE id = (SELECT Counterparty_ID FROM xLocation WHERE id = [Order].To_Location_ID))\n\t\t\t,DeliveryAddress = 'DeliveryAddress12345'--(SELECT completeAddress FROM xLocation WHERE id IN (SELECT To_Location_ID FROM xLandfreight where id = [Order].id))\n\t\t\t,DeliveryPostcode = '1234 AB'\n\t\t\t,DeliveryCity = (SELECT [Name] FROM xCity WHERE id = (SELECT City_ID FROM xLocation WHERE id = [Order].To_Location_ID))\n\t\t\t,DeliveryCountry = (SELECT IsoCode FROM xCountry WHERE CountryId = (SELECT Country_ID FROM xLocation WHERE [id] = [Order].To_Location_ID))\n\t\t\t,DeliveryUNLoCode = ''\n\t\t\t,DeliveryEORI = ''\n\t\t\t,DeliveryReference = ''\n\t\t\t,DeliveryDate = format([Order].Delivery, 'yyyy-MM-dd')\n\t\t) DeliveryData\n\t\tFOR XML AUTO, TYPE,ELEMENTS)\n\n\t\t----------------\n\t    -- Orderlines --\n\t\t----------------\n\n\t\t,Orderlines = (SELECT \n\t\t\tMessageIDOrderLine = CONCAT('NR_' , [Orderline].id, '_' , ROW_NUMBER() over (ORDER BY (select 1)))\n\t\t\t,Quantity = case when [Orderline].Blok > 0 and [Orderline].Euro = 0 then [order].Blok \n\t\t\t\t\t\t\t when [Orderline].Blok = 0 and [Orderline].Euro > 0 then [order].Euro\n\t\t\t\t\t\t\t when [Orderline].Blok > 0 and [Orderline].Euro > 0 then [order].Euro + [order].Blok\n\t\t\t\t\t\t\t when [Orderline].Blok = 0 and [Orderline].Euro = 0 then 0\n\t\t\t\t\t\tEND\n\t\t\t,PackageID = case when [Orderline].Blok > 0 and [Orderline].Euro = 0 then 'Blok'\n\t\t\t\t\t\t\t  when [Orderline].Blok = 0 and [Orderline].Euro > 0 then 'Euro'\n\t\t\t\t\t\t\t  when [Orderline].Blok > 0 and [Orderline].Euro > 0 then 'Blok / Euro'\n\t\t\t\t\t\t\t  when [Orderline].Blok = 0 and [Orderline].Euro = 0 then 'Not specified'\n\t\t\t\t\t\t END\n\t\t\t,PalletType = ''\n\t\t\t,StatusOrderLine = 'New'\n\n\t\t----------------\n\t    -- Goodslines --\n\t\t----------------\n\n\t\t\t,Goodslines = (SELECT \n\t\t\t\tMessageIDGoodsline = CONCAT('NR_' , [Goodsline].id, '_' , ROW_NUMBER() over (ORDER BY (select 1)))\n\t\t\t\t,GoodsDesc = [Goodsline].docDescription\n\t\t\t\t,NumberOfBoxes = [Goodsline].LFCTR_Amount\n\t\t\t\t,UNCodeBox = 'BX'\n\t\t\t\t,Temp = ''\n\t\t\t\t,GrossWeight = CONVERT(DECIMAL(10,2),(SELECT ltrKGB FROM totals_lfctr WHERE xLFCTR_id = (SELECT id FROM xLFCTR WHERE id = [Goodsline].id)))\n\t\t\t\t,NettWeight = CONVERT(DECIMAL(10,2),(SELECT ltrKGN FROM totals_lfctr WHERE xLFCTR_id = (SELECT id FROM xLFCTR where id = [Goodsline].id)))\n\t\t\t\t,GoodsCode = (SELECT [ProductGN] = convert(nvarchar(8),ProdGN) FROM xProduct WHERE id = \n\t\t\t\t(SELECT xProduct_ID FROM xStock WHERE id =\n\t\t\t\t(SELECT Stock_ID FROM xTransactionDetail where id =\n\t\t\t\t(SELECT CTR_ID FROM xLFCTR WHERE id = (SELECT id FROM xLFCTR WHERE id = [Goodsline].id)\n\t\t\t\t))))\n\t\t\t\t,CountryOfOrigin = (SELECT IsoCode from xCountry WHERE CountryId = \n\t\t\t\t(select Origin_ID FROM xStock WHERE id =\n\t\t\t\t(SELECT Stock_ID FROM xTransactionDetail WHERE id =\n\t\t\t\t(SELECT CTR_ID FROM xLFCTR WHERE id = (SELECT id FROM xLFCTR WHERE id = [Goodsline].id)\n\t\t\t\t))))\n\t\t\t\t,Value = CONVERT(DECIMAL(10,2),(SELECT ctrAmount * ctrPrice AS Totalvalue from xCTRTotals where ctr_ID =\n\t\t\t\t(SELECT CTR_ID FROM xLFCTR WHERE id = (SELECT id FROM xLFCTR WHERE id = [Goodsline].id))))\n\t\t\t\t,ValueCurrency = (SELECT codeISO FROM xCurrency WHERE id = \n\t\t\t\t(SELECT Currency_ID FROM xTransactionHeader WHERE id =\n\t\t\t\t(SELECT TransactionHeader_ID from xTransactionDetail where id =\n\t\t\t\t(SELECT CTR_ID FROM xLFCTR WHERE id = (SELECT id FROM xLFCTR WHERE id = [Goodsline].id)\n\t\t\t\t))))\n\t\t\t\t,ItemDocuments = (SELECT\n\t\t\t\t\tItemDocumentType = ''\n\t\t\t\t\t,ItemDocumentName = ''\n\t\t\t\t\t,ItemDocumentFileLocation = ''\n\t\t\t\t\t,DocumentNumber = ''\n\t\t\t\tFROM xTransportDoc [ItemDocument] WHERE TDocSet_ID IN (SELECT id FROM xTransportDocSet WHERE id IN (\n\t\t\t\t\t\tSELECT xTransportDocSet_ID FROm xTransportDocSetxLandfreight WHERE xLandfreight_ID = [Orderline].id)\n\t\t\t\t\t)\n\t\t\t\tFOR XML AUTO, TYPE,ELEMENTS)\n\t\t\tFROM xLFCTR [Goodsline] WHERE [Orderline].id = [Goodsline].LF_ID FOR XML AUTO, TYPE,ELEMENTS)\n\t\tFROM xLandfreight [Orderline] WHERE [Order].id = [Orderline].id FOR XML AUTO, TYPE,ELEMENTS)\n\t FROM xLandfreight [Order] WHERE [Order].Transport_ID = [Orders].id FOR XML AUTO, TYPE,ELEMENTS)\nFROM xTransport [Orders] WHERE id = @id\nFOR XML AUTO,TYPE,ELEMENTS))\n\n\nDECLARE @filename nvarchar(1024) = dbo.strdate(NULL)+'_'+@id+'_'+'transport.xml'\nEXEC sp_api_modal_download @filename = @filename ,@mimetype = N'application/xml',@rawdata = @xml",
            "action_id": 1154,
            "action_name": "XML export freightline",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--Afleverbon afdrukken gebasseerd op Landfreight. Deze NIET gebruiken. Anaco gebruikt afleverbon gebasseerd op transactionheader zie repdef.\nEXEC sp_api_toast N'Afleverbon afdrukken' \n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\t--dit is nu alleen voor tellers en checks:\n\n\t\t--even niet registreren dat er wordt afgedrukt\n\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'LF'\t,@Context_Key_ID=@cid,@Report_CODE=N'deliverynote'\n\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select top 1 id from xTenantKey) -- een CRM wordt naar tenant gestuurd/geprint\n\t\t--DECLARE @error INT\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@fixedemail = @user\n\t\t\t,@sys_report_key = 'deliverynote' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\n\t\t--IF @error > 0 RAISERROR(N'Er is een probleem')\n\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 1155,
            "action_name": "Afleverbon",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--Afleverbon afdrukken gebasseerd op Landfreight. Deze NIET gebruiken. Anaco gebruikt afleverbon gebasseerd op transactionheader zie repdef.\nEXEC sp_api_toast N'Afleverbon afdrukken' \n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\t--dit is nu alleen voor tellers en checks:\n\n\t\t--even niet registreren dat er wordt afgedrukt\n\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'LF'\t,@Context_Key_ID=@cid,@Report_CODE=N'deliverynote'\n\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select top 1 id from xTenantKey) -- een CRM wordt naar tenant gestuurd/geprint\n\t\t--DECLARE @error INT\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = 'deliverynote' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@test = 0\n\t\t\t,@FixedPrinter_ID = 3\n\t\t--IF @error > 0 RAISERROR(N'Er is een probleem')\n\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 1156,
            "action_name": "Afleverbon - Print",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast N'CMR afdrukken' \n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\t--dit is nu alleen voor tellers en checks:\n\n\t\t--even niet registreren dat er wordt afgedrukt\n\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'LF'\t,@Context_Key_ID=@cid,@Report_CODE=N'CMR'\n\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select top 1 id from xTenantKey) -- een CRM wordt naar tenant gestuurd/geprint\n\t\t--DECLARE @error INT\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@fixedemail = @user\n\t\t\t,@sys_report_key = 'cmr' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@test = 1\n\n\t\t--IF @error > 0 RAISERROR(N'Er is een probleem')\n\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 1157,
            "action_name": "CMR",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast N'CMR afdrukken' \n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\t--dit is nu alleen voor tellers en checks:\n\n\t\t--even niet registreren dat er wordt afgedrukt\n\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'LF'\t,@Context_Key_ID=@cid,@Report_CODE=N'CMR'\n\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select top 1 id from xTenantKey) -- een CRM wordt naar tenant gestuurd/geprint\n\t\t--DECLARE @error INT\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = 'cmr' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@test = 0\n\t\t\t--,@FixedPrinter_ID = 5 -- temp solution\n\t\t--IF @error > 0 RAISERROR(N'Er is een probleem')\n\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 1158,
            "action_name": "CMR - Printer",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "/*update xlandfreight set status ='Departed',i_away = 1 where id IN(select * FROM string_split(@IDS,','))\nEXEC sp_api_toast N'Pallets gesloten'*/\n/*\nEXEC sp_api_modal_alert N'Zeker weten?',N'De geselecteerde regels worden op Departed gezet.'\nDECLARE @vast nvarchar(128)\n\nDECLARE @cursor CURSOR,@idval INT\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @idval\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\t--EXEC sp_api_modal_post N'uitgaande_pallets',N'i_away',1,@idval\n\t\tEXEC sp_api_modal_post N'uitgaande_pallets',N'status','Departed',@idval\n\t\tEXEC sp_api_modal_save N'uitgaande_pallets',@idval\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\nEXEC sp_api_toast N'Pallets gesloten'\nEXEC sp_api_modal_clear\nEXEC sp_api_modal_select_all_clear\n*/\n\nIF (SELECT COUNT(id) from q_xtransactionheader where status='openSale' AND (xctrStatus=0 OR xCtrStatus IN (256,512,768)) AND id in (SELECT transactionheader_id from xlandfreight where id in (SELECT value FROM string_split(@ids,',')))) != 0\n\tBEGIN\n\t\tEXEC sp_api_modal_alert N'LET OP!','Er zijn regels nog niet volledig toegewezen. Wijs alle regels volledig toe voordat u het transport op \"Departed\" kan zetten.'\n\t\tEXEC sp_api_modal_clear\n\t\tRETURN\n\tEND\n\nDECLARE @cursor CURSOR,@idval INT\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @idval\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\t/*EXEC sp_api_modal_post N'uitgaande_pallets',N'i_away',1,@idval*/\n\t\tEXEC sp_api_modal_post N'uitgaande_pallets',N'status','Departed',@idval\n\t\tEXEC sp_api_modal_save N'uitgaande_pallets',@idval\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\n\n\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @idval\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t--EXEC sp_api_toast @idval\n\t-- nieuwe cursor\n\tDECLARE @THcursor CURSOR\n\t\tSET @THcursor = CURSOR LOCAL FAST_FORWARD FOR SELECT id from q_xtransactionheader where id = (SELECT transactionheader_ID from xlandfreight where id = @idval)\n\t\tOPEN @THcursor;\n\t\t\tFETCH NEXT FROM @THcursor INTO @idval\n\t\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\n\t\t\t/*CG 210621 Als er geen landfreight met huidige transactionheader_ID is met status Loading en alle ctr's prijzen hebben dan: */\n\t\t\tIF (SELECT COUNT(ID) from xlandfreight where transactionheader_ID = @idval AND Status = 'Loading') = 0 \n\t\t\tAND (SELECT COUNT(id) from q_xtransactiondetail where transactionheader_ID = @idval AND (Price = 0 OR Price is null OR pricetype != 'FIXED')) = 0\n\t\t\t\tBEGIN\n\t\t\t\t\t/*\n\t\t\t\t\tEXEC sp_api_modal_post N'verkoop',N'status','ReadyForInvoice',@idval\n\t\t\t\t\tEXEC sp_api_modal_save N'verkoop',@idval\n\t\t\t\t\t*/\n\t\t\t\t\tEXEC @main_db.dbo.Fase_Guard @ID=@idval\n\t\t\t\t\t,@Context =N'CTH' \t\t\t\t-- cth is voor xtransactionheader; INV voor factuur etc...\n\t\t\t\t\t,@Fase= N'ReadyForInvoice' \t-- fase waar je naartoe wilt iken\n\t\t\t\t\t--,@StateOK=@isOK OUT\t\t\t\t-- deze opvragen, 1 betekent GOED; 0 betekent FOUT\n\t\t\t\t\t--,@Message=@Mess OUT\t\t\t\t--\tbij stateOK =0 staat hier text met de foutmelding\n\t\t\t\t\t--,@CurrentFase=@Current OUT \n\t\t\t\tEND\n\t\t\t\n\t\t\t/*CG 210621 Als er geen landfreight met huidige transactionheader_ID is met status Loading en er een ctr is met prijs \"0\" of andere pricetype dan \"FIXED\": */\n\t\t\tIF (SELECT COUNT(ID) from xlandfreight where transactionheader_ID = @idval AND Status = 'Loading') = 0 \n\t\t\tAND (SELECT COUNT(id) from q_xtransactiondetail where transactionheader_ID = @idval AND (Price = 0 OR Price is null OR pricetype != 'FIXED')) > 0\n\t\t\t\tBEGIN\n\t\t\t\t\t--verzet de fase als dat kan\n\t\t\t\t\tEXEC @main_db.dbo.Fase_Guard @ID=@idval\n\t\t\t\t\t\t\t\t\t\t,@Context =N'CTH' \t\t\t\t-- cth is voor xtransactionheader; INV voor factuur etc...\n\t\t\t\t\t\t\t\t\t\t,@Fase= N'openPrice' \t-- fase waar je naartoe wilt iken\n\t\t\t\t\t\t\t\t\t\t--,@StateOK=@isOK OUT\t\t\t\t-- deze opvragen, 1 betekent GOED; 0 betekent FOUT\n\t\t\t\t\t\t\t\t\t\t--,@Message=@Mess OUT\t\t\t\t--\tbij stateOK =0 staat hier text met de foutmelding\n\t\t\t\t\t\t\t\t\t\t--,@CurrentFase=@Current OUT \n\t\t\t\tEND\n\t\t\t\t\t\t--else status moeilijk...\t\n\t\t\tFETCH NEXT FROM @THcursor INTO @idval\n\t\t\tEND\n\t\tCLOSE @THcursor;\n\t\tDEALLOCATE @THcursor;\n\t\t\n\t\t-- einde nieuwe cursor\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\n\n\nEXEC sp_api_modal_clear\nEXEC sp_api_modal_select_all_clear\n",
            "action_id": 1159,
            "action_name": "Departed",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.ExtraVracht @ID",
            "action_id": 1160,
            "action_name": "Extra Vracht Maken",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_alert N'Fix LF',N'Probeer door een dirty-update en updaterequest-update een sidekick te maken en de lft_PalCalc goed te krijgen.'\nUPDATE xLandfreight SET Dirty=13 WHERE  id = @id\nUPDATE xLandFreightTotals SET updaterequest=13 WHERE LandFreight_ID = @id\nEXEC sp_api_modal_clear\n",
            "action_id": 1161,
            "action_name": "Fix LF /  lft_PalCalc",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast N'KCB downloaden' \n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\nDECLARE @filename nvarchar(1024)\nDECLARE @huidigeid nvarchar(200)\nDECLARE @warning nvarchar(1024)\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\tSET @huidigeid = @cid\n\tIF (select count(id) from xlfctr where LF_ID = @cid and ltrStock_ID in (select id from xstock where id = ltrStock_ID and xCE_ID is not null)) = 0\n\t\tBEGIN\n\t\tSET @warning = @huidigeid + ' bevat geen artikelen welke gemeld moeten worden'\n\t\tEXEC sp_api_toast @warning\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\t\tEND\n\t\t\n\t\tSET @filename = dbo.strdate(NULL)+'_'+@huidigeid+'_'+'KCB.csv'\n\t\t\tSELECT *\n\t\t\tINTO #KCBCSV\n\t\t\tFROM          RV_KCBDOCUMENT_LF\n\t\t\tWHERE        (id = @cid) and ([x/product_naam] is not null)\n\t\t\tALTER TABLE #KCBCSV drop column id\n\t\t\tEXEC sp_api_modal_csv @tmptable=N'#KCBCSV',@orderby=N'ORDER BY [x/nummer]',@filename=@filename, @ansi=1\n\t\t\tDROP TABLE #KCBCSV \n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;\n/*\nEXEC sp_api_modal_text 'Voor de onderstaande pallets worden geen bestanden gemaakt. De artikelen hoeven niet gemeld te worden bij de KCB', 'text-danger font-weight-bold text-center'\nSELECT \n[Klant] = (select code from xcompany where id = Counterparty_ID)\nINTO #NOKCB\nFROM dbo.Q_xlandfreight\nwhere id in (SELECT value FROM string_split(@ids,',')) and id in (select lf_id from xlfctr where ltrStock_ID in (select id from xstock where id = ltrStock_ID and xCE_ID is null))\nEXEC sp_api_modal_table @tmptable=N'#NOKCB'\n*/",
            "action_id": 1163,
            "action_name": "KCB-CSV",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.[LF_Voltooien] @ID",
            "action_id": 1164,
            "action_name": "Landfreight Voltooien",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--update xlandfreight SET transport_id = NULL WHERE id ={[uitgaande_pallets].id}\r\n--DECLARE @zetnull = NULL\r\nDECLARE @cursor CURSOR,@idval INT\r\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\r\nOPEN @cursor;\r\nFETCH NEXT FROM @cursor INTO @idval\r\nWHILE @@FETCH_STATUS = 0\r\n\tBEGIN\r\n\t\tEXEC sp_api_modal_post N'uitgaande_pallets',N'Transport_ID',NULL,@idval\r\n\t\tEXEC sp_api_modal_save N'uitgaande_pallets',@idval\r\n\r\n\t\tFETCH NEXT FROM @cursor INTO @idval\r\n\tEND\r\nCLOSE @cursor;\r\nDEALLOCATE @cursor;",
            "action_id": 1165,
            "action_name": "Maak Los Van Transport",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_text 'Geselecteerde regels:','text-primary font-weight-bold display-4 text-center pb-3'\r\n/*\r\nDECLARE @reducer nvarchar(max) = N'id IN('+@ids+')'\r\nEXEC sp_api_modal_table @card_id,@reducer\r\n\r\nSELECT id,[TotPal@]=lft_PalCalc,[Blok@]=Blok,[Euro@]=Euro INTO #Q_xLandfreight FROM Q_xLandfreight WHERE id IN(SELECT * FROM string_split(@ids,','))\r\nEXEC sp_api_modal_table @tmptable=N'#Q_xLandfreight'\r\n*/\r\nSELECT [TotPal]=SUM(lft_PalCalc),[Blok]=SUM(Blok),[Euro]=SUM(Euro) INTO #Q_xLandfreightSum FROM Q_xLandfreight WHERE id IN(SELECT * FROM string_split(@ids,','))\r\nEXEC sp_api_modal_table @tmptable=N'#Q_xLandfreightSum'\r\n\r\n",
            "action_id": 1168,
            "action_name": "Optellen",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @company_id nvarchar(32),@Countercompany nvarchar(32),@button nvarchar(128),@button2 nvarchar(128),@new_id nvarchar(32)\n,@goto nvarchar(2000),@search nvarchar(2000), @location_id nvarchar(32), @reducer nvarchar(max), @date nvarchar(128)\n,@Euro nvarchar(128),@Blok nvarchar(128), @Transportinfo nvarchar(32),@THid nvarchar(32)\n,@button1 nvarchar(128),@updateinfo nvarchar(128)\n--= N'Set Pallets'\n--\tEXEC sp_api_modal_modal @class=N'w-100'\n\n\nSELECT \n\tid\n\t,[Bedrijf ] = (SELECT CONCAT([xCompany].[Code],'-',CompanyName) FROM [xCompany] WHERE [id] = [xlandfreight].[Counterparty_ID])\n\t,[lft_PalCalc ] = lft_PalCalc\n\t, Blok, Euro\n\tINTO #modalupdate\nFROM xLandfreight WHERE id = @id AND (status != 'Departed')\nEXEC sp_api_modal_table_update @tmptable = N'#modalupdate',@focusx = 3,@focusy = 1\n\nDECLARE @button_text1 nvarchar(128) = 'Opslaan'\nEXEC sp_api_modal_button @name='button1',@value = @button_text1, @valueout = @button1 OUT ,@class='btn-primary',@key='Enter'\nIF @button1 IS NOT NULL\n\tBEGIN\n\t\tSET @THid = (select Transactionheader_ID from xlandfreight where id = @id)\n\t\tSET @updateinfo = (SELECT logistic from xTransactionheader where id = @THid)\n\t\tIF CHARINDEX('B:',@updateinfo) > 0 SET @updateinfo = LEFT(@updateinfo,CHARINDEX('B:',@updateinfo)-1)\n\t\tSET @updateinfo = TRIM(@updateinfo)\n\t\tDECLARE @lfid int\n\t\tDECLARE @cursor_xLandfreight CURSOR\n\t\tSET @cursor_xLandfreight = CURSOR LOCAL FAST_FORWARD FOR SELECT id, Blok, Euro FROM #modalupdate\n\t\tOPEN @cursor_xLandfreight;\n\t\tFETCH NEXT FROM @cursor_xLandfreight INTO @lfid,@Blok,@Euro\n\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_post 'uitgaande_pallets','Blok',@Blok,@lfid\n\t\t\t\tEXEC sp_api_modal_post 'uitgaande_pallets','Euro',@Euro,@lfid\n\t\t\t\tEXEC sp_api_modal_save 'uitgaande_pallets',@lfid\n\t\t\t\tSET @updateinfo = CONCAT(@updateinfo,' B:',@blok,' E:',@Euro)\n\t\t\t\tFETCH NEXT FROM @cursor_xLandfreight INTO @lfid,@Blok,@Euro\n\t\t\tEND\n\t\tCLOSE @cursor_xLandfreight;\n\t\tDEALLOCATE @cursor_xLandfreight;\n\t\tEXEC sp_api_modal_post 'verkoop','logistic',@updateinfo,@THid\n\t\tEXEC sp_api_modal_save 'verkoop',@THid\n\t\tEXEC sp_api_modal_clear\n\tEND\nRETURN\n/*\nSELECT TOP 1 @Euro = Euro, @Blok = Blok FROM xLandfreight WHERE Transactionheader_ID = @id\n\n\tEXEC sp_api_modal_text 'Aantal Blok:','text-primary font-weight-bold h4' --display-4 text-center\n\tEXEC sp_api_modal_input @name='Blok',@value = @Blok OUT,@class='w-25 mt-3'\n\tEXEC sp_api_modal_text 'Aantal Euro:','text-primary font-weight-bold h4' --display-4 text-center\n\tEXEC sp_api_modal_input @name='Euro',@value = @Euro OUT,@class='w-25 mt-3'\n\tEXEC sp_api_modal_text 'Kies een optie:','text-primary font-weight-bold h4' --display-4 text-center\n\tEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Enter'\n\nIF @button = @button1\n\tBEGIN\n\t\tDECLARE @lfid int\n\t\t\tDECLARE @cursor_xLandfreight CURSOR\n\t\t\tSET @cursor_xLandfreight = CURSOR LOCAL FAST_FORWARD FOR SELECT id FROM xLandfreight WHERE Transactionheader_ID = @id\n\t\t\tOPEN @cursor_xLandfreight;\n\t\t\tFETCH NEXT FROM @cursor_xLandfreight INTO @lfid\n\t\t\tWHILE @@FETCH_STATUS = 0\n\t\t\t\tBEGIN\n\t\t\t\t\tEXEC sp_api_modal_post 'xlandfreight','Blok',@Blok,@lfid\n\t\t\t\t\tEXEC sp_api_modal_post 'xlandfreight','Euro',@Euro,@lfid\n\t\t\t\t\tEXEC sp_api_modal_save 'xlandfreight',@lfid\n\t\t\t\t\tFETCH NEXT FROM @cursor_xLandfreight INTO @lfid\n\t\t\t\tEND\n\t\t\tCLOSE @cursor_xLandfreight;\n\t\t\tDEALLOCATE @cursor_xLandfreight;\n\tEND\n\nSELECT Bedrijf = (SELECT [xCompany].[Code] FROM [xCompany] WHERE [id] = [xlandfreight].[Counterparty_ID])\n\t,Naam = (SELECT [xCompany].[CompanyName] FROM [xCompany] WHERE [id] = [xlandfreight].[Counterparty_ID])\n\t--,Palcalc = (SELECT [xLandfreight].[lft_PalCalc] FROM [xLandfreight] WHERE [Transactionheader_ID] = @id)\n\t,[Order] = (SELECT [xtransactionheader].[id] FROM [xtransactionheader] WHERE [id] = @id)\n\t, Blok, Euro INTO #tmptable FROM xLandfreight WHERE Transactionheader_ID = @id\nEXEC sp_api_modal_table  @tmptable = '#tmptable'\n/*\nSET @reducer = N'Transport_ID = ' + @id\nEXEC sp_api_modal_table @card_name = N'uitgaande_pallets',@reducer= @reducer\n*/\nRETURN\n\n*/",
            "action_id": 1170,
            "action_name": "Pallets doorgeven",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast N'PROFORMA afdrukken' \nDECLARE @test bit = 0\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\t--dit is nu alleen voor tellers en checks:\n\n\t\t--even niet registreren dat er wordt afgedrukt\n\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'LF'\t,@Context_Key_ID=@cid,@Report_CODE=N'PROFORMA'\n\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select top 1 id from xTenantKey) -- een CRM wordt naar tenant gestuurd/geprint\n\t\t--DECLARE @error INT\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@fixedemail = @user\n\t\t\t,@sys_report_key = 'proforma' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@test = @test\n\t\t--IF @error > 0 RAISERROR(N'Er is een probleem')\n\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 1171,
            "action_name": "PROFORMA",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast N'PROFORMA afdrukken' \n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\t--dit is nu alleen voor tellers en checks:\n\n\t\t--even niet registreren dat er wordt afgedrukt\n\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'LF'\t,@Context_Key_ID=@cid,@Report_CODE=N'PROFORMA'\n\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select top 1 id from xTenantKey) -- een CRM wordt naar tenant gestuurd/geprint\n\t\t--DECLARE @error INT\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = 'proforma' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@test = 0\n\t\t\t,@FixedPrinter_ID = 1\n\n\t\t--IF @error > 0 RAISERROR(N'Er is een probleem')\n\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 1172,
            "action_name": "Proforma - Printer",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXECUTE @main_db.dbo.RebuildLandfreight @ID ",
            "action_id": 1173,
            "action_name": "RebuildLandfreight",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @button nvarchar(128)\nSET @button = ''\n\nIF (select count(id) from Q_xTransactionDetail where [delayed] = 1 AND transactionheader_id in (SELECT TransactionHeader_ID from xLandfreight where id IN ({@ids}))) > 0\n\tBEGIN\n\t\tSET @reserved = 0\n\t\tEXEC sp_api_modal_text 'Alle regels staan niet meer op gereserveerd.', 'text-primary font-weight-bold text-center display-4'\n\tEND\nELSE IF (select count(id) from Q_xTransactionDetail where [delayed] = 0 AND transactionheader_id in (SELECT TransactionHeader_ID from xLandfreight where id IN ({@ids}))) > 0\n\tBEGIN\n\t\tEXEC sp_api_modal_text 'Alle regels staan nog niet op gereserveerd, weet u zeker dat alle regels naar gereserveerd moeten?', 'text-primary font-weight-bold text-center h3'\n\t\tEXEC sp_api_modal_button @name='button',@value = 'NaarReserved',@valueout = @button OUT,@class = 'btn-primary',@key = '1'\n\t\tIF @button = 'NaarReserved'\n\t\tBEGIN\n\t\t\tSET @reserved = 1\n\t\t\tEXEC sp_api_modal_clear\n\t\t\tEXEC sp_api_modal_text 'Alle regels staan op gereserveerd.', 'text-primary font-weight-bold text-center display-4'\n\t\tEND\n\tEND\nIF @reserved IS NOT NULL\n\tBEGIN\n\t\tDECLARE @cursor CURSOR,@idval INT\n\t\tSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT id FROM q_xtransactiondetail\n\t\twhere transactionheader_id in (SELECT TransactionHeader_ID from xLandfreight where id IN ({@ids}))\n\t\tOPEN @cursor;\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\n\t\t\t\tUPDATE Q_xTransactionDetail SET [delayed] = @reserved WHERE id = @idval\n\t\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\tEND\n\t\tCLOSE @cursor;\n\t\tDEALLOCATE @cursor;\n\t\tEXEC sp_api_modal_clear\n\tEND",
            "action_id": 1174,
            "action_name": "Reserved On/Off",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @uitgaandtransport nvarchar(32), @reducer nvarchar(max), @Transportinfo nvarchar(32), @date nvarchar(128), @button nvarchar(128),@Transporter_ID nvarchar(128), @Counterparty_ID nvarchar(128), @LaatsteTransportCompany_ID nvarchar(128), @Warningmessage nvarchar(128),\n@button1 nvarchar(128) = N'Set Transport'\nset @date = dbo.workDate()\n--SET @reducer = concat('TransportStatus = ',N'Arriving')\nSET @reducer = N'TransportDate = dbo.workDate()'\nEXEC sp_api_modal_select @card_name = N'uitgaand_transport',@value = @uitgaandtransport OUT,@focus = 1,@reducer = @reducer\nSET @Transporter_ID = (select Transporter_ID from xtransport where id = @uitgaandtransport)\n\nIF @uitgaandtransport > 0\n\t\tBEGIN\n\t\t\tDECLARE @cursor CURSOR,@idval INT,@warning bit = 0\n\t\t\tSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\n\t\t\tOPEN @cursor;\n\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\tWHILE @@FETCH_STATUS = 0\n\t\t\t\tBEGIN\n\t\t\t\tSET @Counterparty_ID = (select Counterparty_ID from xlandfreight where id = @idval)\n\t\t\t\tSET @LaatsteTransportCompany_ID = (select top 1 TransportCompany_ID from xlandfreight where datum < dbo.ABCDATE() and TDT = 2 and Counterparty_ID = @Counterparty_ID \t\t\t\t\t\t\t\n\t\t\t\torder by datum desc)\n\t\t\t\t--EXEC sp_api_toast @LaatsteTransportCompany_ID\n\t\t\t\tIF @LaatsteTransportCompany_ID != @Transporter_ID--(select TransportCompany_ID from xlandfreight where id = @id)\n\t\t\t\t\tBEGIN\n\t\t\t\t\tSET @Warningmessage = concat((SELECT code from xcompany where id = (SELECT Counterparty_ID from xlandfreight where id = @idval)),' is eerder verzonden met: ',\n\t\t\t\t\t(select top 1 [Transporteur] = (select code from xcompany where id =TransportCompany_ID) from xlandfreight where datum < dbo.ABCDATE() and TDT = 2 and Counterparty_ID = @Counterparty_ID \t\t\t\t\t\t\t\n\t\t\t\torder by datum desc))\n\t\t\t\t\tEXEC sp_api_modal_text @Warningmessage\n\t\t\t\t\t--EXEC sp_api_modal_text @idval\n\t\t\t\t\tSET @warning = 1\n\t\t\t\t\tEND\n\t\t\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\t\tEND\n\t\t\tCLOSE @cursor;\n\t\t\tDEALLOCATE @cursor;\n\t\t\tIF @warning = 1\n\t\t\t\tBEGIN\n\t\t\t\t\tEXEC sp_api_modal_button @name='@warningbutton',@value = N'Ga verder', @valueout = @warningbutton OUT ,@class='btn-danger',@key='Enter'\n--\t\t\t\t\tEXEC sp_api_toast @warningbutton\n\t\t\t\t\tIF @warningbutton IS NULL RETURN\n\t\t\t\tEND\n\t\t\tSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\n\t\t\tOPEN @cursor;\n\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\tWHILE @@FETCH_STATUS = 0\n\t\t\t\tBEGIN\n\t\t\t\t\tEXEC sp_api_modal_post N'uitgaande_pallets',N'Transport_ID',@uitgaandtransport,@idval\n\t\t\t\t\tEXEC sp_api_modal_post N'uitgaande_pallets',N'TransportCompany_ID',@Transporter_ID,@idval\n\t\t\t\t\tEXEC sp_api_modal_save N'uitgaande_pallets',@idval\n\t\t\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\t\tEND\n\t\t\tCLOSE @cursor;\n\t\t\tDEALLOCATE @cursor;\n\n\n\t\t\tEXEC sp_api_modal_clear\n\t\t\tEXEC sp_api_modal_select_all_clear\nEND",
            "action_id": 1175,
            "action_name": "Select Transport",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "update xlandfreight set status ='Loading',i_away = 0 where id IN(select * FROM string_split(@IDS,','))\nEXEC sp_api_toast N'Terug naar Loading'",
            "action_id": 1176,
            "action_name": "Terug naar Loading",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @transportid nvarchar(32), @button nvarchar(128),@reducerdate nvarchar(128)\n,@button1 nvarchar(128) = N'Snel Verlading Overzicht'\n,@button2 nvarchar(128) = N'Enkel de Sum'\nSET @reducerdate = concat('TransportDate = ','dbo.ABCDATE()')\nEXEC sp_api_toast @reducerdate\nEXEC sp_api_modal_select @card_name = N'uitgaand_transport',@value = @transportid OUT,@reducer = @reducerdate,@focus = 1\n\nIF @transportid > 0\n\tBEGIN\nEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='1'\nEXEC sp_api_modal_button @name='button',@value=@button2,@valueout = @button OUT,@key='2'\nIF @button = @button1 \n\t\tBEGIN\n\t\tSELECT [Location*]=(select Locationcode from xlocation where id = To_Location_ID),[TotPal@]=SUM(lft_PalCalc),[Blok@]=SUM(Blok),[Euro@]=SUM(Euro) \n\t\tINTO #Q_xLandfreight\n\t\tFROM Q_xLandfreight \n\t\tWHERE Q_xLandfreight.Transport_ID = @transportid AND TDT = 2 AND doTransport != 0 AND datum = dbo.workdate()\n\t\tGROUP BY To_Location_ID, lft_PalCalc, Blok, Euro\n\t\tEXEC sp_api_modal_table @tmptable=N'#Q_xLandfreight'\n\t\tEND\nIF @button = @button2\n\t\tBEGIN\n\t\tSELECT [TotPal]=SUM(lft_PalCalc),[Blok]=SUM(Blok),[Euro]=SUM(Euro) \n\t\tINTO #Q_xLandfreightSum \n\t\tFROM Q_xLandfreight \n\t\tWHERE Q_xLandfreight.Transport_ID = @transportid AND TDT = 2 AND doTransport != 0 AND datum = dbo.workdate()\n\t\tEXEC sp_api_modal_table @tmptable=N'#Q_xLandfreightSum'\n\t\tEND\n\t\n\t\t\n\tEND\n\n/*\n\t\tDECLARE @reducer nvarchar(max) = N'TransportCompany_ID = ('+@company_id+')'\n\t\tEXEC sp_api_modal_table @card_id,@reducer\n*/\n\n\n/*\n\t\tSELECT [TotPal]=SUM(lft_PalCalc),[Blok]=SUM(Blok),[Euro]=SUM(Euro) INTO #Q_xLandfreightSum FROM Q_xLandfreight \n\t\tWHERE Q_xLandfreight.TransportCompany_ID = @company_id AND Transport_ID is NULL AND TDT = 2\n\t\tEXEC sp_api_modal_table @tmptable=N'#Q_xLandfreightSum'\n*/\n",
            "action_id": 1177,
            "action_name": "Transp Pal Sum",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @Transport_ID INT, @TransportCompany_ID INT\nSET @Transport_ID = (SELECT Transport_ID from xlandfreight where id = @id)\nSET @TransportCompany_ID = (SELECT TransportCompany_ID from xlandfreight where id = @id)\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\nIF @Transport_ID is null\n\tBEGIN\n\t\tEXEC sp_api_toast N'Verladingsoverzicht afdrukken voor indeling' \t\t\t\t\n\t\t\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'LF'\t,@Context_Key_ID=@TransportCompany_ID,@Report_CODE=N'verladingsoverzicht'\n\n\t\t\t\t--dit is de feitelijke \"run\"\n\t\t\t\tSET @toCompany_ID = (select top 1 id from xTenantKey) -- een CRM wordt naar tenant gestuurd/geprint\n\t\t\t\t--DECLARE @error INT\n\t\t\t\tEXEC sp_api_report_generate @id = @TransportCompany_ID\n\t\t\t\t\t,@sys_report_key = 'verladingsoverzicht' --zie xrepdef\n\t\t\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t\t\t,@fromCompany_ID = @fromCompany_ID\n\tEND\nIF @Transport_ID > 0\n\tBEGIN\n\t\tEXEC sp_api_toast N'Verladingsoverzicht afdrukken voor loods' \n\t\t\t\t EXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'LF'\t,@Context_Key_ID=@Transport_ID,@Report_CODE=N'verladingsoverzicht_loods'\n\t\t\t\t--dit is de feitelijke \"run\"\n\t\t\t\tSET @toCompany_ID = (select top 1 id from xTenantKey) -- een CRM wordt naar tenant gestuurd/geprint\n\t\t\t\t--DECLARE @error INT\n\t\t\t\tEXEC sp_api_report_generate @id = @Transport_ID\n\t\t\t\t\t,@sys_report_key = 'verladingsoverzicht_loods' --zie xrepdef\n\t\t\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t\t\t,@fromCompany_ID = @fromCompany_ID\n\tEND",
            "action_id": 1180,
            "action_name": "Verladingsoverzicht",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_alert N'Verwijder Pallet en alle palletregels?'\nDECLARE @cursor CURSOR,@idval int\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @idval\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tDELETE FROM xLFCTR WHERE LF_ID = @idval\n\t\tDELETE from xcostregistration where syskey_id=1000 and Landfreight_ID=@idval /*210616 RH verwijder de automatisch gegenereerde transportkosten registratie (herkenbaar aan syskey_id=1000)*/\n\t\tDELETE FROM xLandfreight WHERE ID = @idval\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\n\nEXEC sp_api_modal_select_all_clear\nEXEC @main_db.dbo.Create_ALL_Landfreight\nEXEC sp_api_go2\n",
            "action_id": 1181,
            "action_name": "Verwijder Pallet",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @company_id nvarchar(32),@button nvarchar(128),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000), @location_id nvarchar(32), @reducer nvarchar(max), @date nvarchar(128), @Transportinfo nvarchar(32)\r\n,@button1 nvarchar(128) = N'Nieuwe inkomend transport'\r\n,@button2 nvarchar(128) = N'Laatste open-inkomend transport'\r\nset @date = dbo.workDate()\r\nEXEC sp_api_modal_select @card_name = N'transporteur',@value = @company_id OUT,@focus = 1\r\nSET @reducer = CONCAT('company_id = ',@company_id)\r\n\r\nIF @company_id > 0\r\nBEGIN\r\n\t--DECLARE @only_new_is_possible BIT = 0\r\n\t--EXEC sp_api_modal_select @card_name = N'xlocation',@reducer = @reducer,@value = @location_id OUT,@class='mt-3',@focus = 1\r\n\t--IF @location_id > 0\r\n\tEXEC sp_api_modal_input @name = 'Transportinfo',@value = @Transportinfo OUT, @class = 'mt-3',@focus = 1\r\n\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3'\r\n\tEXEC sp_api_modal_text 'Kies een optie:','text-primary font-weight-bold display-4 text-center'\r\n\tEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Insert'\r\n\t\tIF EXISTS (SELECT * FROM xTransport WHERE TransportStatus=N'Arriving' AND Transporter_ID = @company_id)\r\n\t\t\tEXEC sp_api_modal_button @name='button',@value=@button2,@valueout = @button OUT,@key='F1'\r\n/*\t\t\r\nELSE\r\n\t\tIF (select COUNT(id) from xlocation where company_id = @company_id ) = 1 \r\n\t\t\tBEGIN\r\n\t\t\t\tSET @only_new_is_possible = 1\r\n\t\t\tEND\r\n*/\r\n\tIF @button = @button1 --OR @only_new_is_possible = 1\r\n\t\tBEGIN\r\n\t\tDELETE FROM api_storage WHERE card_id = (SELECT id FROM api_card WHERE name = N'inkomend_transport') AND child_id = 0 AND user_id = @user_id\r\n\t\tEXEC sp_api_modal_clear\r\n\t\t\tEXEC sp_api_modal_post N'inkomend_transport',N'Transporter_ID',@company_id,0\r\n\t\t\tEXEC sp_api_modal_post N'inkomend_transport',N'TransportDate',@date,0\r\n\t\t\tEXEC sp_api_modal_post N'inkomend_transport',N'Transportinfo',@Transportinfo,0\r\n\t\t\tEXEC @new_id = sp_api_modal_save N'inkomend_transport',0\r\n\t\t\tIF @new_id > 0\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @goto = N'/inkomend_transport/'+@new_id+'/landfreightselection/0/14168'\r\n\t\t\t\t\tEXEC sp_api_toast N'Nieuwe uitgaande transport',N'alert-primary'\r\n\t\t\t\t\tSET @search = N'?id='+@new_id\r\n\t\t\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/inkomend_transport',@referer_search=@search\r\n\t\t\t\tEND\r\n\t\t\tELSE\r\n\t\t\t\tEXEC sp_api_toast N'Error nieuwe uitgaande transport',N'alert-danger'\r\n\t\t\tEXEC sp_api_modal_clear\r\n\t\tEND\r\n\tIF @button = @button2\r\n\t\tBEGIN\r\n\t\t\tSET @new_id = (SELECT TOP 1 id FROM xTransport WHERE TransportStatus=N'Arriving' AND Transporter_ID = @company_id ORDER BY id DESC)\r\n\t\t\tSET @goto = N'/inkomend_transport/'+@new_id+'/landfreightselection/0/14168'\r\n\t\t\tSET @search = N'?id='+@new_id\r\n\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/inkomend_transport',@referer_search=@search\r\n\t\tEND\r\nEND",
            "action_id": 1182,
            "action_name": "Insert Transport",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@date2 nvarchar(128),@button nvarchar(128),@TransComp nvarchar(128)\r\n--set @date = dbo.workDate()\r\nEXEC sp_api_modal_text 'Zoek op transport bedrijf'\r\nEXEC sp_api_modal_input @name='Transporteur',@value = @TransComp OUT,@focus=1,@select=1 -- zoek veld\r\nEXEC sp_api_modal_text 'Van:'\r\nEXEC sp_api_modal_date @name='Date',@value = @date OUT -- zoek veld\r\nEXEC sp_api_modal_text 'Tot en met:'\r\nEXEC sp_api_modal_date @name='Date2',@value = @date2 OUT -- zoek veld\r\n--SET @date2 = CONCAT(@date2,' 23:59:59.999')\r\nSET @button = 'DepartingPalletsLijst'\r\nEXEC sp_api_modal_button @name='button',@value = 'DepartingPalletsLijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\r\nEXEC sp_api_modal_button @name='button',@value = 'ArrivedPalletsLijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F2'\r\n\r\nIF @button =  'DepartingPalletsLijst'\r\nBEGIN\r\nSELECT *\r\nINTO #DepartingPalletsLijst\r\nFROM          RV_TransportPalletLijst\r\nWHERE\t\t(TransportStatus = 'Departing') AND (TransportDate BETWEEN @date AND @date2) AND (@TransComp is NULL OR [TransComp*] LIKE @TransComp+'%')\r\nEXEC sp_api_modal_table @tmptable=N'#DepartingPalletsLijst',@orderby=N'ORDER BY [TransComp*] ASC'\r\nEND \r\n\r\nIF @button =  'ArrivedPalletsLijst'\r\nBEGIN\r\nSELECT *\r\nINTO #ArrivedPalletsLijst\r\nFROM          RV_TransportPalletLijst\r\nWHERE\t\t(TransportStatus = 'Arrived') AND (TransportDate BETWEEN @date AND @date2) AND (@TransComp is NULL OR [TransComp*] LIKE @TransComp+'%')\r\nEXEC sp_api_modal_table @tmptable=N'#ArrivedPalletsLijst',@orderby=N'ORDER BY [TransComp*] ASC'\r\nEND \r\n",
            "action_id": 1183,
            "action_name": "Pallet Lijst",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @company_id nvarchar(32),@button nvarchar(128),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000), @location_id nvarchar(32), @reducer nvarchar(max), @date nvarchar(128), @Transportinfo nvarchar(32)\r\n,@button1 nvarchar(128) = N'Nieuwe inkomend transport'\r\nset @date = dbo.workDate()\r\nEXEC sp_api_modal_select @card_name = N'transporteur',@value = @company_id OUT,@focus = 1\r\nSET @reducer = CONCAT('company_id = ',@company_id)\r\n\r\nIF @company_id > 0\r\nBEGIN\r\n\t--DECLARE @only_new_is_possible BIT = 0\r\n\t--EXEC sp_api_modal_select @card_name = N'xlocation',@reducer = @reducer,@value = @location_id OUT,@class='mt-3',@focus = 1\r\n\t--IF @location_id > 0\r\n\tEXEC sp_api_modal_input @name = 'Transportinfo',@value = @Transportinfo OUT, @class = 'mt-3',@focus = 1\r\n\tEXEC sp_api_modal_text 'Kies een optie:','text-primary font-weight-bold display-4 text-center'\r\n\tEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Insert'\r\n/*\t\t\r\nELSE\r\n\t\tIF (select COUNT(id) from xlocation where company_id = @company_id ) = 1 \r\n\t\t\tBEGIN\r\n\t\t\t\tSET @only_new_is_possible = 1\r\n\t\t\tEND\r\n*/\r\n\tIF @button = @button1 --OR @only_new_is_possible = 1\r\n\t\tBEGIN\r\n\t\tDELETE FROM api_storage WHERE card_id = (SELECT id FROM api_card WHERE name = N'inkomend_transport') AND child_id = 0 AND user_id = @user_id\r\n\t\tEXEC sp_api_modal_clear\r\n\t\t\tEXEC sp_api_modal_post N'inkomend_transport',N'Transporter_ID',@company_id,0\r\n\t\t\tEXEC sp_api_modal_post N'inkomend_transport',N'TransportDate',@date,0\r\n\t\t\tEXEC sp_api_modal_post N'inkomend_transport',N'Transportinfo',@Transportinfo,0\r\n\t\t\tEXEC @new_id = sp_api_modal_save N'inkomend_transport',0\r\n\t\t\tEXEC sp_api_modal_clear\r\n\t\tEND\r\nEND",
            "action_id": 1184,
            "action_name": "Quick Insert Transport",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@button1 nvarchar(128) = N'Voeg transporten toe',@STRING VARCHAR(MAX),@SEPARATOR CHAR(1)\nSET @date = dbo.workdate()\n\nEXEC sp_api_modal_date @name='Datum voor Transporten:',@value = @date OUT,@class='w-25 mt-3',@focus=1,@select=1\nEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Insert'\n\nDELETE FROM xTransport WHERE id NOT IN (SELECT isnull(Transport_ID,0) FROM xlandfreight) AND TransportDate != dbo.ABCDATE()\n\n-- simpelere manier:\nIF @button = @button1\n\tBEGIN\n\t\t\tINSERT INTO xTransport(\n\t\t\t    Transportinfo,\n\t\t\t    Transporter_ID,\n\t\t\t    TransportDate,\n\t\t\t    TransportStatus,\n\t\t\t\tTDT,\n\t\t\t\tFullTruckTariff\n\t\t\t)\n\t\t\tVALUES\n\t\t\t-- Van Geest international wagens\n\t\t\t    (\n\t\t\t        'Hier Gelost',\n\t\t\t        147036,\n\t\t\t        @date,\n\t\t\t        'Arriving',\n\t\t\t\t\t1,\n\t\t\t\t\t0\n\t\t\t    ),\n\t\t\t    (\n\t\t\t        'Loods ophalen',\n\t\t\t        147036,\n\t\t\t        @date,\n\t\t\t        'Arriving',\n\t\t\t\t\t1,\n\t\t\t\t\t0\n\t\t\t    ),\n\t\t\t    (\n\t\t\t        'retour-boeking',\n\t\t\t        147036,\n\t\t\t        @date,\n\t\t\t        'Arriving',\n\t\t\t\t\t1,\n\t\t\t\t\t0\n\t\t\t    ),\n\t\t\t\t(\n\t\t\t\t\t'VGI - Andre Barendse',\n\t\t\t\t\t147036,\n\t\t\t\t\t@date,\n\t\t\t\t\t'Arriving',\n\t\t\t\t\t1,\n\t\t\t\t\t0\n\t\t\t    ),\n\t\t\t\t(\n\t\t\t\t\t'VGI - Arjen',\n\t\t\t\t\t147036,\n\t\t\t\t\t@date,\n\t\t\t\t\t'Arriving',\n\t\t\t\t\t1,\n\t\t\t\t\t0\n\t\t\t    ),\n\t\t\t\t(\n\t\t\t\t\t'VGI - Danitsja/bus',\n\t\t\t\t\t147036,\n\t\t\t\t\t@date,\n\t\t\t\t\t'Arriving',\n\t\t\t\t\t1,\n\t\t\t\t\t0\n\t\t\t    ),\n\t\t\t\t(\n\t\t\t\t\t'VGI - Jacob',\n\t\t\t\t\t147036,\n\t\t\t\t\t@date,\n\t\t\t\t\t'Arriving',\n\t\t\t\t\t1,\n\t\t\t\t\t0\n\t\t\t    ),\n\t\t\t\t(\n\t\t\t\t\t'VGI - Jeroen/bus',\n\t\t\t\t\t147036,\n\t\t\t\t\t@date,\n\t\t\t\t\t'Arriving',\n\t\t\t\t\t1,\n\t\t\t\t\t0\n\t\t\t    ),\n\t\t\t\t(\n\t\t\t\t\t'VGI - Marcel',\n\t\t\t\t\t147036,\n\t\t\t\t\t@date,\n\t\t\t\t\t'Arriving',\n\t\t\t\t\t1,\n\t\t\t\t\t0\n\t\t\t    ),\n\t\t\t\t(\n\t\t\t\t\t'VGI - Rien/bus',\n\t\t\t\t\t147036,\n\t\t\t\t\t@date,\n\t\t\t\t\t'Arriving',\n\t\t\t\t\t1,\n\t\t\t\t\t0\n\t\t\t    ),\n\t\t\t\t(\n\t\t\t\t\t'VGI 4 - Aniel',\n\t\t\t\t\t147036,\n\t\t\t\t\t@date,\n\t\t\t\t\t'Arriving',\n\t\t\t\t\t1,\n\t\t\t\t\t0\n\t\t\t    ),\n\t\t\t\t(\n\t\t\t\t\t'VGI - Aniel',\n\t\t\t\t\t147036,\n\t\t\t\t\t@date,\n\t\t\t\t\t'Arriving',\n\t\t\t\t\t1,\n\t\t\t\t\t0\n\t\t\t    ),\n\t\t\t-- Overige wagens\n\t\t\t\t(\n\t\t\t\t\t'Gaalen - Aad',\n\t\t\t\t\t156886,\n\t\t\t\t\t@date,\n\t\t\t\t\t'Arriving',\n\t\t\t\t\t1,\n\t\t\t\t\t0\n\t\t\t    ),\n\t\t\t\t(\n\t\t\t\t\t'Gaalen - Rene',\n\t\t\t\t\t156886,\n\t\t\t\t\t@date,\n\t\t\t\t\t'Arriving',\n\t\t\t\t\t1,\n\t\t\t\t\t0\n\t\t\t    ),\n\t\t\t\t(\n\t\t\t\t\t'SVB',\n\t\t\t\t\t157453,\n\t\t\t\t\t@date,\n\t\t\t\t\t'Arriving',\n\t\t\t\t\t1,\n\t\t\t\t\t0\n\t\t\t    ),\n\t\t\t\t(\n\t\t\t\t\t'VSDV',\n\t\t\t\t\t160898,\n\t\t\t\t\t@date,\n\t\t\t\t\t'Arriving',\n\t\t\t\t\t1,\n\t\t\t\t\t0\n\t\t\t    ),\n        \t\t(\n\t\t\t\t\t'Van Ooijen Transport',\n\t\t\t\t\t157391,\n\t\t\t\t\t@date,\n\t\t\t\t\t'Arriving',\n\t\t\t\t\t1,\n\t\t\t\t\t0\n\t\t\t    ),\n    \t\t\t(\n\t\t\t\t\t'Iterson Transport',\n\t\t\t\t\t156948,\n\t\t\t\t\t@date,\n\t\t\t\t\t'Arriving',\n\t\t\t\t\t1,\n\t\t\t\t\t0\n\t\t\t    ),\n    \t\t\t(\n\t\t\t\t\t'Vervoorn Transport',\n\t\t\t\t\t157094,\n\t\t\t\t\t@date,\n\t\t\t\t\t'Arriving',\n\t\t\t\t\t1,\n\t\t\t\t\t0\n\t\t\t    ); \n\t\t    EXEC sp_api_modal_clear\n\t\tEND",
            "action_id": 1185,
            "action_name": "StandaardAuto",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "update xtransport set TransportStatus ='Arriving' where id IN(select * FROM string_split(@IDS,','))\nupdate xlandfreight set [Status] ='Arriving' where Transport_ID IN(select * FROM string_split(@IDS,','))\nEXEC sp_api_toast N'Transport is terug gezet naar Arriving'",
            "action_id": 1186,
            "action_name": "Terug naar Arriving",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 1188,
            "action_name": "Verwijder Transport",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "update xtransport set TransportStatus ='Arrived' where id IN(select * FROM string_split(@IDS,','))\nupdate xlandfreight set [Status] ='Arrived' where Transport_ID IN(select * FROM string_split(@IDS,','))\nEXEC sp_api_toast N'Transport/Pallets zijn binnen'",
            "action_id": 1190,
            "action_name": "Arrived",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "update xlandfreight SET transport_ID={[transport].id} WHERE xlandfreight.Transport_ID is null AND (xlandfreight.Transportcompany_ID={[transport].transporter_ID} OR xlandfreight.Transportcompany_ID is null)",
            "action_id": 1191,
            "action_name": "Auto Add Landfreight",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "update xlandfreight set status ='Arrived' where id IN(select * FROM string_split(@IDS,','))\r\nEXEC sp_api_toast N'Pallets binnengekomen'",
            "action_id": 1192,
            "action_name": "Arrived",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.ExtraVracht @ID",
            "action_id": 1193,
            "action_name": "Extra Vracht Maken",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.[LF_Voltooien] @ID",
            "action_id": 1197,
            "action_name": "Landfreight Voltooien",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast N'Loslijst afdrukken' \r\n\r\nDECLARE @cursor_ids CURSOR,@cid INT\r\nDECLARE @toCompany_ID INT \r\nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\r\n\t\t\r\n\r\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\r\nOPEN @cursor_ids;\r\nFETCH NEXT FROM @cursor_ids INTO @cid\r\nWHILE @@FETCH_STATUS = 0\r\n\tBEGIN\r\n\t\tEXEC sp_api_toast @cid\r\n\t\t--dit is nu alleen voor tellers en checks:\r\n\r\n\t\t--even niet registreren dat er wordt afgedrukt\r\n\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'LF'\t,@Context_Key_ID=@cid,@Report_CODE=N'unloading'\r\n\r\n\t\t--dit is de feitelijke \"run\"\r\n\t\tSET @toCompany_ID = (select top 1 id from xTenantKey) -- een CRM wordt naar tenant gestuurd/geprint\r\n\t\t--DECLARE @error INT\r\n\t\tEXEC sp_api_report_generate @id = @cid\r\n\t\t\t,@sys_report_key = 'unloading' --zie xrepdef\r\n\t\t\t,@toCompany_ID = @toCompany_ID\r\n\t\t\t,@fromCompany_ID = @fromCompany_ID\r\n\r\n\t\t--IF @error > 0 RAISERROR(N'Er is een probleem')\r\n\r\n\r\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\r\n\tEND\r\nCLOSE @cursor_ids;\r\nDEALLOCATE @cursor_ids;",
            "action_id": 1198,
            "action_name": "Loslijst",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--update xlandfreight SET transport_id = NULL WHERE id ={[inkomende_pallets].id}\r\n--DECLARE @zetnull = NULL\r\nDECLARE @cursor CURSOR,@idval INT\r\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\r\nOPEN @cursor;\r\nFETCH NEXT FROM @cursor INTO @idval\r\nWHILE @@FETCH_STATUS = 0\r\n\tBEGIN\r\n\t\tEXEC sp_api_modal_post N'inkomende_pallets',N'Transport_ID',NULL,@idval\r\n\t\tEXEC sp_api_modal_save N'inkomende_pallets',@idval\r\n\r\n\t\tFETCH NEXT FROM @cursor INTO @idval\r\n\tEND\r\nCLOSE @cursor;\r\nDEALLOCATE @cursor;",
            "action_id": 1199,
            "action_name": "Maak Los Van Transport",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_text 'Geselecteerde regels:','text-primary font-weight-bold display-4 text-center pb-3'\r\n/*\r\nDECLARE @reducer nvarchar(max) = N'id IN('+@ids+')'\r\nEXEC sp_api_modal_table @card_id,@reducer\r\n\r\nSELECT id,[TotPal@]=lft_PalCalc,[Blok@]=Blok,[Euro@]=Euro INTO #Q_xLandfreight FROM Q_xLandfreight WHERE id IN(SELECT * FROM string_split(@ids,','))\r\nEXEC sp_api_modal_table @tmptable=N'#Q_xLandfreight'\r\n*/\r\nSELECT [TotPal]=SUM(lft_PalCalc),[Blok]=SUM(Blok),[Euro]=SUM(Euro) INTO #Q_xLandfreightSum FROM Q_xLandfreight WHERE id IN(SELECT * FROM string_split(@ids,','))\r\nEXEC sp_api_modal_table @tmptable=N'#Q_xLandfreightSum'\r\n\r\n",
            "action_id": 1201,
            "action_name": "Optellen",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXECUTE @main_db.dbo.RebuildLandfreight @ID ",
            "action_id": 1203,
            "action_name": "RebuildLandfreight",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @button nvarchar(128)\nSET @button = ''\n\nIF (select count(id) from Q_xTransactionDetail where [delayed] = 1 AND transactionheader_id in (SELECT TransactionHeader_ID from xLandfreight where id IN ({@ids}))) > 0\n\tBEGIN\n\t\tSET @reserved = 0\n\t\tEXEC sp_api_modal_text 'Alle regels staan niet meer op gereserveerd.', 'text-primary font-weight-bold text-center display-4'\n\tEND\nELSE IF (select count(id) from Q_xTransactionDetail where [delayed] = 0 AND transactionheader_id in (SELECT TransactionHeader_ID from xLandfreight where id IN ({@ids}))) > 0\n\tBEGIN\n\t\tEXEC sp_api_modal_text 'Alle regels staan nog niet op gereserveerd, weet u zeker dat alle regels naar gereserveerd moeten?', 'text-primary font-weight-bold text-center h3'\n\t\tEXEC sp_api_modal_button @name='button',@value = 'NaarReserved',@valueout = @button OUT,@class = 'btn-primary',@key = '1'\n\t\tIF @button = 'NaarReserved'\n\t\tBEGIN\n\t\t\tSET @reserved = 1\n\t\t\tEXEC sp_api_modal_clear\n\t\t\tEXEC sp_api_modal_text 'Alle regels staan op gereserveerd.', 'text-primary font-weight-bold text-center display-4'\n\t\tEND\n\tEND\nIF @reserved IS NOT NULL\n\tBEGIN\n\t\tDECLARE @cursor CURSOR,@idval INT\n\t\tSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT id FROM q_xtransactiondetail\n\t\twhere transactionheader_id in (SELECT TransactionHeader_ID from xLandfreight where id IN ({@ids}))\n\t\tOPEN @cursor;\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\n\t\t\t\tUPDATE Q_xTransactionDetail SET [delayed] = @reserved WHERE id = @idval\n\t\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\tEND\n\t\tCLOSE @cursor;\n\t\tDEALLOCATE @cursor;\n\t\tEXEC sp_api_modal_clear\n\tEND",
            "action_id": 1204,
            "action_name": "Reserved On/Off",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @inkomendtransport nvarchar(32), @reducer nvarchar(max), @Transportinfo nvarchar(32), @date nvarchar(128), @button nvarchar(128),@Transporter_ID nvarchar(128),\n@button1 nvarchar(128) = N'Set Transport'\nset @date = dbo.workDate()\n--SET @reducer = concat('TransportStatus = ',N'Arriving')\nSET @reducer = N'TransportDate = dbo.workDate()'\nEXEC sp_api_modal_select @card_name = N'inkomend_transport',@value = @inkomendtransport OUT,@focus = 1,@reducer = @reducer\nSET @Transporter_ID = (select Transporter_ID from xtransport where id = @inkomendtransport)\n\nIF @inkomendtransport > 0\n\t\tBEGIN\n\t\t\tDECLARE @cursor CURSOR,@idval INT\n\t\t\tSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\n\t\t\tOPEN @cursor;\n\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\tWHILE @@FETCH_STATUS = 0\n\t\t\t\tBEGIN\n\t\t\t\t\tEXEC sp_api_modal_post N'inkomende_pallets',N'TransportCompany_ID',@Transporter_ID,@idval\n\t\t\t\t\tEXEC sp_api_modal_post N'inkomende_pallets',N'Transport_ID',@inkomendtransport,@idval\n\t\t\t\t\tEXEC sp_api_modal_save N'inkomende_pallets',@idval\n\n\t\t\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\t\tEND\n\t\t\tCLOSE @cursor;\n\t\t\tDEALLOCATE @cursor;\n\n\t\t\tEXEC sp_api_modal_clear\n\t\t\tEXEC sp_api_modal_select_all_clear\nEND",
            "action_id": 1205,
            "action_name": "Select Transport",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "update xlandfreight set status ='Arriving' where id IN(select * FROM string_split(@IDS,','))\r\nEXEC sp_api_toast N'Terug naar Arriving'",
            "action_id": 1206,
            "action_name": "Terug naar Arriving",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @company_id nvarchar(32), @button nvarchar(128)\r\n,@button1 nvarchar(128) = N'Lijst + Locatie'\r\n,@button2 nvarchar(128) = N'Enkel de Sum'\r\n\r\nEXEC sp_api_modal_select @card_name = N'transporteur',@value = @company_id OUT,@focus = 1\r\n\r\nIF @company_id > 0\r\n\tBEGIN\r\nEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='1'\r\nEXEC sp_api_modal_button @name='button',@value=@button2,@valueout = @button OUT,@key='2'\r\nIF @button = @button1 \r\n\t\tBEGIN\r\n\t\tSELECT [Location*]=(select LocationCode from xlocation where id = To_Location_ID),[TotPal@]=SUM(lft_PalCalc),[Blok@]=SUM(Blok),[Euro@]=SUM(Euro) INTO #Q_xLandfreight FROM Q_xLandfreight \r\n\t\tWHERE Q_xLandfreight.TransportCompany_ID = @company_id AND Transport_ID is NULL AND TDT = 1 AND doTransport != 0\r\n\t\tGROUP BY To_Location_ID, lft_PalCalc, Blok, Euro\r\n\t\tEXEC sp_api_modal_table @tmptable=N'#Q_xLandfreight'\r\n\t\tEND\r\nIF @button = @button2\r\n\t\tBEGIN\r\n\t\tSELECT [TotPal]=SUM(lft_PalCalc),[Blok]=SUM(Blok),[Euro]=SUM(Euro) INTO #Q_xLandfreightSum FROM Q_xLandfreight \r\n\t\tWHERE Q_xLandfreight.TransportCompany_ID = @company_id AND Transport_ID is NULL AND TDT = 1 AND doTransport != 0\r\n\t\tEXEC sp_api_modal_table @tmptable=N'#Q_xLandfreightSum'\r\n\t\tEND\r\n/*\r\n\t\tDECLARE @reducer nvarchar(max) = N'TransportCompany_ID = ('+@company_id+')'\r\n\t\tEXEC sp_api_modal_table @card_id,@reducer\r\n*/\r\n\r\n\r\n/*\r\n\t\tSELECT [TotPal]=SUM(lft_PalCalc),[Blok]=SUM(Blok),[Euro]=SUM(Euro) INTO #Q_xLandfreightSum FROM Q_xLandfreight \r\n\t\tWHERE Q_xLandfreight.TransportCompany_ID = @company_id AND Transport_ID is NULL AND TDT = 2\r\n\t\tEXEC sp_api_modal_table @tmptable=N'#Q_xLandfreightSum'\r\n*/\r\n\tEND",
            "action_id": 1207,
            "action_name": "Transp Pal Sum",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 1208,
            "action_name": "Verwijder Pallet",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "-----------------------------------------------\n-- action \u00cfnsert Order (PURCHASE)\n--\tpre declare: @button\n--\n--\n--\t211209\tstatus controle aangepast naar left(4) ivm commissie en koop partijen\n-----------------------------------------------\nDECLARE @company_id nvarchar(32),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000), @Fromlocation_id nvarchar(32),@Tolocation_id nvarchar(32), @reducer nvarchar(max)\n, @date nvarchar(128), @opmerking nvarchar(128), @Certificate nvarchar(128), @Certificate_enddate nvarchar(128), @text nvarchar(200)\n,@button1 nvarchar(128) = N'Nieuwe inkoop'\n,@button2 nvarchar(128) = N'Laatste open inkoop'\n,@button3 nvarchar(128) = N'Gereserveerde inkoop'\n,@buttonescape nvarchar(128) = N'Ga terug'\n,@buttongoahead nvarchar(128) = N'Ga door'\nset @date = dbo.workDate()\n\nIF dbo.workDate() <> dbo.abcdate() AND @button IS NULL\n\tBEGIN\n\tEXEC sp_api_modal_text 'LET OP! DE WERKDATUM STAAT NIET OP VANDAAG.','text-danger font-weight-bold'\n\tEXEC sp_api_modal_button @name='@button',@value=@buttongoahead,@valueout = @button OUT,@key='Pagedown',@class='bg-danger text-light'\n\tEXEC sp_api_modal_button @name='@button',@value=@buttonescape,@valueout = @button OUT,@key='ESCAPE',@class='bg-danger text-light'\n\t\tIF @button = @buttonescape\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_clear\n\t\t\tRETURN;\n\t\tEND\n\tEND\n\nIF @button = @buttongoahead OR dbo.workdate() = dbo.abcdate()\n\tBEGIN\n\tEXEC sp_api_modal_clear\n\tEXEC sp_api_modal_text 'Kies een leverancier:','text-primary'\n\t--SET @reducer = CONCAT('company_id = ',@company_id)\n\tSET @reducer = 'isDisabled = 0'\n\tEXEC sp_api_modal_select @card_name = N'leverancier',@value = @company_id OUT,@reducer = @reducer,@focus=1\n\t\n\tEND\n\t\nIF @company_id > 0\nBEGIN\t\n\tSET @Certificate = (SELECT Q_Certificate from xcompany where id = @company_id)\n\tSET @Certificate_enddate = (SELECT Q_Certificate_enddate from xcompany where id = @company_id)\n\tSELECT @text = 'LET OP! Het certificaat '+ @Certificate +' van deze leverancier gaat/is vervallen op: ' + (SELECT date = FORMAT(Q_Certificate_enddate,'dd-MM-yyyy') from xcompany where id = @company_id) + '!'\n\t\n\tDECLARE @reducer_location nvarchar(max) = N'Company_ID = ' + @company_id + ' OR id IN (SELECT Location_ID FROM xCompanyxLocation WHERE Company_ID =' + @company_id + ')'\n\tIF (SELECT LOCATIONS = count(Location_ID) FROM xCompanyxLocation WHERE Company_ID = @company_id) > 1\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3',@focus=1\n\t\t\tEXEC sp_api_modal_input @name='Remarks',@value = @opmerking OUT\n\t\t\tEXEC sp_api_modal_text 'Kies een sublocatie van leverancier:','text-primary'\n\t\t\tEXEC sp_api_modal_select @card_name = N'xlocation',@value = @Fromlocation_id OUT,@reducer = @reducer_location\n\t\tEND\n\tIF (SELECT LOCATIONS = count(Location_ID) FROM xCompanyxLocation WHERE Company_ID = @company_id) = 1\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3',@focus=1\n\t\t\tEXEC sp_api_modal_input @name='Remarks',@value = @opmerking OUT\n\t\tEND\n\n\tDECLARE @reducer_TenantLocation nvarchar(max) = N'company_id IN (select id from xtenantkey) \nOR id IN (SELECT Location_ID FROM Q_xCompanyxLocation WHERE Company_ID IN (select id from xtenantkey))'\n\t\t\tEXEC sp_api_modal_text 'Kies een eigen Locatie:','text-primary'\n\t\t\tEXEC sp_api_modal_select @card_name = N'xlocation',@value = @Tolocation_id OUT,@reducer = @reducer_TenantLocation\n\t\t\n\tIF (select count(id) from q_xtransactionheader where TDT = 1 and Repack_ID is null and specialtype is null and CounterParty_ID = @company_id) <= 5 AND (@Certificate is null or @Certificate_enddate is null)\n\t\tBEGIN\n\t\tEXEC sp_api_modal_text 'De gekozen leverancier is nieuw in het systeem','text-danger font-weight-bold display-5 text-center'\n\t\tEXEC sp_api_modal_text 'Vraag of ze begeleidende certificaten mee willen sturen','text-danger font-weight-bold display-5 text-center'\n\t\tEND\n\t\t\n\tIF @Certificate_enddate < (dbo.abcdate() + 8)\n\t\tBEGIN\n\t\tEXEC sp_api_modal_text @text,'text-danger font-weight-bold display-5 text-center'\n\t\tEND\n\t\t\n\tEXEC sp_api_modal_text 'Kies een optie:','text-primary font-weight-bold display-4 text-center'\n\tEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Enter'\n\t\n\tIF EXISTS (SELECT * FROM xTransactionHeader WHERE left(status,4)=N'open' AND TDT=1 AND CounterParty_ID = @company_id AND Transactiondate <= @date)\n\t\tBEGIN\n\t\tEXEC sp_api_modal_button @name='button',@value=@button2,@valueout = @button OUT,@key='F1'\n\t\tEND\n/*\n\tIF EXISTS (SELECT * FROM xTransactionHeader WHERE status=N'openPurchase' AND CounterParty_ID = @company_id AND Transactiondate > @date)\n\t\tBEGIN\n\t\tEXEC sp_api_modal_button @name='button',@value=@button3,@valueout = @button OUT,@key='F2'\n\t\t\tSELECT TOP 1\n\t\t\t\ttv_companyname\n\t\t\t\t,transactiondate\n\t\t\t\t,[GERESERVEERD*] = 'GERESERVEERD'\n\t\t\t\t,id\n\t\t\t\tINTO #LASTORDER\n\t\t\tFROM q_xtransactionheader\n\t\t\tWHERE status=N'openPurchase' AND CounterParty_ID = @company_id AND Transactiondate > @date ORDER BY id DESC\n\t\t\tEXEC sp_api_modal_table @tmptable=N'#LASTORDER',@orderby=N'ORDER BY 3 ASC'\n\t\tEND\n\t\t*/\n\n\tIF @button = @button1\n\t\tBEGIN\n\t\tDELETE FROM api_storage WHERE card_id = (SELECT id FROM api_card WHERE name = N'inkoop') AND child_id = 0 AND user_id = @user_id\n\t\tEXEC sp_api_modal_clear\n\t\t\tEXEC sp_api_modal_post N'inkoop',N'CounterParty_ID',@company_id,0\n\t\t\tEXEC sp_api_modal_post N'inkoop',N'Source_ID',@Fromlocation_id,0\n\t\t\tEXEC sp_api_modal_post N'inkoop',N'Destination_ID',@Tolocation_id,0\n\t\t\tEXEC sp_api_modal_post N'inkoop',N'TransactionDate',@date,0\n\t\t\tEXEC sp_api_modal_post N'inkoop',N'advTransportDep',@date,0\n\t\t\tEXEC sp_api_modal_post N'inkoop',N'unloadingdate',@date,0\n\t\t\tEXEC sp_api_modal_post N'inkoop',N'loadingdate',@date,0\n\t\t\tEXEC sp_api_modal_post N'inkoop',N'Remarks',@opmerking,0\n\t\t\tEXEC @new_id = sp_api_modal_save N'inkoop',0\n\t\t\tIF @new_id > 0\n\t\t\t\tBEGIN\n\t\t\t\t\tSET @goto = N'/inkoop/'+@new_id+'/ctr1/0/stock_ctr1'\n\t\t\t\t\tEXEC sp_api_toast N'Nieuwe inkoop gestart',N'alert-primary'\n\t\t\t\t\tSET @search = N'?id='+@new_id\n\t\t\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/inkoop',@referer_search=@search\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tEXEC sp_api_toast N'Error nieuwe inkoop',N'alert-danger'\n\t\t\tEXEC sp_api_modal_clear\n\t\tEND\n\tIF @button = @button2\n\t\tBEGIN\n\t\t\tSET @new_id = (SELECT TOP 1 id FROM xTransactionHeader where left(status,4)=N'open' AND TDT=1 AND CounterParty_ID = @company_id AND Transactiondate <= @date ORDER BY id DESC)\n\t\t\tSET @goto = N'/inkoop/'+@new_id+'/ctr1/0/stock_ctr1'\n\t\t\tSET @search = N'?id='+@new_id\n\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/inkoop',@referer_search=@search\n\t\tEND\n\tIF @button = @button3\n\t\tBEGIN\n\t\t\tSET @new_id = (SELECT TOP 1 id FROM xTransactionHeader WHERE left(status,4)=N'open' AND TDT=1 AND CounterParty_ID = @company_id AND Transactiondate > @date ORDER BY id DESC)\n\t\t\tSET @goto = N'/inkoop/'+@new_id+'/ctr1/0/stock_ctr1'\n\t\t\tSET @search = N'?id='+@new_id\n\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/inkoop',@referer_search=@search\n\t\tEND\n\tEXEC sp_api_modal_button @name='button',@value=@buttonescape,@valueout = @button OUT,@key='ESCAPE',@class='bg-danger text-light'\n\tIF @button = @buttonescape\n\tBEGIN\n\tEXEC sp_api_modal_clear\n\tRETURN;\n\tEND\nEND",
            "action_id": 1219,
            "action_name": "Insert Order",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @customchoose nvarchar(128)\nIF isnull({[inkoop].status},{[inkoop_loods].status}) NOT IN ('openPurchase','openPurchaseC')\n\tBEGIN\n\texec sp_api_modal_text 'Order status is niet meer \"openPurchase\". U kunt geen nieuwe artikelen toevoegen.', 'text-danger font-weight-bold text-center display-4'\n\tRETURN\n\tEND\nELSE\n\tDECLARE @CTHID INT = ISNULL({[inkoop].id},{[inkoop_loods].id})\n\tIF EXISTS(SELECT * FROM xcthcustomsrows WHERE CTH_ID = @CTHID)\n\tBEGIN\n\t\tEXEC sp_api_modal_text 'De huidige inkoop bevat douane regels voor transito goederen. Kies of u een Transito of Vrij regel wilt toevoegen.',@class = 'h3 text-muted'\n\t\tEXEC sp_api_modal_button @name='Vrij',@value = 'Vrij', @valueout = @customchoose OUT,@class='btn-danger',@key='1'\n\t\tEXEC sp_api_modal_button @name='Transito',@value = 'Transito', @valueout = @customchoose OUT,@class='btn-danger',@key='2'\n\tEND\nELSE\n\tBEGIN\n\t\tSET @path = CONCAT(@path,'/',@ID,'/ctr1/0/stock_ctr1')\n\t\tEXEC sp_api_goto @path\n\tEND\n\tIF @customchoose = 'Vrij'\n\t\tBEGIN\n\t\t\tSET @path = CONCAT(@path,'/',@ID,'/ctr1/0/stock_ctr1')\n\t\t\tEXEC sp_api_goto @path\n\t\tEND\n\tIF @customchoose = 'Transito'\n\t\tBEGIN\n\t\t\tDECLARE @container_id int, @customrow int\n\t\t\tSET @container_id = (SELECT top 1 id FROM xcontainer where cth_id = @CTHID)\n\t\t\tSET @customrow = (SELECT top 1 id FROM xcthcustomsrows where cth_id = @CTHID)\n\t\t\tSET @path = CONCAT(@path,'/',@ID,'/xcontainer/',@container_id,'/xcthcustomsrows/',@customrow,'/ctr1/0/stock_ctr1')\n\t\t\tEXEC sp_api_goto @path\n\t\tEND\n\n/*\nIF {[inkoop].status} NOT IN ('openPurchase','openPurchaseC')\n\tBEGIN\n\texec sp_api_modal_text 'Order status is niet meer \"openPurchase\". U kunt geen nieuwe artikelen toevoegen.', 'text-danger font-weight-bold text-center display-4'\n\tRETURN\n\tEND\nELSE\nSET @path = CONCAT(@path,'/',@ID,'/ctr1/0/stock_ctr1')\nEXEC sp_api_goto @path\n*/",
            "action_id": 1227,
            "action_name": "Regels toevoegen",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "update xfust set A025 = N'CT' where isnull(A025,N'')=N''",
            "action_id": 1235,
            "action_name": "alles CT",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "/* -- CVG Uitgezet op verzoek Klant\nif {[xcontainer].id} >0\n\tbegin\n\t\texec sp_api_modal_alert N'Gebruik ''INS'' en ''F2'' bij container import'\n\t\texec sp_api_modal_clear;\n\t\treturn;\t\n\tend\n*/\nIF (SELECT SUM(LFCTR_Amount) FROM XLFCTR WHERE CTR_ID = @id AND isChecked = 1) >= (SELECT SUM(AMOUNT) FROM xtransactiondetail where id = @id)\n\tBEGIN\n\t\tEXEC sp_api_modal_alert N'Aantal is reeds gelost. U kan het aantal niet meer wijzigen'\n\t\tEXEC sp_api_modal_clear\n\t\tRETURN\n\tEND\n\nDECLARE @Currentstock nvarchar(128),@mes nvarchar(200)\nDECLARE @toewijzing int ,@TOE nvarchar(200)\nSET @Currentstock = {[ctr1].Stock_ID.Stock}\nSET @mes=concat('Vul aantal in. Huidige voorraad van artikel is: ',@Currentstock)\n\nIF {[ctr1].cth_fase} in (N'openPurchase',N'openPurchaseC')\nbegin\n\tEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\n\t--EXEC sp_api_modal_text N'Vul aantal in',N'h4 text-muted'\n\tSET @aantal = {[ctr1].amount}\n\tSET @orgaantal=@aantal -- spaart een onnodige UPDATE uit bij gelijk aantal\n\tSET @toewijzing=isnull({[ctr1].ivtotal},0)\n\t\n\tEXEC sp_api_modal_input @name='@aantal',@max=5, @value= @aantal OUT,@focus=1\n\tEXEC sp_api_modal_button @name='@button',@value = 'Opslaan', @valueout = @button OUT,@class='btn-primary',@key='Enter'\n\tIF @button IS NOT NULL\n\t\tBEGIN\n\t\t\tIF TRY_CAST(@aantal AS int) IS NOT NULL \n\t\t\t\tIF @aantal < @toewijzing  --RH210322\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tEXEC sp_api_modal_Alert N'Toewijzing is hoger, pas eerst de toewijzing aan!' -- eventueel hier gelijk een button om de IV aan te passen\n\t\t\t\t\t\tEXEC sp_api_modal_clear\n\t\t\t\t\tEND\n\t\t\t\tELSE\n\n\t\t\t\tBEGIN\n\t\t\t\t\tIF @aantal<>@orgAantal\n\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\tEXEC sp_api_modal_post N'ctr1',N'amount',@aantal,@id\n\t\t\t\t\t\t\tEXEC sp_api_modal_save N'ctr1',@id\n\t\t\t\t\t\tEND\n\t\t\t\t\t\t\tEXEC sp_api_modal_clear\n\t\t\t\t\t\t\t\n\t\t\t\tEND\n\t\tEND\nend\nelse\nexecute sp_api_toast N'RH210117: Direct aantal alleen bij open inkoop'\t\t",
            "action_id": 1243,
            "action_name": "SelectAmount",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "SET @route = {[api_errors].route}\nEXEC sp_api_modal_url @route",
            "action_id": 1251,
            "action_name": "Open route",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @test int = 1 -- 0=LIVE; 1=TEST\n\nIF @id <> @ids EXEC sp_api_modal_alert N'Waarschuwing',N'De selectie wordt naar jezelf verstuurd.'\n\nDECLARE @cursor CURSOR\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @id\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\n\t\tDECLARE @toCompany_ID INT = NULL\n\t\tDECLARE @fromCompany_ID INT = NULL\n\t\tDECLARE @StateOK bit\n\t\tDECLARE @description nvarchar(max)\n\t\tDECLARE @sys_report_key nvarchar(128)\n\t\tSELECT @toCompany_ID = toCompany_ID, @fromCompany_ID = fromCompany_ID\n\t\t\t\t,@description = CONCAT('Email invoice to myself: ',(SELECT companyname FROM xcompany WHERE id = toCompany_ID))\n\t\t\t\t,@sys_report_key = IIF(LEFT(interval_key,1) = 'C','claiminvoice_out','invoice_out')\n\t\t\t FROM [xInvoice] WHERE [id] = @id\n\t\tDECLARE @sqltask nvarchar(max) = CONCAT('EXEC sp_api_report_generate @id = ',@id,',@sys_report_key = ''',@sys_report_key,''',@toCompany_ID = ',@toCompany_ID\n\t\t\t,',@fromCompany_ID = ',@fromCompany_ID,',@test=0 ,@fixedEmail=',dbo.escape_string(@user_name) )\n\t\tIF @id <> @ids\n\t\t\tEXEC sp_api_add_sql_task @sql=@sqltask,@description=@description --N'Verstuur facturen'\n\t\tELSE\n\t\t\tEXEC(@sqltask)\n--UIT LATEN !! DIT IS DE PREVIEW NAAR JEZELF DUS WIL JE GEEN FASE VERSCHUIVING\n--\t\texec @main_db.dbo.Fase_Guard @ID=@ID,@Fase=N'sent' ,@StateOK = @StateOK OUT,@Context =N'INV' --210113 DEZE METHODE GEBRUIKEN VOOR ALLE FASE WIJZIGINGEN IN AGFX !\n--\t\tif @StateOK=0 exec sp_api_toast N'LET OP: DE FASE ''sent'' is (nog) niet toegestaan in xFASE...'\n\n\t\tFETCH NEXT FROM @cursor INTO @id\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\nEXEC sp_api_modal_clear",
            "action_id": 1270,
            "action_name": "Mail Credit naar jezelf",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @test int = 1 -- 0=LIVE; 1=TEST\n\nIF @id <> @ids EXEC sp_api_modal_alert N'Waarschuwing',N'De selectie wordt naar jezelf verstuurd.'\n\nDECLARE @cursor CURSOR\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @id\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\n\t\tDECLARE @toCompany_ID INT = NULL\n\t\tDECLARE @fromCompany_ID INT = NULL\n\t\tDECLARE @StateOK bit\n\t\tDECLARE @description nvarchar(max)\n\t\tSELECT @toCompany_ID = toCompany_ID, @fromCompany_ID = fromCompany_ID\n\t\t\t\t,@description = CONCAT('Email invoice to myself: ',(SELECT companyname FROM xcompany WHERE id = toCompany_ID))\n\t\t\t FROM [xInvoice] WHERE [id] = @id\n\t\tDECLARE @sqltask nvarchar(max) = CONCAT('EXEC sp_api_report_generate @id = ',@id,',@sys_report_key = ''invoice_out'',@toCompany_ID = ',@toCompany_ID\n\t\t\t,',@fromCompany_ID = ',@fromCompany_ID,',@test=0 ,@fixedEmail=',dbo.escape_string(@user_name) )\n\t\tIF @id <> @ids\n\t\t\tEXEC sp_api_add_sql_task @sql=@sqltask,@description=@description --N'Verstuur facturen'\n\t\tELSE\n\t\t\tEXEC(@sqltask)\n--UIT LATEN !! DIT IS DE PREVIEW NAAR JEZELF DUS WIL JE GEEN FASE VERSCHUIVING\n--\t\texec @main_db.dbo.Fase_Guard @ID=@ID,@Fase=N'sent' ,@StateOK = @StateOK OUT,@Context =N'INV' --210113 DEZE METHODE GEBRUIKEN VOOR ALLE FASE WIJZIGINGEN IN AGFX !\n--\t\tif @StateOK=0 exec sp_api_toast N'LET OP: DE FASE ''sent'' is (nog) niet toegestaan in xFASE...'\n\n\t\tFETCH NEXT FROM @cursor INTO @id\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\nEXEC sp_api_modal_clear",
            "action_id": 1271,
            "action_name": "Mail naar jezelf",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "declare @sys_report_key nvarchar(50) = N'confirmation_out'\ndeclare @test bit =1 -- 0:LIVE ; 1=TEST\nEXEC sp_api_toast @sys_report_key--N'Orderbevestiging' \n\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\t--EXEC sp_api_toast @cid\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select Counterparty_id from xtransactionheader where id=@cid)\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = @sys_report_key--'confirmation_out' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@fixedFrom = @user\n\t\t\t,@test=@test\n\n\t\t--dit is nu alleen voor tellers en checks:\n\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'CTH'\t,@Context_Key_ID=@cid,@Report_CODE=N'CONF'\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;\nEXEC sp_api_modal_clear\nEXEC sp_api_modal_select_all_clear",
            "action_id": 1272,
            "action_name": "Inbox Orderbevestiging",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 1273,
            "action_name": "men_sales_closed",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "Declare @infotext nvarchar(512) = concat('Financiele mutaties op basis van deze order(',@ID,')')\nEXEC sp_api_modal_text @text=@infotext,@class = 'h3 text-muted'\n\nEXEC sp_api_modal_print\nSELECT * INTO #tt_verkoop from @main_db.dbo.Calc_Finrows_Summed_CTH_IV where cth_id=@ID and ([ExBedrag@:2] <>0 or Fin_Group=N'BASIS')\nEXEC sp_api_modal_table @tmptable=N'#tt_verkoop',@print=1\n\n\n----RH210222 eventueel de extra regels tonen:\nif exists(select * from xinvrow where cth_id=@ID and invoice_id is null) exec sp_api_modal_text N'Deze order heeft tevens direcvte favctuurregels:'\n\nSELECT groupcode,cth_id,rowprice,Amount,RowText,Price, GL_Number,Vatlevel INTO #di_cth2 from @main_db.dbo.xinvrow where cth_id=@ID AND invoice_id is null --and ([ExBedrag@:2] <>0 or Fin_Group=N'BASIS')\nEXEC sp_api_modal_table @tmptable=N'#di_cth2'\n\n",
            "action_id": 1275,
            "action_name": "Mutaties Financieel",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @VerkoopPath nvarchar(200) \r\nSET @VerkoopPath=concat(N'./verkoop',{[verkoop].id},N'/ctr2')\r\nEXEC SP_API_GOTO @VerkoopPath",
            "action_id": 1276,
            "action_name": "naar CTR",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "SELECT * INTO #globecsv FROM calc_exact_globe_csv WHERE datum IS NOT NULL AND inv_id IN (SELECT * FROM STRING_SPLIT(@ids,',')) ORDER BY factuurnum,dagboek,regel\nALTER TABLE #globecsv DROP COLUMN cth_id,inv_id\nEXEC sp_api_modal_csv @tmptable=N'#globecsv',@ansi =1,@filename=N'exact_globe.csv',@orderby=N'ORDER BY factuurnum,dagboek,regel'",
            "action_id": 1277,
            "action_name": "Naar ExactGlobe CSV",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "SELECT * INTO #globecsv FROM calc_exact_globe_csv WHERE datum IS NOT NULL ORDER BY factuurnum,dagboek,regel\nEXEC sp_api_modal_csv @tmptable=N'#globecsv',@ansi =1,@filename=N'exact_globe.csv',@orderby=N'ORDER BY factuurnum,dagboek,regel'",
            "action_id": 1278,
            "action_name": "Naar ExactGlobe CSV_voor210112",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "BEGIN TRY\n\tEXEC @main_db.dbo.sp_iu_finance_invoice @id\nEND TRY BEGIN CATCH\n\tDECLARE @text nvarchar(max) = ERROR_MESSAGE(),@ERROR_SEVERITY int = ERROR_SEVERITY()\n\tIF @ERROR_SEVERITY = 17\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_url @text\n\t\t\tRETURN\n\t\tEND\n\t--EXEC sp_api_modal_text @errornumber\n\tEXEC sp_api_modal_text @text\n\tDECLARE @valueout nvarchar(128)\n\tEXEC sp_api_modal_button @name='Retry',@value = 'Retry', @valueout = @valueout OUT\n\t\t,@class='btn-primary',@key='Enter'\nEND CATCH",
            "action_id": 1279,
            "action_name": "Naar ExactOnline",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @VerkoopPath nvarchar(200) \nSET @VerkoopPath=concat(N'/verkoop/',{[verkoop].id},N'/ctr2')\nEXEC SP_API_GOTO @VerkoopPath",
            "action_id": 1280,
            "action_name": "Naar Verkoop Regels",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @VerkoopPath nvarchar(200) \nSET @VerkoopPath=concat(N'/verkoop/',{[verkoop].id},N'/ctr2')\nEXEC SP_API_GOTO @VerkoopPath",
            "action_id": 1281,
            "action_name": "Naar Verkoop Regels",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @pathname nvarchar(2000) = CONCAT('/klant/',{[verkoop].Counterparty_ID},'/company_locations')\nEXEC sp_api_goto @pathname",
            "action_id": 1282,
            "action_name": "Naar Werklocaties",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @xml varbinary(max) = CONVERT(varbinary(max),(SELECT\n\t (SELECT\n\n\t\t----------------\n\t\t -- General --\n\t\t----------------\n\n\t\t(SELECT * FROM (SELECT\n\t\t\tCustomerID = '00454'\n\t\t\t,MessageID = id\n\t\t\t,OrderReference = concat([Orders].id ,'-', [Order].id)\n\t\t\t,StatusOrder = 'New'\n\t\t\t,Documents = (SELECT \n\t\t\t\tDocumentType = (SELECT doctype from xTransportDoc where TDocSet_ID = [Documentset].id)\n\t\t\t\t,DocumentName = ''\n\t\t\t\t,DocumentFileLocation = ''\n\t\t\t\t,DocumentNumber = Info\n\t\t\t\tFROM xTransportDocSet [Documentset] WHERE id IN (SELECT xTransportDocSet_ID FROm xTransportDocSetxLandfreight WHERE xLandfreight_ID = [Order].id)\n\t\t\t\tFOR XML AUTO, TYPE,ELEMENTS)\n\t\t\t,Remarks = ''\n\t\t\t,CustomsAgent = ''\n\t\t\t,CustomsAgentImport = ''\n\t\t\t,MRNNumber = ''\n\t\t\t,IncoTerms = 'DDP'\n\t\t\t,IncoTermsCity= (SELECT Name FROM xCity WHERE id = (SELECT City_ID FROM xLocation WHERE id = [Order].To_Location_ID))\n\t\t) General\n\t\tFOR XML AUTO, TYPE,ELEMENTS)\n\n\t\t----------------\n\t\t-- Pickupdata --\n\t\t----------------\n\n\t\t,(SELECT * FROM (SELECT\n\t\t\tPickupName = (SELECT companyname FROM xcompany WHERE id = (SELECT Company_ID FROM xLocation WHERE id = [Order].From_Location_ID))\n\t\t\t,PickupAddress = 'PickupAddress12345'--(SELECT completeAddress FROM xLocation WHERE id IN (SELECT From_Location_ID FROM xLandfreight where id = [Order].id))\n\t\t\t,PickupPostcode = '1234 AB'\n\t\t\t,PickupCity = (SELECT [Name] FROM xCity WHERE id = (SELECT City_ID FROM xLocation WHERE id = [Order].From_Location_ID))\n\t\t\t,PickupCountry = (SELECT IsoCode FROM xCountry WHERE CountryId = (SELECT Country_ID FROM xLocation WHERE id = [Order].From_Location_ID))\n\t\t\t,PickupUNLoCode = ''\n\t\t\t,PickupEORI = ''\n\t\t\t,PickupReference  = ''\n\t\t\t,PickupDate = format([Order].Pickup, 'yyyy-MM-dd')\n\t\t) PickupData\n\t\tFOR XML AUTO, TYPE,ELEMENTS)\n\n\t\t----------------\n\t   -- Deliverydata --\n\t\t----------------\n\n\t\t,(SELECT * FROM (SELECT\n\t\t\tDeliveryName = (SELECT companyname FROM xcompany WHERE id = (SELECT Counterparty_ID FROM xLocation WHERE id = [Order].To_Location_ID))\n\t\t\t,DeliveryAddress = 'DeliveryAddress12345'--(SELECT completeAddress FROM xLocation WHERE id IN (SELECT To_Location_ID FROM xLandfreight where id = [Order].id))\n\t\t\t,DeliveryPostcode = '1234 AB'\n\t\t\t,DeliveryCity = (SELECT [Name] FROM xCity WHERE id = (SELECT City_ID FROM xLocation WHERE id = [Order].To_Location_ID))\n\t\t\t,DeliveryCountry = (SELECT IsoCode FROM xCountry WHERE CountryId = (SELECT Country_ID FROM xLocation WHERE [id] = [Order].To_Location_ID))\n\t\t\t,DeliveryUNLoCode = ''\n\t\t\t,DeliveryEORI = ''\n\t\t\t,DeliveryReference = ''\n\t\t\t,DeliveryDate = format([Order].Delivery, 'yyyy-MM-dd')\n\t\t) DeliveryData\n\t\tFOR XML AUTO, TYPE,ELEMENTS)\n\n\t\t----------------\n\t    -- Orderlines --\n\t\t----------------\n\n\t\t,Orderlines = (SELECT \n\t\t\tMessageIDOrderLine = CONCAT('NR_' , [LF_Orderline].id, '_' , ROW_NUMBER() over (ORDER BY (select 1)))\n\t\t\t,Quantity = palAmount\n\t\t\t/*\n\t\t\t,Quantity = case when [LF_Orderline].Blok > 0 and [LF_Orderline].Euro = 0 then [order].Blok \n\t\t\t\t\t\t\t when [LF_Orderline].Blok = 0 and [LF_Orderline].Euro > 0 then [order].Euro\n\t\t\t\t\t\t\t when [LF_Orderline].Blok > 0 and [LF_Orderline].Euro > 0 then [order].Euro + [order].Blok\n\t\t\t\t\t\t\t when [LF_Orderline].Blok = 0 and [LF_Orderline].Euro = 0 then 0\n\t\t\t\t\t\tEND\n\t\t\t*/\n\t\t\t,PackageID = IIF(isBlok = 1,'Blok','Euro')\n\t\t\t/*\n\t\t\t,PackageID = case when [LF_Orderline].Blok > 0 and [LF_Orderline].Euro = 0 then 'Blok'\n\t\t\t\t\t\t\t  when [LF_Orderline].Blok = 0 and [LF_Orderline].Euro > 0 then 'Euro'\n\t\t\t\t\t\t\t  when [LF_Orderline].Blok > 0 and [LF_Orderline].Euro > 0 then 'Blok / Euro'\n\t\t\t\t\t\t\t  when [LF_Orderline].Blok = 0 and [LF_Orderline].Euro = 0 then 'Not specified'\n\t\t\t\t\t\t END\n\t\t\t */\n\t\t\t,PalletType = ''\n\t\t\t,StatusOrderLine = 'New'\n\n\t\t----------------\n\t    -- Goodslines --\n\t\t----------------\n\n\t\t\t,Goodslines = (SELECT \n\t\t\t\tMessageIDGoodsline = CONCAT('NR_' , [Goodsline].id, '_' , ROW_NUMBER() over (ORDER BY (select 1)))\n\t\t\t\t,GoodsDesc = [Goodsline].docDescription\n\t\t\t\t,NumberOfBoxes = [Goodsline].LFCTR_Amount\n\t\t\t\t,UNCodeBox = 'BX'\n\t\t\t\t,Temp = ''\n\t\t\t\t,GrossWeight = CONVERT(DECIMAL(10,2),(SELECT ltrKGB FROM totals_lfctr WHERE xLFCTR_id = (SELECT id FROM xLFCTR WHERE id = [Goodsline].id)))\n\t\t\t\t,NettWeight = CONVERT(DECIMAL(10,2),(SELECT ltrKGN FROM totals_lfctr WHERE xLFCTR_id = (SELECT id FROM xLFCTR where id = [Goodsline].id)))\n\t\t\t\t,GoodsCode = (SELECT [ProductGN] = convert(nvarchar(8),ProdGN) FROM xProduct WHERE id = \n\t\t\t\t(SELECT xProduct_ID FROM xStock WHERE id =\n\t\t\t\t(SELECT Stock_ID FROM xTransactionDetail where id =\n\t\t\t\t(SELECT CTR_ID FROM xLFCTR WHERE id = (SELECT id FROM xLFCTR WHERE id = [Goodsline].id)\n\t\t\t\t))))\n\t\t\t\t,CountryOfOrigin = (SELECT IsoCode from xCountry WHERE CountryId = \n\t\t\t\t(select Origin_ID FROM xStock WHERE id =\n\t\t\t\t(SELECT Stock_ID FROM xTransactionDetail WHERE id =\n\t\t\t\t(SELECT CTR_ID FROM xLFCTR WHERE id = (SELECT id FROM xLFCTR WHERE id = [Goodsline].id)\n\t\t\t\t))))\n\t\t\t\t,Value = CONVERT(DECIMAL(10,2),(SELECT ctrAmount * ctrPrice AS Totalvalue from xCTRTotals where ctr_ID =\n\t\t\t\t(SELECT CTR_ID FROM xLFCTR WHERE id = (SELECT id FROM xLFCTR WHERE id = [Goodsline].id))))\n\t\t\t\t,ValueCurrency = (SELECT codeISO FROM xCurrency WHERE id = \n\t\t\t\t(SELECT Currency_ID FROM xTransactionHeader WHERE id =\n\t\t\t\t(SELECT TransactionHeader_ID from xTransactionDetail where id =\n\t\t\t\t(SELECT CTR_ID FROM xLFCTR WHERE id = (SELECT id FROM xLFCTR WHERE id = [Goodsline].id)\n\t\t\t\t))))\n\t\t\t\t,ItemDocuments = (SELECT\n\t\t\t\t\tItemDocumentType = DocType\n\t\t\t\t\t,ItemDocumentName = concat(DocType,'/',(SELECT info from xTransportDocSet where id = TDocSet_ID),'.pdf')\n\t\t\t\t\t,ItemDocumentFileLocation = ''\n\t\t\t\t\t,ItemDocumentNumber = concat(DocType,'/',(SELECT info from xTransportDocSet where id = TDocSet_ID))\n\t\t\t\tFROM xTransportDoc [ItemDocument] WHERE TDocSet_ID IN (SELECT id FROM xTransportDocSet WHERE id IN (\n\t\t\t\t\t\tSELECT xTransportDocSet_ID FROm xTransportDocSetxLandfreight WHERE xLandfreight_ID = [LF_Orderline].id\n\t\t\t\t\t\tAND  [Goodsline].ltrStock_ID in (SELECT id from xstock where xCE_ID is not null))\n\t\t\t\t\t)\n\t\t\t\tFOR XML AUTO, TYPE,ELEMENTS)\n\t\t\tFROM xLFCTR [Goodsline] WHERE [LF_Orderline].id = [Goodsline].LF_ID AND hasEuro = 0 FOR XML AUTO, TYPE,ELEMENTS)\n\t\t\t\n\t\tFROM xLandfreight [LF_Orderline]\n\t\tCROSS APPLY(SELECT palAmount = [LF_Orderline].Blok,isBlok = 1,hasEuro = IIF([LF_Orderline].Euro>0,1,0) UNION SELECT palAmount = [LF_Orderline].Euro,isBlok = 0,hasEuro = 0) [Orderline]\n\t\tWHERE [Order].id = [LF_Orderline].id AND palAmount > 0 FOR XML AUTO, TYPE,ELEMENTS)\n\t FROM xLandfreight [Order] WHERE [Order].Transport_ID = [Orders].id FOR XML AUTO, TYPE,ELEMENTS)\nFROM xTransport [Orders] WHERE id = @id\nFOR XML AUTO,TYPE,ELEMENTS))\n\n\nDECLARE @filename nvarchar(1024) = dbo.strdate(NULL)+'_'+@id+'_'+'transport_NEW.xml'\nEXEC sp_api_modal_download @filename = @filename ,@mimetype = N'application/xml',@rawdata = @xml",
            "action_id": 1285,
            "action_name": "NEW XML export freightline",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 1289,
            "action_name": "RICK",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast N'Proforma_docset afdrukken' \r\n\r\nDECLARE @cursor_ids CURSOR,@cid INT\r\nDECLARE @toCompany_ID INT \r\nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\r\n\t\t\r\n\r\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\r\nOPEN @cursor_ids;\r\nFETCH NEXT FROM @cursor_ids INTO @cid\r\nWHILE @@FETCH_STATUS = 0\r\n\tBEGIN\r\n\t\tEXEC sp_api_toast @cid\r\n\t\t--dit is nu alleen voor tellers en checks:\r\n\r\n\t\t--even niet registreren dat er wordt afgedrukt\r\n\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'DS'\t,@Context_Key_ID=@cid,@Report_CODE=N'Proforma_docset'\r\n\r\n\t\t--dit is de feitelijke \"run\"\r\n\t\tSET @toCompany_ID = (select top 1 id from xTenantKey) -- een CRM wordt naar tenant gestuurd/geprint\r\n\t\t--DECLARE @error INT\r\n\t\tEXEC sp_api_report_generate @id = @cid\r\n\t\t\t,@sys_report_key = 'Proforma_docset' --zie xrepdef\r\n\t\t\t,@toCompany_ID = @toCompany_ID\r\n\t\t\t,@fromCompany_ID = @fromCompany_ID\r\n\r\n\t\t--IF @error > 0 RAISERROR(N'Er is een probleem')\r\n\r\n\r\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\r\n\tEND\r\nCLOSE @cursor_ids;\r\nDEALLOCATE @cursor_ids;",
            "action_id": 1290,
            "action_name": "Samengevoegd Handelsfactuur",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "Declare @infotext nvarchar(512) = concat('Samenvatting voor factuur: ',{[invoice].InvoiceNumber_F})\nEXEC sp_api_modal_text @text=@infotext,@class = 'h3 text-muted'\n\nEXEC sp_api_modal_print\nSELECT * INTO #ColliVerkocht from @main_db.dbo._FinRows(@ID,1,1,1)\nEXEC sp_api_modal_table @tmptable=N'#ColliVerkocht',@print=1\n",
            "action_id": 1291,
            "action_name": "Samenvatting",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @location_id INT,@company_id nvarchar(32)\r\nEXEC sp_api_modal_text N'Kies wat...'\r\nEXEC sp_api_modal_select @card_name = N'klant',@value = @company_id OUT,@focus=1\r\nIF @company_id IS NOT NULL\r\n\tBEGIN\r\n\t/*\r\n\t\tSELECT id = xLocation.id, name=LocationCode\r\n\t\t\tINTO #locations\r\n\t\t\tFROM xLocation WHERE Company_ID = @company_id OR id IN (SELECT Location_ID FROM xCompanyxLocation WHERE Company_ID = @company_id)\r\n\t\t--EXEC sp_api_modal_select_table @tmptable = N'#locations',@value = @location_id OUT,@focus=1\r\n\t*/\r\n\t\tDECLARE @reducer nvarchar(max) = N'Company_ID = ' + @company_id + ' OR id IN (SELECT Location_ID FROM xCompanyxLocation WHERE Company_ID =' + @company_id + ')'\r\n\t\tEXEC sp_api_modal_select @card_name = N'xlocation',@value = @location_id OUT,@focus=1,@reducer = @reducer\r\n\t\tIF @location_id > 0\r\n\t\t\tBEGIN\r\n\t\t\t\tEXEC sp_api_modal_text N'@company_id'\r\n\t\t\t\tEXEC sp_api_modal_text @company_id\r\n\t\t\t\tEXEC sp_api_modal_text N'@location_id'\r\n\t\t\t\tEXEC sp_api_modal_text @location_id\r\n\t\t\tEND\r\n\tEND\r\n",
            "action_id": 1292,
            "action_name": "Select company location",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @LinkAantal INT = {[ivhistory].LinkAantal}\r\nDECLARE @LinkPrice INT = {[ivhistory].iCTR_Price}\r\n--SET @LinkAantal = (SELECT [code_IVlinked_ctrFromTo].[LinkAantal] FROM [code_IVlinked_ctrFromTo] WHERE [id] = (SELECT id FROM #parents WHERE card_name = N'ivhistory'))\r\nDECLARE @ReturnAmount nvarchar(max) = @LinkAantal\r\nDECLARE @ReturnPrice nvarchar(max) = @LinkPrice,@valueout nvarchar(max) \r\nDECLARE @new_id INT\r\nEXEC sp_api_modal_text N'Kies het aantal dat gecrediteerd moet worden'\r\nEXEC sp_api_modal_input @name='Retour colli',@max=6, @value= @ReturnAmount OUT,@focus=1\r\nEXEC sp_api_modal_text N'Prijs'\r\nEXEC sp_api_modal_input @name='Retour prijs',@max=6, @value= @ReturnPrice OUT\r\n\r\nEXEC sp_api_modal_button @name='ZVoorraad',@value = 'Zonder voorraad mutatie', @valueout = @valueout OUT ,@class='btn-primary',@key='Enter'\r\nIF @valueout = 'Zonder voorraad mutatie' AND TRY_CAST(@ReturnAmount as int) BETWEEN 1 AND @LinkAantal\r\n\tBEGIN\r\n\t\tEXEC sp_api_toast @ReturnAmount\r\n\t\texec @new_id = @main_db.dbo.sp_create_return_sale @id,@ReturnAmount\r\n\t\tUPDATE xTransactionDetail SET delayed = 1 WHERE id = @new_id\r\n\t\tEXEC sp_api_modal_clear\r\n\tEND\r\n\r\nEXEC sp_api_modal_button @name='MVoorraad',@value = 'Met voorraad mutatie', @valueout = @valueout OUT ,@class='btn-primary',@key='+'\r\nIF @valueout = 'Met voorraad mutatie' AND TRY_CAST(@ReturnAmount as int) BETWEEN 1 AND @LinkAantal\r\n\tBEGIN\r\n\t\tEXEC sp_api_toast @ReturnAmount\r\n\t\texec @new_id = @main_db.dbo.sp_create_return_sale @id,@ReturnAmount\r\n\t\tEXEC sp_api_modal_clear\r\n\tEND",
            "action_id": 1293,
            "action_name": "SelectAmount",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--EXEC sp_api_toast @parent_parent_id\n--exec sp_api_toast @User\nIF @id is NULL\n\tBEGIN\n\t\tEXEC sp_api_modal_clear N'Geen artikel gekozen'\n\t\t--EXEC sp_api_modal_clear\n\t\tRETURN\n\tEND\nDECLARE @CTHID INT = {[verkoop].id} --200818 curly\nIF @CTHID IS NULL begin\n\t\tEXEC sp_api_toast 'Kan geen [verkoop] vinden'\n\t\tRETURN;\n\t\tend\n--ELSE EXEC sp_api_toast @CTHID\n\n--DECLARE @CTRID INT \n--SELECT @CTRID=id from xtransactiondetail where TransactionHeader_ID = @CTHID\n\nDECLARE @GIP nvarchar(10)\nselect @GIP= av from @main_db.dbo.gip(@ID)\n\nDECLARE @mes nvarchar(200), @FustSaldo int, @CoreType nvarchar(10),@FustID int, @xDesc nvarchar(200)\nSELECT @xDesc=x.[Description],@mes= concat('Selling ' , x.[Description],' (GIP:',TRY_CAST(@GIP as decimal(8,2)),')'),@Coretype= x.coretype,@FustID=x.Fust_ID from xstock x where x.id=@ID --@main_db.dbo.\n--EXEC sp_api_modal_text @mes,'h2 text-primary'\n\nIF {[verkoop].status} not in ('openSale') AND @Coretype='FOOD' BEGIN --200924 fust mag wel worden bij of afgeboekt\n\tEXEC sp_api_modal_alert 'U kunt alleen leeg FUST toevoegen/terugnemen, want de order is definitief.'\n\tEXEC sp_api_modal_clear\t\t\n\tRETURN;\t\n\tend\n\n-- 200629 Uitbreiding inkoop vanuit diverse contexten: Zoek CTH ; bijv als we afkomstig zijn van een regel, dan is CTH te vinden in de regel\n--if @parent_card_name ='verkoop'\tset @CTHID=@parent_id\n--if @parent_card_name = 'ctr2' set @CTHID=(select TransactionHeader_ID from xtransactiondetail where xtransactiondetail.id=@parent_id)\nIF @coretype in('CRATE','PALLET')\n\tBEGIN\n\t\tSELECT @Fustsaldo=Fustsaldo from @main_db.dbo.FustSaldo_FC(@FustID,{[verkoop2].Counterparty_ID})\n\t\t-- EXEC sp_api_toast @Fustsaldo\n\t\t-- breid DECLARE message uit met het fust-saldo\n\t\tIF @FustSaldo is not NULL\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') actueel saldo bij deze klant: ',@fustsaldo)\n\t\tELSE\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') => let op: deze klant heeft dit fust nooit eerder gehad!')\n\tEND\n\t\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\nDECLARE @prijs nvarchar(20),@aantal nvarchar(20),@opmerking nvarchar(50), @Pricetype nvarchar(10) --='100' --RH210113 opmerking 50 gemaakt, was 10!\nDECLARE @CounterpartyID int\nDECLARE @FlowModel int\nDECLARE @THDT INT\nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=FlowModel_ID,@THDT=TDT From xTransactionHeader CTH where CTH.ID=@CTHID\n--200630 was@parent_id\n\n--200708 => ??? WAAROM GAAT DIT NIET ??? select @Prijs= @main_db.dbo.StockPrice(@ID,@CTHID,NULL,NULL,NULL,NULL,NULL,NULL,NULL)\nDECLARE @FRAFOT Nvarchar(3) -- 'FRA' OF 'FOT'\nDECLARE @SrcID int -- let op: slechts 'advies'\nDECLARE @DstID INT\n\n\n--201022\ndeclare @dayprice bit\nset @dayprice=isnull((select L from @main_db.dbo.[GetCompanySettings]('useDayprice')),0)\n-- exec sp_api_toast @dayprice\n\nif @dayprice = 1 \n\tBEGIN\n\t\tselect top 1 @Prijs=per.pricehi from p_PriceEntryRow per where per.Stock_ID=@ID and per.Supplier_ID=@CounterpartyID and per.activeCount>0\n\tEND\n\nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=cth.FlowModel_ID,@THDT=cth.TDT,@FRAFOT=cth.FRAFOT, @srcID=cth.source_ID,@DstID=cth.Destination_ID From q_xTransactionHeader CTH where CTH.ID=@CTHID\n-- exec sp_api_toast @dstID\n--200630 was@parent_id\n\nif isnull(@Prijs,0)=0\n\tbegin\n\t\t--SELECT top 1 @prijs = ctr.ctrPRICE FROM xctrtotals ctr WHERE ctr.ctrprice > 0 AND ctr.Counterparty_ID=@CounterpartyID AND ctr.ctrStock_ID =@ID ORDER BY ctr.id DESC -- laatste prijs!\n\n\t\tset @prijs=(select @main_db.dbo.stockprice(\t@ID --48482 --stock_ID\n\t\t\t\t\t\t\t,@CTHID --3761\t--CTH_ID\n\t\t\t\t\t\t\t,@CounterpartyID --161418\t--Counterparty_ID\n\t\t\t\t\t\t\t,@FlowModel --null\t--Flowmodel_ID\n\t\t\t\t\t\t\t,@THDT --2\t\t--DaTDT\n\t\t\t\t\t\t\t,@SrcID --NULL --SupplierLocation_ID\n\t\t\t\t\t\t\t,@DstID --NULL -- 7945\t--Receiverlocation_ID\n\t\t\t\t\t\t\t,IIF(@FRAFOT='FOT',1,0)\t\t--isFOT\n\t\t\t\t\t\t\t,@dayprice --0-- use dayprice\n\t\t\t\t\t\t)\n\t\t\t\t\t)\n\n\tend\n\nDECLARE @can_set_delayed BIT = 0 \nIF dbo.ABCDATE() < dbo.workDate() OR dbo.ABCDATE() < {[verkoop].TransactionDate}\nBEGIN\n\tSET @can_set_delayed = 1\nEND\nDECLARE @new_id INT\n\nIF @id = ANY (select stock_id from xtransactiondetail where TransactionHeader_ID = @CTHID AND stock_id = @id) BEGIN\n\tDECLARE @QTYCTR nvarchar(20)\n\tSELECT @QTYCTR = sum(Amount) from xTransactiondetail where @id = stock_id AND TransactionHeader_ID = @CTHID\n\tEXEC sp_api_modal_text 'Let op! Dit artikel bestaat al in de bestelling!','text-danger font-weight-bold h2 text-center'\n\tEXEC sp_api_modal_text 'Momenteel in bestelling:','text-danger font-weight-bold h2 text-center'\n\tEXEC sp_api_modal_text @QTYCTR,@class = 'text-danger font-weight-bold display-4 text-center'\nEND\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\nEXEC sp_api_modal_text 'Aantal'\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1,@select=1\nIF @coretype in('FOOD','SERVICE')\n\tBEGIN\n\t\tEXEC sp_api_modal_text 'Prijs'\n\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT\n\tEND\nEXEC sp_api_modal_text 'Opm. loods'\nEXEC sp_api_modal_input @name='opmerking',@value = @opmerking OUT\nDECLARE @button nvarchar(128)\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\n\nIF (select count(id) from view_coco_prijshistory where {[Stock_ctr2].ID} = Stock_ID AND xCompanyID = {[verkoop].counterparty_id} AND TDT = 2) > 0\nBEGIN\nselect\n\tAmount\n\t,Price\n\t,insUser\n\t,[order_NR] = id\n\t,TransactionDate\n\tINTO #prijshistory\n\tFROM view_coco_prijshistory\nwhere {[Stock_ctr2].ID} = Stock_ID AND xCompanyID = {[verkoop].counterparty_id} AND TDT = 2\nEXEC sp_api_modal_table @tmptable=N'#prijshistory',@orderby=N'ORDER BY TransactionDate DESC OFFSET 0 ROWS FETCH NEXT 8 ROWS ONLY'\nEND\n\nDECLARE @mapfustpartijregel int\n\n\tBEGIN\n\t\tIF dbo.str2dec(@prijs) > 100 BEGIN -- groter dan 100\n\t\tEXEC sp_api_modal_clear\t\n\t\tEXEC sp_api_modal_text 'LET OP! PRIJS IS GROTER DAN:','text-danger font-weight-bold text-center'\n\t\tEXEC sp_api_modal_text '100,00', 'text-danger font-weight-bold display-4 text-center'\n\t\tEXEC sp_api_modal_text 'DRUK (INSERT) OM TOCH DOOR TE GAAN OF VUL EEN ANDERE PRIJS IN:','text-danger font-weight-bold text-center'\n\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT,@focus=1,@select=1\n\t\tDECLARE @button2 nvarchar(128)\n\t\tEXEC sp_api_modal_button @name='button2',@value = 'Doorgaan',@valueout = @button2 OUT,@class = 'btn-danger',@key = 'Insert'\n\t\tEXEC sp_api_modal_text 'DRUK OP (ESC) OM DIT SCHERM TE VERLATEN','text-Secondary text-right blockquote-footer'\n\t\tIF @button2 IS NOT NULL BEGIN\n\t\t\tIF @button IS NOT NULL\n\t\t\tBEGIN\n\t\t\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') \n\t\t\t\tIF \t\tdbo.str2dec(@prijs) > 0 OR dbo.str2dec(@prijs) = 0 AND \n\t\t\t\t\t\tdbo.str2dec(@aantal) > 0 \n\t\t\t\t\t\tOR @FustSaldo is not NULL \n\t\t\t\t\tBEGIN\n\t\t\t\t\t\texec @new_id = @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs,@Logistic=@Opmerking, @User=@User\n\t\t\t\t\t\tIF @new_id > 0 AND @can_set_delayed = 1\n\t\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\tUPDATE xTransactionDetail SET delayed = @can_set_delayed WHERE id = @new_id\n\t\t\t\t\t\t\texec sp_api_toast N'Gereserveerd!'\n\t\t\t\t\t\t\tEND\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\n\t\t\t\t\t\texec sp_api_toast @mes\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\t\tEND\n\t\t\t\tELSE\n\t\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\t\t\t\tEND \t\t\n\t\t\tEND\n\t\tEND\n\n\t\tIF dbo.str2dec(@prijs) BETWEEN 0 AND 1 BEGIN -- kleiner dan 1\n\t\tEXEC sp_api_modal_clear\n\t\tEXEC sp_api_modal_text 'LET OP! PRIJS IS KLEINER DAN:','text-danger font-weight-bold text-center'\n\t\tEXEC sp_api_modal_text '1,00','text-danger font-weight-bold display-4 text-center'\n\t\tEXEC sp_api_modal_text 'DRUK (INSERT) OM TOCH DOOR TE GAAN OF VUL EEN ANDERE PRIJS IN:','text-danger font-weight-bold text-center'\n\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT,@focus=1,@select=1\n\t\tDECLARE @button3 nvarchar(128)\n\t\tEXEC sp_api_modal_button @name='button3',@value = 'Doorgaan',@valueout = @button3 OUT,@class = 'btn-danger',@key = 'Insert'\n\t\tEXEC sp_api_modal_text 'DRUK OP (ESC) OM DIT SCHERM TE VERLATEN','text-Secondary text-right blockquote-footer'\n\t\tIF @button3 IS NOT NULL BEGIN\n\t\t\tIF @button IS NOT NULL\n\t\t\tBEGIN\n\t\t\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') \n\t\t\t\tIF \t\tdbo.str2dec(@prijs) > 0 OR dbo.str2dec(@prijs) = 0 AND \n\t\t\t\t\t\tdbo.str2dec(@aantal) > 0 \n\t\t\t\t\t\tOR @FustSaldo is not NULL \n\t\t\t\t\tBEGIN\n\t\t\t\t\t\texec @new_id = @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs,@Logistic=@Opmerking, @User=@User\n\t\t\t\t\t\tIF @new_id > 0 AND @can_set_delayed = 1\n\t\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\tUPDATE xTransactionDetail SET delayed = @can_set_delayed WHERE id = @new_id\n\t\t\t\t\t\t\texec sp_api_toast N'Gereserveerd!'\n\t\t\t\t\t\t\tEND\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\n\t\t\t\t\t\texec sp_api_toast @mes\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\t\tEND\n\t\t\t\tELSE\n\t\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\t\t\t\tEND \t\t\n\t\t\tEND\n\t\tEND\n\tEND\n\nIF @button IS NOT NULL AND dbo.str2dec(@prijs) BETWEEN 1 AND 100 -- tussen 1 en 100\n\t\t\tBEGIN\n\t\t\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') -- dit vertaalt een komma in een punt, waardoor iemand 123,85 kan intikken END ook 123.85\n\t\t\t\tIF \t\tdbo.str2dec(@prijs) > 0 AND \n\t\t\t\t\t\tdbo.str2dec(@aantal) > 0 \n\t\t\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\texec @new_id = @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs,@Logistic=@Opmerking, @User=@User\n\t\t\t\t\t\tIF @new_id > 0 AND @can_set_delayed = 1\n\t\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\tUPDATE xTransactionDetail SET delayed = @can_set_delayed WHERE id = @new_id\n\t\t\t\t\t\t\texec sp_api_toast N'Gereserveerd!'\n\t\t\t\t\t\t\tEND\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\n\t\t\t\t\t\texec sp_api_toast @mes\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\t\tEND\n\t\t\t\tELSE\n\t\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\t\t\t\tEND\nIF @button IS NOT NULL AND @coretype in('CRATE','PALLET') -- fust\n\t\t\tBEGIN\n\t\t\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') -- dit vertaalt een komma in een punt, waardoor iemand 123,85 kan intikken END ook 123.85\n\t\t\t\tIF \t\t--dbo.str2dec(@prijs) > 0 AND \n\t\t\t\t\t\tdbo.str2dec(@aantal) > 0 \n\t\t\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\n\t\t\t\t\tBEGIN\n\t\t\t\tSET @mapfustpartijregel=(select @main_db.dbo.FustIV_VTD(@FustID))\n\t\t\t\t\t\texec @new_id = @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs,@Logistic=@Opmerking, @User=@User,@mapctr_id=@mapfustpartijregel\n\t\t\t\t\t\tIF @new_id > 0 AND @can_set_delayed = 1\n\t\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\tUPDATE xTransactionDetail SET delayed = @can_set_delayed WHERE id = @new_id\n\t\t\t\t\t\t\texec sp_api_toast N'Gereserveerd!'\n\t\t\t\t\t\t\tEND\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\n\t\t\t\t\t\texec sp_api_toast @mes\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\t\tEND\n\t\t\t\tELSE\n\t\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\t\t\t\tEND\nIF @button IS NOT NULL AND dbo.str2dec(@aantal) > 0  AND dbo.str2dec(@prijs) is NULL -- aantal groter dan 0 en price niet ingevuld.\n\t\t\tBEGIN\n\t\t\t\t--IF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') -- dit vertaalt een komma in een punt, waardoor iemand 123,85 kan intikken END ook 123.85\n\t\t\t\tIF \t\t--dbo.str2dec(@prijs) > 0 AND \n\t\t\t\t\t\tdbo.str2dec(@aantal) > 0 \n\t\t\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\n\t\t\t\t\tBEGIN\n\t\t\t\tSET @mapfustpartijregel=(select @main_db.dbo.FustIV_VTD(@FustID))\n\t\t\t\t\t\texec @new_id = @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs,@Pricetype='FIXED',@Logistic=@Opmerking, \t\t\t \n   \t\t\t\t\t\t@User=@User,@mapctr_id=@mapfustpartijregel\n\t\t\t\t\t\tIF @new_id > 0 AND @can_set_delayed = 1\n\t\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\tUPDATE xTransactionDetail SET delayed = @can_set_delayed WHERE id = @new_id\n\t\t\t\t\t\t\texec sp_api_toast N'Gereserveerd!'\n\t\t\t\t\t\t\tEND\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\n\t\t\t\t\t\texec sp_api_toast @mes\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\t\tEND\n\t\t\t\tELSE\n\t\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\t\t\t\tEND",
            "action_id": 1294,
            "action_name": "SelectAmount",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--EXEC sp_api_toast @parent_parent_id\r\n--exec sp_api_toast @User\r\n\t\r\nDECLARE @CTHID INT = {[correctie].id} --200818 curly\r\nIF @CTHID IS NULL begin\r\n\t\tEXEC sp_api_toast 'Kan geen [correctie] vinden'\r\n\t\tRETURN;\r\n\t\tend\r\n--ELSE EXEC sp_api_toast @CTHID\r\n\r\nIF {[correctie].status} not in ('opencorrectie') BEGIN\r\n\tEXEC sp_api_modal_alert 'Toevoegen alleen bij status: correctie'\r\n\tEXEC sp_api_modal_clear\t\t\r\n\tRETURN;\t\r\n\tend\r\n\r\n-- 200629 Uitbreiding inkoop vanuit diverse contexten: Zoek CTH ; bijv als we afkomstig zijn van een regel, dan is CTH te vinden in de regel\r\n--if @parent_card_name ='verkoop'\tset @CTHID=@parent_id\r\n--if @parent_card_name = 'ctr2' set @CTHID=(select TransactionHeader_ID from xtransactiondetail where xtransactiondetail.id=@parent_id)\r\n\r\nDECLARE @mes nvarchar(200), @FustSaldo int, @CoreType nvarchar(10),@FustID int, @xDesc nvarchar(200)\r\nSELECT @xDesc=x.[Description],@mes= concat('correctie bij ' , x.[Description]) ,@Coretype= x.coretype,@FustID=x.Fust_ID from xstock x where x.id=@ID --@main_db.dbo.\r\n--EXEC sp_api_modal_text @mes,'h2 text-primary'\r\n------\r\nIF @coretype in('CRATE','PALLET')\r\n\tBEGIN\r\n\t\tSELECT @Fustsaldo=Fustsaldo from @main_db.dbo.FustSaldo_FC(@FustID,{[verkoop].Counterparty_ID})\r\n\t\tEXEC sp_api_toast @Fustsaldo\r\n\t\t-- breid DECLARE message uit met het fust-saldo\r\n\t\tIF @FustSaldo is not NULL\r\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') actueel saldo bij deze klant: ',@fustsaldo)\r\n\t\tELSE\r\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') => let op: deze klant heeft dit fust nooit eerder gehad!')\r\n\tEND\r\n\r\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\r\nDECLARE @aantal nvarchar(20),@opmerking nvarchar(50) --='100'\r\nDECLARE @CounterpartyID int\r\nDECLARE @FlowModel int\r\nDECLARE @THDT INT \r\nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=FlowModel_ID,@THDT=TDT From xTransactionHeader CTH where CTH.ID=@CTHID\r\n--200630 was@parent_id\r\n\r\n--200708 => ??? WAAROM GAAT DIT NIET ??? select @Prijs= @main_db.dbo.StockPrice(@ID,@CTHID,NULL,NULL,NULL,NULL,NULL,NULL,NULL)\r\n\r\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\r\nEXEC sp_api_modal_text 'Aantal'\r\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1\r\nEXEC sp_api_modal_text 'Opm. loods'\r\nEXEC sp_api_modal_input @name='opmerking',@value = @opmerking OUT\r\nDECLARE @button nvarchar(128)\r\nEXEC sp_api_modal_button @name='button',@value = 'IN',@valueout = @button OUT,@class = 'btn-primary',@key = '+'\r\nEXEC sp_api_modal_button @name='button',@value = 'OUT',@valueout = @button OUT,@class = 'btn-primary',@key = '-'\r\nIF @button = 'OUT'\r\n\tBEGIN\r\n\t\tIF \t\t--TRY_CAST(@prijs as decimal) > 0 AND \r\n\t\t\t\tTRY_CAST(@aantal as int) > 0 \r\n\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\r\n\t\t\tBEGIN\r\n\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=NULL,@Logistic=@Opmerking, @User=@User, @forcedTDT=2\r\n\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de correctie' from xstock x where x.id=@ID\r\n\t\t\t\texec sp_api_toast @mes\r\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\r\n\r\n\t\t\tEND\r\n\t\tELSE\r\n\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\r\n\tEND \r\nIF @button = 'IN'\r\n\tBEGIN\r\n\t\tIF \t\t--TRY_CAST(@prijs as decimal) > 0 AND \r\n\t\t\t\tTRY_CAST(@aantal as int) > 0 \r\n\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\r\n\t\t\tBEGIN\r\n\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=NULL,@Logistic=@Opmerking, @User=@User, @forcedTDT=1\r\n\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de correctie' from xstock x where x.id=@ID\r\n\t\t\t\texec sp_api_toast @mes\r\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\r\n\r\n\t\t\tEND\r\n\t\tELSE\r\n\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\r\n\tEND",
            "action_id": 1295,
            "action_name": "SelectAmount",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_text 'Filter prijzen',N'mt-4 h5'\r\nDECLARE @search nvarchar(128) = {[verkoop].CounterParty_ID.Code} ,@button nvarchar(128),@Description nvarchar(max)\r\nEXEC sp_api_modal_input @name='search',@value = @search OUT,@focus=0,@select=1\r\nEXEC sp_api_modal_input @name='search1',@value = @search OUT,@focus=0,@select=0\r\nEXEC sp_api_modal_input @name='search3',@value = @search OUT,@focus=0,@select=0\r\n\r\nSET @button = 'Historie'\r\nEXEC sp_api_modal_button @name='button',@value = 'Historie',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\r\nEXEC sp_api_modal_button @name='button',@value = 'Hell',@valueout = @button OUT,@class = 'btn-primary',@key = 'F2'\r\n\r\nDECLARE @CounterParty_ID INT = {[verkoop].CounterParty_ID}\r\nDECLARE @xProduct_ID INT = {[stock_ctr2].xProduct_ID}\r\n\r\nIF @button = 'Historie'\r\n\tBEGIN\r\n\r\n\t\tSET @Description = CONCAT(N'Historie', ' - ' + {[stock_ctr2].Description})\r\n\t\tEXEC sp_api_modal_text @text = @Description,@class = 'h3 text-muted'\r\n\t\tSELECT [Datum*]=ctr.TransactionDate,ctr.Amount, ctr.Price,ctr.Origin_Code,ctr.Counterparty INTO #klant_historie FROM Q_xTransactionDetail ctr\r\n\t\t\tWHERE Stock_ID IN (SELECT id FROM xStock WHERE xProduct_ID = @xProduct_ID) AND Price > 0 ORDER BY ctr.TransactionDate DESC\r\n\t\tEXEC sp_api_modal_table @tmptable=N'#klant_historie'\r\n\tEND\r\n\r\nIF @button = 'Hell'\r\n\tBEGIN\r\n\t\tSET @Description = N'Hell suppliers'\r\n\r\nSELECT\r\n\t[Supplier*] = (SELECT CONCAT(Code,' - ',CompanyName) FROM xCompany WHERE id = Supplier_ID)\r\n\t,Receiver = (SELECT CONCAT(Code,' - ',CompanyName) FROM xCompany WHERE id = Receiver_ID)\r\n\t,[inPrice] = inPrice\r\n\t,Pallet = IIF(FullPalletPrice=1,'Full Pallet','')\r\n\t\tINTO #modaltable FROM t_Price this WHERE Art_ID = @id AND (\r\n\t\t\t(SELECT CONCAT(Code,' - ',CompanyName) FROM xCompany WHERE id = Supplier_ID) LIKE '%'+@search+'%'\r\n\t\t\t\tOR\r\n\t\t\t(SELECT CONCAT(Code,' - ',CompanyName) FROM xCompany WHERE id = Receiver_ID) LIKE '%'+@search+'%'\r\n\t)\r\nEXEC sp_api_modal_table\r\nEND\r\n\r\nreturn\t\r\n\r\n\r\nDECLARE @CTHID INT = {[verkoop].id} --200818 curly\r\nIF @CTHID IS NULL begin\r\n\t\tEXEC sp_api_toast 'Kan geen [verkoop] vinden'\r\n\t\tRETURN;\r\n\t\tend\r\n--ELSE EXEC sp_api_toast @CTHID\r\n\r\nDECLARE @mes nvarchar(200), @FustSaldo int, @CoreType nvarchar(10),@FustID int, @xDesc nvarchar(200)\r\nSELECT @xDesc=x.[Description],@mes= concat('Selling ' , x.[Description]) ,@Coretype= x.coretype,@FustID=x.Fust_ID from xstock x where x.id=@ID --@main_db.dbo.\r\n--EXEC sp_api_modal_text @mes,'h2 text-primary'\r\n\r\nIF {[verkoop].status} not in ('openSale') AND @Coretype='FOOD' BEGIN --200924 fust mag wel worden bij of afgeboekt\r\n\tEXEC sp_api_modal_alert 'U kunt alleen leeg FUST toevoegen/terugnemen, want de order is definitief.'\r\n\tEXEC sp_api_modal_clear\t\t\r\n\tRETURN;\t\r\n\tend\r\n\r\n-- 200629 Uitbreiding inkoop vanuit diverse contexten: Zoek CTH ; bijv als we afkomstig zijn van een regel, dan is CTH te vinden in de regel\r\n--if @parent_card_name ='verkoop'\tset @CTHID=@parent_id\r\n--if @parent_card_name = 'ctr2' set @CTHID=(select TransactionHeader_ID from xtransactiondetail where xtransactiondetail.id=@parent_id)\r\n\r\n\r\n------\r\nIF @coretype in('CRATE','PALLET')\r\n\tBEGIN\r\n\t\tSELECT @Fustsaldo=Fustsaldo from @main_db.dbo.FustSaldo_FC(@FustID,{[verkoop].Counterparty_ID})\r\n\t\tEXEC sp_api_toast @Fustsaldo\r\n\t\t-- breid DECLARE message uit met het fust-saldo\r\n\t\tIF @FustSaldo is not NULL\r\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') actueel saldo bij deze klant: ',@fustsaldo)\r\n\t\tELSE\r\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') => let op: deze klant heeft dit fust nooit eerder gehad!')\r\n\tEND\r\n\r\n\r\n\r\n\r\n\r\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\r\nDECLARE @prijs nvarchar(20),@aantal nvarchar(20) --='100'\r\nDECLARE @CounterpartyID int\r\nDECLARE @FlowModel int\r\nDECLARE @THDT INT\r\nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=FlowModel_ID,@THDT=TDT From xTransactionHeader CTH where CTH.ID=@CTHID\r\n--200630 was@parent_id\r\n--BEGIN \r\n--200708 => ??? WAAROM GAAT DIT NIET ??? select @Prijs= @main_db.dbo.StockPrice(@ID,@CTHID,NULL,NULL,NULL,NULL,NULL,NULL,NULL)\r\n\r\nif isnull(@Prijs,0)=0\r\n\tbegin\r\n\t\tSELECT top 1 @prijs = ctr.ctrPRICE FROM xctrtotals ctr WHERE ctr.ctrprice > 0 AND\r\n\t\tctr.Counterparty_ID=@CounterpartyID AND ctr.ctrStock_ID =@ID ORDER BY ctr.id DESC -- laatste prijs!\r\n\tend\r\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\r\nEXEC sp_api_modal_text 'Aantal'\r\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1\r\nIF @coretype in('FOOD')\r\n\tBEGIN\r\n\t\tEXEC sp_api_modal_text 'Prijs'\r\n\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT\r\n\tEND\r\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\r\nIF @button IS NOT NULL\r\n\tBEGIN\r\n\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') -- 200924 zorg dat je ook komma mag gebruiken als decimaal scheidingsteken\r\n\t\tIF \t\t--try_cast(@prijs as decimal(10,2)) > 0 AND \r\n\t\t\tTRY_CAST(@aantal as int) >\t 0 \r\n\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\r\n\t\t\tBEGIN\r\n\t\t\t\tDECLARE @mapfustpartijregel int\r\n\t\t\t\tSET @mapfustpartijregel=(select @main_db.dbo.FustIV_VTD(@FustID))\r\n\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs, @User=@User,@mapctr_id=@mapfustpartijregel\r\n\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\r\n\t\t\t\texec sp_api_toast @mes\r\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\r\n\t\t\t\tRETURN\r\n\t\t\tEND\r\n\t\tELSE\r\n\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\r\n\tEND\r\n\r\n\r\n",
            "action_id": 1296,
            "action_name": "SelectAmount2",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @week nvarchar(128),@year nvarchar(128),@button nvarchar(128), @currentweek nvarchar(128), @date nvarchar(128), @dateandweek nvarchar(128)\r\nSET @week = @main_db.dbo.ABCWEEKNR() - 1\r\nSET @year = YEAR ( getdate() )\r\nSET @currentweek = @main_db.dbo.ABCWEEKNR()\r\nSET @date = FORMAT(@main_db.dbo.ABCDATE(), 'dd-MM-yyyy') --try_cast(@main_db.dbo.abcdate() AS date)\r\nSET @dateandweek = 'jjjj-mm-dd: '+ @date + ' ' + 'Week nummer: ' + @currentweek\r\nDECLARE @Download nvarchar(128) = dbo.strdate(NULL) +'_'+ 'Productschap.csv'\r\n\r\nEXEC sp_api_modal_text @dateandweek\r\n--EXEC sp_api_modal_text @name='Jaar',@value = @year OUT,@class='w-24' -- zoek veld\r\nEXEC sp_api_modal_text 'Week nummer: (Standaard 1 week terug gezet)'\r\nEXEC sp_api_modal_input @name='WeekNummer',@value = @week OUT,@class='w-24',@focus=1,@select=1 -- zoek veld\r\n\r\nSET @button = 'AangifteProductschap'\r\nEXEC sp_api_modal_button @name='button',@value = 'AangifteProductschap',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\r\nEXEC sp_api_modal_print\r\n\r\nIF @button =  'AangifteProductschap'\r\nBEGIN\r\nSELECT distinct [CountryName*], [Artikel], [Klas], [Aantal@],'Week nummer:' AS [WeekNummerCap*], [WeekNummer*]\r\nINTO #AangifteProductschap\r\nFROM          RV_AangifteProductschap\r\nWHERE\t\t[WeekNummer*] = @week AND [THTDT] = 2 AND [ABCYear] = @year\r\nEXEC sp_api_modal_table @tmptable=N'#AangifteProductschap',@orderby=N'ORDER BY [CountryName*], [WeekNummerCap*], [WeekNummer*], [Artikel] ASC', @print=1\r\nEXEC sp_api_modal_button @name='button',@value = 'DownloadProductschap',@valueout = @button OUT,@class = 'btn-success',@key = 'F1'\r\nEND \r\n\r\nIF @button =  'DownloadProductschap'\r\nBEGIN\r\nSELECT distinct [CountryName*], [Artikel], [Klas], [Aantal@],'Week nummer:' AS [WeekNummerCap*], [WeekNummer*]\r\nINTO #DownloadProductschap\r\nFROM          RV_AangifteProductschap\r\nWHERE\t\t[WeekNummer*] = @week AND [THTDT] = 2 AND [ABCYear] = @year\r\nEXEC sp_api_modal_csv @tmptable=N'#DownloadProductschap',@orderby=N'ORDER BY [CountryName*], [WeekNummerCap*], [WeekNummer*], [Artikel] ASC', @filename= @Download,@ansi=1\r\nEND \r\n",
            "action_id": 1297,
            "action_name": "Aangifte_Productschap",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @company_id nvarchar(32),@Countercompany nvarchar(32),@button nvarchar(128),@button2 nvarchar(128), @CTR_ID nvarchar(128),@button1 nvarchar(128)\n,@link_ID nvarchar(128),@Linkqty nvarchar(128),@Party nvarchar(128),@desc nvarchar(128),@text nvarchar(128),@unmapped nvarchar(128)\n\nSET @unmapped = (SELECT Unmapped FROM q_xtransactiondetail where id = @id)\nSET @text = 'Totaal Mapped: ' + @unmapped\nSET @CTR_ID = (SELECT ID FROM q_xtransactiondetail where id = @id)\nEXEC sp_api_modal_text @text, 'text-primary font-weight-bold text-center display-4'\n\nselect LinkAantal,Leverancier,Ontvanger,[Description] \nINTO #linkinfo\nfrom Q_IVLINK IV \nWHERE EXISTS (SELECT 1 FROM q_xtransactiondetail ctr\n               WHERE @CTR_ID = IV.VTD\n                 OR @CTR_ID = IV.ITD)\nEXEC sp_api_modal_table @tmptable=N'#linkinfo'\n\nselect id,LinkAantal,[Party ] = concat(Leverancier,'->',Ontvanger),[Description ] \nINTO #modalupdate\nfrom Q_IVLINK IV \nWHERE EXISTS (SELECT 1 FROM q_xtransactiondetail ctr\n               WHERE @CTR_ID = IV.VTD\n                 OR @CTR_ID = IV.ITD)\nEXEC sp_api_modal_table_update @tmptable = N'#modalupdate',@focusx = 1,@focusy = 1\n\nDECLARE @button_text1 nvarchar(128) = 'Opslaan'\nEXEC sp_api_modal_button @name='button1',@value = @button_text1, @valueout = @button1 OUT ,@class='btn-primary',@key='Enter'\nIF @button1 IS NOT NULL\n\tBEGIN\n\t\tDECLARE @lfid int\n\t\tDECLARE @cursor CURSOR\n\t\tSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT id,LinkAantal,Party,Description FROM #modalupdate\n\t\tOPEN @cursor;\n\t\tFETCH NEXT FROM @cursor INTO @link_ID,@Linkqty,@Party,@desc\n\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_post 'IVLINK','LinkAantal',@Linkqty,@link_ID\n\t\t\t\tEXEC sp_api_modal_save 'IVLINK',@link_ID\n\t\t\t\tFETCH NEXT FROM @cursor INTO @link_ID,@Linkqty,@Party,@desc\n\t\t\tEND\n\t\tCLOSE @cursor;\n\t\tDEALLOCATE @cursor;\n\t\tEXEC sp_api_modal_clear\n\tEND\nRETURN",
            "action_id": 1298,
            "action_name": "Adjust IV Linkaantal",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\t--dit is nu alleen voor tellers en checks, zodat we weten dat het report al is gemaakt:\n\t\t--EXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'CTH'\t,@Context_Key_ID=@cid,@Report_CODE=N'CONF_DELIVERY' -- zie runreport \n\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select Counterparty_id from xtransactionheader where id=@cid)\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = 'deliverynote' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\n\n\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 1299,
            "action_name": "afleverbon",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast N'Afleverbon afdrukken' \r\n\r\nDECLARE @cursor_ids CURSOR,@cid INT\r\nDECLARE @toCompany_ID INT \r\nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\r\n\t\t\r\n\r\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\r\nOPEN @cursor_ids;\r\nFETCH NEXT FROM @cursor_ids INTO @cid\r\nWHILE @@FETCH_STATUS = 0\r\n\tBEGIN\r\n\t\tEXEC sp_api_toast @cid\r\n\t\t--dit is nu alleen voor tellers en checks:\r\n\r\n\t\t--even niet registreren dat er wordt afgedrukt\r\n\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'LF'\t,@Context_Key_ID=@cid,@Report_CODE=N'deliverynote'\r\n\r\n\t\t--dit is de feitelijke \"run\"\r\n\t\tSET @toCompany_ID = (select top 1 id from xTenantKey) -- een CRM wordt naar tenant gestuurd/geprint\r\n\t\t--DECLARE @error INT\r\n\t\tEXEC sp_api_report_generate @id = @cid\r\n\t\t\t,@sys_report_key = 'deliverynote' --zie xrepdef\r\n\t\t\t,@toCompany_ID = @toCompany_ID\r\n\t\t\t,@fromCompany_ID = @fromCompany_ID\r\n\r\n\t\t--IF @error > 0 RAISERROR(N'Er is een probleem')\r\n\r\n\r\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\r\n\tEND\r\nCLOSE @cursor_ids;\r\nDEALLOCATE @cursor_ids;",
            "action_id": 1300,
            "action_name": "Afleverbon",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\t\t\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\t--dit is nu alleen voor tellers en checks, zodat we weten dat het report al is gemaakt:\n\t\t--EXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'CTH'\t,@Context_Key_ID=@cid,@Report_CODE=N'CONF_DELIVERY' -- zie runreport \n\n\t\t--dit is de feitelijke \"run\"\n\t\tSET @toCompany_ID = (select Counterparty_id from xtransactionheader where id=@cid)\n\t\tEXEC sp_api_report_generate @id = @cid\n\t\t\t,@sys_report_key = 'deliverynote' --zie xrepdef\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@fixedEmail = @User_name\n\n\n\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;",
            "action_id": 1301,
            "action_name": "afleverbon naar jezelf",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @cth_id int = {[verkoop].id}, @ctr_id int,@stock_ID int,@detail nvarchar(max),@stock nvarchar(128),@text nvarchar(128)\n\nSELECT @ctr_id = id,@stock_ID = stock_ID,@detail=detail,@price =ISNULL(price,0) FROM xtransactionDetail WHERE ISNULL(price,0) = 0 AND @cth_id = transactionheader_id \nORDER BY detail DESC\nEXEC sp_api_modal_modal @class = 'w75'\n\nIF @ctr_id IS NOT NULL AND {[verkoop].status} in (N'openSale')\n\tBEGIN\n\t\t--EXEC sp_api_modal_text @detail\n\t\t--EXEC sp_api_modal_text @ctr_id\n\t\t\n\t\tSET @stock = (SELECT stock from xstock where id = @stock_ID)\n\t\tSELECT @text = 'History van: ' + @detail + ' Huidige voorraad: ' + @stock\n\t\tEXEC sp_api_modal_text 'INKOOP HISTORY', 'text-primary font-weight-bold text-center display-4'\n\t\tEXEC sp_api_modal_text @text, 'text-primary font-weight-bold text-center display-4'\n\t\t\n\t\tEXEC sp_api_modal_text N'Vul prijs in',N'h4 text-muted'\n\t\tEXEC sp_api_modal_input_decimal @name='@price',@value = @price OUT,@inline=1,@select=1\n\t\tEXEC sp_api_modal_button @name='@button',@value = 'Opslaan', @valueout = @button OUT,@class='btn-danger',@key='Enter'\n\t\t\n\t\tSELECT TOP 10 [Amount] = Amount,[Price] = Price,[currencyISO] = currencyISO,[Counterparty~col-sm-3] = Counterparty,[Verkocht aan] = MappedCompanies,\n\t\t[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id\n\t\tINTO #InkoopHistory\n\t\tfrom Q_xTransactionDetail \n\t\twhere TDT = 1 AND Stock_ID = @stock_ID\n\t\tORDER BY id DESC\n\t\tALTER TABLE #InkoopHistory\n\t\tDROP COLUMN [Stock_ID],[TDT]\n\t\tEXEC sp_api_modal_table @tmptable=N'#InkoopHistory',@orderby=N'ORDER BY id DESC'\n\t\t\n\t\tIF @button IS NOT NULL\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_post N'ctr2',N'price',@price,@ctr_id\n\t\t\t\tEXEC sp_api_modal_save N'ctr2',@ctr_id\n\t\t\t\tEXEC sp_api_modal_restart\n\t\t\tEND\n\tEND\nIF @ctr_id IS NULL\n\tBEGIN\n\tEXEC sp_api_modal_text 'Alle prijzen zijn ingevuld. Er zijn geen regels gevonden zonder een prijs.', 'text-success font-weight-bold text-center display-4'\n\tEND\nIF {[verkoop].status} not in (N'openSale')\n\tBEGIN\n\tEXEC sp_api_modal_text 'Direct prijzen ingave alleen bij open Orders!', 'text-success font-weight-bold text-center display-4'\n\tEND\n\n",
            "action_id": 1302,
            "action_name": "Alle prijzen invullen",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128),@detail nvarchar(128),@aantal nvarchar(128),@text nvarchar(128), @datumrange nvarchar(50)\nEXEC sp_api_modal_modal @class = 'w75'\nSET @date = dbo.workDate()\nSET @aantal = (SELECT stock from xstock where id = @id)\nSET @detail = (SELECT description from xstock where id = @id)\nSELECT @text = 'History van: ' + @detail + ' Huidige voorraad: ' + @aantal\nEXEC sp_api_modal_text 'INKOOP HISTORY', 'text-primary font-weight-bold text-center display-4'\nEXEC sp_api_modal_text @text, 'text-primary font-weight-bold text-center display-4'\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n--EXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\n\nDECLARE @simpelhistory BIT = 0\nIF dbo.hasClaims('sub=nicky@vgibv.nl') > 0 /*OR dbo.hasClaims('sub=colin@tracy.nu') > 0*/\nBEGIN\nSET @simpelhistory = 1\nEND\n\nIF @simpelhistory = 0\n\tBEGIN\n\t\tSET @from = DATEADD(week, -1, dbo.workDate())\n\t\tEXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\n\t\tSET @datumrange = concat(@from, ' - ', @to)\n\t\tEXEC sp_api_modal_button @name='button',@value = 'InkoopHistory',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\n\tEND\n\nSET @button = 'InkoopHistory'\n--EXEC sp_api_modal_button @name='button',@value = 'InkoopHistory',@valueout = @button OUT,@class = 'btn-primary',@key = '1'\n\nIF @button =  'InkoopHistory'\nBEGIN\n\tIF @simpelhistory = 1\n\t\tBEGIN\n\t\t\tSELECT TOP 10 [Amount@g] = Amount,[Price] = Price,[currencyISO] = currencyISO,[Counterparty~col-sm-3] = Counterparty,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id\n\t\t\tINTO #InkoopHistory\n\t\t\tfrom Q_xTransactionDetail \n\t\t\twhere TDT = 1 AND Stock_ID = @id AND delayed != 1 AND TransactionHeader_ID not in (select id from q_xtransactionheader where specialType = 1001)\n\t\t\tORDER BY id DESC\n\t\t\tALTER TABLE #InkoopHistory\n\t\t\tDROP COLUMN [Stock_ID],[TDT]\n\t\t\tEXEC sp_api_modal_table @tmptable=N'#InkoopHistory',@orderby=N'ORDER BY TransactionDate DESC'\n\n\t\t\tIF (SELECT count(id) from Q_xTransactionDetail where TDT = 1 AND Stock_ID = @id AND delayed = 1) > 0\n\t\t\t\tBEGIN\n\t\t\t\t\tEXEC sp_api_modal_text ' ', 'mt-3'\n\t\t\t\t\tSELECT TOP 10 [Amount@g] = Amount,[Price] = Price,[currencyISO] = currencyISO,[Counterparty~col-sm-3] = Counterparty,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id,[Reserved*] = case WHEN delayed = 1 THEN 'RESERVED' WHEN delayed = 0 THEN '' END\n\t\t\t\t\tINTO #InkoopHistorydelayed\n\t\t\t\t\tfrom Q_xTransactionDetail \n\t\t\t\t\twhere TDT = 1 AND Stock_ID = @id AND delayed = 1 AND TransactionHeader_ID not in (select id from q_xtransactionheader where specialType = 1001)\n\t\t\t\t\tORDER BY id DESC\n\t\t\t\t\tALTER TABLE #InkoopHistorydelayed\n\t\t\t\t\tDROP COLUMN [Stock_ID],[TDT]\n\t\t\t\t\tEXEC sp_api_modal_table @tmptable=N'#InkoopHistorydelayed',@orderby=N'ORDER BY TransactionDate DESC'\n\t\t\t\tEND\n\t\tEND\n\tIF @simpelhistory = 0\n\t\tBEGIN\n\t\t\tSELECT /*TOP 10*/ [Amount@g] = Amount,[Price] = Price,[currencyISO] = currencyISO,[Counterparty~col-sm-3] = Counterparty,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id\n\t\t\tINTO #InkoopHistory2\n\t\t\tfrom Q_xTransactionDetail \n\t\t\twhere TDT = 1 AND Stock_ID = @id AND delayed != 1 AND TransactionHeader_ID not in (select id from q_xtransactionheader where specialType = 1001)\n\t\t\tAND (Q_xTransactionDetail.TransactionDate BETWEEN @from AND @to)\n\t\t\tORDER BY id DESC\n\t\t\tALTER TABLE #InkoopHistory2\n\t\t\tDROP COLUMN [Stock_ID],[TDT]\n\t\t\tEXEC sp_api_modal_table @tmptable=N'#InkoopHistory2',@orderby=N'ORDER BY TransactionDate DESC'\n\n\t\t\tIF (SELECT count(id) from Q_xTransactionDetail where TDT = 1 AND Stock_ID = @id AND delayed = 1) > 0\n\t\t\t\tBEGIN\n\t\t\t\t\tEXEC sp_api_modal_text ' ', 'mt-3'\n\t\t\t\t\tSELECT TOP 10 [Amount@g] = Amount,[Price] = Price,[currencyISO] = currencyISO,[Counterparty~col-sm-3] = Counterparty,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id,[Reserved*] = case WHEN delayed = 1 THEN 'RESERVED' WHEN delayed = 0 THEN '' END\n\t\t\t\t\tINTO #InkoopHistorydelayed2\n\t\t\t\t\tfrom Q_xTransactionDetail \n\t\t\t\t\twhere TDT = 1 AND Stock_ID = @id AND delayed = 1 AND TransactionHeader_ID not in (select id from q_xtransactionheader where specialType = 1001)\n\t\t\t\t\tORDER BY id DESC\n\t\t\t\t\tALTER TABLE #InkoopHistorydelayed2\n\t\t\t\t\tDROP COLUMN [Stock_ID],[TDT]\n\t\t\t\t\tEXEC sp_api_modal_table @tmptable=N'#InkoopHistorydelayed2',@orderby=N'ORDER BY TransactionDate DESC'\n\t\t\t\tEND\n\t\tEND\nEND \n",
            "action_id": 1303,
            "action_name": "Inkoop History",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128),@detail nvarchar(128),@aantal nvarchar(128),@text nvarchar(128)\nEXEC sp_api_modal_modal @class = 'w75'\nSET @date = dbo.workDate()\nSET @aantal = (SELECT stock from xstock where id = @id)\nSET @detail = (SELECT description from xstock where id = @id)\nSELECT @text = 'History van: ' + @detail + ' Huidige voorraad: ' + @aantal\nEXEC sp_api_modal_text 'INKOOP HISTORY', 'text-primary font-weight-bold text-center display-4'\nEXEC sp_api_modal_text @text, 'text-primary font-weight-bold text-center display-4'\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n--EXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\nSET @button = 'InkoopHistory'\n--EXEC sp_api_modal_button @name='button',@value = 'InkoopHistory',@valueout = @button OUT,@class = 'btn-primary',@key = '1'\n\nIF @button =  'InkoopHistory'\nBEGIN\n\tSELECT TOP 10 [Amount@g] = Amount,[Price] = Price,[currencyISO] = currencyISO,[Counterparty~col-sm-3] = Counterparty,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id\n\tINTO #InkoopHistory\n\tfrom Q_xTransactionDetail \n\twhere TDT = 1 AND Stock_ID = @id AND delayed != 1 AND TransactionHeader_ID not in (select id from q_xtransactionheader where specialType = 1001)\n\tORDER BY id DESC\n\tALTER TABLE #InkoopHistory\n\tDROP COLUMN [Stock_ID],[TDT]\n\tEXEC sp_api_modal_table @tmptable=N'#InkoopHistory',@orderby=N'ORDER BY TransactionDate DESC'\n\n\tIF (SELECT count(id) from Q_xTransactionDetail where TDT = 1 AND Stock_ID = @id AND delayed = 1) > 0\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_text ' ', 'mt-3'\n\t\t\tSELECT TOP 10 [Amount@g] = Amount,[Price] = Price,[currencyISO] = currencyISO,[Counterparty~col-sm-3] = Counterparty,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id,[Reserved*] = case WHEN delayed = 1 THEN 'RESERVED' WHEN delayed = 0 THEN '' END\n\t\t\tINTO #InkoopHistorydelayed\n\t\t\tfrom Q_xTransactionDetail \n\t\t\twhere TDT = 1 AND Stock_ID = @id AND delayed = 1 AND TransactionHeader_ID not in (select id from q_xtransactionheader where specialType = 1001)\n\t\t\tORDER BY id DESC\n\t\t\tALTER TABLE #InkoopHistorydelayed\n\t\t\tDROP COLUMN [Stock_ID],[TDT]\n\t\t\tEXEC sp_api_modal_table @tmptable=N'#InkoopHistorydelayed',@orderby=N'ORDER BY TransactionDate DESC'\n\t\tEND\nEND \n",
            "action_id": 1304,
            "action_name": "Inkoop History",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128),@detail nvarchar(128),@aantal nvarchar(128),@text nvarchar(128), @datumrange nvarchar(50)\nEXEC sp_api_modal_modal @class = 'w75'\nSET @date = dbo.workDate()\nSET @aantal = (SELECT stock from xstock where id = @id)\nSET @detail = (SELECT description from xstock where id = @id)\nSELECT @text = 'History van: ' + @detail + ' Huidige voorraad: ' + @aantal\nEXEC sp_api_modal_text 'INKOOP HISTORY', 'text-primary font-weight-bold text-center display-4'\nEXEC sp_api_modal_text @text, 'text-primary font-weight-bold text-center display-4'\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n--EXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\n\nDECLARE @simpelhistory BIT = 0\nIF dbo.hasClaims('sub=nicky@vgibv.nl') > 0 /*OR dbo.hasClaims('sub=colin@tracy.nu') > 0*/\nBEGIN\nSET @simpelhistory = 1\nEND\n\nIF @simpelhistory = 0\n\tBEGIN\n\t\tSET @from = DATEADD(week, -1, dbo.workDate())\n\t\tEXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\n\t\tSET @datumrange = concat(@from, ' - ', @to)\n\t\tEXEC sp_api_modal_button @name='button',@value = 'InkoopHistory',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\n\tEND\n\nSET @button = 'InkoopHistory'\n--EXEC sp_api_modal_button @name='button',@value = 'InkoopHistory',@valueout = @button OUT,@class = 'btn-primary',@key = '1'\n\nIF @button =  'InkoopHistory'\nBEGIN\n\tIF @simpelhistory = 1\n\t\tBEGIN\n\t\t\tSELECT TOP 10 [Amount@g] = Amount,[Price] = Price,[currencyISO] = currencyISO,[Counterparty~col-sm-3] = Counterparty,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id\n\t\t\tINTO #InkoopHistory\n\t\t\tfrom Q_xTransactionDetail \n\t\t\twhere TDT = 1 AND Stock_ID = @id AND delayed != 1 AND TransactionHeader_ID not in (select id from q_xtransactionheader where specialType = 1001)\n\t\t\tORDER BY id DESC\n\t\t\tALTER TABLE #InkoopHistory\n\t\t\tDROP COLUMN [Stock_ID],[TDT]\n\t\t\tEXEC sp_api_modal_table @tmptable=N'#InkoopHistory',@orderby=N'ORDER BY TransactionDate DESC'\n\n\t\t\tIF (SELECT count(id) from Q_xTransactionDetail where TDT = 1 AND Stock_ID = @id AND delayed = 1) > 0\n\t\t\t\tBEGIN\n\t\t\t\t\tEXEC sp_api_modal_text ' ', 'mt-3'\n\t\t\t\t\tSELECT TOP 10 [Amount@g] = Amount,[Price] = Price,[currencyISO] = currencyISO,[Counterparty~col-sm-3] = Counterparty,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id,[Reserved*] = case WHEN delayed = 1 THEN 'RESERVED' WHEN delayed = 0 THEN '' END\n\t\t\t\t\tINTO #InkoopHistorydelayed\n\t\t\t\t\tfrom Q_xTransactionDetail \n\t\t\t\t\twhere TDT = 1 AND Stock_ID = @id AND delayed = 1 AND TransactionHeader_ID not in (select id from q_xtransactionheader where specialType = 1001)\n\t\t\t\t\tORDER BY id DESC\n\t\t\t\t\tALTER TABLE #InkoopHistorydelayed\n\t\t\t\t\tDROP COLUMN [Stock_ID],[TDT]\n\t\t\t\t\tEXEC sp_api_modal_table @tmptable=N'#InkoopHistorydelayed',@orderby=N'ORDER BY TransactionDate DESC'\n\t\t\t\tEND\n\t\tEND\n\tIF @simpelhistory = 0\n\t\tBEGIN\n\t\t\tSELECT /*TOP 10*/ [Amount@g] = Amount,[Price] = Price,[currencyISO] = currencyISO,[Counterparty~col-sm-3] = Counterparty,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id\n\t\t\tINTO #InkoopHistory2\n\t\t\tfrom Q_xTransactionDetail \n\t\t\twhere TDT = 1 AND Stock_ID = @id AND delayed != 1 AND TransactionHeader_ID not in (select id from q_xtransactionheader where specialType = 1001)\n\t\t\tAND (Q_xTransactionDetail.TransactionDate BETWEEN @from AND @to)\n\t\t\tORDER BY id DESC\n\t\t\tALTER TABLE #InkoopHistory2\n\t\t\tDROP COLUMN [Stock_ID],[TDT]\n\t\t\tEXEC sp_api_modal_table @tmptable=N'#InkoopHistory2',@orderby=N'ORDER BY TransactionDate DESC'\n\n\t\t\tIF (SELECT count(id) from Q_xTransactionDetail where TDT = 1 AND Stock_ID = @id AND delayed = 1) > 0\n\t\t\t\tBEGIN\n\t\t\t\t\tEXEC sp_api_modal_text ' ', 'mt-3'\n\t\t\t\t\tSELECT TOP 10 [Amount@g] = Amount,[Price] = Price,[currencyISO] = currencyISO,[Counterparty~col-sm-3] = Counterparty,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id,[Reserved*] = case WHEN delayed = 1 THEN 'RESERVED' WHEN delayed = 0 THEN '' END\n\t\t\t\t\tINTO #InkoopHistorydelayed2\n\t\t\t\t\tfrom Q_xTransactionDetail \n\t\t\t\t\twhere TDT = 1 AND Stock_ID = @id AND delayed = 1 AND TransactionHeader_ID not in (select id from q_xtransactionheader where specialType = 1001)\n\t\t\t\t\tORDER BY id DESC\n\t\t\t\t\tALTER TABLE #InkoopHistorydelayed2\n\t\t\t\t\tDROP COLUMN [Stock_ID],[TDT]\n\t\t\t\t\tEXEC sp_api_modal_table @tmptable=N'#InkoopHistorydelayed2',@orderby=N'ORDER BY TransactionDate DESC'\n\t\t\t\tEND\n\t\tEND\nEND \n",
            "action_id": 1305,
            "action_name": "Inkoop History",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128),@detail nvarchar(128),@aantal nvarchar(128),@text nvarchar(128)\nEXEC sp_api_modal_modal @class = 'w75'\nSET @date = dbo.workDate()\nSET @aantal = (SELECT stock from xstock where id = @id)\nSET @detail = (SELECT description from xstock where id = @id)\nSELECT @text = 'History van: ' + @detail + ' Huidige voorraad: ' + @aantal\nEXEC sp_api_modal_text 'INKOOP HISTORY', 'text-primary font-weight-bold text-center display-4'\nEXEC sp_api_modal_text @text, 'text-primary font-weight-bold text-center display-4'\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n--EXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\nSET @button = 'InkoopHistory'\n--EXEC sp_api_modal_button @name='button',@value = 'InkoopHistory',@valueout = @button OUT,@class = 'btn-primary',@key = '1'\n\nIF @button =  'InkoopHistory'\nBEGIN\n\tSELECT TOP 10 [Amount] = Amount,[Counterparty~col-sm-3] = Counterparty,[Verkocht aan] = MappedCompanies,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id\n\tINTO #InkoopHistory\n\tfrom Q_xTransactionDetail \n\twhere TDT = 1 AND Stock_ID = @id\n\tORDER BY id DESC\n\tALTER TABLE #InkoopHistory\n\tDROP COLUMN [Stock_ID],[TDT]\n\tEXEC sp_api_modal_table @tmptable=N'#InkoopHistory',@orderby=N'ORDER BY TransactionDate DESC'\nEND \n",
            "action_id": 1306,
            "action_name": "Inkoop History",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "-- ==============================================================================================\n-- LET OP! Deze action alleen wijzigen in xrepack en universeel houden voor xrepack & corrections\n-- ==============================================================================================\n\n\n\n\n\n\n\nDECLARE @company_id nvarchar(32),@button nvarchar(128),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000)\n, @location_id nvarchar(32), @reducer nvarchar(max), @date nvarchar(128)\n,@button1 nvarchar(128)\n,@button2 nvarchar(128)\n,@open_status nvarchar(128)\nset @date = dbo.workDate()\n/*\nEXEC sp_api_modal_select @card_name = N'packer',@value = @company_id OUT,@focus = 1\nSET @reducer = CONCAT('company_id = ',@company_id)\n*/\nIF @card_name = 'xrepack' SET @company_id = 159778\nIF @card_name = 'corrections' SET @company_id = 159786\nIF @company_id > 0\nBEGIN\n\tIF @card_name = 'xrepack' SET @button1 = N'Nieuwe ompakken'\n\tIF @card_name = 'xrepack' SET @button2 = N'Laatste open ompakken'\n\tIF @card_name = 'xrepack' SET @open_status = N'open_repack'\n\tIF @card_name = 'corrections' SET @button1 = N'Nieuwe correctie starten'\n\tIF @card_name = 'corrections' SET @button2 = N'Laatste open correctie'\n\tIF @card_name = 'corrections' SET @open_status = N'open_correction'\n\n\n/*\n\tDECLARE @reducer_location nvarchar(max) = N'id IN (SELECT Location_ID FROM xCompanyxLocation WHERE Company_ID =' + @company_id + ')'\n\tIF (SELECT LOCATIONS = count(Location_ID) FROM xCompanyxLocation WHERE Company_ID = @company_id) > 1\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_text 'Kies een ompak locatie:','text-primary'\n\t\t\tEXEC sp_api_modal_select @card_name = N'xlocation',@value = @location_id OUT,@focus=1,@reducer = @reducer_location\n\t\t\t\tIF @location_id > 0\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3',@focus=1\n\t\t\t\t\tEND\n\t\tEND\n\tIF (SELECT LOCATIONS = count(Location_ID) FROM xCompanyxLocation WHERE Company_ID = @company_id) = 1\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3',@focus=1\n\t\tEND\n\n\t--DECLARE @only_new_is_possible BIT = 0\n\t--EXEC sp_api_modal_select @card_name = N'xlocation',@reducer = @reducer,@value = @location_id OUT,@class='mt-3',@focus = 1\n\t--IF @location_id > 0\n\t--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3'\n*/\n\tEXEC sp_api_modal_text 'Kies een optie:','text-primary font-weight-bold display-4 text-center'\n\tEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Insert'\n\t\tIF EXISTS (SELECT * FROM xRepack WHERE status=@open_status AND PackDate = @date AND Company_ID = @company_id)\n\t\t\tEXEC sp_api_modal_button @name='button',@value=@button2,@valueout = @button OUT,@key='F1'\n/*\t\t\nELSE\n\t\tIF (select COUNT(id) from xlocation where company_id = @company_id ) = 1 \n\t\t\tBEGIN\n\t\t\t\tSET @only_new_is_possible = 1\n\t\t\tEND\n*/\n\tIF @button = @button1 --OR @only_new_is_possible = 1\n\t\tBEGIN\n\t\tDELETE FROM api_storage WHERE card_id = (SELECT id FROM api_card WHERE name = N'xrepack') AND child_id = 0 AND user_id = @user_id\n\t\tEXEC sp_api_modal_clear\n\t\t\tEXEC sp_api_modal_post N'xrepack',N'Company_ID',@company_id,0\n\t\t\t--EXEC sp_api_modal_post N'xrepack',N'Destination_ID',@location_id,0\n\t\t\tEXEC sp_api_modal_post N'xrepack',N'PackDate',@date,0\n\t\t\tEXEC sp_api_modal_post N'xrepack',N'Status',@open_status,0\n\t\t\t--EXEC sp_api_modal_post N'xrepack',N'advTransportDep',@date,0\n\t\t\tEXEC @new_id = sp_api_modal_save N'xrepack',0\n\t\t\tIF @new_id > 0\n\t\t\t\tBEGIN\n\t\t\t\t\tSET @goto = N'/xrepack/'+@new_id+'/xstock_ctr_ompak'\n\t\t\t\t\tEXEC sp_api_toast N'Nieuwe gestart',N'alert-primary'\n\t\t\t\t\tSET @search = N'?id='+@new_id\n\t\t\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/xrepack',@referer_search=@search\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tEXEC sp_api_toast N'Error nieuw',N'alert-danger'\n\t\t\tEXEC sp_api_modal_clear\n\t\tEND\n\tIF @button = @button2\n\t\tBEGIN\n\t\t\tSET @new_id = (SELECT TOP 1 id FROM xRepack WHERE status=@open_status AND PackDate = @date AND Company_ID = @company_id ORDER BY id DESC)\n\t\t\tSET @goto = N'/xrepack/'+@new_id+'/xstock_ctr_ompak'\n\t\t\tSET @search = N'?id='+@new_id\n\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/xrepack',@referer_search=@search\n\t\tEND\nEND",
            "action_id": 1307,
            "action_name": "Insert Order",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @company_id nvarchar(32),@button nvarchar(128),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000), @location_id nvarchar(32), @reducer nvarchar(max), @date nvarchar(128)\r\n,@button1 nvarchar(128) = N'Nieuwe correctie'\r\n,@button2 nvarchar(128) = N'Laatste open correctie'\r\nset @date = dbo.workDate()\r\nSET @company_id = 159786\r\n--EXEC sp_api_modal_select @card_name = N'packer',@value = @company_id OUT,@focus = 1\r\nSET @reducer = CONCAT('company_id = ',@company_id)\r\n\r\nIF @company_id > 0\r\nBEGIN\r\n\r\n\tDECLARE @reducer_location nvarchar(max) = N'id IN (SELECT Location_ID FROM xCompanyxLocation WHERE Company_ID =' + @company_id + ')'\r\n\tIF (SELECT LOCATIONS = count(Location_ID) FROM xCompanyxLocation WHERE Company_ID = @company_id) > 1\r\n\t\tBEGIN\r\n\t\t\tEXEC sp_api_modal_text 'Kies een correctie locatie:','text-primary'\r\n\t\t\tEXEC sp_api_modal_select @card_name = N'xlocation',@value = @location_id OUT,@focus=1,@reducer = @reducer_location\r\n\t\t\t\tIF @location_id > 0\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3',@focus=1\r\n\t\t\t\t\tEND\r\n\t\tEND\r\n\tIF (SELECT LOCATIONS = count(Location_ID) FROM xCompanyxLocation WHERE Company_ID = @company_id) = 1\r\n\t\tBEGIN\r\n\t\t\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3',@focus=1\r\n\t\tEND\r\n\r\n\tEXEC sp_api_modal_text 'Kies een optie:','text-primary font-weight-bold display-4 text-center'\r\n\tEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Insert'\r\n\t\tIF EXISTS (SELECT * FROM xTransactionHeader WHERE status=N'openCorrectie' AND CounterParty_ID = @company_id)\r\n\t\t\tEXEC sp_api_modal_button @name='button',@value=@button2,@valueout = @button OUT,@key='F1'\r\n\r\n\tIF @button = @button1\r\n\t\tBEGIN\r\n\t\tDELETE FROM api_storage WHERE card_id = (SELECT id FROM api_card WHERE name = N'correctie') AND child_id = 0 AND user_id = @user_id\r\n\t\tEXEC sp_api_modal_clear\r\n\t\t\tEXEC sp_api_modal_post N'correctie',N'CounterParty_ID',@company_id,0\r\n\t\t\tEXEC sp_api_modal_post N'correctie',N'Destination_ID',@location_id,0\r\n\t\t\tEXEC sp_api_modal_post N'correctie',N'TransactionDate',@date,0\r\n\t\t\tEXEC sp_api_modal_post N'correctie',N'advTransportDep',@date,0\r\n\t\t\tEXEC @new_id = sp_api_modal_save N'correctie',0\r\n\t\t\tIF @new_id > 0\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @goto = N'/correctie/'+@new_id+'/stock_ctr4'\r\n\t\t\t\t\tEXEC sp_api_toast N'Nieuwe correctie gestart',N'alert-primary'\r\n\t\t\t\t\tSET @search = N'?id='+@new_id\r\n\t\t\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/correctie',@referer_search=@search\r\n\t\t\t\tEND\r\n\t\t\tELSE\r\n\t\t\t\tEXEC sp_api_toast N'Error nieuwe correctie',N'alert-danger'\r\n\t\t\tEXEC sp_api_modal_clear\r\n\t\tEND\r\n\tIF @button = @button2\r\n\t\tBEGIN\r\n\t\t\tSET @new_id = (SELECT TOP 1 id FROM xTransactionHeader WHERE status=N'openCorrectie' AND CounterParty_ID = @company_id ORDER BY id DESC)\r\n\t\t\tSET @goto = N'/correctie/'+@new_id+'/stock_ctr4'\r\n\t\t\tSET @search = N'?id='+@new_id\r\n\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/correctie',@referer_search=@search\r\n\t\tEND\r\nEND",
            "action_id": 1308,
            "action_name": "Insert Order",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @company_id nvarchar(32),@button nvarchar(128),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000), @location_id nvarchar(32), @reducer nvarchar(max), @date nvarchar(128)\r\n,@button1 nvarchar(128) = N'Nieuwe retour/credit'\r\n,@button2 nvarchar(128) = N'Laatste open retour/credit'\r\nset @date = dbo.workDate()\r\nEXEC sp_api_modal_text 'Kies een klant:','text-primary'\r\nEXEC sp_api_modal_select @card_name = N'klant',@value = @company_id OUT,@focus = 1\r\nSET @reducer = CONCAT('company_id = ',@company_id)\r\n\r\nIF @company_id > 0\r\n\r\nBEGIN\r\n\r\n\tEXEC sp_api_modal_text 'Kies een locatie voor ophalen retour:','text-primary'\r\n\r\n--\tDECLARE @reducer_location nvarchar(max) = N'Company_ID = ' + @company_id + ' OR id IN (SELECT Location_ID FROM xCompanyxLocation WHERE Company_ID =' + @company_id + ')'\r\n\tDECLARE @reducer_location nvarchar(max) = N'id IN (SELECT Location_ID FROM xCompanyxLocation WHERE Company_ID =' + @company_id + ')'\r\n\tEXEC sp_api_modal_select @card_name = N'xlocation',@value = @location_id OUT,@focus=1,@reducer = @reducer_location\r\n\r\n\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3'\r\n\tEXEC sp_api_modal_text 'Kies een optie:','text-primary font-weight-bold display-4 text-center'\r\n\tEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Insert'\r\n\t\tIF EXISTS (SELECT * FROM xTransactionHeader WHERE status=N'openSaleReturn' AND CounterParty_ID = @company_id)\r\n\t\t\tEXEC sp_api_modal_button @name='button',@value=@button2,@valueout = @button OUT,@key='F1'\r\n\r\n\tIF @button = @button1 \r\n\t\tBEGIN\r\n\t\tDELETE FROM api_storage WHERE card_id = (SELECT id FROM api_card WHERE name = N'verkoop_retour') AND child_id = 0 AND user_id = @user_id\r\n\t\tEXEC sp_api_modal_clear\r\n\t\t\tEXEC sp_api_modal_post N'verkoop_retour',N'CounterParty_ID',@company_id,0\r\n\t\t\tEXEC sp_api_modal_post N'verkoop_retour',N'Destination_ID',@location_id,0\r\n\t\t\tEXEC sp_api_modal_post N'verkoop_retour',N'TransactionDate',@date,0\r\n\t\t\tEXEC sp_api_modal_post N'verkoop_retour',N'advTransportDep',@date,0\r\n\t\t\tEXEC @new_id = sp_api_modal_save N'verkoop_retour',0\r\n\t\t\tIF @new_id > 0\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @goto = N'/verkoop_retour/'+@new_id+'/ivhistory'\r\n\t\t\t\t\tEXEC sp_api_toast N'Nieuwe retour gestart',N'alert-primary'\r\n\t\t\t\t\tSET @search = N'?id='+@new_id\r\n\t\t\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/verkoop_retour',@referer_search=@search\r\n\t\t\t\tEND\r\n\t\t\tELSE\r\n\t\t\t\tEXEC sp_api_toast N'Error nieuwe verkoop_retour',N'alert-danger'\r\n\t\t\tEXEC sp_api_modal_clear\r\n\t\tEND\r\n\tIF @button = @button2\r\n\t\tBEGIN\r\n\t\t\tSET @new_id = (SELECT TOP 1 id FROM xTransactionHeader WHERE status=N'openSaleReturn' AND CounterParty_ID = @company_id ORDER BY id DESC)\r\n\t\t\tSET @goto = N'/verkoop_retour/'+@new_id+'/ivhistory'\r\n\t\t\tSET @search = N'?id='+@new_id\r\n\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/verkoop_retour',@referer_search=@search\r\n\t\tEND\r\nEND\r\n",
            "action_id": 1309,
            "action_name": "Insert Order",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128),@detail nvarchar(128),@aantal nvarchar(128),@text nvarchar(128)\nEXEC sp_api_modal_modal @class = 'w75'\nSET @date = dbo.workDate()\nSET @aantal = (SELECT stock from xstock where id = @id)\nSET @detail = (SELECT description from xstock where id = @id)\nSELECT @text = 'History van: ' + @detail + ' Huidige voorraad: ' + @aantal\nEXEC sp_api_modal_text 'VERKOOP HISTORY', 'text-primary font-weight-bold text-center display-4'\nEXEC sp_api_modal_text @text, 'text-primary font-weight-bold text-center display-4'\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n--EXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\nSET @button = 'VerkoopHistory'\n\nIF @button =  'VerkoopHistory'\nBEGIN\n\tSELECT TOP 50 [Amount] = Amount,[Counterparty] = Counterparty,[MappedCompanies] = MappedCompanies,[insUser] = insUser,[TransactionDate] = TransactionDate,[TDT] = TDT, [Stock_ID] = Stock_ID, [id] = id\n\tINTO #VerkoopHistory\n\tfrom Q_xTransactionDetail \n\twhere TDT = 2 AND Stock_ID = @id --AND dbo.daysago(TransactionDate,NULL) < 1\n\tORDER BY id DESC\n\tALTER TABLE #VerkoopHistory\n\tDROP COLUMN [Stock_ID],[TDT]\n\tEXEC sp_api_modal_table @tmptable=N'#VerkoopHistory',@orderby=N'ORDER BY TransactionDate DESC'\nEND \n",
            "action_id": 1310,
            "action_name": "Verkoop History",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "\nEXEC sp_api_modal_choose @list = N'Leverancier,Periode,Beide',@value = @button_choose OUT--,@startkey=NULL\n\nDECLARE @company_id nvarchar(32)\n\n\nDECLARE @date nvarchar(128),@button nvarchar(128)/*,@from nvarchar(128),@to nvarchar(128),*/\n\t,@datumrange nvarchar(50)\nset @date = dbo.workDate()\n\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\nIF @button_choose IN ('Beide','Periode')\n\tBEGIN\n\t\tIF @startdate IS NULL SET @startdate = @main_db.dbo.abcbom()\n\t\t--IF @enddate IS NULL SET @startdate = @main_db.dbo.abceom()\n\t\tEXEC sp_api_modal_date_from_to @from=@startdate out, @to=@enddate out,@class='w-24'\n\tEND\nIF @button_choose IN ('Beide','Leverancier')\n\tBEGIN\n\t\tEXEC sp_api_modal_select @card_name = N'leverancier',@value = @company_id OUT ,@focus = 1,@top = 3--,@select = 1\n\t\tIF @company_id IS NULL RETURN\n\tEND\n--IF @company_id IS NOT NULL EXEC sp_api_modal_focus N'geert' --blurr\nSET @button = '*KIES*'\nSET @datumrange = concat(@startdate, ' - ', @enddate)\nEXEC sp_api_modal_text @datumrange, @printonly=1\n--EXEC sp_api_modal_button @name='button',@value = 'SalesPerLot',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print @keycode = N'Ctrl+P'\n\n-- \tSELECT TransactionDate, TV_CompanyName,[currencyISO*] = currencyISO,id, [totalProductPrice@] = totalProductPrice, [DATE*] = concat(@from, ' - ', @to)\n\nIF @button_choose IS NOT NULL --=  'SalesPerLot'\nBEGIN\n\n\n\nSELECT \n\n--HENK: KOLOMMEN\nRegionName as [Regio*], Variety_0 , VTH_CODE as [VTH_CODE] ,\tContentDesc,\tSize,Detail_0\t,KGN,Origin_Code,V_AMT_IV as [Aantal@:0],V_EUR,\tFustCode\n--,\tLFDate,ITH_CODE, VTH_CODE,\tITHDT,VTHDT,\tStock_ID,\tcompleteAddress as V_ADDR\t,\t\tI_RATE,\tV_RATE, i_comp_id, V_Comp_ID,I_AMT_CTR, I_EUR\n\n\n\tINTO #RV_SalesPerLot_base\n\nFROM [RV_SalesPerLot_base] \n\twhere ithdt=1 \n\t\tand ((@Company_ID is NULL) OR i_comp_ID=@Company_ID) --counter_code like '%looy%'\n\t\tand ((@startdate IS NULL AND @enddate IS NULL) OR (LFDATE BETWEEN @startdate AND @enddate))\n\torder by RegionName,VTH_CODE, Variety_0,ContentDesc\t\n\t\n\tSET @filename = CONCAT(N'SalesPerLot',@datumrange,'.csv')\n--to csv\n\tEXEC sp_api_modal_button @name='@button_csv',@value = N'CSV', @valueout = @button_csv OUT ,@class='btn-danger',@key='F4'\n\tIF @button_csv IS NOT NULL EXEC sp_api_modal_csv @tmptable = N'#RV_SalesPerLot_base',@filename=@filename\n--print\n\tEXEC sp_api_modal_table @tmptable=N'#RV_SalesPerLot_base',@print=1 ,@orderby=N'ORDER BY 1,2,3 ASC'\nEND \n",
            "action_id": 1311,
            "action_name": "Verkoop van leverancier",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @Transport_ID INT, @TransportCompany_ID INT\nSET @Transport_ID = (SELECT Transport_ID from xlandfreight where id = @id)\nSET @TransportCompany_ID = (SELECT TransportCompany_ID from xlandfreight where id = @id)\nDECLARE @cursor_ids CURSOR,@cid INT\nDECLARE @toCompany_ID INT \nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\n\nIF @Transport_ID is null\n\tBEGIN\n\t\tEXEC sp_api_toast N'Verladingsoverzicht afdrukken voor indeling' \t\t\t\t\n\t\t\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'LF'\t,@Context_Key_ID=@TransportCompany_ID,@Report_CODE=N'verladingsoverzicht'\n\n\t\t\t\t--dit is de feitelijke \"run\"\n\t\t\t\tSET @toCompany_ID = (select top 1 id from xTenantKey) -- een CRM wordt naar tenant gestuurd/geprint\n\t\t\t\t--DECLARE @error INT\n\t\t\t\tEXEC sp_api_report_generate @id = @TransportCompany_ID\n\t\t\t\t\t,@sys_report_key = 'verladingsoverzicht' --zie xrepdef\n\t\t\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t\t\t,@fromCompany_ID = @fromCompany_ID\n\tEND\nIF @Transport_ID > 0\n\tBEGIN\n\t\tEXEC sp_api_toast N'Verladingsoverzicht afdrukken voor loods' \n\t\t\t\t EXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'LF'\t,@Context_Key_ID=@Transport_ID,@Report_CODE=N'verladingsoverzicht_loods'\n\t\t\t\t--dit is de feitelijke \"run\"\n\t\t\t\tSET @toCompany_ID = (select top 1 id from xTenantKey) -- een CRM wordt naar tenant gestuurd/geprint\n\t\t\t\t--DECLARE @error INT\n\t\t\t\tEXEC sp_api_report_generate @id = @Transport_ID\n\t\t\t\t\t,@sys_report_key = 'verladingsoverzicht_loods' --zie xrepdef\n\t\t\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t\t\t,@fromCompany_ID = @fromCompany_ID\n\tEND",
            "action_id": 1312,
            "action_name": "Verladingsoverzicht",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "Update xtransactiondetail set amount = 0, price = 0 where id = @id\r\n\r\nEXEC @main_db.dbo.DeleteCTR @ID",
            "action_id": 1313,
            "action_name": "Verwijder",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "IF @id <> @ids EXEC sp_api_modal_alert N'Alle regels verwijderen van alle geselecteerde facturen?'\n\nDECLARE @cursor CURSOR,@idval INT\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @idval\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tIF EXISTS (SELECT * FROM xInvoice WHERE id=@idval AND status = 'draft')\n\t\t\tBEGIN\n\t\t\t\tUPDATE xTransactionHeader SET status = N'ReadyForInvoice' WHERE id IN (SELECT DISTINCT cth_id FROM xInvRow WHERE invoice_id=@idval)\n\t\t\t\tdelete FROM xinvrow WHERE invoice_id=@idval\n\t\t\tEND\n\t\tELSE\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_toast N'Invoice niet in status ''Draft'''\n\t\t\tEND\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\nEXEC sp_api_modal_clear\nEXEC sp_api_modal_select_all_clear\n\n\n",
            "action_id": 1314,
            "action_name": "Verwijder de regels",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "UPDATE xTransactionHeader SET status = N'ReadyForInvoice' WHERE id IN (SELECT DISTINCT cth_id FROM xInvRow WHERE invoice_id=@ID)\ndelete FROM xinvrow WHERE invoice_id=@ID\n",
            "action_id": 1315,
            "action_name": "Verwijder de regels_voor210112",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "IF {[uitgaande_pallets].Status} in ('Departed') OR {[inkomende_pallets].Status} in ('Arrived')\n\tBEGIN\n\t\tEXEC sp_api_modal_alert N'Unable to delete, Status of xlandfreight / Pallet is \"Departed\" or \"Arrived\"'\n\t\tEXEC sp_api_modal_clear\n\t\tRETURN\n\tEND\n\t\nIF {[inkomende_landfreight].To_Location_ID} IN (SELECT ID FROM xLocation WHERE isEntrepot = 1)\n\tBEGIN\n\texec sp_api_modal_text 'De lokatie is een transito lokatie! Enkel (Richard of Sabine) kan hier iets aanpassen', 'text-danger font-weight-bold text-center display-4'\n\tRETURN\n\tEND\n\t\n-- CVG 21/10/19 Controleer of de LFCTR reeds al gelinkt is aan een verkoop welke niet meer status \"openSale\" heeft. Indien dit zo is mag ik niet meer ge unchecked worden.\nIF EXISTS (SELECT TOP 100 * FROM xIVLINK IVL WHERE EXISTS (SELECT * FROM Q_xTransactionDetail ctr where \nEXISTS (SELECT * FROM xTransactionHeader cth WHERE cth.[status] != 'openSale' AND id = ctr.transactionheader_id) \nAND ctr.id = IVL.ITD AND IVL.VTD IN (SELECT CTR_ID FROM XLFCTR WHERE ID IN ({@ids}))))\n\tBEGIN\n\tEXEC sp_api_modal_alert N'LET OP!',N'Regels zijn reeds toegewezen aan een verkoop welke niet meer de status \"openSale\" heeft. U kan de regel niet meer verwijderen.'\n\tEXEC sp_api_modal_clear\n\tRETURN\n\tEND\n\t\nDECLARE @LF_ID int\nSET @LF_ID = {[uitgaande_pallets].id}\n\nIF {[uitgaande_pallets].i_away} = 0 \n\tBEGIN\n\tEXEC sp_api_modal_post N'uitgaande_pallets',N'i_away',1,@LF_ID\n\tEXEC sp_api_modal_save N'uitgaande_pallets',@LF_ID\n\tEND\n\t\nIF @ids IS NULL OR @ids = ''\n\tBEGIN\n\t\tEXEC sp_api_modal_alert N'Unable to delete, contact your admin'\n\t\tEXEC sp_api_modal_clear\n\t\tRETURN\n\tEND\nIF @tablename LIKE 'api_%' EXEC sp_api_modal_alert N'Delete project records',N'Are you sure?'\nIF @id <> @ids EXEC sp_api_modal_alert N'Multi Delete',N'Delete multiple records - Are you sure?'\nDECLARE @sql nvarchar(max)\nDECLARE @cursor CURSOR,@idval INT\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @idval\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tSET  @sql = CONCAT(N'DELETE FROM ',QUOTENAME(ISNULL(@basetable,@tablename)),' WHERE ',QUOTENAME(@identity_column),' = ', @idval)\n\t\tEXEC(@sql);\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\n\n--EXEC @main_db.dbo.Create_ALL_Landfreight\n\nEXEC sp_api_modal_clear\nEXEC sp_api_modal_select_all_clear\n\n",
            "action_id": 1316,
            "action_name": "Verwijder Landfreight Regel",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @Code nvarchar(50) --CURRENCY, DIESEL, ...\nDECLARE @ContextID INT -- context van de huidige kaart\nDECLARE @mes nvarchar(200)--, @xDesc nvarchar(200)\nDECLARE @prijs nvarchar(20),@aantal nvarchar(20) --='100'\n\nDECLARE @xValRateID INT = {[xValRate].id}\n\nif isnull(@xValRateID,0) = 0 -- 0 bij splinternieuwe kaart, dan geen koersen zetten op deze manier\n\tBEGIN\n\n\t\t\n\n\t\t--EXEC SP_API_TOAST N'Er kan geen nieuwe waarde worden toegevoegd. Dit kan alleen op bestaande xValrate kaarten.'\n\t\t--RETURN;\n\t\tdeclare @xCURR_ID int = {[currency].id}\n\t\tdeclare @xVALID int \n\t\tif @xCURR_ID is not null\n\t\t\tselect @xVALID = id from xValue where code='CURRENCY' and ContextID=@xCURR_ID and returntype='F'\n\n\t\tif @xVALID is not null\n\t\t\tbegin\n\t\t\t\tINSERT INTO [dbo].[xValrate]\n        \t   ([xVal_ID]\n           \t\t,[code]\n           \t\t,[contextID]\n           \t\t,[F]\n           \t\t,[StartDate]\n           \t\t,[ReturnType]\n           \t\t,[EndDate])\nselect \t[ID]\n          ,[code]\n          ,[contextID]\n          ,[F]\n          ,@main_db.dbo.ABCBOM()\n          ,[ReturnType]\n          ,NULL\nfrom xvalue where id=@xVALID\n\n\t\nreturn; -- nieuw record. stoppen. Als men een koers wil ingeven, dan nog een keer klikken..\n\t\t-- we kunnen ook het nieuwe inserted ID  hier in @ContextID stoppen...\n\n\t\t\tend\n\n\t\t\t\t\n\tEND\n\n\nselect @Code=code\n\t\t, @ContextID=ContextID\n\t\t--, @CardStartDate =startdate \n\tfrom xvalrate where ID=@xValrateID\nexec sp_api_toast @code\n--return;\n\ndeclare @datum nvarchar(512)\t--input\nDECLARE @koers nvarchar(20)\t\t--input\nset @mes=N'Invoeren van een nieuwe waarde'\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\nEXEC sp_api_modal_text 'Datum'\nSET @datum = dbo.strdate(getdate())--'2020-10-30'\nEXEC sp_api_modal_date @name='Ingangsdatum:',@value= @datum OUT,@class = 'w-25' ,@focus=1\nEXEC sp_api_toast @datum\n\nEXEC sp_api_modal_text 'Waarde op deze datum:'\nEXEC sp_api_modal_input @name='koers',@value = @koers OUT\nIF @Koers>N'' SET @Koers=replace(@Koers, ',', '.') -- zorg dat punten en komma's als dec. seperator zijn toegestaan..\n\n\nDECLARE @button nvarchar(128)\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\nIF @button IS NOT NULL\n\tBEGIN\n\t\texec @main_db.dbo.SetxValRate_F \t@Code = @Code\t,@ContextID =@ContextID\t,@StartDate =@datum\t,@F =@koers\n\t\tEXEC sp_api_modal_clear\t\t\n\t\tif @Code=N'CURRENCY'\n\t\t\tbegin\n\t\t\t\tdeclare @TT nvarchar(200)=concat(N'CTHTOTALS: currency ',@ContextID,'  naar: ',@koers)\n\t\t\t\texec @main_db.dbo._Writelog @TT\n\t\t\t\tupdate T  set t.currencyXrate=@koers \n\t\t\t\tfrom xcthtotals T inner join xtransactionheader cth on cth.id=t.cth_id\n\t\t\t\twhere t.lfdate>=@datum and cth.currency_id=@contextID\n\t\t\tend\t\t\n\t\tRETURN\n\tEND\n",
            "action_id": 1317,
            "action_name": "Nieuwe Waarde",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128), @datumrange nvarchar(50)\nset @date = dbo.workDate()\n\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\nEXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\nSET @button = 'NietGeboektLijst'\nSET @datumrange = concat(@from, ' - ', @to)\nEXEC sp_api_modal_text @datumrange, @printonly=1\nEXEC sp_api_modal_button @name='button',@value = 'NietGeboektLijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print\n\n-- \tSELECT TransactionDate, TV_CompanyName,[currencyISO*] = currencyISO,id, [totalProductPrice@] = totalProductPrice, [DATE*] = concat(@from, ' - ', @to)\n\nIF @button =  'NietGeboektLijst'\nBEGIN\n\tSELECT \n\t[Order id*] = TransactionHeader_ID,\n\t[Leverancier*] = (SELECT companyname from xcompany where id = CounterParty_ID),\n\t[Order Date*] = (SELECT format(TransactionDate,'dd-MM-yyyy') FROM q_Xtransactionheader WHERE q_Xtransactionheader.id = Q_xTransactionDetail.TransactionHeader_ID), \n\t[Totaal order prijs*] = (SELECT totalProductPrice FROM q_Xtransactionheader WHERE q_Xtransactionheader.id = Q_xTransactionDetail.TransactionHeader_ID),\t\n\t[detail] = detail, \n\t[Amount@] = amount, \n\t[Price@:2] = Price, \n\t[Totaal prijs@:2] = amount * price,\n\t[Realprice@:2] = RealPrice,\n\t[Totaal RealPrice@:2] = amount * isnull(RealPrice,Price),\n\t[Boek info*] = isnull((select STRING_AGG(CASE WHEN (FACTUURNUMMER >N'' and paraaf >N'') THEN Opmerking else N'..' END ,',')  from xcth_check where CTH_ID = TransactionHeader_ID),'')\n\tINTO #NietGeboektLijst\n\tFROM Q_xTransactionDetail where TransactionHeader_ID in \n\t(SELECT id from Q_xTransactionHeader where TDT = 1 and Repack_ID is null and specialType is null and [status] = 'openPurchase'\n\tAND TransactionDate BETWEEN @from AND @to\n\tand (id not in (SELECT CTH_ID from xCTH_Check ) OR id in (SELECT CTH_ID from xCTH_Check where Paraaf is null)))\n\tEXEC sp_api_modal_table @tmptable=N'#NietGeboektLijst',@orderby=N'ORDER BY 2,3 ASC',@print=1\nEND \n",
            "action_id": 1320,
            "action_name": "Not booked",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@date2 nvarchar(128),@button nvarchar(128)\nset @date = dbo.workDate()\nset @date2 = dbo.workDate()\n/*EXEC sp_api_modal_text 'Zoek op transport bedrijf'\nEXEC sp_api_modal_input @name='Transporteur',@value = @TransComp OUT,@focus=1,@select=1 -- zoek veld\n*/\nEXEC sp_api_modal_text 'Van:'\nEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-24',@focus=1,@select=1  -- zoek veld\nEXEC sp_api_modal_text 'Tot en met:'\nEXEC sp_api_modal_date @name='Date2',@value = @date2 OUT,@class='w-24' -- zoek veld\n--SET @date2 = CONCAT(@date2,' 23:59:59.999')\nSET @button = 'OpenOmpakLijst'\nEXEC sp_api_modal_button @name='button',@value = 'OpenOmpakLijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\n--EXEC sp_api_modal_button @name='button',@value = 'GeslotenOmpakLijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F2'\nEXEC sp_api_modal_print @keycode = 'F9'\n\nIF @button =  'OpenOmpakLijst'\nBEGIN\nSELECT [IN/UIT], AMOUNT, [DETAIL~col-sm-3] = DETAIL, KGN, KGB, Size, ContentDesc, BrandName, FustCode, LVO, logistic,[TID*]--,[cthkgninCAP*],[cthkgnin*],[seperate*],[cthkgnout CAP*],[cthkgnout*]--,Status,THTDT\nINTO #OpenOmpakLijst\nFROM          RV_OMPAKBON\nWHERE\t\t(Status = 'open_repack') AND (TransactionDate BETWEEN @date AND @date2) -- (Status = 'open_repack')\nEXEC sp_api_modal_table @tmptable=N'#OpenOmpakLijst',@orderby=N'ORDER BY [TID*],3 ASC',@print=1\nEND \n/*\nIF @button =  'GeslotenOmpakLijst'\nBEGIN\nSELECT [IN/UIT], AMOUNT, [DETAIL~col-sm-3] = DETAIL, KGN, KGB, Size, ContentDesc, BrandName, FustCode, LVO, logistic,[TID*],[cthkgninCAP*],[cthkgnin*],[seperate*],[cthkgnout CAP*],[cthkgnout*]--,Status,THTDT\nINTO #GeslotenOmpakLijst\nFROM          RV_OMPAKBON\nWHERE\t\t(Status = 'open_repack') AND (TransactionDate BETWEEN @date AND @date2)\nEXEC sp_api_modal_table @tmptable=N'#GeslotenOmpakLijst',@orderby=N'ORDER BY [TID*],[cthkgninCAP*],[cthkgnin*],[seperate*],[cthkgnout CAP*],[cthkgnout*],3 ASC',@print=1\nEND \n*/",
            "action_id": 1321,
            "action_name": "OMPAKBON",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@date2 nvarchar(128),@button nvarchar(128)\nset @date = dbo.workDate()\nset @date2 = dbo.workDate()\n/*EXEC sp_api_modal_text 'Zoek op transport bedrijf'\nEXEC sp_api_modal_input @name='Transporteur',@value = @TransComp OUT,@focus=1,@select=1 -- zoek veld\n*/\nEXEC sp_api_modal_text 'Van:'\nEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-24',@focus=1,@select=1  -- zoek veld\nEXEC sp_api_modal_text 'Tot en met:'\nEXEC sp_api_modal_date @name='Date2',@value = @date2 OUT,@class='w-24' -- zoek veld\n--SET @date2 = CONCAT(@date2,' 23:59:59.999')\nSET @button = 'OpenOmpakLijst'\nEXEC sp_api_modal_button @name='button',@value = 'OpenOmpakLijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_button @name='button',@value = 'GeslotenOmpakLijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F2'\nEXEC sp_api_modal_print @keycode = 'F9'\n\nIF @button =  'OpenOmpakLijst'\nBEGIN\nSELECT [IN/UIT], AMOUNT, [DETAIL~col-sm-3] = DETAIL, KGN, KGB, Size, ContentDesc, BrandName, FustCode, LVO, logistic,[TID*],[cthkgninCAP*],[cthkgnin*],[seperate*],[cthkgnout CAP*],[cthkgnout*]--,Status,THTDT\nINTO #OpenOmpakLijst\nFROM          RV_OMPAKBON\nWHERE\t\t(Status = 'openRepack') AND (THTDT = 3) AND (TransactionDate BETWEEN @date AND @date2)\nEXEC sp_api_modal_table @tmptable=N'#OpenOmpakLijst',@orderby=N'ORDER BY [TID*],[cthkgninCAP*],[cthkgnin*],[seperate*],[cthkgnout CAP*],[cthkgnout*],3 ASC',@print=1\nEND \n\nIF @button =  'GeslotenOmpakLijst'\nBEGIN\nSELECT [IN/UIT], AMOUNT, [DETAIL~col-sm-3] = DETAIL, KGN, KGB, Size, ContentDesc, BrandName, FustCode, LVO, logistic,[TID*],[cthkgninCAP*],[cthkgnin*],[seperate*],[cthkgnout CAP*],[cthkgnout*]--,Status,THTDT\nINTO #GeslotenOmpakLijst\nFROM          RV_OMPAKBON\nWHERE\t\t(Status = 'closeRepack') AND (THTDT = 3) AND (TransactionDate BETWEEN @date AND @date2)\nEXEC sp_api_modal_table @tmptable=N'#GeslotenOmpakLijst',@orderby=N'ORDER BY [TID*],[cthkgninCAP*],[cthkgnin*],[seperate*],[cthkgnout CAP*],[cthkgnout*],3 ASC',@print=1\nEND ",
            "action_id": 1322,
            "action_name": "OMPAKBON",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128), @datumrange nvarchar(50)\nset @date = dbo.workDate()\n\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\nEXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\nSET @button = 'OmzetLijst'\nSET @datumrange = concat(@from, ' - ', @to)\nEXEC sp_api_modal_text @datumrange, @printonly=1\nEXEC sp_api_modal_button @name='button',@value = 'OmzetLijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print\n\n-- \tSELECT TransactionDate, TV_CompanyName,[currencyISO*] = currencyISO,id, [totalProductPrice@] = totalProductPrice, [DATE*] = concat(@from, ' - ', @to)\n\nIF @button =  'OmzetLijst'\nBEGIN\n\tSELECT distinct [TV_CompanyName] = concat((select code from xcompany where id = CounterParty_ID),' ',TV_CompanyName), [currencyISO*] = currencyISO, \n\t[Sum Colli@] = sum(COLFTOTALCTH)\n\t,[totalProductPrice@:2] = isnull(sum(totalProductPrice) \n\t--kortingen\n\t/ 100 * \n\t--Factuur korting percentage\n\t(isnull((select setting from xCompanyCostSettings where description_ID = 1 and xCompany_ID = q_xtransactionheader.CounterParty_ID),0) \n\t--Rabat korting percentage \n\t+ isnull((select setting from xCompanyCostSettings where xCompany_ID = q_xtransactionheader.CounterParty_ID and description_ID = 200),0) + 100)\n\t--Rabat per collo\n\t+ ISNULL(((select setting from xCompanyCostSettings where description_ID = 210 and xCompany_ID = CounterParty_ID) * \n\t(select sum(Amount) from Q_xTransactionDetail where Q_xTransactionDetail.Counterparty_ID = q_xtransactionheader.CounterParty_ID and TransactionDate BETWEEN @from AND @to)),0)\n\t--korting per collo\n\t+ ISNULL(((select setting from xCompanyCostSettings where description_ID = 8 and xCompany_ID = CounterParty_ID) * \n\t(select sum(Amount) from Q_xTransactionDetail where Q_xTransactionDetail.Counterparty_ID = q_xtransactionheader.CounterParty_ID and TransactionDate BETWEEN @from AND @to)),0)\n\n\t,ISNULL(sum(totalProductPrice),0))\n\t--[totalProductPrice@] = sum(totalProductPrice)\n\tINTO #OmzetLijst\n\tfrom q_xtransactionheader \n\twhere TDT = 2 and Repack_ID is null and (TransactionDate BETWEEN @from AND @to)\n\tGROUP BY currencyISO,TV_CompanyName,CounterParty_ID\n\tEXEC sp_api_modal_table @tmptable=N'#OmzetLijst',@orderby=N'ORDER BY 2,1 ASC',@print=1\nEND \n",
            "action_id": 1323,
            "action_name": "Omzet lijst",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @Currentstock nvarchar(128),@mes nvarchar(200), @remark nvarchar(400) \nSET @remark = {[ctr1].relation} \nif {[inkoop].status} in (N'openPurchase')\nbegin\n\tEXEC sp_api_modal_text 'Vul opmerking hieronder in:',@class = 'h3 text-muted'\n\t\n\tEXEC sp_api_modal_input @name='@remark',@max=400, @value= @remark OUT,@focus=1\n\tEXEC sp_api_modal_button @name='@button',@value = 'Opslaan', @valueout = @button OUT,@class='btn-primary',@key='Enter'\n\tIF @button IS NOT NULL\n\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_post N'ctr1',N'relation',@remark,@id\n\t\t\t\tEXEC sp_api_modal_save N'ctr1',@id\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\n\t\tEND\nend",
            "action_id": 1332,
            "action_name": "Opmerking (Relatie)",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @cursor CURSOR,@idval INT\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @idval\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tupdate xinvoice set status='exported' where status='sent' and ID=@idval\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\n\n\n",
            "action_id": 1334,
            "action_name": "Bevestig import Exact",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "SELECT q_xtransactiondetail.id, price, amount, detail = (select detail = concat(Description,' ',Origin_Code,' ',size,' ',ContentDesc) from xstock where id = stock_id) INTO #modaltmp FROM Q_xtransactiondetail WHERE TransactionHeader_ID = @id\n\nDECLARE @company_id nvarchar(32) = (SELECT counterparty_ID from xtransactionheader where id = @ID)\n\nIF {[verkoop].status} != 'OpenSale'\n\tBEGIN\n\texec sp_api_modal_text 'Order status is Gesloten', 'text-danger font-weight-bold text-center display-4'\n\tRETURN\n\tEND\n\nset @head_1 = concat(N'Geef aantal of prijzen door voor: ',(select companyname from xcompany where id=@company_id))\nexec sp_api_modal_text @head_1\n\nSELECT id, [detail ] = detail, [amount] = Amount, [price]=price INTO #modalupdatetotal FROM #modaltmp\n\nEXEC sp_api_modal_table_update @tmptable = N'#modalupdatetotal',@addnew=0--,@addnew=1\n\n-- hier heb je bijgewerkte data\nDECLARE @button1 nvarchar(128),@button_text1 nvarchar(128) = 'Opslaan'\nEXEC sp_api_modal_button @name='button1',@value = @button_text1, @valueout = @button1 OUT ,@class='btn-danger',@key='Enter'\n\nIF @button1 IS NULL RETURN\nDECLARE @price nvarchar(128) ,@TID int ,@amount int\n\nDECLARE @cursor_TD CURSOR\nSET @cursor_TD = CURSOR LOCAL FAST_FORWARD FOR\n\tSELECT id, [amount], [price] FROM #modalupdatetotal\nOPEN @cursor_TD\nFETCH NEXT FROM @cursor_TD INTO\n\t\t@TID\n\t\t,@amount\n\t\t,@price\t\n\tWHILE @@FETCH_STATUS = 0\n\t\tBEGIN\n\t\t\t--UPDATE\n\t\t\tif 1=1\n\t\t\tbegin\n\t\t\t\tupdate xtransactiondetail\n\t\t\t\t\tset amount=@amount\n\t\t\t\t\t,price=@price\n\t\t\t\t\twhere id=@TID\n--\t\t\t\t\t\t\t\tset @RealID = NULL --moet niet nodig zijn..\n\t\t\tend\t\t\t\t\t\t\t\n\t\t\tFETCH NEXT FROM @cursor_TD INTO\n\t\t@TID\n\t\t,@amount\n\t\t,@price\n\t\t\tEND\n\tCLOSE @cursor_TD;\n\tDEALLOCATE @cursor_TD;\n\t\n\t\t\tif @Button1 is NOT NULL\n\t\t\tBEGIN\n\t\t\tEXEC sp_api_modal_clear\n\t\t\tEND\n",
            "action_id": 1335,
            "action_name": "Bewerk Aantal & Prijs",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "SELECT q_xtransactiondetail.id, price, amount, detail = (select detail = concat(Description,' ',Origin_Code,' ',size,' ',ContentDesc) from xstock where id = stock_id) INTO #modaltmp FROM Q_xtransactiondetail WHERE TransactionHeader_ID = @id\n\nDECLARE @company_id nvarchar(32) = (SELECT counterparty_ID from xtransactionheader where id = @ID)\n\nIF {[verkoop].status} != 'OpenSale'\n\tBEGIN\n\texec sp_api_modal_text 'Order status is Gesloten', 'text-danger font-weight-bold text-center display-4'\n\tRETURN\n\tEND\n\nset @head_1 = concat(N'Geef aantal of prijzen door voor: ',(select companyname from xcompany where id=@company_id))\nexec sp_api_modal_text @head_1\n\nSELECT id, [detail ] = detail, [amount] = Amount, [price]=price INTO #modalupdatetotal FROM #modaltmp\n\nEXEC sp_api_modal_table_update @tmptable = N'#modalupdatetotal',@addnew=0--,@addnew=1\n\n-- hier heb je bijgewerkte data\nDECLARE @button1 nvarchar(128),@button_text1 nvarchar(128) = 'Opslaan'\nEXEC sp_api_modal_button @name='button1',@value = @button_text1, @valueout = @button1 OUT ,@class='btn-danger',@key='Enter'\n\nIF @button1 IS NULL RETURN\nDECLARE @price nvarchar(128) ,@TID int ,@amount int\n\nDECLARE @cursor_TD CURSOR\nSET @cursor_TD = CURSOR LOCAL FAST_FORWARD FOR\n\tSELECT id, [amount], [price] FROM #modalupdatetotal\nOPEN @cursor_TD\nFETCH NEXT FROM @cursor_TD INTO\n\t\t@TID\n\t\t,@amount\n\t\t,@price\t\n\tWHILE @@FETCH_STATUS = 0\n\t\tBEGIN\n\t\t\t--UPDATE\n\t\t\tif 1=1\n\t\t\tbegin\n\t\t\t\tupdate xtransactiondetail\n\t\t\t\t\tset amount=@amount\n\t\t\t\t\t,price=@price\n\t\t\t\t\twhere id=@TID\n--\t\t\t\t\t\t\t\tset @RealID = NULL --moet niet nodig zijn..\n\t\t\tend\t\t\t\t\t\t\t\n\t\t\tFETCH NEXT FROM @cursor_TD INTO\n\t\t@TID\n\t\t,@amount\n\t\t,@price\n\t\t\tEND\n\tCLOSE @cursor_TD;\n\tDEALLOCATE @cursor_TD;\n\t\n\t\t\tif @Button1 is NOT NULL\n\t\t\tBEGIN\n\t\t\tEXEC sp_api_modal_clear\n\t\t\tEND\n",
            "action_id": 1336,
            "action_name": "Bewerk Aantal & Prijs",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "/*\nDECLARE @Allowed BIT = 0 \nIF dbo.hasClaims('sub=sylvester@vgibv.nl,sub=joke@vgibv.nl,sub=nicky@vgibv.nl') > 0 OR dbo.hasRole('admin') > 0\n\tBEGIN\n\t\tSET @Allowed = 1\n\tEND\n\nIF @Allowed = 1\n\tBEGIN\n*/\t\n\t\n\tDECLARE @Factuurtotaalverdelen float\n\tEXEC sp_api_modal_input_decimal @name='@Factuurtotaalverdelen', @value=@Factuurtotaalverdelen OUT,@inline=1,@placeholder=N'Factuurtotaal'\n\n\tDECLARE @correction decimal(18,2)\n\tEXEC sp_api_modal_input_decimal @name='@correction', @value=@correction OUT,@inline=1,@placeholder=N'Correctiefactor (1,00)'\n\tIF @correction IS NULL SET @correction = 1\n\tEXEC sp_api_modal_button @name='@button_verdelen',@value = N'Factuur Totaal Verdelen', @valueout = @button_verdelen OUT ,@class='btn-danger',@key='F10'\n\tIF @Factuurtotaalverdelen = '' SET @Factuurtotaalverdelen = NULL\n\t--EXEC sp_api_modal_text @Factuurtotaalverdelen\n\tDECLARE @totPalCalc float = (SELECT SUM(lft_PalCalc+@correction) FROM xLandfreight WHERE id IN ({@IDS}))\n\tEXEC sp_api_modal_text N'',@class='p-4'\n\t--100% kopie van xCTH_Check; CTH vervangen door LF\n\tSELECT xLandfreight.id, Factuurnummer,lft_PalCalc,xLandfreight.datum,Opmerking,Transporter=(SELECT code FROM xCompany WHERE id = TransportCompany_ID),counterparty = (SELECT code FROM xCompany WHERE id = Counterparty_ID)\n\t\t,[FactuurTotaal] = CAST(ISNULL(@Factuurtotaalverdelen*(lft_PalCalc+@correction)/@totPalCalc,ISNULL(FactuurTotaal,@main_db.dbo.LF_Transport_Calculation_3(xLandfreight.id))) AS float)\n\t\t,xLF_Check_id = xLF_Check.id\n\t\tINTO #modaltmp FROM xLandfreight LEFT JOIN xLF_Check ON LF_ID = xLandfreight.id WHERE /*ISNULL(FactuurTotaal,'') > '' AND*/ xLandfreight.id IN ({@IDS})\n/*\n\tIF (SELECT COUNT(DISTINCT Factuurnummer) FROM #modaltmp) > 1 OR (SELECT COUNT(DISTINCT Opmerking) FROM #modaltmp) > 1 OR (SELECT COUNT(DISTINCT Transporter) FROM #modaltmp) > 1\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_alert N'Let op',N'Factuurnummer, Opmerking en/of Transporteur moeten gelijk zijn voor de gehele selectie'\n\t\t\tEXEC sp_api_modal_clear\n\t\t\tRETURN\n\t\tEND\n*/\n\tSET @Opmerking = (SELECT DISTINCT Opmerking FROM #modaltmp WHERE Opmerking IS NOT NULL )\n\tSET @Factuurnummer = (SELECT DISTINCT Factuurnummer FROM #modaltmp WHERE Factuurnummer IS NOT NULL)\n\tEXEC sp_api_modal_input @name='@Factuurnummer', @value= @Factuurnummer OUT--,@focus=1,@select=1\n\tEXEC sp_api_modal_input @name='@Opmerking', @value= @Opmerking OUT\n\n\tSELECT id, [counterparty ] = counterparty,[datum ] = dbo.formatdate(datum),[lft_PalCalc ] = lft_PalCalc,[FactuurTotaal] = FactuurTotaal,[xLF_Check_id-]=xLF_Check_id--,ert=CONCAT(N'',id)\n\t\tINTO #modalupdatetotal FROM #modaltmp\n\tDECLARE @identifier nvarchar(256) = CONCAT(N'',@Factuurtotaalverdelen,@correction)\n\tEXEC sp_api_modal_table_update @tmptable = N'#modalupdatetotal',@focusx = 3,@focusy = 1,@identifier=@identifier--,@addnew=1\n\n\t/*\n\tSELECT id, Factuurnummer, Opmerking,FactuurTotaal,[LF_id ]=LF_id--, [Username ] = Username --,Aantal = CAST(NULL as decimal(18,4)) \n\t\tINTO #modalupdate FROM xLF_Check where ISNULL(FactuurTotaal,'') = '' AND  LF_ID IN ({@IDS}) --AND (trim(isnull(Factuurnummer,N'')) > N'' OR trim(isnull(Opmerking,N'')) > N'')\n\tEXEC sp_api_modal_table_update @tmptable = N'#modalupdate',@addnew=1,@showheader = 0\n\t*/\n\t-- hier heb je bijgewerkte data\n\tDECLARE @button1 nvarchar(128),@button_text1 nvarchar(128) = 'Opslaan'\n\tEXEC sp_api_modal_button @name='button1',@value = @button_text1, @valueout = @button1 OUT ,@class='btn-danger',@key='Enter'\n\t--DECLARE @code nvarchar(100)= (SELECT TOP 1 code from #modalupdate ORDER BY code DESC )\n\t--EXEC sp_api_modal_text @code\n\tIF (ISNULL(@Opmerking,'') = '' OR ISNULL(@Factuurnummer,'')  = '') AND @button1 IS NOT NULL\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_text N'Factuurnummer of Opmerking moet ingevuld zijn'\n\t\t\tRETURN\n\t\tEND\n\tIF @button1 IS NULL RETURN\n\t--EXEC sp_api_modal_table @tmptable = N'#modalupdatetotal'--,@addnew=1\n\t--RETURN\n\t--test:EXEC sp_api_modal_text N'Result:',N'h4 text-muted'\n\t--EXEC sp_api_modal_table @tmptable = N'#modalupdate'\n\t--RETURN\n\t--cursortje\n\tDECLARE @FactuurTotaal nvarchar(128) ,@xLF_Check_id int ,@LF_ID int\n\tDECLARE @cursor_xLF_Check CURSOR\n\tSET @cursor_xLF_Check = CURSOR LOCAL FAST_FORWARD FOR\n\t\tSELECT id,FactuurTotaal, [xLF_Check_id-] FROM #modalupdatetotal\n\tOPEN @cursor_xLF_Check\n\tFETCH NEXT FROM @cursor_xLF_Check INTO\n\t\t\t@LF_ID\n\t\t\t,@FactuurTotaal\n\t\t\t,@xLF_Check_id\n\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\n\t\t\t\tif 1=1 -- RH210111 geen conditie meer, ivm leeg kunnen maken van een nummer!\n\t\t\t\t\tbegin\n\t\t\t\t\t\t--EXEC sp_api_toast @FactuurTotaal\n\t\t\t\t\t\t--select @Realid=id from xLF_check where id=@checkid and LF_id=@ID\n\t\t\t\t\t\tif @xLF_Check_id IS NULL\n\t\t\t\t\t\t\t--ADD\n\t\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\t\t--EXEC sp_api_modal_text @checkid\n\t\t\t\t\t\t\t\tINSERT INTO xLF_check (Factuurnummer, Opmerking,FactuurTotaal,LF_id,username)\n\t\t\t\t\t\t\t    VALUES (@Factuurnummer,@Opmerking,@FactuurTotaal,@LF_ID,@User)\n\t\t\t\t\t\t\tend\n\t\t\t\t\t\tELSE\n\t\t\t\t\t\t\t--UPDATE\n\t\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\t\tupdate xLF_check\n\t\t\t\t\t\t\t\t\tset Factuurnummer=@Factuurnummer\n\t\t\t\t\t\t\t\t\t\t,Opmerking=@Opmerking\n\t\t\t\t\t\t\t\t\t\t,FactuurTotaal=@FactuurTotaal\n\t\t\t\t\t\t\t\t\twhere id=@xLF_Check_id\n\t--\t\t\t\t\t\t\t\tset @RealID = NULL --moet niet nodig zijn..\n\t\t\t\t\t\t\tend\n\t\t\t\t\tend\t\t\t\t\t\n\t\t\t\t\t\t\t\t\n\t\t\t\tFETCH NEXT FROM @cursor_xLF_Check INTO\n\t\t\t@LF_ID\n\t\t\t,@FactuurTotaal\n\t\t\t,@xLF_Check_id\n\t\t\t\t\t\tEND\n\t\tCLOSE @cursor_xLF_Check;\n\t\tDEALLOCATE @cursor_xLF_Check;\n\t\t\n\t\t--210111 VERWIJDER RECORDS WAAR GEEN FACTUURNUMMER OF OPMERKING STAAT !\n\t\tdelete from xLF_Check where  LF_id IN ({@IDS}) AND trim(isnull(Factuurnummer,N''))=N'' AND  trim(isnull(Opmerking,N''))=N''\n\t\t--return\n\t\tif @Button1 is NOT NULL\n\t\t\tEXEC sp_api_modal_clear\n\t\t\tEXEC sp_api_modal_select_all_clear\n/*\t\n\tEND\n\nIF @Allowed = 0\n\tBEGIN\n\t\tEXEC sp_api_modal_text N'U mag dit niet doen!','h2 text-danger font-weight-bold text-center'\nEND\n*/",
            "action_id": 1337,
            "action_name": "boek_vracht_multi",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_modal @class=N'w75'\n--exec sp_api_toast @User\nDECLARE @search nvarchar(128) = {[factuurcontrole_inkoop].CounterParty_ID.Code} \nDECLARE @button nvarchar(128),@Description nvarchar(max), @mes nvarchar(128)\nDECLARE @Counterparty_ID INT ={[factuurcontrole_inkoop].Counterparty_ID}\nDECLARE @CTHID INT = {[factuurcontrole_inkoop].id} \nIF @CTHID IS NULL begin\n\t\tEXEC sp_api_toast 'Kan geen inkoop vinden'\n\t\tRETURN;\n\t\tend\n\ndeclare @Status nvarchar(50)={[factuurcontrole_inkoop].status} \nIF @Status not in ('openPurchase') \n\tBEGIN --200924 fust mag wel worden bij of afgeboekt\n\t\tEXEC sp_api_modal_alert 'U kunt alleen ....'\n\t\tEXEC sp_api_modal_clear\t\t\n\t\tRETURN;\t\n\tend\n\n------WE KUNNEN BEGINNEN :\n\n\nDECLARE @Factnr nvarchar(50)\ndeclare @xcth_check_ID int -- kijk of er al een id bestaat\ndeclare @AantalFacturen int\ndeclare @Opmerking nvarchar(128)\n\nset @AantalFacturen=  (select count(id) from xcth_check where xcth_check.cth_id=@CTHID )\n\nif @AantalFacturen is null -- NIEUW, NOG GEEN FACTUREN\n \tbegin\n \t\texecute sp_api_toast N'nieuwe registratie'\n \tend\nif @AantalFacturen = 1 -- Een inkomende Factuur\n\tbegin\n\t\tselect @xcth_check_ID=id\n\t\t\t\t,@factnr=Factuurnummer\n\t\t\t\t,@Opmerking=Opmerking\n\t\t from xcth_check where xcth_check.cth_id=@CTHID \n\n\tend\t\n\nif @AantalFacturen > 1 \n\tbegin --MEERDERE FACTUREN !!!\n\t\texec sp_api_toast N'MEERDERE FACTUREN !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!'\n\tend\n\n\t\n\n\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\nDECLARE @prijs nvarchar(20),@aantal nvarchar(20) --='100'\n\n--DECLARE @CounterpartyID int\n\nset @mes=N'invullen'\ndeclare @buttonvalue nvarchar(128) = 'Factuur Boeken'\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\nSET @text = N'Factuur nummer / referentie'\nEXEC sp_api_modal_text @text\nDECLARE @focus BIT = 1\nEXEC sp_api_modal_input @name='Factnr',@value = @factnr OUT,@focus=@focus,@inline = 0\nEXEC sp_api_modal_input @name='Opmerking',@value = @Opmerking OUT,@inline = 0--,@focus=@focus\n--EXEC sp_api_modal_input @name='Factuurbedrag',@value = @aantal OUT,@focus=@focus,@inline = 0\nEXEC sp_api_modal_button @name='button',@value = @buttonvalue,@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\n--IF @button IS NOT NULL exec sp_api_modal_clear --klaar, close modal (\n--RETURN\n\nIF @button IS NOT NULL\n\tBEGIN\n--\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') -- 200924 zorg dat je ook komma mag gebruiken als decimaal scheidingsteken\n--\t\tIF \t((ISNULL(@Prijs,N'')=N'' OR\ttry_cast(@prijs as decimal(10,2)) > 0) AND \tTRY_CAST(@aantal as int) >\t 0 ) \n\t\tif @factnr is not null\n\t\t\t\t\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text @factnr,'text-danger'\n\t\t\t\t\n\t\t\t\tif @xcth_check_ID is null\n\t\t\t\t\tbegin\n\t\t\t\t\t\tinsert into xCTH_CHECK (CTH_ID,Opmerking,Factuurnummer,Username) values(@CTHID,@Opmerking,@factnr,@user)\n\t\t\t\t\tend\n\t\t\t\tif @xcth_check_ID is NOT null\n\t\t\t\t\tbegin\t\n\t\t\t\t\t\tupdate xCTH_CHECK set Factuurnummer=@factnr,Opmerking=@Opmerking where id=@xcth_check_ID\n\t\t\t\t\tend\n\t\t\t\texec sp_api_modal_clear --klaar, close modal (\n\t\t\tEND\n\t\tELSE\n\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\tEND\n",
            "action_id": 1338,
            "action_name": "BOEK-oud",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128),@detail nvarchar(128),@aantal nvarchar(128),@text nvarchar(128),@currency_id nvarchar(128)\n,@country_id nvarchar(128),@CountryGroupID nvarchar(128), @filename nvarchar(1024)\nEXEC sp_api_modal_modal @class = 'w100'\nSET @date = dbo.workDate()\nSET @filename = dbo.strdate(NULL)+'_'+'Invoerrechten.csv'\nSET @currency_id = 3\nSELECT @text = 'History van: ' + @detail + ' Huidige voorraad: ' + @aantal\nEXEC sp_api_modal_text @text, 'text-primary font-weight-bold text-center display-4'\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n--EXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\nSET @button = 'CalculatieInvoerrechten'\nEXEC sp_api_modal_button @name='button',@value = 'CalculatieInvoerrechten',@valueout = @button OUT,@class = 'btn-primary'--,@key = '1'\nEXEC sp_api_modal_button @name='button',@value = 'CalculatieDownload',@valueout = @button OUT,@class = 'btn-success'\nEXEC sp_api_modal_print\n\nEXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\nEXEC sp_api_modal_text 'Koers:'\nEXEC sp_api_modal_select @card_name = N'currency',@value = @currency_id OUT\nEXEC sp_api_modal_text 'Verkocht aan Land:'\nEXEC sp_api_modal_select @card_name = N'country',@value = @country_id OUT\nEXEC sp_api_modal_text 'CountryGroup van producten:'\nEXEC sp_api_modal_select @card_name = N'country_group',@value = @CountryGroupID OUT\n/*\nEXEC sp_api_modal_select @card_name = N'klant',@value = @company_id OUT\nEXEC sp_api_modal_select @card_name = N'klant',@value = @company_id OUT\n*/\n\nIF @button =  'CalculatieInvoerrechten'\nBEGIN\nSELECT\n[Amount@] = sum(Amount)\n,detail\n,Origin_Code\n,[KGN@] = KGN\n/*\n,ContentDesc\n,xBrandCode\n,KGB\n,KGN\n,Size\n,[Gemiddelde prijs@] = sum(amount*price)/sum(amount)\n,[KOERS*] = (SELECT koers = Actual from Q_xcurrency where id = @currency_id)\n,[Price in euro@] = sum(amount*price) *  (SELECT koers = Actual from Q_xcurrency where id = @currency_id)\n*/\n,[totaal prijs@] = sum(amount*price)\n,[HEFPERC] = (SELECT isnull(HEFPERC,0) FROM @main_db.dbo.Heffing_xStock(Stock_ID))\n,[HEFKGN] = (SELECT isnull(HEF100KGN,0) FROM @main_db.dbo.Heffing_xStock(Stock_ID))\n,[Totaal Perc inv in \u00a3@:2] = sum(amount*price) / 100 * (SELECT isnull(HEFPERC,0) FROM @main_db.dbo.Heffing_xStock(Stock_ID))\n,[totaal inv per kg in \u00a3@:2] = sum(Amount*KGN) * (SELECT isnull(HEF100KGN,0) / 100 FROM @main_db.dbo.Heffing_xStock(Stock_ID))\nINTO #CalculatieInvoerrechten\nfrom q_xtransactiondetail \nwhere (TransactionDate BETWEEN @from AND @to)\nAND CounterParty_ID in (select id from xcompany where Country_ID = @country_id)\nAND TDT = 2 AND Repack_ID is null AND transactionheader_id in (select id from q_xtransactionheader where specialtype is null)\nAND Stock_ID in (select id from xstock where Origin_ID in (select Countryid from xcountry where CountryGroupID = @CountryGroupID))\ngroup by detail,Origin_Code,KGN,Stock_ID /*,ContentDesc,xBrandCode,KGB,KGN,Size*/\nORDER BY detail ASC\n\tEXEC sp_api_modal_table @tmptable=N'#CalculatieInvoerrechten',@orderby=N'ORDER BY detail ASC',@print=1\nEND \n\nIF @button =  'CalculatieDownload'\nBEGIN\nSELECT\n[Amount@] = sum(Amount)\n,detail\n,Origin_Code\n,[KGN@] = KGN\n/*\n,ContentDesc\n,xBrandCode\n,KGB\n,KGN\n,Size\n,[Gemiddelde prijs@] = sum(amount*price)/sum(amount)\n,[KOERS*] = (SELECT koers = Actual from Q_xcurrency where id = @currency_id)\n,[Price in euro@] = sum(amount*price) *  (SELECT koers = Actual from Q_xcurrency where id = @currency_id)\n*/\n,[totaal prijs@] = sum(amount*price)\n,[HEFPERC] = (SELECT isnull(HEFPERC,0) FROM @main_db.dbo.Heffing_xStock(Stock_ID))\n,[HEFKGN] = (SELECT isnull(HEF100KGN,0) FROM @main_db.dbo.Heffing_xStock(Stock_ID))\n,[Totaal Perc inv in \u00a3@:2] = sum(amount*price) / 100 * (SELECT isnull(HEFPERC,0) FROM @main_db.dbo.Heffing_xStock(Stock_ID))\n,[totaal inv per kg in \u00a3@:2] = sum(Amount*KGN) * (SELECT isnull(HEF100KGN,0) / 100 FROM @main_db.dbo.Heffing_xStock(Stock_ID))\nINTO #CalculatieDownload\nfrom q_xtransactiondetail \nwhere (TransactionDate BETWEEN @from AND @to)\nAND CounterParty_ID in (select id from xcompany where Country_ID = @country_id)\nAND TDT = 2 AND Repack_ID is null AND transactionheader_id in (select id from q_xtransactionheader where specialtype is null)\nAND Stock_ID in (select id from xstock where Origin_ID in (select Countryid from xcountry where CountryGroupID = @CountryGroupID))\ngroup by detail,Origin_Code,KGN,Stock_ID/*,ContentDesc,xBrandCode,KGB,KGN,Size*/\nEXEC sp_api_modal_csv @tmptable=N'#CalculatieDownload',@orderby=N'ORDER BY detail ASC',@filename=@filename, @ansi=1\nEND\n",
            "action_id": 1339,
            "action_name": "Calculatie invoerrechten",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_text 'Calculator',N'mt-4 h5'\r\nDECLARE @calc nvarchar(256) = '0',@button nvarchar(128),@result nvarchar(1000),@sql nvarchar(1000)\r\nEXEC sp_api_modal_input @name='calc',@value = @calc OUT,@focus=1,@select=1\r\n\r\nEXEC sp_api_modal_button @name='button',@value = 'Bereken',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\r\nBEGIN TRY\r\n\r\nDECLARE @KeepValues nvarchar(50) = N'%[^0-9+*/().-]%'\r\n    While PATINDEX(@KeepValues, @calc) > 0\r\n        Set @calc = Stuff(@calc, PatIndex(@KeepValues, @calc), 1, '')\r\n\tSET @result = @calc +' = '\r\n\tSET @sql = N'SET @calc = TRY_CAST((1.0*'+@calc+') as decimal(18,2))'\r\n\tSET @calc = 0\r\n\tEXEC sp_executesql @sql,N'@calc decimal(18,2) OUT',@calc OUT\r\n\tSET @result+= @calc\r\nEND TRY BEGIN CATCH\r\n\tSET @result+= 'Err'\r\n END CATCH\r\nEXEC sp_api_modal_text @result\r\n",
            "action_id": 1340,
            "action_name": "Calculator",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @company_id nvarchar(32),@button nvarchar(128),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000), @location_id nvarchar(32), @reducer nvarchar(max), @date nvarchar(128)\r\n,@button1 nvarchar(128) = N'Nieuwe retour/credit'\r\n,@button2 nvarchar(128) = N'Laatste open retour/credit'\r\nset @date = dbo.workDate()\r\nEXEC sp_api_modal_text 'Kies een leverancier:','text-primary'\r\nEXEC sp_api_modal_select @card_name = N'leverancier',@value = @company_id OUT,@focus = 1\r\nSET @reducer = CONCAT('company_id = ',@company_id)\r\n\r\nIF @company_id > 0\r\n\r\nBEGIN\r\n\r\n\tEXEC sp_api_modal_text 'Kies een locatie voor terugsturen retour:','text-primary'\r\n\r\n--\tDECLARE @reducer_location nvarchar(max) = N'Company_ID = ' + @company_id + ' OR id IN (SELECT Location_ID FROM xCompanyxLocation WHERE Company_ID =' + @company_id + ')'\r\n\tDECLARE @reducer_location nvarchar(max) = N'id IN (SELECT Location_ID FROM xCompanyxLocation WHERE Company_ID =' + @company_id + ')'\r\n\tEXEC sp_api_modal_select @card_name = N'xlocation',@value = @location_id OUT,@focus=1,@reducer = @reducer_location\r\n\r\n\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3'\r\n\tEXEC sp_api_modal_text 'Kies een optie:','text-primary font-weight-bold display-4 text-center'\r\n\tEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Insert'\r\n\t\tIF EXISTS (SELECT * FROM xTransactionHeader WHERE status=N'openPurchaseReturn' AND CounterParty_ID = @company_id)\r\n\t\t\tEXEC sp_api_modal_button @name='button',@value=@button2,@valueout = @button OUT,@key='F1'\r\n\r\n\tIF @button = @button1 \r\n\t\tBEGIN\r\n\t\tDELETE FROM api_storage WHERE card_id = (SELECT id FROM api_card WHERE name = N'inkoop_retour') AND child_id = 0 AND user_id = @user_id\r\n\t\tEXEC sp_api_modal_clear\r\n\t\t\tEXEC sp_api_modal_post N'inkoop_retour',N'CounterParty_ID',@company_id,0\r\n\t\t\tEXEC sp_api_modal_post N'inkoop_retour',N'Destination_ID',@location_id,0\r\n\t\t\tEXEC sp_api_modal_post N'inkoop_retour',N'TransactionDate',@date,0\r\n\t\t\tEXEC sp_api_modal_post N'inkoop_retour',N'advTransportDep',@date,0\r\n\t\t\tEXEC @new_id = sp_api_modal_save N'inkoop_retour',0\r\n\t\t\tIF @new_id > 0\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @goto = N'/inkoop_retour/'+@new_id+'/ivhistory'\r\n\t\t\t\t\tEXEC sp_api_toast N'Nieuwe retour gestart',N'alert-primary'\r\n\t\t\t\t\tSET @search = N'?id='+@new_id\r\n\t\t\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/inkoop_retour',@referer_search=@search\r\n\t\t\t\tEND\r\n\t\t\tELSE\r\n\t\t\t\tEXEC sp_api_toast N'Error nieuwe inkoop_retour',N'alert-danger'\r\n\t\t\tEXEC sp_api_modal_clear\r\n\t\tEND\r\n\tIF @button = @button2\r\n\t\tBEGIN\r\n\t\t\tSET @new_id = (SELECT TOP 1 id FROM xTransactionHeader WHERE status=N'openPurchaseReturn' AND CounterParty_ID = @company_id ORDER BY id DESC)\r\n\t\t\tSET @goto = N'/inkoop_retour/'+@new_id+'/ivhistory'\r\n\t\t\tSET @search = N'?id='+@new_id\r\n\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/inkoop_retour',@referer_search=@search\r\n\t\tEND\r\nEND\r\n",
            "action_id": 1341,
            "action_name": "Insert Order",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @prodtariffid nvarchar(32),@button nvarchar(128),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000), @xprodID nvarchar(128), @reducer nvarchar(max), @date nvarchar(128), @OriginID nvarchar(128), @Active nvarchar(128), @newheffing_id nvarchar(32),@product nvarchar(128), @Productvermelding nvarchar(128)\n,@button1 nvarchar(128) = N'Nieuw Product Tariff'\nset @date = dbo.workDate()\nSET @product = (SELECT Description from xstock where id = @id)\nSET @Productvermelding = 'U gaat een tariff toevoegen voor: ' + @product \n\nSET @prodtariffid = (SELECT ID FROM xProdTariff xpt WHERE xProduct_ID = (SELECT xProduct_ID from xstock where id = @id AND Origin_ID = xpt.xCountry_ID))\nSET @xprodID = (SELECT xProduct_ID FROM xstock WHERE id = @id)\nSET @OriginID = (SELECT Origin_ID FROM xstock WHERE id = @id)\nSET @Active = 1\n\nIF @prodtariffid is null\n\nBEGIN\nEXEC sp_api_modal_text @Productvermelding,'text-primary'\nEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Insert'\n\n\tIF @button = @button1 --OR @only_new_is_possible = 1\n\t\tBEGIN\n\t\tDELETE FROM api_storage WHERE card_id = (SELECT id FROM api_card WHERE name = N'xstock') AND child_id = 0 AND user_id = @user_id\n\t\tEXEC sp_api_modal_clear\n\t\t\tEXEC sp_api_modal_post N'xprodtariff',N'xProduct_ID',@xprodID,0\n\t\t\tEXEC sp_api_modal_post N'xprodtariff',N'xCountry_ID',@OriginID,0\n\t\t\tEXEC sp_api_modal_post N'xprodtariff',N'Active',@Active,0\n\t\t\tEXEC @new_id = sp_api_modal_save N'xprodtariff',0\n\t\t\tIF @new_id > 0\n\t\t\t\tBEGIN\n\n\t\t\t\tSET @goto = N'/xprodtariff/'+@new_id+'/heffingverloop'\n\t\t\t\tEXEC sp_api_toast N'Nieuw Product Tariff gestart',N'alert-primary'\n\t\t\t\tSET @search = N'?id='+@id\n\t\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/xstock',@referer_search=@search\n\t\t\t\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tEXEC sp_api_toast N'Error nieuw tariff',N'alert-danger'\n\t\t\tEXEC sp_api_modal_clear\n\t\tEND\nEND\n\nIF @prodtariffid > 0\n\tBEGIN\n\t\t\t\tSET @goto = N'/xprodtariff/'+@prodtariffid+'/heffingverloop'\n\t\t\t\tEXEC sp_api_toast N'U gaat nu naar de heffingverloop van dit Product',N'alert-primary'\n\t\t\t\tSET @search = N'?id='+@id\n\t\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/xstock',@referer_search=@search\n\tEND\n",
            "action_id": 1342,
            "action_name": "Insert ProdTariff",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--RH 210217 Actie voor Child-keuze\nIF isnull({[invoice].isManual},0) =1 \n\tBEGIN\n\t\texec sp_api_modal_alert N'U gaat nu naar een handmatige factuur..'\n\t\texec sp_api_modal_clear\n\t\tSET @path = @path+'/'+@id+'/invrow_manual'\n\tEND\nELSE\n\tBEGIN\n\t\tSET @path = @path+'/'+@id+'/invrow'\n\tEND\n\t\nEXEC sp_api_goto @path\n",
            "action_id": 1343,
            "action_name": "Invrow",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @search nvarchar(128) ,@button nvarchar(128), @doctype nvarchar(128) \nDECLARE @filename nvarchar(1024) = dbo.strdate(NULL)+'_'+@id+'_'+'KCB.csv'\n--EXEC sp_api_modal_input @name='search',@value = @search OUT,@focus=1 -- zoek veld\nSET @doctype = (select xtransportdoc.DocType from xtransportdoc where xtransportdoc.id = @id)\nSET @button = 'KCB'\n--EXEC sp_api_modal_button @name='button',@value = 'KCB',@valueout = @button OUT,@class = 'btn-primary',@key = '1'\nEXEC sp_api_modal_button @name='button',@value = 'NaarCSV',@valueout = @button OUT,@class = 'btn-success',@key = '1'\n\nIF @doctype = 'KCB'\nBEGIN\n\tIF @button =  'KCB'\n\tBEGIN\n\t\tSELECT [x/nummer],[x/aantal],[x/product_naam],[x/artikelomschrijving_cft],[e/origine]\n\t\tINTO #KCB\n\t\tFROM          RV_KCBDOCUMENT\n\t\tWHERE        (id = @id) and ([x/product_naam] is not null)\n\t\tEXEC sp_api_modal_table @tmptable=N'#KCB'--,@orderby=N'ORDER BY [CAP*],Description ASC'\n\tEND\n\n\t\tIF @button =  'NaarCSV'\n\t\tBEGIN\n\t\t\t\tSELECT *--[x/nummer],[x/aantal],[x/product_naam],[x/artikelomschrijving_cft],[e/origine]\n\t\t\t\tINTO #KCBCSV\n\t\t\t\tFROM          RV_KCBDOCUMENT\n\t\t\t\tWHERE        (id = @id) and ([x/product_naam] is not null)\n\t\t\t\tALTER TABLE #KCBCSV drop column id\n\t\t\t\t--DECLARE @eol nvarchar(10) = CHAR(10)\n\t\t\t\tEXEC sp_api_modal_csv @tmptable=N'#KCBCSV',@orderby=N'ORDER BY [x/nummer]', @filename=@filename,@ansi=1 --,@eol=@eol\n\t\t\t\tEXEC sp_api_modal_text 'Huidige regels zijn gedownload','text-primary font-weight-bold h2 text-center mt-5'\n\t\t\t\t\tSELECT [x/nummer],[x/aantal],[x/product_naam],[x/artikelomschrijving_cft],[e/origine]\n\t\t\t\t\tINTO #KCBD\n\t\t\t\t\tFROM          RV_KCBDOCUMENT\n\t\t\t\t\tWHERE        (id = @id) and ([x/product_naam] is not null)\n\t\t\t\t\tEXEC sp_api_modal_table @tmptable=N'#KCBD'--,@orderby=N'ORDER BY [CAP*],Description ASC'\n\t\tEND\nEND\nIF @doctype != 'KCB' \nBEGIN\n\t\tEXEC sp_api_modal_text 'Huidige regel is niet KCB','text-danger font-weight-bold h2 text-center'\nEND\n",
            "action_id": 1344,
            "action_name": "KCB CSV",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @search nvarchar(128) ,@button nvarchar(128), @doctype nvarchar(128) \nDECLARE @filename nvarchar(1024) = dbo.strdate(NULL)+'_'+@id+'_'+'KCB.csv'\n--EXEC sp_api_modal_input @name='search',@value = @search OUT,@focus=1 -- zoek veld\nSET @doctype = (select xtransportdoc.DocType from xtransportdoc where xtransportdoc.id = @id)\nSET @button = 'KCB'\n--EXEC sp_api_modal_button @name='button',@value = 'KCB',@valueout = @button OUT,@class = 'btn-primary',@key = '1'\nEXEC sp_api_modal_button @name='button',@value = 'NaarCSV',@valueout = @button OUT,@class = 'btn-success',@key = '1'\n\nSELECT [x/nummer],[x/aantal],[x/product_naam],[x/artikelomschrijving_cft],[e/origine]\nINTO #KCB\nFROM          RV_KCBDOCUMENT_DS\nWHERE        (id = @id) and ([x/product_naam] is not null)\nEXEC sp_api_modal_table @tmptable=N'#KCB'--,@orderby=N'ORDER BY [CAP*],Description ASC'\n\nIF @button =  'NaarCSV'\nBEGIN\n\t\tSELECT *--[x/nummer],[x/aantal],[x/product_naam],[x/artikelomschrijving_cft],[e/origine]\n\t\tINTO #KCBCSV\n\t\tFROM          RV_KCBDOCUMENT_DS\n\t\tWHERE        (id = @id) and ([x/product_naam] is not null)\n\t\tALTER TABLE #KCBCSV drop column id\n\t\t--DECLARE @eol nvarchar(10) = CHAR(10)\n\t\tEXEC sp_api_modal_csv @tmptable=N'#KCBCSV',@orderby=N'ORDER BY [x/nummer]', @filename=@filename,@ansi=1 --,@eol=@eol\n\t\tEXEC sp_api_modal_text 'Huidige regels zijn gedownload','text-primary font-weight-bold h2 text-center mt-5'\n\t\t\tSELECT [x/nummer],[x/aantal],[x/product_naam],[x/artikelomschrijving_cft],[e/origine]\n\t\t\tINTO #KCBD\n\t\t\tFROM          RV_KCBDOCUMENT_DS\n\t\t\tWHERE        (id = @id) and ([x/product_naam] is not null)\n\t\t\tEXEC sp_api_modal_table @tmptable=N'#KCBD'--,@orderby=N'ORDER BY [CAP*],Description ASC'\nEND",
            "action_id": 1345,
            "action_name": "KCB CSV",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @search nvarchar(128) ,@button nvarchar(128), @doctype nvarchar(128) \r\nDECLARE @filename nvarchar(1024) = dbo.strdate(NULL)+'_'+@id+'_'+'KCB.json'\r\n--EXEC sp_api_modal_input @name='search',@value = @search OUT,@focus=1 -- zoek veld\r\nSET @doctype = (select xtransportdoc.DocType from xtransportdoc where xtransportdoc.id = @id)\r\nSET @button = 'KCB'\r\nEXEC sp_api_modal_button @name='button',@value = 'KCB',@valueout = @button OUT,@class = 'btn-primary',@key = '1'\r\nEXEC sp_api_modal_button @name='button',@value = 'Naar JSON',@valueout = @button OUT,@class = 'btn-success',@key = '2'\r\n\r\nIF @doctype = 'KCB'\r\nBEGIN\r\n\tIF @button =  'KCB'\r\n\tBEGIN\r\n\t\tSELECT [x/nummer],[x/aantal],[x/product_naam],[x/artikelomschrijving_cft],[e/origine]\r\n\t\tINTO #KCB\r\n\t\tFROM          RV_KCBDOCUMENT\r\n\t\tWHERE        (id = @id) and ([x/product_naam] is not null)\r\n\t\tEXEC sp_api_modal_table @tmptable=N'#KCB'--,@orderby=N'ORDER BY [CAP*],Description ASC'\r\n\tEND\r\n\r\n\t\tIF @button =  'Naar JSON'\r\n\t\tBEGIN\r\n\t\t\t\tSELECT *--[x/nummer],[x/aantal],[x/product_naam],[x/artikelomschrijving_cft],[e/origine]\r\n\t\t\t\tINTO #KCBCSV\r\n\t\t\t\tFROM          RV_KCBDOCUMENT\r\n\t\t\t\tWHERE        (id = @id) and ([x/product_naam] is not null)\r\n\t\t\t\tALTER TABLE #KCBCSV drop column id\r\n\t\t\t\tDECLARE @json nvarchar(max) = (SELECT * FROM #KCBCSV FOR JSON PATH,INCLUDE_NULL_VALUES)\r\n\t\t\t\tDECLARE @rawdata varbinary(max) = CAST(@json AS varbinary(max))\r\n\t\t\t\tEXEC sp_api_modal_download @filename=@filename,@rawdata = @rawdata\r\n\t\t\t\t--EXEC sp_api_modal_csv @tmptable=N'#KCBCSV',@orderby=N'ORDER BY [x/nummer]', @filename=@filename,@ansi=1 --,@eol=@eol\r\n\t\t\t\tEXEC sp_api_modal_text 'Huidige regels zijn gedownload','text-primary font-weight-bold h2 text-center mt-5'\r\n\t\t\t\t\tSELECT [x/nummer],[x/aantal],[x/product_naam],[x/artikelomschrijving_cft],[e/origine]\r\n\t\t\t\t\tINTO #KCBD\r\n\t\t\t\t\tFROM          RV_KCBDOCUMENT\r\n\t\t\t\t\tWHERE        (id = @id) and ([x/product_naam] is not null)\r\n\t\t\t\t\tEXEC sp_api_modal_table @tmptable=N'#KCBD'--,@orderby=N'ORDER BY [CAP*],Description ASC'\r\n\t\tEND\r\nEND\r\nIF @doctype != 'KCB' \r\nBEGIN\r\n\t\tEXEC sp_api_modal_text 'Huidige regel is niet KCB','text-danger font-weight-bold h2 text-center'\r\nEND\r\n",
            "action_id": 1346,
            "action_name": "KCB JSON",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128), @datumrange nvarchar(50), @week nvarchar(128), @year nvarchar(128), \n@currentweek nvarchar(128),@dateandweek nvarchar(128),@KCBLijstdownload nvarchar(128) = dbo.strdate(NULL) +'_'+ 'KCB-Lijst.csv'\n\nSET @date = dbo.workDate()\nSET @week = @main_db.dbo.ABCWEEKNR() - 1\nSET @year = YEAR ( getdate() )\nSET @currentweek = @main_db.dbo.ABCWEEKNR()\n\nEXEC sp_api_modal_text 'De volgende lijst bestaat uit producten afkomstig uit Nederland welke verkocht zijn binnen de Europese Unie'\nEXEC sp_api_modal_text 'Na 1 april is het verplicht om voor de export naar het VK eCertNL te gebruiken en vervalt de opgaveplicht voor het VK.'\n\nIF dbo.abcdate() > '2021-04-01'\n BEGIN\n EXEC sp_api_modal_clear\n EXEC sp_api_modal_text 'Het is 1 April geweest! Deze lijst moet aangepast worden. Het Verenigd Koninkrijk dient via eCertNL opgegeven te worden.', 'text-danger font-weight-bold text-center'\n EXEC sp_api_modal_text 'Neem contact op met een consultant om deze lijst aan te laten passen', 'text-danger font-weight-bold text-center'\n RETURN\n END\n\nEXEC sp_api_modal_modal @class = 'w100'\nEXEC sp_api_modal_text 'Week nummer:'\nEXEC sp_api_modal_input @name='WeekNummer',@value = @week OUT,@class='w-24',@focus=1,@select=1 -- zoek veld\n\nSET @button = 'KCB-Lijst'\nEXEC sp_api_modal_button @name='button',@value = 'KCB-Lijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_button @name='button',@value = '#KCBLijstdownload',@valueout = @button OUT,@class = 'btn-success'\nEXEC sp_api_modal_button @name='button',@value = 'KCB-Artikelen',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print\n\nIF @button =  'KCB-Lijst'\nBEGIN\n\tSELECT DISTINCT\n\t   [woord~col-sm-3] = [woord]\n      ,[Totaal KGN@~col-sm-2] = [Totaal KGN]\n      ,[KLASSE~col-sm-1] = [KLASSE]\n      ,[TYPE] = [TYPE]\n      ,[KLEUR~col-sm-1] = [KLEUR]\n      ,[RAS~col-sm-2] = [RAS]\n      ,[isocode*] = [isocode]\n      ,[weeknrcap*] = 'Weeknummer: '\n      ,[weeknummer*] = [weeknummer]\n      ,[JaarCap*] = 'Jaar: '\n      ,[jaar*] = [jaar]\n\tINTO #KCBLijst\n\tfrom RV_KCB \n\twhere [weeknummer] = @week AND [jaar] = @year AND [Origin_ID] = 151 and [TDT] = 2 and ([CountryGroupID] = 1 OR [CountryId] = 224) and [CoreType] = 'FOOD' AND [isocode] != 'NL' \t\t\t \n\tEXEC sp_api_modal_table @tmptable=N'#KCBLijst',@orderby=N'ORDER BY [isocode*],[woord~col-sm-3] ASC',@fontsize='70%',@print=1\n\t--EXEC sp_api_modal_table @tmptable=N'#KCBLijst',@orderby=N'ORDER BY 9,1,8 ASC',@print=1\nEND \n\nIF @button =  'KCB-Artikelen'\nBEGIN\n\tSELECT DISTINCT\n\t   [woord] = [woord]\n\t  ,[detail] = [detail]\n      ,[KLASSE~col-sm-1] = [KLASSE]\n      ,[isocode*] = [isocode]\n      ,[weeknrcap*] = 'Weeknummer: '\n      ,[weeknummer*] = [weeknummer]\n      ,[JaarCap*] = 'Jaar: '\n      ,[jaar*] = [jaar]\n\tINTO #KCBArtikelen\n\tfrom RV_KCB \n\twhere [weeknummer] = @week AND [jaar] = @year AND [Origin_ID] = 151 and [TDT] = 2 and ([CountryGroupID] = 1 OR [CountryId] = 224) and [CoreType] = 'FOOD' AND [isocode] != 'NL' \t\t\t \n\tEXEC sp_api_modal_table @tmptable=N'#KCBArtikelen',@orderby=N'ORDER BY [isocode*],[woord] ASC',@fontsize='100%',@print=1\n\t--EXEC sp_api_modal_table @tmptable=N'#KCBLijst',@orderby=N'ORDER BY 9,1,8 ASC',@print=1\nEND \n\nIF @button =  '#KCBLijstdownload'\nBEGIN\n\tSELECT DISTINCT\n\t   [woord~col-sm-3] = [woord]\n      ,[Totaal KGN] = [Totaal KGN]\n      ,[KLASSE] = [KLASSE]\n      ,[TYPE~col-sm-2] = [TYPE]\n      ,[KLEUR] = [KLEUR]\n      ,[RAS] = [RAS]\n      ,[isocode] = [isocode]\n      ,[weeknummer] = [weeknummer]\n      ,[jaar] = [jaar]\n\tINTO #KCBLijstdownload\n\tfrom RV_KCB \n\twhere [weeknummer] = @week AND [jaar] = @year AND [Origin_ID] = 151 and [TDT] = 2 and ([CountryGroupID] = 1 OR [CountryId] = 224) and [CoreType] = 'FOOD' AND [isocode] != 'NL'\nEXEC sp_api_modal_csv @tmptable=N'#KCBLijstdownload',@orderby=N'ORDER BY [woord~col-sm-3] ASC', @filename= @KCBLijstdownload,@ansi=1\nEND \n",
            "action_id": 1347,
            "action_name": "KCB-Melding",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128), @datumrange nvarchar(50), @week nvarchar(128), @year nvarchar(128),\n@currentweek nvarchar(128),@dateandweek nvarchar(128),@KCBLijstdownload nvarchar(128) = dbo.strdate(NULL) +'_'+ 'KCB-Lijst.csv'\n\n--EXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\nSET @date = dbo.workDate()\nSET @week = @main_db.dbo.ABCWEEKNR() - 1\nSET @year = YEAR ( getdate() )\nSET @currentweek = @main_db.dbo.ABCWEEKNR()\n\nEXEC sp_api_modal_text 'De volgende lijst bestaat uit producten afkomstig uit Nederland welke verkocht zijn binnen de Europese Unie'\n\n/*\nEXEC sp_api_modal_text 'Na 1 april is het verplicht om voor de export naar het VK eCertNL te gebruiken en vervalt de opgaveplicht voor het VK.'\n\nIF dbo.abcdate() > '2021-04-01'\n BEGIN\n EXEC sp_api_modal_clear\n EXEC sp_api_modal_text 'Het is 1 April geweest! Deze lijst moet aangepast worden. Het Verenigd Koninkrijk dient via eCertNL opgegeven te worden.', 'text-danger font-weight-bold text-center'\n EXEC sp_api_modal_text 'Neem contact op met een consultant om deze lijst aan te laten passen', 'text-danger font-weight-bold text-center'\n RETURN\n END\n*/\n\nEXEC sp_api_modal_modal @class = 'w100'\nEXEC sp_api_modal_text 'Week nummer:'\nEXEC sp_api_modal_input @name='WeekNummer',@value = @week OUT,@class='w-24',@focus=1,@select=1 -- zoek veld\n\nSET @button = 'KCB-Lijst'\nEXEC sp_api_modal_button @name='button',@value = 'KCB-Lijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_button @name='button',@value = '#KCBLijstdownload',@valueout = @button OUT,@class = 'btn-success'\nEXEC sp_api_modal_button @name='button',@value = 'KCB-Artikelen',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print\n\nIF @button =  'KCB-Lijst'\nBEGIN\n\tSELECT DISTINCT\n\t   [woord~col-sm-3] = [woord]\n      ,[Totaal KGN@~col-sm-2] = [Totaal KGN]\n      ,[KLASSE~col-sm-1] = [KLASSE]\n      ,[TYPE] = [TYPE]\n      ,[KLEUR~col-sm-1] = [KLEUR]\n      ,[RAS~col-sm-2] = [RAS]\n      ,[isocode*] = [isocode]\n      ,[weeknrcap*] = 'Weeknummer: '\n      ,[weeknummer*] = [weeknummer]\n      ,[JaarCap*] = 'Jaar: '\n      ,[jaar*] = [jaar]\n\tINTO #KCBLijst\n\tfrom RV_KCB \n\twhere [weeknummer] = @week AND [jaar] = @year AND [Origin_ID] = 151 and [TDT] = 2 and ([CountryGroupID] = 1 OR [CountryId] = 224) and [CoreType] = 'FOOD' AND [isocode] != 'NL' \t\t\t \n\tEXEC sp_api_modal_table @tmptable=N'#KCBLijst',@orderby=N'ORDER BY [isocode*],[woord~col-sm-3] ASC',@fontsize='70%',@print=1\n\t--EXEC sp_api_modal_table @tmptable=N'#KCBLijst',@orderby=N'ORDER BY 9,1,8 ASC',@print=1\nEND \n\nIF @button =  'KCB-Artikelen'\nBEGIN\n\tSELECT DISTINCT\n\t   [woord] = [woord]\n\t  ,[detail] = [detail]\n      ,[KLASSE~col-sm-1] = [KLASSE]\n      ,[isocode*] = [isocode]\n      ,[weeknrcap*] = 'Weeknummer: '\n      ,[weeknummer*] = [weeknummer]\n      ,[JaarCap*] = 'Jaar: '\n      ,[jaar*] = [jaar]\n\tINTO #KCBArtikelen\n\tfrom RV_KCB \n\twhere [weeknummer] = @week AND [jaar] = @year AND [Origin_ID] = 151 and [TDT] = 2 and ([CountryGroupID] = 1 OR [CountryId] = 224) and [CoreType] = 'FOOD' AND [isocode] != 'NL'\t \n\tEXEC sp_api_modal_table @tmptable=N'#KCBArtikelen',@orderby=N'ORDER BY [isocode*],[woord] ASC',@fontsize='100%',@print=1\n\t--EXEC sp_api_modal_table @tmptable=N'#KCBLijst',@orderby=N'ORDER BY 9,1,8 ASC',@print=1\nEND \n\nIF @button =  '#KCBLijstdownload'\nBEGIN\n\tSELECT DISTINCT\n\t   [woord~col-sm-3] = [woord]\n      ,[Totaal KGN] = [Totaal KGN]\n      ,[KLASSE] = [KLASSE]\n      ,[TYPE~col-sm-2] = [TYPE]\n      ,[KLEUR] = [KLEUR]\n      ,[RAS] = [RAS]\n      ,[isocode] = [isocode]\n      ,[weeknummer] = [weeknummer]\n      ,[jaar] = [jaar]\n\tINTO #KCBLijstdownload\n\tfrom RV_KCB \n\twhere [weeknummer] = @week AND [jaar] = @year AND [Origin_ID] = 151 and [TDT] = 2 and ([CountryGroupID] = 1 OR [CountryId] = 224) and [CoreType] = 'FOOD' AND [isocode] != 'NL'\nEXEC sp_api_modal_csv @tmptable=N'#KCBLijstdownload',@orderby=N'ORDER BY [woord~col-sm-3] ASC', @filename= @KCBLijstdownload,@ansi=1\nEND \n",
            "action_id": 1348,
            "action_name": "KCB-Melding",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@date2 nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128)\nset @date = dbo.workDate()\nset @date2 = dbo.workDate()\nEXEC sp_api_modal_modal @class=N'grid'\n--EXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24' -- zoek veld\n\nSET @button = 'Keuringsrapport'\nEXEC sp_api_modal_button @name='button',@value = 'Keuringsrapport',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print\nEXEC sp_api_modal_text N'Keuringsrapport',N'h4 text-muted',@print=1\nIF @button =  'Keuringsrapport'\nBEGIN\nselect \n[Companyname*] = [Q_xTransactionHeader].TV_CompanyName\n,[Naam keurmeester*] = ' Naam Keurmeester:________________________'\n,[typecontrole *] = ' Type Controle:_________'\n,[Artikel~col-sm-3] = concat([Q_xTransactionDetail].detail,' ',[Q_xTransactionDetail].size,' '\n\t\t\t\t,[Q_xTransactionDetail].ContentDesc,' ',[Q_xTransactionDetail].xBrandCode,' ',[Q_xTransactionDetail].FustCode)\n,[Amount] = [Q_xTransactionDetail].Amount\n,[Monster] = ''\n,[Aanduid] = ''\n,[Uitwendig] = ''\n,[Inwendig] = ''\n,[Sortering] = ''\n,[gewicht] = ''\n,[Overige] = ''\n,[Afgekeurd] = ''\n,[Afwijkingen] = ''\n,[Reden*] = 'Reden afkeuring:________________________'\nINTO #Keuringsrapport\nFrom [Q_xTransactionHeader] right outer join Q_xTransactionDetail on TransactionHeader_ID = [Q_xTransactionHeader].id\nwhere [Q_xTransactionHeader].id = @id and [Q_xTransactionHeader].TDT = 1\n--ALTER TABLE #Keuringsrapport\nEXEC sp_api_modal_table @tmptable=N'#Keuringsrapport',@orderby=N'ORDER BY 4 ASC',@print=1,@fontsize='90%'\nEND \n",
            "action_id": 1349,
            "action_name": "Keuringsrapport",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@date2 nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128)\nset @date = dbo.workDate()\nset @date2 = dbo.workDate()\nEXEC sp_api_modal_modal @class=N'grid'\n--EXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24' -- zoek veld\n\nSET @button = 'Keuringsrapport'\nEXEC sp_api_modal_button @name='button',@value = 'Keuringsrapport',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print\nEXEC sp_api_modal_text N'Keuringsrapport',N'h4 text-muted',@print=1\nIF @button =  'Keuringsrapport'\nBEGIN\nselect \n[Companyname*] = [Q_xTransactionHeader].TV_CompanyName\n,[Naam keurmeester*] = ' Naam Keurmeester:________________________'\n,[typecontrole *] = ' Type Controle:_________'\n,[Artikel~col-sm-3] = concat([Q_xTransactionDetail].detail,' ',[Q_xTransactionDetail].size,' '\n\t\t\t\t,[Q_xTransactionDetail].ContentDesc,' ',[Q_xTransactionDetail].xBrandCode,' ',[Q_xTransactionDetail].FustCode)\n,[Amount] = [Q_xTransactionDetail].Amount\n,[Monster] = ''\n,[Aanduid] = ''\n,[Uitwendig] = ''\n,[Inwendig] = ''\n,[Sortering] = ''\n,[gewicht] = ''\n,[Overige] = ''\n,[Afgekeurd] = ''\n,[Afwijkingen] = ''\n,[Reden*] = 'Reden afkeuring:________________________'\nINTO #Keuringsrapport\nFrom [Q_xTransactionHeader] right outer join Q_xTransactionDetail on TransactionHeader_ID = [Q_xTransactionHeader].id\nwhere [Q_xTransactionHeader].id = @id and [Q_xTransactionHeader].TDT = 1\n--ALTER TABLE #Keuringsrapport\nEXEC sp_api_modal_table @tmptable=N'#Keuringsrapport',@orderby=N'ORDER BY 4 ASC',@print=1,@fontsize='90%'\nEND \n",
            "action_id": 1350,
            "action_name": "Keuringsrapport",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "--211101 uitgebreid voor admin met verwijderen van regels !!!\n-------------------------------------------------------------\n\n--EXEC @main_db.dbo.DeleteCTH @CTHID=@ID\nDECLARE @cursor_ids CURSOR,@cid INT, @idval INT\n\nIF dbo.hasRole('admin') > 0\n\tBEGIN\n\t\tEXEC sp_api_modal_alert N'Warning',N'Wil je ook de regels verwijderen?'\n\tEND\n\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\n\t\t--optie: verwijder ook gelijk de regels! GEVAARLIJK!!!\n\t\tIF dbo.hasRole('admin') > 0\n\t\t\tBEGIN\n\t\t\t\tDECLARE @cursor CURSOR\n\t\t\t\tSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT ID FROM XTRANSACTIONDETAIL WHERE TRANSACTIONHEADER_ID=@CID\n\t\t\t\tOPEN @cursor;\n\t\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\t\tWHILE @@FETCH_STATUS = 0\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tEXEC @main_db.dbo.DeleteCTR @idval\n\t\t\t\t\t\tFETCH NEXT FROM @cursor INTO @idval\n\t\t\t\t\tEND\n\t\t\t\tCLOSE @cursor;\n\t\t\t\tDEALLOCATE @cursor;\n\t\t\tEND\n\t\t\n\t\t\n\t\t--EXEC @main_db.dbo.DeleteCTH @CTHID=@cID -- delete enkel id\n\t\texec @main_db.dbo.DeleteCTH @CTHID=@cID, @Level=N'FULL' --PAS OP FULL VERWIJDERT OOK CONTAINER!!!!\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;\n\n\n\n\n--211101 WAS:\n/* \n--EXEC @main_db.dbo.DeleteCTH @CTHID=@ID\nDECLARE @cursor_ids CURSOR,@cid INT\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_toast @cid\n\t\tEXEC @main_db.dbo.DeleteCTH @CTHID=@cID -- delete enkel id\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;\n*/",
            "action_id": 1352,
            "action_name": "Verwijder_Order",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.DeleteCTH @ID ",
            "action_id": 1353,
            "action_name": "Verwijder_Order",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "exec @main_db.dbo.DeleteCTH @ID ",
            "action_id": 1354,
            "action_name": "Verwijder_Order",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXECUTE @MAIN_DB.DBO.CTH_Endsum @ID\n\nif (select sum(ivtotal) from xctrtotals where cth_id=@ID)=(select ctrstockmut from xcthtotals where cth_id=@ID)\n\tbegin\n\t\texec sp_api_toast N'gelijk'\n\tend\nelse\n\tbegin\n\t\texec sp_api_toast N'niet gelijk'\n\tend",
            "action_id": 1355,
            "action_name": "Volledig Toegewezen?",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @search nvarchar(128) ,@button nvarchar(128), @datumtijd nvarchar(50)\nDECLARE @filename nvarchar(1024) \n,@VroegNegatiefdownload nvarchar(128) = dbo.strdate(NULL) +'_'+ 'VroegNegatief.csv'\n,@Negatiefdownload nvarchar(128) = dbo.strdate(NULL) +'_'+ 'Negatief.csv'\n,@Reserveddownload nvarchar(128) = dbo.strdate(NULL) +'_'+ 'Gereserveerd.csv'\n,@Notzerodownload nvarchar(128) = dbo.strdate(NULL) +'_'+ 'Voorraad.csv'\nSET @datumtijd = FORMAT(getdate(),'dd MMM yyyy HH:mm')\n\n--EXEC sp_api_modal_input @name='search',@value = @search OUT,@focus=1 -- zoek veld\nEXEC sp_api_modal_modal @class = 'w100'\nSET @button = 'VroegNegatief'\nEXEC sp_api_modal_button @name='button',@value = 'VroegNegatief',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_button @name='button',@value = 'Negatief',@valueout = @button OUT,@class = 'btn-primary',@key = 'F2'\nEXEC sp_api_modal_button @name='button',@value = 'Gereserveerd',@valueout = @button OUT,@class = 'btn-primary',@key = 'F3'\nEXEC sp_api_modal_button @name='button',@value = 'Alles',@valueout = @button OUT,@class = 'btn-primary',@key = 'F4'\nEXEC sp_api_modal_button @name='button',@value = 'VolledigeLijst',@valueout = @button OUT,@class = 'btn-primary',@key = 'F5'\nEXEC sp_api_modal_print @keycode='F9'\nEXEC sp_api_modal_text @datumtijd, @printonly=1\n\nIF @button =  'VroegNegatief'\nBEGIN\nSELECT DISTINCT [Description~col-sm-5] = Description, Origin_Code, Size, xBrandName, ContentDesc, FustCode, 'Vroeg Negatief' AS [CAP*]\n\t,[verwacht@g] = VoorraadVerwacht@, [Voorraad@g] = Voorraad@\nINTO #VroegNegatief\nFROM          RV_IR_Voorraad\nWHERE        (Voorraad@ < 0) AND ([EndTime*] = 'Vroeg') AND (CoreType = 'FOOD')\nEXEC sp_api_modal_table @tmptable=N'#VroegNegatief',@orderby=N'ORDER BY [CAP*],1 ASC',@print=1\nEXEC sp_api_modal_button @name='button',@value = 'VroegNegatiefNaarCSV',@valueout = @button OUT,@class = 'btn-success'\nEND \n\nIF @button =  'VroegNegatiefNaarCSV'\nBEGIN\nSELECT DISTINCT Voorraad@, VoorraadVerwacht@, Description, Origin_Code, Size, xBrandName, ContentDesc, FustCode, 'Vroeg Negatief' AS [CAP*]\nINTO #VroegNegatiefdownload\nFROM          RV_IR_Voorraad\nWHERE        (Voorraad@ < 0) AND ([EndTime*] = 'Vroeg') AND (CoreType = 'FOOD')\nEXEC sp_api_modal_csv @tmptable=N'#VroegNegatiefdownload',@orderby=N'ORDER BY [CAP*],Description ASC', @filename= @VroegNegatiefdownload,@ansi=1\nEND \n\n\nIF @button =  'Negatief'\nBEGIN\nSELECT DISTINCT [Description~col-sm-5] = Description, Origin_Code, Size, xBrandName, ContentDesc, FustCode, 'Negatief' AS [CAP*]\n\t,[verwacht@g] = VoorraadVerwacht@, [Voorraad@g] = Voorraad@\nINTO #Negatief\nFROM          RV_IR_Voorraad\nWHERE        (Voorraad@ < 0) AND (CoreType = 'FOOD')\nEXEC sp_api_modal_table @tmptable=N'#Negatief',@orderby=N'ORDER BY [CAP*],1 ASC',@print=1\nEXEC sp_api_modal_button @name='button',@value = 'NegatiefNaarCSV',@valueout = @button OUT,@class = 'btn-success'\nEND \n\nIF @button =  'NegatiefNaarCSV'\nBEGIN\nSELECT DISTINCT Voorraad@, VoorraadVerwacht@, Description, Origin_Code, Size, xBrandName, ContentDesc, FustCode, 'Negatief' AS [CAP*]\nINTO #Negatiefdownload\nFROM          RV_IR_Voorraad\nWHERE        (Voorraad@ < 0) AND (CoreType = 'FOOD')\nEXEC sp_api_modal_csv @tmptable=N'#Negatiefdownload',@orderby=N'ORDER BY [CAP*],Description ASC', @filename= @Negatiefdownload,@ansi=1\nEND \n\nIF @button =  'Gereserveerd'\nBEGIN\nSELECT DISTINCT ReservedIn@, ReservedOut@, [Description~col-sm-5] = Description, Origin_Code, Size, xBrandName, ContentDesc, FustCode, 'Gereserveerd' AS [CAP*]\n\t,[verwacht@g] = VoorraadVerwacht@, [Voorraad@g] = Voorraad@\nINTO #Gereserveerd\nFROM          RV_IR_Voorraad\nWHERE        (ReservedIn@ <> 0 OR ReservedOut@ <> 0) AND (CoreType = 'FOOD')\nEXEC sp_api_modal_table @tmptable=N'#Gereserveerd',@orderby=N'ORDER BY [CAP*],3 ASC',@print=1\nEXEC sp_api_modal_button @name='button',@value = 'GereserveerdNaarCSV',@valueout = @button OUT,@class = 'btn-success'\nEND \n\nIF @button =  'GereserveerdNaarCSV'\nBEGIN\nSELECT DISTINCT Voorraad@, VoorraadVerwacht@, ReservedIn@, ReservedOut@, Description, Origin_Code, Size, xBrandName, ContentDesc, FustCode, 'Gereserveerd' AS [CAP*]\nINTO #GereserveerdNaarCSV\nFROM          RV_IR_Voorraad\nWHERE        (ReservedIn@ <> 0 OR ReservedOut@ <> 0) AND (CoreType = 'FOOD')\nEXEC sp_api_modal_csv @tmptable=N'#GereserveerdNaarCSV',@orderby=N'ORDER BY [CAP*],Description ASC', @filename= @Reserveddownload,@ansi=1\nEND \n\nIF @button =  'Alles'\nBEGIN\nSELECT DISTINCT [Description~col-sm-4] = Description, Origin_Code, Size, xBrandName, ContentDesc, FustCode, 'Alles' AS [CAP*]\n\t,[Voorraad@g] = Voorraad@ --, [Correctie] = '         '\nINTO #Notzero\nFROM          RV_IR_Voorraad\nWHERE        (Voorraad@ <> 0) AND (CoreType = 'FOOD')\nSET @datumtijd = FORMAT(getdate(),'dd MMM yyyy HH:mm')\nDECLARE @sql nvarchar(max) = N'ALTER TABLE #Notzero ADD ' + QUOTENAME(@datumtijd+'~col-sm-2') +' nvarchar(128)'\nEXEC (@sql)\nEXEC sp_api_modal_table @tmptable=N'#Notzero',@orderby=N'ORDER BY [CAP*],1 ASC',@fontsize='110%',@print=1\nEXEC sp_api_modal_button @name='button',@value = 'AllesNaarCSV',@valueout = @button OUT,@class = 'btn-success'\nEND \n\nIF @button =  'AllesNaarCSV'\nBEGIN\nSELECT DISTINCT Voorraad@, VoorraadVerwacht@, Description, Origin_Code, Size, xBrandName, ContentDesc, FustCode, 'Negatief' AS [CAP*]\nINTO #Notzerodownload\nFROM          RV_IR_Voorraad\nWHERE        (Voorraad@ <> 0) AND (CoreType = 'FOOD')\nEXEC sp_api_modal_csv @tmptable=N'#Notzerodownload',@orderby=N'ORDER BY [CAP*],Description ASC', @filename= @Notzerodownload,@ansi=1\nEND \n\nIF @button =  'VolledigeLijst'\n\tBEGIN\n\t\tDECLARE @datum nvarchar(128),@button2 nvarchar(128)\n\t\tEXEC sp_api_modal_text N'Kies de datum voor de voorraadlijst (dit is een lange lijst!!)'\n\t\tEXEC sp_api_modal_date @name='datum',@value = @datum OUT\n\t\tEXEC sp_api_modal_button @name='button2',@value = 'Laad lijst',@valueout = @button2 OUT,@class = 'btn-success',@key = 'Enter'\n\n\t\tIF @button2 IS NOT NULL\n\t\t\tBEGIN\n\t\t\t\tSELECT *\n\t\t\t\tINTO #VolledigeLijst\n\t\t\t\tFROM @main_db.dbo.stockByDate(@datum)\n\t\t\t\tEXEC sp_api_modal_table @tmptable=N'#VolledigeLijst',@orderby=N'ORDER BY ARTIKEL ASC'\n\t\t\tEND\n\tEND",
            "action_id": 1357,
            "action_name": "Voorraad Lijsten",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @search nvarchar(128) ,@button nvarchar(128), @datumtijd nvarchar(50)\nDECLARE @filename nvarchar(1024) \n,@VroegNegatiefdownload nvarchar(128) = dbo.strdate(NULL) +'_'+ 'VroegNegatief.csv'\n,@Negatiefdownload nvarchar(128) = dbo.strdate(NULL) +'_'+ 'Negatief.csv'\n,@Reserveddownload nvarchar(128) = dbo.strdate(NULL) +'_'+ 'Gereserveerd.csv'\n,@Notzerodownload nvarchar(128) = dbo.strdate(NULL) +'_'+ 'Voorraad.csv'\nSET @datumtijd = FORMAT(getdate(),'dd MMM yyyy HH:mm')\n\n--EXEC sp_api_modal_input @name='search',@value = @search OUT,@focus=1 -- zoek veld\nEXEC sp_api_modal_modal @class = 'w100'\nSET @button = 'VoorraadWaarde'\nEXEC sp_api_modal_button @name='button',@value = 'VoorraadWaarde',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print @keycode='F9'\nEXEC sp_api_modal_text @datumtijd, @printonly=1\n\nIF @button =  'VoorraadWaarde'\nBEGIN\nSELECT DISTINCT [Description~col-sm-5] = concat(Description,' ',Origin_Code,' ', Size,' ', xBrandName,' ', ContentDesc,' ', FustCode), 'VoorraadWaarde' AS [CAP*]\n\t,[Voorraad@g] = Voorraad@ ,[Inkoop prijs] = [Laatste inkoop prijs],[Totaal waarde@g~col-sm-2] = [Totaal waarde]\nINTO #VoorraadWaarde\nFROM          RV_IR_Voorraad\nWHERE        (Voorraad@ <> 0) AND (CoreType = 'FOOD')\nSET @datumtijd = FORMAT(getdate(),'dd MMM yyyy HH:mm')\nDECLARE @sql nvarchar(max) = N'ALTER TABLE #VoorraadWaarde ADD ' + QUOTENAME(@datumtijd+'~col-sm-2') +' nvarchar(128)'\nEXEC (@sql)\nEXEC sp_api_modal_table @tmptable=N'#VoorraadWaarde',@orderby=N'ORDER BY [CAP*],1 ASC',@fontsize='120%',@print=1\nEXEC sp_api_modal_button @name='button',@value = 'AllesNaarCSV',@valueout = @button OUT,@class = 'btn-success'\nEND \n\nIF @button =  'AllesNaarCSV'\nBEGIN\nSELECT DISTINCT [Description~col-sm-5] = concat(Description,' ',Origin_Code,' ', Size,' ', xBrandName,' ', ContentDesc,' ', FustCode), 'VoorraadWaarde' AS [CAP*]\n\t,[Voorraad@g] = Voorraad@ ,[Inkoop prijs] = [Laatste inkoop prijs],[Totaal waarde@g~col-sm-2] = [Totaal waarde]\nINTO #Notzerodownload\nFROM          RV_IR_Voorraad\nWHERE        (Voorraad@ <> 0) AND (CoreType = 'FOOD')\nEXEC sp_api_modal_csv @tmptable=N'#Notzerodownload',@orderby=N'ORDER BY [CAP*], [Description~col-sm-4]', @filename= @Notzerodownload,@ansi=1\nEND ",
            "action_id": 1358,
            "action_name": "Voorraad Waarde",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "IF dbo.hasClaims('sub=sylvester@vgibv.nl,role=admin') > 0\nBEGIN\n\tupdate xinvoice set status='Draft' where id =@ID\nEND\t\n\n\t",
            "action_id": 1367,
            "action_name": "ZET DRAFT",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "IF dbo.hasClaims('sub=rick@tracy.nu,sub=colin@tracy.nu,sub=geertbultman@gmail.com') > 0\nBEGIN\n\tupdate xtransactionheader set status='InvoiceGenerated' where id=@ID\nEND\nELSE EXECUTE SP_API_TOAST N'BEL TRACY SUPPORT VOOR DEZE ACTIE'\n",
            "action_id": 1368,
            "action_name": "zet fase Gefactureerd",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "IF dbo.hasClaims('sub=rick@tracy.nu') > 0\nBEGIN\n\tupdate xtransactionheader set status='InvoiceGenerated' where id=@ID\nEND\nELSE EXECUTE SP_API_TOAST N'BEL TRACY SUPPORT VOOR DEZE ACTIE'\n",
            "action_id": 1369,
            "action_name": "zet fase Gefactureerd",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "IF (SELECT status from xtransactionheader where id = @id) IN ('openSale','openClaim') AND (SELECT xctrStatus from Q_xtransactionheader where id = @id) = 0\nOR dbo.hasRole('admin,directie') > 0 AND (SELECT xctrStatus from Q_xtransactionheader where id = @id) = 0\nBEGIN\n\tupdate xtransactionheader set status='ReadyForInvoice' where id=@ID\nEND\n\n",
            "action_id": 1370,
            "action_name": "zet fase Klaar voor Factuur",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "IF dbo.hasClaims('sub=rick@tracy.nu') > 0\nBEGIN\n\tupdate xtransactionheader set status='ReadyForInvoice' where id=@ID\nEND\nELSE EXECUTE SP_API_TOAST N'BEL TRACY SUPPORT VOOR DEZE ACTIE'\n",
            "action_id": 1371,
            "action_name": "zet fase Klaar voor Factuur",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "IF dbo.hasClaims('sub=rick@tracy.nu,sub=colin@tracy.nu,sub=rene@anacogreeve.nl') > 0 AND (SELECT status FROM xtransactionheader where id = @id) IN ('ReadyForInvoice','openPrice')\nBEGIN\n\tupdate xtransactionheader set status='openSale' where id=@ID\n\tupdate xlandfreight set status ='Loading',i_away = 0 where transactionheader_id = @ID\n\tEXEC sp_api_toast N'Terug naar OpenSale en Loading'\n\t\nEND\nELSE EXECUTE SP_API_TOAST N'BEL TRACY SUPPORT VOOR DEZE ACTIE'",
            "action_id": 1372,
            "action_name": "zet fase open",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "IF dbo.hasClaims('sub=rick@tracy.nu') > 0\nBEGIN\n\tupdate xtransactionheader set status='openSale' where id=@ID\nEND\nELSE EXECUTE SP_API_TOAST N'BEL TRACY SUPPORT VOOR DEZE ACTIE'",
            "action_id": 1373,
            "action_name": "zet fase open",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "update xtransactionheader set status='openSale' where id=@ID",
            "action_id": 1374,
            "action_name": "zet open",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "IF dbo.hasClaims('sub=sylvester@vgibv.nl,role=admin') > 0\n\tbegin\n\t\tupdate xinvoice set status='sent' where id =@ID\n\tend\t",
            "action_id": 1375,
            "action_name": "zet sent",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @test int = 0 -- 0=LIVE; 1=TEST\n\nIF @id <> @ids EXEC sp_api_modal_alert N'Waarschuwing',N'De selectie wordt opnieuw naar klanten verstuurd.'\n\nDECLARE @cursor CURSOR\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @id\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\n\t\tDECLARE @toCompany_ID INT = NULL\n\t\tDECLARE @fromCompany_ID INT = NULL\n\t\tDECLARE @StateOK bit\n\n\t\tSELECT @toCompany_ID = toCompany_ID, @fromCompany_ID = fromCompany_ID FROM [xInvoice] WHERE [id] = @id\n\n\t\tEXEC sp_api_report_generate @id = @id\n\t\t\t,@sys_report_key = 'invoice_out'\n\t\t\t,@toCompany_ID = @toCompany_ID\n\t\t\t,@fromCompany_ID = @fromCompany_ID\n\t\t\t,@test=@test\n\n\t\t\n--\t\texec @main_db.dbo.Fase_INV   @ID=@id,@Fase=N'sent' ,@StateOK = @StateOK OUT\n\t\texec @main_db.dbo.Fase_Guard @ID=@ID,@Fase=N'sent' ,@StateOK = @StateOK OUT,@Context =N'INV' --210113 DEZE METHODE GEBRUIKEN VOOR ALLE FASE WIJZIGINGEN IN AGFX !\n\t\tif @StateOK=0 exec sp_api_toast N'LET OP: DE FASE ''sent'' is (nog) niet toegestaan in xFASE...'\n\n\t\tFETCH NEXT FROM @cursor INTO @id\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\n",
            "action_id": 1376,
            "action_name": "Opnieuw Printen / Verzenden",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_text 'Geselecteerde regels:','text-primary font-weight-bold display-4 text-center pb-3'\r\n/*\r\nDECLARE @reducer nvarchar(max) = N'id IN('+@ids+')'\r\nEXEC sp_api_modal_table @card_id,@reducer\r\n\r\nSELECT id,[TotPal@]=lft_PalCalc,[Blok@]=Blok,[Euro@]=Euro INTO #Q_xLandfreight FROM Q_xLandfreight WHERE id IN(SELECT * FROM string_split(@ids,','))\r\nEXEC sp_api_modal_table @tmptable=N'#Q_xLandfreight'\r\n*/\r\nSELECT [TotPal]=SUM(lft_PalCalc),[Blok]=SUM(Blok),[Euro]=SUM(Euro) INTO #Q_xLandfreightSum FROM Q_xLandfreight WHERE id IN(SELECT * FROM string_split(@ids,','))\r\nEXEC sp_api_modal_table @tmptable=N'#Q_xLandfreightSum'\r\n\r\n",
            "action_id": 1377,
            "action_name": "Optellen",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @F1button nvarchar(128)= 'VCheck'\nEXEC sp_api_modal_button @name='button',@value = 'OK',@valueout = @F1button OUT,@class = 'btn-primary',@key = 'F1'\n\nIF @F1button =  'OK'\nBEGIN\n\tEXEC sp_api_modal_clear\nEND \n\nELSE\nBEGIN --F_Email_Accounting\n\tDeclare @infotext nvarchar(512) = concat('Financiele mutaties op basis van deze order(',@ID,')')\n\tEXEC sp_api_modal_text @text=@infotext,@class = 'h3 text-muted'\n\n\tEXEC sp_api_modal_print\n\tSELECT * INTO #tt_verkoop from @main_db.dbo.Calc_Finrows_Summed_CTH_IV where cth_id=@ID and [ExBedrag@:2] <>0\n\tEXEC sp_api_modal_table @tmptable=N'#tt_verkoop',@print=1\n\n--\tEXEC sp_api_modal_text 'Meldingen:'\n\tif trim(isnull((select debtorNumber from xcompany where id= {[verkoop].counterparty_id}),N''))=N''  EXEC sp_api_modal_text 'Geen Debiteurnummer ingevuld'\n\t--if trim(isnull((select F_Email_Accounting from xcompany where id= {[verkoop].counterparty_id}),N''))=N''  EXEC sp_api_modal_text 'Geen Factuur emailadres ingevuld'\n\tif trim(isnull((select invoiceEmail from xcompany where id= {[verkoop].counterparty_id}),N''))=N''  EXEC sp_api_modal_text 'Geen Factuur emailadres ingevuld'\n\t\n\t--kostensettings\n\tif not exists(select id from xcompanycostsettings where groupcode=N'BASIS_AGF' and xcompany_id ={[verkoop].counterparty_id})   EXEC sp_api_modal_text 'Er zijn geen kosteninstellingen ingevuld (kijk bij CompanyCostSettings)'\nEND",
            "action_id": 1378,
            "action_name": "Order Info",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @F1button nvarchar(128)= 'VCheck'\nEXEC sp_api_modal_button @name='button',@value = 'OK',@valueout = @F1button OUT,@class = 'btn-primary',@key = 'F1'\n\nIF @F1button =  'OK'\nBEGIN\n\tEXEC sp_api_modal_clear\nEND \n\nELSE\nBEGIN --F_Email_Accounting\n\tDeclare @infotext nvarchar(512) = concat('Financiele mutaties op basis van deze order(',@ID,')')\n\tEXEC sp_api_modal_text @text=@infotext,@class = 'h3 text-muted'\n\n\tEXEC sp_api_modal_print\n\tSELECT * INTO #tt_verkoop from @main_db.dbo.Calc_Finrows_Summed_CTH_IV where cth_id=@ID and [ExBedrag@:2] <>0\n\tEXEC sp_api_modal_table @tmptable=N'#tt_verkoop',@print=1\n\n--\tEXEC sp_api_modal_text 'Meldingen:'\n\tif trim(isnull((select debtorNumber from xcompany where id= {[verkoop].counterparty_id}),N''))=N''  EXEC sp_api_modal_text 'Geen Debiteurnummer ingevuld'\n\t--if trim(isnull((select F_Email_Accounting from xcompany where id= {[verkoop].counterparty_id}),N''))=N''  EXEC sp_api_modal_text 'Geen Factuur emailadres ingevuld'\n\tif trim(isnull((select invoiceEmail from xcompany where id= {[verkoop].counterparty_id}),N''))=N''  EXEC sp_api_modal_text 'Geen Factuur emailadres ingevuld'\n\t\n\t--kostensettings\n\tif not exists(select id from xcompanycostsettings where groupcode=N'BASIS_AGF' and xcompany_id ={[verkoop].counterparty_id})   EXEC sp_api_modal_text 'Er zijn geen kosteninstellingen ingevuld (kijk bij CompanyCostSettings)'\nEND",
            "action_id": 1379,
            "action_name": "Order Info",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 1390,
            "action_name": "Overschrijf_P96_Tarief",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 1391,
            "action_name": "Overschrijf_P96_Tarief",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @mes nvarchar(200),@CTRid int\nDECLARE @toewijzing int, @TOE nvarchar(200),@TOE2 nvarchar(200)\nSET @CTRid = (SELECT CTR_ID from XLFCTR where id = @id)\n/* {[ctr2].id343243} */\nif {[xlfctr].CTR_ID.cth_fase} in (N'openSale',N'openPurchase')\n\nbegin\n\t--EXEC sp_api_modal_text N'Vul aantal in',N'h4 text-muted'\n\tSET @aantal = {[xlfctr].LFCTR_Amount} \n\tSET @ltrCTH = {[xlfctr].ltrCTH} \n\tSET @LF_ID = {[xlfctr].LF_ID} \n\tSET @ctr_id = {[xlfctr].CTR_ID} \n\tSET @away = {[xlfctr].LF_ID.i_away}\n\tSET @selected = {[xlfctr].LF_ID.i_selected}\n--\texec sp_api_toast @aantal\n\tSET @ctraantal = {[xlfctr].CTR_ID.amount} -- {[ctr2].amount}\n\t--exec sp_api_toast @ctraantal\n\tset @orgaantal=@aantal -- spaart een onnodige UPDATE uit bij gelijk aantal\n\tEXEC sp_api_modal_input @name='@aantal',@max=10, @value= @aantal OUT,@focus=1\n--\texec sp_api_toast @aantal\n--\treturn;\n\tEXEC sp_api_modal_button @name='@button',@value = 'Opslaan', @valueout = @button OUT,@class='btn-primary',@key='Enter'\n\tIF @button IS NOT NULL\n\t\tBEGIN\n\t\t\n\t\tIF @away = 1\n\t\t\tBEGIN\t\t\t\n\t\t\t\tset @TOE = N'Landfreight is vast gezet.'\n\t\t\t\tset @TOE2 = N'U kan geen aantal wijzigen. Ga naar Landfreight en geef via \"acties -> vast on/off\" OF \"Workflow (F11) -> Terug naar Loading\" de regels vrij'\n\t\t\t\tEXEC sp_api_modal_Alert @TOE,@TOE2\n\t\t\t\tEXEC sp_api_modal_clear\n\t\t\t\tRETURN\n\t\t\tEND\n\t\t\t/* -- CG 210617 niet meer i_selected gebruiken. Raken mensen door in de war\n\t\tIF @selected = 0\n\t\t\tBEGIN\t\t\t\n\t\t\t\texec sp_api_toast @selected\n\t\t\t\tEXEC sp_api_modal_post N'uitgaande_landfreight',N'i_selected',1,@LF_ID\n\t\t\t\tEXEC sp_api_modal_save N'uitgaande_landfreight',@LF_ID\n\t\t\tEND\n\t\t\t*/\n\t\tIF TRY_CAST(@aantal AS int) IS NOT NULL\n\t\t\tBEGIN\n\t\t\tIF @aantal > @ctraantal\n\t\t\t\tBEGIN\t\t\t\n\t\t\t\t\tset @TOE = N'Ingevulde aantal is groter dan verkoop regel, Pas de verkoop aan.'\n\t\t\t\t\tEXEC sp_api_modal_Alert @TOE\n\t\t\t\t\tRETURN\n\t\t\t\tEND\n\t\t\t\n\t\t\tIF @aantal = @ctraantal\n\t\t\t\tBEGIN\t\t\n\t\t\t\t\tIF (SELECT count(id) FROM xlfctr WHERE CTR_ID = @ctr_id AND LF_ID != @LF_ID AND LF_id in (SELECT id from xlandfreight where i_away = 1)) > 0\n\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\tset @TOE = N'De huidige regel staat reeds al op een andere (vastgezette) regel.'\n\t\t\t\t\t\t\tEXEC sp_api_modal_Alert @TOE\n\t\t\t\t\t\t\tRETURN\n\t\t\t\t\t\tEND\n\t\t\t\t\tELSE\n\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\tDELETE FROM xlfctr WHERE CTR_ID = @ctr_id AND LF_ID != @LF_ID AND LF_id in (SELECT id from xlandfreight where i_away = 0)\n\t\t\t\t\t\t\tEXEC sp_api_modal_post N'xlfctr',N'LFCTR_Amount',@aantal,@id\n\t\t\t\t\t\t\tEXEC sp_api_modal_save N'xlfctr',@id\n\t\t\t\t\t\t\tEXEC @main_db.dbo.Create_ALL_Landfreight\n\t\t\t\t\t\tEND\n\t\t\t\tEND\n\n\t\t\tif  @aantal < @ctraantal\n\t\t\t\tBEGIN\n\t\t\t\t\tEXEC sp_api_modal_post N'xlfctr',N'LFCTR_Amount',@aantal,@id\n\t\t\t\t\tEXEC sp_api_modal_save N'xlfctr',@id\n\t\t\t\t\tEXEC @main_db.dbo.Create_ALL_Landfreight\n\t\t\t\tEND\n\t\t\tEND\n\t\t\t\t\tEXEC sp_api_modal_clear\n\n\t\tEND\nend\nelse execute sp_api_toast N'RH210117: Direct aantal ingave alleen bij open Orders!'\t\t",
            "action_id": 1392,
            "action_name": "CHANGE LF_Regel Amount ",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 1395,
            "action_name": "clone",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 1396,
            "action_name": "clone",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": null,
            "action_id": 1397,
            "action_name": "clone",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @cursor_ids CURSOR,@cid INT\r\nDECLARE @toCompany_ID INT \r\nDECLARE @fromCompany_ID INT = (select top 1 id from xTenantKey)\r\nDECLARE @doctype nvarchar(128)\r\nSET @doctype = (select xtransportdoc.DocType from xtransportdoc where xtransportdoc.id = @id)\r\n/*\t\r\n--DECLARE @json nvarchar(max) = (select id from xLandfreight where id in (select xLandfreight_ID from xTransportDocSetxLandfreight where xTransportDocSet_ID = @id) FOR JSON PATH)\r\nDECLARE @json nvarchar(max) = (select xLandfreight_ID from xTransportDocSetxLandfreight where xTransportDocSet_ID = {[tdocset].id} FOR JSON PATH)\r\n\r\nEXEC sp_api_modal_text @json,N'json'\r\nRETURN\r\n*/\r\n--SET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\r\nIF @doctype = 'CMR'\r\nBEGIN\r\n\tEXEC sp_api_toast N'CMR afdrukken' \r\n\tSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR select xLandfreight_ID from xTransportDocSetxLandfreight where xTransportDocSet_ID = {[tdocset].id}\r\n\tOPEN @cursor_ids;\r\n\tFETCH NEXT FROM @cursor_ids INTO @cid\r\n\tWHILE @@FETCH_STATUS = 0\r\n\t\tBEGIN\r\n\t\t\tEXEC sp_api_toast @cid\r\n\t\t\t--dit is nu alleen voor tellers en checks:\r\n\r\n\t\t\t--dit is de feitelijke \"run\"\r\n\t\t\tSET @toCompany_ID = (select top 1 id from xTenantKey) -- een CRM wordt naar tenant gestuurd/geprint\r\n\t\t\t--DECLARE @error INT\r\n\t\t\tEXEC sp_api_report_generate @id = @cid\r\n\t\t\t\t,@sys_report_key = 'cmr' --zie xrepdef\r\n\t\t\t\t,@toCompany_ID = @toCompany_ID\r\n\t\t\t\t,@fromCompany_ID = @fromCompany_ID\r\n\r\n\t\t\t--IF @error > 0 RAISERROR(N'Er is een probleem')\r\n\t\t\t--even niet registreren dat er wordt afgedrukt\r\n\t\t\tEXEC @main_db.dbo.RunReport\t@TABLECONTEXT = N'LF'\t,@Context_Key_ID=@cid,@Report_CODE=N'CMR'\r\n\r\n\t\t\tFETCH NEXT FROM @cursor_ids INTO @cid\r\n\t\tEND\r\n\tCLOSE @cursor_ids;\r\n\tDEALLOCATE @cursor_ids;\r\nEND\r\nIF @doctype != 'CMR' \r\nBEGIN\r\n\t\tEXEC sp_api_modal_text 'Huidige regel is niet CMR','text-danger font-weight-bold h2 text-center'\r\nEND",
            "action_id": 1401,
            "action_name": "CMR",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "-------------------------------\n--\tMODAL INPUT: GET COUNTRY_ID \n-------------------------------\nDECLARE @value nvarchar(max),@country_id nvarchar(max)--,@menu_id nvarchar(max),@company_id nvarchar(max)\n\nEXEC sp_api_modal_text N'Land-picker',N'h3'\nEXEC sp_api_modal_select @card_name=N'country',@value = @country_id OUT,@focus=1,@placeholder=N'Kies een land'\n\nSET @country_id = CONCAT(N'Het land id is: ' , @country_id)\nEXEC sp_api_modal_text @country_id\n\n\n\n\n\n\n\n",
            "action_id": 1402,
            "action_name": "Comp",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "-------------------------------\r\n--\tMODAL INPUT: GET COUNTRY_ID \r\n-------------------------------\r\nDECLARE @value nvarchar(max),@country_id nvarchar(max)--,@menu_id nvarchar(max),@company_id nvarchar(max)\r\n\r\nEXEC sp_api_modal_text N'Land-picker',N'h3'\r\nEXEC sp_api_modal_select @card_name=N'country',@value = @country_id OUT,@focus=1,@placeholder=N'Kies een land'\r\n\r\nSET @country_id = CONCAT(N'Het land id is: ' , @country_id)\r\nEXEC sp_api_modal_text @country_id\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
            "action_id": 1403,
            "action_name": "Comp",
            "source_table": "api_card_actions"
        },
        {
            "sql_source": "DECLARE @search nvarchar(128) ,@button nvarchar(128)\nEXEC sp_api_modal_input @name='search',@value = @search OUT,@focus=1\n\nSET @button = 'Landen'\nEXEC sp_api_modal_button @name='button',@value = 'Landen',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_button @name='button',@value = 'Steden',@valueout = @button OUT,@class = 'btn-primary',@key = 'F2'\nEXEC sp_api_modal_button @name='button',@value = 'Landen3',@valueout = @button OUT,@class = 'btn-primary',@key = 'F3'\nEXEC sp_api_modal_button @name='button',@value = 'Vroeg',@valueout = @button OUT,@class = 'btn-primary',@key = 'F4'\n\n\nIF @button = 'Landen'\n\tBEGIN\n\t\tSELECT TOP 50 Countryid, name_0 INTO #landen FROM xCountry WHERE name_0 LIKE @search+'%'\n\t\tEXEC sp_api_modal_table @tmptable=N'#landen'\n\tEND\n/*\n-- er kan maar 1 tijdelijke tabel zijn met de naam #landen; wil je meer, dan moet je een andere naam kiezen (#landen2)\nIF @button = 'Landen2'\n\tBEGIN\n\t\tSELECT TOP 50 * INTO #landen2 FROM xCountry WHERE name_0 LIKE @search+'%'\n\t\tEXEC sp_api_modal_table @tmptable=N'#landen2'\n\tEND\n*/\n\n--Je kan OOK de layout gebruiken van een bestaande kaart: ( hierbij wel oppassen voor SQL-injection !!)\n\tIF @button = 'Landen3'\n\t\tBEGIN\n\t\t\t--via layout normale kaart xCountry = 394 (zie apicard)\n\t\t\tDECLARE @reducer nvarchar(max) = N'Name_0 like '+dbo.escape_string(@search+'%')\n\t\t\tEXEC sp_api_modal_table @card_id=394,@reducer = @reducer\n\t\tEND\n\t\n\nIF @button = 'Steden'\n\tBEGIN\n\t\t--SET @Description = CONCAT(N'Historie', ' - ' + {[stock_ctr2].Description})\n--\t\tEXEC sp_api_modal_text @text = @Description,@class = 'h3 text-muted'\n\t\tSELECT TOP 50 id,name,[Land*]=(SELECT Name_0 FROM xCountry WHERE CountryID = Country_ID) INTO #steden FROM xCity WHERE name LIKE @search+'%' ORDER BY [Land*]\n\t\tEXEC sp_api_modal_table @tmptable=N'#steden'\n\tEND\n\nIF @button =  'Vroeg'\nBEGIN\nSELECT DISTINCT dbo.xStock.Stock AS Voorraad@, dbo.xStock.Stock + dbo.xStock.delayedIn + dbo.xStock.delayedOut AS VoorraadVerwacht@, \ndbo.xStock.Description, dbo.xStock.Size, dbo.xStock.Origin_Code, [EndTime*]=dbo.xTransactionHeader.EndTime\nINTO #Vroeg\nFROM            dbo.xTransactionHeader RIGHT OUTER JOIN\n                         dbo.xTransactionDetail ON dbo.xTransactionHeader.id = dbo.xTransactionDetail.TransactionHeader_ID RIGHT OUTER JOIN\n                         dbo.xStock ON dbo.xTransactionDetail.Stock_ID = dbo.xStock.id\nWHERE        (dbo.xStock.Stock < 0) and EndTime = 'Vroeg'\nEXEC sp_api_modal_table @tmptable=N'#Vroeg'\nEND\n",
            "action_id": 1,
            "action_name": "_sample_instant_report",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_goto @path='/xrole'",
            "action_id": 2,
            "action_name": "a_Role",
            "source_table": "api_actions"
        },
        {
            "sql_source": "\nDECLARE @hclass nvarchar(255) = N'h4 pt-4'\n\t,@subclass nvarchar(255) = N'text-muted blockquote mt-4'\n\t,@codeclass nvarchar(255) = N'code pre mb-2'\n\t,@valueout nvarchar(255)\n\nEXEC sp_api_modal_text 'Action Help','h3 text-muted'\n\nEXEC sp_api_modal_text 'Performance tips',@hclass\nEXEC sp_api_modal_text 'To disable triggers on temp inserts/updates:',@subclass\nEXEC sp_api_modal_text 'IF TRY_CAST(SESSION_CONTEXT(N''api_save_confirmed'') as INT) = 0 RETURN',@codeclass\n\nEXEC sp_api_modal_text 'Choose option',@hclass\n\n\n\n\nEXEC sp_api_modal_text 'Choose option',@hclass\n\n\tEXEC sp_api_modal_text N'EXEC sp_api_modal_choose @list = N''Predefined,Custom,Later, Maybe'',@value = @button_choose OUT,@startkey=NULL',@codeclass\n\n\n\tEXEC sp_api_modal_text @text = N'Kies een optie met F-toetsen (@startkey=3)',@class = N'm-4 text-muted'\n\tDECLARE @button_choose nvarchar(128)\n\tEXEC sp_api_modal_choose @list = N'Predefined,Custom,wert,wertr,wywer,tqyer,twertq,ewrt',@value = @button_choose OUT,@startkey=3\n\tEXEC sp_api_modal_text @button_choose\n\n\tEXEC sp_api_modal_text @text = N'Kies een optie met beginletter-toetsen (spatie = geen, @startkey=NULL)',@class = N'm-4 text-muted'\n\tDECLARE @button_choose2 nvarchar(128)\n\tEXEC sp_api_modal_choose @list = N'Predefined,Custom, wert,wertr, wywer,tqyer, twertq,ewrt2',@value = @button_choose2 OUT,@startkey=NULL\n\tEXEC sp_api_modal_text @button_choose2\n\n\nEXEC sp_api_modal_text 'pathname',@hclass\n\nEXEC sp_api_modal_text 'go to url:',@subclass\nEXEC sp_api_modal_text '{\"pathname\":\"/verkoop\"}',@codeclass\n\nEXEC sp_api_modal_text 'add to current url with optional {selectedId}:',@subclass\nEXEC sp_api_modal_text '{\"addto\":\"{selectedId}/CTR\"}',@codeclass\n\nEXEC sp_api_modal_text 'stored_procedure',@hclass\n\nEXEC sp_api_modal_text 'modal text:',@subclass\nEXEC sp_api_modal_text N'EXEC sp_api_modal_text @text = N''This is a success!''\n\t,@class = N''alert alert-primary'', @translate = 1',@codeclass\nEXEC sp_api_modal_text @text = N'This is a success!',@class = N'alert alert-primary', @translate = 1\n\nEXEC sp_api_modal_text 'modal input:',@subclass\nEXEC sp_api_modal_text N'EXEC sp_api_modal_input @name=''Naam'',@max=5, @value= @valueout OUT,@focus=1',@codeclass\nEXEC sp_api_modal_input @name='Naam',@max=5, @value= @valueout OUT,@focus=0\n\nEXEC sp_api_modal_text 'modal input decimal:',@subclass\nEXEC sp_api_modal_text N'EXEC sp_api_modal_input_decimal @name=''Percentage'',@value= @Percentage OUT,@focus=1 [,@precision=18,@scale=2]',@codeclass\nDECLARE @Percentage decimal(18,2)\nEXEC sp_api_modal_input_decimal @name='Percentage', @value= @Percentage OUT\n\n\n\nEXEC sp_api_modal_text 'modal date:',@subclass\nEXEC sp_api_modal_text N'EXEC sp_api_modal_date @name=''Datum''@value= @valueout OUT,@focus=1',@codeclass\nEXEC sp_api_modal_date @name='Datum', @value= @valueout OUT,@focus=0,@class='w-24'\n\n\nEXEC sp_api_modal_text 'modal button:',@subclass\nEXEC sp_api_modal_text N'DECLARE @button1 nvarchar(128),@button_text1 nvarchar(128) = ''Opslaan''\nEXEC sp_api_modal_button @name=''button1'',@value = @button_text1, @valueout = @button1 OUT ,@class=''btn-danger'',@key=''Enter''',@codeclass\nDECLARE @button1 nvarchar(128),@button_text1 nvarchar(128) = 'Opslaan'\nEXEC sp_api_modal_button @name='button1',@value = 'Opslaan', @valueout = @valueout OUT,@class='btn-danger',@key='Enter'\nIF @valueout = 'Opslaan'\n\tBEGIN\n\t\tEXEC sp_api_modal_clear\n\t\tEXEC sp_api_statusbar N'HELP F1 - JA gedrukt!' ,'bg-danger col-sm-2 text-truncate',1 --> 1 is rechts\n\t\tRETURN\n\tEND\n\nEXEC sp_api_modal_text 'modal route:',@subclass\nEXEC sp_api_modal_text N'EXEC  sp_api_modal_route @name = N''Verkoop Anaco'',@pathname=N''/verkoop''\n\t,@search =N''?id=2784'' ,@class = N''btn-success'' ,@key = N''F2''',@codeclass\nEXEC  sp_api_modal_route @name = N'Verkoop Anaco',@pathname=N'/verkoop',@search =N'?id=2784' ,@class = N'btn-success' ,@key = N'F2'\n\nEXEC sp_api_modal_text 'modal clear all previous components:',@subclass\nEXEC sp_api_modal_text N'EXEC sp_api_modal_clear',@codeclass\n\nEXEC sp_api_modal_text 'Alert box:',@subclass\nEXEC sp_api_modal_text N'EXEC sp_api_modal_alert N''Give me an alert''',@codeclass\n\nEXEC sp_api_modal_text 'modal get user setting:',@subclass\nEXEC sp_api_modal_text N'EXEC sp_api_modal_get N''my_fake_name'',@naam OUT',@codeclass\n\nEXEC sp_api_modal_text 'modal set user setting:',@subclass\nEXEC sp_api_modal_text N'EXEC sp_api_modal_set N''my_fake_name'',N''Jack van Vliet''',@codeclass\n\nEXEC sp_api_modal_text 'modal set modal value:',@subclass\nEXEC sp_api_modal_text N'EXEC sp_api_modal_value @name,NULL',@codeclass\n\n\nEXEC sp_api_modal_text 'modal set delete user setting:',@subclass\nEXEC sp_api_modal_text N'EXEC sp_api_modal_set N''my_fake_name'',NULL',@codeclass\n\nEXEC sp_api_modal_text 'modal set delete user setting:',@subclass\nEXEC sp_api_modal_text N'EXEC sp_api_modal_set N''my_fake_name'',NULL',@codeclass\n\nEXEC sp_api_modal_text 'Toast message:',@subclass\nEXEC sp_api_modal_text N'EXEC sp_api_toast @text = N''Toast message Toast message !!! ???''\n,@class=N''bg-danger text-white'',@translate=1,@seconds=2',@codeclass\nEXEC sp_api_toast @text = N'Toast message Toast message !!! ???',@class=N'bg-danger text-white',@translate=1,@seconds=2\n\nEXEC sp_api_modal_text 'Send dispatch to modal, to dispatch something on the client:',@subclass\nEXEC sp_api_modal_text N'EXEC sp_api_modal_dispatch N''{\"type\":\"stored_procedure\",\"name\":\"Choose columns\"}''',@codeclass\n\nEXEC sp_api_modal_text 'modal post and save to card example:',@subclass\nEXEC sp_api_modal_text N'IF TRY_CAST(@prijs as decimal) > 0 AND TRY_CAST(@aantal as int) > 0\n\tBEGIN\n\t\tEXEC sp_api_modal_post @card=''verkocht'',@column=''aantal'',@value=@aantal\n\t\tEXEC sp_api_modal_post @card=''verkocht'',@column=''prijs'',@value=@prijs\n\t\tEXEC sp_api_modal_post @card=''verkocht'',@column=''prosoort_id'',@value=@id\n\t\tEXEC sp_api_modal_save @card=''verkocht''\n\t\tEXEC sp_api_modal_clear\n\tEND',@codeclass\n\nEXEC sp_api_modal_text 'Push to statusbar:',@subclass\nEXEC sp_api_modal_text N'EXEC sp_api_statusbar N''HELP F1'' ,''bg-danger col-sm-1 text-truncate'',1 --> 1 is rechts',@codeclass\n\nEXEC sp_api_statusbar N'HELP F1' ,'bg-danger col-sm-1 text-truncate',0 --> 1 is rechts\n\nEXEC sp_api_modal_text 'Cursor for @ids:',@subclass\nEXEC sp_api_modal_text N'DECLARE @cursor CURSOR,@idval INT\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,'','')\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @idval\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tEXEC sp_api_modal_text @idval\n\t\tFETCH NEXT FROM @cursor INTO @idval\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\n',N'code'\n",
            "action_id": 3,
            "action_name": "sys_action_help",
            "source_table": "api_actions"
        },
        {
            "sql_source": null,
            "action_id": 5,
            "action_name": "alle bedrijven",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_goto @path='/xbol'",
            "action_id": 6,
            "action_name": "B/L",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_choose_columns @card_id,@is_form",
            "action_id": 10,
            "action_name": "Choose columns",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @set nvarchar(max) -- CUSTOMIZE THIS!!! = N'name=name+''_clone'''\n\nEXEC sp_api_modal_alert N'Clone',N'Create a clone of this record?'\nDECLARE @clone_id nvarchar(32)\nEXEC @clone_id = sp_clone_record @basetable,@ids,@set=@set\nEXEC sp_api_modal_clear\nSET @path = @path+'/'+@clone_id\nEXEC sp_api_modal_text N'Record cloned',N'h4 text-muted'\nEXEC sp_api_modal_route @name = N'Go to clone',@pathname=@path,@key='Enter'\n",
            "action_id": 11,
            "action_name": "sys_clone",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_modal @class=N'w75'\n--EXEC sp_api_toast @parent_parent_id\n--exec sp_api_toast @User\nDECLARE /*@search nvarchar(128) = {[verkoop].CounterParty_ID.Code} ,@button nvarchar(128),*/@Description nvarchar(max)\nDECLARE @Counterparty_ID INT ={[verkoop].Counterparty_ID}\nDECLARE @PriceType nvarchar(10) =N'FIXED' -- 201215 wordt overschreven naar ZERO bij fust!\nif @Counterparty_ID IS NULL\n\tbegin\n\t\tset @Counterparty_ID={[klant].id} -- context is dan kennelijk \"verkoop direct vanaf de klant\"\n\tend\n\n\t\nDECLARE @CTHID INT = {[verkoop].id} --200818 curly\n--ALS CTHID NULL -> AANMAKEN\nif @CTHID IS NULL AND @Counterparty_ID IS NOT NULL --maak een nieuwe verkooporder aan\n\tbegin\n\t\tset @Counterparty_ID={[klant].id}\n\t\texec @CTHID = @main_db.dbo.CreateSelectCTH2 @Counterparty_ID\n\tend\n--ALS CTHID NOG STEEDS NULL -> Afbreken!\nIF @CTHID IS NULL begin\n\t\tEXEC sp_api_toast 'Kan geen [verkoop] vinden'\n\t\tRETURN;\n\t\tend\n\nDECLARE @Status nvarchar(50)\nDECLARE @FlowModel int\nDECLARE @THDT INT\nDECLARE @FRAFOT Nvarchar(3) -- 'FRA' OF 'FOT'\nDECLARE @SrcID int -- let op: slechts 'advies'\nDECLARE @DstID INT\n\nSELECT @Status=CTH.Status,@FlowModel=cth.FlowModel_ID,@THDT=cth.TDT,@FRAFOT=cth.FRAFOT, @srcID=cth.source_ID,@DstID=cth.Destination_ID From q_xTransactionHeader CTH where CTH.ID=@CTHID\nDECLARE @ctr_id int\nDECLARE @StockID int ={[stock_ctr2].id} -- 201030 beter dan '@ID'\nIF @StockID IS NULL SET @ctr_id = {[ctr2].id} --Alleen ctr_id halen indien NIET in stock_ctr2\nDECLARE @ctr_amount int = {[ctr2].Amount}\nDECLARE @ctr_price float = {[ctr2].Price}\nIF @StockID is NULL SET @StockID = {[ctr2].Stock_ID}\n\nIF @StockID is NULL \n\tbegin\n\t\tSET @StockID=@ID -- fall back gevaarlijk!!\n\t\texec sp_api_toast N'Pas op: het voorraad ID afkomstig uit PARENT'\n\tend\n\n\nDECLARE @mes nvarchar(200), @FustSaldo int, @CoreType nvarchar(10),@FustID int, @xDesc nvarchar(200),@CPP120 nvarchar(10)\n\n--201030 IF er bij\nSELECT @xDesc=x.[Description],@mes= concat(IIF(@ctr_id IS NULL,'Selling ','Changing ') , x.[Description],N' (cpp ',x.cp120,N')') ,@Coretype= x.coretype,@FustID=x.Fust_ID, @CPP120=x.cp120 from xstock x where x.id=@StockID  --@main_db.dbo.\n--EXEC sp_api_modal_text @mes,'h2 text-primary'\n\nIF @Status not in ('openSale') AND @Coretype='FOOD' BEGIN --200924 fust mag wel worden bij of afgeboekt\n\tEXEC sp_api_modal_alert 'U kunt alleen leeg FUST toevoegen/terugnemen, want de order is definitief.'\n\tEXEC sp_api_modal_clear\t\t\n\tRETURN;\t\n\tend\n\n-- 200629 Uitbreiding inkoop vanuit diverse contexten: Zoek CTH ; bijv als we afkomstig zijn van een regel, dan is CTH te vinden in de regel\n--if @parent_card_name ='verkoop'\tset @CTHID=@parent_id\n--if @parent_card_name = 'ctr2' set @CTHID=(select TransactionHeader_ID from xtransactiondetail where xtransactiondetail.id=@parent_id)\n\n\n------\nIF @coretype in('CRATE','PALLET')\n\tBEGIN\n\t\tSELECT @Fustsaldo=Fustsaldo from @main_db.dbo.FustSaldo_FC(@FustID,@Counterparty_ID)--{[verkoop].Counterparty_ID})\n\t\tEXEC sp_api_toast @Fustsaldo\n\t\t-- breid DECLARE message uit met het fust-saldo\n\t\tIF @FustSaldo is not NULL\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') actueel saldo bij deze klant: ',@fustsaldo)\n\t\tELSE\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') => let op: deze klant heeft dit fust nooit eerder gehad!')\n\t\tset @PriceType=N'ZERO'\n\tEND\n\n\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\nDECLARE @prijs nvarchar(20),@aantal nvarchar(20) --='100'\n--DECLARE @CounterpartyID int\n\n--201022\ndeclare @dayprice bit\nset @dayprice=isnull((select L from @main_db.dbo.[GetCompanySettings]('useDayprice')),0)\n--exec sp_api_toast @dayprice\n\n--exec sp_api_toast @dstID\n--200630 was@parent_id\n\n--if isnull(@Prijs,0)=0\n--\tbegin\n\t\t--SELECT top 1 @prijs = ctr.ctrPRICE FROM xctrtotals ctr WHERE ctr.ctrprice > 0 AND ctr.Counterparty_ID=@Counterparty_ID AND ctr.ctrStock_ID =@ID ORDER BY ctr.id DESC -- laatste prijs!\n\n\n\n--\tend\nDECLARE @button nvarchar(128), @buttonvalue nvarchar(128) = 'Toevoegen'\nIF @ctr_id IS NOT NULL\n\tBEGIN\n\t\tSET @buttonvalue = 'Bijwerken'\n\t\tSET @aantal = @ctr_amount\n\t\tSET @prijs = @ctr_price\n\tEND\nELSE\n\tBEGIN\n\t\tset @prijs=(select @main_db.dbo.stockprice(\t@StockID--201030 @ID --48482 --stock_ID\n\t\t\t\t\t\t\t,@CTHID --3761\t--CTHID\n\t\t\t\t\t\t\t,@Counterparty_ID --161418\t--Counterparty_ID\n\t\t\t\t\t\t\t,@FlowModel --null\t--Flowmodel_ID\n\t\t\t\t\t\t\t,@THDT --2\t\t--DaTDT\n\t\t\t\t\t\t\t,@SrcID --NULL --SupplierLocation_ID\n\t\t\t\t\t\t\t,@DstID --NULL -- 7945\t--Receiverlocation_ID\n\t\t\t\t\t\t\t,IIF(@FRAFOT='FOT',1,0)\t\t--isFOT\n\t\t\t\t\t\t\t,@dayprice --0-- use dayprice\n\t\t\t\t\t\t)\n\t\t\t\t\t)\n\tEND\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\nSET @text = N'Aantal'+IIF( @coretype in('FOOD'),' x Prijs','')\nEXEC sp_api_modal_text @text\nDECLARE @focus BIT = IIF(@ctr_id IS NULL,1,0)\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=@focus,@inline = 1\nIF @coretype in('FOOD')\n\tBEGIN\n\t\t--EXEC sp_api_modal_text 'Prijs'\n\t\tDECLARE @selected BIT = IIF(@ctr_id IS NULL,0,1)\n\t\tSET @focus = IIF(@ctr_id IS NULL,0,1)\n\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT,@focus=@focus,@inline = 1,@select=@selected\n\tEND\nEXEC sp_api_modal_button @name='button',@value = @buttonvalue,@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\nIF @button IS NOT NULL\n\tBEGIN\n\t\t--SET @Prijs = dbo.str2dec(@Prijs)\n\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') -- 200924 zorg dat je ook komma mag gebruiken als decimaal scheidingsteken\n\t\t/* 201107 ook prijscontrole weer invoeren! bijvoorbeeld op 2 punten/kommas */\n\t\tIF \t((ISNULL(@Prijs,N'')=N'' OR\ttry_cast(@prijs as decimal(10,2)) > 0) AND (TRY_CAST(@aantal as int) >\t 0 OR @aantal = 'x') ) \n\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\n\t\t\tBEGIN\n\t\t\t\tIF @aantal = 'x' SET @aantal = 0\n\t\t\t\tIF @ctr_id IS NOT NULL\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tUPDATE xTransactionDetail SET amount = @aantal, price = @Prijs WHERE id = @ctr_id\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' bijgewerkt' from xstock x where x.id=@StockID\n\t\t\t\t\t\texec sp_api_toast @mes\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\t\t\tRETURN\n\t\t\t\t\tEND\n\t\t\t\tELSE\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tDECLARE @mapfustpartijregel int\n\t\t\t\t\t\tSET @mapfustpartijregel=(select @main_db.dbo.FustIV_VTD(@FustID))\n\t\t\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@StockID,@Amount=@Aantal,@Price=@Prijs,@priceType=@PriceType, @User=@User,@mapctr_id=@mapfustpartijregel\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@StockID\n\t\t\t\t\t\texec sp_api_toast @mes\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\t\t\tRETURN\n\t\t\t\t\tEND\n\t\t\tEND\n\t\tELSE\n\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\tEND\n\n\n\n\nDECLARE @RecLocID INT = {[verkoop].Destination_ID} --=> 201201 zie SET @MainLocID een paar regels lager !!!\n\t,@MainLocID int\n\t,@MainLoc nvarchar(200)\n\t--,@StockID INT = @id\n\t,@TestPrijs float\n\t,@TestPallets int\n\n--201201 NEEM DE HOOFDLOKATIE!\nset @MainLocID=(select defaultLocation_ID from xcompany where xcompany.id=@Counterparty_ID)\nset @MainLoc=(select LocationCode from xlocation where xlocation.id=@MainLocID)\nSET @Description = CONCAT(N'Calculator met berekeningen vanaf hoofdlokatie', ' - ' ,@MainLoc)\nEXEC sp_api_modal_text @text = @Description,@class = 'h5 text-muted mt-2'\n\n\n\nEXEC sp_api_modal_input @name='testprice',@value = @TestPrijs OUT,@focus=0,@select=0,@inline=1\nEXEC sp_api_modal_button @name='buttontestprice',@value = 'Calculate',@valueout = @button OUT,@class = 'btn-primary'\n\nSET @TestPrijs = ISNULL(@TestPrijs,0)\nSET @TestPallets = ISNULL(@TestPallets,0)\nselect\n\t [Ignore] = case when ignore=1 then 'xxxxxx' else '   ' end\n,[Supplier~col-sm-2] = SupplierLoc\n, FP as [Full*] \n,inPrice as [inPrice:2]\n, Trans_SC as [Oprij:2]\n--, Fusthuur as [Fusthuur:2]\n, fot_price as [FOT_Price:2]\n--, fot_marge as [FOT_Marge:2]\n, fra_price as [FRA_Price:2]\n, fra_marge as [FRA_Marge:2]\n, min_fra as [Min_FRA:2]\n, min_fot as [Min_FOT:2]\n--, TR_Oprijden as [TR_Oprijden:2]\n,  TR_Klantvracht as [TR_Klantvracht:2]\n--,fustTranspFactor\n--, Trans_SR as [Transport direct:2]\n--, RfinPerc\n, [WF~col-sm-1-2] = WF\n,[Valid date~col-sm-2] = validDate\nINTO #t_price_tmp\n from @main_db.dbo.tP_Flex(@MainLocID,@StockID,@TestPrijs,@TestPallets  ) --201201 @MainLocID ipv RecLocID\n\torder by FP, Validdate desc, SupplierLoc\nDELETE FROM #t_price_tmp WHERE [Valid date~col-sm-2] < CAST(GETDATE() as DATE) --THIS IS STUPID!!! Anders tP_Flex aanpassen???\n\nEXEC sp_api_modal_table @tmptable=N'#t_price_tmp'\n\n--201201\n\nSET @Description = N'Momentprijs informatie'\nEXEC sp_api_modal_text @text = @Description,@class = 'h5 text-muted mt-2'\n\nSELECT [FP],\t[wFOT_Price],\t[wFRA_Price],\t[Moment]  INTO #Momentinfo FROM @main_db.dbo.xPriceMoment where  art_ID=@StockID  AND  Receiver_ID=@Counterparty_ID\nEXEC sp_api_modal_table @tmptable=N'#Momentinfo'\n\n\n-- einde 201201\nSET @Description = CONCAT(N'Andere verkopen', ' - ' + {[stock_ctr2].Description})\nEXEC sp_api_modal_text @text = @Description,@class = 'h5 text-muted mt-2'\n\nSELECT TOP 4 * INTO #salesByDateStock FROM @main_db.dbo.salesByDateStock(GETDATE(),@id,NULL) ORDER BY transactiondate DESC\nEXEC sp_api_modal_table @tmptable=N'#salesByDateStock'\n\nSET @Description = CONCAT(N'Eerdere verkopen aan ', {[verkoop].CounterParty_ID.CompanyName})\nEXEC sp_api_modal_text @text = @Description,@class = 'h5 text-muted mt-2'\n\nSELECT TOP 4 * INTO #salesByDateStockCounterParty FROM @main_db.dbo.salesByDateStock(NULL,@id,{[verkoop].CounterParty_ID}) ORDER BY transactiondate DESC\nEXEC sp_api_modal_table @tmptable=N'#salesByDateStockCounterParty'\n\n\n/*\nEXEC sp_api_modal_text 'Filter prijzen',N'mt-4 h5'\nDECLARE @search nvarchar(128) = isnull(\n\t\t\t\t\t\t\t\t\t\t{[verkoop].CounterParty_ID.Code} \n\t\t\t\t\t\t\t\t\t\t,{[klant].Code}\n\t\t\t\t\t\t\t\t\t\t)\nEXEC sp_api_modal_input @name='search',@value = @search OUT\nSELECT\n\t[Supplier*] = (SELECT CONCAT(Code,' - ',CompanyName) FROM xCompany WHERE id = Supplier_ID)\n\t,Receiver = (SELECT CONCAT(Code,' - ',CompanyName) FROM xCompany WHERE id = Receiver_ID)\n\t,[inPrice] = inPrice\n\t,Pallet = IIF(FullPalletPrice=1,'Full Pallet','')\n\t\tINTO #modaltable FROM t_Price this WHERE Art_ID = @StockID AND (\n\t\t\t(SELECT CONCAT(Code,' - ',CompanyName) FROM xCompany WHERE id = Supplier_ID) LIKE '%'+@search+'%'\n\t\t\t\tOR\n\t\t\t(SELECT CONCAT(Code,' - ',CompanyName) FROM xCompany WHERE id = Receiver_ID) LIKE '%'+@search+'%'\n\t)\nEXEC sp_api_modal_table\n*/\n\n\n",
            "action_id": 15,
            "action_name": "CTH2_GlobalSelectAmount",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--EXEC sp_api_toast @parent_parent_id\n--exec sp_api_toast @User\n\t\nDECLARE @CTHID INT = {[verkoop].id} --200818 curly\nDECLARE @StockID INT ={[stock_ctr2].id} -- 201030 beter dan '@ID'\nIF @StockID is NULL SET @StockID=@ID -- fall back\n\nIF @CTHID IS NULL begin\n\t\tEXEC sp_api_toast 'Kan geen [verkoop] vinden'\n\t\tRETURN;\n\t\tend\n--ELSE EXEC sp_api_toast @CTHID\n\nDECLARE @mes nvarchar(200), @FustSaldo int, @CoreType nvarchar(10),@FustID int, @xDesc nvarchar(200)\n\n--201030 IF er bij\nSELECT @xDesc=x.[Description],@mes= concat('Selling ' , x.[Description]) ,@Coretype= x.coretype,@FustID=x.Fust_ID from xstock x where x.id=@StockID  --@main_db.dbo.\n--EXEC sp_api_modal_text @mes,'h2 text-primary'\n\nIF {[verkoop].status} not in ('openSale') AND @Coretype='FOOD' BEGIN --200924 fust mag wel worden bij of afgeboekt\n\tEXEC sp_api_modal_alert 'U kunt alleen leeg FUST toevoegen/terugnemen, want de order is definitief.'\n\tEXEC sp_api_modal_clear\t\t\n\tRETURN;\t\n\tend\n\n-- 200629 Uitbreiding inkoop vanuit diverse contexten: Zoek CTH ; bijv als we afkomstig zijn van een regel, dan is CTH te vinden in de regel\n--if @parent_card_name ='verkoop'\tset @CTHID=@parent_id\n--if @parent_card_name = 'ctr2' set @CTHID=(select TransactionHeader_ID from xtransactiondetail where xtransactiondetail.id=@parent_id)\n\n\n------\nIF @coretype in('CRATE','PALLET')\n\tBEGIN\n\t\tSELECT @Fustsaldo=Fustsaldo from @main_db.dbo.FustSaldo_FC(@FustID,{[verkoop].Counterparty_ID})\n\t\tEXEC sp_api_toast @Fustsaldo\n\t\t-- breid DECLARE message uit met het fust-saldo\n\t\tIF @FustSaldo is not NULL\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') actueel saldo bij deze klant: ',@fustsaldo)\n\t\tELSE\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') => let op: deze klant heeft dit fust nooit eerder gehad!')\n\tEND\n\n\n\n\n\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\nDECLARE @prijs nvarchar(20),@aantal nvarchar(20) --='100'\nDECLARE @CounterpartyID int\nDECLARE @FlowModel int\nDECLARE @THDT INT\nDECLARE @FRAFOT Nvarchar(3) -- 'FRA' OF 'FOT'\nDECLARE @SrcID int -- let op: slechts 'advies'\nDECLARE @DstID INT\n\n\n--201022\ndeclare @dayprice bit\nset @dayprice=isnull((select L from @main_db.dbo.[GetCompanySettings]('useDayprice')),0)\nexec sp_api_toast @dayprice\n\nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=cth.FlowModel_ID,@THDT=cth.TDT,@FRAFOT=cth.FRAFOT, @srcID=cth.source_ID,@DstID=cth.Destination_ID From q_xTransactionHeader CTH where CTH.ID=@CTHID\nexec sp_api_toast @dstID\n--200630 was@parent_id\n\nif isnull(@Prijs,0)=0\n\tbegin\n\t\t--SELECT top 1 @prijs = ctr.ctrPRICE FROM xctrtotals ctr WHERE ctr.ctrprice > 0 AND ctr.Counterparty_ID=@CounterpartyID AND ctr.ctrStock_ID =@ID ORDER BY ctr.id DESC -- laatste prijs!\n\n\t\tset @prijs=(select @main_db.dbo.stockprice(\t@StockID--201030 @ID --48482 --stock_ID\n\t\t\t\t\t\t\t,@CTHID --3761\t--CTH_ID\n\t\t\t\t\t\t\t,@CounterpartyID --161418\t--Counterparty_ID\n\t\t\t\t\t\t\t,@FlowModel --null\t--Flowmodel_ID\n\t\t\t\t\t\t\t,@THDT --2\t\t--DaTDT\n\t\t\t\t\t\t\t,@SrcID --NULL --SupplierLocation_ID\n\t\t\t\t\t\t\t,@DstID --NULL -- 7945\t--Receiverlocation_ID\n\t\t\t\t\t\t\t,IIF(@FRAFOT='FOT',1,0)\t\t--isFOT\n\t\t\t\t\t\t\t,@dayprice --0-- use dayprice\n\t\t\t\t\t\t)\n\t\t\t\t\t)\n\n\tend\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\nEXEC sp_api_modal_text 'Aantal'\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1\nIF @coretype in('FOOD')\n\tBEGIN\n\t\tEXEC sp_api_modal_text 'Prijs'\n\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT\n\tEND\nDECLARE @button nvarchar(128)\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\nIF @button IS NOT NULL\n\tBEGIN\n\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') -- 200924 zorg dat je ook komma mag gebruiken als decimaal scheidingsteken\n\t\t/* 201107 ook prijscontrole weer invoeren! bijvoorbeeld op 2 punten/kommas */\n\t\tIF \t((@Prijs=N'' OR\ttry_cast(@prijs as decimal(10,2)) > 0) AND \tTRY_CAST(@aantal as int) >\t 0 ) \n\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\n\t\t\tBEGIN\n\t\t\t\tDECLARE @mapfustpartijregel int\n\t\t\t\tSET @mapfustpartijregel=(select @main_db.dbo.FustIV_VTD(@FustID))\n\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@StockID,@Amount=@Aantal,@Price=@Prijs,@priceType=N'FIXED', @User=@User,@mapctr_id=@mapfustpartijregel\n\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@StockID\n\t\t\t\texec sp_api_toast @mes\n\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\n\t\t\t\tRETURN\n\t\t\tEND\n\t\tELSE\n\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\n\tEND\n\nEXEC sp_api_modal_text 'Filter prijzen',N'mt-4 h5'\nDECLARE @search nvarchar(128) = {[verkoop].CounterParty_ID.Code} \nEXEC sp_api_modal_input @name='search',@value = @search OUT\nSELECT\n\t[Supplier*] = (SELECT CONCAT(Code,' - ',CompanyName) FROM xCompany WHERE id = Supplier_ID)\n\t,Receiver = (SELECT CONCAT(Code,' - ',CompanyName) FROM xCompany WHERE id = Receiver_ID)\n\t,[inPrice] = inPrice\n\t,Pallet = IIF(FullPalletPrice=1,'Full Pallet','')\n\t\tINTO #modaltable FROM t_Price this WHERE Art_ID = @StockID AND (\n\t\t\t(SELECT CONCAT(Code,' - ',CompanyName) FROM xCompany WHERE id = Supplier_ID) LIKE '%'+@search+'%'\n\t\t\t\tOR\n\t\t\t(SELECT CONCAT(Code,' - ',CompanyName) FROM xCompany WHERE id = Receiver_ID) LIKE '%'+@search+'%'\n\t)\nEXEC sp_api_modal_table\n",
            "action_id": 16,
            "action_name": "CTH2_SelectAmount_",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_goto @path='xcustomsoffice'",
            "action_id": 17,
            "action_name": "CustomsOffice",
            "source_table": "api_actions"
        },
        {
            "sql_source": null,
            "action_id": 18,
            "action_name": "Del Comp",
            "source_table": "api_actions"
        },
        {
            "sql_source": null,
            "action_id": 19,
            "action_name": "Deurbel",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast N'Ding dong'",
            "action_id": 20,
            "action_name": "Deurbel Ding Dong",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast N'Tring tring'",
            "action_id": 21,
            "action_name": "Deurbel Tring Tring",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_goto @path='/fieldname'",
            "action_id": 23,
            "action_name": "Fieldname",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_find_fields @card_id,@path,@id",
            "action_id": 25,
            "action_name": "Find Fields",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_goto @path='/xlocation'\n",
            "action_id": 26,
            "action_name": "goederenlokaties",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @search nvarchar(128) ,@button nvarchar(128)\nEXEC sp_api_modal_input @name='search',@value = @search OUT,@focus=1\n\nSET @button = 'Landen'\nEXEC sp_api_modal_button @name='button',@value = 'Landen',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_button @name='button',@value = 'Steden',@valueout = @button OUT,@class = 'btn-primary',@key = 'F2'\nEXEC sp_api_modal_button @name='button',@value = 'Landen3',@valueout = @button OUT,@class = 'btn-primary',@key = 'F3'\nEXEC sp_api_modal_button @name='button',@value = 'VroegNegatief',@valueout = @button OUT,@class = 'btn-primary',@key = 'F4'\nEXEC sp_api_modal_button @name='button',@value = 'NegatiefNietVroeg',@valueout = @button OUT,@class = 'btn-primary',@key = 'F5'\nEXEC sp_api_modal_button @name='button',@value = 'Negatief',@valueout = @button OUT,@class = 'btn-primary',@key = 'F6'\n\n\n\nIF @button = 'Landen'\n\tBEGIN\n\t\tSELECT TOP 50 Countryid, name_0 INTO #landen FROM xCountry WHERE name_0 LIKE @search+'%'\n\t\tEXEC sp_api_modal_table @tmptable=N'#landen'\n\tEND\n/*\n-- er kan maar 1 tijdelijke tabel zijn met de naam #landen; wil je meer, dan moet je een andere naam kiezen (#landen2)\nIF @button = 'Landen2'\n\tBEGIN\n\t\tSELECT TOP 50 * INTO #landen2 FROM xCountry WHERE name_0 LIKE @search+'%'\n\t\tEXEC sp_api_modal_table @tmptable=N'#landen2'\n\tEND\n*/\n\n--Je kan OOK de layout gebruiken van een bestaande kaart: ( hierbij wel oppassen voor SQL-injection !!)\n\tIF @button = 'Landen3'\n\t\tBEGIN\n\t\t\t--via layout normale kaart xCountry = 394 (zie apicard)\n\t\t\tDECLARE @reducer nvarchar(max) = N'Name_0 like '+dbo.escape_string(@search+'%')\n\t\t\tEXEC sp_api_modal_table @card_id=394,@reducer = @reducer\n\t\tEND\n\t\n\nIF @button = 'Steden'\n\tBEGIN\n\t\t--SET @Description = CONCAT(N'Historie', ' - ' + {[stock_ctr2].Description})\n--\t\tEXEC sp_api_modal_text @text = @Description,@class = 'h3 text-muted'\n\t\tSELECT TOP 50 id,name,[Land*]=(SELECT Name_0 FROM xCountry WHERE CountryID = Country_ID) INTO #steden FROM xCity WHERE name LIKE @search+'%' ORDER BY [Land*]\n\t\tEXEC sp_api_modal_table @tmptable=N'#steden'\n\tEND\n\nIF @button =  'VroegNegatief'\nBEGIN\nSELECT DISTINCT Voorraad@, VoorraadVerwacht@, Description, Size, Origin_Code, 'Vroeg Negatief' AS [CAP*]\nINTO #VroegNegatief\nFROM          RV_IR_VoorraadNeg\nWHERE        (Voorraad@ < 0) AND ([EndTime*] = 'Vroeg')\nEXEC sp_api_modal_table @tmptable=N'#VroegNegatief',@orderby=N'ORDER BY [CAP*],Description ASC'\nEND \n\nIF @button =  'NegatiefNietVroeg'\nBEGIN\nSELECT DISTINCT Voorraad@, VoorraadVerwacht@, Description, Size, Origin_Code, 'Negatief niet vroeg' AS [CAP*]\nINTO #NegatiefNietVroeg\nFROM          RV_IR_VoorraadNeg\nWHERE        (Voorraad@ < 0) AND ([EndTime*] != 'Vroeg')\nEXEC sp_api_modal_table @tmptable=N'#NegatiefNietVroeg',@orderby=N'ORDER BY [CAP*],Description ASC'\nEND \n\nIF @button =  'Negatief'\nBEGIN\nSELECT DISTINCT Voorraad@, VoorraadVerwacht@, Description, Size, Origin_Code, 'Negatief' AS [CAP*]\nINTO #Negatief\nFROM          RV_IR_VoorraadNeg\nWHERE        (Voorraad@ < 0)\nEXEC sp_api_modal_table @tmptable=N'#Negatief',@orderby=N'ORDER BY [CAP*],Description ASC'\nEND ",
            "action_id": 27,
            "action_name": "instant_report_example",
            "source_table": "api_actions"
        },
        {
            "sql_source": null,
            "action_id": 28,
            "action_name": "klanten",
            "source_table": "api_actions"
        },
        {
            "sql_source": null,
            "action_id": 29,
            "action_name": "landen",
            "source_table": "api_actions"
        },
        {
            "sql_source": null,
            "action_id": 30,
            "action_name": "leveranciers",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @text nvarchar(max)\n,@hclass nvarchar(128) = 'h5 text-muted mt-3'\n,@bclass nvarchar(128) = 'btn-primary'\n\nEXEC sp_api_modal_modal @class = 'pt-5'\nIF dbo.hasRole('admin') > 0 BEGIN\n\tSET @text = N'You''re at ' + @hostname + ' [@main_db]'\n\tEXEC sp_api_toast @text=@text,@seconds=3\nEND\n\nDECLARE @colorblind BIT = 0\nIF dbo.hasClaims('sub=email@anacogreeve.nl') > 0\nBEGIN\nSET @colorblind = 1\nEND\n\nDECLARE @extendedMenu BIT = 0\nIF dbo.hasClaims('sub=email@anacogreeve.nl') > 0\nBEGIN\nSET @extendedMenu = 1\nEND\n\nDECLARE @loods BIT = 0\nIF dbo.hasRole('loodsbaas,loodsmedewerker,ompakker,keurmeester') > 0\nBEGIN\nSET @loods = 1\nEND\n\n--ALS EERSTE!\n--EXEC sp_api_modal_action N'Scanner Test',@class='btn-danger'\nEXEC sp_api_modal_action N'Scanner',@class='btn-danger'\nEXEC sp_api_modal_action N'Mobilephone',@class='btn-danger'\nEXEC sp_api_modal_action N'detepo',@class='btn-danger'\nEXEC sp_api_modal_action N'micro_check_scan',@class='btn-danger' --rh 230825\nEXEC sp_api_modal_action N'test_rick_2',@class='btn-danger' --rh 230825\nEXEC sp_api_modal_action N'NEOVO_PALLET_SCAN',@class='btn-danger'\nEXEC sp_api_modal_action N'Barcode Scanner',@class='btn-tracy'\nEXEC sp_api_modal_action N'check_serial_number' --rh231218\nEXEC sp_api_modal_action N'check_pallets' --241129\nEXEC sp_api_modal_action N'check_pallets_in_stock' --241129\nEXEC sp_api_modal_action N'check_data' --rh240719\nEXEC sp_api_modal_action @name='RWS-podcast'\nEXEC sp_api_modal_action @name='rick_delete'\n\n\n--START\n\nIF @button = 'Quick menu'\n\tBEGIN\n\t\tEXEC #sys_quick_menu @path\n\t\tRETURN\n\tEND\n\nEXEC sp_api_modal_text 'Hoofdmenu','h1'\n\nif  dbo.hasClaims(N'tenant=AGNEOVO') >0 or dbo.hasRole('admin,directie') > 0\n\tbegin \n\t\t--EXEC sp_api_modal_action @name='pallet_status_agneovo',@class = 'btn-white border-dark text-dark' --test 230808\n\t\tEXEC sp_api_modal_route @cardname='pallet_status_agneovo'\t\n\tend\n\nEXEC sp_api_modal_route @cardname='wms_micro_outbound'\n\nIF dbo.hasClaims('sub=mterlouw@rwsbv.com') > 0 or dbo.hasClaims('sub=kterlouw@rwsbv.com') > 0 --250415\n\tor dbo.hasClaims('sub=rick@tracy.nu') > 0 OR dbo.hasRole('admin,directie,barsan,barsan_bo') > 0\nBEGIN\n\tEXEC sp_api_modal_route @cardname='douanevoorraadmutatie'\nEND\t\n\nIF dbo.hasRole('admin,directie,loodsmedewerker') > 0\nBEGIN\n\tEXEC sp_api_modal_route @cardname='vehicle_export_staging',@search= '?red=open'\nEND\t\n\n BEGIN\n\t-----------------\n\t-- ADMIN QUICK LIJST\n\t-----------------\n\n\t\tIF dbo.hasRole('admin') > 0\n\t\tBEGIN\n--\t\tEXEC sp_api_modal_text 'Admin Knopjes',@hclass\n--\t\tSET @bclass = 'btn btn-linkt border-danger text-dark'\n\t\t/*\n\t\tEXEC sp_api_modal_route @name='Product (Hoofdgroup)',@pathname='/xproduct',@search= '?red=',@class=@bclass,@key='P',@group = 'Voorraadbeheer'\n\t\tEXEC sp_api_modal_route @name='Intrastat Fout of Geen',@pathname='/xproduct',@search= '?red=Intrastat_ID+Empty+OR+Wrong',@class=@bclass,@key='I',@group = 'Voorraadbeheer'\n\t\tEXEC sp_api_modal_route @name='Geen Customs Group',@pathname='/xproduct',@search= '?red=Geen+Douane+Groep',@class=@bclass,@key='D',@group = 'Voorraadbeheer'\n\t\tEXEC sp_api_modal_route @name='Onvolledig Customs Art',@pathname='/xproduct',@search= '?red=Niet+(Volledig)+in+Customs+Art',@class=@bclass,@key='L',@group = 'Voorraadbeheer'\n\t\t*/\n\t\t\n\t\tEXEC sp_api_modal_route @name='To Do',@pathname='/api_todo',@search= '?red=Niet+klaar',@class='btn btn-linkt border-danger text-dark',@key='T'\n\t\tEXEC sp_api_modal_route @name='API DATASET',@pathname='/api_data_set'\n\t\tEND\n\t\n\t--------------\n\t-- Warehouse\n\t--------------\n--\tEXEC sp_api_modal_text 'Warehouse',@hclass\n\n\tIF @colorblind = 1\n\t\tBEGIN\n\t\t\tSET @bclass = 'btn-primary'\n\t\tEND\n\tELSE\n\t\tBEGIN\n\t\t\tSET @bclass = 'btn-secondary'\n\t\tEND\nIF dbo.hasRole('user,admin,directie') > 0\n\tbegin\n\n\t\n\t\tEXEC sp_api_modal_route @name='Vessel',@pathname='/w_vessel',@class=@bclass,@key='V'--, @Search='?red=Open+en+Nieuw',@group = 'main'\n\t\tEXEC sp_api_modal_route @name='Bill of Lading',@pathname='/w_bl',@class=@bclass,@key='Alt+B'--, @Search='?red=recent'--,@group = 'main'\n\t\tEXEC sp_api_modal_route @name='Forecast',@pathname='/forecast',@class=@bclass,@key='F'--, @Search='?red=Open+en+Nieuw',@group = 'main'\n\t\t\n\n\t--\tEXEC sp_api_modal_route @name='Inbound',@pathname='/inbound',@class=@bclass,@key='I'--, @Search='?red=Open+en+Nieuw',@group = 'main'\n\t--\tEXEC sp_api_modal_route @name='Outbound Transport',@pathname='/wms_out_transport',@class=@bclass,@key='O'--, @Search='?red=Open+en+Nieuw',@group = 'main'\n--\t\tEXEC sp_api_modal_action @name='report_menu',@class = 'btn-white border-dark text-dark'\n\t\t\n\n\t\t\n\tend\n--@name='Inbound Transport.',\n--\t\tEXEC sp_api_modal_route @name='Inbound Transport',@pathname='/wms_in_transport',@class=@bclass,@key='T'--, @Search='?red=Open+en+Nieuw',@group = 'main'\n\t\tEXEC sp_api_modal_route @name='Inbound Transport',@cardname='wms_in_transport',@class=@bclass,@key='T'--, @Search='?red=Open+en+Nieuw',@group = 'main'\n\n--IF dbo.hasRole('viewer') > 0\n\t--begin\n\n  \n\n\t--220319 NIEUW: DE CARD BEPAALT ZELF AAN DE HAND VAN DE ROLLEN OF HIJ GERENDERD WORDT..\nIF dbo.hasRole('loodsmedewerker') = 0 --specifiek ** UITSLUITEN ** bij menu voor loodsmedewerker\n\tbegin\n\t\tEXEC sp_api_modal_route @name='Inbound',@cardname='inbound',@class=@bclass,@key='I'\n\t\tEXEC sp_api_modal_route @name='Outbound Transport',@cardname='wms_out_transport',@class=@bclass,@key='O',@group = 'outbound'\n\t\tEXEC sp_api_modal_route @name='Micro outbound form',@cardname='wms_micro_outbound',@class=@bclass,@key='O'\t,@group=N'micro_outbound'\t\n\t\t\n\tend\n--230306 specifiek uitsluiten voor ensign\nif  dbo.hasClaims(N'tenant=VIAROT') =0 \t--iedereen behalve viaensign\t\n\tEXEC sp_api_modal_route @name='Outbound orders',@cardname='outbound_form',@class=@bclass,@key='O',@group = 'outbound'\n\n\t\tIF dbo.hasRole('admin,directie') > 0 -- micro werk!\n\t\t\tbegin\n\t\t\t\tEXEC sp_api_modal_route @name='Micro outbound form',@cardname='wms_micro_outbound',@class=@bclass,@key='O'\t,@group=N'micro_outbound'\t\n\t\t\t\tEXEC sp_api_modal_route @name='Replenishment',@cardname='w_pallet_replenishment',@class=@bclass,@key='R'\t,@group=N'micro_outbound'\t\t\n--\t\t\t\tEXEC sp_api_modal_route @name='Micro item stock info',@cardname='wms_micro_item_stock_info',@class=@bclass,@key='R'\t,@group=N'micro_outbound',@search= '?red=selecteerbare_pallets'\n\t\t\t\tEXEC sp_api_modal_route @name='micro_totals',@cardname='micro_totals',@class=@bclass,@key='T'\t,@group=N'micro_outbound'\n\n\t\t\t\t--231024\n\t\t\t\tEXEC sp_api_modal_route @cardname='micro_items_stock_per_position_agneovo'\n\t\t\tend\t\n\t\tEXEC sp_api_modal_route @name='Stock by Client',@cardname='wms_rv_pal_stock',@class=@bclass,@key='C'\n\n--230306 specifiek uitsluiten voor ensign\nif  dbo.hasClaims(N'tenant=VIAROT') =0 \n\t--alleen viarot uitsluiten, dus als je de claim niet hebt mag je dit item zien\n\tEXEC sp_api_modal_route @name='Stock by BL',@cardname='wms_rv_pal_stock_bl',@class=@bclass,@key='B'\n\n\t\tEXEC sp_api_modal_route @name='Stock by Container',@cardname='wms_rv_pal_stock_cnt',@class=@bclass,@key='N'\n\t\t--micro stock info\n--\t\tEXEC sp_api_modal_route @name='Stock per micro item',@cardname='micro_totals',@class=@bclass,@key='T'\t\n--per lotnumber\nIF dbo.hasRole('loodsmedewerker') = 0\n\tbegin --specifiek uitsluiten bij menu voor loodsmedewerker\n\t\tEXEC sp_api_modal_route @name='Stock per micro item',@cardname='micro_totals_lotnr_w_lot',@class=@bclass,@key='T'\t\n\tend\t\n\n\t\t--230114\n\t\tEXEC sp_api_modal_route @cardname='wms_io'\t\n\t\t--230710 uitgezet, driver-screen wordt via link direct gestart EXEC sp_api_modal_route @cardname='driver_screen'\t\n\t\tEXEC sp_api_modal_route @cardname='inbound_form_barsan'\t\n\t\t\n--\tend\n\t\t\n\t--------------\n\t-- Rapportage\n\t--------------\n\tEXEC sp_api_modal_action @name='report_menu',@class = 'btn-success'--'btn-white border-dark text-dark'\n\n\tIF dbo.hasRole('user,admin,directie') > 0\n\t\tBEGIN\n\t\t\t--EXEC sp_api_modal_text 'Rapportage (Maand Afsluiten)',@hclass\n\t\t\t--EXEC sp_api_modal_route @name='Aangifte',@pathname='/aangifte',@search= '',@class = 'btn-white border-dark text-dark',@key='A'\n\t\t\tEXEC sp_api_modal_route @name='Crossdock',@pathname='/w_crossdock',@class=@bclass,@key='C'\n\t\t\t\n\t\tEND\n\n\n/*\n\t-----------------\n\t-- VOORRAAD LIJST\n\t-----------------\n--\tEXEC sp_api_modal_text 'Artikelbestand (Voorraad)',@hclass\n--\tSET @bclass = 'btn-secondary'\n\t--EXEC sp_api_modal_route @name='xstock',@pathname='/xstock',@search= '',@class=@bclass,@key='X'\n\n\tIF @colorblind = 1\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_route @name='Totaal Voorraad per lokatie',@pathname='/stocklocation',@search= '',@class='btn-primary',@key='T',@group = 'Voorraad'\n\t\t\tEXEC sp_api_modal_route @name='Voorraad per lokatie',@pathname='/voorraadlokatie',@search= '',@class='btn-primary',@key='X',@group = 'Voorraad'\n\t\t\tEXEC sp_api_modal_route @name='Voorraad [Artikelen]',@pathname='/xstock',@search= '?red=',@class='btn-primary',@key='S',@group = 'Voorraad'\n\t\t\t\n\t\tEND\n\tELSE\n\t\tBEGIN\n\t\tEXEC sp_api_modal_route @name='Totaal Voorraad per lokatie',@pathname='/stocklocation',@search= '',@class=@bclass,@key='T',@group = 'Voorraad'\n\t\t\tEXEC sp_api_modal_route @name='Voorraad per lokatie',@pathname='/voorraadlokatie',@search= '',@class=@bclass,@key='X',@group = 'Voorraad'\n\t\t\tEXEC sp_api_modal_route @name='Voorraad [Artikelen]',@pathname='/xstock',@search= '?red=',@class=@bclass,@key='S',@group = 'Voorraad'\n\t\t\t\n\t\tEND\n*/\n\n\t------------\n\t-- Transactions\n\t------------\n--\tEXEC sp_api_modal_text 'Transacties',@hclass\n/*\n\tBEGIN\n\n\tEXEC sp_api_modal_route @name='Verkoop [Pakbon Niet Geprint]',@pathname='/verkoop',@search= '?red=Pickbon+NOG+NIET+GEPRINT' ,@class='btn-primary',@key='V',@group = 'verkoop'\n\n\tEXEC sp_api_modal_route @name='Filter [Pickbon Geprint]',@pathname='/verkoop',@search= '?red=Pickbon+Geprint' ,@class='btn-primary',@key='P',@group = 'verkoop'\n\tEXEC sp_api_modal_route @name='Verkoop [Alles]',@pathname='/verkoop',@search= '?red=' ,@class='btn-primary',@key='A',@group = 'verkoop'\n\tEXEC sp_api_modal_route @name='Filter [Commission]',@pathname='/verkoop',@search= '?red=Commission+%5BopenPrice%5D' ,@class='btn-primary',@key='C',@group = 'verkoop'\n\n\t--EXEC sp_api_modal_route @name='Verkoop [Vandaag]',@pathname='/verkoop',@search= '?red=Werkdatum+openSale' ,@class='btn-primary',@key='Ctrl+V',@group = 'verkoop'\n\n\tEXEC sp_api_modal_route @name='Filter [Pickbon Veranderd]',@pathname='/verkoop',@search= '?red=Pickbon+VERANDERD' ,@class='btn-primary',@key='W',@group = 'verkoop'\n\tEXEC sp_api_modal_route @name='Filter [Klaar voor Factuur]',@pathname='/verkoop',@search= '?red=Fase+Klaar+voor+Factuur' ,@class='btn-primary',@key='K',@group = 'verkoop'\n\tEXEC sp_api_modal_route @name='Filter [Gefactureerd]',@pathname='/verkoop',@search= '?red=Orders%3A+gefactureerd' ,@class='btn-primary',@key='F',@group = 'verkoop'\n\tEXEC sp_api_modal_route @name='Filter [Nog Toewijzen]',@pathname='/verkoop',@search= '?red=Toewijzen' ,@class='btn-primary',@key='T',@group = 'verkoop'\n\tEXEC sp_api_modal_route @name='Inkoop',@pathname='/inkoop',@search= '?red=',@class='btn-warning',@key='I',@group = 'inkoop'\n\tEXEC sp_api_modal_route @name='Open inkopen',@pathname='/inkoop',@search= '?red=Open+inkopen',@class='btn-primary',@key='O',@group = 'inkoop'\n\tEXEC sp_api_modal_route @name='Gesloten inkopen',@pathname='/inkoop',@search= '?red=Gesloten+inkopen',@class='btn-primary',@key='G',@group = 'inkoop'\n\tEXEC sp_api_modal_route @name='Inkoop [Vandaag]',@pathname='/inkoop',@search= '?red=Werkdatum',@class='btn-warning',@key='Ctrl+I',@group = 'inkoop'\n\tEXEC sp_api_modal_route @name='Douane Actie Nodig',@pathname='/inkoop',@search= '?red=Actie+nodig+(douane+tafel)',@class='btn-warning',@key='D',@group = 'inkoop'\n\tEXEC sp_api_modal_route @name='Verkoop Claims [New]',@pathname='/xclaim',@search= '?red=Status+%3D+New',@class='btn-danger',@key='Alt+C',@group = 'verkoop'\n\tEXEC sp_api_modal_route @name='AccountSale [Open]',@pathname='/xcth_accountsale',@search= '?red=Open',@class='btn-warning',@key='A',@group = 'accountsale'\n\tEXEC sp_api_modal_route @name='AccountSale [Invoiced]',@pathname='/xcth_accountsale',@search= '?red=Factuur+gemaakt',@class='btn-warning',@key='F',@group = 'accountsale'\n\t--EXEC sp_api_modal_route @name='Fust Inname',@pathname='/xfustreturned',@search= '?red=',@class='btn-white border-dark text-dark',@key='F'\n\t\tIF @extendedMenu = 1\n\t\tBEGIN\n\t\tEXEC sp_api_modal_route @name='Verkoop [Gereserveerd]',@pathname='/verkoop',@search= '?red=Orders+Reserved' ,@class='btn-primary',@key='Ctrl+V',@group = 'verkoop'\n\t\tEXEC sp_api_modal_route @name='Inkoop [Gereserveerd]',@pathname='/inkoop',@search= '?red=Orders+Reserved',@class='btn-warning',@key='Ctrl+I',@group = 'inkoop'\n\t\tEND\n\t\t\n\tEND\n*/\t\n\t\n/*\t\n\tEXEC sp_api_modal_text '',@class='row'\n\tEXEC sp_api_modal_action @name='Nieuwe Verkoop',@class='btn-primary',@keycode='ArrowUp'\n\tEXEC sp_api_modal_action @name='Nieuwe Inkoop',@class='btn-warning',@keycode='ArrowDown'\n*/\n\n/*\n\tIF dbo.hasRole('douane,admin') > 0\n\t\tBEGIN\n\t\t\n\t\t--------------\n\t\t-- Douane\n\t\t--------------\n\t\tEXEC sp_api_modal_text 'Douane',@hclass\n\t\t\n\t\tSET @bclass = 'btn-dark'\n\t\t\n\t\t\tIF EXISTS (SELECT * FROM check_lfctr_at_entrepot)\n\t\t\t\tBEGIN\n\t\t\t\t\tEXEC sp_api_modal_route @name='Verkoop Correctie',@pathname='/check_lfctr_at_entrepot',@search= '',@class='btn-danger',@key='E'\n\t\t\t\tEND\n\t\t\n\t\t\tEXEC sp_api_modal_route @name='Douane Saldo',@pathname='/douanesaldo',@search= '',@class=@bclass,@key='S',@group = 'Douaneoverzicht'--,@group = 'Container'\n\t\t\tEXEC sp_api_modal_route @name='Contingent',@pathname='/sf_femimp',@search= '',@class=@bclass,@key='C',@group = 'Douaneoverzicht'\n\t\t\t\n\t\t\tEXEC sp_api_modal_route @name='Import',@pathname='/xvessel',@search= '?red=Nog+Niet+Uitgelost&ord=22636,26417,22107',@class=@bclass,@key='B',@group = 'Container'\n\t\t\tEXEC sp_api_modal_route @name='Inslag document',@pathname='/xbol',@class=@bclass,@key='D',@group = 'Container'\n\t\t\tEXEC sp_api_modal_route @name='Containers',@pathname='/xcontainer',@class=@bclass,@key='C',@group = 'Container'\n\t\t\tEXEC sp_api_modal_route @name='Partij Douane Artikelen',@pathname='/xcthcustomsrows',@class=@bclass,@key='P',@group = 'Container'\n\t\t\t\n\t\t\t\n\t\t\tEXEC sp_api_modal_route @name='Douane Artikelen',@pathname='/xproductcustomsgroup',@search= '',@class=@bclass,@key='D',@group = 'DouaneArtikelGroup'\n\t\t\tEXEC sp_api_modal_route @name='Douane Artikelen Per Land',@pathname='/xcthcustomsart',@search= '',@class=@bclass,@key='A',@group = 'DouaneArtikelGroup'\n\t\t\tEXEC sp_api_modal_route @name='E-cert Groep',@pathname='/xclientbotanic',@search= '',@class=@bclass,@key='G',@group = 'DouaneArtikelGroup'\n\t\t\tEXEC sp_api_modal_route @name='E-cert Vari\u00ebteit',@pathname='/xclientexport',@search= '',@class=@bclass,@key='V',@group = 'DouaneArtikelGroup'\n\t\t\tEXEC sp_api_modal_route @name='Product (Hoofdgroup)',@pathname='/xproduct',@search= '?red=',@class=@bclass,@key='P',@group = 'DouaneArtikelGroup'\n\t\t\t\n\t\t\t--EXEC sp_api_modal_route @name='Binnenkomend (LF)',@pathname='/lf_aanvoer_inkomend',@search= '',@class=@bclass,@key='I',@group = 'Container'\n\t\t\t--EXEC sp_api_modal_route @name='Uitgaand (LF)',@pathname='/lf_aanvoer_uitgaand',@search= '',@class=@bclass,@key='U',@group = 'Container'\n\t\t\t\n\t\t\t\n\t\tEND\n*/\n\n\t--------------\n\t-- Facturatie\n\t--------------\n--\tEXEC sp_api_modal_text 'Facturatie',@hclass\n\n\tIF @colorblind = 1\n\t\tBEGIN\n\t\t\tSET @bclass = 'btn-primary'\n\t\tEND\n\tELSE\n\t\tBEGIN\n\t\t\tSET @bclass = 'btn-secondary'\n\t\tEND\nIF dbo.hasRole('user,admin,directie') > 0\n\tbegin\n\t--\tEXEC sp_api_modal_route @name='Uitgaande facturen',@pathname='/invoice',@class=@bclass,@key='Alt+U', @Search='?red=Open+en+Nieuw',@group = 'Factuuruit'\n\t\tEXEC sp_api_modal_route @name='Uitgaande facturen',@pathname='/invoice_wms',@class=@bclass,@key='Alt+U', @Search='?red=Open+en+Nieuw',@group = 'Factuuruit'\n\t\tEXEC sp_api_modal_route @name='Filter [Klaar voor Export]',@pathname='/invoice_wms',@class=@bclass,@key='', @Search='?red=Klaar+voor+Export',@group = 'Factuuruit'\n\t\tEXEC sp_api_modal_route @name='Voorbereiding weekfacturen',@pathname='/wms_week_data_for_invoice',@class=@bclass,@key='' ,@group = 'Factuuruit'--, @Search='?red=Klaar+voor+Export'\n\t\tEXEC sp_api_modal_route @name='Inslagen',@pathname='/w_applied_actions',@class=@bclass,@key='' ,@group = 'Factuuruit'--, @Search='?red=Klaar+voor+Export'\t\t\n\t\t\n\t\tEXEC sp_api_modal_route @name='Inkoopfacturen',@pathname='/incoming_invoice',@class=@bclass,@key='Alt+I',@group = 'Factuurin'\n\t\tEXEC sp_api_modal_route @name='Status Exact',@pathname='/incoming_invoice',@class=@bclass,@key='Alt+I',@Search='?red=Status+Exact',@group = 'Factuurin'\n\t\tEXEC sp_api_modal_route @name='Status Draft / Empty',@pathname='/incoming_invoice',@class=@bclass,@key='Alt+I',@Search='?red=Draft+%2F+Empty',@group = 'Factuurin'\n\tend\n\t------------\n\t-- ADRESSEN\n\t------------\n--\tEXEC sp_api_modal_text 'Adressen',@hclass\n\n\tIF @colorblind = 1\n\t\tBEGIN\n\t\t\tSET @bclass = 'btn-primary'\n\t\tEND\n\tELSE\n\t\tBEGIN\n\t\t\tSET @bclass = 'btn-success'\n\t\tEND\n\n\nIF dbo.hasRole('user,admin,directie') > 0\n\tbegin\n\t\t\t\n\t\tEXEC sp_api_modal_route @name='Alle bedrijven',@pathname='/adres',@search= '',@class=@bclass,@key='F1',@group = 'stamgegevens'\n\t\tEXEC sp_api_modal_route @name='Leveranciers',@pathname='/leverancier',@search= '',@class=@bclass,@key='F2',@group = 'stamgegevens'\n\t\tEXEC sp_api_modal_route @name='Klanten',@pathname='/klant',@search= '?ord=23124,27062',@class=@bclass,@key='F3',@group = 'stamgegevens'\n\t\tEXEC sp_api_modal_route @name='Transporteurs',@pathname='/transporteur',@search= '',@class=@bclass,@key='F4',@group = 'stamgegevens'\n\t\t\n\t\tEXEC sp_api_modal_route @name='Lokaties',@pathname='/xlocation',@search= '',@class=@bclass,@key='L',@group = 'Locaties'\n\t\tEXEC sp_api_modal_route @name='Pickup lokaties',@pathname='/wms_pickup_location',@search= '',@class=@bclass,@key='P',@group = 'Locaties'\n\n\tend\t\n\nIF dbo.hasRole('barsan_bo') > 0\n\tbegin\n\t\t--BARSAN_BO OOK DEZE LOKATIE OPTIE\n\t\tEXEC sp_api_modal_route @name='Lokaties',@pathname='/xlocation',@search= '',@class=@bclass,@key='L'\t\n\t\t\n\tend\t\n\nIF dbo.hasRole('barsan,barsan_bo,loodsmedewerker,directie') > 0 OR @user='alex_dong_nl@ensignfreight.com' --231110 alex specifiek OOK\n\tbegin\n\t\tEXEC sp_api_modal_route @cardname='barsan_micro_out'\n\tend\t\n\nIF dbo.hasRole('admin,directie') > 0\n\tbegin\n\t\t\t\n\t\tEXEC sp_api_modal_route @name='wms_artikelen',@pathname='/wms_item',@search= '',@class=@bclass,@key='Alt+A',@group = 'base'\n\t\tEXEC sp_api_modal_route @name='wms_groepen',@pathname='/xproduct',@search= '',@class=@bclass,@key='ALT+G',@group = 'base'\n\t\tEXEC sp_api_modal_route @name='wms_loodshuur_artikel',@pathname='/wms_price_per_week',@search= '',@class=@bclass,@key='ALT+W',@group = 'base'\t\n\t\tEXEC sp_api_modal_route @name='wms_tarief_inslag',@pathname='/w_action_tariff',@search= '',@class=@bclass,@key='ALT+i',@group = 'base'\t\n\t\tEXEC sp_api_modal_route @name='wms_notification_settings',@pathname='/wms_notification_settings',@search= '',@class=@bclass,@key='ALT+N',@group = 'base'\t\n\t\tEXEC sp_api_modal_route @name='wms_invoice_method',@pathname='/wms_invoice_method',@search= '',@class=@bclass,@key='ALT+M',@group = 'base'\t\n\t\tEXEC sp_api_modal_route @name='wms_verpakking_micro_items',@pathname='/fust',@search= '',@class=@bclass,@key='ALT+V',@group = 'base'\t\n\t\tEXEC sp_api_modal_route @name='pallets toevoegen',@pathname='/wms_purchase',@search= '',@class=@bclass,@key='ALT+P',@group = 'base'\t\n\t\t--https://rws.tsql.app/wms_notification_settings\t\n\tend\t\n\n\nEND\n------------\n-- GEBRUIKER\n------------\n--EXEC sp_api_modal_menu_user\t@user_id,@path\nDECLARE @key nvarchar(128) = IIF(@path='/','Escape','Home')\nSET @bclass = 'btn-tracy'\n\nEXEC sp_api_modal_route @name='Home',@pathname='/',@search= '',@class=@bclass,@key=@key\n\nEXEC sp_api_modal_button @name='logout',@value='Log Out',@valueout = @b_logout OUT,@class=@bclass,@key='End'\n\tIF @b_logout = 'Log Out'\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_dispatch N'{\"type\":\"logOut\"}'\n\t\t\tRETURN\n\t\tEND\n\n\n\n\n-----------\n-- ADMIN --\n-----------\n--if @user_name<>'rick@tracy.nu' \nEXEC sp_sys_admin_main_menu @hclass\n--https://rws.tsql.app/api_actions/32\n\ndeclare @T nvarchar(512)=N'&nbsp;'\nexec sp_api_modal_html @T\nexec sp_api_modal_html @T\nexec sp_api_modal_html @T\nset @T =concat(N'<a href=\"https://tracy.nu\" target=_blank>Solution &copy;',year(getdate()),' TDS B.V.</a><br/><a href=\"https://www.ux1.nl\" target=_blank>Technology &copy;',year(getdate()),' UX1 B.V.</a>'   \t)\nexec sp_api_modal_html @T, @class='m-1 w-24 btn btn-link2 btn-sm float-right' ",
            "action_id": 32,
            "action_name": "main_menu",
            "source_table": "api_actions"
        },
        {
            "sql_source": null,
            "action_id": 35,
            "action_name": "No Insert Allowed",
            "source_table": "api_actions"
        },
        {
            "sql_source": null,
            "action_id": 36,
            "action_name": "parent_id_in_toast",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast @previous_path ",
            "action_id": 37,
            "action_name": "path_info",
            "source_table": "api_actions"
        },
        {
            "sql_source": null,
            "action_id": 38,
            "action_name": "PER Bronlijst",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_pick_from_list @id, @ids ,@picklist_type, @parent_card_name, @picklist_fieldname, @previous_path, @card_id, @parent_id, @parent_card_id, @user_id",
            "action_id": 39,
            "action_name": "Pick from list",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @toCompany nvarchar(200),@fromCompany nvarchar(200)\nIF @toCompany IS NULL SET @toCompany = {[verkoop].counterparty_id.seek_column}\nIF @fromCompany IS NULL SET @fromCompany = {[inkoop].counterparty_id.seek_column}\nDECLARE @search nvarchar(2000)\nIF @toCompany IS NOT NULL SET @search = N'?filter=tocompany_id.swhas('+@toCompany+')'\nIF @fromCompany IS NOT NULL SET @search = N'?filter=fromcompany_id.swhas('+@fromCompany+')'\n\nEXEC sp_api_goto @path='/repaction',@search = @search",
            "action_id": 40,
            "action_name": "repaction",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_goto @path='/repdef'\n",
            "action_id": 41,
            "action_name": "repdef",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_goto @path='/repprinters'\n",
            "action_id": 42,
            "action_name": "repprinters",
            "source_table": "api_actions"
        },
        {
            "sql_source": "declare @T nvarchar(200)\nset @T=(select L from @main_db.dbo.[GetCompanySettings]('useDayprice'))\nexec sp_api_toast @T",
            "action_id": 43,
            "action_name": "sample_GetCompanySettings",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @search nvarchar(128),@button nvarchar(200)\nEXEC sp_api_modal_input @name='Search', @value= @search OUT,@focus=1\nEXEC sp_api_modal_button @name='Go',@value = 'Zoek', @valueout = @button OUT ,@class='btn-primary',@key='Enter'\nIF @button is not null\n\tBEGIN\n\t\tDECLARE @cursor CURSOR,@sql nvarchar(max),@title nvarchar(max)\n\t\tSET @cursor = CURSOR FOR\n\t\t\tSELECT sql,title=isnull((SELECT name FROM api_card WHERE id = (SELECT card_id FROM api_card_fields WHERE id = field_id)),'NULL')\n\t\t\t\t\t\t+'.'+isnull((SELECT name FROM api_card_fields WHERE id = field_id),'NULL')\n\t\t\t\t\t\t+'.'+(SELECT name FROM api_attributes WHERE id = attr_id)\n\t\t\t\t\tFROM api_card_field_attributes\n\t\t\t\t\tWHERE sql <> '' AND attr_id IN (SELECT id FROM api_attributes WHERE name LIKE '%'+@search+'%')\n\t\t\t\tUNION\n\t\t\tSELECT list_class,title=(SELECT name FROM api_card WHERE id = card_id)+'.'+name+'.list_class' FROM api_card_fields\n\t\t\t\t\tWHERE list_class <> '' AND list_class LIKE '%'+@search+'%'\n\t\t\t\tUNION\n\t\t\tSELECT picklist_sql,title=(SELECT name FROM api_card WHERE id = card_id)+'.'+name+'.picklist_sql' FROM api_card_fields\n\t\t\t\t\tWHERE picklist_sql <> '' AND picklist_sql LIKE '%'+@search+'%'\n\t\t\t\tUNION\n\t\t\tSELECT sql,title=(SELECT name FROM api_card WHERE id = card_id)+'.'+name+'.sql' FROM api_card_fields\n\t\t\t\t\tWHERE sql <> '' AND sql LIKE '%'+@search+'%'\n\t\t\t\tUNION\n\t\t\tSELECT on_update_sql,title=(SELECT name FROM api_card WHERE id = card_id)+'.'+name+'.on_update_sql' FROM api_card_fields WHERE on_update_sql <> '' AND on_update_sql LIKE '%'+@search+'%'\n\n\n\t\tOPEN @cursor;\n\t\tFETCH NEXT FROM @cursor INTO @sql ,@title\n\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text @title,'small opacity-50'\n\t\t\t\tEXEC sp_api_modal_text @sql,'big code mb-1'\n\t\t\t\tFETCH NEXT FROM @cursor INTO @sql ,@title\n\t\t\tEND\n\t\tCLOSE @cursor;\n\t\tDEALLOCATE @cursor;\n\tEND",
            "action_id": 44,
            "action_name": "Search Edit history",
            "source_table": "api_actions"
        },
        {
            "sql_source": "IF @id = @ids\n\tEXEC sp_api_modal_select_all\nELSE\n\tBEGIN\n\t\tEXEC sp_api_modal_text N'There is already a selection present.','py-1'\n\t\tDECLARE @valueout nvarchar(255)\n\t\tEXEC sp_api_modal_button @name='Option',@value = 'Add', @valueout = @valueout OUT,@class='btn-danger',@key='A'\n\t\tEXEC sp_api_modal_button @name='Option',@value = 'New', @valueout = @valueout OUT,@class='btn-danger',@key='N'\n\t\tEXEC sp_api_modal_button @name='Option',@value = 'Clear', @valueout = @valueout OUT,@class='btn-danger',@key='C'\n\t\tIF @valueout IS NOT NULL\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_clear\n\t\t\t\tIF @valueout = 'Clear' EXEC sp_api_modal_select_all_clear\n\t\t\t\tIF @valueout = 'Add' EXEC sp_api_modal_select_all\n\t\t\t\tIF @valueout = 'New'\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tEXEC sp_api_modal_select_all_clear\n\t\t\t\t\t\tEXEC sp_api_modal_select_all\n\t\t\t\t\tEND\n\t\t\tEND\n\tEND",
            "action_id": 45,
            "action_name": "Select All",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @Status nvarchar(100)\n--basis = via p_api_modal_get:\n--EXEC sp_api_modal_get N'workdate',@status OUT \n\n--alternatief = via helper function dbo.Workdate(@user_id):\nSELECT @Status=dbo.Workdate()\n\n-- in direct SQL: SET @Status=(SELECT top 1 TV_CompanyName FROM q_xtransactionheader WHERE transactiondate=dbo.Workdate(@User_ID))\n\nSET @Status =CONCAT(N'Werkdatum is: ',@STATUS)\nEXEC sp_api_modal_text @status",
            "action_id": 46,
            "action_name": "ShowWorkdate",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_card_help @card_id,@card_name,@card_field_id",
            "action_id": 48,
            "action_name": "sys_card_help",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @json nvarchar(max),@sql nvarchar(max),@columnname nvarchar(128)\n\t,@button nvarchar(128)\n\t,@object_id nvarchar(128)\n\t,@code_table nvarchar(128)\n\t,@code_column nvarchar(128)\n\t,@caption_column nvarchar(128)\n\t,@option nvarchar(max)\n\nSELECT @sql = sql,@columnname=name FROM api_card_fields WHERE id = @card_field_id AND (sql is null OR sql = '')\nIF @columnname is null\n\tBEGIN\n\t\tEXEC sp_api_toast N'Field does not exist or already has sql output (clear first!)'\n\t\tRETURN\n\tEND\n\nEXEC sp_api_modal_text N'Choose a code TABLE'\nSELECT * INTO #sys_tables FROM (SELECT id=name, name FROM sys_tables UNION SELECT id=name, name FROM @main_db.sys.views) tbl\n\nEXEC sp_api_modal_select_table @tmptable=N'#sys_tables',@value = @code_table OUT\nSELECT @object_id = object_id FROM sys_tables WHERE name = @code_table\nIF @object_id IS NULL SELECT @object_id = object_id FROM @main_db.sys.views WHERE name = @code_table\nIF @object_id Is NOT NULL\n\tBEGIN\n\t\tEXEC sp_api_modal_text N'Choose a CODE column'\n\t\tSELECT id=name, name INTO #sys_columns_code FROM sys_columns WHERE object_id = @object_id\n\t\tEXEC sp_api_modal_select_table @tmptable=N'#sys_columns_code',@value = @code_column OUT\n\t\tIF EXISTS (SELECT * FROM sys_columns WHERE object_id = @object_id AND name = @code_column)\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text N'Choose a CAPTION column'\n\t\t\t\tSELECT id=name, name INTO #sys_columns_caption FROM sys_columns WHERE object_id = @object_id\n\t\t\t\tEXEC sp_api_modal_select_table @tmptable=N'#sys_columns_caption',@value = @caption_column OUT\n\t\t\t\tIF EXISTS (SELECT * FROM sys_columns WHERE object_id = @object_id AND name = @caption_column)\n\t\t\t\t\tBEGIN\n--\t\t\t\t\t\tEXEC sp_api_modal_text @sql\n\t\t\t\t\t\tEXEC sp_api_modal_button @name='Sure',@value = 'Create a select', @valueout = @button OUT\t,@class='btn-primary',@key='Enter'\n\t\t\t\t\t\tIF @button IS NOT NULL\n\t\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\t\tEXEC sp_api_populate_card_views @tablename = @code_table\n\t\t\t\t\t\t\t\tSET @sql = N'SELECT '+QUOTENAME(@code_column)+','+QUOTENAME(@caption_column)\n\t\t\t\t\t\t\t\t\t+' FROM '+QUOTENAME(@code_table)+' ORDER BY 2 FOR JSON PATH, INCLUDE_NULL_VALUES'\n\t\t\t\t\t\t\t\tDECLARE @attr_id_extra INT = (SELECT id FROM api_attributes WHERE name = 'extra')\n\t\t\t\t\t\t\t\tDECLARE @attr_id_element INT = (SELECT id FROM api_attributes WHERE name = 'element')\n\t\t\t\t\t\t\t\tDELETE FROM api_card_field_attributes WHERE field_id = @card_field_id AND attr_id IN (@attr_id_extra,@attr_id_element)\n\t\t\t\t\t\t\t\tINSERT INTO api_card_field_attributes (attr_id,sql,field_id) VALUES\n\t\t\t\t\t\t\t\t\t(@attr_id_element,'''Select''',@card_field_id),(@attr_id_extra,@sql,@card_field_id)\n\t\t\t\t\t\t\t\tEXEC sp_api_modal_clear\n\t\t\t\t\t\t\tEND\n\t\t\t\t\tEND\n\t\t\tEND\n\tEND\n\n/*\nRETURN\n\n\nSELECT @sql = sql,@columnname=name FROM api_card_fields WHERE id = @card_field_id AND (sql is null OR sql = '')\nIF @columnname is null\n\tBEGIN\n\t\tEXEC sp_api_toast N'Field does not exist or has sql output'\n\t\tRETURN\n\tEND\nEXEC sp_api_modal_input @name='Add option',@max=5, @value= @option OUT,@focus=1\n\nSET @sql = N'SET @json = (SELECT id = ' + QUOTENAME(@columnname) + ',name = ' + QUOTENAME(@columnname) + ' FROM\n\t\t(SELECT DISTINCT ' + QUOTENAME(@columnname) + ' FROM '+ QUOTENAME(@tablename) + ' UNION SELECT ' + QUOTENAME(@columnname) + ' = @option) tbl WHERE ' + QUOTENAME(@columnname) + ' IS NOT NULL AND ' + QUOTENAME(@columnname) + ' <> '''' GROUP BY ' + QUOTENAME(@columnname) + ' ORDER BY 1 FOR JSON AUTO)'\nEXEC sp_executesql @sql, N'@json  nvarchar(max) OUT,@option nvarchar(max)', @json = @json OUT,@option = @option\nEXEC sp_api_modal_text @json,N'code'\nEXEC sp_api_modal_button @name='Sure',@value = 'Create a select', @valueout = @valueout OUT\t,@class='btn-primary',@key='Enter'\nIF @valueout IS NOT NULL\n\tBEGIN\n\t\tDECLARE @attr_id_extra INT = (SELECT id FROM api_attributes WHERE name = 'extra')\n\t\tDECLARE @attr_id_element INT = (SELECT id FROM api_attributes WHERE name = 'element')\n\t\tDELETE FROM api_card_field_attributes WHERE field_id = @card_field_id AND attr_id IN (@attr_id_extra,@attr_id_element)\n\t\tINSERT INTO api_card_field_attributes (attr_id,sql,field_id) VALUES\n\t\t\t(@attr_id_element,'''Select''',@card_field_id),(@attr_id_extra,dbo.escape_string(@json),@card_field_id)\n\t\tEXEC sp_api_modal_clear\n\tEND\n*/\n\n\n",
            "action_id": 51,
            "action_name": "sys_convert_field_to_code_table",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_convert_field_to_select @card_field_id,@tablename",
            "action_id": 52,
            "action_name": "sys_convert_field_to_select",
            "source_table": "api_actions"
        },
        {
            "sql_source": "/*EXEC sp_api_modal_select @card_name=N'apicard',@name=N'@selected_card_id',@value=@selected_card_id OUT--,@focus=1\nIF @selected_card_id IS NULL RETURN\nEXEC sp_api_modal_clear\nDECLARE @selected_card_name nvarchar(128),@selected_table_name nvarchar(128)\nSELECT @selected_card_name = '['+name+'].',@selected_table_name = ISNULL(basetable,tablename)  FROM api_card WHERE id = @selected_card_id\n*/\nDECLARE @search nvarchar(2000),@button nvarchar(128)\nEXEC sp_api_modal_select_curly @value = @search OUT,@focus=1\n\n/*RETURN\nDECLARE @parsed nvarchar(max) = '{'+REPLACE(@search,@selected_card_name,'')+'}'\nEXEC sp_api_card_curly_replace @card_id = @selected_card_id,@string = @parsed OUT\nSET @parsed = REPLACE(@parsed,'this.',QUOTENAME(@selected_table_name)+'.')\nEXEC sp_api_modal_text @parsed,N'my-3 code'\nRETURN\nSELECT word = CAST('{'+name+'}' as nvarchar(max)) INTO #curly FROM (\n\tselect name FROM api_card_fields WHERE card_id = @selected_card_id\n\tUNION\n\tselect '['+lower(name)+']' FROM api_card WHERE name is not null AND tablename NOT LIKE 'api_%'\n\tUNION\n\tselect '['+lower(ac.name)+'].'+acf1.name FROM api_card ac JOIN api_card_fields acf1 ON ac.id = acf1.card_id WHERE @sql LIKE '%{[[]' + ac.name+']%'\n\tUNION\n\tselect acf1.name+'.'+acf2.name FROM api_card_fields acf1 JOIN api_card_fields acf2 ON acf1.card_id = @card_id AND acf2.card_id = acf1.picklist_card_id\n\t\tWHERE @sql LIKE '%{' + acf1.name+'%'\n\tUNION\n\tselect acf1.name+'.'+acf2.name+'.'+acf3.name FROM api_card_fields acf1 JOIN api_card_fields acf2 ON acf1.card_id = @card_id AND acf2.card_id = acf1.picklist_card_id\n\t\t\tJOIN api_card_fields acf3 ON acf2.card_id = acf1.picklist_card_id AND acf3.card_id = acf2.picklist_card_id\n\t\t\t\tWHERE @sql LIKE '%{' + acf1.name+'.'+acf2.name+'%'\n\t) tbl\n\nEXEC sp_api_modal_table @tmptable=N'#curly'\n*/",
            "action_id": 53,
            "action_name": "sys_curly_brackets",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @search nvarchar(2000) = N'',@button nvarchar(128)\nEXEC sp_api_modal_select_curly @value = @search OUT\nEXEC sp_api_modal_text N'',@class=N'm-3'\nEXEC sp_api_modal_button @name='button',@value=N'Insert',@valueout=@button OUT,@key='Insert'\nIF @button IS NOT NULL\n\tBEGIN\n\t\tEXEC sp_api_modal_clear\n\t\tSET @search=N'{'+@search+'}'\n\t\tEXEC sp_api_modal_field_insert @card_field_id,@search\n\tEND",
            "action_id": 54,
            "action_name": "sys_curly_search_and_insert",
            "source_table": "api_actions"
        },
        {
            "sql_source": "/*\nIndien je anders wilt deleten (EXEC DeleteCTR bijvoorbeeld) dan moet je VLAK ERVOOR(!) per id dit aanroepen:\n\n\tEXEC sp_api_history_delete @id,@tablename,@basetable,@identity_column\n\nDan wordt het verwijderde record in api_history opgeslagen!\n\n*/\nEXEC sp_sys_delete @ids,@id,@tablename,@basetable,@identity_column",
            "action_id": 55,
            "action_name": "sys_delete",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast N'Deprecated'\nRETURN\nDELETE FROM api_card_cache\nEXEC sp_api_toast N'Card Cache Deleted'\nUPDATE api_card SET select_cache = NULL",
            "action_id": 56,
            "action_name": "sys_drop_all_cache",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_edit_fields @id,@is_form,@path,@card_field_id,@card_id",
            "action_id": 57,
            "action_name": "sys_edit",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @subject nvarchar(255) = N'Tracy '+@card_name + ' mail'\nDECLARE @body nvarchar(max),@html nvarchar(max),@list_select nvarchar(max),@list_select_cache nvarchar(max)\nSELECT @list_select_cache = list_select_cache FROM api_card WHERE id = @card_id\nSET @list_select=N'\n\tSELECT * INTO #tmptable FROM ('+@list_select_cache+') tbl\n\tEXEC sp_api_html_table N''#tmptable'',N''ORDER BY 2'',@html OUT'\nEXEC sp_executesql @list_select,N'@html nvarchar(max) OUT',@html OUT\n/*\nEXEC sp_api_toast @html\n\nRETURN\nEXEC sp_api_html_table N'api_card',N'ORDER BY name',@html OUT\n*/\n--EXEC sp_api_email @user,@subject,N'<h3>See attached</h3>',@query = @list_select_cache\n\nSET @body = N'<h3>Export</h3>'+@html\nEXEC sp_api_email @user,@subject,@body\nEXEC sp_api_toast N'Sent mail to:'\nEXEC sp_api_toast @user",
            "action_id": 58,
            "action_name": "sys_email_to_me",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_escape @is_form,@path,@previous_path,@parent_id,@card_id,@card_name,@id,@user_id\r\n\t,@ids,@picklist_type,@parent_card_name,@picklist_fieldname,@parent_card_id",
            "action_id": 59,
            "action_name": "sys_escape",
            "source_table": "api_actions"
        },
        {
            "sql_source": null,
            "action_id": 60,
            "action_name": "sys_goto_card_field_settings",
            "source_table": "api_actions"
        },
        {
            "sql_source": null,
            "action_id": 61,
            "action_name": "sys_goto_card_settings",
            "source_table": "api_actions"
        },
        {
            "sql_source": null,
            "action_id": 62,
            "action_name": "sys_hide_all_sk_id",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_alert N'Velden verbergen?',N'Alleen velden van lijstweergave tonen'\nEXEC sp_api_modal_alert N'Zeker weten?',N'De hele bestaande volgorde wordt zoals de lijstweergave!'\nEXEC sp_api_modal_alert N'Laatste waarschuwing!',N'Dit kan niet ongedaan worden!'\nUPDATE acf SET detail_order = list_order FROM api_card_fields acf WHERE card_id = @card_id\n--DELETE FROM api_card_cache WHERE cid = @card_id\nEXEC sp_api_populate_card @card_id\n--EXEC sp_api_card_re_order @card_id\nEXEC sp_api_modal_clear\n",
            "action_id": 63,
            "action_name": "sys_hide_fields_not_in_list",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @rowcount_api_storage INT = 0\nSELECT @rowcount_api_storage = COUNT(child_id) FROM api_storage (NOLOCK) WHERE card_id = @card_id AND child_id = 0 AND user_id = @user_id\nIF @rowcount_api_storage > 0\n\tBEGIN\n\t\tDECLARE @valueout nvarchar(100)\n\t\tEXEC sp_api_modal_text N'Continue with unfinished insert values?',N'h4',1\n\t\tEXEC sp_api_modal_button @name='save',@value = 'Continue', @valueout = @valueout OUT ,@class='btn-success',@key='Enter'\n\t\tEXEC sp_api_modal_button @name='save',@value = 'Reset', @valueout = @valueout OUT ,@class='btn-danger',@key='Delete'\n\t\tIF @valueout IS NULL RETURN\n\t\tEXEC sp_api_modal_clear\n\t\tIF @valueout = 'Reset'\n\t\t\tBEGIN\n\t\t\t\tDELETE FROM api_storage WHERE card_id = @card_id AND child_id = 0 AND user_id = @user_id\n\t\t\t\tEXEC sp_api_toast N'Previous values removed'\n\t\t\tEND\n\tEND\nSET @path+='/0'\nEXEC sp_api_goto @path\n",
            "action_id": 64,
            "action_name": "sys_insert",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @time time = CAST(SYSDATETIME() as time)\n\n\nDECLARE @cursor_ids CURSOR,@fid INT,@fname nvarchar(128),@class nvarchar(128)\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT id,name FROM api_card_fields WHERE card_id = @card_id ORDER BY detail_order\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @fid,@fname\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\n\t\tDECLARE @is_field_updateable BIT\n\t\tEXEC @is_field_updateable = sp_api_card_field_is_updateable @fid,@id\n\t\tIF @is_field_updateable = 1\n\t\t\tSET @class= 'text-success'\n\t\tELSE\n\t\t\tSET @class= 'text-danger'\n\t\tEXEC sp_api_modal_text @fname,@class\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @fid,@fname\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;\n\nDECLARE @ms INT = DATEDIFF(millisecond,@time,CAST(SYSDATETIME() as time))\nEXEC sp_api_toast @ms\n",
            "action_id": 65,
            "action_name": "sys_is_field_updateable",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @sql nvarchar(max)\n\t,@parent_ref nvarchar(128)\n\t,@parent_ref_id nvarchar(max)\n\t,@child_card_id INT\n\t,@child_basetable nvarchar(128)\n\t,@child_tablename nvarchar(128)\n\t,@field_name nvarchar(128)\n\t,@identity_column_child nvarchar(128) = 'id'\n\t,@valueout nvarchar(128)\n\nSELECT @field_name = name,@child_card_id = picklist_card_id,@identity_column_child = picklist_type,@sql=picklist_sql FROM api_card_fields WHERE id = @card_field_id AND picklist_type = 3 --=> 3 is multi pick\n--EXEC sp_api_toast @field_name\nSELECT @child_basetable = basetable,@child_tablename=tablename FROM api_card WHERE id = @child_card_id\nIF @child_tablename IS NULL\n\tBEGIN\n\t\tEXEC sp_api_modal_alert N'\"Multi Select Unique\" can only work with fields using picklist type \"Listview picklist multi\"'\n\t\tRETURN\n\tEND\n\n--EXEC sp_api_toast @field_name\n--EXEC sp_api_toast @tablename\nSET @parent_ref_id = N'(SELECT id FROM #parents WHERE card_name = ' + ISNULL(dbo.escape_string(@parent_card_name),'NULL')+')'\n--EXEC sp_api_toast @parent_ref_id\n\nSELECT @identity_column_child = name FROM sys_columns WHERE object_id = (SELECT object_id FROM sys_objects WHERE name = ISNULL(@child_basetable,@child_tablename)) AND is_identity = 1\n--EXEC sp_api_toast @identity_column_child\n\nSELECT @parent_ref = ref FROM api_card_children WHERE child = @card_id AND parent = @parent_card_id\nIF @parent_ref IS NULL\n\tBEGIN\n\t\tEXEC sp_api_modal_alert N'\"Multi Select Unique\" requires a parent reference'\n\t\tRETURN\n\tEND\n--EXEC sp_api_toast @parent_ref\nDECLARE @newsql nvarchar(max) = N''+@identity_column_child+' NOT IN (SELECT '+QUOTENAME(@field_name)+' FROM '+QUOTENAME(@tablename)+' WHERE '+QUOTENAME(@parent_ref)+' = '+@parent_ref_id+') OR '+@identity_column_child+' = @' +dbo.QUOTE_DECLARE(@field_name)\n\nIF LEN(@sql) > 0\n\tBEGIN\n\t\tEXEC sp_api_modal_text N'Overwrite Picklist reducer?',N'h4'\n\t\tEXEC sp_api_modal_text @sql,N'code my-3'\n\t\tEXEC sp_api_modal_text N'With:',N'h4'\n\t\tEXEC sp_api_modal_text @newsql,N'code my-3'\n\t\tEXEC sp_api_modal_button @name='Sure',@value = 'Ok', @valueout = @valueout OUT ,@class='btn-danger',@key='Enter'\n\t\tIF @valueout IS NULL RETURN\n\t\tEXEC sp_api_modal_clear\n\tEND\n\n--SET @json = (SELECT * FROM api_card_children WHERE child = @card_id AND parent = @parent_card_id FOR JSON AUTO, INCLUDE_NULL_VALUES)\nUPDATE api_card_fields SET picklist_sql = @newsql ,unparsed_picklist_reducer=@newsql WHERE id = @card_field_id\nEXEC sp_api_toast N'Done!'\n\n\n",
            "action_id": 66,
            "action_name": "sys_make_multi_select_unique",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_model_diff @card_id,@id",
            "action_id": 67,
            "action_name": "sys_model_diff",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @populate_card_id INT = @card_id\nIF @card_name = 'apicard' SET @populate_card_id = @id\nIF @card_name = 'card_fields' SET @populate_card_id = @parent_id\n\nEXEC sp_api_populate_card @populate_card_id\n--RETURN\nDECLARE @pop_id int,@table nvarchar\n\tDECLARE @cursor_api_card CURSOR\n\tSET @cursor_api_card = CURSOR LOCAL FAST_FORWARD FOR SELECT id FROM api_card\n\t\tWHERE id <> @populate_card_id AND (tablename = (SELECT ISNULL(tablename,'qwerq4232we2342rwe') FROM api_card WHERE id = @populate_card_id)\n\t\t\tOR basetable = (SELECT ISNULL(basetable,'qwerqw2346e23rwe') FROM api_card WHERE id = @populate_card_id))\n\tOPEN @cursor_api_card;\n\tFETCH NEXT FROM @cursor_api_card INTO @pop_id\n\tWHILE @@FETCH_STATUS = 0\n\t\tBEGIN\n\t\t\tDECLARE @sql nvarchar(max) = CONCAT(N'EXEC sp_api_populate_card ',@pop_id)\n\t\t\tEXEC sp_api_add_sql_task @sql\n\t\t\t--EXEC sp_api_populate_card @pop_id\n\t\t\tFETCH NEXT FROM @cursor_api_card INTO @pop_id\n\t\tEND\n\tCLOSE @cursor_api_card;\n\tDEALLOCATE @cursor_api_card;\n",
            "action_id": 68,
            "action_name": "sys_populate_card",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_menu_quick @path",
            "action_id": 69,
            "action_name": "sys_quick_menu",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_refresh_all_views\r\n",
            "action_id": 70,
            "action_name": "sys_refresh_all_views",
            "source_table": "api_actions"
        },
        {
            "sql_source": "/*\nGebruik elders dit:\n\tEXEC sp_api_modal_set N'statusbar_1',N'Gooi dit in de statusbar!'\n\tof\n\tEXEC sp_api_modal_set N'statusbar_all_green',N'Dit overschrijft alles in de statusbar!'\n*/\n--EXEC sp_api_modal_set N'last_access_date',N'2020-01-01'\n\n\nDECLARE @status nvarchar(256)\nEXEC sp_api_modal_get N'last_access_date',@status OUT \nIF @status IS NULL OR @status <> dbo.strdate(NULL)\n\tBEGIN\n\t\tEXEC sp_api_toast N'Welkom deze nieuwe dag!!!'\n\t\tEXEC sp_api_modal_set N'workdate',NULL\n\t\tSET @status = dbo.strdate(NULL)\n\t\tEXEC sp_api_modal_set N'last_access_date',@status\n\t\tEXEC sp_api_modal_set N'statusbar_all_green',NULL -- wissen!\n\t\t--SP_DAILY HIER\n\t\tEXEC sp_api_health_status\n\tEND\nEXEC sp_api_health_status\n\nEXEC sp_api_modal_get N'workdate',@status OUT \nIF @status IS NULL\n\tBEGIN\n\t\tSET @status = dbo.abcdate()\n\t\tEXEC sp_api_modal_set N'workdate',@status \n\tEND\n\n\n/* --=> statusbar_all overschrijft alle status */\nEXEC sp_api_modal_get N'statusbar_all_red',@status OUT \nIF @status IS NOT NULL\n\tBEGIN\n\t\tEXEC sp_api_statusbar @status ,'bg-danger col-sm-3 text-truncate',0 --> 0 is links\n\t\tRETURN\n\tEND\n\nEXEC sp_api_modal_get N'statusbar_all_blue',@status OUT \nIF @status IS NOT NULL --OR  1=1\n\tBEGIN\n\t\tEXEC sp_api_statusbar @status ,'bg-primary col-sm text-truncate',1 --> 0 is links\n\t\tRETURN\n\tEND\n\nEXEC sp_api_modal_get N'statusbar_all_green',@status OUT \nIF @status IS NOT NULL\n\tBEGIN\n\t\tEXEC sp_api_statusbar @status ,'bg-success col-sm-3 text-truncate',1 --> 0 is links\n\t\tRETURN\n\tEND\n\nEXEC sp_api_modal_get N'statusbar_all_yellow',@status OUT \nIF @status IS NOT NULL\n\tBEGIN\n\t\tEXEC sp_api_statusbar @status ,'bg-warning col-sm-3 text-truncate',1 --> 0 is links\n\t\tRETURN\n\tEND\n\n\n\n\n\nEXEC sp_api_modal_get N'workdate',@status OUT\nDECLARE @class nvarchar(255) = N'bg-danger col-sm-1 text-truncate' -- zet kleur danger...\nIF dbo.abcdate() = @status SET @class = N'col-sm-1 text-truncate' -- als workdate gelijk is aan echte datum, dan geen kleur\n\nSET @status = dbo.strdate(@status)\nIF @status IS NOT NULL EXEC sp_api_statusbar @status ,@class,0 --> 0 is links\n-----------------------------------\n/* hier verder als statusbar_all NULL is */\nIF OBJECT_ID('xtenant') IS NOT NULL\n\tBEGIN\n\t\tif (select isnull(xtenant.forceToTestmodus,0) from xtenant where id=7)=1\n\t\t\tbegin\n\t\t\t\tEXEC sp_api_statusbar N'*TESTMODUS*' ,'bg-warning col-sm-1 text-truncate',0 --> 0 is links --'bg-danger col-sm-1 text-truncate'\n\t\t\tend\n\t\telse\n\t\t\tbegin\t\n\n\t\t\t\tEXEC sp_api_modal_get N'statusbar_1',@status OUT\n\t\t\t\tIF @status IS NOT NULL EXEC sp_api_statusbar @status ,'col-sm-1 text-truncate',0 --> 0 is links --'bg-danger col-sm-1 text-truncate'\n\t\t\tend\n\tEND\nDECLARE @is_admin bit = dbo.hasRole('admin')\nIF object_id('@main_db.dbo.debug_trigger_xCompany') IS NOT NULL AND @is_admin = 1\n\tbegin\n\t\tEXEC sp_api_statusbar N'DEBUG ON' ,'bg-primary col-sm-1 text-truncate',0 --> 0 is links --'bg-danger col-sm-1 text-truncate'\n\tend\n\nDECLARE @forcedRole nvarchar(4000)\nEXEC sp_api_modal_get N'forcedRole',@forcedRole OUT \nIF @forcedRole IS NOT NULL EXEC sp_api_statusbar @forcedRole ,'bg-primary col-sm-1 text-truncate',0 --> 0 is links\n/*\n\t\tEXEC sp_api_modal_get N'statusbar_1',@status OUT\n\t\tIF @status IS NOT NULL EXEC sp_api_statusbar @status ,'col-sm-1 text-truncate',0 --> 0 is links --'bg-danger col-sm-1 text-truncate'\n*/\t\t\n----------------------------------------------\n \n\nEXEC sp_api_modal_get N'statusbar_2',@status OUT\nIF @status IS NOT NULL EXEC sp_api_statusbar @status ,'col-sm-1-2 text-truncate',1 --> 1 is rechts -- 'bg-warning col-sm-1-2 text-truncate'\nEXEC sp_api_modal_get N'statusbar_4',@status OUT\nEXEC sp_api_statusbar @status ,'col-sm-1-3 text-truncate',1 --> 1 is rechts -- vijv success kleur: 'bg-success col-sm-1-3 text-truncate'\n\nEXEC sp_api_statusbar @user_name,'col-sm-1 text-truncate',0 --> 0 is links -- bijv rood: 'bg-warning col-sm-1 text-truncate'\n\n\nEXEC sp_api_statusbar @card_name,'col-sm-1 text-truncate text-right',1 --> 1 is rechts\n\n/*\nDECLARE @filter_reducer_name nvarchar(128) = TRY_CAST(SESSION_CONTEXT(N'query_red') as nvarchar(128))\nIF @filter_reducer_name > ''\n\tBEGIN\n\t\tSET @filter_reducer_name = N'Filter: '+(SELECT * FROM get_lang(@filter_reducer_name,'menu'))\n\t\tEXEC sp_api_statusbar @filter_reducer_name,'col-sm-2 text-truncate bg-primary',1 --> 1 is rechts\n\tEND\n\nEXEC sp_api_statusbar '','col-sm-1-2 text-center' -- 'bg-danger col-sm-1-2 text-center'\nEXEC sp_api_statusbar '','col-sm-1-2 text-center',1 --> 1 is rechts -- 'bg-primary col-sm-1-2 text-center'\nEXEC sp_api_statusbar '','col-sm-1-2 text-center',1 --> 1 is rechts --'bg-danger col-sm-1-2 text-center'\n*/\n/* the end */",
            "action_id": 71,
            "action_name": "sys_run_always",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @json nvarchar(max),@sql nvarchar(max),@columnname nvarchar(128),@columnsql nvarchar(max),@valueout nvarchar(128),@option nvarchar(max),@outval nvarchar(max), @attr_id_fill_with INT,@daSQL nvarchar(max)\n\nSELECT @sql = sql,@columnname=name,@columnsql=IIF(sql is null OR sql = '',QUOTENAME(name),'('+sql+CHAR(13)+')') FROM api_card_fields WHERE id = @card_field_id --AND (sql is null OR sql = '')\nIF @columnname is null\n\tBEGIN\n\t\tEXEC sp_api_toast N'Field does not exist or has sql output'\n\t\tRETURN\n\tEND\nDECLARE @tmpsql nvarchar(max) = N'SELECT @outval = ' + @columnsql +' FROM '+QUOTENAME(@basetable)+' this WHERE ' + QUOTENAME(@identity_column) + ' = ' + @id\nEXEC sp_executesql @tmpsql,N'@outval nvarchar(max) OUT', @outval OUT\n\t\tEXEC sp_api_toast @outval\n\n\nIF @parent_card_name is null\n\tBEGIN\n\t\t--EXEC sp_api_modal_alert 'No parent card, no defaults!'\n\t\t--EXEC sp_api_modal_clear\n\t\t--RETURN;\n\t\tEXEC sp_api_toast N'Setting op basiskaart'\n\tEND\n\n--\tIF EXISTS (SELECT * FROM xDefaults WHERE ContextCardName = isnull(@parent_card_name,N'') AND Cardname = @card_name AND FieldName = @columnname)\n--\t\tUPDATE xDefaults \n--\t\t\tSET BaseTableName = @basetable \n--\t\t\t\t,DefaultValue = @outval\n--\t\t\t\tWHERE ContextCardName = isnull(@parent_card_name,N'') AND Cardname = @card_name AND FieldName = @columnname\n--\tELSE\n--\t\tINSERT xDefaults (BaseTableName,ContextCardName,Cardname,FieldName,DefaultValue) VALUES (@basetable,isnull(@parent_card_name,N''),@card_name,@columnname,@outval)\n--\n--\tEND\n\tEXECUTE @main_db.dbo.IINE_xDefaults @basetable,@parent_card_name,@card_name,@columnname,@outval --Wat als @parent_card_name IS NULL ?no problem, mag gewoon, dan zit je OPEN een hoofdk-levoe, l ok maar het werkte niet alles werkte gwoon goed.. (dacht ik)\n\n\n--user change value:\n--SET @option='wawa'--@card_field_value\n--EXEC sp_api_modal_input @name='SET default Value',@max=5, @value= @option OUT,@focus=1\n\n--show result info\nEXEC sp_api_modal_text @outval,N'code'\n\nEXEC sp_api_modal_button @name='Sure',@value = 'This value as Default', @valueout = @valueout OUT\t,@class='btn-primary',@key='Enter'\nIF @valueout IS NOT NULL\n\tBEGIN\n\tSET @attr_id_fill_with = (SELECT id FROM api_attributes WHERE name = 'fill_with')\n\tSELECT @daSQL=N'(select top 1 DefaultValue from xdefaults where Cardname = @card_name and contextCardName= @parent_card_name and fieldname=@card_field_name)'\n\tEXEC sp_api_toast @daSQL\n\n\t--write to card field settings\n\tDELETE FROM api_card_field_attributes WHERE field_id = @card_field_id AND attr_id =@attr_id_fill_with\n\t--INSERT INTO api_card_field_attributes (attr_id,sql,field_id) VALUES (@attr_id_fill_with,dbo.escape_string(@daSQL),@card_field_id)\n\tINSERT INTO api_card_field_attributes (attr_id,sql,field_id) VALUES (@attr_id_fill_with,@daSQL,@card_field_id)\n\n\t\tEXEC sp_api_modal_clear\n\tEND\n",
            "action_id": 72,
            "action_name": "sys_set_default_for_field",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @workdate nvarchar(128),@button nvarchar(128)\n--EXEC sp_api_modal_get N'workdate',@workdate OUT --GB210106\nEXEC sp_api_modal_date @name=N'Workdate',@value=@workdate OUT,@focus=1,@select=1\nEXEC sp_api_modal_button @name=N'button',@value=N'Set workdate',@valueout= @button OUT,@key='Enter'\nEXEC sp_api_modal_button @name=N'button',@value=N'Morgen',@valueout= @button OUT,@key='M'\nEXEC sp_api_modal_button @name=N'button',@value=N'Gisteren',@valueout= @button OUT,@key='G'\nIF @button IS NOT NULL\n\tBEGIN\n\t\tIF @button = 'Morgen' SET @workdate = dbo.strdate(DATEADD(DAY,1,GETDATE()))\n\t\tIF @button = 'Gisteren' SET @workdate = dbo.strdate(DATEADD(DAY,-1,GETDATE()))\n\t\tEXEC sp_api_modal_set N'workdate',@workdate\n\t\tEXEC sp_api_modal_clear\n\tEND\n\n",
            "action_id": 73,
            "action_name": "sys_set_workdate",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @search nvarchar(2000) = N'?filter=card_id.swhas('+@card_name+')'\nEXEC sp_api_goto N'/api_storage',@search",
            "action_id": 74,
            "action_name": "sys_storage",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_table_size @basetable",
            "action_id": 75,
            "action_name": "sys_table_size",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_translate @id,@card_field_id",
            "action_id": 76,
            "action_name": "sys_translate",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_workflow @card_name,@ids,@tablename,@basetable,@identity_column",
            "action_id": 77,
            "action_name": "sys_workflow",
            "source_table": "api_actions"
        },
        {
            "sql_source": null,
            "action_id": 78,
            "action_name": "TenantSettings",
            "source_table": "api_actions"
        },
        {
            "sql_source": null,
            "action_id": 79,
            "action_name": "test",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--EXEC sp_api_modal_set N'statusbar_all_green',NULL\nDECLARE @S1 nvarchar(50)\nEXEC sp_api_modal_get N'statusbar_all_green', @S1 OUT\nIF @S1 is null EXEC sp_api_modal_set N'statusbar_all_green',N'klik ''test statusbar'' nog een keer!'\nELSE EXEC sp_api_modal_set N'statusbar_all_green',NULL\n\n--EXEC sp_api_modal_set N'statusbar_all_red',NULL\n--EXEC sp_api_modal_set N'statusbar_all_red',N'Dit overschrijft alles in de statusbar!'",
            "action_id": 80,
            "action_name": "Test de statusbar",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @text2 nvarchar(max) = {[inkoop].Counterparty_ID.CompanyName} \nEXEC sp_api_toast @text2 \n\nDECLARE @text nvarchar(255) = N'@card_id INT = '+@card_id+'\n\t\t\t\t,@id INT = '+@id +'\n\t\t\t\t,@ids nvarchar(max) = '+@ids +'\n\t\t\t\t,@tablename NVARCHAR(128) = '+dbo.nv(@tablename) +'\n\t\t\t\t,@identity_column NVARCHAR(1024) = '+dbo.nv(@identity_column )+'\n\t\t\t\t,@parent_id INT = '+@parent_id +'\n\t\t\t\t,@path nvarchar(4000) = '+dbo.nv(@path )+'\n\t\t\t\t,@is_new INT = '+dbo.nv(@is_new )+'\n\t\t\t\t'\nEXEC sp_api_modal_text @text\nEXEC sp_api_modal_text @text=N'Gewoon een test modal',@class=N'h3'\nEXEC sp_api_modal_text 'Gewoon een sub-test modal','h4'\nEXEC sp_api_modal_text 'Weet jij van tralala?','p-4'\nDECLARE @value nvarchar(10) = 'rick'\nEXEC sp_api_modal_input @name='Titel van het rapport',@max=10, @value = @value OUT\nIF @value is NULL RETURN\nEXEC sp_api_modal_text @value\nEXEC sp_api_modal_text 'Even overleggen!!!','h1'\n",
            "action_id": 81,
            "action_name": "test_met_modal",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @ST nvarchar(100)\nEXEC sp_api_modal_get N'statusbar_all_red',@st OUT \nIF @st IS NOT NULL EXEC sp_api_modal_set N'statusbar_all_red', NULL\nELSE EXEC sp_api_modal_set N'statusbar_all_red', N'Klik weer op test RED'",
            "action_id": 82,
            "action_name": "testred",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @ST nvarchar(100)\nEXEC sp_api_modal_get N'statusbar_all_yellow',@st OUT \nIF @st IS NOT NULL EXEC sp_api_modal_set N'statusbar_all_yellow', NULL\nELSE EXEC sp_api_modal_set N'statusbar_all_yellow', N'Press ''TEST YELLOW'' again'",
            "action_id": 83,
            "action_name": "testyellow",
            "source_table": "api_actions"
        },
        {
            "sql_source": null,
            "action_id": 84,
            "action_name": "toastje",
            "source_table": "api_actions"
        },
        {
            "sql_source": null,
            "action_id": 85,
            "action_name": "transporteurs",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_goto @path='/vatperc'\n",
            "action_id": 86,
            "action_name": "vatPercentage",
            "source_table": "api_actions"
        },
        {
            "sql_source": null,
            "action_id": 88,
            "action_name": "verkoop_uit_voorraad",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_goto @path='/xvessel'",
            "action_id": 89,
            "action_name": "Vessel",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @value bit\nexec sp_api_modal_sure @alert_text =N'alle data wissen?', @value = @value OUT\n\nif @value=1\n\tbegin\n\t\tif (select count(*) from xinvoice) <20\n\t\t\tbegin\n\t\t\t\tupdate xinvoice set status='Draft'\n\t\t\t\texec sp_wis_alles 2023\n\t\t\t\texec sp_api_modal_clear\n\t\t\t\treturn;\n\t\t\tend\t\n\tend\t\n\nif @value=0\n\tbegin\n\t\texec sp_api_modal_clear\n\t\treturn;\n\tend\t\n\t\nexec sp_api_modal_restart\t\n\t",
            "action_id": 90,
            "action_name": "wis_alles",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @cursor_ids CURSOR,@cid INT, @tekst NVARCHAR(100), @sqlTask nvarchar(1024)\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tSET @TEKST=CONCAT(N'Toewijzen order ',@cid)\n\t\tEXEC sp_api_toast @TEKST\n/*\n\t\t------------------single action---------------------------------------------------\n\t\texec @main_db.dbo.SP_CURSED_MAPPER_CTH @CTH_ID =@cid ,@MAPINKOOP =1,@MAPVERKOOP =1\n\t\t--zet tevens landfreight op checked\n\t\texec @main_db.dbo.SP_CURS_SetChecked_CTH @cid\n\t\t----------------------------------------------------------------------------------\n*/\n\t\tSET @sqltask = CONCAT(N'\n\t\texec @main_db.dbo.SP_CURSED_MAPPER_CTH @CTH_ID =',@cid,' ,@MAPINKOOP =1,@MAPVERKOOP =1\n\t\texec @main_db.dbo.SP_CURS_SetChecked_CTH ',@cid)\n\t\tEXEC sp_api_add_sql_task @sql=@sqltask,@description=@TEKST --N'Verstuur facturen'\n\t\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;\n\n--wis als laatste alle markeringen\nEXEC sp_api_modal_select_all_clear \n\n\n\n\n",
            "action_id": 91,
            "action_name": "CTH_Toewijzen",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_search_all @card_id_reduced,@reducer,@focus,@highlight",
            "action_id": 92,
            "action_name": "sys_search_all",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_alert N'Populate all cards?',N'Action will be scheduled.'\nEXEC sp_api_modal_clear\nEXEC sp_api_populate_cards\nEXEC sp_api_push_bullet @channel_tag = 'tracy',@title=@User_name, @body='Populate ALL', @type='link', @url=N'https://agfx.nl'\nEXEC sp_api_modal_route @name = N'Go to tasks',@pathname=N'/api_sql_tasks'\t,@search =N'?ord=16594d' ,@class = N'btn-success' ,@key = N'Enter'\n",
            "action_id": 93,
            "action_name": "sys_populate_all",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @field_name nvarchar(128),@text nvarchar(max)\nSELECT @field_name = name FROM api_card_fields WHERE card_id = @card_id AND id = @card_field_id\nSET @text = N'This will delete field ['+@field_name+'] and its attributes. Re-populate, so it may come back'\nEXEC sp_api_modal_alert N'Warning!',@text\nDELETE FROM api_card_fields WHERE card_id = @card_id AND id = @card_field_id\nEXEC sp_api_populate_card @card_id\nEXEC sp_api_modal_clear",
            "action_id": 94,
            "action_name": "sys_gui_delete",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_gui_insert @card_id,@card_field_id",
            "action_id": 95,
            "action_name": "sys_gui_insert_text",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_list_editable @card_id,@id",
            "action_id": 99,
            "action_name": "sys_list_editable",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_route @name='verkoop definitief',@pathname='/verkoop',@search= '?red=closed+sales' --&ord=8629d' ",
            "action_id": 103,
            "action_name": "men_sales_closed",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--EXEC sp_api_toast @parent_parent_id\r\n--exec sp_api_toast @User\r\n\t\r\nDECLARE @CTHID INT = {[verkoop].id} --200818 curly\r\nIF @CTHID IS NULL begin\r\n\t\tEXEC sp_api_toast 'Kan geen [verkoop] vinden'\r\n\t\tRETURN;\r\n\t\tend\r\n--ELSE EXEC sp_api_toast @CTHID\r\n\r\n--DECLARE @CTRID INT \r\n--SELECT @CTRID=id from xtransactiondetail where TransactionHeader_ID = @CTHID\r\n\r\nDECLARE @GIP nvarchar(10)\r\nselect @GIP= av from @main_db.dbo.gip(@ID)\r\n\r\nDECLARE @mes nvarchar(200), @FustSaldo int, @CoreType nvarchar(10),@FustID int, @xDesc nvarchar(200)\r\nSELECT @xDesc=x.[Description],@mes= concat('Selling ' , x.[Description],' (GIP:',TRY_CAST(@GIP as decimal(8,2)),')'),@Coretype= x.coretype,@FustID=x.Fust_ID from xstock x where x.id=@ID --@main_db.dbo.\r\n--EXEC sp_api_modal_text @mes,'h2 text-primary'\r\n\r\nIF {[verkoop].status} not in ('openSale') AND @Coretype='FOOD' BEGIN --200924 fust mag wel worden bij of afgeboekt\r\n\tEXEC sp_api_modal_alert 'U kunt alleen leeg FUST toevoegen/terugnemen, want de order is definitief.'\r\n\tEXEC sp_api_modal_clear\t\t\r\n\tRETURN;\t\r\n\tend\r\n\r\n-- 200629 Uitbreiding inkoop vanuit diverse contexten: Zoek CTH ; bijv als we afkomstig zijn van een regel, dan is CTH te vinden in de regel\r\n--if @parent_card_name ='verkoop'\tset @CTHID=@parent_id\r\n--if @parent_card_name = 'ctr2' set @CTHID=(select TransactionHeader_ID from xtransactiondetail where xtransactiondetail.id=@parent_id)\r\nIF @coretype in('CRATE','PALLET')\r\n\tBEGIN\r\n\t\tSELECT @Fustsaldo=Fustsaldo from @main_db.dbo.FustSaldo_FC(@FustID,{[verkoop2].Counterparty_ID})\r\n\t\t-- EXEC sp_api_toast @Fustsaldo\r\n\t\t-- breid DECLARE message uit met het fust-saldo\r\n\t\tIF @FustSaldo is not NULL\r\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') actueel saldo bij deze klant: ',@fustsaldo)\r\n\t\tELSE\r\n\t\t\tSET @mes=concat('Fust bij- of afboeken (', @xDesc,') => let op: deze klant heeft dit fust nooit eerder gehad!')\r\n\tEND\r\n\t\r\nDECLARE @text nvarchar(max),@prodcode_id INT,@artcode_id INT\r\nDECLARE @prijs nvarchar(20),@aantal nvarchar(20),@opmerking nvarchar(10), @Pricetype nvarchar(10) --='100'\r\nDECLARE @CounterpartyID int\r\nDECLARE @FlowModel int\r\nDECLARE @THDT INT\r\nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=FlowModel_ID,@THDT=TDT From xTransactionHeader CTH where CTH.ID=@CTHID\r\n--200630 was@parent_id\r\n\r\n--200708 => ??? WAAROM GAAT DIT NIET ??? select @Prijs= @main_db.dbo.StockPrice(@ID,@CTHID,NULL,NULL,NULL,NULL,NULL,NULL,NULL)\r\nDECLARE @FRAFOT Nvarchar(3) -- 'FRA' OF 'FOT'\r\nDECLARE @SrcID int -- let op: slechts 'advies'\r\nDECLARE @DstID INT\r\n\r\n\r\n--201022\r\ndeclare @dayprice bit\r\nset @dayprice=isnull((select L from @main_db.dbo.[GetCompanySettings]('useDayprice')),0)\r\n-- exec sp_api_toast @dayprice\r\n\r\nif @dayprice = 1 \r\n\tBEGIN\r\n\t\tselect top 1 @Prijs=per.pricehi from p_PriceEntryRow per where per.Stock_ID=@ID and per.Supplier_ID=@CounterpartyID and per.activeCount>0\r\n\tEND\r\n\r\nSELECT @CounterpartyID = CTH.counterparty_ID,@FlowModel=cth.FlowModel_ID,@THDT=cth.TDT,@FRAFOT=cth.FRAFOT, @srcID=cth.source_ID,@DstID=cth.Destination_ID From q_xTransactionHeader CTH where CTH.ID=@CTHID\r\n-- exec sp_api_toast @dstID\r\n--200630 was@parent_id\r\n\r\nif isnull(@Prijs,0)=0\r\n\tbegin\r\n\t\t--SELECT top 1 @prijs = ctr.ctrPRICE FROM xctrtotals ctr WHERE ctr.ctrprice > 0 AND ctr.Counterparty_ID=@CounterpartyID AND ctr.ctrStock_ID =@ID ORDER BY ctr.id DESC -- laatste prijs!\r\n\r\n\t\tset @prijs=(select @main_db.dbo.stockprice(\t@ID --48482 --stock_ID\r\n\t\t\t\t\t\t\t,@CTHID --3761\t--CTH_ID\r\n\t\t\t\t\t\t\t,@CounterpartyID --161418\t--Counterparty_ID\r\n\t\t\t\t\t\t\t,@FlowModel --null\t--Flowmodel_ID\r\n\t\t\t\t\t\t\t,@THDT --2\t\t--DaTDT\r\n\t\t\t\t\t\t\t,@SrcID --NULL --SupplierLocation_ID\r\n\t\t\t\t\t\t\t,@DstID --NULL -- 7945\t--Receiverlocation_ID\r\n\t\t\t\t\t\t\t,IIF(@FRAFOT='FOT',1,0)\t\t--isFOT\r\n\t\t\t\t\t\t\t,@dayprice --0-- use dayprice\r\n\t\t\t\t\t\t)\r\n\t\t\t\t\t)\r\n\r\n\tend\r\n\r\nIF @id = ANY (select stock_id from xtransactiondetail where TransactionHeader_ID = @CTHID AND stock_id = @id) BEGIN\r\n\tDECLARE @QTYCTR nvarchar(20)\r\n\tSELECT @QTYCTR = sum(Amount) from xTransactiondetail where @id = stock_id AND TransactionHeader_ID = @CTHID\r\n\tEXEC sp_api_modal_text 'Let op! Dit artikel bestaat al in de bestelling!','text-danger font-weight-bold h2 text-center'\r\n\tEXEC sp_api_modal_text 'Momenteel in bestelling:','text-danger font-weight-bold h2 text-center'\r\n\tEXEC sp_api_modal_text @QTYCTR,@class = 'text-danger font-weight-bold display-4 text-center'\r\nEND\r\nEXEC sp_api_modal_text @text = @mes,@class = 'h3 text-muted'\r\nEXEC sp_api_modal_text 'Aantal'\r\nEXEC sp_api_modal_input @name='aantal',@value = @aantal OUT,@focus=1,@select=1\r\nIF @coretype in('FOOD')\r\n\tBEGIN\r\n\t\tEXEC sp_api_modal_text 'Prijs'\r\n\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT\r\n\tEND\r\nEXEC sp_api_modal_text 'Opm. loods'\r\nEXEC sp_api_modal_input @name='opmerking',@value = @opmerking OUT\r\nDECLARE @button nvarchar(128)\r\nEXEC sp_api_modal_button @name='button',@value = 'Toevoegen',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\r\nDECLARE @mapfustpartijregel int\r\n\r\n\tBEGIN\r\n\t\tIF dbo.str2dec(@prijs) > 100 BEGIN -- groter dan 100\r\n\t\tEXEC sp_api_modal_clear\t\r\n\t\tEXEC sp_api_modal_text 'LET OP! PRIJS IS GROTER DAN:','text-danger font-weight-bold text-center'\r\n\t\tEXEC sp_api_modal_text '100,00', 'text-danger font-weight-bold display-4 text-center'\r\n\t\tEXEC sp_api_modal_text 'DRUK (INSERT) OM TOCH DOOR TE GAAN OF VUL EEN ANDERE PRIJS IN:','text-danger font-weight-bold text-center'\r\n\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT,@focus=1,@select=1\r\n\t\tDECLARE @button2 nvarchar(128)\r\n\t\tEXEC sp_api_modal_button @name='button2',@value = 'Doorgaan',@valueout = @button2 OUT,@class = 'btn-danger',@key = 'Insert'\r\n\t\tEXEC sp_api_modal_text 'DRUK OP (ESC) OM DIT SCHERM TE VERLATEN','text-Secondary text-right blockquote-footer'\r\n\t\tIF @button2 IS NOT NULL BEGIN\r\n\t\t\tIF @button IS NOT NULL\r\n\t\t\tBEGIN\r\n\t\t\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') \r\n\t\t\t\tIF \t\tdbo.str2dec(@prijs) > 0 OR dbo.str2dec(@prijs) = 0 AND \r\n\t\t\t\t\t\tdbo.str2dec(@aantal) > 0 \r\n\t\t\t\t\t\tOR @FustSaldo is not NULL \r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs,@Logistic=@Opmerking, @User=@User\r\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\r\n\t\t\t\t\t\texec sp_api_toast @mes\r\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\r\n\t\t\t\t\tEND\r\n\t\t\t\tELSE\r\n\t\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\r\n\t\t\t\tEND \t\t\r\n\t\t\tEND\r\n\t\tEND\r\n\r\n\t\tIF dbo.str2dec(@prijs) BETWEEN 0 AND 1 BEGIN -- kleiner dan 1\r\n\t\tEXEC sp_api_modal_clear\r\n\t\tEXEC sp_api_modal_text 'LET OP! PRIJS IS KLEINER DAN:','text-danger font-weight-bold text-center'\r\n\t\tEXEC sp_api_modal_text '1,00','text-danger font-weight-bold display-4 text-center'\r\n\t\tEXEC sp_api_modal_text 'DRUK (INSERT) OM TOCH DOOR TE GAAN OF VUL EEN ANDERE PRIJS IN:','text-danger font-weight-bold text-center'\r\n\t\tEXEC sp_api_modal_input @name='prijs',@value = @prijs OUT,@focus=1,@select=1\r\n\t\tDECLARE @button3 nvarchar(128)\r\n\t\tEXEC sp_api_modal_button @name='button3',@value = 'Doorgaan',@valueout = @button3 OUT,@class = 'btn-danger',@key = 'Insert'\r\n\t\tEXEC sp_api_modal_text 'DRUK OP (ESC) OM DIT SCHERM TE VERLATEN','text-Secondary text-right blockquote-footer'\r\n\t\tIF @button3 IS NOT NULL BEGIN\r\n\t\t\tIF @button IS NOT NULL\r\n\t\t\tBEGIN\r\n\t\t\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') \r\n\t\t\t\tIF \t\tdbo.str2dec(@prijs) > 0 OR dbo.str2dec(@prijs) = 0 AND \r\n\t\t\t\t\t\tdbo.str2dec(@aantal) > 0 \r\n\t\t\t\t\t\tOR @FustSaldo is not NULL \r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs,@Logistic=@Opmerking, @User=@User\r\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\r\n\t\t\t\t\t\texec sp_api_toast @mes\r\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\r\n\t\t\t\t\tEND\r\n\t\t\t\tELSE\r\n\t\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\r\n\t\t\t\tEND \t\t\r\n\t\t\tEND\r\n\t\tEND\r\n\tEND\r\n\r\nIF @button IS NOT NULL AND dbo.str2dec(@prijs) BETWEEN 1 AND 100 -- tussen 1 en 100\r\n\t\t\tBEGIN\r\n\t\t\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') -- dit vertaalt een komma in een punt, waardoor iemand 123,85 kan intikken END ook 123.85\r\n\t\t\t\tIF \t\tdbo.str2dec(@prijs) > 0 AND \r\n\t\t\t\t\t\tdbo.str2dec(@aantal) > 0 \r\n\t\t\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs,@Logistic=@Opmerking, @User=@User\r\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\r\n\t\t\t\t\t\texec sp_api_toast @mes\r\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\r\n\t\t\t\t\tEND\r\n\t\t\t\tELSE\r\n\t\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\r\n\t\t\t\tEND\r\nIF @button IS NOT NULL AND @coretype in('CRATE','PALLET') -- fust\r\n\t\t\tBEGIN\r\n\t\t\t\tIF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') -- dit vertaalt een komma in een punt, waardoor iemand 123,85 kan intikken END ook 123.85\r\n\t\t\t\tIF \t\t--dbo.str2dec(@prijs) > 0 AND \r\n\t\t\t\t\t\tdbo.str2dec(@aantal) > 0 \r\n\t\t\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\tSET @mapfustpartijregel=(select @main_db.dbo.FustIV_VTD(@FustID))\r\n\t\t\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs,@Logistic=@Opmerking, @User=@User,@mapctr_id=@mapfustpartijregel\r\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\r\n\t\t\t\t\t\texec sp_api_toast @mes\r\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\r\n\t\t\t\t\tEND\r\n\t\t\t\tELSE\r\n\t\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\r\n\t\t\t\tEND\r\nIF @button IS NOT NULL AND dbo.str2dec(@aantal) > 0  AND dbo.str2dec(@prijs) is NULL -- aantal groter dan 0 en price niet ingevuld.\r\n\t\t\tBEGIN\r\n\t\t\t\t--IF @Prijs>N'' SET @Prijs=replace(@Prijs, ',', '.') -- dit vertaalt een komma in een punt, waardoor iemand 123,85 kan intikken END ook 123.85\r\n\t\t\t\tIF \t\t--dbo.str2dec(@prijs) > 0 AND \r\n\t\t\t\t\t\tdbo.str2dec(@aantal) > 0 \r\n\t\t\t\t\t\tOR @FustSaldo is not NULL -- 200921 Als het een selectie van LEEG FUST betreft, dan mag het aantal Negatief zijn!\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\tSET @mapfustpartijregel=(select @main_db.dbo.FustIV_VTD(@FustID))\r\n\t\t\t\t\t\texec @main_db.dbo.CreateCTR @CTH_ID=@CTHID, @stock_ID=@ID,@Amount=@Aantal,@Price=@Prijs,@Pricetype='FIXED',@Logistic=@Opmerking, \t\t\t \r\n   \t\t\t\t\t\t@User=@User,@mapctr_id=@mapfustpartijregel\r\n\t\t\t\t\t\tselect @mes = 'Er zijn '+@Aantal+ ' colli '+ x.[Description]+' toegevoegd aan de order' from xstock x where x.id=@ID\r\n\t\t\t\t\t\texec sp_api_toast @mes\r\n\t\t\t\t\t\tEXEC sp_api_modal_clear\t\t\t\t\t\t\r\n\t\t\t\t\tEND\r\n\t\t\t\tELSE\r\n\t\t\t\t\tEXEC sp_api_modal_text 'Aantal of prijs niet geldig!','text-danger'\r\n\t\t\t\tEND",
            "action_id": 104,
            "action_name": "SelectAmountVerkoop",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @mainclass nvarchar(128) = N'm-4 text-muted'\n\t,@text nvarchar(max)\n\nEXEC sp_api_modal_text @text = N'Add a JSON field',@class = N'h4 text-muted'--, @translate = 1\nEXEC sp_api_modal_text @text = N'Choose a column which is the JSON data store',@class = @mainclass--, @translate = 1\n\nIF @tablename LIKE 'api[_]%'\n\tBEGIN\n\t\tSELECT id=name,name INTO #sys_columns_proj FROM sys.columns WHERE object_id = (SELECT object_id FROM sys.objects WHERE name = @basetable) AND max_length=-1\n\t\tSET @tmptable=N'#sys_columns_proj'\n\tEND\nELSE\n\tBEGIN\n\t\tSELECT id=name,name INTO #sys_columns FROM sys_columns WHERE object_id = (SELECT object_id FROM sys_objects WHERE name = @basetable) AND max_length=-1\n\t\tSET @tmptable=N'#sys_columns'\n\tEND\n\n\nDECLARE @json_column nvarchar(128),@json_key nvarchar(4000)\nEXEC sp_api_modal_select_table @tmptable=@tmptable,@value = @json_column OUT,@focus=1--,@select=1\n\nIF @json_column IS NULL RETURN\nDECLARE @sql nvarchar(max)\nCREATE TABLE #in_use (JSON nvarchar(max))\nSET @sql = CONCAT(N'INSERT #in_use SELECT ''[''+LEFT(',QUOTENAME(@json_column),',200)+'']'' FROM ',QUOTENAME(@tablename)\n\t\t,' WHERE ISJSON(',QUOTENAME(@json_column),') = 0 AND ',QUOTENAME(@json_column),'> '''' ORDER BY newid()')\nEXEC(@sql)\n--DECLARE @json nvarchar(max) = (SELECT * FROM #in_use FOR JSON AUTO, INCLUDE_NULL_VALUES)\n--EXEC sp_api_modal_text @json\n\nIF EXISTS(SELECT * FROM  #in_use)\n\tBEGIN\n\t\tEXEC sp_api_modal_text @text = N'\u26a0\ufe0f Some fields (top 25 shown) are in use as non-JSON. These will be over-written:',@class = @mainclass\n\t\tEXEC sp_api_modal_table @tmptable=N'#in_use',@orderby=N'ORDER BY 1 OFFSET 0 ROWS FETCH NEXT 25 ROWS ONLY'\n--\t\tEXEC sp_api_modal_clear\n\tEND\nCREATE TABLE #json_keys (id nvarchar(4000),name nvarchar(4000))\nSET @sql = CONCAT(N'INSERT #json_keys SELECT DISTINCT id = j.[key],name = j.[key] FROM ',QUOTENAME(@tablename)\n\t,' CROSS APPLY OPENJSON(',QUOTENAME(@json_column),') j WHERE ISJSON(',QUOTENAME(@json_column),') > 0')\nEXEC(@sql)\n\n\n/*\nEXEC sp_api_modal_text @text = N'Kies een optie met F-toetsen',@class = @mainclass\nDECLARE @button_choose nvarchar(128)\nEXEC sp_api_modal_choose @list = N'Predefined,Custom,wert,wertr,wywer,tqyer,twertq,ewrt',@value = @button_choose OUT\nEXEC sp_api_modal_text @button_choose\n\nEXEC sp_api_modal_text @text = N'Kies een optie met beginletter-toetsen (spatie = geen)',@class = @mainclass\nDECLARE @button_choose2 nvarchar(128)\nEXEC sp_api_modal_choose @list = N'Predefined,Custom, wert,wertr, wywer,tqyer, twertq,ewrt2',@value = @button_choose2 OUT,@startkey=NULL\nEXEC sp_api_modal_text @button_choose2\n*/\n\n--RETURN\nDECLARE @button_choose nvarchar(128) = 'Custom'\nIF EXISTS (SELECT * FROM #json_keys)\n\tBEGIN\n\t\tSET @button_choose = 'Predefined'\n\t\tEXEC sp_api_modal_choose @list = N'Predefined,Custom',@value = @button_choose OUT\n\t\tIF @button_choose = N'Predefined'\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text @text = N'Choose a predefined field name / JSON key:',@class = @mainclass\n\t\t\t\tEXEC sp_api_modal_select_table @tmptable=N'#json_keys',@value = @json_key OUT --,@select=1\n\t\t\tEND\n\tEND\n\nIF @button_choose = 'Custom'\n\tBEGIN\n\t\tEXEC sp_api_modal_text @text = N'Choose a custom field name / JSON key:',@class = @mainclass\n\t\tEXEC sp_api_modal_input @name='JSON key', @value= @json_key OUT,@class='' ,@focus=1,@select=1,@inline=1\n\t\tDECLARE @button1 nvarchar(128),@button_text1 nvarchar(128) = 'Validate'\n\t\tEXEC sp_api_modal_button @name='button1',@value = @button_text1, @valueout = @button1 OUT ,@class='btn-primary',@key='Enter'\n\tEND\n\nIF NULLIF(@json_key,'') IS NOT NULL\n\tBEGIN\n\t\t--DECLARE @field_name nvarchar(128) = N'json_' + @json_key,@detail_order INT,@detail_page INT\n\t\tDECLARE @field_name nvarchar(128),@detail_order INT,@detail_page INT\n\t\tSET @field_name = 'json_' + @json_key\n\t\tIF EXISTS (SELECT * FROM api_card_fields WHERE card_id = @card_id AND name = @field_name)\n\t\t\tBEGIN\n\t\t\t\tSET @text = N'\u26a0\ufe0f Field ['+@field_name+'] already exists'\n\t\t\t\tEXEC sp_api_modal_text @text,@class = @mainclass\n\t\t\tEND\n\t\tELSE\n\t\t\tBEGIN\n\t\t\t\tSET @text = N'\u2714\ufe0f Field ['+@field_name+'] will be created'\n\t\t\t\tEXEC sp_api_modal_text @text,@class = @mainclass\n\t\t\t\tDECLARE @button2 nvarchar(128),@button_text2 nvarchar(128) = 'Create Field'\n\t\t\t\tEXEC sp_api_modal_button @name='button2',@value = @button_text2, @valueout = @button2 OUT,@class='btn-danger',@key='Insert'\n\t\t\t\tIF @button2 IS NOT NULL\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tSELECT @detail_order=detail_order,@detail_page = detail_page FROM api_card_fields WHERE card_id = @card_id AND id = @card_field_id\n\t\t\t\t\t\tIF @detail_order IS NULL SET @detail_order = 4\n\t\t\t\t\t\tIF @detail_page IS NULL SET @detail_page = 0\n\t\t\t\t\t\tSET @detail_order-=1\n\t\t\t\t\t\tINSERT api_card_fields (card_id,name,unparsed_sql,sql,detail_order,detail_page)\n\t\t\t\t\t\t\tVALUES(@card_id,@field_name,'dbo.json_get('+QUOTENAME(@json_column)+','\n\t\t\t\t\t\t\t+ dbo.escape_string(@json_key) + ')','dbo.json_get('+QUOTENAME(@json_column)+','\n\t\t\t\t\t\t\t+ dbo.escape_string(@json_key) + ')',@detail_order,@detail_page)\n\t\t\t\t\t\tDECLARE @new_field_id INT = SCOPE_IDENTITY()\n\t\t\t\t\t\tINSERT api_card_field_attributes (field_id,attr_id,unparsed_sql,sql)\n\t\t\t\t\t\tVALUES(@new_field_id,(SELECT id FROM api_attributes WHERE name = 'is_updateable'),'@is_updateable','@is_updateable')\n\t\t\t\t\t\t--EXEC sp_api_populate_card @card_id\n\t\t\t\t\tEND\n\n\t\t\tEND\n/*\n\t\t;WITH nums as (SELECT a = 1 UNION ALL SELECT a=a+1 FROM nums WHERE a < 100)\n\t\t\tSELECT TOP 1 @json_key+=dbo.nv(IIF(a=1,NULL,a)) FROM nums WHERE NOT EXISTS (SELECT * FROM api_card_fields WHERE card_id = @card_id AND name = @json_key+dbo.nv(a))\n\t\t\t\t ORDER BY a\n\t\tEXEC sp_api_modal_text @json_key\n*/\n\tEND\n\n\n\n\n\nIF @button1 IS NULL RETURN\n\nRETURN\n--EXEC sp_api_modal_input @name='Naam',@max=5, @value= @valueout OUT,@focus=1,@select=1 [,@hidden = 1]\n--EXEC sp_api_modal_date @name='Datum'@value= @valueout OUT,@focus=1\n--EXEC sp_api_modal_button @name='Sure',@value = 'Ja', @valueout = @valueout OUT,@class='btn-danger',@key='Enter'\n/*\nSELECT * INTO #jsontable FROM OPENJSON(NULL)\nSET @sql = ';WITH cte as (SELECT JSON FROM #in_use) INSERT INTO #jsontable SELECT * FROM OPENJSON(cte.JSON) JOIN cte ON 1=1'\nEXEC(@sql)\nEXEC sp_api_modal_table @tmptable=N'#jsontable'\n\n\nEXEC sp_api_modal_text @sql\n\n\n--SELECT dataset='table'\n--EXEC(@sql)\nRETURN\n\n\nDECLARE @field_name nvarchar(128) = N'gui_text_',@detail_order INT,@detail_page INT\n;WITH nums as (SELECT a = 1 UNION ALL SELECT a=a+1 FROM nums WHERE a < 100)\n\tSELECT TOP 1 @field_name+=dbo.nv(a) FROM nums WHERE NOT EXISTS (SELECT * FROM api_card_fields WHERE card_id = @card_id AND name = @field_name+dbo.nv(a)) ORDER BY a\n--SELECT @field_name+=dbo.nv(count(*)+1) FROM api_card_fields WHERE card_id = @card_id AND name LIKE @field_name+'%'\nSELECT @detail_order=detail_order,@detail_page = detail_page FROM api_card_fields WHERE card_id = @card_id AND id = @card_field_id\nIF @detail_order IS NULL SET @detail_order = 4\nIF @detail_page IS NULL SET @detail_page = 0\nSET @detail_order-=1\nINSERT api_card_fields (card_id,name,unparsed_sql,sql,detail_order,detail_page)\n\tVALUES(@card_id,@field_name,'''''','''''',@detail_order,@detail_page)\nDECLARE @new_field_id INT = SCOPE_IDENTITY()\nINSERT api_card_field_attributes (field_id,attr_id,unparsed_sql,sql)\nVALUES(@new_field_id,(SELECT id FROM api_attributes WHERE name = 'element'),'''Text''','''Text''')\nEXEC sp_api_populate_card @card_id\n\n*/",
            "action_id": 106,
            "action_name": "sys_gui_insert_json_field",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_text 'Calculator',N'h2'\n--DECLARE @calc nvarchar(256) = '0',@button nvarchar(128),@result nvarchar(1000),@sql nvarchar(1000)\n--EXEC sp_api_modal_input_calculator @name='calc',@value = @calc OUT,@focus=1,@select=1\nEXEC sp_api_modal_input_calculator @value = @value OUT\nEXEC sp_api_modal_button @name='@button',@value = 'Bereken',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\nEXEC sp_api_modal_text @value\n/*\nRETURN\n\n\nBEGIN TRY\n\nDECLARE @KeepValues nvarchar(50) = N'%[^0-9+* /().-]%'\n    While PATINDEX(@KeepValues, @calc) > 0\n        Set @calc = Stuff(@calc, PatIndex(@KeepValues, @calc), 1, '')\n\tSET @result = @calc +' = '\n\tSET @sql = N'SET @calc = TRY_CAST((1.0*'+@calc+') as decimal(18,2))'\n\tSET @calc = 0\n\tEXEC sp_executesql @sql,N'@calc decimal(18,2) OUT',@calc OUT\n\tSET @result+= @calc\nEND TRY BEGIN CATCH\n\tSET @result+= 'Err'\n END CATCH\n*/",
            "action_id": 113,
            "action_name": "sys_calculator",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_text N'Verstuur een bericht',N'h4 text-muted'\nEXEC sp_api_modal_select @card_name = N'api_user',@value = @to_user_id OUT,@focus = 1\nIF @to_user_id IS NOT NULL\n\tBEGIN\n\t\tEXEC sp_api_modal_input '@message_text',@message_text OUT,@focus = 1\n\t\tEXEC sp_api_modal_text @to_user_id\n\t\tEXEC sp_api_modal_text @message_text\n\t\tEXEC sp_api_modal_text @pathname\n\t\tEXEC sp_api_modal_text @search\n\t\tEXEC sp_api_modal_button N'@button1','Verstuur',@button OUT ,@class='btn-danger',@key='Enter'\n\tEND",
            "action_id": 124,
            "action_name": "sys_send_message",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--DECLARE @date nvarchar(128) = dbo.workDate()\nDECLARE @F1button nvarchar(128)= 'VCheck'\n\nEXEC sp_api_modal_text 'Check Functies:'\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n\nEXEC sp_api_modal_button @name='button',@value = 'Landfreight met afwijkend Transport',@valueout = @F1button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print\n\nIF @F1button =  'VCheck'\nBEGIN\n\tSELECT *\n\tINTO #TMPLF\n\tfrom @main_db.dbo.Check_LF_Met_Afwijkend_Transport() \n\tEXEC sp_api_modal_table @tmptable=N'#TMPLF',@print=1\n\nEND ",
            "action_id": 131,
            "action_name": "LF met afwijkend transport",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--DECLARE @date nvarchar(128) = dbo.workDate()\nDECLARE @F1button nvarchar(128)= 'VCheck'\n\nEXEC sp_api_modal_text 'Check Functies:'\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n\nEXEC sp_api_modal_button @name='button',@value = 'Voorraad Controle',@valueout = @F1button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print\n\nIF @F1button =  'VCheck'\nBEGIN\n\tSELECT *\n\tINTO #ColliVerkocht\n\tfrom @main_db.dbo.CheckSum_Stock_CTR(0) where sum_ctrAmount<> (stock+delayedIn+DelayedOut)\n\t\tEXEC sp_api_modal_table @tmptable=N'#ColliVerkocht',@print=1\nEND ",
            "action_id": 138,
            "action_name": "voorraad controle",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--DECLARE @date nvarchar(128) = dbo.workDate()\nDECLARE @F1button nvarchar(128)= 'VCheck'\n\nEXEC sp_api_modal_text 'Check Functies:'\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n\nEXEC sp_api_modal_button @name='button',@value = 'Vreemde Toewijzingen',@valueout = @F1button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print\n\nIF @F1button =  'VCheck'\nBEGIN\n\tselect inkoopdatum=vdate, inkoopnummer=VTH, vtd , leverancier=vtdtCounterparty , verkoopdatum=idate, FysiekAantal=LinkAantal * iv_stockmut , klantnaam=itdtCounterparty, verkoop_order =ITH, itd  \n\tINTO #tmptab\n\tfrom code_ivlink \n\t\twhere vdate > idate -- kan niet eerder verkocht dan ingekocht\n\t\torder by vth\n\tEXEC sp_api_modal_table @tmptable=N'#tmptab',@print=1\nEND \n",
            "action_id": 139,
            "action_name": "Vreemde toewijzingen",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_edit_actions @card_id",
            "action_id": 144,
            "action_name": "sys_edit_actions",
            "source_table": "api_actions"
        },
        {
            "sql_source": "update xtenant set forceToTestmodus = case when forceToTestmodus = 1 then 0 else 1 end where id=7",
            "action_id": 150,
            "action_name": "TestModus",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--DECLARE @date nvarchar(128) = dbo.workDate()\nDECLARE @F1button nvarchar(128)= 'VCheck'\n\nEXEC sp_api_modal_text 'Check Functies:'\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n\nEXEC sp_api_modal_button @name='button',@value = 'CTR_TOTALS_CONTROLE',@valueout = @F1button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print\n\nIF @F1button =  'VCheck'\nBEGIN\n\tSELECT *\n\tINTO #TDB\n\tfrom @main_db.dbo.ctr_with_incorrect_totals_iv()\n\t\tEXEC sp_api_modal_table @tmptable=N'#TDB',@print=1\nEND \n",
            "action_id": 151,
            "action_name": "ctr_totals_met_iv_fouten",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--DECLARE @date nvarchar(128) = dbo.workDate()\nDECLARE @F1button nvarchar(128)= 'VCheck'\n\nEXEC sp_api_modal_text 'Check Functies:'\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n\nEXEC sp_api_modal_button @name='button',@value = 'Landfreight met afwijkend Transport',@valueout = @F1button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print\n\nIF @F1button =  'VCheck'\nBEGIN\n\tSELECT *\n\tINTO #TMPLF\n\tfrom @main_db.dbo.Check_LF_Met_Afwijkend_Transport() \n\tEXEC sp_api_modal_table @tmptable=N'#TMPLF',@print=1\n\nEND \n",
            "action_id": 152,
            "action_name": "LF_Met_Afwijkend_Transport",
            "source_table": "api_actions"
        },
        {
            "sql_source": "execute @main_db.dbo.Repair_ONE_IVLINK ",
            "action_id": 153,
            "action_name": "Repair_One_Overmapping",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--facturen waar de aantallen niet overeenstemmen met de ctr (door toewijsverchillen tijdens facturatie?)\nDECLARE @F1button nvarchar(128)= 'VCheck'\n\nEXEC sp_api_modal_text 'Check Functies:'\n\n\nEXEC sp_api_modal_button @name='button',@value = 'Vreemde facturen',@valueout = @F1button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print\n\nIF @F1button =  'VCheck'\nBEGIN\n\tselect T.TV_CompanyName, T.InvoiceNumber_F ,ctr.id,i.cth_id  as ctr_id,i.rowText , sum(i.colliAmount) AS FA ,ctr.Amount AS CA,ctr.stockMut   \n\tINTO #tmptab\nfrom xinvrow i \n\tinner join xTransactionDetail ctr on i.ctr_id =ctr.id\n\tinner join xInvoiceTotals T on i.Invoice_ID =T.Invoice_ID\n\twhere i.GroupCode =N'BASIS_AGF'\n\tgroup by i.ctr_id,ctr.Amount,ctr.stockMut ,T.TV_CompanyName,T.InvoiceNumber_F ,i.rowText ,ctr.id,i.cth_id\n\thaving sum(i.colliAmount)<>ctr.Amount \n\tEXEC sp_api_modal_table @tmptable=N'#tmptab',@print=1\nEND \n",
            "action_id": 154,
            "action_name": "Vreemde facturen",
            "source_table": "api_actions"
        },
        {
            "sql_source": "if @Transporter_ID is null set @Transporter_ID={[transporteur].ID}\nif @Transporter_ID is null set @Transporter_ID={[CompanyRole].Company_ID}\nif @Transporter_ID is null set @Transporter_ID={[adres].ID}\n\nif @Transporter_ID IS NULL \n\tbegin\n\t\texecute sp_api_modal_Alert N'Deze actie is alleen van toepassing op een bedrijf met een Transportrol'\n\t\texecute sp_api_modal_clear\n\t\treturn;\n\tend\nif @Transporter_ID IS NOT NULL\n\tbegin\n\t\tdeclare @Factor float\n\t\tselect\t@Companyname=companyname\n\t\t\t\t,@Factor =P120_Factor\n\t\t\t\t, @Ftxt=concat(N'Voor transporteur ',companyname,N' is geen vaste euro conversie factor ingesteld bij de CompayRole [TRANSPORT].') \n\t\tfrom Q_xcompanyRole where company_ID=@Transporter_ID and Role_ID= 4 --TRANSPORT\n\t\tif @companyname is null\n\t\t\tbegin\n\t\t\t\texecute sp_api_modal_alert N'De actie kan niet worden uitgevoerd. Deze is alleen voor Transporteurs bedoeld.'\n\t\t\t\texec sp_api_modal_clear;\n\t\t\t\treturn;\n\t\t\tend\t\n\t\t\t\t\n\t\t\n\t\tif @Factor is NULL execute sp_api_modal_alert @FTxt\n\t\telse\n\t\t\tbegin\n\t\t\t\tif @Factor=0 \n\t\t\t\t\tbegin\n\t\t\t\t\t\texecute sp_api_modal_Alert N'GEEN FACTOR'\t\n\t\t\t\t\t\treturn;\n\t\t\t\t\tend\t\n\t\t\t\tif @Factor>1 \n\t\t\t\t\tbegin\n\t\t\t\t\t\texecute sp_api_modal_Alert N'Factor mag nooit groter zijn dan 1'\t\n\t\t\t\t\t\treturn;\n\t\t\t\t\tend\t\n\n\t\t\t\tif @Factor <=1 \n\t\t\t\t\tbegin\n\t\t\t\t\t\tset @ftxt = concat(N'U staat op het punt om het tarief voor Europallets opnieuw in te stellen. Voor ',@Companyname,N' geldt een omrekenfactor van ',@factor,N'. Met ENTER gaat u dit doorvoeren; Gebruik ESC als u wilt stoppen.')\n\t\t\t\t\t\texecute sp_api_modal_Alert @ftxt\n\n\t\t\t\t\t\t--kennelijk mogen we verder\n\t\t\t\t\t\tset @ftxt = concat(N'Bent u zeker? De Europallet tarieven voor ALLE staffels en ALLE Regions worden overschreven voor de transporteur',@companyname,N'. Laatste kans: Gebruik ESC als u wilt stoppen!')\n\t\t\t\t\t\texecute sp_api_modal_Alert @ftxt\n\t\t\t\t\t\t\n\t\t\t\t\t\t--210124\n\t\t\t\t\t\tdeclare @Res01 int\n\t\t\t\t\t\texecute @Res01=@main_db.dbo.Set_P96_For_RegionTariff @Transporter_ID=@Transporter_ID\n\t\t\t\t\t\tif @Res01\t=0 \n\t\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\t\texecute sp_api_modal_Alert N'Het tarief voor de Europallets is opnieuw ingesteld.'\t\t\t\t\t\t\n\t\t\t\t\t\t\t\texecute sp_api_modal_clear\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\tend\n\t\t\t\t\t\tif @Res01\t<0 \n\t\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\t\texecute sp_api_modal_Alert N'Tarief wijzigen is niet gelukt.'\t\t\t\t\t\t\n\t\t\t\t\t\t\t\texecute sp_api_modal_clear\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\tend\t\t\n\t\t\t\t\tend\t\n\n\t\t\tend\n\t\t\t\n\tend\t\t\n",
            "action_id": 158,
            "action_name": "Overschrijf_P96_Tarief",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_goto @path='/api_errors'\n",
            "action_id": 159,
            "action_name": "Api.Errors",
            "source_table": "api_actions"
        },
        {
            "sql_source": "if @Transporter_ID is null set @Transporter_ID={[transporteur].ID}\nif @Transporter_ID is null set @Transporter_ID={[CompanyRole].Company_ID}\nif @Transporter_ID is null set @Transporter_ID={[adres].ID}\n\nif @Transporter_ID is NOT NULL \n\texecute @R=@main_db.dbo.CopyRegions_From_To_transporter NULL, @Transporter_ID\nif @R=0 execute sp_api_Modal_Alert N'De rayonnen zijn gekopieerd naar deze transporteur.'\t\nexecute sp_api_modal_clear",
            "action_id": 160,
            "action_name": "Copy_Regions",
            "source_table": "api_actions"
        },
        {
            "sql_source": "SELECT @picklist_card_id = picklist_card_id, @card_field_name=name FROM api_card_fields WHERE id = @card_field_id\n\nIF @picklist_card_id IS NOT NULL\n\tBEGIN\n\t\tEXEC sp_api_modal_select @card_id = @picklist_card_id,@value = @picklist_value_id OUT,@focus = 1\n\t\tIF @picklist_value_id IS NOT NULL\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_post @card_name,@card_field_name,@picklist_value_id,@id\n\t\t\t\t--EXEC sp_api_modal_save N'api_card_templates',@id\n\t\t\t\tEXEC sp_api_modal_clear\n\t\t\tEND\n\tEND\n",
            "action_id": 184,
            "action_name": "sys_ajax_picklist",
            "source_table": "api_actions"
        },
        {
            "sql_source": "SELECT * INTO #icl FROM @main_db.dbo.IDEP_ICL WHERE Transactieperiode = '202101' ORDER BY Transactieperiode\nEXEC sp_api_modal_csv @tmptable=N'#icl',@ansi =1,@filename=N'icl_202101.csv',@orderby=N'ORDER BY Transactieperiode'",
            "action_id": 190,
            "action_name": "Naar ICL",
            "source_table": "api_actions"
        },
        {
            "sql_source": "execute @main_db.dbo.fix_xCTH_Check",
            "action_id": 204,
            "action_name": "fix_CthCheck",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast 'Updated!',@seconds=1",
            "action_id": 212,
            "action_name": "sys_refresh",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_broker_request @type='update',@json='{}',@dataout = @dataout OUT,@wait=25000\nEXEC sp_api_toast @dataout\n\n",
            "action_id": 220,
            "action_name": "sys_update_dispatcher",
            "source_table": "api_actions"
        },
        {
            "sql_source": "----------------------------------------------------------------------\n--\tcontext xtransactionheader !!!\n--\t210325 rh\n--\tzet de geselecteerde CTH IDs een dag verder\n----------------------------------------------------------------------\nDECLARE @newDate datetime\nDECLARE @cursor_ids CURSOR,@cid INT, @tekst NVARCHAR(100)\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tSET @TEKST=CONCAT(N'Verschuif de datum voor order ',@cid)\n\t\tEXEC sp_api_toast @TEKST\n\n\t\t------------------single action---------------------------------------------------------------\n\t\tset @newDate=(select transactiondate from xtransactionheader where id=@cid) +1 -- 1 dag er bij\n\t\tif @newDate is not NULL \n\t\t\texecute @main_db.dbo.Set_CTH_plus_LF_Date @CTH = @cid, @Datum = @newDate\n\t\t----------------------------------------------------------------------------------------------\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;\n\n--wis als laatste alle markeringen\nEXEC sp_api_modal_select_all_clear \n",
            "action_id": 230,
            "action_name": "Dag_Verder",
            "source_table": "api_actions"
        },
        {
            "sql_source": "----------------------------------------------------------------------\n--\tcontext xtransactionheader !!!\n--\t210325 rh\n--\tzet de geselecteerde CTH IDs een dag verder\n----------------------------------------------------------------------\nDECLARE @newDate datetime\nDECLARE @cursor_ids CURSOR,@cid INT, @tekst NVARCHAR(100)\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tSET @TEKST=CONCAT(N'Verschuif de datum voor order ',@cid)\n\t\tEXEC sp_api_toast @TEKST\n\n\t\t------------------single action---------------------------------------------------------------\n\t\tset @newDate=(select DATEADD(DAY,-1,transactiondate) from xtransactionheader where id=@cid) ---1 -- 1 dag terug!\n\t\t--EXEC sp_api_toast @newDate\n\t\tif @newDate is not NULL \n\t\t\texecute @main_db.dbo.Set_CTH_plus_LF_Date @CTH = @cid, @Datum = @newDate\n\t\t----------------------------------------------------------------------------------------------\n\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;\n\n--wis als laatste alle markeringen\nEXEC sp_api_modal_select_all_clear \n",
            "action_id": 235,
            "action_name": "Dag_Terug",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--\t210325RH Wijzig de laadlokatie voor een directsales order.\n--\tDeze code kan draaien in de contexten: CTR1, CTR2, IV1 en IV2\n--------------------------------------------------------------------------------------------------------------------------------------------\nDECLARE @company_id nvarchar(32),@compLoc_id  nvarchar(32),@button nvarchar(128),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000)\n\t,@reducer nvarchar(256), @iv_id int, @ctr_id int,@realSupplier_ID int, @newLocation_id int\n\t,@button1 nvarchar(128) = N'Kies Laadlokatie'\n\n--komen we vanaf iv2?\nset @iv_id={[iv2].id}\n--probeer iv1\nif @iv_id is null \n\tset @iv_id={[iv1].id}\n\n\n--als we niet vanaf IV komen, komen we dan misschien vanaf een CTR?\t\t\nif @iv_id is null \n\tbegin\n\t\t--verkoop ctr?\n\t\tset @ctr_id={[ctr2].id}\n\t\t--inkoop ctr?\n\t\tif @ctr_id is null \n\t\t\tset @ctr_id={[ctr1].id}\n\t\t\n\t\t--hopelijk hebben we nu een ctr..\n\t\t--controleer of de (eventuele) ctr volledig is toegewezen met 1 IV\n\t\tif (select count(id) from xivlink where itd=@ctr_id or vtd=@ctr_id) <> 1\n\t\tbegin --fout!\n\t\t\texecute sp_api_modal_alert N'De regel moet volledig zijn toegewezen met 1 IVLINK. Controleer de eerst de toewijzing.'\n\t\t\texecute sp_api_modal_clear\n\t\t\treturn --kappen\n\t\tend\n\n\t\t--we komen hier, dus er bestaat precies 1 IV_ID, dus door.....\n\t\tset @iv_id=(select id from xivlink where itd=@ctr_id or vtd=@ctr_id) \n\tend\n\n--ok, we hebben nu zekerhet iv_id, dus haal de leverancier op van het artikel op uit ivlink...\nset @realSupplier_ID=(select vSupplier_id from @main_db.dbo.code_IVloc where iv_id=@iv_id) --itd=@ctr_id or vtd=@ctr_id)\n\n--controleer of de CTR volledig is toegewezen met 1 IV\nif @realSupplier_ID is null\n\tbegin --fout!\n\t\texecute sp_api_modal_alert N'De leverancier kan niet bepaald worden.'\n\t\texecute sp_api_modal_clear\n\t\treturn --kappen\n\tend\n\n--ok, verder\nset @reducer=concat(N'company_id=',@realSupplier_ID) \n\n--Kies een laadlokatie uit de werklokaties van de leverancier:\nexec sp_api_modal_text N'Typ de gewenste lokatie naam. Begin met een SPATIE om vrij zoeken te activeren...' -- @GB misschien beter een Project/Tenant-setting van maken??\nEXEC sp_api_modal_select @card_name = N'company_locations',@value = @compLoc_id OUT,@focus = 1, @reducer=@reducer, @top=100\nif @compLoc_id > 0\nbegin\n\t--execute sp_api_toast @compLoc_id\n\tselect @newLocation_id = location_id from @main_db.dbo.xcompanyxlocation where id=@compLoc_id\n\tif @newLocation_id >0 \n\t\tbegin\n\t\t\texecute @main_db.dbo.Change_DirectSales_Location @iv_id=@iv_id, @newLoc=@newLocation_id\n\t\t\texecute sp_api_toast N'Instructie ontvangen voor lokatiewijziging....'\n\t\tend\n\t execute sp_api_modal_clear --KLAAR!\nend\n\n",
            "action_id": 240,
            "action_name": "wijzig_directe_laadlokatie",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_text N'Search'\nEXEC sp_api_modal_input @name='@search', @value= @search OUT,@select=1\nEXEC sp_api_modal_text N'Replace'\nEXEC sp_api_modal_input @name='@replace', @value= @replace OUT,@select=1\nEXEC sp_api_modal_text N'Add comment at bottom'\nEXEC sp_api_modal_input @name='@comment', @value= @comment OUT,@select=1\nEXEC sp_api_modal_button @name='@button',@value = 'Search', @valueout = @button OUT,@class='btn-tracy',@key='Enter'\nEXEC sp_api_modal_button @name='@button',@value = 'Replace', @valueout = @button OUT,@class='btn-danger',@key='Insert'\nDECLARE @cursor CURSOR\n,@name nvarchar(128)\n,@def nvarchar(max)\n,@otype char(2)='V'\nSET @cursor = CURSOR FOR\n\tSELECT TOP 2 name =CONCAT(o.name,' -','-> ',o.type_desc COLLATE SQL_Latin1_General_CP1_CI_AS,' - ',o.type COLLATE SQL_Latin1_General_CP1_CI_AS),m.definition AS Object_Name\n\tFROM @main_db.sys.sql_modules m \n\tINNER JOIN @main_db.sys.objects o \n\tON m.object_id=o.object_id\n\tWHERE m.definition Like '%'+@search+'%' AND o.type IN(SELECT * FROM string_split(@otype,','))\n\tORDER BY o.name\n--GROUP BY o.name\nOPEN @cursor;\nFETCH NEXT FROM @cursor INTO @name,@def\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tIF @button = 'Search'\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text @name,N'h4 text-muted'\n\t\t\t\tEXEC sp_api_modal_text @def,N'code',@highlight=@search\n\t\t\t\tRETURN\n\t\t\tEND\n\t\tELSE\n\t\t\tBEGIN\n\t\t\t\tSET @def = REPLACE(@def,@search,@replace)+IIF(@comment IS NULL,'',CHAR(10)+CHAR(13)+@comment)\n\t\t\t\tSET @def = REPLACE(@def,N'CREATE VIEW',N'ALTER VIEW')\n\t\t\t\t--SET @tmpsql = N'USE @main_db;'+CHAR(10)+CHAR(13)+@def\n\t\t\t\tEXEC sp_executesql N'USE @main_db;EXEC(@def);',N'@def nvarchar(max)',@def\n\t\t\t\t--EXEC(@tmpsql);\n\t\t\t\t--EXEC sp_api_modal_text @name,N'h4 text-danger'\n\t\t\t\t--EXEC sp_api_modal_text @tmpsql,N'code',@highlight=@replace\n\t\t\t\tSET @button = 'Search'\n\t\t\tEND\n\t\tFETCH NEXT FROM @cursor INTO @name,@def\n\tEND\nCLOSE @cursor;\nDEALLOCATE @cursor;\n",
            "action_id": 253,
            "action_name": "sys_views_search_and_replace",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-----Context CTH-----\n--SET CHECKED & MAP !\n---------------------\n--210422 SP MAP Aangepast, er worden geen regels met delayed geselecteerd om te mappen..\n\nDECLARE @cursor_ids CURSOR,@cid INT, @tekst NVARCHAR(100),@sqltask nvarchar(max)\nSET @cursor_ids = CURSOR LOCAL FAST_FORWARD FOR SELECT value FROM string_split(@ids,',')\nOPEN @cursor_ids;\nFETCH NEXT FROM @cursor_ids INTO @cid\nWHILE @@FETCH_STATUS = 0\n\tBEGIN\n\t\tSET @TEKST=CONCAT(N'Toewijzen order ',@cid)\n\t\tEXEC sp_api_toast @TEKST\n\t\t/*\n\t\t------------------single action---------------------------------------------------\n\t\texec @main_db.dbo.SP_CURSED_MAPPER_CTH @CTH_ID =@cid ,@MAPINKOOP =1,@MAPVERKOOP =1\n\t\t--zet tevens landfreight op checked\n\t\texec @main_db.dbo.SP_CURS_SetChecked_CTH @cid\n\t\t--@onlySameDay =1 --210324 VGI alleen dezelfde dag..\n\t\t--@sameDayOrOlder = 1 --210324 VGI alleen dezelfde dag of eerder..\n\t\t----------------------------------------------------------------------------------\n\t\t*/\n\t\tSET @sqltask = CONCAT(N'\n\t\texec @main_db.dbo.SP_CURSED_MAPPER_CTH @CTH_ID =',@cid,' ,@MAPINKOOP =1,@MAPVERKOOP =1, @sameDayOrOlder =1\n\t\texec @main_db.dbo.SP_CURS_SetChecked_CTH ',@cid)\n\t\tEXEC sp_api_add_sql_task @sql=@sqltask,@description=@TEKST --N'Verstuur facturen'\n\t\tFETCH NEXT FROM @cursor_ids INTO @cid\n\tEND\nCLOSE @cursor_ids;\nDEALLOCATE @cursor_ids;\n\n--wis als laatste alle markeringen\nEXEC sp_api_modal_select_all_clear \n\n\n\n\n",
            "action_id": 254,
            "action_name": "MAP_ALL",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_toggle_isam_search",
            "action_id": 255,
            "action_name": "sys_toggle_isam_search",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_view_performance @card_id",
            "action_id": 256,
            "action_name": "sys_view_performance",
            "source_table": "api_actions"
        },
        {
            "sql_source": "declare @j nvarchar(512)\nEXEC tracy_translate.dbo.translate N'Eet smakelijk',N'NL',N'FR',@J OUT\nexec sp_api_modal_alert @j",
            "action_id": 257,
            "action_name": "eet smakelijk",
            "source_table": "api_actions"
        },
        {
            "sql_source": "if @ID=@IDS execute @main_db.dbo.FlashxStock @ID -- alleen de geselecteerde regel\nif @ID<>@IDS execute @main_db.dbo.FlashxStock 0 -- alles",
            "action_id": 258,
            "action_name": "Flash_Stock",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_file_upload @card_name, @user_name, @path, @id, @name ,@mimetype ,@modified ,@filesize ,@description",
            "action_id": 262,
            "action_name": "sys_file_upload",
            "source_table": "api_actions"
        },
        {
            "sql_source": "SET @alert_text=CONCAT('Eerst dit, dan: ',@alert_text,@card_name)\nif @sub_Text is NULL Set @Sub_Text=N'TEST123'\nEXEC sp_api_modal_alert @alert_text,@sub_text\nEXEC sp_api_email @to='rick@tracy.nu',@subject=@sub_text,@body=@alert_text\n",
            "action_id": 263,
            "action_name": "#alert",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @menu_id nvarchar(max),@reducer nvarchar(max)\nEXEC sp_api_modal_text N'Quick menu',N'h1 font-weight-light text-primary'\nSET @reducer=N'in_main_menu = 1'\nEXEC sp_api_modal_select @card_name=N'menu',@value = @menu_id OUT,@focus=1,@placeholder=N'Zoek...',@no_isam=1\n\t,@modalRouteSql = N'''/'' + name'\n\t--,@reducer=@reducer\n\nIF @path='/' EXEC sp_api_modal_button @name='@button',@value='Home',@valueout=NULL,@class='btn-tracy',@key='Escape'\n\nIF @menu_id IS NULL RETURN\nEXEC sp_api_modal_clear\nSELECT @path = CONCAT('/',name) FROM api_card WHERE id = @menu_id\nEXEC sp_api_modal_pathname @path,NULL\n",
            "action_id": 264,
            "action_name": "#sys_quick_menu",
            "source_table": "api_actions"
        },
        {
            "sql_source": "declare @Mess nvarchar(200)\ndeclare @current nvarchar(50)\ndeclare @isOK bit\n\n\tbegin\n\t\t--verzet de fase als dat kan\n\t\texecute @main_db.dbo.Fase_Guard @ID=@ID ,@Fase= N'openPurchase',@StateOK=@isOK OUT,@Context =N'CTH' ,@CurrentFase=@Current OUT ,@Message=@Mess OUT\n\t\tif @isOK=1 execute sp_api_toast N'OKe'\n\t\tif @isOK =0 execute sp_api_toast @Mess\n\tend\n",
            "action_id": 265,
            "action_name": "reOpenCTH1",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_add_column @basetable,@card_id",
            "action_id": 266,
            "action_name": "sys_add_column",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_add_table",
            "action_id": 267,
            "action_name": "sys_add_table",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_file_download @card_name,@id,@file_id",
            "action_id": 268,
            "action_name": "sys_file_download",
            "source_table": "api_actions"
        },
        {
            "sql_source": "declare @json nvarchar(2048)\nexec sp_api_places_search @Search=N'abc 666 poeldijk',@json=@json OUT\nexec sp_api_modal_Alert @json",
            "action_id": 269,
            "action_name": "test adres",
            "source_table": "api_actions"
        },
        {
            "sql_source": "/*\n-- GENEREER EEN INKOOP EN KOSTENREGISTRATIE --\nselect * from lfctr_breakdown(11637,0)\n\n*/\nexec @main_db.dbo.create_demo_1 ",
            "action_id": 270,
            "action_name": "test_inkoop_en_kosten",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--\t-----------------------------------------------------------------------------\n--\tinstant_report: BREAKDOWN_CTH1\n--\ttoont een overzicht van de partijkosten en verkoopopbrengsten\n--\tpre declare: @buttonmore,@buttonmore2, @mt\n--\t-----------------------------------------------------------------------------\nEXEC sp_api_modal_modal @class=N'w100',@printStyle=N'font-size:70%',@landscape=1\n\ndeclare @CTHID int={[inkoop].id}\nif @CTHID is null set @CTHID={[verkoop].id}\n\nexec sp_api_toast N'kosten'\n\n--exec @main_db.dbo.create_demo_1 \nif @CTHID IS NULL\n\tbegin\n\t\texecute sp_api_modal_alert_new N'Breakdown heeft een Inkoop of verkoop nodig.'\n\t\treturn;-- afkappen\n\tend\n--210830 totalen bovenaan even tonen in EURO!\ndeclare @LFC float=--(\tselect sum(isnull(nullif(cost,0),0)*isnull(nullif(xrate,0),1)) from @main_db.dbo.xCostReg_ALL_CTH(@CTHID) where landfreight_id>0)\n\t\t\t\t\t(\tselect sum(eurbedrag) from @main_db.dbo.xCostReg_ALL_CTH(@CTHID) where landfreight_id>0)\nif @lfc is not null\n\tbegin\n\t\tdeclare @lfctext nvarchar(512)=concat('Totaal op Landfreight geboekt: ',@lfc)\t\n\t\texec sp_api_modal_text @lfctext\n\tend\n\ndeclare @CTHC float=(\tselect sum(isnull(nullif(cost,0),0)*isnull(nullif(xrate,0),1)) from xcostregistration where transaction_id=@CTHID) \nif @CTHC is not null\n\tbegin\n\t\tdeclare @CTHCtext nvarchar(512)=concat('Totaal op CTH geboekt: ',@cthc)\t\n\t\texec sp_api_modal_text @CTHCtext\n\tend\n\ndeclare @CTRC float=(\tselect sum(isnull(nullif(cost,0),0)*isnull(nullif(xrate,0),1)) from xcostregistration \nwhere ctr_id in (select id from xtransactiondetail where transactionheader_id=@CTHID) )\nif @CTRC is not null\n\tbegin\n\t\tdeclare @CTRCtext nvarchar(512)=concat('Totaal op CTR(s) geboekt: ',@ctrc)\t\n\t\texec sp_api_modal_text @CTRCtext\n\tend\n\t\n--SELECT --lfctr_ctr_part,C_Part_CTR_CTH,\nselect ctr_id,lfctr_colli as [lfctrColli@:2],rpCTH_Costs_P as [CTHP@:2],lfctr_Pal,cth_PCost as CTH_P,LFCTRcosts_C as [CTHC@:2]\n, CTH_CCost as CTH_C,ctr_dirkosten * lfctr_ctr_part as [CTRDIRECT@:2],LFP as [LFP@:2]\n--,P_Part_LFCTR_LF as lfctr_lf_deel@ -- LFCTR deel van de LF (optellen per LF moet 1 zijn)\n, CP_CostLF as LF_P, lfctr_ccc as colPrijs, Lfctr_CCPP ,lfctr_ColliKosten as colTot, [regeltotaal@:2]=lfctr_colli * lfctr_collikosten\n--, ctr_totalCosts_C\n--,isnull(cth_PCost,0)+ isnull(CTH_CCost,0) as CTH\n--,CTR_COL\n--,ctr_cth_Cost   \nINTO #BreakDown FROM @main_db.dbo.lfctr_breakdown(@CTHID,0)          \n\nexec sp_api_modal_print -- zet de print button boven (=BROWSER CTRL-P)\nset @mt=concat(N'Dit is de kostenverdeling van de geboekte kosten op partij ',{[inkoop].Lotnumber})\nexec sp_api_modal_text @mt , @class='h2', @PrintOnly=1\nEXEC sp_api_modal_table @tmptable=N'#BreakDown', @PRINT=1\n\n\n--MORE? PREDECLARE @buttonmore\nIF @buttonmore IS NULL\n\tBEGIN\n\t\tEXEC sp_api_modal_text N'',N'm-4'\n\t\tEXEC sp_api_modal_button @name='@buttonmore',@value = 'Meer info...', @valueout = @buttonmore OUT,@class='btn-tracy',@key='PageDown'\n\t\tRETURN\n\tEND\n\nselect costReg_ID,suppliercode,costdate, eurbedrag as [Eurobedrag@:2], [description] \n\t\t\t,invoicenumber,gl_number,dateinvoice --inv en gl er bij 211125RH\nINTO #CostReg FROM @main_db.dbo.xCostReg_ALL_CTH(@CTHID)          \nexec sp_api_modal_text N'Geregistreerde kosten:' , @class='h5', @Print=1\nEXEC sp_api_modal_table @tmptable=N'#costReg', @PRINT=1\n\nselect ctr_id, [aantal@]=sum(lfctr_col), [niet_ingedeeld@:2]=sum([0]), [agf@:2]=sum([1]), [rabat@:2]=sum([2]), [transport@:2]=sum([3]),\n\t\t\t\t\t\t[overig@:2]=sum([4]), [sum5@:2]=sum([5]) \n\tinto #piv1\tfrom piv_xcostregistration where cth_id=@CTHID group by ctr_id\nexec sp_api_modal_text N'Kosten kolommen:' , @class='h5', @Print=1\nEXEC sp_api_modal_table @tmptable=N'#piv1', @PRINT=1\n\n\n--MORE? PREDECLARE @buttonmore2 VERKOOP OPBRENGST ( ALLEEN BIJ INKOOPBREAKDOWN )\nIF @buttonmore2 IS NULL AND {[inkoop].id} is NOT NULL\n\tBEGIN\n\t\tEXEC sp_api_modal_text N'',N'm-4'\n\t\tEXEC sp_api_modal_button @name='@buttonmore2',@value = 'Toon de verkoopopbrengst', @valueout = @buttonmore OUT,@class='btn-tracy',@key='PageDown'\n\t\tRETURN\n\tEND\n\n--210901 Toon verkoop opbrengst en kosten voor partijuitmelding\n/*\nselect * from SalesResultCTH1(13237)\n*/\nselect lotrefrowid as [ctr1~col-sm-1-2],(select D from @main_db.dbo.ctr_description_prod(lotrefrowid)) as [prod*]\n\t,(select D from @main_db.dbo.ctr_description(lotrefrowid)) as [artikel], TV_CODE as Customer,cth2 as [order~col-sm-1-2],\tctr_id as [ctr2~col-sm-1-2]\n\t,\tLFDate as [Date~col-sm-1],\tcolli_gefactureerd as [Colli@~col-sm-1-2],\tgemiddeld as [SalesCol:2~col-sm-1-2],\tomzet as [NetSales@:2~col-sm-1]\n\t,\tbookedcosts as [SalesCosts@:2~col-sm-1]\n\t, bookedcosts/nullif(colli_gefactureerd,0) as [CostCol:2~col-sm-1-2]\n\t,isnull(gemiddeld,0)-isnull(bookedcosts/nullif(colli_gefactureerd,0),0) as [NETT_COL:2]\nINTO #SalesRes FROM @main_db.dbo.[RowResultEUR_CTH1_perCTR2](@CTHID) --order by lotrefrowid\nexec sp_api_modal_text N'Geregistreerde verkoop opbrengsten:' , @class='h5', @Print=1\nEXEC sp_api_modal_table @tmptable=N'#SalesRes', @PRINT=1,@orderby='ORDER BY 1'-- maak alles het printbaar \n--@PRINTONLY=1 (hidden op scherm, maar wel op printer)--,@orderby=N'ORDER BY [wawa*],lalaDescription ASC'\n\n-- PARTIJ-RESULTAAT\nselect CTR1_ID,\tleverancier,\tklant,CTH2_ID,\tCTR2_ID, Orderdatum,\t\n\t\tAantal as [Aantal@]\n\t\t,-1 * I_PRIJS as [I_PRIJS@:2],\t-1 * (I_RABAT+\tI_TRANSP+\tI_OVERIG) as [I_KOST@:2]\n\t\t,-1 * V_PRIJS as [V_PRIJS@:2],\t-1 * V_RABAT as [V_RABAT@:2],\t-1* V_TRANSP as [V_TRANSP@:2],\t-1 * V_OVERIG as [V_OVERIG@:2]--\tV_AMT_CTR\tI_AMT_CTR\n\t\t, rowresult as [Resultaat@:2]\n\tinto #ivresult\n\tFROM @main_db.dbo.[IV_RESULT] where CTH1_ID =@CTHID\nexec sp_api_modal_text N'Partij resultaatregels :' , @class='h5', @Print=1\nEXEC sp_api_modal_table @tmptable=N'#ivresult', @PRINT=1\n\n\n",
            "action_id": 271,
            "action_name": "ctr_breakdown",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_alert N'Lock Layouts, prevent master update',N'This will lock all list, form en handler layouts (list_order/detail_order/handler_order) from all cards. Unlocking per card can be done in \"Model differences\"'\nEXEC sp_sys_card_lock_layouts",
            "action_id": 272,
            "action_name": "sys_card_lock_layouts",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @rawdata varbinary(max) = (SELECT * FROM OPENROWSET(BULK 'C:\\Windows\\explorer.exe', SINGLE_BLOB) as f)\n\t\tEXEC sp_api_modal_download @rawdata=@rawdata,@filename=N'abc.zip'",
            "action_id": 273,
            "action_name": "file_from_host",
            "source_table": "api_actions"
        },
        {
            "sql_source": "----------------------------------------------------------------------------\n--\tfunction: \t\tir_transit\n--\tdescription:\ttoon het actuele douanesaldo en zorg dat dit geprint kan worden\n--\tpre declare:\t@Mailbutton\n----------------------------------------------------------------------------\nexec sp_api_modal_text N'Actueel douanesaldo'\nselect *  INTO #IR_TransitoVoorraad from @main_db.dbo.DouaneSaldo_ctr1(0,0) \nEXEC sp_api_modal_table @tmptable=N'#IR_TransitoVoorraad' ,@print=1\n\n--mailen??\nEXEC sp_api_modal_button @name='@mailbutton',@value = 'Mail', @valueout = @Mailbutton OUT,@class='btn-warning',@key='M'\nif @Mailbutton='Mail'\nbegin\n\n\tDECLARE @subject nvarchar(255) = N'Tracy actual Transito stock'\n\tDECLARE @body nvarchar(max),@html nvarchar(max),@list_select nvarchar(max),@list_select_cache nvarchar(max)\n\tSELECT @list_select_cache = list_select_cache FROM api_card WHERE id = @card_id\n\tSET @list_select=N'\n\t\tSELECT * INTO #tmptable FROM @main_db.dbo.DouaneSaldo_ctr1(0,0) tbl\n\t\tEXEC sp_api_html_table N''#tmptable'',N''ORDER BY 2'',@html OUT'\n\tEXEC sp_executesql @list_select,N'@html nvarchar(max) OUT',@html OUT\n\n\n\t--wrap er een table omheen: / *\n\tSET @html = N'<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n\t<html xmlns=\"http://www.w3.org/1999/xhtml\">\n\t <head>\n\t  <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" />\n\t  <title>Demystifying Email Design</title>\n\t  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"/>\n\t</head><body style=\"margin: 0; padding: 0;\">\n\t <table border=\"3\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\n\t  <tr>\n\t   <td><h3>Export</h3>'+ @html +N'</td>\n\t  </tr>\n\t </table>\n\t</body></html>'\n\t--* /\n\n\tEXEC sp_api_email @user,@subject,@body = N'Geen html support',@html = @html -- html in @HTML !\n\tEXEC sp_api_toast N'Sent mail to:'\n\tEXEC sp_api_toast @user\n\texec sp_api_modal_clear-- afkappen na mailen..\n\nend",
            "action_id": 274,
            "action_name": "IR_Transit",
            "source_table": "api_actions"
        },
        {
            "sql_source": "declare @main_text nvarchar(512) = concat(N'You''re at ', @hostname, ' ', '@main_db')\nexec sp_api_modal_alert_new @main_text",
            "action_id": 275,
            "action_name": "main_db",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_parent_cards @card_id",
            "action_id": 276,
            "action_name": "sys_parent_cards",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_convert_to_type_table @card_id",
            "action_id": 277,
            "action_name": "sys_convert_to_type_table",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_edit_attributes @card_id",
            "action_id": 278,
            "action_name": "sys_edit_attributes",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_list_classes @card_id = @card_id , @is_form = @is_form",
            "action_id": 279,
            "action_name": "sys_list_classes",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_insert_todo @card_name,@user_name",
            "action_id": 280,
            "action_name": "sys_insert_todo",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_import_action @card_id",
            "action_id": 283,
            "action_name": "sys_import_action",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--je zit hier op een lfctr out\ndeclare @LFCTR_OUT int\nset @LFCTR_OUT={[v_lfctr_out].id}\t\t--normale uitslag\nif @LFCTR_OUT is NULL\n\tset @LFCTR_OUT={[v_lfctr_in].id} \t-- misschien type RELOC..\nif @LFCTR_OUT is NULL\n\tbegin\n\t\texec sp_api_modal_clear N'Er is geen geschikte vrachtregel (LFCTR) gevonden.' ,N'Actie wordt afgebroken'\n\t\treturn; -- hier kom je niet eens volgens mij\n\tend\t\n\t\ndeclare @IMPDOC int, @Log int\nselect @log=id, @Impdoc=declared_sales_doc_id from xCustomsLog where declared_sales_doc_id IS NOT NULL and lfctr_out=@LFCTR_OUT\ndelete from xcustomsLog where id=@log\ndelete from sf_femimp where id=@impdoc\n\nselect @log=id, @Impdoc=transit_sales_doc_id from xCustomsLog where transit_sales_doc_id IS NOT NULL and lfctr_out=@LFCTR_OUT\ndelete from xcustomsLog where id=@log\ndelete from sf_femtra where id=@impdoc\n\n/* => het is beter om alleen via de mutaties te verwijderen en het log automatisch bij te werken. Er kan een missend xCustomslog recvord worden toegevoegd via PROC: fix_sf_Femimp_xCustomslog etc.\n--210731 niet gekoppelde femtra records verwijderen\ndelete from sf_femtra where not exists(select * from xCustomsLog where transit_sales_doc_id =sf_femtra.id )\ndelete from sf_femimp where not exists(select * from xCustomsLog where declared_sales_doc_id =sf_femimp.id or declared_stock_doc_id =sf_femimp.id)\n*/",
            "action_id": 284,
            "action_name": "verwijder_uitslag",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_switch_role",
            "action_id": 285,
            "action_name": "sys_switch_role",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@buttoncsv nvarchar(128),@from nvarchar(128),@to nvarchar(128)\nset @date = dbo.workDate()\nEXEC sp_api_modal_modal @class = 'w100'\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n--EXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\n--EXEC sp_api_modal_button @name='button',@value = 'Omzet Per Artikel',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print\n\nEXEC sp_api_modal_action N'report_menu',@keycode='Escape'\n\nSET @button = 'Stock Per Lot'\nIF @button =  'Stock Per Lot'\nBEGIN\nEXEC sp_api_modal_button @name='@button',@value = 'Download CSV', @valueout = @buttoncsv OUT,@class='btn btn-success',@key='4'\n\tSELECT \n\t\tffa_code as [ffa**]\n\t\t,client_code as [client_code]\n\t--\tvendor_code as Klant\n\t\t,\tcontainer_number\n\t\t,\tforecast as [forecast@T]\n\t\t,\tin_warehouse as [stock@T]\n\t\t,\tbusy as [busy@T]\n\t\t,\tgone as [out@T]\n\tinto #SPL\n\tFROM @main_db.dbo.piv_pallet_state where in_warehouse is not null or busy is not null\n\n\t\n\tEXEC sp_api_modal_table @tmptable=N'#SPL',@orderby=N'ORDER BY [ffa**],client_code ASC',@print=1\n\tIF @buttoncsv =  'Download CSV'\n\t\tBEGIN\n\t\t\tDECLARE @filename nvarchar(128) = dbo.strdate(NULL) +'_'+ 'Stock_Per_Lot.csv'\n\t\t\tEXEC sp_api_modal_csv @tmptable=N'#SPL',@filename= @filename,@ansi=1\n\t\tEND\nEND \n",
            "action_id": 291,
            "action_name": "Stock Per Lot",
            "source_table": "api_actions"
        },
        {
            "sql_source": "exec sp_api_toast N'report_menu...'\n\nif dbo.hasrole('admin')>0\nbegin\n\texec sp_api_modal_action N'Stock Per Lot'\n\tEXEC sp_api_modal_action N'Stock Per Item'\n\tEXEC sp_api_modal_action N'Ouderdomsanalyse'\n\texec sp_api_modal_action N'rep_rv_stock_container_bonded_YN'\nend\t\n\nif dbo.hasrole('admin,directie')>0 --231117 ivm douane\nbegin\n\texec sp_api_modal_action N'rep_rv_stock_container_bonded_YN'\nend\t\n\n\n---------------------------------------------------------------------\n--\tA G N E O V O\n---------------------------------------------------------------------\n\nif @user=N'agneovo-bv-logistic@agneovo.com' or @user=N'agneovo@tracy.nu' or dbo.hasrole('admin')>0\n\tbegin\n\t\tEXEC sp_api_modal_action N'micro_outbound_rapportage'\n\tend\n\n--------------------------------------------------------------------\n-- B A R  S A N\n--------------------------------------------------------------------\t\nif dbo.hasrole('barsan_bo,directie') > 0\nBEGIN\n\tEXEC sp_api_modal_action N'stock_via_pallet_status'\nEND\n\n",
            "action_id": 300,
            "action_name": "report_menu",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@buttoncsv nvarchar(128),@from nvarchar(128),@to nvarchar(128)\nset @date = dbo.workDate()\nEXEC sp_api_modal_modal @class = 'w100'\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n--EXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\n--EXEC sp_api_modal_button @name='button',@value = 'Omzet Per Artikel',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print\nEXEC sp_api_modal_action N'report_menu',@keycode='Escape'\nSET @button = 'Omzet Per Klant'\nIF @button =  'Omzet Per Klant'\nBEGIN\nEXEC sp_api_modal_button @name='@button',@value = 'Download CSV', @valueout = @buttoncsv OUT,@class='btn btn-success',@key='4'\n\tSELECT \n\t  [Country*] = [Country]\n\t  ,[Naam Debiteur~col-sm-1] = [Naam Debiteur]\n\t  ,[Aantal@] = [Aantal]\n      ,[Bedrag Eur@:2] = [Bedrag Eur v2]\n      ,[Rabat@:2] = [Rabat]\n      ,[Transp@:2] = [Transp]\n      ,[Korting@:2] = [Korting]\n      ,[Reservering P@:2] = [Reservering P]\n      /*\n      ,[Rabat Bedrag P]\n      ,[Rabat Colli]\n      ,[Korting Bedrag P]\n      ,[Korting Colli]\n      ,[Reservering P]\n      */\n      ,[Kredietlim]\n      \n\tINTO #OMZET_PER_KLANT_ANACO\n\tFROM [RV_OMZET_PER_KLANT_ANACO]\n\tEXEC sp_api_modal_table @tmptable=N'#OMZET_PER_KLANT_ANACO',@orderby=N'ORDER BY [Country*] ASC',@print=1,@fontsize = '85%'\n\tIF @buttoncsv =  'Download CSV'\n\t\tBEGIN\n\t\t\tDECLARE @filename nvarchar(128) = dbo.strdate(NULL) +'_'+ 'Omzet_Per_Klant.csv'\n\t\t\tEXEC sp_api_modal_csv @tmptable=N'#OMZET_PER_KLANT_ANACO',@filename= @filename,@ansi=1\n\t\tEND\nEND \n",
            "action_id": 310,
            "action_name": "Omzet Per Klant",
            "source_table": "api_actions"
        },
        {
            "sql_source": "\nEXEC sp_api_modal_text @text,N'h2' \nEXEC sp_api_modal_text @text,N'h2' \n\ndsfasdffdg \n",
            "action_id": 311,
            "action_name": "#h2",
            "source_table": "api_actions"
        },
        {
            "sql_source": "exec sp_api_modal_alert N'Dit is alert. Met enter gaan we even verder, maar met Escape ga je naar containers' ,@escape_path = N'/xcontainer'\nexec sp_api_modal_text N'nu zijn we verder...'\nEXEC sp_api_modal_choose @list = N'Predefined,Custom',@value = @button_choose OUT,@startkey=3\n",
            "action_id": 312,
            "action_name": "example_alert",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128),@commissieuser nvarchar(128)\nset @date = dbo.workDate()\nEXEC sp_api_modal_modal @class = 'w100'\nEXEC sp_api_modal_action N'report_menu',@keycode='Escape'\nEXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n--EXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\n--EXEC sp_api_modal_button @name='button',@value = 'Omzet Per Artikel',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_button @name='button',@value='Commissie per Klant',@valueout = @button OUT,@key='Enter'\n\nEXEC sp_api_modal_print\n\n\n\n\nIF @button = 'Commissie per Klant'\n BEGIN\n\t\t SELECT DISTINCT [id] = CTH.insUser,[NAME] = CTH.insUser\n\t\tINTO #Commissie_Users\n\t\tFROM Q_xTransactionDetail ctr\n\t\tLEFT JOIN Q_xTransactionHeader cth ON ctr.TransactionHeader_ID = cth.id\n\t\tWHERE \n\t\tCTH.TDT = 2 AND (CTH.transactiondate between @from and @to) AND ((CTR.Pricetype = 'Indication' OR CTR.Price IS NULL OR CTR.Price = 0) OR CTH.status = 'openPrice')\n\t\tAND EXISTS (SELECT * FROM Q_xTransactionHeader WHERE TDT = 2 AND [status] = 'openPrice' AND Repack_ID IS NULL AND specialType IS NULL\n\t\tAND id = CTH.id)\n\t\t\n\tEXEC sp_api_modal_text N'Zoek een gebruiker:','text-primary mb-1 h4'\n\tEXEC sp_api_modal_select_table @tmptable = N'#Commissie_Users',@name='@user',@value = @commissieuser OUT,@placeholder = N'Kies een gebruiker'\n END\n\n--SET @button = 'Commissie per Klant'\n\nIF @commissieuser is not null AND @button = 'Commissie per Klant'\nBEGIN\nSELECT \n* \nINTO #Commissie_Orders_Per_Klant\nFROM\n(\nSELECT \n\t[Verkoper*] = CTH.insUser\n\t,[KLANT*] = CTH.TV_CompanyName\n\t,[Ordernr] = CTH.id\n\t,[Datum] = FORMAT(CTH.TransactionDate,'dd-MM-yy')\n\t,[Partij] = (select STRING_AGG(iv.Lotnumber,'...') from Q_IVLINK iv where ITD=ctr.id)\n\t,[Produkt~col-sm-2] = CTR.detail\n\t,[Soort] = CTR.xBrandCode\n\t,[Maat] = CTR.Size\n\t,[Aantal] = Ctr.Amount\n\t,[Val~col-sm-1] = ctr.currencyISO\n\t,[RichtPrijs] = isnull(CTR.Price,0)\n\t,[T/V] = ctr.TV_I\nFROM Q_xTransactionDetail ctr\n\tLEFT JOIN Q_xTransactionHeader cth ON ctr.TransactionHeader_ID = cth.id\nWHERE \nCTH.TDT = 2 AND (CTH.transactiondate between @from and @to) AND ((CTR.Pricetype = 'Indication' OR CTR.Price IS NULL OR CTR.Price = 0) /*OR CTH.status = 'openPrice'*/)\nAND EXISTS (SELECT * FROM Q_xTransactionHeader WHERE TDT = 2 AND [status] = 'openPrice' AND Repack_ID IS NULL AND specialType IS NULL\nAND id = CTH.id)\nAND CTH.insUser = @commissieuser\n\nUNION ALL\n\nSELECT \n\t[Verkoper*] = CTH.insUser\n\t,[KLANT*] = CTH.TV_CompanyName\n\t,[Ordernr] = CTH.id\n\t,[Datum] = FORMAT(CTH.TransactionDate,'dd-MM-yy')\n\t,[Partij] = ''\n\t,[Produkt~col-sm-2] = ''\n\t,[Soort] = ''\n\t,[Maat] = ''\n\t,[Aantal] = NULL\n\t,[Val~col-sm-1] = ''\n\t,[RichtPrijs] = NULL\n\t,[T/V] = ''\nFROM Q_xTransactionHeader cth\n\tLEFT JOIN Q_xTransactionDetail ctr ON ctr.TransactionHeader_ID = cth.id\nWHERE \nCTH.TDT = 2 AND (CTH.transactiondate between @from and @to) \nAND EXISTS (SELECT * FROM Q_xTransactionHeader WHERE TDT = 2 AND [status] = 'openPrice' AND Repack_ID IS NULL AND specialType IS NULL\nAND id = CTH.id)\nAND CTH.insUser = @commissieuser\nGROUP BY CTH.id,CTH.insUser,CTH.TV_CompanyName,CTH.TransactionDate\nHAVING (SELECT COUNT(id) FROM xtransactiondetail where TransactionHeader_ID = cth.id and Pricetype = 'Indication' ) = 0\nAND (SELECT COUNT(id) FROM xtransactiondetail where TransactionHeader_ID = cth.id and price = 0  ) = 0\nAND (SELECT COUNT(id) FROM xtransactiondetail where TransactionHeader_ID = cth.id and price  IS NULL ) = 0\n) tbl\n\tEXEC sp_api_modal_table @tmptable=N'#Commissie_Orders_Per_Klant',@orderby=N'ORDER BY 2 ASC',@print=1\nEND \n",
            "action_id": 318,
            "action_name": "Commissie Orders Per Klant",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_field_info @card_field_id",
            "action_id": 319,
            "action_name": "sys_field_info",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--ACTION: Zet de printstatus van de orderbevestiging 1 stap terug (van 1 (geprint) naar 0 ongeprint ; van 7x geprint naar 6x geprint)\n--NAME: Undo_Last_Orderconfirmation\nexec @main_db.dbo.Orderconfirmation_Undo_Last @CTH2_ID =@ID",
            "action_id": 320,
            "action_name": "Undo_Last_Orderconfirmation",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--ACTION: Zet de printstatus van de picklist 1 stap terug (van 1 (geprint) naar 0 ongeprint ; van 7x geprint naar 6x geprint)\n--NAME: Undo_Last_Picklist\nexec @main_db.dbo.Picklist_Undo_Last @CTH2_ID =@ID\n--de printstatus van de bon is 1 stap terug gezet",
            "action_id": 321,
            "action_name": "Undo_Last_Picklist",
            "source_table": "api_actions"
        },
        {
            "sql_source": "update xlandfreight set i_selected=0, i_away=0 where id={[xlandfreight].id}",
            "action_id": 322,
            "action_name": "ReOpen LF",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--\t-----------------------------------------------------------------------------------------------------------\n--\t211110RH\n--\tGLOBAL ACTION: CTH_Change_Currency\n--\tVerander de valuta van de Inkoop of Verkoop inclusief de eventueel geboekte kostenregels op artikelniveau\n--\t-----------------------------------------------------------------------------------------------------------\nDECLARE @oldCurr_id int = {[inkoop].Currency_id}\nDECLARE @CTH_ID int = {[inkoop].id}\nif @oldCurr_id is NULL SET @oldCurr_id = {[verkoop].Currency_id}\nif @CTH_ID is NULL SET @CTH_ID = {[verkoop].id}\n\nDECLARE @id_value int\nSELECT id=id, Name=codeISO INTO #modaltable FROM xCurrency\nEXEC sp_api_modal_select_table @value = @id_value OUT --,@tmptable=N'#tmptable'\n\nif @oldCurr_id is NULL \n\tbegin\n\t\texec sp_api_toast N'old curr err'\n\t\tRETURN \n\tend\t\nif @CTH_ID is NULL \n\tbegin\n\t\texec sp_api_toast N'cth err'\n\t\tRETURN \n\tend\t\n\nif @oldCurr_id <> @id_value AND @id_value is not NULL\n\tbegin\n\t\t-- bouw de boel om\n\t\t--update xtransactionheader set currency_id=@id_value where id =@CTH_ID\n\t\texec @main_db.dbo.CTH_Change_Currency @CTH_ID=@CTH_ID ,@Currency_ID=@id_value\n\t\texec sp_api_modal_clear\n\tend\n\t\n",
            "action_id": 323,
            "action_name": "CTH_Change_Currency",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--instant_report: Breakdown_CTH2\n--pre declare: @buttonmore, @mt, @m2, @m3, @m4\nEXEC sp_api_modal_modal @class=N'w100',@printStyle=N'font-size:70%',@landscape=1\n\ndeclare @CTHID int={[inkoop].id}\nif @CTHID is null set @CTHID={[verkoop].id}\n\nexec sp_api_toast N'kosten'\n\n--exec @main_db.dbo.create_demo_1 \nif @CTHID IS NULL\n\tbegin\n\t\texecute sp_api_modal_alert_new N'Breakdown heeft een Inkoop of verkoop nodig.'\n\t\treturn;-- afkappen\n\tend\n--210830 totalen bovenaan even tonen in EURO!\ndeclare @LFC float=--(\tselect sum(isnull(nullif(cost,0),0)*isnull(nullif(xrate,0),1)) from @main_db.dbo.xCostReg_ALL_CTH(@CTHID) where landfreight_id>0)\n\t\t\t\t\t(\tselect sum(eurbedrag) from @main_db.dbo.xCostReg_ALL_CTH(@CTHID) where landfreight_id>0)\nif @lfc is not null\n\tbegin\n\t\tdeclare @lfctext nvarchar(512)=concat('Totaal op Landfreight geboekt: ',@lfc)\t\n\t\texec sp_api_modal_text @lfctext\n\tend\n\ndeclare @CTHC float=(\tselect sum(isnull(nullif(cost,0),0)*isnull(nullif(xrate,0),1)) from xcostregistration where transaction_id=@CTHID) \nif @CTHC is not null\n\tbegin\n\t\tdeclare @CTHCtext nvarchar(512)=concat('Totaal op CTH geboekt: ',@cthc)\t\n\t\texec sp_api_modal_text @CTHCtext\n\tend\n\ndeclare @CTRC float=(\tselect sum(isnull(nullif(cost,0),0)*isnull(nullif(xrate,0),1)) \n\t\t\t\t\t\tfrom xcostregistration \n\t\t\t\t\t\twhere ctr_id in (select id from xtransactiondetail where transactionheader_id=@CTHID) )\nif @CTRC is not null\n\tbegin\n\t\tdeclare @CTRCtext nvarchar(512)=concat('Totaal op CTR(s) geboekt: ',@ctrc)\t\n\t\texec sp_api_modal_text @CTRCtext\n\tend\n\t\n--SELECT --lfctr_ctr_part,C_Part_CTR_CTH,\nselect ctr_id,rpCTH_Costs_P as [CTHP@:2],cth_PCost as CTH_P,LFCTRcosts_C as [CTHC@:2], CTH_CCost as CTH_C,ctr_dirkosten * lfctr_ctr_part as [CTRDIRECT@:2],LFP as [LFP@:2]\n, CP_CostLF as LF_P,lfctr_colli, lfctr_ccc as colPrijs, Lfctr_CCPP ,lfctr_ColliKosten as colTot, [regeltotaal@:2]=lfctr_colli * lfctr_collikosten\n--, ctr_totalCosts_C\n--,isnull(cth_PCost,0)+ isnull(CTH_CCost,0) as CTH\n--,CTR_COL\n--,ctr_cth_Cost   \nINTO #BreakDown FROM @main_db.dbo.lfctr_breakdown(@CTHID,0)          \n\nexec sp_api_modal_print -- zet de print button boven (=BROWSER CTRL-P)\nset @mt=concat(N'Dit is de kostenverdeling van CTH ',@CTHID,' (',{[inkoop].Lotnumber},')')\nexec sp_api_modal_text @mt , @class='h2', @PrintOnly=1\nEXEC sp_api_modal_table @tmptable=N'#BreakDown', @PRINT=1\n\n--MORE? PREDECLARE @buttonmore\nIF @buttonmore IS NULL\n\tBEGIN\n\t\tEXEC sp_api_modal_text N'',N'm-4'\n\t\tEXEC sp_api_modal_button @name='@buttonmore',@value = 'Meer info...', @valueout = @buttonmore OUT,@class='btn-tracy',@key='PageDown'\n\t\tRETURN\n\tEND\n\nset @m2=concat(N'Alle kostenregistraties van CTH ',@CTHID) --verkoop\nexec sp_api_modal_text @m2 , @class='h2', @PrintOnly=1\nselect costReg_ID,suppliercode,costdate, eurbedrag as [eurobedrag@:2], [description] \nINTO #CostReg FROM @main_db.dbo.xCostReg_ALL_CTH(@CTHID)          \nEXEC sp_api_modal_table @tmptable=N'#costReg', @PRINT=1-- maak alles het printbaar --@PRINTONLY=1 (hidden op scherm, maar wel op printer)\n--,@orderby=N'ORDER BY [wawa*],lalaDescription ASC'\n\n\n--211020 finmut er bij gehaald\nexec sp_api_modal_text N'Financiele mutaties:' , @class='h5'--, @PrintOnly=1\nset @m3=N'Financiele mutaties op basis van company cost settings'\nexec sp_api_modal_text @m3 , @class='h2', @PrintOnly=1\n\nSELECT * INTO #tt_verkoop from @main_db.dbo.Calc_Finrows_Summed_CTH_IV where cth_id=@CTHID and ([ExBedrag@:2] <>0 or Fin_Group=N'BASIS')\nEXEC sp_api_modal_table @tmptable=N'#tt_verkoop',@print=1,@lang_context=N'IR_tt_verkoop'\n\n--211021 netto verkoop opbrengst per colli\n\nset @m4=N'Netto opbrengst per regel:'\nexec sp_api_modal_text @m4 , @class='h2', @PrintOnly=1\n\nselect  ctr_id,\tomzet,\tcolli_gefactureerd,\tFactuurwaarde,\tNetto_omzet,\tNetto_waarde INTO #tt_nettores from @main_db.dbo.RowResultEUR_CTH2(@CTHID)\nEXEC sp_api_modal_table @tmptable=N'#tt_nettores',@print=1,@lang_context=N'IR_tt_nettores'\n",
            "action_id": 324,
            "action_name": "ctr_breakdown_cth2",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-------------------------------------------------------------------------------------------\n--\tfunction: \t\tIR_Douaneplot\n--\tdescription:\tmail de gemiddelde waarde van de gefactureerde vrij verkochte goederen\n--\tpre declare:\t@Mailbutton\n--\tLET OP: ALLEEN GEFACTUREERDE OMZET\n-------------------------------------------------------------------------------------------\n--EXEC sp_api_modal_modal N'bg-white'\nexec sp_api_modal_text N'Anaco & Greeve International BV', @class='h2', @Print=1\nexec sp_api_modal_text N'Douane overzicht vrije goederen (waarde in Euro)', @class='h2' , @Print=1\n\nSET @from = DATEADD(day, -1, dbo.workDate())\nSET @to=@from\nEXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\nSET @datumrange = concat(N'Douaneoverzicht vrije goederen van ',@from, ' t/m ', @to)\nEXEC sp_api_modal_button @name='button',@value = 'Douanewaarde',@valueout = @button OUT,@class = 'btn-primary',@key = 'Enter'\n\nIF @button =  'Douanewaarde'\n\tBEGIN\n\n\n--\t\tdeclare @T1 nvarchar(128)=concat(N'Factuurdatum ',(select @main_db.dbo.datumstring(getdate()-30,0)))\n\t\texec sp_api_modal_text @datumrange, @Print=1, @class='h2'\n\t\tselect Douane_Groep,\tOorsprong,\tNetto_Gewicht,\tAantal,\tTotaal_Gewicht,\tGem_Prijs_EUR,\teasy as Artikelomschrijving\n\t\t\tINTO #IR_Douaneplot\n\t\t from @main_db.dbo.IR_Douaneplot\n\t\t\t--select * from Netto_Salesprice_Per_StockID_and_InvoiceDate_customs\n\t\t\twhere dateinvoice between @from and @to\n\t\t\t--=(select @main_db.dbo.cleandate(getdate()-30)) --'2021-11-24'\n\n\t\tEXEC sp_api_modal_table @tmptable=N'#IR_Douaneplot' ,@print=1\n\n\t\t--mailen??\n\t\tEXEC sp_api_modal_button @name='@mailbutton',@value = 'Mail', @valueout = @Mailbutton OUT,@class='btn-warning',@key='M'\n\t\tif @Mailbutton='Mail'\n\t\tbegin\n\n\t\t\tDECLARE @subject nvarchar(255) = @datumrange\n\t\t\tDECLARE @body nvarchar(max),@html nvarchar(max),@list_select nvarchar(max),@list_select_cache nvarchar(max)\n\t\t\tSELECT @list_select_cache = list_select_cache FROM api_card WHERE id = @card_id\n\t\t\tSET @list_select=concat(N'\n\t\t\t\t\t\tSELECT * INTO #tmptable FROM @main_db.dbo.IR_Douaneplot '--where dateinvoice=(select @main_db.dbo.cleandate(getdate()-30))\n\t\t\t\t\t\t,N' where dateinvoice between ''',@from,N''' AND ''',@to, N''' '\n\t\t\t\t\t\t,'\n\t\t\t\t\t\tEXEC sp_api_html_table N''#tmptable'',N''ORDER BY 2'',@html OUT'\n\t\t\t\t\t)\n\t\t\tEXEC sp_executesql @list_select,N'@html nvarchar(max) OUT',@html OUT\n\n\n\t\t\t--wrap er een table omheen: / *\n\t\t\tSET @html = N'<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n\t\t\t<html xmlns=\"http://www.w3.org/1999/xhtml\">\n\t\t\t <head>\n\t\t\t  <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" />\n\t\t\t  <title>Demystifying Email Design</title>\n\t\t\t  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"/>\n\t\t\t</head><body style=\"margin: 0; padding: 0;\">\n\t\t\t <table border=\"3\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\n\t\t\t  <tr>\n\t\t\t   <td><h3>Export</h3>'+ @html +N'</td>\n\t\t\t  </tr>\n\t\t\t </table>\n\t\t\t</body></html>'\n\t\t\t--* /\n\n\t\t\tEXEC sp_api_email @user,@subject,@body = N'Geen html support',@html = @html -- html in @HTML !\n\t\t\tEXEC sp_api_toast N'Sent mail to:'\n\t\t\tEXEC sp_api_toast @user\n\t\t\texec sp_api_modal_clear-- afkappen na mailen..\n\n\t\tend\n\tEND",
            "action_id": 333,
            "action_name": "Douanewaarde (gefactureerd)",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_switch_role_setter",
            "action_id": 334,
            "action_name": "sys_switch_role_setter",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @company_id nvarchar(32),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000), @location_id nvarchar(32), @reducer nvarchar(max), @date nvarchar(128), @opmerking nvarchar(128), @opmerkingrelation nvarchar(128)\n,@transactiondate nvarchar(128)\n,@button nvarchar(128)\n,@button1 nvarchar(128) = N'Nieuwe verkoop'\n,@button2 nvarchar(128) = N'Laatste open verkoop'\n,@button3 nvarchar(128) = N'Gereserveerde verkoop'\n,@button4 nvarchar(128) = N'Naar lokaties'\n,@button5 nvarchar(128) = N'Eigen lokaties'\n,@button6 nvarchar(128) = N'Werk lokaties'\n,@buttonescape nvarchar(128) = N'Ga terug'\n,@buttongoahead nvarchar(128) = N'Ga door'\nset @date = dbo.workDate()\nSET @transactiondate = dbo.abcdate()\n\nIF dbo.workDate() <> dbo.abcdate() AND @button IS NULL\n\tBEGIN\n\tEXEC sp_api_modal_modal @class = 'bg-primary-25'\n\tEXEC sp_api_modal_text 'LET OP! DE WERKDATUM STAAT NIET OP VANDAAG.','text-danger font-weight-bold'\n\tEXEC sp_api_modal_button @name='@button',@value=@buttongoahead,@valueout = @button OUT,@key='Pagedown',@class='bg-danger text-light'\n\tEXEC sp_api_modal_button @name='@button',@value=@buttonescape,@valueout = @button OUT,@key='ESCAPE',@class='bg-danger text-light'\n\t\tIF @button = @buttonescape\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_clear\n\t\tEND\n\tEND\n\t\nIF @button = @buttongoahead OR dbo.workdate() = dbo.abcdate()\n\tBEGIN\n\tEXEC sp_api_modal_clear\n\tEXEC sp_api_modal_modal @class = 'bg-primary-25'\n\tEXEC sp_api_modal_text 'Nieuwe Verkoop inzetten.','text-primary'\n\tEXEC sp_api_modal_text 'Kies een klant:','text-primary'\n\t--SET @reducer = CONCAT('company_id = ',@company_id)\n\tSET @reducer = 'isDisabled = 0'\n\tEXEC sp_api_modal_select @card_name = N'klant',@value = @company_id OUT,@reducer = @reducer,@focus = 1\n\tEND\n\t\nIF @company_id > 0 \n\nBEGIN\n\t--DECLARE @only_new_is_possible BIT = 0\n\tDECLARE @reducer_location nvarchar(max) = N'Company_ID = ' + @company_id + ' OR id IN (SELECT Location_ID FROM xCompanyxLocation WHERE Company_ID =' + @company_id + ')'\n--\tDECLARE @reducer_location nvarchar(max) = N'id IN (SELECT Location_ID FROM xCompanyxLocation WHERE Company_ID =' + @company_id + ')'\n\tIF (SELECT LOCATIONS = count(Location_ID) FROM xCompanyxLocation WHERE Company_ID = @company_id) > 1\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_text 'Vertrek Datum:','text-primary'\n\t\t\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3',@focus=1\n\t\t\tEXEC sp_api_modal_input @name='Logistic',@value = @opmerking OUT,@placeholder = N'Opmerking voor loods'\n\t\t\tEXEC sp_api_modal_input @name='Relation',@value = @opmerkingrelation OUT,@placeholder = N'Referentie voor klant'\n\t\t\tEXEC sp_api_modal_text 'Kies een sublocatie van klant:','text-primary'\n\t\t\tEXEC sp_api_modal_select @card_name = N'xlocation',@value = @location_id OUT,@reducer = @reducer_location\n\t\t\t/*\n\t\t\t\tIF @location_id > 0\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3',@focus=1\n\t\t\t\t\tEND\n\t\t\t*/\n\t\tEND\n\tIF (SELECT LOCATIONS = count(Location_ID) FROM xCompanyxLocation WHERE Company_ID = @company_id) = 1 OR (SELECT LOCATIONS = count(id) FROM xLocation WHERE Company_ID = @company_id) = 1\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_text 'Vertrek Datum:','text-primary'\n\t\t\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3',@focus=1\n\t\t\tEXEC sp_api_modal_input @name='Logistic',@value = @opmerking OUT,@placeholder = N'Opmerking voor loods'\n\t\t\tEXEC sp_api_modal_input @name='Relation',@value = @opmerkingrelation OUT,@placeholder = N'Referentie voor klant'\n\t\tEND\n\t/*\n\tSELECT id = xLocation.id, name=LocationCode\n\t\tINTO #locations\n\t\tFROM xLocation WHERE Company_ID = @company_id OR id IN (SELECT Location_ID FROM xCompanyxLocation WHERE Company_ID = @company_id)\n\tEXEC sp_api_modal_select_table @tmptable = N'#locations',@value = @location_id OUT,@focus=1,@class='mt-3'\n\t*/\n\n\t--IF @location_id > 0\n\n\tEXEC sp_api_modal_text 'Kies een optie:','text-primary font-weight-bold display-4 text-center'\n\tEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Enter'\n\t\n\tIF EXISTS (SELECT * FROM xTransactionHeader WHERE status=N'openSale' AND CounterParty_ID = @company_id AND Transactiondate <= @date)\n\t\tBEGIN\n\t\tEXEC sp_api_modal_button @name='button',@value=@button2,@valueout = @button OUT,@key='F2'\n\t\tEND\n\t\t\n\tEXEC sp_api_modal_button @name='button',@value=@button4,@valueout = @button OUT,@key='F1'\n\tIF @button = @button4\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_clear\n\t\t\tEXEC sp_api_modal_button @name='button',@value=@button5,@valueout = @button OUT,@key='1'\n\t\t\tEXEC sp_api_modal_button @name='button',@value=@button6,@valueout = @button OUT,@key='2'\n\t\tEND\n\t\t\tIF @button = @button5\n\t\t\t\tBEGIN\n\t\t\t\t\tDECLARE @GotoOwnLocatie nvarchar(2000)\n\t\t\t\t\tSET @GotoOwnLocatie = N'/adres/'+@company_id+'/xlocation'\n\t\t\t\t\tEXEC sp_api_goto @GotoOwnLocatie,@referer_path=N'/verkoop'\n\t\t\t\tEND\n\t\t\tIF @button = @button6\n\t\t\t\tBEGIN\n\t\t\t\t\tDECLARE @GotoWorkLocatie nvarchar(2000)\n\t\t\t\t\tSET @GotoWorkLocatie = N'/adres/'+@company_id+'/company_locations'\n\t\t\t\t\tEXEC sp_api_goto @GotoWorkLocatie,@referer_path=N'/verkoop'\n\t\t\t\tEND\n\t\t\n\t\t/*\n\tIF EXISTS (SELECT * FROM xTransactionHeader WHERE status=N'openSale' AND CounterParty_ID = @company_id AND Transactiondate > @date)\n\t\tBEGIN\n\t\tEXEC sp_api_modal_button @name='button',@value=@button3,@valueout = @button OUT,@key='F2'\n\t\t\tSELECT TOP 1\n\t\t\t\ttv_companyname\n\t\t\t\t,transactiondate\n\t\t\t\t,[GERESERVEERD*] = 'GERESERVEERD'\n\t\t\t\t,id\n\t\t\t\tINTO #LASTORDER\n\t\t\tFROM q_xtransactionheader\n\t\t\tWHERE status=N'openSale' AND CounterParty_ID = @company_id AND Transactiondate > @date ORDER BY id DESC\n\t\t\tEXEC sp_api_modal_table @tmptable=N'#LASTORDER',@orderby=N'ORDER BY 3 ASC'\n\t\tEND\n\t\t*/\n/*\t\t\nELSE\n\t\tIF (select COUNT(id) from xlocation where company_id = @company_id ) = 1 \n\t\t\tBEGIN\n\t\t\t\tSET @only_new_is_possible = 1\n\t\t\tEND\n*/ \n\tIF @button = @button1 --OR @only_new_is_possible = 1\n\t\tBEGIN\n\t\tDELETE FROM api_storage WHERE card_id = (SELECT id FROM api_card WHERE name = N'verkoop') AND child_id = 0 AND user_id = @user_id\n\t\tEXEC sp_api_modal_clear\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'CounterParty_ID',@company_id,0\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'Destination_ID',@location_id,0\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'TransactionDate',@transactiondate,0\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'advTransportDep',@date,0\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'unloadingdate',@date,0\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'loadingdate',@date,0\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'Logistic',@opmerking,0\n\t\t\tEXEC sp_api_modal_post N'verkoop',N'Relation',@opmerkingrelation,0\n\t\t\tEXEC @new_id = sp_api_modal_save N'verkoop',0\n\t\t\tIF @new_id > 0\n\t\t\t\tBEGIN\n\t\t\t\t\t/*SET @goto = N'/verkoop/'+@new_id+'/stock_ctr2'*/\n\t\t\t\t\tSET @goto = N'/verkoop/'+@new_id+'/ctr2/0/stockloc_ctr2'\n\t\t\t\t\tEXEC sp_api_toast N'Nieuwe verkoop gestart',N'alert-primary'\n\t\t\t\t\t--SET @search = N'?id='+@new_id\n\t\t\t\t\tSET @search = N'/verkoop/'+@new_id+'/ctr2'\n\t\t\t\t\tDECLARE @update_current_search nvarchar(4000) =CONCAT(N'?id=',@new_id)\n\t\t\t\t\tEXEC sp_api_goto @goto,@referer_path=@search,@referer_search=N'',@update_current_search=@update_current_search\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tEXEC sp_api_toast N'Error nieuwe verkoop',N'alert-danger'\n\t\t\tEXEC sp_api_modal_clear\n\t\tEND\n\tIF @button = @button2\n\t\tBEGIN\n\t\t\tSET @new_id = (SELECT TOP 1 id FROM xTransactionHeader WHERE status=N'openSale' AND CounterParty_ID = @company_id AND Transactiondate <= @date ORDER BY id DESC)\n\t\t\t/*SET @goto = N'/verkoop/'+@new_id+'/stock_ctr2'*/\n\t\t\tSET @goto = N'/verkoop/'+@new_id+'/ctr2/0/stockloc_ctr2'\n\t\t\tSET @search = N'/verkoop/'+@new_id+'/ctr2'\n\t\t\tEXEC sp_api_goto @goto,@referer_path=@search,@referer_search=N''\n\t\t\t--SET @search = N'?id='+@new_id\n\t\t\t--EXEC sp_api_goto @goto,@referer_path=N'/verkoop',@referer_search=@search\n\t\tEND\n\tIF @button = @button3\n\t\tBEGIN\n\t\t\tSET @new_id = (SELECT TOP 1 id FROM xTransactionHeader WHERE status=N'openSale' AND CounterParty_ID = @company_id AND Transactiondate > @date ORDER BY id DESC)\n\t\t\t/*SET @goto = N'/verkoop/'+@new_id+'/stock_ctr2'*/\n\t\t\tSET @goto = N'/verkoop/'+@new_id+'/ctr2/0/stockloc_ctr2'\n\t\t\tSET @search = N'/verkoop/'+@new_id+'/ctr2'\n\t\t\tEXEC sp_api_goto @goto,@referer_path=@search,@referer_search=N''\n\t\t\t--SET @search = N'?id='+@new_id\n\t\t\t--EXEC sp_api_goto @goto,@referer_path=N'/verkoop',@referer_search=@search\n\t\tEND\n\tEXEC sp_api_modal_button @name='button',@value=@buttonescape,@valueout = @button OUT,@key='ESCAPE',@class='bg-danger text-light'\n\tIF @button = @buttonescape\n\tBEGIN\n\tEXEC sp_api_modal_clear\n\tRETURN;\n\tEND\nEND\n",
            "action_id": 341,
            "action_name": "Nieuwe Verkoop",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-----------------------------------------------\n-- action \u00cfnsert Order (PURCHASE)\n--\tpre declare: @button\n--\t211209\tstatus controle aangepast naar left(4) ivm commissie en koop partijen\n-----------------------------------------------\nDECLARE @company_id nvarchar(32),@new_id nvarchar(32),@goto nvarchar(2000),@search nvarchar(2000), @Fromlocation_id nvarchar(32),@Tolocation_id nvarchar(32), @reducer nvarchar(max)\n, @date nvarchar(128), @opmerking nvarchar(128), @Certificate nvarchar(128), @Certificate_enddate nvarchar(128), @text nvarchar(200)\n,@button1 nvarchar(128) = N'Nieuwe inkoop'\n,@button2 nvarchar(128) = N'Laatste open inkoop'\n,@button3 nvarchar(128) = N'Gereserveerde inkoop'\n,@buttonescape nvarchar(128) = N'Ga terug'\n,@buttongoahead nvarchar(128) = N'Ga door'\nset @date = dbo.workDate()\n\nIF dbo.workDate() <> dbo.abcdate() AND @button IS NULL\n\tBEGIN\n\tEXEC sp_api_modal_modal @class = 'bg-success-25'\n\tEXEC sp_api_modal_text 'LET OP! DE WERKDATUM STAAT NIET OP VANDAAG.','text-danger font-weight-bold'\n\tEXEC sp_api_modal_button @name='@button',@value=@buttongoahead,@valueout = @button OUT,@key='Pagedown',@class='bg-danger text-light'\n\tEXEC sp_api_modal_button @name='@button',@value=@buttonescape,@valueout = @button OUT,@key='ESCAPE',@class='bg-danger text-light'\n\t\tIF @button = @buttonescape\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_clear\n\t\t\tRETURN;\n\t\tEND\n\tEND\n\nIF @button = @buttongoahead OR dbo.workdate() = dbo.abcdate()\n\tBEGIN\n\tEXEC sp_api_modal_clear\n\tEXEC sp_api_modal_modal @class = 'bg-success-25'\n\tEXEC sp_api_modal_text 'Nieuwe Inkoop inzetten.','text-primary'\n\tEXEC sp_api_modal_text 'Kies een leverancier:','text-primary'\n\t--SET @reducer = CONCAT('company_id = ',@company_id)\n\tSET @reducer = 'isDisabled = 0'\n\tEXEC sp_api_modal_select @card_name = N'leverancier',@value = @company_id OUT,@reducer = @reducer,@focus=1\n\t\n\tEND\n\t\nIF @company_id > 0\nBEGIN\t\n\tSET @Certificate = (SELECT Q_Certificate from xcompany where id = @company_id)\n\tSET @Certificate_enddate = (SELECT Q_Certificate_enddate from xcompany where id = @company_id)\n\tSELECT @text = 'LET OP! Het certificaat '+ @Certificate +' van deze leverancier gaat/is vervallen op: ' + (SELECT date = FORMAT(Q_Certificate_enddate,'dd-MM-yyyy') from xcompany where id = @company_id) + '!'\n\t\n\tDECLARE @reducer_location nvarchar(max) = N'Company_ID = ' + @company_id + ' OR id IN (SELECT Location_ID FROM xCompanyxLocation WHERE Company_ID =' + @company_id + ')'\n\tIF (SELECT LOCATIONS = count(Location_ID) FROM xCompanyxLocation WHERE Company_ID = @company_id) > 1\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3',@focus=1\n\t\t\tEXEC sp_api_modal_input @name='Remarks',@value = @opmerking OUT\n\t\t\tEXEC sp_api_modal_text 'Kies een sublocatie van leverancier:','text-primary'\n\t\t\tEXEC sp_api_modal_select @card_name = N'xlocation',@value = @Fromlocation_id OUT,@reducer = @reducer_location\n\t\tEND\n\tIF (SELECT LOCATIONS = count(Location_ID) FROM xCompanyxLocation WHERE Company_ID = @company_id) = 1\n\t\tBEGIN\n\t\t\tEXEC sp_api_modal_date @name='Date',@value = @date OUT,@class='w-25 mt-3',@focus=1\n\t\t\tEXEC sp_api_modal_input @name='Remarks',@value = @opmerking OUT\n\t\tEND\n\n\tDECLARE @reducer_TenantLocation nvarchar(max) = N'company_id IN (select id from xtenantkey) \nOR id IN (SELECT Location_ID FROM Q_xCompanyxLocation WHERE Company_ID IN (select id from xtenantkey))'\n\t\t\tEXEC sp_api_modal_text 'Kies een eigen Locatie:','text-primary'\n\t\t\tEXEC sp_api_modal_select @card_name = N'xlocation',@value = @Tolocation_id OUT,@reducer = @reducer_TenantLocation\n\t\t\n\tIF (select count(id) from q_xtransactionheader where TDT = 1 and Repack_ID is null and specialtype is null and CounterParty_ID = @company_id) <= 5 AND (@Certificate is null or @Certificate_enddate is null)\n\t\tBEGIN\n\t\tEXEC sp_api_modal_text 'De gekozen leverancier is nieuw in het systeem','text-danger font-weight-bold display-5 text-center'\n\t\tEXEC sp_api_modal_text 'Vraag of ze begeleidende certificaten mee willen sturen','text-danger font-weight-bold display-5 text-center'\n\t\tEND\n\t\t\n\tIF @Certificate_enddate < (dbo.abcdate() + 8)\n\t\tBEGIN\n\t\tEXEC sp_api_modal_text @text,'text-danger font-weight-bold display-5 text-center'\n\t\tEND\n\t\t\n\tEXEC sp_api_modal_text 'Kies een optie:','text-primary font-weight-bold display-4 text-center'\n\tEXEC sp_api_modal_button @name='button',@value=@button1,@valueout = @button OUT,@key='Enter'\n\t\n\tIF EXISTS (SELECT * FROM xTransactionHeader WHERE left(status,4)=N'open' AND TDT=1 AND CounterParty_ID = @company_id AND Transactiondate <= @date)\n\t\tBEGIN\n\t\tEXEC sp_api_modal_button @name='button',@value=@button2,@valueout = @button OUT,@key='F1'\n\t\tEND\n/*\n\tIF EXISTS (SELECT * FROM xTransactionHeader WHERE status=N'openPurchase' AND CounterParty_ID = @company_id AND Transactiondate > @date)\n\t\tBEGIN\n\t\tEXEC sp_api_modal_button @name='button',@value=@button3,@valueout = @button OUT,@key='F2'\n\t\t\tSELECT TOP 1\n\t\t\t\ttv_companyname\n\t\t\t\t,transactiondate\n\t\t\t\t,[GERESERVEERD*] = 'GERESERVEERD'\n\t\t\t\t,id\n\t\t\t\tINTO #LASTORDER\n\t\t\tFROM q_xtransactionheader\n\t\t\tWHERE status=N'openPurchase' AND CounterParty_ID = @company_id AND Transactiondate > @date ORDER BY id DESC\n\t\t\tEXEC sp_api_modal_table @tmptable=N'#LASTORDER',@orderby=N'ORDER BY 3 ASC'\n\t\tEND\n\t\t*/\n\n\tIF @button = @button1\n\t\tBEGIN\n\t\tDELETE FROM api_storage WHERE card_id = (SELECT id FROM api_card WHERE name = N'inkoop') AND child_id = 0 AND user_id = @user_id\n\t\tEXEC sp_api_modal_clear\n\t\t\tEXEC sp_api_modal_post N'inkoop',N'CounterParty_ID',@company_id,0\n\t\t\tEXEC sp_api_modal_post N'inkoop',N'Source_ID',@Fromlocation_id,0\n\t\t\tEXEC sp_api_modal_post N'inkoop',N'Destination_ID',@Tolocation_id,0\n\t\t\tEXEC sp_api_modal_post N'inkoop',N'TransactionDate',@date,0\n\t\t\tEXEC sp_api_modal_post N'inkoop',N'advTransportDep',@date,0\n\t\t\tEXEC sp_api_modal_post N'inkoop',N'unloadingdate',@date,0\n\t\t\tEXEC sp_api_modal_post N'inkoop',N'loadingdate',@date,0\n\t\t\tEXEC sp_api_modal_post N'inkoop',N'Remarks',@opmerking,0\n\t\t\tEXEC @new_id = sp_api_modal_save N'inkoop',0\n\t\t\tIF @new_id > 0\n\t\t\t\tBEGIN\n\t\t\t\t\tSET @goto = N'/inkoop/'+@new_id+'/ctr1/0/stock_ctr1'\n\t\t\t\t\tEXEC sp_api_toast N'Nieuwe inkoop gestart',N'alert-primary'\n\t\t\t\t\tSET @search = N'?id='+@new_id\n\t\t\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/inkoop',@referer_search=@search\n\t\t\t\tEND\n\t\t\tELSE\n\t\t\t\tEXEC sp_api_toast N'Error nieuwe inkoop',N'alert-danger'\n\t\t\tEXEC sp_api_modal_clear\n\t\tEND\n\tIF @button = @button2\n\t\tBEGIN\n\t\t\tSET @new_id = (SELECT TOP 1 id FROM xTransactionHeader where left(status,4)=N'open' AND TDT=1 AND CounterParty_ID = @company_id AND Transactiondate <= @date ORDER BY id DESC)\n\t\t\tSET @goto = N'/inkoop/'+@new_id+'/ctr1/0/stock_ctr1'\n\t\t\tSET @search = N'?id='+@new_id\n\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/inkoop',@referer_search=@search\n\t\tEND\n\tIF @button = @button3\n\t\tBEGIN\n\t\t\tSET @new_id = (SELECT TOP 1 id FROM xTransactionHeader WHERE left(status,4)=N'open' AND TDT=1 AND CounterParty_ID = @company_id AND Transactiondate > @date ORDER BY id DESC)\n\t\t\tSET @goto = N'/inkoop/'+@new_id+'/ctr1/0/stock_ctr1'\n\t\t\tSET @search = N'?id='+@new_id\n\t\t\tEXEC sp_api_goto @goto,@referer_path=N'/inkoop',@referer_search=@search\n\t\tEND\n\tEXEC sp_api_modal_button @name='button',@value=@buttonescape,@valueout = @button OUT,@key='ESCAPE',@class='bg-danger text-light'\n\tIF @button = @buttonescape\n\tBEGIN\n\tEXEC sp_api_modal_clear\n\tRETURN;\n\tEND\nEND",
            "action_id": 349,
            "action_name": "Nieuwe Inkoop",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@from nvarchar(128),@to nvarchar(128),@commissieuser nvarchar(128)\nset @date = dbo.workDate()\nEXEC sp_api_modal_modal @class = 'w100'\nEXEC sp_api_modal_action N'report_menu',@keycode='Escape'\nEXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\nEXEC sp_api_modal_button @name='button',@value='Positieverloop Bijkopen',@valueout = @button OUT,@key='Enter'\nEXEC sp_api_modal_print\n\nEXEC sp_api_modal_text N'LET OP DEZE ACTIE IS ENKEL EEN SKELET OM EEN REPPORT IN TE PLAKKEN'\nEXEC sp_api_modal_text N'Deze actie is te vinden op: '\nEXEC sp_api_modal_text N'https://anaco.agfx.nl/api_actions/356'\n\n/* ENKEL COMMISSIE PARTIJEN DIE AFREKEND ZIJN OF BIJKOOP PARTIJEN TOONEN */\n\nIF @button = 'Positieverloop Bijkopen'\nBEGIN\nSELECT\n\t[Partynr] = [Partynr]\n\t,[Aankomst]\t= [Aankomst]\n\t,[Gelost] = SUM([Gelost])\n\t,[Verkocht]\t= SUM([Verkocht])\n\t,[Verkoop] = SUM([Verkoop])\n\t,[Transport] = SUM([Transport])\n\t,[Rabat] = SUM([Rabat])\n\t,[Verkoop nett.] = SUM([Verkoop nett.])\n\t,[Definitief] = SUM([Definitief])\n\t,[Verwacht] = SUM([Verwacht])\n\t,[Resultaat] = CAST(SUM([Verkoop nett.]) - (SUM([Definitief])+ SUM([Verwacht])) as decimal (18,2))\nINTO #Positieverloopbijkopen\nFROM (\n\t\t/* HIERONDER DE JUISTE INFORMATIE IN EEN SELECT STATEMENT NEERZETTEN */\n\tSELECT\n\t [Partynr] = 'PARTIJ123' -- Partijen\n\t ,[Aankomst] = '25/01/2022' -- aankomst datum\n\t ,[Gelost] = 1080 -- aantal gelost\n\t ,[Verkocht] = 1080 -- aantal verkocht\n\t ,[Verkoop] = 10000 -- omzet\n\t ,[Transport] = 400 -- transportkosten\n\t ,[Rabat] = 50 -- rabat,kortingen etc\n\t ,[Verkoop nett.] = 10000 - (400 + 50) -- omzet minus rabat, kortingen en transport.\n\t ,[Definitief] = 8000 -- inkoop kosten geboekt\n\t ,[Verwacht] = 200 -- verwachte kosten nog te boeken.\n) tbl WHERE [Aankomst] BETWEEN '25/01/2022' /*@from*/ AND '25/01/2022' /*@to*/  /* ENKEL COMMISSIE PARTIJEN DIE AFREKEND ZIJN OF BIJKOOP PARTIJEN TOONEN */\nGROUP BY [Partynr],[Aankomst]\nEXEC sp_api_modal_table @tmptable=N'#Positieverloopbijkopen',@orderby=N'ORDER BY 1 ASC',@print=1\nEND \n",
            "action_id": 356,
            "action_name": "Positieverloop Bijkopen",
            "source_table": "api_actions"
        },
        {
            "sql_source": "----------------------------------\n--\t220125rh\n--\ttoon foute data\n--\tpre declare @filename,@button\n----------------------------------\n\nselect  * into #errr from code_xInvRow where rowprice <> isnull(amount,1)*Price\nEXEC sp_api_modal_table @tmptable=N'#errr', @PRINT=1,@orderby='ORDER BY 1'\nEXEC sp_api_modal_button @name='button',@value = 'NaarCSV',@valueout = @button OUT,@class = 'btn-success',@key = '1'\nIF @button =  'NaarCSV'\nBEGIN\n\t\tset @filename='datafout.csv'\n\t\tEXEC sp_api_modal_clear\n\t\tSELECT *\n\t\tINTO #err_csv\n\t\tFROM \t\t #errr\n\t\tEXEC sp_api_modal_csv @tmptable=N'#err_csv',/*@orderby=N'ORDER BY [x/nummer]',*/ @filename=@filename,@ansi=1\n\t\tEXEC sp_api_modal_text 'Data is geexporteerd naar CSV','text-primary font-weight-bold h2 text-center mt-5'\n\t\t\tSELECT *\n\t\t\tINTO #err_d\n\t\t\tFROM          #errr\n\t\t\t--WHERE         Reportid = @id\n\t\t\tEXEC sp_api_modal_table @tmptable=N'#err_d'\nEND",
            "action_id": 363,
            "action_name": "foutjes",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-------------------------------------------------------------------------------------------\n--\tfunction: \t\tIR_Douaneplot\n--\tdescription:\tmail de gemiddelde waarde van de gefactureerde vrij verkochte goederen\n--\tpre declare:\t@Mailbutton\n--\tLET OP: ALLEEN GEFACTUREERDE OMZET !\n-------------------------------------------------------------------------------------------\n--EXEC sp_api_modal_modal N'bg-white'\nexec sp_api_modal_text N'Anaco & Greeve International BV', @Print=1, @class='h2'\nexec sp_api_modal_text N'Douane overzicht vrije goederen (waarde in Euro)', @Print=1, @class='h2'\ndeclare @T1 nvarchar(128)=concat(N'Factuurdatum ',(select @main_db.dbo.datumstring(getdate()-30,0)))\nexec sp_api_modal_text @T1, @Print=1, @class='h2'\n--@GB: hoe een <hr> ??\nexec sp_api_modal_text N'', @class='hr'\n\nselect Douane_Groep,\tOorsprong,\tNetto_Gewicht,\tAantal,\tTotaal_Gewicht,\tGem_Prijs_EUR,\teasy as Artikelomschrijving\n\tINTO #IR_Douaneplot\n from @main_db.dbo.IR_Douaneplot\n\t--select * from Netto_Salesprice_Per_StockID_and_InvoiceDate_customs\n\twhere dateinvoice=(select @main_db.dbo.cleandate(getdate()-30)) --'2021-11-24'\n--\twhere dateinvoice=(select @main_db.dbo.workDate())\nEXEC sp_api_modal_table @tmptable=N'#IR_Douaneplot' ,@print=1\n\n--mailen??\nEXEC sp_api_modal_button @name='@mailbutton',@value = 'Mail', @valueout = @Mailbutton OUT,@class='btn-warning',@key='M'\nif @Mailbutton='Mail'\nbegin\n\n\tDECLARE @subject nvarchar(255) = concat(N'Douaneoverzicht vrije goederen van ',(select @main_db.dbo.cleandate(getdate()-30)))\n\tDECLARE @body nvarchar(max),@html nvarchar(max),@list_select nvarchar(max),@list_select_cache nvarchar(max)\n\tSELECT @list_select_cache = list_select_cache FROM api_card WHERE id = @card_id\n\tSET @list_select=N'\n\t\tSELECT * INTO #tmptable FROM @main_db.dbo.IR_Douaneplot where dateinvoice=(select @main_db.dbo.cleandate(getdate()-30))\n\t\tEXEC sp_api_html_table N''#tmptable'',N''ORDER BY 2'',@html OUT'\n\t\t\n\tEXEC sp_executesql @list_select,N'@html nvarchar(max) OUT',@html OUT\n\n\n\t--wrap er een table omheen: / *\n\tSET @html = N'<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n\t<html xmlns=\"http://www.w3.org/1999/xhtml\">\n\t <head>\n\t  <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" />\n\t  <title>Demystifying Email Design</title>\n\t  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"/>\n\t</head><body style=\"margin: 0; padding: 0;\">\n\t <table border=\"3\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\n\t  <tr>\n\t   <td><h3>Export</h3>'+ @html +N'</td>\n\t  </tr>\n\t </table>\n\t</body></html>'\n\t--* /\n\n\tEXEC sp_api_email @user,@subject,@body = N'Geen html support',@html = @html -- html in @HTML !\n\tEXEC sp_api_toast N'Sent mail to:'\n\tEXEC sp_api_toast @user\n\texec sp_api_modal_clear-- afkappen na mailen..\n\nend",
            "action_id": 364,
            "action_name": "douaneplot",
            "source_table": "api_actions"
        },
        {
            "sql_source": "declare @data varbinary(max) = cast(N'Hallo hier text\\n' as varbinary(max))\n\nexec sp_api_sftp_put @host='matthijsict.nl', @user='Matthijs',@password='mati1980'\n\t, @filepath='/root/rick2021.txt' -- tilde = honme directory\n\t,@data=@data",
            "action_id": 365,
            "action_name": "sftp Mati",
            "source_table": "api_actions"
        },
        {
            "sql_source": "declare @data varbinary(max) = cast((SELECT * FROM xCountry FOR JSON AUTO) as varbinary(max))\n\nexec sp_api_sftp_put @host='matthijsict.nl', @user='matthijs',@password='mati1980'\n\t, @filepath='./rick2021.txt' -- tilde = honme directory\n\t,@data=@data\n",
            "action_id": 366,
            "action_name": "sftp matthijs",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--------------------------------------------------------------------------\n--\trh 220124\n--\trh 220127 met verwachte kosten op partij\n--\t220128 met verkoop fase plus alleen gelost=verkocht\n--\tAction: Instant report Partij overzicht \n--\tContext Card: Inkoop\n--\tPre declare: @Subgroep, @Lotnumber,@button\n--\n----------------------------------------------------------------------------\n--Set @Lotnumber = {[inkoop].lotnumber}\n--Set @Subgroep = left(@Lotnumber,2)\nDECLARE @ToLotGroup nvarchar(128),@searchlot nvarchar(128)\nIF @Lotnumber IS NULL\n\tBEGIN\n\t\tEXEC sp_api_modal_text N'Vul een Partij group in:',N'h2 text-muted font-weight-light'\n\t\tEXEC sp_api_modal_input @name='Subgroep',@max=2, @value= @Lotnumber OUT,@focus=1,@select=1\n\t\tEXEC sp_api_modal_button @name='@button',@value = 'Zoek', @valueout = @searchlot OUT,@class='btn-danger',@key='Enter'\n\tEND\nIF @Lotnumber IS NOT NULL\n\tBEGIN\n\t\t/*\n\t\tif trim(isnull(@lotnumber,N''))=N''\n\t\t\tbegin\n\t\t\t\texec sp_api_modal_text N'Geen Partijgroep..'\n\t\t\t\texec sp_api_modal_clear\n\t\t\tend\n\t\t*/\n\t\t-- ok, verder\t\n\t\tEXEC sp_api_modal_text N'Kies een status van de inkoop:',N'h2 text-muted font-weight-light'\n\t\tEXEC sp_api_modal_button @name='@button',@value = 'Open inkopen', @valueout = @button OUT,@class='btn-danger',@key='1'\n\t\tEXEC sp_api_modal_button @name='@button',@value = 'Gesloten inkopen', @valueout = @button OUT,@class='btn-danger',@key='2'\n\t\tDECLARE @status nvarchar(200),@status2 nvarchar(200)\n\t\tIF @button = 'Open inkopen'\n\t\t\tBEGIN\n\t\t\t\tSET @status = N'openPurchase'\n\t\t\t\tSET @status2 = N'openPurchaseC'\n\t\t\tEND\n\t\tIF @button = 'Gesloten inkopen'\n\t\t\tBEGIN\n\t\t\t\tSET @status = N'closedPurchase'\n\t\t\t\tSET @status2 = N'closedPurchaseC'\n\t\t\tEND\n\n\t\tEXEC sp_api_modal_modal @class=N'w100',@printStyle=N'font-size:70%',@landscape=1\n\t\tIF @button IS NOT NULL\n\t\t\tBEGIN\n\t\t\tEXEC sp_api_modal_text N'Status = ',N'h2 text-muted font-weight-light'\n\t\t\tEXEC sp_api_modal_text @status,N'h2 text-muted font-weight-light'\n\t\t\tEXEC sp_api_modal_text @status2,N'h2 text-muted font-weight-light'\n\t\t\t\tSELECT\n\t\t\t\t[Lotnumber] = [Lotnumber]\n\t\t\t\t,[CTH1_ID] = [CTH1_ID]\n\t\t\t\t,[partijdatum] = [partijdatum]\n\t\t\t\t,[leverancier] = [leverancier]\n\t\t\t\t,[Gelost@] = ISNULL(SUM([Gelost@]),0)\n\t\t\t\t,[Verkocht@] = ISNULL(SUM([Verkocht@]),0)\n\t\t\t\t,[Verkoop@:2] = ISNULL(SUM([Verkoop@:2]),0)\n\t\t\t\t,[v_Trans@:2] = ISNULL(SUM([v_Trans@:2]),0)\n\t\t\t\t,[v_Rabat@:2] = ISNULL(SUM([v_Rabat@:2]),0)\n\t\t\t\t,[Netto@:2] = ISNULL(SUM([Netto@:2]),0)\n\t\t\t\t,[p_Def@:2] = ISNULL(SUM([p_Def@:2]),0)\n\t\t\t\t,[p_Verw.@:2] = ISNULL(SUM([p_Verw.@:2]),0)\n\t\t\t\t,[result@:2] = ISNULL(SUM([result@:2]),0)\n\t\t\t\tINTO #V1\n\t\t\t\tFROM (\n\t\t\t\tselect  [Lotnumber]\n\t\t\t\t\t\t,[CTH1_ID]\n\t\t\t\t\t\t,[partijdatum]\n\t\t\t\t\t\t,[leverancier]\n\t\t\t\t\t\t,[Gelost] as [Gelost@]\n\t\t\t\t\t\t,[Verkocht@] = CASE WHEN fase2 = 'InvoiceGenerated' THEN [Verkocht]\tELSE 0 \tEND\n\t\t\t\t\t\t,[Verkoop@:2] =  CASE WHEN fase2 = 'InvoiceGenerated' THEN [verkoop] ELSE 0 \tEND\n\t\t\t\t\t\t,[v_Trans@:2] = CASE WHEN fase2 = 'InvoiceGenerated' THEN [V_trans] ELSE 0 \tEND\n\t\t\t\t\t\t,[v_Rabat@:2] = CASE WHEN fase2 = 'InvoiceGenerated' THEN [V_Rabat] ELSE 0 \tEND\n\t\t\t\t\t\t,[Netto@:2] = CASE WHEN fase2 = 'InvoiceGenerated' THEN [Verkoop_Netto] ELSE 0 \tEND\n\t\t\t\t\t\t,[p_Def@:2] = [P_def] \n\t\t\t\t\t\t,[p_Verw.@:2] = [P_verw] \n\t\t\t\t\t\t,[result@:2] = CASE WHEN fase2 = 'InvoiceGenerated' THEN [resultaat] ELSE [P_verw]  +  [P_def] *-1 \tEND\n\t\t\t\t\t\t--,[type] = fase2\n\t\t\t\t\t\t/*\n\t\t\t\t\t\t,[verkoop] as [Verkoop@:2]\n\t\t\t\t\t\t,[V_trans] as [v_Trans@:2]\n\t\t\t\t\t\t,[V_Rabat] as [v_Rabat@:2]\n\t\t\t\t\t\t,[Verkoop_Netto] as [Netto@:2]\n\t\t\t\t\t\t,[P_def] as [p_Def@:2]\n\t\t\t\t\t\t,[P_verw] as [p_Verw.@:2]\n\t\t\t\t\t\t,[resultaat] as [result@:2]\n\t\t\t\t\t\t*/\n\t\t\t\t\t/*into #V1*/\tfrom IV_RESULT_SUM_BASE_3 \n\t\t\t\t\t\twhere \n\t\t\t\t\t\t\t( @button = 'Gesloten inkopen' and fase1  in (@status,@status2) -- (N'Accountsale_Generated',N'closedPurchase')\n\t\t\t\t\t\t\t\tor\n\t\t\t\t\t\t\t@button = 'Open inkopen' and fase1 in (@status,@status2)\t -- (N'Accountsale_Generated',N'closedPurchase')\n\t\t\t\t\t\t\t) \t\t\t\t\n\t\t\t\t\t\t\t--and fase2=N'InvoiceGenerated' \n\t\t\t\t\t\t\t--CVG 2200201 Robert v L wilt dit uit hebben\n\t\t\t\t\t\t\t/*and gelost=verkocht */\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tand Lotnumber like concat(@Lotnumber,'%')\n\t\t\t\t\t\t\t\n\t\t--\t\t\tAND EXISTS(SELECT * FROM xtransactionheader where id = [CTH1_ID] AND Status IN(@status,@status2))\n\t\t\t\t\t--order by 1-- Lotnumber\n\t\t\t\t\t) tbl GROUP BY \t\t[Lotnumber],[CTH1_ID],[partijdatum],[leverancier]\n\t\t\t\texec sp_api_modal_text N'Totaal overzicht voor deze reeks' , @class='h5', @Print=1\n\t\t\t\tEXEC sp_api_modal_table @tmptable=N'#V1',@orderby = N'ORDER BY [Lotnumber] ASC' ,@PRINT=1-- geeft error!, @Orderby=1\n\t\t\tEND\n\t\t \n\t\t /* CVG VU 220201\n\t\t \tselect  [Lotnumber]\n\t\t\t\t\t\t,[CTH1_ID]\n\t\t\t\t\t\t,[partijdatum]\n\t\t\t\t\t\t,[leverancier]\n\t\t\t\t\t\t,[Gelost] as [Gelost@]\n\t\t\t\t\t\t,[Verkocht] as [Verkocht@]\n\t\t\t\t\t\t,[verkoop] as [Verkoop@:2]\n\t\t\t\t\t\t,[V_trans] as [v_Trans@:2]\n\t\t\t\t\t\t,[V_Rabat] as [v_Rabat@:2]\n\t\t\t\t\t\t,[Verkoop_Netto] as [Netto@:2]\n\t\t\t\t\t\t,[P_def] as [p_Def@:2]\n\t\t\t\t\t\t,[P_verw] as [p_Verw.@:2]\n\t\t\t\t\t\t,[resultaat] as [result@:2]\n\t\t\t\t\tinto #V1\tfrom IV_RESULT_SUM_BASE_3 \n\t\t\t\t\t\twhere \n\t\t\t\t\t\t\t( @button = 'Gesloten inkopen' and fase1  in (@status,@status2) -- (N'Accountsale_Generated',N'closedPurchase')\n\t\t\t\t\t\t\t\tor\n\t\t\t\t\t\t\t@button = 'Open inkopen' and fase1 in (@status,@status2)\t -- (N'Accountsale_Generated',N'closedPurchase')\n\t\t\t\t\t\t\t) \t\t\t\t\n\t\t\t\t\t\t\tand fase2=N'InvoiceGenerated' \n\t\t\t\t\t\t\tand gelost=verkocht\n\t\t\t\t\t\t\tand Lotnumber like concat(@Subgroep,'%')\n\t\t\t\texec sp_api_modal_text N'Totaal overzicht voor deze reeks' , @class='h5', @Print=1\n\t\t\t\tEXEC sp_api_modal_table @tmptable=N'#V1',@orderby = N'ORDER BY [Lotnumber] ASC' ,@PRINT=1-- geeft error!, @Orderby=1\n\t\t \n\t\t */\n\t END",
            "action_id": 372,
            "action_name": "Partij resultaten",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@buttoncsv nvarchar(128),@from nvarchar(128),@to nvarchar(128)\nset @date = dbo.workDate()\nEXEC sp_api_modal_modal @class = 'w100'\ndeclare @T1 nvarchar(300)= concat(N'Actuele voorraad in de loods op ',getdate())\nexec sp_api_modal_text @T1, @Class='h2', @print=1\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\n--EXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\n--EXEC sp_api_modal_button @name='button',@value = 'Omzet Per Artikel',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\nEXEC sp_api_modal_print\n\nEXEC sp_api_modal_action N'report_menu',@keycode='Escape'\n\nSET @button = 'Stock Per Item'\nIF @button =  'Stock Per Item'\nBEGIN\nEXEC sp_api_modal_button @name='@button',@value = 'Download CSV', @valueout = @buttoncsv OUT,@class='btn btn-success',@key='4'\n\tSELECT \n\t\tffa_code as [ffa_code**]\n\t\t,tot_pallets as [Pallets@~col-sm-1]\n\t\t, LK as [wms_article]\n--\t\t,[colli] as [Stuks@] --allemaal (nog) niet aanwezig in wms_art_stock\n--\t\t,[gewicht per pallet] \n--\t\t,[gewicht totaal] as [gewicht totaal@]\n\t\t,client_code as [client_code~col-sm-2]\n\tinto #SPI\n\tFROM @main_db.dbo.wms_art_stock\n\n\t\n\tEXEC sp_api_modal_table @tmptable=N'#SPI',@orderby=N'ORDER BY [ffa_code**],[wms_article] ASC',@print=1\n\tIF @buttoncsv =  'Download CSV'\n\t\tBEGIN\n\t\t\tDECLARE @filename nvarchar(128) = dbo.strdate(NULL) +'_'+ 'Stock_Per_Item.csv'\n\t\t\tEXEC sp_api_modal_csv @tmptable=N'#SPL',@filename= @filename,@ansi=1\n\t\tEND\nEND \n",
            "action_id": 377,
            "action_name": "Stock Per Item",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-------------------------------------------------------------------\n--\tcontext card:\tpallet_mobile (pal!), inbound (cnt!)\n--\taction: Position Container\n--\tZet alle pallets van de container op 1 loods lokatie (position)\n--\t220318 actie werkt nu ook op inbound (multi-card)\n-------------------------------------------------------------------\ndeclare @position_code nvarchar(20)\ndeclare @button nvarchar(50)\ndeclare @container_id int\n\nset @position_code={[pallet_mobile].position_code}\nset @container_id={[pallet_mobile].w_lot_id}\n--multi-card!\nif  @container_id is NULL set @container_id={[inbound].id} \nif @position_code is NULL set @position_code=(select top 1 position_code from w_pallet where w_lot_id=@container_id and position_code is not NULL) --220318 fallback\nif  @container_id is NULL\n\tbegin\n\t\texec sp_api_modsal_alert N'Tracy kan geen bijbehorende container vinden. Dit is een probleem. Taak wordt afgebroken.' \n\t\texec sp_api_modal_clear\n\t\treturn\n\tend\n\nEXEC sp_api_modal_input @name='position_code',@max=5, @value= @position_code OUT,@focus=1,@select=1,@Class='w-24 m-1'\nEXEC sp_api_modal_button @name='@button',@value = 'Opslaan', @valueout = @button OUT,@class='btn-danger',@key='Enter'\nif @button='Opslaan'\n\tbegin\n\t\t--naar boven gehaald ivm multi-card set @container_id={[p a l l e  t _ m o b i l  e].w_lot_id}\n\t\tif @container_id > 0 and @position_code > N''\n\t\t\tbegin\n\t\t\t\tupdate w_pallet set position_code=@position_code where w_lot_id=@container_id\n\t\t\t\tdeclare @Tx nvarchar(100)=concat(N'Pallets staan nu geboekt op lokatie ',@position_code)\n\t\t\t\texec sp_api_modal_alert @Tx\n\t\t\tend\n\t\tif @container_id > 0 and @position_code = N''\texec sp_api_modal_alert N'Er is geen nieuwe lokatiecode.'\n\n\t\texec sp_api_modal_clear\n\tend\n\n",
            "action_id": 384,
            "action_name": "wms_position_all_pallets_for_container",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_excel_from_list",
            "action_id": 393,
            "action_name": "sys_excel_from_list",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_file_delete @card_name,@id,@file_id,@user_name",
            "action_id": 397,
            "action_name": "sys_file_delete",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_save_sorting_order @card_id",
            "action_id": 402,
            "action_name": "sys_save_sorting_order",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_input @type='textarea',@name='@scanvalue',@value = @scanvalue OUT\n\t,@scanner = 1\n\t,@scanner_visible = 1\n\t,@scanner_action_prefix = N'https://tsql.app#'\n\t,@scanner_items_text = N'Scanned {n} codes'\n\t--,@scanner_direct_post = 1\n\n--EXEC sp_api_modal_button @name='@button',@value = 'Opslaan', @valueout = @button OUT,@class='btn-danger'\n\nIF 1 =1 OR @button IS NOT NULL\n\tBEGIN\n--\t\tEXEC sp_api_modal_clear\n\t\tEXEC sp_api_modal_text N'Scanner values:',N'h2'\n\t\tEXEC sp_api_modal_text @scanvalue,N'code'\n\t\tEXEC sp_api_modal_text N'@button value:',N'h2'\n\t\tEXEC sp_api_modal_text @button,N'code'\n\t\tEXEC sp_api_modal_text N'@scanactie value:',N'h2'\n\t\tEXEC sp_api_modal_text @scanactie,N'code'\n\tEND\n",
            "action_id": 407,
            "action_name": "Scanner Test",
            "source_table": "api_actions"
        },
        {
            "sql_source": "---------------------------------------------------------------------\n--\tglobal project action: #FFA \n--\tpredeclare @ffa_id int OUT \n--\tdynamic role: \n\n--EXEC sp_api_modal_select @card_name = N'ffa',@value = @ffa_id OUT\n---------------------------------------------------------------------\nexec sp_api_modal_text N'Freight Forwarding Agent (FFA)'\nif  dbo.hasClaims(N'tenant=rws,tenant=tracy')>0 \n\tEXEC sp_api_modal_select @card_name = N'adres',@value = @ffa_id OUT, @reducer='is_ffa=1'\nelse --ffa of klant\n\tbegin\n\t\tdeclare @xr1 nvarchar(4000) -- extra reducer\n--\t\tdeclare @xr2 nvarchar(4000) -- extra reducer\t\t\n\t\tdeclare @reducer nvarchar(max) -- final\n\t\t\n\t\tif exists(select * from user_ffa_client where user_name=@user_name and ffa_id >0) -- er zijn ffa_id's voor deze user\n\t\t\tset @xr1=(select string_agg(ffa_id,',') from user_ffa_client where user_name=@user_name)\n\t\telse exec sp_api_toast N'er is (nog) geen login-verband gelegd voor deze user-company-ffa'\t\n--\t\tif exists(select * from user_ffa_client where user_name=@user_name and client_id >0) -- er zijn client_id's vopor deze user\n--\t\t\tset @xr2=concat(' and ',(select string_agg(client_id,',') from user_ffa_client where user_name=@user_name))\t\t\t\n\t\tset @reducer= N'is_ffa=1' + iif(@xr1>N'',concat(' and id in(',@xr1,')'),'')\n\t\tEXEC sp_api_modal_select @card_name = N'adres',@value = @ffa_id OUT, @reducer=@reducer\n\tend\n\t",
            "action_id": 413,
            "action_name": "#FFA",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--------------------------------------------------------------\n--\tglobal project action: #klant_van (tijdelijke stored proc)\n--\tPRE DECLARE: @ffa_id int, @klant_id int OUT \n--\thttps://wms.tsql.app/api_actions/437  \n---------------------------------------------------------------\ndeclare @t1 nvarchar(200)=concat('Selecteer klant van ',(select code from xcompany where id=@ffa_id))\ndeclare @xr1 nvarchar(512) \nexec sp_api_modal_text @t1  \n \ndeclare @reduc nvarchar(1024)\nset @reduc=N'is_wms_customer=1' + iif(@ffa_id is NULL,N'',concat(' and id in (select vendor_company_id from wms_vendor_companies where main_company_id=',@ffa_id,' )'))\n\n--221208 was: EXEC sp_api_modal_select @card_name = N'klant',@value = @klant_id OUT, @reducer=@reduc, @initial_id=@klant_id\nif  dbo.hasClaims(N'tenant=rws,tenant=tracy')>0 \n\tEXEC sp_api_modal_select @card_name = N'klant',@value = @klant_id OUT, @reducer=@reduc, @initial_id=@klant_id\nelse --ffa of klant\n\tbegin\n\t\tif exists(select * from user_ffa_client where user_name=@user_name and client_id >0) -- er zijn ffa_id's voor deze user\n\t\t\tset @xr1=(select string_agg(client_id,',') from user_ffa_client where user_name=@user_name)\n\t\telse \n\t\t\texec sp_api_toast N'er is (nog) geen login-verband gelegd voor deze user-company-ffa'\t\n\t\t\t \n\t\tIF @XR1 > N''\n\t\t\tbegin\n\t\t\t\tset @reduc=concat(@reduc ,' and id in(',@xr1,')')\n\t\t\tend\n\t\tEXEC sp_api_modal_select @card_name = N'klant',@value = @klant_id OUT, @reducer=@reduc, @initial_id=@klant_id\n\tend",
            "action_id": 417,
            "action_name": "#klant_van",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--------------------------------------------------------------------- \n--\tglobal project action: #FFA\n--\tpredeclare @ffa_id int OUT\n\n--EXEC sp_api_modal_select @card_name = N'ffa',@value = @ffa_id OUT \n---------------------------------------------------------------------\nexec sp_api_modal_text N'Freight Forwarding Agent (FFA)'\nselect distinct ffa_id INTO #ffa_ids FROM [wms_micro_items_stock_info] where s_items_stock >0\n--@reducer='is_ffa=1 and id in ( select distinct ffa_id FROM [wms_micro_items_stock_info] where s_items_stock >0)'\nEXEC sp_api_modal_select @card_name = N'adres',@value = @ffa_id OUT, @reducer='is_ffa=1 and id in ( select ffa_id FROM #ffa_ids)'\n",
            "action_id": 425,
            "action_name": "#ffa_met_micro_stock",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-----------------------------------------\n--\tPROC: #klant (tijdelijke stored proc)\n--\tPRE DECLARE: @klant_id int OUT\n--\thttps://dev.agfx.nl/api_actions/503\n-----------------------------------------\n\nEXEC sp_api_modal_select @card_name = N'klant',@value = @klant_id OUT\nSELECT * INTO #context FROM xCountry WHERE 1 = 0\nEXEC sp_api_modal_table @tmptable = '#context'\n\n--SELECT \n",
            "action_id": 426,
            "action_name": "#klant",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--------------------------------------------------------------\n--\tglobal project action: #klant_van_ffa_met_micro_stock\n--\tPRE DECLARE: @ffa_id int, @klant_id int OUT\n--\thttps://wms.tsql.app/api_actions/437\n---------------------------------------------------------------\ndeclare @t1 nvarchar(200)=concat('Selecteer klant van ',(select code from xcompany where id=@ffa_id))\nexec sp_api_modal_text @t1\n\nif not exists( select * from wms_vendor_companies where main_company_id=@ffa_id and vendor_company_id=@klant_id) \n\tbegin\n\t\tset @klant_id=NULL\n\tend\t\n\ndeclare @reduc nvarchar(512)\nselect distinct client_id INTO #client_ids FROM [wms_micro_items_stock_info] where s_items_stock >0\nset @reduc=N'is_wms_customer=1' \n\t\t+ iif(@ffa_id is NULL,N'',concat(' and id in (select vendor_company_id from wms_vendor_companies where main_company_id=',@ffa_id,' )'))\n\t\t--GB221212 + N' and id in(select distinct client_id FROM [wms_micro_items_stock_info] where s_items_stock >0)'\n\t\t+ N' and id in(select client_id FROM #client_ids)'\nEXEC sp_api_modal_select @card_name = N'klant',@value = @klant_id OUT, @reducer=@reduc, @initial_id=@klant_id",
            "action_id": 427,
            "action_name": "#klant_van_ffa_met_micro_stock",
            "source_table": "api_actions"
        },
        {
            "sql_source": "exec sp_api_toast N'in test'\nreturn 100",
            "action_id": 428,
            "action_name": "#test_oke",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--------------------------------------------------------\n-- context: een pallet\n-- add_micro_item\n--------------------------------------------------------\ndeclare @PalID int\n\nset @PalID={[pallet_status].id}\nif @PalID is null set @PalID={[w_pallet].id}\nif @PalID is null \n\tbegin\n\t\texec sp_api_modal_Alert N'Er is geen pallet context gevonden. Actie wordt gestopt.'\n\t\texec sp_api_modal_clear\n\t\treturn\n\tend\n\n--oke, verder\t\nif (select id from w_pallet where id=@PalID) is null\n\tbegin\n\t\texec sp_api_modal_alert N'Onbekende pallet'\n\t\texec sp_api_modal_clear\n\t\treturn\n\tend\n--oke verder...\t\ndeclare @Aantal int\nDECLARE @id_value int\ndeclare @button nvarchar(200)\n\nexec sp_api_modal_text N'Ingave van de artikelen op de pallet.',@class='h3'\nexec sp_api_modal_text N'Artikelcode'\nSELECT id=Id,name=LookupCode --JAM54S30-405/MR\n INTO #micro_item FROM xstock\nEXEC sp_api_modal_select_table @value = @id_value OUT ,@tmptable=N'#micro_item'\n\nexec sp_api_modal_text N'Aantal toe te voegen op de pallet'\nEXEC sp_api_modal_input_decimal @name='Aantal items',@value= @Aantal OUT,@focus=1 ,@precision=18,@scale=0\n\nEXEC sp_api_modal_button @name='@button',@value = 'Opslaan', @valueout = @button OUT,@class='btn-danger',@key='F5'\nif @Button=N'Opslaan' and isnull(@Aantal,-1)>0 and isnull(@id_value,-1)>0\n\tbegin\n\t\t--exec sp_api_modal_alert 'Goed zo'\n\t\tDECLARE @Counter INT \n\t\tSET @Counter=1\n\t\tWHILE ( @Counter <= @Aantal)\n\t\tBEGIN\n\t\t   -- PRINT 'The counter value is = ' + CONVERT(VARCHAR,@Counter)\n\t\t   insert into wms_micro_item(w_pallet_id,xStock_id)\n\t\t   \tvalues(\n\t\t   \t\t\t@PalID \t\t-- pallet from card\n\t\t   \t\t\t,@id_value\t--selected xstock id\n\t\t   \t\t)\n\t\t    SET @Counter  = @Counter  + 1\n\t\tEND\n\t\texec sp_api_modal_clear\n\tend",
            "action_id": 429,
            "action_name": "wms_add_micro_item_to_pallet",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_modal @class=N'w100',@printStyle=N'font-size:70%',@landscape=1  -- ;width:105mm;height:148mm",
            "action_id": 433,
            "action_name": "#breed100",
            "source_table": "api_actions"
        },
        {
            "sql_source": "---------------------------------------------------------------------\n--\tglobal project action: #country\n--\tpredeclare @country_id int OUT\n\n--EXEC sp_api_modal_select @card_name = N'ffa',@value = @ffa_id OUT\n---------------------------------------------------------------------\nexec sp_api_modal_text N'Select Country'\nif @country_id is NULL set @country_id=151\nSELECT id=countryId,name=Name_1 INTO #modaltable FROM xCountry\nEXEC sp_api_modal_select_table @value = @country_id OUT ,@initial_id=@country_id --,@tmptable=N'#tmptable'",
            "action_id": 439,
            "action_name": "#country",
            "source_table": "api_actions"
        },
        {
            "sql_source": "---------------------------------------------------------------------\n--\tglobal project action: #country\n--\tpredeclare @country_id int OUT\n\n--EXEC sp_api_modal_select @card_name = N'ffa',@value = @ffa_id OUT\n---------------------------------------------------------------------\nexec sp_api_modal_text N'Kies een land'\nif @country_id is NULL set @country_id=151\nSELECT id=countryId,name=Name_0 INTO #modaltable FROM xCountry\nEXEC sp_api_modal_select_table @value = @country_id OUT ,@initial_id=@country_id --,@tmptable=N'#tmptable'",
            "action_id": 443,
            "action_name": "#land",
            "source_table": "api_actions"
        },
        {
            "sql_source": "----------------------------------------------\n--\tPROC: #crediteur (tijdelijke stored proc)\n--\tPRE DECLARE: @crediteur_id int OUT\n--\thttps://dev.agfx.nl/api_actions/503\n----------------------------------------------\nexec sp_api_modal_text N'Selecteer de leverancier (crediteur)'\n--EXEC sp_api_modal_select @card_name = N'crediteurleverancier',@value = @leverancier_id OUT\nSELECT id=Id,name=concat(code,' - ',companyname) INTO #cred FROM xCompany where is_creditor=1\nEXEC sp_api_modal_select_table @value = @crediteur_id OUT ,@tmptable=N'#cred'\n",
            "action_id": 449,
            "action_name": "#crediteur",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-------------------------------- \n-- global action lijst-weergave\n-- name : list ( vertaal naar \u2263 lijst )\n-- params: {\"className\":\"arial btn btn-tracy\"}\n-- recommended key: F2\n-- Global = TRUE\n--------------------------------\ndeclare @GT nvarchar(256)=concat(@path,'?id=',@ID)\n--exec sp_api_toast @GT\nexec sp_api_goto @PATH=@GT",
            "action_id": 456,
            "action_name": "list",
            "source_table": "api_actions"
        },
        {
            "sql_source": "set @newID int =scope_Identity()\n\tif @newID >0\n\t\tbegin\n\t\t\tdeclare @gt nvarchar(256)=concat(@path,'?id=',@newid)\n\t\t\texec sp_api_goto @path=@gt\n\t\tend",
            "action_id": 460,
            "action_name": "#GOTO_LIST_ID",
            "source_table": "api_actions"
        },
        {
            "sql_source": "declare @H nvarchar(512)=concat_ws(' - ',getdate(),@user)\n--EXEC sp_api_modal_modal @class=N'w100',@printStyle=N'font-size:70%',@landscape=1  -- ;width:105mm;height:148mm\nexec sp_api_modal_text @H,@print=1",
            "action_id": 469,
            "action_name": "#print_header",
            "source_table": "api_actions"
        },
        {
            "sql_source": "declare @H nvarchar(512)=concat_ws(' - ','printed',getdate(),@user)\n--EXEC sp_api_modal_modal @class=N'w100',@printStyle=N'font-size:70%',@landscape=1  -- ;width:105mm;height:148mm\nexec sp_api_modal_text @H,@print=1",
            "action_id": 473,
            "action_name": "#print_footer",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-----------------------------------------------------------\n-- 230127  \n-- mobile_scan; **MENU-ITEM** voer een actie uit op basis van een qr scan\n-- pre declare: @lastname,@button,@qrscanner\n-----------------------------------------------------------\n\nDECLARE @prefix nvarchar(max)\nDECLARE @uuid nvarchar(max)\nEXEC sp_api_modal_text N'Scanner',N'h1'\nIF --1= 0 AND \n@qrscanner IS NULL  --na post is dit gevuld\n\tBEGIN\n\t\t--post direct als hij qr 'ziet'\n\t\tEXEC sp_api_modal_qr_scanner N'@qrscanner',@value = @qrscanner OUT\n\t\tRETURN\n\tEND\n\nSET @prefix = N'w_lot#'\nIF @qrscanner LIKE @prefix+'%'\n\tBEGIN\n\t\t--set @uuid = REPLACE(@qrscanner,@prefix,'')\n\t\tset @uuid=dbo.regex_match(right(@qrscanner,len(@qrscanner)-len(@prefix)),N'[0-z]+')\n\t\t--SET @uuid = 7\n\t\tEXEC #qr_action_loods_bevestiging_inslag @uuid\n\t\tRETURN\n\tEND\n\n--uitgebreid 230219 omdat oude palletstickers ook gelezen moeten kunnen worden\n-- hiermee kunnen de oude palletstickers met volledige url ook gelezen worden; vertaalt zich naar dezelfde functionaliteit als bij ps:<<pallet_id>>\nSET @prefix = concat(@origin,'/inbound/') --N'https://rws.tsql.app/inbound/' -- de palletsticker\nif left(@qrscanner,len(@prefix))=@prefix\n\tbegin \n\t\tdeclare @pallet_label nvarchar(256) = @main_db.dbo.get_url_param_val(@qrscanner,'pallet_label')\n\t\tif @pallet_label > N''\n\t\t\tBEGIN\n--\t\t\t\texecute sp_api_toast N'pallet sticker..'\n\t\t\t\tdeclare @pal_id int = (select id from w_pallet where pallet_label=@pallet_label)\n\t\t\t\tif @pal_id > 0 \n\t\t\t\t\tbegin\n\t\t\t\t\t\tEXEC #qr_action_pallet_sticker @uuid=@pal_id --230219\n\t\t\t\t\tend\n\t\t\t\tif isnull(@pal_id,0)=0\n\t\t\t\t\tbegin\n\t\t\t\t\t\texec sp_api_toast N'GEEN GELDIG PALLET LABEL.'\n\t\t\t\t\tend\t\t\n\t\t\t\tRETURN\n\t\t\tEND\n\tend\t\n--230217 nieuw\nSET @prefix = N'ps:' -- de palletsticker\nIF @qrscanner LIKE @prefix+'%'\n\tBEGIN\n--\t\texecute sp_api_toast N'pallet sticker..'\n\t\t--set @uuid = REPLACE(@qrscanner,@prefix,'')\n\t\tset @uuid=dbo.regex_match(right(@qrscanner,len(@qrscanner)-len(@prefix)),N'[0-z]+')\n\t\tEXEC #qr_action_pallet_sticker @uuid\n\t\tRETURN\n\tEND\n\n\nSET @prefix = N'out_trans#'\nIF @qrscanner LIKE @prefix+'%'\n\tBEGIN\n--\t\tset @uuid = REPLACE(@qrscanner,@prefix,'')\n\t\tset @uuid=dbo.regex_match(right(@qrscanner,len(@qrscanner)-len(@prefix)),N'[0-z]+')\n\n\t\t--SET @uuid = 7\n\t\tEXEC #qr_action_verwerk_outbound_transport @uuid ,@origin = @origin --foto?\n\t\tRETURN\n\tEND\n\n\nSET @prefix = N'micro_pick'\nIF @qrscanner LIKE @prefix+'%'\n\tBEGIN\n--\t\tset @uuid = REPLACE(@qrscanner,@prefix,'')\n\t\tset @uuid=dbo.regex_match(right(@qrscanner,len(@qrscanner)-len(@prefix)),N'[0-z]+')\n\n\t\t--SET @uuid = 7\n\t\t--231008 was EXEC #q r _ a c t i o n _ v e r w e r k _ m i c r o_pick @uuid ,@origin = @origin --foto?\n\t\t--if @user='rick@tracy.nu' \n\t\t\t\n\t\t\tif @user='rick@tracy.nu'\n\t\t\tBEGIN\n\t\t\t\t--exec #qr_action_verwerk_micro_pick_241213 @uuid ,@origin = @origin \n\t\t\t\tEXEC #qr_action_verwerk_micro_pick_v11 @uuid ,@origin = @origin \n\t\t\tEND\n\t\t\tELSE\n\t\t\tBEGIN\n\t\t\t\t--231211 live test met V11\n\t\t\t\tEXEC #qr_action_verwerk_micro_pick_v11 @uuid ,@origin = @origin \n\t\t\tEND\n\t\t--else \n\t\t--\t....andere test actie\n\t\tRETURN\n\tEND\n\n\nEXEC sp_api_modal_qr_scanner N'@qrscanner',@value = @qrscanner OUT\t\nEXEC sp_api_modal_text N'Onbekende code',N'h5'\nEXEC sp_api_modal_text @qrscanner\n\n/*\n\n\t--@qrscanner:  bonnetje#34535-345234-2356-234-342\nEXEC sp_api_modal_text @qrscanner,N'h5'\nEXEC sp_api_modal_input @name = '@qrscanner', @value = @qrscanner OUT --,@inline = 1\nEXEC sp_api_modal_text 'Doe er wat mee'\nEXEC sp_api_modal_button @name='@button',@value = 'Save', @valueout = @button OUT,@class='btn-danger',@key='Enter'\n--IF @button IS NULL RETURN\n*/",
            "action_id": 478,
            "action_name": "Mobilephone",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-------------------------------------------------------------\n-- #qr_action_loods_bevestiging_inslag\n--\t#qr_action_pallet_sticker scanner action handler\n-- pre declare: @uuid int, @button_choose nvarchar(max)= null\n--\n-------------------------------------------------------------\ndeclare @hTML nvarchar(4000) \ndeclare @link_tracy nvarchar(4000)=NULL\ndeclare @T nvarchar(512)=concat(N'Afsluitende handeling voor de inslag van container ',(select container_number from w_lot WHERE Id = @uuid))\nexec sp_api_modal_text @T,@class='h2'\n\ndeclare @current_state nvarchar(512)= (select status from wms_io where w_lot_id=@uuid and in_out='IN' )\nset @T=concat('De huidige status van de inbound is: ',@current_state)\nexec sp_api_modal_text @T,@class='h2'\n\n\nEXEC sp_api_modal_choose @list = N'Conform,Niet_Conform',@value = @button_choose OUT,@startkey=3\nif @button_choose is null return\n \n if @button_choose ='Conform'\n\tbegin\n\t\tif @current_state  ='CONFORM'\n\t\t\tbegin\n\t\t\t\texec sp_api_modal_alert N'De status van deze inslag is al \"CONFORM\"'\n\t\t\t\tEXEC sp_api_modal_clear --!! nodig anders kom je niet weg hier\n\t\t\t\texec sp_api_goto N'\\'\n\t\t\t\treturn\n\t\t\tend\n\t\t\n\t\t\t\t--230516\n\t\t\t\tupdate wms_io \n\t\t\t\t\tset status='CONFORM' \n\t\t\t\t\t\t,conform_user=@USER\n\t\t\t\t\t\t,conform_dt=getdate()\n\t\t\t\t\twhere w_lot_id=@uuid and in_out='IN' \n\t\t\t\n\t\t\t\t--WEBHOOK\n\t\t\t\tdeclare @supplier_id int = (select ffa_id from w_lot where id=@uuid)\n\t\t\t\texec sp_add_webhook_post @target_company_id=@supplier_id, @context_code=N'inbound_booked', @context_id=@uuid\n\t\t\t\t\n\t\t\t\t--notification rick\n\t\t\t\tEXEC tracy_wms_proj.dbo.sp_api_push_bullet @channel_tag = 'tracy_wmsx_rws',@title=N'webhook api inbound completed',@body=N'api inbound voltooid, klant geinformeerd via webhook.'\n\t\t\t\t--EXEC sp_api_email @to=N'inboundrwsbv.com@tracy.nu',@subject='API - BL - INBOUND POST WEBHOOK COMPLETED',@body=N'Er is een INBOUND POST ontvangen uit een extern systeem.'\n\t\t\t\t--exec sp_api_toast N'sp_add_webhook_post....' \n\n\t\t\t\n\t\t\t\n\t\t\t\n\n\t\t--\tLET OP: TEVENS TRIGGER ACTIE MAIL NAAR FFA, ZIE WMS_IO\n\t\t--\tALTER TRIGGER [dbo].[au_wms_io_send_mail] \n\t\t\n\n\n\n\t\t\n/* 230214 deze hoeft niet meer van Dennis\n\t\t--hier mail naar inbound@rws met een link naar de container zodat het verder afgewerkt en bevestigd kan worden naar de klant subject INSLAG CONFORM\n\t\tset @link_tracy=concat(N'https://rws.tsql.app/inbound?id=',@uuid,' ') --meegegeven parameter\n\t\tset @html=concat(N'Container ',(select container_number from w_lot where id=@uuid),' is conform verwachting ingeslagen in de loods. '\n\t\t\t\t\t\t,'Ga naar de betreffende container in Tracy voor de laatste afhandeling. Daarbij kunt u de klant bevestigen via de email button.'\n\t\t\t\t\t\t,'<p><a href=\"',@link_tracy,'\" target=_blank>click hier</a>'\n\t\t\t\t\t\t)\n\n\t  \t--PROJECT CALL !!\n  \t\tEXEC sp_api_email @to = N'inbound@rwsbv.com',@subject = N'inbound conform, s.v.p. afwerken..',@body = N'tracy is the best',@html = @html\n*/\n\t\texec sp_api_modal_clear\n\t\treturn\n\tend\n\n \nif @button_choose ='Niet_Conform'\n\tbegin\n\t\tif @current_state ='NOT CONFORM'\n\t\t\tbegin\n\t\t\t\texec sp_api_modal_alert N'Deze inslag is al als \"NOT CONFORM\" gemeld..'\n\t\t\t\tEXEC sp_api_modal_clear\n\t\t\t\texec sp_api_goto N'\\'\t\t\t\t\n\t\t\t\treturn\n\t\t\tend\n\n\t\tDECLARE @opmerking nvarchar(max),@button22 nvarchar(128)\n\t\texec sp_api_modal_text N'opmerking op container'\n\t\tEXEC sp_api_modal_input @name = '@opmerking', @value = @opmerking OUT --,@inline = 1\n\t\tEXEC sp_api_modal_button @name='@button22',@value = 'Save', @valueout = @button22 OUT,@class='btn-danger',@key='Enter'\n\t\tIF @button22 IS NULL RETURN\n\t\tUPDATE w_lot SET inbound_remark =  @opmerking WHERE Id = @uuid\n\n\t\tupdate wms_io set status='NOT CONFORM' where w_lot_id=@uuid and in_out='IN' \n\t\n\t\n\t\t--hier mail naar inbound@rws met een link naar de container zodat het verder afgewerkt en bevestigd kan worden naar de klant subject: AFWIJKENDE INSLAG\n\t\tset @link_tracy=concat(N'https://rws.tsql.app/inbound?id=',@uuid,' ') --meegegeven parameter\n\t\tset @html=concat(N'Let op: bij het inslaan van de container zijn verschillen geconstateerd. Het betreft container ',(select container_number from w_lot where id=@uuid),'. '\n\t\t\t\t\t\t,'Ga naar de betreffende container en pas de pallets aan. -> '\n\t\t\t\t\t\t,'<p>De opmerking is :',@opmerking,'<p>'\n\t\t\t\t\t\t,'Als de registratie compleet is verwerkt dient u de klant nog de bevestigings mail te sturen via de email button'\n\t\t\t\t\t\t,'<p><a href=\"',@link_tracy,'\" target=_blank>click hier om naar de container te gaan.</a>'\n\t\t\t\t\t\t)\n\n\t  \t--PROJECT CALL !!\n  \t\tEXEC sp_api_email @to = N'inbound@rwsbv.com',@subject = N'AFWIJKENDE INBOUND! S.V.P AFWERKEN..',@body = N'tracy is the best',@html = @html\n\n\t\tEXEC sp_api_modal_clear\n\t\treturn\n\tend\n\n",
            "action_id": 486,
            "action_name": "#qr_action_loods_bevestiging_inslag",
            "source_table": "api_actions"
        },
        {
            "sql_source": "---------------------------------------------------------------\n-- #qr_action_verwerk_outbound_transport scanner action handler \n-- pre declare: @uuid int, @button_choose nvarchar(max)= null ,@origin nvarchar(1024), @sampleqrscanner nvarchar(max)= null\n-- 230510 uitbreiden met altijd foto's kunnen toevoegen aan outbound transport files\n---------------------------------------------------------------\ndeclare @hTML nvarchar(4000) \ndeclare @link_tracy nvarchar(4000)=NULL\ndeclare @gofoto nvarchar(4000)=concat(N'/wms_out_transport/',@uuid)\ndeclare @pal_id int\nexec sp_api_modal_text @uuid --230706 toon transport_id\nEXEC sp_api_modal_choose @list = N'Conform,Not_Conform,Add_Photo,Barcodes,Pallet_Sample',@value = @button_choose OUT,@startkey=3\nif @button_choose is null return\n\n if @button_choose ='Add_Photo'\n\tbegin\n\t\t--230703 dit stukje is er voor gezet om af te dwingen dat er eerst een geldige SAMPLE wordt gemaakt d.m.v. PALLET LABEL SCAN\n\t\t--230706 aangepast, controleert of er minimaal 1 geldige scan is met container, artikel en w_lot overeenkomst\n\t\tif not exists(select 1 from wms_micro_outbound where transport_id=@uuid) \n\t\t\tbegin --deze outbound is geen micro outbound, dus een normale outbound => dwing af dat er eerst een pallet scan wordt gedaan\n\t\t\t\tif not exists(select * from q_wms_out_samples \n\t\t\t\t\t\t\t\twhere xtransport_id=@uuid \n\t\t\t\t\t\t\t\t\tand out_stock_id in (select xstock_id from q_wms_out_requested where xtransport_id=@uuid) -- zelfde artikel !\n\t\t\t\t\t\t\t\t\tand w_lot_id in(select w_lot_id from q_wms_out_requested where xtransport_id=@uuid) --minimaal zelfde container\n\t\t\t\t\t\t\t\t\tand bl_id in(select bl_id from q_wms_out_requested where xtransport_id=@uuid) --minimaal zelfde BL !\n\n\t\t\t\t\t\t\t) --and info='oke') --TMP !!\n\t\t\t\t\tBEGIN --kennelijk (nog) geen correcte pallet gecand..\n\t\t\t\t\t\texec sp_api_toast N'NO VALIDATION YET; SCAN THE PALLET-LABEL FIRST! (SAMPLE)'\n\t\t\t\t\t\treturn\n\t\t\t\t\tEND\n\t\t\tend\n\n\t\tELSE --het is een micro outbound\n\t\t\tBEGIN\n\t\t\t\texec sp_api_toast N'micro outbound'\n\t\t\tEND\t\n\n\t\t-------------------------------------\n\t\t-- add_document_or_foto\n\t\t-- pre declare @api_files_id,@filename,@trans_out_id\n\t\t-------------------------------------\n\t\t/*\n\t\t(context = 'wms_out_transport' AND context_id = {[wms_out_transport].id})\n\t\tor \n\t\t(context = 'wms_out_transport' AND context_id = {[ffa_transport_out].id})\n\t\tor \n\t\t(context = 'wms_out_transport' AND context_id = {[wms_io].out_transport_id})\n\t\t*/\n\t\tdeclare @api_files_id int\n\t\tdeclare @filename nvarchar(200)\n\t\tdeclare @trans_out_id int\n\t\t\n\t\tset @trans_out_id=@uuid\n\t\t--set @trans_out_id = 1 --@uuid\n\t\tif @trans_out_id is null \n\t\t\tbegin\n\t\t\t\texec sp_api_modal_alert N'Er is geen correcte transport out referentie. (neem evt. contact op met uw consultant)'\n\t\t\t\texec sp_api_modal_clear\n\t\t\t\treturn\n\t\t\tend\n\t\tset @filename=concat('foto_',@main_db.dbo.char_left(@user,'@'),'_',@main_db.dbo.DT_FILENAME(GETDATE()))\n\t\t--exec sp_api_toast @filename\n\t\tEXEC @main_db.dbo.sp_api_modal_file @name = N'@filename', @to_file_context = 'wms_out_transport', @to_file_context_id = @trans_out_id,@filename = @filename\n\t\t\t, @category = 'pallet_foto' ,@resize_max = 2048, @resize_quality = 45,@api_files_id = @api_files_id OUT\n\t\tIF @api_files_id > 0 EXEC sp_api_modal_value N'@filename'\n\t\treturn\n\tend\n \n if @button_choose ='Conform'\n\tbegin\n\t\t--230703 dit stukje is er voor gezet om af te dwingen dat er eerst een geldige SAMPLE wordt gemaakt d.m.v. PALLET LABEL SCAN\n\t\t--230706 aangepast, controleert of er minimaal 1 geldige scan is met container, artikel en w_lot overeenkomst\n\t\tif not exists(select 1 from wms_micro_outbound where transport_id=@uuid) \n\t\t\tbegin --deze outbound is geen micro outbound, dus een normale outbound => dwing af dat er eerst een pallt scan wordt gedaan\n\t\t\t\tif not exists(select * from q_wms_out_samples \n\t\t\t\t\t\t\t\twhere xtransport_id=@uuid \n\t\t\t\t\t\t\t\t\tand out_stock_id in (select xstock_id from q_wms_out_requested where xtransport_id=@uuid) -- zelfde artikel !\n\t\t\t\t\t\t\t\t\tand w_lot_id in(select w_lot_id from q_wms_out_requested where xtransport_id=@uuid) --minimaal zelfde container\n\t\t\t\t\t\t\t\t\tand bl_id in(select bl_id from q_wms_out_requested where xtransport_id=@uuid) --minimaal zelfde BL !\n\n\t\t\t\t\t\t\t) --and info='oke') --TMP !!\n\t\t\t\t\tBEGIN --kennelijk (nog) geen correcte pallet gecand..\n\t\t\t\t\t\texec sp_api_toast N'NO VALIDATION YET; SCAN THE PALLET-LABEL FIRST! (SAMPLE)'\n\t\t\t\t\t\treturn\n\t\t\t\t\tEND\n\t\t\tend\n\n\t\tELSE --het is een micro outbound\n\t\t\tBEGIN\n\t\t\t\texec sp_api_toast N'micro outbound'\n\t\t\tEND\t\n\n\n\t\n\t\tupdate wms_io \n\t\t\tset status='CONFORM' \n\t\t\t\t,conform_user=@USER\t\t--230626\n\t\t\t\t,conform_dt=getdate()\t--230626\n\t\twhere out_transport_id=@uuid and in_out='OUT' --230316 dit kunnen meerdere regels zijn (bij multi-item-outbound)\n\t\tupdate xtransport set completed=1 where id=@uuid\n\t\tset @link_tracy=concat(@origin,N'/wms_out_transport?id=',@uuid,' ') --meegegeven parameter\n\t\tset @html=concat(N'De outbound met referentie ',(select transportinfo from xtransport where id=@uuid),' / ',(select top 1 transport_details from dbo.tr_stuff \nwhere transport_id=@uuid),' is conform verwachting verladen naar de klant. '\n\t\t\t\t\t\t,'<p><a href=\"',@link_tracy,'\" target=_blank>click hier</a>'\n\t\t\t\t\t\t)\n\n\t  \t--PROJECT CALL !!\n  \t\t--230428 GEEN OUTBOUND MAIL MEER NAAR RWS =>    EXEC sp_api_email @to = N'outbound@rwsbv.com',@subject = N'outbound conform & completed....',@body = N'tracy is the best',@html = @html\n\n\n\t\t--voeg evt foto toe\t\t\n--\t\tdeclare @gofoto nvarchar(4000)=concat(N'/wms_out_transport/',@uuid)\n\t\texec sp_api_goto @path=@gofoto\n\n\t\texec sp_api_modal_clear\n\t\treturn\n\tend\n\n\n if @button_choose ='Not_Conform'\n\tbegin\n\t\tDECLARE @opmerking nvarchar(max),@button22 nvarchar(128)\n\t\texec sp_api_modal_text N'What is wrong with this outbound loading?'\n\t\tEXEC sp_api_modal_input @name = '@opmerking', @value = @opmerking OUT --,@inline = 1\n\t\tEXEC sp_api_modal_button @name='@button22',@value = 'Save', @valueout = @button22 OUT,@class='btn-danger',@key='Enter'\n\t\tIF @button22 IS NULL RETURN\n\t\t\n\t\t\n\t\tupdate wms_io set status='NOT CONFORM' where out_transport_id=@uuid and in_out='OUT' --out check extra zekerheid, hoewel er maar 1 id is natuurlijk\n\t\tupdate xtransport set completed=0 where id=@uuid\n\t\tset @link_tracy=concat(@origin,N'/wms_out_transport?id=',@uuid,' ') --meegegeven parameter\n\t\tset @html=concat(N'Er zijn verschillen bij de outbound met referentie ',(select transportinfo from xtransport where id=@uuid),' / ',(select top 1 transport_details from dbo.tr_stuff \nwhere transport_id=@uuid),'. '\n\t\t\t\t\t\t,'<p>De opmerking is :',@opmerking,'<p>'\n\t\t\t\t\t\t,'<p><a href=\"',@link_tracy,'\" target=_blank>click hier</a>'\n\t\t\t\t\t\t)\n\n\t  \t--PROJECT CALL !!\n  \t\t--230428 GEEN OUTBOUND MAIL MEER NAAR RWS =>      \t\tEXEC sp_api_email @to = N'outbound@rwsbv.com',@subject = N'outbound NOT COFORM....',@body = N'tracy is the best',@html = @html\n\n\t\texec sp_api_modal_clear\n\t\treturn\n\tend\n\nif @button_choose ='Pallet_Sample'\n\tbegin\n\t\tEXEC sp_api_modal_qr_scanner @name=N'@sampleqrscanner',@value = @sampleqrscanner OUT\n\t\tIF @sampleqrscanner IS NULL RETURN\n\t\texec sp_api_modal_text @sampleqrscanner\n\t\tIF left(@sampleqrscanner,3) = 'ps:'\n\t\t\tBEGIN\n\t\t\t\tset @pal_id=right(@sampleqrscanner,len(@sampleqrscanner)-3) \n\t\t\t\t--230701 registreer sample\n\t\t\t\texec IINE_wms_out_samples   \n\t\t\t\t\t@user=@user\n    \t\t\t\t,@w_pallet_id =@pal_id\n    \t\t\t\t,@xTransport_id =@uuid\n\n\t\t\t\t\n\t\t\t\tif exists(select * from pallet_status \n\t\t\t\t\t\t\twhere --id=@pal_id\tAND -- ff niet lullig doen als het een andere pallet uit dezelfde container is..\n\t\t\t\t\t\t\t\tout_transport_id=@uuid \n\t\t\t\t\t\t\t\t--and artikel is oke\n\t\t\t\t\t\t)\n\t\t\t\t\tEXEC sp_api_modal_text N'GOED',N'h1'\n\t\t\t\tELSE\n\t\t\t\t\tEXEC sp_api_modal_text N'VERKEERDE PALLET!',N'h1'\n\t\t\t\t\n\t\t\tEND\n\t\tELSE\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_text N'SCAN A PALLET LABEL!',N'h1'\n\t\t\t\t--EXEC sp_api_modal_text @sampleqrscanner,N'h1'\n\t\t\t\t\n\t\t\tEND\n\tend\n\nif @button_choose ='Barcodes' --230705 verzamelde codes voor de klant in extene textfile\n\tbegin\n\t\tdeclare @barcodes nvarchar(max)\n\t\t--231017 was:\n\t\t--EXEC sp_api_modal_scanner @barcodes = 1, @value = @barcodes OUT\n\n\t\t--231017 nw\n\t\t\t-- @button_choose_2 nvarchar(max)= null, @button_laser_klaar nvarchar(max)= null\n\t\t\n\t\texec sp_api_modal_text N'Select your \"Scan Device\"'\n\t\tEXEC sp_api_modal_choose @list = N'use_camera,use_laser_scanner',@value = @button_choose_2 OUT, @button_class='secondary'\n\t\tif @button_choose_2 is null RETURN\n\t\tif @button_choose_2 = N'use_camera'\n\t\t\tEXEC sp_api_modal_scanner @barcodes = 1, @value = @barcodes OUT, @video_width= 1200\n\t\tif @button_choose_2 = N'use_laser_scanner'\n\t\tbegin\t\n\t\t\tEXEC sp_api_modal_input @name = '@Pallet_serials', @value = @barcodes OUT ,@type = 'textarea', @focus=1 --,@inline = 1\n\t\t\tEXEC sp_api_modal_button @name='@button_laser_klaar',@value = 'Save Pallet Scans', @valueout = @button_laser_klaar OUT,@class='btn-danger',@key='Enter'\n\t\t\tif @button_laser_klaar is null return\n\t\tend\t\t\n\n\n\n\n\t\tIF NULLIF(@barcodes,'') IS NOT NULL\n\t\t\tBEGIN\n\t\t\t\tset @barcodes=concat('Scanned codes at ',getdate(),char(13),@barcodes,'')\n\t\t\t\tDECLARE @name nvarchar(128) = N'outbound_barcodes.txt'\n\t\t\t\t\t,@base64data nvarchar(max) = dbo.base64encode(CONVERT(varbinary(max),CONVERT(varchar(max),@barcodes)))\n\t\t\t\tEXEC sp_sys_file_upload_base64 @base64data = @base64data,@name = @name\n\t\t\t\t\t,@description = N'Scanned barcodes at outbound'\n\t\t\t\t\t,@mimetype = N'text/plain'\n\t\t\t\t\t,@context = N'wms_out_transport'\n\t\t\t\t\t,@context_id = @uuid\n\t\t\t\t\t,@category = N'extern' --6 (maar in wms is dat 3 dus oppassen met id's!!)\n\n\t\t\t\tEXEC sp_api_modal_clear\n\t\t\tEND \n\tend\t",
            "action_id": 491,
            "action_name": "#qr_action_verwerk_outbound_transport",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_menu_info",
            "action_id": 492,
            "action_name": "sys_menu_info",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_performance_listview @card_id",
            "action_id": 493,
            "action_name": "sys_performance_listview",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_file_preview @card_name,@id,@file_id",
            "action_id": 494,
            "action_name": "sys_file_preview",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-------------------------------------------------------------\n--\t#qr_action_pallet_sticker scanner action handler \n--\tpre declare: @uuid nvarchar(max), @button_choose nvarchar(max)= null,@choose_list nvarchar(max)=null\n-------------------------------------------------------------\ndeclare @html nvarchar(4000) \ndeclare @link_tracy nvarchar(4000)=NULL\ndeclare @label nvarchar(4000)= (select pallet_label from w_pallet where id=@uuid)--@main_db.dbo.key_right(@uuid,N'pallet_label=') --@label wordt nu rechts van pallet_label=\ndeclare @kop nvarchar(512)\n--exec sp_api_toast @label\n--231009 pos tonen\ndeclare @t nvarchar(400)= (select concat('Pos: ',position_code) from w_pallet where id=@uuid)\nexec sp_api_modal_text @t ,@class='h2'\n\nset @choose_list=concat(N'',N'pallet_positie,container_positie,toon_details,replenish,toon_serials')\nEXEC sp_api_modal_choose @list = @choose_list,@value = @button_choose OUT\n\nif @button_choose is null return\n\n\t--maak compatible:\n\tdeclare @ramp nvarchar(20)\n\tdeclare @position_code nvarchar(20)=(select position_code from w_pallet where id=@uuid)\n\tdeclare @button nvarchar(128)\n\tdeclare @container_id int=(select w_lot_id from w_pallet where id=@uuid)\n\tdeclare @warehouse_id int = (select warehouse_id from q_lot where id=@container_id)\n\tdeclare @Tx nvarchar(100)\n----------------------------------------------------------------WIJZIG PALLET POSITIE \nif @button_choose =N'pallet_positie'\n\tbegin\n\t\n\t--dit is copy code van inbound positie actie\n--\t\tset @ramp=(select ramp from w_lot where id= @container_id)\n\t\texec sp_api_modal_text N'Wijzig de positie van deze pallet (dus niet alle pallets)'\n--\t\tEXEC sp_api_modal_input @name='ramp',@max=20, @value=@ramp OUT,@select=1,@Class='w-24 m-1'\n\t\tEXEC sp_api_modal_input @name='position_code',@max=10, @value= @position_code OUT,@select=1,@Class='w-24 m-1'\n\t\tEXEC sp_api_modal_button @name='@button',@value = 'Opslaan', @valueout = @button OUT,@class='btn-danger',@key='Enter'\n\t\tif @button='Opslaan'\n\t\t\tbegin\n\t\t\t\n--\t\t\t\tupdate w_lot set ramp=@ramp where id= @container_id\n\t\t\t\n\t\t\t\t--naar boven gehaald ivm multi-card set @container_id={[p a l l e  t _ m o b i l  e].w_lot_id}\n\t\t\t\tif @container_id > 0 and @position_code > N''\n\t\t\t\t\tbegin\n--hele container\t\t\t\t\t\tupdate w_pallet set position_code=@position_code where w_lot_id=@container_id\n--een pallet\n\t\t\t\t\t\tupdate w_pallet set position_code=@position_code where id=@uuid--w_lot_id=@container_id\n\t\t\t\t\t\tset @position_code=upper(@position_code)\t\n\t\t\t\t\t\tset @Tx=concat(N'Nieuwe palletlokatie: ',@position_code)\n\t\t--\t\t\t\texec sp_api_modal_alert @Tx\n--\t\t\t\t\t\texec sp_api_toast @Tx\n\t\t\t\t\t\t\n\t\t\t\t\t\t-- 230207 bijwerken kruistabel met mogelijke positiecodes voor de bezettings overzichten\n\t\t\t\t\t\tif not exists(select * from position_map where warehouse_id=@warehouse_id and position_code=@position_code )\n\t\t\t\t\t\t\tbegin\n\t\t--230213 vervangen door : fill_position_map\n\t\t--\t\t\t\t\t\tinsert into position_map(warehouse_id,position_code)\n\t\t--\t\t\t\t\t\tvalues (@warehouse_id,@position_code)\n\t\t\t\t\t\t\t\texec fill_position_map --230213 --LET OP: @Main_DB bij INBOUND !\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t--230209 ook gelijk proberen te \"auto-mappen\" dat wil zeggen een normalized path (A-Z) =plus area geven (1-99)\n\t\t\t\t\t\t\t\t--230213 fill_position_map doet dit al.. exec position_mapper_auto\n\t\t\t\t\t\t\tend\n\t\t\t\t\tend\n\t\t\t\t\t\n\t\t\t\tif @container_id > 0 and @position_code = N''\t\n\t\t\t\t\tbegin\n\t\t\t\t\t\t--exec sp_api_modal_alert N'Er is geen nieuwe lokatiecode.'\n\t\t\t\t\t\texec sp_api_toast N'Er is geen nieuwe lokatiecode.'\n\t\t\t\t\tend\t\n\n\t\t\t\texec sp_api_modal_clear\n\t\t\tend\n\n\t\n\tend\n\nif @button_choose =N'replenish'\t\t-- 230817 GELIJK VERPLAATSEN NAAR MICRO PICKLOKATIE EN PALLET AFSTAPELBAAR MARKEREN (REPLENISHEN)\n\t\t\t\t\t\t\t\t\t-- de pallet krijgt een nieuwe positie en wordt gelijk een afstapelbare pallet (micro_pick_allowed)\n\tbegin\n\t\n\t\texec sp_api_modal_text N'Geef de locatie op voor de afstapelbare pallet'\n\t\tEXEC sp_api_modal_input @name='position_code',@max=10, @value= @position_code OUT,@select=1,@Class='w-24 m-1'\n\t\tEXEC sp_api_modal_button @name='@button',@value = 'Opslaan', @valueout = @button OUT,@class='btn-danger',@key='Enter'\n\t\tif @button='Opslaan'\n\t\t\tbegin\n\t\t\t\tif @container_id > 0 and @position_code > N''\n\t\t\t\t\tbegin\n\t\t\t\t\t\tupdate w_pallet set position_code=@position_code, micro_pick_allowed=1 where id=@uuid   --PICK ALLOWED = 1\n\t\t\t\t\t\tset @position_code=upper(@position_code)\t\n\t\t\t\t\t\tset @Tx=concat(N'Nieuwe palletlokatie: ',@position_code)\n\t\t\t\t\t\t--LET OP: PICLOKATIES ZIJN * NIET * GENORMALISEERD\n\t\t\t\t\tend\n\t\t\t\t\t\n\t\t\t\tif @container_id > 0 and @position_code = N''\t\n\t\t\t\t\tbegin\n\t\t\t\t\t\t--exec sp_api_modal_alert N'Er is geen nieuwe lokatiecode.'\n\t\t\t\t\t\texec sp_api_toast N'POSITIE??'\n\t\t\t\t\tend\t\n\n\t\t\t\texec sp_api_modal_clear\n\t\t\tend\n\n\t\n\tend\n\n----------------------------------------------------------------WIJZIG CONTAINER POSITIE \nif @button_choose =N'container_positie'\n\tbegin\n\t\n\t--dit is copy code van inbound positie actie\n\t\tset @ramp=(select ramp from w_lot where id= @container_id)\n\t\tset @tx=concat(N'Wijzig de positie van ALLE PALLETS van container ',(select container_number from w_lot where id=@container_id))\n\t\texec sp_api_modal_text @tx\n\t\tEXEC sp_api_modal_input @name='ramp',@max=20, @value=@ramp OUT,@select=1,@Class='w-24 m-1'\n\t\tEXEC sp_api_modal_input @name='position_code',@max=10, @value= @position_code OUT,@select=1,@Class='w-24 m-1'\n\t\tEXEC sp_api_modal_button @name='@button',@value = 'Opslaan', @valueout = @button OUT,@class='btn-danger',@key='Enter'\n\t\tif @button='Opslaan'\n\t\t\tbegin\n\t\t\t\n\t\t\t\tupdate w_lot set ramp=@ramp where id= @container_id\n\t\t\t\n\t\t\t\t--naar boven gehaald ivm multi-card set @container_id={[p a l l e  t _ m o b i l  e].w_lot_id}\n\t\t\t\tif @container_id > 0 and @position_code > N''\n\t\t\t\t\tbegin\n--hele container\t\t\t\t\t\t\n\t\t\t\t\t\tupdate w_pallet set position_code=@position_code where w_lot_id=@container_id\n--een pallet\n--\t\t\t\t\t\tupdate w_pallet set position_code=@position_code where id=@uuid--w_lot_id=@container_id\n\n\t\t\t\t\t\tset @position_code=upper(@position_code)\t\n\t\t\t\t\t\tset @Tx =concat(N'ALLE Pallets van de container zijn nu geregistreerd op lokatie: ',@position_code)\n\t\t--\t\t\t\texec sp_api_modal_alert @Tx\n--\t\t\t\t\t\texec sp_api_toast @Tx\n\t\t\t\t\t\t\n\t\t\t\t\t\t-- 230207 bijwerken kruistabel met mogelijke positiecodes voor de bezettings overzichten\n\t\t\t\t\t\tif not exists(select * from position_map where warehouse_id=@warehouse_id and position_code=@position_code )\n\t\t\t\t\t\t\tbegin\n\t\t--230213 vervangen door : fill_position_map\n\t\t--\t\t\t\t\t\tinsert into position_map(warehouse_id,position_code)\n\t\t--\t\t\t\t\t\tvalues (@warehouse_id,@position_code)\n\t\t\t\t\t\t\t\texec fill_position_map --230213 --LET OP: @Main_DB bij INBOUND !\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t--230209 ook gelijk proberen te \"auto-mappen\" dat wil zeggen een normalized path (A-Z) =plus area geven (1-99)\n\t\t\t\t\t\t\t\t--230213 fill_position_map doet dit al.. exec position_mapper_auto\n\t\t\t\t\t\t\tend\n\t\t\t\t\tend\n\t\t\t\t\t\n\t\t\t\tif @container_id > 0 and @position_code = N''\t\n\t\t\t\t\tbegin\n\t\t\t\t\t\t--exec sp_api_modal_alert N'Er is geen nieuwe lokatiecode.'\n\t\t\t\t\t\texec sp_api_toast N'Er is geen nieuwe lokatiecode.'\n\t\t\t\t\tend\t\n\n\t\t\t\texec sp_api_modal_clear\n\t\t\tend\n\n\t\n\tend\n\n----------------------------------------------------------------------TOON PALLETS\nif @button_choose = N'toon_serials'\nbegin\n\tselect item_serial_number into #serials from wms_micro_item where w_pallet_id=(select id from w_pallet where pallet_label=@label)\n\texec sp_api_modal_table @tmptable=N'#serials'\nend\n\n\n----------------------------------------------------------------------TOON PALLETS\nif @button_choose = N'toon_details'\n\tbegin\n\t\tif (select top 1 micro_pick_allowed from w_pallet where pallet_label=@label)=1\n\t\tBEGIN\n\t\t\texec sp_api_modal_text N'Dit is een replenished pallet (afstapelbaar)'\n\t\tend\n\n\t\tselect \n\t\tclient_code\t\n\t\t--,vendor_code\t\n\t\t,ffa_code\t\n\t\t--,in_completed\t\n\t\t--,out_completed\t\n\t\t--,in_transport_id\t\n\t\t--,in_date\t\n\t\t--,out_date\t\n\t\t,[container_number-]=container_number\t\t\n\t\t--,in_ref\t\n\t\t,[bl_number-]=bl_number\t\n\t\t--,house_bl\t\n\t\t,pallet_state\t\n\t\t,customs_state\t\n\t\t--,pal_in\t\n\t\t--,pal_out\t\n\t\t--,pal_stock\t\n\t\t--,ramp\t\n\t\t,[wms_item-]=wms_item\n\t\t--,micro_art_count\t\n\t\t--,art_kgn\t\n\t\t--,pallet_label\t\n\t\t,pallet_nr\t\n\t\t--,pallet_gross_weight\t\n\t\t--,Colli\t\n\t\t,position_code\t\n\t\t--,pallet_art_lotnr\t\n\t\t--,micro_pick_allowed\t\n\n\t\tinto #pal from @main_db.dbo.pallet_status where pallet_label=@label --231031 main_db ipv rws\n\t\tset @kop=(select top 1 concat(N'Container number: ',[container_number-]\t,', bl: ',[bl_number-]) from #pal \t)\n\t\texec sp_api_modal_text @kop, @class='h4'\n\t\tset @kop=(select top 1 concat(N'Article : ',[wms_item-]\t) from #pal \t)\n\t\texec sp_api_modal_text @kop, @class='h4'\n\t\texec sp_api_modal_table @tmptable=N'#pal',@print=1\n\tend\n ",
            "action_id": 500,
            "action_name": "#qr_action_pallet_sticker",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-----------------------------------------------------------\n-- 230127  \n-- mobile_scan; **MENU-ITEM** voer een actie uit op basis van een qr scan\n-- pre declare: @lastname,@button,@qrscanner\n-----------------------------------------------------------\n\nDECLARE @prefix nvarchar(max)\nDECLARE @uuid nvarchar(max)\nEXEC sp_api_modal_text N'Scanner',N'h1'\n--IF --1= 0 AND \n--@qrscanner IS NULL  --na post is dit gevuld\n--\tBEGIN\n\t\t--post direct als hij qr 'ziet'\nEXEC sp_api_modal_qr_scanner N'@qrscanner',@value = @qrscanner OUT, @use_camera=0\n--\t\tRETURN\n--\tEND\n\nSET @prefix = N'w_lot#'\nIF @qrscanner LIKE @prefix+'%'\n\tBEGIN\n\t\t--set @uuid = REPLACE(@qrscanner,@prefix,'')\n\t\tset @uuid=dbo.regex_match(right(@qrscanner,len(@qrscanner)-len(@prefix)),N'[0-z]+')\n\t\t--SET @uuid = 7\n\t\tEXEC #qr_action_loods_bevestiging_inslag @uuid\n\t\tRETURN\n\tEND\n\n--uitgebreid 230219 omdat oude palletstickers ook gelezen moeten kunnen worden\n-- hiermee kunnen de oude palletstickers met volledige url ook gelezen worden; vertaalt zich naar dezelfde functionaliteit als bij ps:<<pallet_id>>\nSET @prefix = concat(@origin,'/inbound/') --N'https://rws.tsql.app/inbound/' -- de palletsticker\nif left(@qrscanner,len(@prefix))=@prefix\n\tbegin \n\t\tdeclare @pallet_label nvarchar(256) = @main_db.dbo.get_url_param_val(@qrscanner,'pallet_label')\n\t\tif @pallet_label > N''\n\t\t\tBEGIN\n--\t\t\t\texecute sp_api_toast N'pallet sticker..'\n\t\t\t\tdeclare @pal_id int = (select id from w_pallet where pallet_label=@pallet_label)\n\t\t\t\tif @pal_id > 0 \n\t\t\t\t\tbegin\n\t\t\t\t\t\tEXEC #qr_action_pallet_sticker @uuid=@pal_id --230219\n\t\t\t\t\tend\n\t\t\t\tif isnull(@pal_id,0)=0\n\t\t\t\t\tbegin\n\t\t\t\t\t\texec sp_api_toast N'GEEN GELDIG PALLET LABEL.'\n\t\t\t\t\tend\t\t\n\t\t\t\tRETURN\n\t\t\tEND\n\tend\t\n--230217 nieuw\nSET @prefix = N'ps:' -- de palletsticker\nIF @qrscanner LIKE @prefix+'%'\n\tBEGIN\n--\t\texecute sp_api_toast N'pallet sticker..'\n\t\t--set @uuid = REPLACE(@qrscanner,@prefix,'')\n\t\tset @uuid=dbo.regex_match(right(@qrscanner,len(@qrscanner)-len(@prefix)),N'[0-z]+')\n\t\tEXEC #qr_action_pallet_sticker @uuid\n\t\tRETURN\n\tEND\n\n\nSET @prefix = N'out_trans#'\nIF @qrscanner LIKE @prefix+'%'\n\tBEGIN\n--\t\tset @uuid = REPLACE(@qrscanner,@prefix,'')\n\t\tset @uuid=dbo.regex_match(right(@qrscanner,len(@qrscanner)-len(@prefix)),N'[0-z]+')\n\n\t\t--SET @uuid = 7\n\t\tEXEC #qr_action_verwerk_outbound_transport @uuid ,@origin =@origin --foto?\n\t\tRETURN\n\tEND\n--EXEC sp_api_modal_qr_scanner N'@qrscanner',@value = @qrscanner OUT\nIF @qrscanner Is NOT NULL\n\tBEGIN\n\t\tEXEC sp_api_modal_text N'Onbekende code',N'h5'\n\t\tEXEC sp_api_modal_text @qrscanner\n\tEND\nEXEC sp_api_modal_value N'@qrscanner'\n/*\n\n\t--@qrscanner:  bonnetje#34535-345234-2356-234-342\nEXEC sp_api_modal_text @qrscanner,N'h5'\nEXEC sp_api_modal_input @name = '@qrscanner', @value = @qrscanner OUT --,@inline = 1\nEXEC sp_api_modal_text 'Doe er wat mee'\nEXEC sp_api_modal_button @name='@button',@value = 'Save', @valueout = @button OUT,@class='btn-danger',@key='Enter'\n--IF @button IS NULL RETURN\n*/",
            "action_id": 504,
            "action_name": "Scanner",
            "source_table": "api_actions"
        },
        {
            "sql_source": "---------------------------------------------------------------------\n--\tglobal project action: #warehouse \n--\tpredeclare @warehouse_id int OUT\n---------------------------------------------------------------------\nexec sp_api_modal_text N'Choose warehouse'\n\n\tSELECT DISTINCT \n\t[Id] = ID \n\t,[Name] = LocationCode \n\tINTO #templocation FROM Xlocation WHERE company_id in (select id from xtenantkey)\n\tEXEC sp_api_modal_select_table @tmptable = N'#templocation',@name='Kies een lokatie',@value = @warehouse_id OUT,@top = 50,@placeholder = N'Kies een lokatie',@no_isam = 1,@focus=1\n",
            "action_id": 510,
            "action_name": "#warehouse",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_modal @class=N'w75',@printStyle=N'font-size:70%',@landscape=1  -- ;width:105mm;height:148mm\r\ndeclare @ei nvarchar(4000)=TRY_CAST(session_context(N'context_extra_info') AS [nvarchar](4000))\r\n--declare @p nvarchar(4000)=LEFT(@ei, CHARINDEX('#',@ei) - 1) \r\ndeclare @T [nvarchar](4000)= concat(N'Tracy Report Support Link: ',@ei)\r\nexec sp_api_modal_text @t",
            "action_id": 561,
            "action_name": "#groot100",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-------------------------------------------------------------\r\n-- #qr_action_picklist -- scanner action handler\r\n-- pre declare: @uuid int, @button_choose nvarchar(max)= null, @v nvarchar(max) = null, @b2 nvarchar(max) = null, @b3 nvarchar(max) = null\r\n-- DEV DEV DEV\r\n-------------------------------------------------------------\r\ndeclare @origin nvarchar(512)='https://dev.agfx.nl' --RAAR?? BESTAAT TOCH OVERAL NU ????\r\ndeclare @hTML nvarchar(4000) \r\ndeclare @link_tracy nvarchar(4000)=NULL\r\ndeclare @da_ctr int, @picked_amt int\r\ndeclare @t1 nvarchar(512)\r\nset @t1=(select concat(ctrtotal,N' colli ',hi_) from q_xtransactionheader where id=@uuid)\r\nexec sp_api_modal_text @t1\r\nEXEC sp_api_modal_choose @list = N'Info,Niet_Conform,Pick',@value = @button_choose OUT,@startkey=2\r\nif @button_choose is null return\r\n\r\n if @button_choose ='Pick'\r\n\tbegin\r\n\t\tdeclare @ctr2 int\r\n\t\tdeclare @continue bit =1\r\n\t\twhile @continue=1 and exists(select * from xctrtotals ctrt\r\n\t\t\t\t\t\tleft join xPalletDetail PD on PD.ctr_id=ctrt.ctr_id\r\n\t\t\t\t\t\twhere ctrt.cth_id=@uuid AND pd.ctr_id is NULL --detail bestaat nog niet\r\n\t\t\t\t\t)\r\n\t\t\t\t\r\n\t\t\tBEGIN\r\n\t\t\t\tset @ctr2=(select top 1 ctrt.ctr_id from xctrtotals ctrt\r\n\t\t\t\t\t\t\tleft join xPalletDetail PD on PD.ctr_id=ctrt.ctr_id\r\n\t\t\t\t\t\t\twhere ctrt.cth_id=@uuid AND pd.ctr_id is NULL --detail bestaat nog niet\r\n\t\t\t\t\t\t\t)\r\n\t\t\t\tif @ctr2 is null set @continue=0\r\n\t\t\t\tif @ctr2 >0\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\tif not exists(select * from xpalletdetail where ctr_id=@ctr2)\r\n\t\t\t\t\t\t\tbegin\r\n\t\t\t\t\t\t\t\tinsert into xPalletDetail (ctr_id) values(@ctr2) \r\n\t\t\t\t\t\t\tend\t\r\n\t\t\t\t\tend\t\t\t\r\n\r\n\t\t\tEND\t\r\n\t\tif @continue=1\r\n\t\t\tBEGIN\r\n\t\t\t\tSELECT \tid = pd.id\r\n\t\t\t\t\t\t,name = concat_ws(' - ',concat(isnull(pd.mappedAmount,0),'/',d2.amount),d2.inv_desc,d2.[size],d2.xbrandcode,d2.origin_code)\r\n\t\t\t\t\t\t,selected = 0 \r\n\t\t\t\t\t\t,ctr_id=pd.ctr_id\r\n\t\t\t\t\t\t,ctr_amt =d2.amount\r\n\t\t\t\t\tINTO #picked \r\n\t\t\t\t\tFROM xpalletdetail pd\r\n\t\t\t\t\t\tjoin q_xtransactiondetail d2 on d2.id=pd.ctr_id\r\n\t\t\t\t\twhere pd.ctr_id in(select ctr_id from xctrtotals where cth_id=@uuid)\r\n\t\t\t\tEXEC sp_api_modal_choose @tmptable = N'#picked',@orderby = N'ORDER BY 2' ,@value=@V out,@select_all_button = 1--,@name_filter = @name_filter\r\n\t\t\t\texec sp_api_toast @V\r\n\t\t\t\t--update xpalletdetail set mappedAmount\r\n\t\t\t\t\r\n\t\t\t\tselect name into #sel from #picked where selected=1\r\n\t\t\t\texec sp_api_modal_text N'geselecteerd:'\r\n\t\t\t\texec sp_api_modal_table @tmptable = N'#sel'\r\n\t\t\t\t\r\n\t\t\t\t--butt\r\n\t\t\t\tEXEC sp_api_modal_button @name='@b2',@value = 'Go', @valueout = @b2 OUT,@class='btn-danger',@key='Enter'\r\n\t\t\t\tif @b2 is null return\r\n\t\t\t\t--button uitgespeeld? dan verder naar aantal edit\r\n\t\t\t\tSELECT id=ctr_id\r\n\t\t\t\t\t,[Omschrijving ] = name\r\n\t\t\t\t\t,[Aantal ] = (select coptotal from q_xtransactiondetail where id=ctr_id)\r\n\t\t\t\t\t,[Selected] = (select amount from q_xtransactiondetail where id=ctr_id) -- probeer altijd het totaal van de ctr te 'picken'\r\n\t\t\t\tINTO #tmpmodal\r\n\t\t\t\tFROM #picked WHERE #picked.selected=1\r\n\t\t\t\tEXEC sp_api_modal_table_update @tmptable=N'#tmpmodal',@focusx=3,@sort='Omschrijving'\r\n\r\n\t\t\t\tEXEC sp_api_modal_button @name='@b3',@value = 'Confirm Pick', @valueout = @b3 OUT,@class='btn-danger',@key='F6'\r\n\t\t\t\tif @b3 is null return\r\n\t\t\t\tif @b3='Confirm Pick'\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\twhile exists( select * from #tmpmodal )\r\n\t\t\t\t\t\t\tBEGIN\r\n\r\n\t\t\t\t\t\t\t\tselect @da_ctr=id ,@picked_amt=Selected from #tmpmodal --?? @GB ?? HELLUP... SELECTED GEEFT HET INITIELE CTR AANTAL; NIET HET GEWIJZIGDE AANTAL IN DE TMPTABLE\r\n\t\t\t\t\t\t\t\texec iu_xPalletDetail @ctr_id=@da_ctr,@mapped_amount=@picked_amt\r\n\t\t\t\t\t\t\t\tdelete from #tmpmodal where id=@da_ctr\t\r\n\r\n\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\texec sp_api_modal_clear\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\tEND\r\n\t\t\t\treturn\r\n\r\n\t\t\tEND\t\r\n\tend\r\n\r\n if @button_choose ='Info'\r\n\tbegin\r\n\r\n\tselect Amount,\tPrice,\trowPrice,\tDescription\r\n\t\tinto #rep from code_ctr_stock\r\n\twhere transactionheader_id=@uuid\t\r\n\texec sp_api_modal_table @tmptable\t=N'#rep'\r\n/*\t\r\n\t\tupdate wms_io set status='CONFORM' where w_lot_id=@uuid and in_out='IN' \r\n\r\n\t\t--hier mail naar inbound@rws met een link naar de container zodat het verder afgewerkt en bevestigd kan worden naar de klant subject INSLAG CONFORM\r\n\t\tset @link_tracy=concat(N'https://rws.tsql.app/inbound?id=',@uuid,' ') --meegegeven parameter\r\n\t\tset @html=concat(N'Container ',(select container_number from w_lot where id=@uuid),' is conform verwachting ingeslagen in de loods. '\r\n\t\t\t\t\t\t,'Ga naar de betreffende container in Tracy voor de laatste afhandeling. Daarbij kunt u de klant bevestigen via de email button.'\r\n\t\t\t\t\t\t,'<p><a href=\"',@link_tracy,'\" target=_blank>click hier</a>'\r\n\t\t\t\t\t\t)\r\n\r\n\t  \t--PROJECT CALL !!\r\n  \t\tEXEC sp_api_email @to = N'inbound@rwsbv.com',@subject = N'inbound conform, s.v.p. afwerken..',@body = N'tracy is the best',@html = @html\r\n\r\n\t\texec sp_api_modal_clear\r\n*/\t\t\r\n\t\treturn\r\n\tend\r\n\r\n \r\nif @button_choose ='Niet_Conform'\r\n\tbegin\r\n\t\tDECLARE @opmerking nvarchar(max),@button22 nvarchar(128)\r\n\t\tdeclare @to_user nvarchar(2000) = @user-- maar normaal ophalen uit de order isnull((select top 1 insuser from xtransactionheader where id=@uuid),'fallback@tracy.nu')\r\n\t\texec sp_api_modal_text N'opmerking op de order'\r\n\t\tEXEC sp_api_modal_input @name = '@opmerking', @value = @opmerking OUT --,@inline = 1\r\n\t\tEXEC sp_api_modal_button @name='@button22',@value = 'Save', @valueout = @button22 OUT,@class='btn-danger',@key='Enter'\r\n\t\tIF @button22 IS NULL RETURN\r\n\r\n\t\t--UPDATE xtransactionheader SET   logistic= @opmerking WHERE Id = @uuid\r\n\r\n\t--concat(@origin,'\r\n\t\tset @link_tracy=concat(isnull(@origin,N'https://anaco.agfx.nl'),'/verkoop/',@uuid,' ') -- kan ook naar lijst ?id=    meegegeven parameter\r\n\t\tset @html=concat(N'Let op: er is een probleem bij de pickbon. Het betreft order nummer ',(select concat(cth_id,' van ',tv_companyname) from xcthtotals where cth_id=@uuid),'. '\r\n\t\t\t\t\t\t,'Ga naar de betreffende order en pas deze aan.'\r\n\t\t\t\t\t\t,'<p>De door de loods geplaatste opmerking is :',@opmerking,'<p>'\r\n\t\t\t\t\t\t,'Als de registratie compleet is verwerkt dient u de klant nog de bevestigings mail te sturen via de email button'\r\n\t\t\t\t\t\t,'<p><a href=',@link_tracy,' target=_blank>click hier om direct naar de order te gaan.</a>'\r\n\t\t\t\t\t\t)\r\n\r\n\t  \t--PROJECT CALL !!\r\n  \t\tEXEC sp_api_email @to = @to_user,@subject = N'AFWIJKENDE PICKBON S.V.P AFWERKEN..',@body = N'tracy is the best',@html = @html\r\n\r\n\t\tEXEC sp_api_modal_clear\r\n\t\treturn\r\n\tend\r\n\r\n",
            "action_id": 562,
            "action_name": "#qr_action_picklist",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--------------------------------------------\r\n-- #set_country_name7 scanner action handler\r\n-- pre declare: @uuid int\r\n--\r\n--------------------------------------------\r\nEXEC sp_api_modal_text N'Header',N'h1'\r\nDECLARE @input nvarchar(max),@button22 nvarchar(128)\r\nEXEC sp_api_modal_input @name = '@input', @value = @input OUT --,@inline = 1\r\nEXEC sp_api_modal_button @name='@button22',@value = 'Save', @valueout = @button22 OUT,@class='btn-danger',@key='Enter'\r\nIF @button22 IS NULL RETURN\r\nUPDATE xCountry SET name_7 =  @input WHERE CountryId = @uuid\r\nEXEC sp_api_modal_clear",
            "action_id": 563,
            "action_name": "#set_country_name7",
            "source_table": "api_actions"
        },
        {
            "sql_source": "----------------------------------\r\n-- name: #stam\r\n-- submenu-items voor stamgegevens\r\n----------------------------------\r\nEXEC sp_api_modal_route @name='country',@cardname = 'country'\r\nEXEC sp_api_modal_route @name='product',@cardname = 'xproduct'\r\nEXEC sp_api_modal_route @name='adres',@cardname = 'adres'",
            "action_id": 564,
            "action_name": "#stam",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-------------------------\r\n-- @Supplier int OUT\r\n-------------------------\r\nexec sp_api_modal_text N'Leverancier'\r\nEXEC sp_api_modal_select @card_name = N'leverancier',@value = @Supplier OUT --, @reducer='1=1'",
            "action_id": 565,
            "action_name": "#Supplier",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_toast N'Boe!'\r\nEXEC sp_api_modal_input @name = '@lastname', @value = @lastname OUT --,@inline = 1\r\n",
            "action_id": 566,
            "action_name": "default_scan_code",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-------------------------------------------------------------------------------------------\n--\t220818 financi\u00eble_claim_afhandelen \n--\tcontext xClaim, ctr2\n--\tClaim verwerken tot kostenregistratie (die een credit factuur tot gevolg heeft)\n--\tcontext kan een xClaim registratie zijn, maar het kan ook direct op de betreffende CTR2\n--\t220823\tnu wordt ook gelijk de credit factuur gemaakt \n--\n--\tpre declare: @ModelCTR_ID int\t,@Amount int ,@Price float ,@TargetCTR_ID int, @toCTR int, @thdt int,@StockID int,@selectedTargetCTR int, @Button,@ClaimID,@CTR2_ID\n-------------------------------------------------------------------------------------------\n\ndeclare @ModelCTR_ID int\t\n\t\t,@Amount  nvarchar(200)\n\t\t,@Price float \n\t\t,@TargetCTR_ID int\n\t\t, @toCTR int\n\t\t, @thdt int\n\t\t,@StockID int\n\t\t,@selectedTargetCTR int\n\t\t, @Button nvarchar(200)\n\t\t,@ClaimID int\n\t\t,@CTR2_ID int\n\t\t,@retourAmount int = 0\n--dit is toch altijd? :: IF @ClaimID is NULL AND @CTR2_ID is NULL\n--\tbegin\n\t\t--context = xClaim?\n\t\tselect @ClaimID = id\n\t\t\t\t,@ModelCTR_ID =ctr_id\t \n\t\t\t\t,@Amount = claimAmount\n\t\t\t\t,@Price =claimPriceDiff \n\t\t\t\t,@retourAmount = ISNULL(retourAmount,0)\n\t\t\t\t--,@TargetCTR_ID int \n\t\t\tfrom Q_xClaim \n\t\t\twhere id = {[xClaim].id}\n\t\t\t\t\t--and retourAmount =0\n\t\t\t\t\tand\tstatus='New'\n\t\t\t\t\tand thdt=2 -- alleen op verkoop (vooralsnog)\n--\tend\nIF @retourAmount > 0 --oude methode met retour via ctrs\n\tBEGIN\n\t\t--EXEC sp_api_modal_action N'Afhandelen',@text=N'Retour colli! Je kunt deze claim hier [action]'\n\n\t\tDECLARE @claimAmount int\n\t\tDECLARE @claimPrice float\n\t\t--DECLARE @retourAmount int\n\t\tDECLARE @ctrAmount float\n\t\tDECLARE @ctrPrice float\n\n\t\tSET @ctrPrice = {[xclaim].ctr_price}\n\n\n\t\tSELECT @ctr_id = ctr_id\n\t\t \t\t,@claimReason = claimReason\n\t\t \t\t,@claimAmount = ISNULL(claimAmount,0)\n\t\t \t\t,@claimPrice = claimPrice\n\t\t \t\t,@retourAmount = ISNULL(retourAmount,0)\n\t\t \t\t--,@Description = Description\n\t\t \t\t,@client_id = client_id\n\t\t \t\t,@cth_id = cth_id\n\t\t \t\t,@counter_ctr_id = counter_ctr_id\n\t\t \t\t,@new_ctr_id = new_ctr_id FROM xClaim WHERE id = @id\n\n\t\t-- RH210212 ALS HET EEN INKOOP CTH IS DAN HIER AFBREKEN MET EEN MELDING??... want dit is verkoop claim afhandeling..\n\t\tIF @claimAmount > 0 AND (@claimPrice = @ctrPrice OR @claimPrice IS NULL)\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_clear N'Prijs is nul icm korting aantal!'\n\t\t\t\tRETURN\n\t\t\tEND\n\n\t\t \n\t\tIF @new_ctr_id IS NOT NULL OR @counter_ctr_id IS NOT NULL\n\t\t\tBEGIN\n\t\t\t\tEXEC sp_api_modal_clear N'Claim is reeds afgehandeld' \n\t\t\t\tRETURN\n\t\t\tEND\n\n\t\tIF (SELECT count(*) FROM xClaim WHERE @ctr_id = ctr_id) > 1 --GB220208 DONE, afsplitsen of iets dergelijks...\n\t\t\tBEGIN\n\t\t\t\tUPDATE new SET cth_id = TransactionHeader_ID ,ctr_id = old.new_ctr_id\n\t\t\t\tFROM xClaim new\n\t\t\t\tJOIN xClaim old ON old.ctr_id = new.ctr_id AND old.status != 'New' AND new.status = 'New'\n\t\t\t\tJOIN xTransactionDetail ctr ON ctr.id = old.new_ctr_id\n\t\t\t\tWHERE new.id = @id\n\t\t\t\tEXEC sp_api_toast N'Claim naar eerdere claim verplaatst'\n\t\t\t\tEXEC sp_api_modal_clear\n\t\t\t\t--EXEC sp_api_modal_restart\n\t\t\t\t--EXEC sp_api_modal_clear N'Er zitten meerdere claims op de verkoopregel, vraag Tracy om hulp!'\n\t\t\t\tRETURN\n\t\t\tEND\n\n\t\t--SET @ctr_id = {[xclaim].ctr_id}\n\t\tSET @ctrAmount = {[xclaim].ctr_amount}\n\t\tSET @Description = {[xclaim].Description}\n\t\t/*SET @claimReason = {[xclaim].claimReason}*/\n\t\tSET @class = N'h5 text-muted'\n\t\tSET @text = CONCAT(N'Claim afhandelen - ',@Description)\n\t\tEXEC sp_api_modal_text @text,N'h3 text-muted'\n\n\t\tSET @text = CONCAT(N'Claim reden: ',@claimReason)\n\t\tEXEC sp_api_modal_text @text,@class\n\n\t\tSET @text = CONCAT(N'Korting aantal: ',@claimAmount)\n\t\tEXEC sp_api_modal_text @text,@class\n\n\t\tSET @text = CONCAT(N'Retour aantal: ',@retourAmount)\n\t\tEXEC sp_api_modal_text @text,@class\n\n\t\tSELECT id,[Leverancier ] = Leverancier,[LinkAantal ]=LinkAantal,Retour = 0,Korting = 0  INTO #ivlink FROM Q_IVLINK WHERE ITD = @ctr_id ORDER BY id\n\t\tUPDATE #ivlink SET Retour = @retourAmount,Korting = @claimAmount WHERE id = (SELECT min(id) FROM #ivlink)\n\t\tEXEC sp_api_modal_table_update @tmptable='#ivlink',@focusx=3\n\n\t\tDECLARE @claimAmountTodo int = @claimAmount\n\t\tDECLARE @retourAmountTodo int = @retourAmount\n\n\t\tDECLARE @isOk BIT = 1\n\t\tDECLARE @cursor CURSOR,@idval int,@LinkAantal int,@Retour int,@Korting int\n\t\tSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT id,[LinkAantal ],Retour,Korting FROM #ivlink\n\t\tOPEN @cursor;\n\t\tFETCH NEXT FROM @cursor INTO @idval,@LinkAantal,@Retour,@Korting\n\t\tWHILE @@FETCH_STATUS = 0\n\t\t\tBEGIN\n\t\t\t\tIF((@Retour + @Korting) > @LinkAantal) OR @Retour < 0 OR @Korting < 0  SET @isOk = 0\n\t\t\t\tSET @claimAmountTodo-=@Korting\n\t\t\t\tSET @retourAmountTodo-=@Retour\n\t\t\t\tFETCH NEXT FROM @cursor INTO @idval,@LinkAantal,@Retour,@Korting\n\t\t\tEND\n\t\tCLOSE @cursor;\n\t\tDEALLOCATE @cursor;\n\t\tSET @button_text = 'Verwerken'\n\t\tEXEC sp_api_modal_button @name='@button',@value = @button_text, @valueout = @button OUT,@class='btn-primary',@key='Enter'\n\t\tSET @class = N'h5 text-danger'\n\t\tIF @isOk = 0 EXEC sp_api_modal_text N'De verdeling is nog incorrect!',@class\n\t\tIF @claimAmountTodo <> 0 EXEC sp_api_modal_text N'De korting verdeling is incorrect!',@class\n\t\tIF @retourAmountTodo <> 0 EXEC sp_api_modal_text N'De retour verdeling is incorrect!',@class\n\n\t\tIF @button = @button_text AND @isOk = 1 AND @claimAmountTodo = 0 AND @retourAmountTodo = 0\n\t\t\tBEGIN\n\t\t\t\t--EXEC sp_api_modal_table @tmptable='#ivlink'\n\n\t\t\t\tSET @claim_cth_id = (SELECT min(id) FROM xTransactionHeader WHERE CounterParty_ID = @client_id AND status IN('openClaim','ReadyForInvoice') AND specialType = 1001)\n\t\t\t\t--SELECT @xIVLINKs = STRING_AGG(CAST(id as nvarchar(max)),',') FROM xIVLINK WHERE ITD = @ctr_id\n\n\t\t\t\tIF @claim_cth_id IS NULL\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\t--DECLARE @specialType int = @main_db.dbo.CthSpecialType('claim')\n\t\t\t\t\t\tEXEC @claim_cth_id = @main_db.dbo.CreateCTH2 @Client_ID = @client_id,@Status = 'ReadyForInvoice',@specialType = 'claim'\n\t\t\t\t\tEND\n\n\t\t\t\tIF @counter_ctr_id IS NULL\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tSET @set = CONCAT(N'stockMut=1,Amount = -Amount,TransactionHeader_ID = ',@claim_cth_id)\n\t\t\t\t\t\tEXEC @counter_ctr_id = sp_clone_record N'xTransactionDetail',@ctr_id,@set\n\t\t\t\t\t\tUPDATE xClaim SET counter_ctr_id = @counter_ctr_id WHERE id = @id\n\t\t\t\t\tEND\n\t\t\t\tIF @claimAmount > 0\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tSET @set = CONCAT(N'stockMut=1,Amount = ',@claimAmount,',Price=',@claimPrice,IIF(@claimPrice=0,',Pricetype=''ZERO''',''),',TransactionHeader_ID = ',@claim_cth_id)\n\t\t\t\t\t\tEXEC @new_ctr_id = sp_clone_record N'xTransactionDetail',@ctr_id,@set\n\t\t\t\t\t\tUPDATE xClaim SET new_ctr_id = @new_ctr_id WHERE id = @id\n\t\t\t\t\tEND\n\t\t\t\tDECLARE @NietRetour int = (@ctrAmount - @claimAmount) - @retourAmount\n\t\t\t\tIF @NietRetour > 0\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tSET @set = CONCAT(N'stockMut=1,Amount = ',@NietRetour,',Price=',@ctrPrice,IIF(@ctrPrice=0,',Pricetype=''ZERO''',''),',TransactionHeader_ID = ',@claim_cth_id)\n\t\t\t\t\t\tEXEC @new_retour_ctr_id = sp_clone_record N'xTransactionDetail',@ctr_id,@set\n\t\t\t\t\t\tUPDATE xClaim SET new_ctr_id = @new_retour_ctr_id WHERE id = @id\n\t\t\t\t\tEND\n\t\t\t\t\n\n\t\t\t\tSET @cursor = CURSOR LOCAL FAST_FORWARD FOR SELECT id,[LinkAantal ],Retour,Korting FROM #ivlink\n\t\t\t\tOPEN @cursor;\n\t\t\t\tFETCH NEXT FROM @cursor INTO @xIVLINK_id,@LinkAantal,@Retour,@Korting\n\t\t\t\tWHILE @@FETCH_STATUS = 0\n\t\t\t\t\tBEGIN\n\t\t\t\t\t\tIF @LinkAantal > 0\n\t\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\t\tSET @set = CONCAT(N'LinkAantal = -',@LinkAantal,',SK_ID = NULL, ITD = ',@counter_ctr_id)\n\t\t\t\t\t\t\t\tEXEC sp_clone_record N'xIVLINK',@xIVLINK_id,@set\n\t\t\t\t\t\t\tEND\n\t\t\t\t\t\tIF @Korting > 0\n\t\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\t\tSET @set = CONCAT(N'LinkAantal = ',@Korting,',SK_ID = NULL, ITD = ',@new_ctr_id)\n\t\t\t\t\t\t\t\tEXEC sp_clone_record N'xIVLINK',@xIVLINK_id,@set\n\t\t\t\t\t\t\tEND\n\t\t\t\t\t\tIF @Retour < (@LinkAantal - @Korting)\n\t\t\t\t\t\t\tBEGIN\n\t\t\t\t\t\t\t\tSET @NietRetour = (@LinkAantal - @Korting) - @Retour\n\t\t\t\t\t\t\t\tSET @set = CONCAT(N'LinkAantal = ',@NietRetour,',SK_ID = NULL, ITD = ',@new_retour_ctr_id)\n\t\t\t\t\t\t\t\tEXEC sp_clone_record N'xIVLINK',@xIVLINK_id,@set\n\t\t\t\t\t\t\tEND\n\t\t\t\t\t\tFETCH NEXT FROM @cursor INTO @xIVLINK_id,@LinkAantal,@Retour,@Korting\n\t\t\t\t\tEND\n\t\t\t\tCLOSE @cursor;\n\t\t\t\tDEALLOCATE @cursor;\n\t\t\t\tEXEC sp_api_modal_post N'xclaim','status','Processed',@id\n\t\t\t\tEXEC sp_api_modal_save N'xclaim',@id\n\t\t\t\tEXEC sp_api_modal_clear\n\t\t\t\t\n\t\t\tEND\n\n\t\tRETURN\n\tEND\nELSE\n\tBEGIN\n\t\t--context = ctr2?\n\t\tif @claimID is null and @CTR2_ID is null\n\t\t\t\t\tand @ModelCTR_ID is null \n\t\t\t\t\tand {[ctr2].id} is not NULL\n\t\t\t\t\tand {[xClaim].id} is NULL -- je mag per se niet op een xclaim staan als je ctr2 wilt boeken!\n\t\t\tbegin\n\t\t\t\tselect @CTR2_ID = id\n\t\t\t\t\t,@ModelCTR_ID =id\t \n\t\t\t\t\t,@Amount = Amount\n\t\t\t\t\t,@Price =Price \n\t\t\t\tfrom xtransactiondetail where id={[ctr2].id}\n\t\t\t\t\n\t\t\t\tif @ModelCTR_ID is not NULL\n\t\t\t\t\tbegin\n\t\t\t\t\t\t-- vanaf CTR2 direct vragen om credit aantal en prijs\t\t\n\t\t\t\t\t\tEXEC sp_api_modal_Text N'Credit aantal'\n\t\t\t\t\t\t\n\t\t\t\t\t\tEXEC sp_api_modal_input_decimal @name='Aantal',@value= @Amount OUT,@precision=18,@scale=0\n\t\t\t\t\t\tEXEC sp_api_modal_Text N'Credit prijs'\n\t\t\t\t\t\tset @Price=convert(float,@Price)\n\t\t\t\t\t\tEXEC sp_api_modal_input_decimal @name='Prijs',@value= @Price OUT ,@precision=18,@scale=2\n\t\t\t\t\tend\t\t\n\n\t\t\tend\n\n\t\tif @ModelCTR_ID is null\n\t\t\tbegin\n\t\t\t\texec sp_api_modal_alert N'xClaim is al afgehandeld.'\n\t\t\tend\n\t\t\n\t\t--oke verder...\n\n\t\tif @ModelCTR_ID >0 -- geldige claim details\n\t\t\t\tbegin\t\t\t\t\n\t\t\t\t\t--set @Amount=convert(int,@Amount)\n\t\t\t\t\tselect @sTOCKid=stock_id from xtransactiondetail where id=@ModelCTR_ID\n\t\t\t\t\t--controleer of er nog gecrediteerd kan worden op de order\n\t\t\t\t\tselect @thdt=(select tdt from xtransactionheader where id=(select transactionheader_id from xtransactiondetail where id=@ModelCTR_ID))\n\t\t\t\t\tif @thdt is null\n\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\t--npc\n\t\t\t\t\t\t\texec sp_api_modal_alert N'Ordertype kan niet worden bepaald. Actuie wordt afgebroken'\n\t\t\t\t\t\t\texec sp_api_modal_clear\n\t\t\t\t\t\t\treturn\n\t\t\t\t\t\tend\n\t\t\t\t\t--oke verder..\n\t\t\t\t\tif @thdt=1 -- inkoop credit (doen we nog niet)\n\t\t\t\t\t\tbegin\t\n\t\t\t\t\t\t\t--select @toCTR=select itd\n\t\t\t\t\t\t\texec sp_api_modal_alert N'Inkoop credit kan (nog) niet worden verwerkt..'\n\t\t\t\t\t\t\texec sp_api_modal_clear\n\t\t\t\t\t\t\treturn\n\n\t\t\t\t\t\tend\t\n\t\t\t\t\tif @thdt=2 -- verkoop\n\t\t\t\t\t\tbegin\t\n\t\t\t\t\t\t\tselect @toCTR=itd from ctr_linked_lot  --vtd is de partijregel; itd is de hieraan gelinkte verkoopregel\n\t\t\t\t\t\t\t\twhere itd=@ModelCTR_ID -- kijk aan welke partijen de ctr gelinkt is\n\t\t\t\t\t\t\t\t\tand linkaantal >= @Amount\n\t\t\t\t\t\t\t\t\tand cth1_status like N'openPur%'\n\n\t\t\t\t\t\t\t---------------------------------------------------------------------------------------------------------------------------------------------------\n\t\t\t\t\t\t\texec sp_api_modal_text N'Er wordt gefilterd op dit artikelnummer: (u kunt deze leeg maken en ENTER geven om op andere artikelen te kunnen boeken)'\n\t\t\t\t\t\t\tEXEC sp_api_modal_input @name='Gefilterd Artikel',@max=5, @value= @StockID OUT\n\t\t\t\t\t\t\tif @StockID='' set @StockID = NULL\n\t\t\t\t\t\t\t----------------------------------------------------------------------------------------------------------------------------------------------------\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tif @toCTR >0 -- de partij is nog open, je kunt de verkoop credit boeken \n\t\t\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\t\t\texec sp_api_modal_text N'De claim kosten kunnen op de originele verkoopregel worden geboekt'\n\t\t\t\t\t\t\t\t\tSELECT id=Id,name=concat(iif(id=@ModelCTR_ID,'*ORG*',''),' order: ',transactionheader_id, ' datum: ' ,TRANSACTIONDATE,' kostenpartij ' ,ll.lotnumber,' art: ',detail,' ',size) \n\t\t\t\t\t\t\t\t\t\tINTO #mt1\n\t\t\t\t\t\t\t\t\t\tFROM Q_xtransactiondetail ctr2 join ctr_linked_lot ll on ll.itd=ctr2.id\n\t\t\t\t\t\t\t\t\t\tWHERE (@sTOCKid is NULL or ctr2.stock_id = @sTOCKid)\n\t\t\t\t\t\t\t\t\tEXEC sp_api_modal_select_table @value = @selectedTargetCTR OUT ,@INITIAL_ID=@toCTR, @tmptable=N'#mt1'\n\t\t\t\t\t\t\t\tend\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tif @toCTR is NULL -- de gelinkte partij is niet meer open, je moet een alternatieve regel kiezen\n\t\t\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\t\t\texec sp_api_modal_text N'De claim kosten kunnen niet meer op de originele verkoopregel worden geboekt, want de gelinkte partij is al gesloten!'\n\t\t\t\t\t\t\t\t\tSELECT id=Id,name=concat('order: ',transactionheader_id, ' datum: ' ,TRANSACTIONDATE,' kostenpartij ',ll.lotnumber,' art: ',detail,' ',size )\n\t\t\t\t\t\t\t\t\t\tINTO #mt2 \n\t\t\t\t\t\t\t\t\t\tFROM Q_xtransactiondetail ctr2 join ctr_linked_lot ll on ll.itd=ctr2.id\n\t\t\t\t\t\t\t\t\t\tWHERE (@sTOCKid is NULL or ctr2.stock_id = @sTOCKid)\n\t\t\t\t\t\t\t\t\tEXEC sp_api_modal_select_table @value = @selectedTargetCTR OUT ,@INITIAL_ID=@toCTR, @tmptable=N'#mt2'\n\t\t\t\t\t\t\t\tend\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tif @selectedTargetCTR is null\n\t\t\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\t\t\texec sp_api_modal_text N'U moet een regel aanwijzen waar de kosten worden geboekt'\n\t\t\t\t\t\t\t\tend\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tEXEC sp_api_modal_button @name='@button',@value = 'F5_Verwerken', @valueout = @button OUT,@class='btn-danger',@key='F5'\n\t\t\t\t\t\t\tif @Button='F5_Verwerken' and @selectedTargetCTR >0\n\t\t\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\t\t\texecute @main_db.dbo.create_costreg_for_finmut  \n\t\t\t\t\t\t\t\t\t\t\t\t@ModelCTR_ID =@ModelCTR_ID\n\t\t\t\t\t\t\t\t\t\t\t\t, @Amount =@Amount\n\t\t\t\t\t\t\t\t\t\t\t\t, @Price =@Price \n\t\t\t\t\t\t\t\t\t\t\t\t,@TargetCTR_ID=@selectedTargetCTR --registreer de kosten op de targetCTR\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t--als het vanaf een claim komt:\n\t\t\t\t\t\t\t\t\tif @ClaimID is not NULL\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\tbegin\n\t\t\t\t\t\t\t\t\t\t\tupdate xclaim set status =N'finCostRegistered' where id=@ClaimID and status='New' --geef aan dat financiele kosten zijn geregistreerd\n\t\t\t\t\t\t\t\t\t\tend\t\n\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t--maak de credit factuur voor de klant\n\t\t\t\t\t\t\t\t\tdeclare @idstring nvarchar(500)=(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tSELECT STRING_AGG( ID, ',')  \n\t\t\t\t\t\t\t\t\t\t\t\t\t       From xcostregistration where deb_cred_4_ctr_id =@ModelCTR_ID and invrow_id is null\n\t\t\t\t\t\t\t\t\t\t\t\t\t  )     \n\t\t\t\t\t\t\t\t\texecute create_credit_invoice_CTH2_for_xcostregistration @IDS=@idstring\n\t\t\t\t\t\t\t\t\t--maak de credit factuur voor de klant -eind-\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\texec sp_api_modal_clear\n\t\t\t\t\t\t\t\tend\n\t\t\t\t\t\tend\t\n\t\t\t\tend\n\t\tEND\t",
            "action_id": 568,
            "action_name": "financi\u00eble_claim_afhandelen",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-------------------------------------\r\n-- mail_all_linked_files\r\n-------------------------------------\r\ndeclare @filename nvarchar(512) --240528\r\ndeclare @url nvarchar(512)\t\t--240528\r\ndeclare @mail_to nvarchar(256) = @user -- the user who is currently logged-in\r\nDECLARE @bodytext nvarchar(max) \r\nCREATE TABLE #files (filename nvarchar(4000),path nvarchar(4000))\r\nSELECT id,name FROM api_files WHERE context = @card_name AND context_id = @id\r\n\r\nDECLARE @cursor CURSOR,@idval INT\r\nSET @cursor = CURSOR LOCAL FAST_FORWARD FOR \r\n\t\tSELECT id,name FROM api_files \r\n\t\tWHERE context = @card_name AND context_id = @id -- IN ({@ids})\r\nOPEN @cursor;\r\nFETCH NEXT FROM @cursor INTO @idval,@filename\r\nWHILE @@FETCH_STATUS = 0\r\n\tBEGIN\r\n\t\tEXEC sp_api_file_set @api_files_id=@idval,@url = @url OUT\r\n        INSERT INTO #files (filename,path) VALUES(@filename,@url)\r\n        SET @bodytext = CONCAT(@bodytext,CHAR(13),@url)\r\n\t\tFETCH NEXT FROM @cursor INTO @idval,@filename\r\n\tEND\r\nCLOSE @cursor;\r\nDEALLOCATE @cursor;\r\nDECLARE @attachments nvarchar(max) = (SELECT * FROM #files FOR JSON PATH)\r\n\r\nDECLARE @subject nvarchar(256)=concat(' Files from dossier: ',@card_name,': ',@ID)\r\nif @bodytext is not null set @bodytext=CONCAT(N'Links for direct download:',CHAR(13),@bodytext)\r\nif @bodytext is null set @bodytext=concat(N'Hereby we send you the files for dossier ',@id,' (',@card_name,')')\r\nEXEC sp_api_email @mail_to,@subject,@bodytext,@attachments = @attachments --filename en path\r\n\r\nDECLARE @T1 nvarchar(256)=concat(N'All files for record ',@ID,N' are sent by mail to ',@mail_to)\r\nexec sp_api_toast @T1",
            "action_id": 569,
            "action_name": "mail_all_linked_files",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-------------------------------------------------------------------------------------------------------------------\r\n-- global report : Omzet Per Artikel\r\n-- pre declare: @jaar,@button\r\n-------------------------------------------------------------------------------------------------------------------\r\n\r\n--230106 even bij een paar rapporten jaar filter er bij\r\nEXEC sp_api_modal_input_decimal @name = '@jaar', @value = @jaar OUT, @inline = 1 ,@scale = 0\r\nEXEC sp_api_modal_button @name='@button',@value = 'Save', @valueout = @button OUT,@class='btn-danger',@key='Enter'\r\nif @button is null return\r\n-------------------------------------------------------------------------------------------------------------------\r\n\r\n--exec sp_api_modal_alert N'220615 deze is vervangen door report op basis van gefactureerde data'\r\n\r\n --fout report\r\nDECLARE @date nvarchar(128)\r\n\t--pre declared ivm jaar\t,@button nvarchar(128)\r\n\t,@buttoncsv nvarchar(128),@from nvarchar(128),@to nvarchar(128)\r\nset @date = dbo.workDate()\r\nEXEC sp_api_modal_modal @class = 'w100'\r\n--EXEC sp_api_modal_date @name='Date',@value = @date OUT,@focus = 1,@select=1 -- zoek veld\r\n--EXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\r\n--EXEC sp_api_modal_button @name='button',@value = 'Omzet Per Artikel',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\r\nEXEC sp_api_modal_print\r\n\r\nEXEC sp_api_modal_action N'report_menu',@keycode='Backspace'\r\n\r\nSET @button = 'Omzet Per Artikel'\r\nIF @button =  'Omzet Per Artikel'\r\nBEGIN\r\nEXEC sp_api_modal_button @name='@button',@value = 'Download CSV', @valueout = @buttoncsv OUT,@class='btn btn-success',@key='4'\r\n\tSELECT \r\n\t\t[Product] = [Product]\r\n\t\t,[Land] = [Land]\r\n\t\t,[LandCode] = [LandCode]\r\n\t\t,[Aantal@] = [Aantal]\r\n\t\t\r\n--\t\t,[Bedrag Eur@:2] = [Bedrag Eur]\r\n--\t\t,[Gemidd@:2] = [Gemidd]\r\n\t\t\r\n\t\t,[Bedrag Eur v2@:2] = [Bedrag Eur v2]\r\n\t\t\r\n--\t\t,[Gemidd v2@:2] = [Gemidd v2]\r\n--\t\t,[Totaal bruto]\r\n--\t\t,[Rabat Bedrag P~col-sm-2-3] = [Rabat Bedrag P]\r\n--\t\t,[Rabat Colli~col-sm-2-3] = [Rabat Colli]\r\n--\t\t,[Korting Bedrag P~col-sm-2-3] = [Korting Bedrag P]\r\n--\t\t,[Korting Colli~col-sm-2-3]\t= [Korting Colli]\r\n--\t\t,[Reservering P~col-sm-2-3] = [Reservering P]\r\n\t\t,jaar=contextyear\r\n\t\t\r\n\tINTO #OMZET_PER_ARTIKEL_ANACO\r\n\tFROM @main_db.dbo.[RV_OMZET_PER_ARTIKEL_ANACO] where contextyear=@jaar\r\n\tEXEC sp_api_modal_table @tmptable=N'#OMZET_PER_ARTIKEL_ANACO',@orderby=N'ORDER BY 1 ASC',@print=1\r\n\tIF @buttoncsv =  'Download CSV'\r\n\t\tBEGIN\r\n\t\t\tDECLARE @filename nvarchar(128) = dbo.strdate(NULL) +'_'+ 'Omzet_Per_Artikel.csv'\r\n\t\t\tEXEC sp_api_modal_csv @tmptable=N'#OMZET_PER_ARTIKEL_ANACO',@filename= @filename,@ansi=1\r\n\t\tEND\r\nEND \r\n",
            "action_id": 570,
            "action_name": "Omzet Per Artikel",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @prefix nvarchar(max)\nEXEC sp_api_modal_text N'Tracy QR Continu Scanner',N'h1'\n--IF @qrscanner IS NULL  --na post is dit gevuld\n\tBEGIN\n\t\t--post direct als hij qr 'ziet'\n\t\tEXEC sp_api_modal_qr_scanner N'@qrscanner',@value = @qrscanner OUT\n\t--\tRETURN\n\tEND\nSET @prefix = N'bonnetje#'\nIF @qrscanner LIKE @prefix+'%'\n\tBEGIN\n\t\tDECLARE @uuid nvarchar(max) = REPLACE(@qrscanner,@prefix,'')\n\t\tSET @uuid = 7\n\t\t--SELECT @id = id FROM bonnetjes WHERE uuid = @uuid\n\t\tEXEC #set_country_name7 @uuid\n\t\tRETURN\n\tEND\n\n\t--@qrscanner:  bonnetje#34535-345234-2356-234-342\nEXEC sp_api_modal_text @qrscanner,N'h5'\nEXEC sp_api_modal_input @name = '@qrscanner', @value = @qrscanner OUT --,@inline = 1\nEXEC sp_api_modal_text 'Doe er wat mee'\nEXEC sp_api_modal_button @name='@button',@value = 'Save', @valueout = @button OUT,@class='btn-danger',@key='Enter'\n--IF @button IS NULL RETURN",
            "action_id": 571,
            "action_name": "Scanner_test2",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_route @name = N'country',@cardname = N'country'",
            "action_id": 572,
            "action_name": "stamgegevens",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_card_field_settings @card_id,@card_field_id",
            "action_id": 573,
            "action_name": "sys_card_field_settings",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_search_all @card_id_reduced,@reducer,@focus,@highlight",
            "action_id": 574,
            "action_name": "sys_search_all_clone",
            "source_table": "api_actions"
        },
        {
            "sql_source": "\t\tEXEC sp_api_modal_route @name='alle bedrijven',@pathname='/adres'--,@search= '',@class=@bclass,@key='F1',@group = 'stamgegevens'\n\t\tEXEC sp_api_modal_route @cardname='leverancier',@pathname='/leverancier'--,@search= '',@class=@bclass,@key='F2',@group = 'stamgegevens'\n\t\tEXEC sp_api_modal_route @cardname='klant',@pathname='/klant'--,@search= '?ord=23124,27062',@class=@bclass,@key='F3',@group = 'stamgegevens'\n\t\tEXEC sp_api_modal_route @cardname='transporteur',@pathname='/transporteur'--,@search= '',@class=@bclass,@key='F4',@group = 'stamgegevens'\n\t\t\n\t\tEXEC sp_api_modal_route @pathname='/xlocation',@cardname=N'xlocation'--,@search= '',@class=@bclass,@key='L'",
            "action_id": 575,
            "action_name": "#submenu_bedrijven",
            "source_table": "api_actions"
        },
        {
            "sql_source": "IF dbo.hasRole('user,admin,directie') > 0\n\tbegin\n\t\tEXEC sp_api_modal_route @name='Inkoopfacturen',@pathname='/incoming_invoice'--,@class=@bclass,@key='Alt+I'--,@group = 'Factuurin'\n\t\tEXEC sp_api_modal_route @name='Status Exact',@pathname='/incoming_invoice',@Search='?red=Status+Exact'--,@class=@bclass,@key='Alt+I',@group = 'Factuurin'\n\t\tEXEC sp_api_modal_route @name='Status Draft / Empty',@pathname='/incoming_invoice',@Search='?red=Draft+%2F+Empty'--,@class=@bclass,@key='Alt+I',@Search='?red=Draft+%2F+Empty',@group = 'Factuurin'\n\tend\n",
            "action_id": 576,
            "action_name": "#submenu_factuur_in",
            "source_table": "api_actions"
        },
        {
            "sql_source": "IF dbo.hasRole('user,admin,directie') > 0\n\tbegin\n \n\t\tEXEC sp_api_modal_route @name='nieuwe en open facturen',@cardname='invoice_wms', @Search='?red=Open+en+Nieuw'\n\t\tEXEC sp_api_modal_route @name='klaar voor export',@cardname='invoice_wms', @Search='?red=Klaar+voor+Export'\n\t\tEXEC sp_api_modal_route @cardname='wms_week_data_for_invoice'\n\t\tEXEC sp_api_modal_route @cardname='w_applied_actions'\n\tend\n",
            "action_id": 577,
            "action_name": "#submenu_factuur_uit",
            "source_table": "api_actions"
        },
        {
            "sql_source": "\t-------------------------------------------------------------------\n\t-- name: #stam\n\t-- submenu-items voor stamgegevens\n\t-------------------------------------------------------------------\n\t\tEXEC sp_api_modal_route @cardname = 'wms_price_per_week'\n\t\tEXEC sp_api_modal_route @cardname = 'wms_item'\n\t\tEXEC sp_api_modal_route @cardname ='xproduct'\n\t\tEXEC sp_api_modal_route @cardname ='w_action_tariff'\n\t\tEXEC sp_api_modal_route @cardname =\t\t'wms_notification_settings'\n\t\tEXEC sp_api_modal_route @cardname =\t\t'wms_invoice_method'\n\t\tEXEC sp_api_modal_route @cardname =\t\t'wms_purchase'\n",
            "action_id": 578,
            "action_name": "#submenu_stamgegevens",
            "source_table": "api_actions"
        },
        {
            "sql_source": "\tEXEC sp_sys_modal_view_builder\r\n",
            "action_id": 579,
            "action_name": "sys_view_builder",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_filter_defaults_show_hide @card_id",
            "action_id": 580,
            "action_name": "sys_filter_defaults_show_hide",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_menu_info_memory_usage",
            "action_id": 581,
            "action_name": "sys_menu_info_memory_usage",
            "source_table": "api_actions"
        },
        {
            "sql_source": "---------------------------------------------------------------------\r\n-- scan voor missende code met preload\r\n--\r\n--\r\n--\r\n---------------------------------------------------------------------\r\ndeclare @lines nvarchar(max), @this_id int , @this_line nvarchar(128)\r\nselect id, line into #SEL from wms_micro_outbound_line_barcode\r\nwhile exists(select 1 from #sel)\r\n\tBEGIN\r\n\t\tselect top 1 @this_id =id, @this_line=Line from #sel\r\n\t\t\r\n\t\tif @this_line <> N'DAM2420JP1100019'\r\n\t\t\tSet @Lines =concat(@lines,@this_line, CHAR(13) + CHAR(10))\r\n\t\tdelete from #sel where id=@this_id\r\n\tend\r\n--N'DAM2420JP1100019'\r\n\r\n\r\nEXEC sp_api_modal_text N'Barcode scanner',N'h1'\r\nEXEC sp_api_modal_text N'Zet je scherm van je mobiel vast als je vaak schuin of 90 graden wilt scannen',N'p'\r\nDECLARE @button_choose nvarchar(max),@barcode nvarchar(max)\r\n\t,@video_width int,@line_height int,@line_width int\r\nSET @button_choose = N'Multi code'\r\nEXEC sp_api_modal_choose @list = N'Multi code,Single code',@value = @button_choose OUT\r\nDECLARE @direct_post bit = IIF(N'Single code' = @button_choose,1,0)\r\n\r\nSET @video_width = 1200\r\nSET @line_height = 2\r\nSET @line_width = 50\r\n\r\nEXEC sp_api_modal_text N'Camera resolutie',N'p'\r\nEXEC sp_api_modal_choose @list = N'800,1200,1600,2000,2400',@value = @video_width OUT\r\n\r\nEXEC sp_api_modal_text N'Lijnhoogte scanner',N'p'\r\nEXEC sp_api_modal_choose @list = N'1,2,4,8,16',@value = @line_height OUT\r\n\r\nEXEC sp_api_modal_text N'Lijnbreedte percentage',N'p'\r\nEXEC sp_api_modal_choose @list = N'30,40,50,60,70,80',@value = @line_width OUT\r\n\r\n\t/*\r\nset @initial_codes=N'oke'\r\nEXEC sp_api_modal_scanner @barcodes = 1, @value = @barcode OUT,@direct_post = @direct_post,@video_width = @video_width\r\n\t,@line_height = @line_height,@line_width = @line_width\r\n\t--,@regex=N'^gaan we'\r\n\t,@initial_codes=@initial_codes\r\nIF @barcode > ''\r\n\tBEGIN\r\n\t\tEXEC sp_api_modal_text N'Codes:',N'h3'\r\n\t\tEXEC sp_api_modal_text @barcode,N'code'\r\n\tEND\r\n*/\r\n\r\n---------------------------\r\n-- met pre load\r\n\r\nEXEC sp_api_modal_scanner @barcodes = 1, @value = @barcode OUT,@direct_post = @direct_post,@video_width = @video_width\r\n\t,@line_height = @line_height,@line_width = @line_width\r\n\t,@initial_codes = @lines--'gaan we weer'",
            "action_id": 589,
            "action_name": "Barcode Scanner",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_filters_custom @card_id = @card_id",
            "action_id": 590,
            "action_name": "sys_filters_custom",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_performance_query_store",
            "action_id": 591,
            "action_name": "sys_performance_query_store",
            "source_table": "api_actions"
        },
        {
            "sql_source": "DECLARE @date nvarchar(128),@button nvarchar(128),@buttoncsv nvarchar(128),@ffa nvarchar(128),@client nvarchar(128),@warehouse nvarchar(128),@warehouse_id int\r\nset @date = dbo.workDate()\r\nEXEC sp_api_modal_modal @class = 'w100'\r\nEXEC sp_api_modal_print\r\n\r\nexec sp_api_modal_text N'Dit report toont alleen containers die langer dan 60 dagen in het warehouse staan.'\r\n\r\nEXEC sp_api_modal_input @name = '@ffa', @value = @ffa OUT \r\nEXEC sp_api_modal_input @name = '@client', @value = @client OUT \r\nEXEC sp_api_modal_select N'xlocation',@value = @warehouse_id OUT, @reducer ='company_id in(select id from xtenantkey)'\r\n\r\n\r\nEXEC sp_api_modal_button @name='@b1',@value = 'Run Analyse', @valueout = @button OUT,@class='btn-danger',@key='Enter'\r\nif @b1 is null return\r\n\r\n\r\nEXEC sp_api_modal_action N'report_menu',@keycode='Escape'\r\n\r\nSET @button = 'Ouderdomsanalyse'\r\nIF @button =  'Ouderdomsanalyse'\r\nBEGIN\r\n\tEXEC sp_api_modal_button @name='@button',@value = 'Download CSV', @valueout = @buttoncsv OUT,@class='btn btn-success',@key='4'\r\n\tselect\r\n\t\tffa_code as [ffa_code**],client_code, storagedays , in_date, pallets=count(*), container_number, bl_number, house_bl, wms_item as indication_item, case when warehouse_id=6310 then 'MAASVLAKTE' else 'BOTLEK' end as warehouse\r\n\t\tinto #OUD\r\n\t\tfrom pallet_status\r\n\t\tcross apply(select storagedays=datediff(day,in_date,getdate())) aa\r\n\t\twhere is_outbound_pick_pallet=0 and is_placeholder =0\r\n\t\t\tAND IN_DATE IS NOT NULL\t\t\t--ingeslagen\r\n\t\t\tAND OUT_TRANSPORT_ID IS NULL\t-- nog niet uitgeslagen\r\n\t\t\tand storagedays > 60\t\t\t-- meer dan 60 dagen\t\r\n\t\t\tand (@ffa is null  OR ffa_code like concat('%',@ffa,'%'))\r\n\t\t\tand (@client is null  OR client_code like concat('%',@client,'%'))\r\n\t\t\tand (@warehouse_id is null  OR warehouse_id=@warehouse_id)\r\n\t\t\t--and warehouse_id>6310\t\t\r\n\t\tgroup by ffa_code,client_code, storagedays , in_date\r\n\t\t\t\t, container_number, bl_number, house_bl\r\n\t\t\t\t, wms_item-- as indication_item, case when warehouse_id\r\n\t\t\t\t,warehouse_id\r\n\t\torder by ffa_code, storagedays desc,client_code -- per ffa, oudste containers boven\r\n\t\t\r\n\tEXEC sp_api_modal_table @tmptable=N'#OUD',@orderby=N'ORDER BY [ffa_code**], storagedays desc, client_code',@print=1, @excel=1\r\n\tIF @buttoncsv =  'Download CSV'\r\n\t\tBEGIN\r\n\t\t\tDECLARE @filename nvarchar(128) = dbo.strdate(NULL) +'_'+ 'Ouderdomsanalyse.csv'\r\n\t\t\tEXEC sp_api_modal_csv @tmptable=N'#OUD',@filename= @filename,@ansi=1\r\n\t\tEND\r\nEND \r\n",
            "action_id": 594,
            "action_name": "Ouderdomsanalyse",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-----------------------------------------------------------\r\n-- 230127  - 230807\r\n-- mobile_scan; **MENU-ITEM** voer een actie uit op basis van een qr scan\r\n-- pre declare: @button,@barcodescanner\r\n--\r\n-----------------------------------------------------------\r\n\r\n\r\nEXEC sp_api_modal_text N'Scanner',N'h1'\r\n\r\nEXEC sp_api_modal_scanner N'@barcode_scanner',@value = @barcodescanner OUT\r\n ,@barcodes = 1,@direct_post = 0\r\n ,@video_width = 1200\t\r\n ,@line_height = 8\r\n\r\nif @barcodescanner is NULL RETURN\r\n\r\nset @pal_id = (select id from w_pallet where pallet_label=@barcodescanner)\r\nif @pal_id > 0 \r\n\tbegin\r\n\t\tset @container_id=(select w_lot_id from w_pallet where id=@pal_id)\r\n\t\tif @position_code is null set @position_code=(select position_code from w_pallet where id=@pal_id)\r\n\r\n\t\tset @T=concat_ws(' - ', 'labelinfo:', @barcodescanner,@pal_id)\r\n\t\texec sp_api_toast @T\r\n\t\t\r\n\t\tset @T=concat(N'Huidige positie : ', (select position_code from w_pallet where id=@pal_id))\r\n\t\texec sp_api_modal_text @T ,@class='h1'\r\n\t--\t\tEXEC sp_api_modal_input @name='ramp',@max=20, @value=@ramp OUT,@select=1,@Class='w-24 m-1'\r\n\t\t\tEXEC sp_api_modal_input @name='position_code',@max=10, @value= @position_code OUT,@select=1,@Class='w-24 m-1'\r\n\t\t\tEXEC sp_api_modal_button @name='@button',@value = 'Opslaan', @valueout = @button OUT,@class='btn-danger',@key='Enter'\r\n\t\t\tif @button='Opslaan'\r\n\t\t\t\tbegin\r\n\t\t\t\t\texec sp_api_toast N'xxx'\r\n\t--\t\t\t\tupdate w_lot set ramp=@ramp where id= @container_id\r\n\t\t\t\t\r\n\t\t\t\t\t--naar boven gehaald ivm multi-card set @container_id={[p a l l e  t _ m o b i l  e].w_lot_id}\r\n\t\t\t\t\tif @container_id > 0 and @position_code > N''\r\n\t\t\t\t\t\tbegin\r\n\t\t\t\t\t\t\tset @Tx=concat(N'Nieuwe palletlokatie: ',@position_code)\r\n\t\t\t\t\t\t\texec sp_api_toast @Tx\r\n\r\n--schrijf...\r\n\r\n\r\n\t\t\t\t\t\tend\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tif @container_id > 0 and @position_code = N''\t\r\n\t\t\t\t\t\tbegin\r\n\t\t\t\t\t\t\texec sp_api_toast N'Er is geen nieuwe lokatiecode.'\r\n\t\t\t\t\t\tend\t\r\n\r\n\t\t\t\t\texec sp_api_modal_clear\r\n\t\t\t\tend\r\n\t\t\r\n\tend\r\nif isnull(@pal_id,0)=0\r\n\tbegin\r\n\t\texec sp_api_toast N'GEEN GELDIG PALLET LABEL.'\r\n\tend\t\t\r\n",
            "action_id": 600,
            "action_name": "NEOVO_PALLET_SCAN",
            "source_table": "api_actions"
        },
        {
            "sql_source": "select --* \r\nclient_code,\r\n--vendor_code,\r\n--ffa_code,\r\n--in_completed,\r\n--out_completed,\r\n--in_transport_id,\r\nin_date,\r\n--ywk_in,\r\n--iso_w_in,\r\nout_date,\r\n--ywk_out,\r\n--iso_w_out,\r\n--out_transport_id,\r\n--lot_id,\r\n--client_id,\r\ncontainer_number,\r\n--bl_id,\r\n--inbound_note,\r\nin_ref,\r\nbl_number,\r\nhouse_bl,\r\n--bl_ffa_id,\r\n--one,\r\npallet_state,\r\ncustoms_state,\r\npal_in,\r\npal_out,\r\npal_busy,\r\npal_stock,\r\n--tr_in_id,\r\n--tr_out_id,\r\n--pal_out_id,\r\n--doc_pallets,\r\n--ramp,\r\nwms_item,\r\nwms_item_sku,\r\n--wms_item_id,\r\n--micro_art_count,\r\n--micro_art_ids,\r\n--art_kgn,\r\n--warehouse_id,\r\nwarehouse_code,\r\nmicro_stock,\r\n--id,\r\npallet_label,\r\n--w_lot_id,\r\n--pallet_nr,\r\n--xStock_id,\r\n--lf_in_id,\r\n--lf_out_id,\r\npallet_gross_weight,\r\nColli,\r\nposition_code,\r\npallet_art_lotnr,\r\nmicro_pick_allowed\r\n--is_outbound_pick_pallet,\r\n--wms_micro_outbound_id,\r\n--pallet_nr_pick,\r\n--wms_purchase_id,\r\n--w_sublocation_id,\r\n--pallet_key,\r\n--is_placeholder,\r\n--Placeholder_id\r\n\r\ninto #pallet_status_agneovo from pallet_status where w_lot_id in(select id from w_lot where ffa_id=(select id from xcompany where code=N'AGNEOVO'))\r\nexec sp_api_modal_table @tmptable=#pallet_status_agneovo,@excel=1",
            "action_id": 604,
            "action_name": "pallet_status_agneovo",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_history_table @card_id,@id,@ids",
            "action_id": 605,
            "action_name": "sys_history_table",
            "source_table": "api_actions"
        },
        {
            "sql_source": "\tselect  \r\n\t\t\t--is_processed,\r\n\t\t\t--container_number,\r\n\t\t\t--linked_amount,\r\n\t\t\tid,\r\n\t\t\tname=concat('sku: ',sku,\r\n\t\t\t\t\t--lookupcode,\r\n\t\t\t\t\t', gekoppeld: ',linked_SERIALS\r\n\t\t\t\t\t)\r\n\t\t\t into #modaltable\r\n\t\t\tfrom q_wms_micro_outbound_lines where wms_micro_outbound_id=3297\r\n\t--\texec sp_api_modal_select_table @tmptable=N'#mol'\t, @value = @selected_values OUT ,@no_isam = 1\r\n\t\t--EXEC sp_api_modal_select_table @tmptable = '#modaltable', @value = @selected_value OUT ,@no_isam = 1\r\n\r\n--exec sp_api_modal_text N'Kies een land'\r\n--if @country_id is NULL set @country_id=151\r\n--SELECT id=countryId,name=Name_0 INTO #modaltable FROM xCountry\r\nEXEC sp_api_modal_select_table @value = @selected_values OUT --,@initial_id=@country_id --,@tmptable=N'#tmptable'\r\n\r\n\t\t\r\n\t\treturn\r\n",
            "action_id": 619,
            "action_name": "rick_2",
            "source_table": "api_actions"
        },
        {
            "sql_source": "\r\nEXEC sp_api_modal_text N'Zoek een micro outbound:','text-primary mb-1 h4'\r\nselect mob.id, name=concat_ws(' - ',mob.out_ref,mob.warehouse_instructions,loc.locationcode,loc.locationname) \r\n\tinto #mobs \r\n\tfrom q_wms_micro_outbound mob\r\n\tleft join xlocation loc on loc.id=mob.to_loc_id\r\n\twhere mob.completed=0\r\nEXEC sp_api_modal_select_table @tmptable = N'#mobs',@value = @mob_id OUT,@placeholder = N'Kies een micro outbound',@no_isam=1\r\nif @mob_id is null RETURN\r\n\r\n\r\n\r\n-------------\r\n\r\n\r\ndeclare @lines nvarchar(max), @this_id int , @this_line nvarchar(128)\r\nselect id, line into #SEL from wms_micro_outbound_line_barcode where wms_micro_outbound_lines_id in (select id from wms_micro_outbound_lines where wms_micro_outbound_id=@mob_id)\r\n\t--={[wms_micro_outbound_lines].id}\r\nwhile exists(select 1 from #sel)\r\n\tBEGIN\r\n\t\tselect top 1 @this_id =id, @this_line=Line from #sel\r\n\t\t\r\n\t\tif 1=1 -- test eentje uitsluiten @this_line <> N'DAM2420JP1100019'\r\n\t\t\tSet @Lines =concat(@lines,@this_line, CHAR(13) + CHAR(10))\r\n\t\tdelete from #sel where id=@this_id\r\n\tend\r\n\r\n-- scanner met pre load\r\nEXEC sp_api_modal_scanner \r\n\t@barcodes = 1\r\n\t,@value = @barcode OUT\r\n\t,@direct_post = 0\r\n\t,@video_width = 2400 -- N'800,1200,1600,2000,2400'\r\n\t,@line_height = 4 --  N'1,2,4,8,16'\r\n\t,@line_width = 60 --% N'30,40,50,60,70,80'\r\n\t,@initial_codes = @lines",
            "action_id": 626,
            "action_name": "micro_check_scan",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_input @name = '@barcode', @value = @line OUT ,@focus=1   --,@inline = 1\r\nEXEC sp_api_modal_button @name='@button',@value = 'Test', @valueout = @button OUT,@class='btn-danger',@key='Enter', @pietje=12\r\nif @button is null return\r\nif exists(select 1 from wms_micro_outbound_line_barcode where line=@line)\r\n\tBEGIN\r\n\t\texec sp_api_modal_text @line\r\n\t\tEXEC sp_api_modal_beep 1200,300\r\n\tend\r\nELSE\t\r\n\tbegin\r\n\t\t--if correcte line gescand (serienummer line, check op begin en op lengte..)\r\n\t\texec sp_api_modal_text N'Toevoegen?'\r\n\t\tEXEC sp_api_modal_beep 2400,150\t\r\n\tend\t\r\n\t",
            "action_id": 631,
            "action_name": "test_rick_2",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_modal_sql_import\r\n",
            "action_id": 632,
            "action_name": "sys_modal_sql_import",
            "source_table": "api_actions"
        },
        {
            "sql_source": "----------------------------------------------------------------------------------------------------------------\r\n--\tmicro_outbound_rapportage A G N E O V O\r\n--\t231103 specifiek voor agneovo login\r\n----------------------------------------------------------------------------------------------------------------\r\nexec sp_api_modal_text N'Overzicht van outbound registraties in de opgegeven periode',@class='h1'\r\nDECLARE @date nvarchar(128),@button nvarchar(128),@buttoncsv nvarchar(128),@from nvarchar(128),@to nvarchar(128)\r\n\t\t,@datumrange nvarchar(128)\r\nset @date = dbo.workDate()\r\nEXEC sp_api_modal_modal @class = 'w100'\r\n\r\nSET @from = DATEADD(day, -1, dbo.workDate())\r\nSET @to=dbo.workDate()\r\nEXEC sp_api_modal_date_from_to @from=@from out, @to=@to out,@class='w-24'\r\nSET @datumrange = concat(N'micro_outbound van ',@from, ' t/m ', @to)\r\n\r\nEXEC sp_api_modal_button @name='button',@value = 'Generate Report',@valueout = @button OUT,@class = 'btn-primary',@key = 'F1'\r\n\r\n--EXEC sp_api_modal_print\r\n--EXEC sp_api_modal_action N'report_menu',@keycode='Escape'\r\n\r\nIF @button =  'Generate Report'\r\nBEGIN\r\n\r\n\tSELECT \r\n\t\tregistratiedatum=datum\r\n\t\t,out_ref\r\n\t\t,locationname\r\n\t\t,lookupcode\r\n\t\t,sku\r\n\t\t,item_serial_number\r\n\r\n\tinto #wmsx_nl_micro_outbound_rapportage\r\n\tFROM @main_db.dbo.ffa_mob_status(181175) --LET OP: S P E C I F I E K   A G N E O V O   ! \r\n\t\t--group by locationname \r\n\twhere datum >= @from and datum <= @to\r\n\r\n\t\r\n\tEXEC sp_api_modal_table @tmptable=N'#wmsx_nl_micro_outbound_rapportage',@excel=1 ,@orderby=N'ORDER BY 1,2 ASC',@print=1\r\n\t\r\nEND \r\n",
            "action_id": 639,
            "action_name": "micro_outbound_rapportage",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_menu_info_top_table_usage",
            "action_id": 640,
            "action_name": "sys_menu_info_top_table_usage",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-----------------------------------------------------------\r\n-- 230127  \r\n-- mobile_scan; **MENU-ITEM** voer een actie uit op basis van een qr scan\r\n-- pre declare: @lastname,@button,@qrscanner\r\n-----------------------------------------------------------\r\n\r\nDECLARE @prefix nvarchar(max)\r\nDECLARE @uuid nvarchar(max)\r\nEXEC sp_api_modal_text N'Scanner',N'h1'\r\nEXEC sp_api_modal_input @name = '@qrscanner', @value = @qrscanner OUT ,@select = 1\r\n\t--,@hidden = 0\r\n/*detepo:\r\n*/\r\nEXEC sp_api_modal_button @name='@detepo',@value = 'check', @valueout = @detepo OUT,@class='btn-danger',@key='Enter'\r\nif @detepo is null return\r\n\r\n/* mobile\t\r\nIF @qrscanner IS NULL  --na post is dit gevuld\r\n\tBEGIN\r\n\t\t--post direct als hij qr 'ziet'\r\n\t\tEXEC sp_api_modal_qr_scanner N'@qrscanner',@value = @qrscanner OUT\r\n\t\tRETURN\r\n\tEND\r\n*/\t\r\n\r\nSET @prefix = N'w_lot#'\r\nIF @qrscanner LIKE @prefix+'%'\r\n\tBEGIN\r\n\t\t--set @uuid = REPLACE(@qrscanner,@prefix,'')\r\n\t\tset @uuid=dbo.regex_match(right(@qrscanner,len(@qrscanner)-len(@prefix)),N'[0-z]+')\r\n\t\t--SET @uuid = 7\r\n\t\tEXEC #qr_action_loods_bevestiging_inslag @uuid\r\n\t\tRETURN\r\n\tEND\r\n\r\n--uitgebreid 230219 omdat oude palletstickers ook gelezen moeten kunnen worden\r\n-- hiermee kunnen de oude palletstickers met volledige url ook gelezen worden; vertaalt zich naar dezelfde functionaliteit als bij ps:<<pallet_id>>\r\nSET @prefix = concat(@origin,'/inbound/') --N'https://rws.tsql.app/inbound/' -- de palletsticker\r\nif left(@qrscanner,len(@prefix))=@prefix\r\n\tbegin \r\n\t\tdeclare @pallet_label nvarchar(256) = @main_db.dbo.get_url_param_val(@qrscanner,'pallet_label')\r\n\t\tif @pallet_label > N''\r\n\t\t\tBEGIN\r\n--\t\t\t\texecute sp_api_toast N'pallet sticker..'\r\n\t\t\t\tdeclare @pal_id int = (select id from w_pallet where pallet_label=@pallet_label)\r\n\t\t\t\tif @pal_id > 0 \r\n\t\t\t\t\tbegin\r\n\t\t\t\t\t\tEXEC #qr_action_pallet_sticker @uuid=@pal_id --230219\r\n\t\t\t\t\tend\r\n\t\t\t\tif isnull(@pal_id,0)=0\r\n\t\t\t\t\tbegin\r\n\t\t\t\t\t\texec sp_api_toast N'GEEN GELDIG PALLET LABEL.'\r\n\t\t\t\t\tend\t\t\r\n\t\t\t\tRETURN\r\n\t\t\tEND\r\n\tend\t\r\n--230217 nieuw\r\nSET @prefix = N'ps:' -- de palletsticker\r\nIF @qrscanner LIKE @prefix+'%'\r\n\tBEGIN\r\n--\t\texecute sp_api_toast N'pallet sticker..'\r\n\t\t--set @uuid = REPLACE(@qrscanner,@prefix,'')\r\n\t\tset @uuid=dbo.regex_match(right(@qrscanner,len(@qrscanner)-len(@prefix)),N'[0-z]+')\r\n\t\tEXEC #qr_action_pallet_sticker @uuid\r\n\t\tRETURN\r\n\tEND\r\n\r\n\r\nSET @prefix = N'out_trans#'\r\nIF @qrscanner LIKE @prefix+'%'\r\n\tBEGIN\r\n--\t\tset @uuid = REPLACE(@qrscanner,@prefix,'')\r\n\t\tset @uuid=dbo.regex_match(right(@qrscanner,len(@qrscanner)-len(@prefix)),N'[0-z]+')\r\n\r\n\t\t--SET @uuid = 7\r\n\t\tEXEC #qr_action_verwerk_outbound_transport @uuid ,@origin = @origin --foto?\r\n\t\tRETURN\r\n\tEND\r\n\r\n\r\nSET @prefix = N'micro_pick'\r\nIF @qrscanner LIKE @prefix+'%'\r\n\tBEGIN\r\n--\t\tset @uuid = REPLACE(@qrscanner,@prefix,'')\r\n\t\tset @uuid=dbo.regex_match(right(@qrscanner,len(@qrscanner)-len(@prefix)),N'[0-z]+')\r\n\r\n\t\t--SET @uuid = 7\r\n\t\t--231008 was EXEC #qr_action_verwerk_micro_pick @uuid ,@origin = @origin --foto?\r\n\t\t--if @user='rick@tracy.nu' \r\n\t\t\tEXEC #qr_action_verwerk_micro_pick_v8 @uuid ,@origin = @origin --foto?\r\n\t\t--else \r\n\t\t--\tEXEC #qr_action_verwerk_micro_pick @uuid ,@origin = @origin --foto?\r\n\t\tRETURN\r\n\tEND\r\n\r\n\r\nEXEC sp_api_modal_qr_scanner N'@qrscanner',@value = @qrscanner OUT\t\r\nEXEC sp_api_modal_text N'Onbekende code',N'h5'\r\nEXEC sp_api_modal_text @qrscanner\r\n\r\n/*\r\n\r\n\t--@qrscanner:  bonnetje#34535-345234-2356-234-342\r\nEXEC sp_api_modal_text @qrscanner,N'h5'\r\nEXEC sp_api_modal_input @name = '@qrscanner', @value = @qrscanner OUT --,@inline = 1\r\nEXEC sp_api_modal_text 'Doe er wat mee'\r\nEXEC sp_api_modal_button @name='@button',@value = 'Save', @valueout = @button OUT,@class='btn-danger',@key='Enter'\r\n--IF @button IS NULL RETURN\r\n*/",
            "action_id": 652,
            "action_name": "detepo",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-------------------------------------------------------\r\n--stock per container - container overview\r\n-------------------------------------------------------\r\nexec sp_api_modal_text N'Select company for container stock'\r\n\r\n--EXEC sp_api_modal_select N'wms_ffa',@value = @ffa_id OUT, @initial_id=171906\r\nselect id, name=code into #ffa from xcompany where is_ffa=1\r\nEXEC sp_api_modal_select_table @tmptable = '#ffa', @value = @ffa_id OUT ,@no_isam = 1\r\n\t--,@class = 'p-4'\r\n\t--,@select = 1\r\n\t--,@placeholder = 'Choose a car'\r\n\t--,@top = 10\r\n\t--,@orderby = 'ORDER BY field3 DESC'\r\n\t,@initial_id = 171906\r\n\t--,@searchvalue = @searchvalue OUT -- the user typed string \r\n\t--,@use_placeholder = 'placeholder3' -- display in a placeholder above\r\nif @ffa_id is null RETURN\r\n\r\nexec #groot100\r\n\r\nexec sp_api_modal_text N'batch number'\r\nEXEC sp_api_modal_input @name = '@batch', @value = @batch OUT, @focus=1\r\n\r\n\r\nexec sp_api_modal_text N'container number'\r\nEXEC sp_api_modal_input @name = '@container_number', @value = @container_number OUT\r\n\r\nexec sp_api_modal_text N'sku'\r\nEXEC sp_api_modal_input @name = '@sku', @value = @sku OUT\r\n\r\nEXEC sp_api_modal_button @name='@button',@value = 'Search', @valueout = @button OUT,@class='btn-danger',@key='Enter'\r\nif @button is null or (@container_number is null  AND @Sku is null AND @batch is NULL) return\r\n\r\nselect --[kop*]=concat(ffa_code, ' - ',client_code)\r\n\t--, bl_number, \r\n\t--[ctnr_nr~col-3]=container_number --,wms_item\r\n\t--,[P@~col-1]=count(*)\r\n\t--,Pallet_nr -- niet in sum\r\n\t--,out_completed,sku=wms_item_sku\r\n\t--,\r\n\t[batch~col-8]=pallet_art_lotnr\r\n\t--,position_code\r\n\t,[CPP@~col-2]=sum(Colli)\r\n\t, [Left@~col-2]=sum(micro_stock)\r\ninto #s\r\nfrom Pallet_Status\twhere isnull(out_completed,0)=0 and bl_ffa_id=@ffa_id AND container_number like concat('%',@container_number,'%') AND (@SKU is null OR wms_item_sku like concat('%',@SKU,'%')) AND (@batch is null OR pallet_art_lotnr like concat('%',@batch,'%'))\r\ngroup by-- ffa_code, client_code\r\n\t\t--, bl_number, \r\n\t\t--container_number\r\n\t\t-- ,wms_item,out_completed,wms_item_sku,position_code\r\n\t\t--,\r\n\t\tpallet_art_lotnr\r\nexec sp_api_modal_table @tmptable=N'#s' , @orderby=' order by 1'\r\n\r\n",
            "action_id": 673,
            "action_name": "stock_via_pallet_status",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-------------------------------------\r\n/*\r\n\treport menu: rep_rv_stock_container_bonded_YN\r\n\t\r\n*/\r\n-------------------------------------\r\n\r\nselect customs_state as [customs_state**], aantal_pallets=count(*), ffa_code,warehouse_code,client_code,position_code ,container_number\r\n\tinto #r \r\n\tfrom @main_db.dbo.rv_stock_container_bonded_YN \r\n\twhere customs_state=N'BONDED'\r\n\tgroup by customs_state,ffa_code,warehouse_code,client_code,position_code,container_number\r\nexec sp_api_modal_table @tmptable=N'#r',@Excel=1 , @orderby=N' order by 1,3,4,5'",
            "action_id": 678,
            "action_name": "rep_rv_stock_container_bonded_YN",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--241213 @GB: let op @origin gebruiken we hier niet.. maar dat is niet het probleem\r\n\r\n-------------------------------------------------------\r\n--\t#qr_action_verwerk_micro_pick_v11\r\n--\tversie met herschikking van gekoppelde miscro-items na scannen van een pallet (scanned_pallet-id) \r\n--\tPRE DECLARE: \r\n/*\r\n@uuid int ,@origin nvarchar(1024), @button_choose nvarchar(max) = null , @sampleqrscanner nvarchar(max)= null, @button5 nvarchar(max) = null, @button_choose2 nvarchar(max) = NULL, @b6 nvarchar(128) = NULL\r\n,@button nvarchar(max) = NULL,@mol nvarchar(max) = NULL,@button2 nvarchar(max) = NULL,@T nvarchar(max) = NULL,@sku_check nvarchar(max) = NULL\r\n,@button3 nvarchar(max) = NULL,@xstock_id nvarchar(max) = NULL,@aantal_serials_nodig nvarchar(max) = NULL,@sku_oke nvarchar(max) = NULL,@button4 nvarchar(max) = NULL\r\n,@pal_select_button nvarchar(128)=NULL,@pal_select nvarchar(128)=NULL,@button_choose_pal nvarchar(128)=NULL,@button_scan_serials_for_mol nvarchar(128)=NULL,@button_replenish nvarchar(128)=NULL,@replenish_loc nvarchar(128)=NULL\r\n,@ps nvarchar(128)=NULL, @pallet_mol_id int = NULL, @this_SP int = null, @pipa int = null\r\n,@but_10 nvarchar(128)=NULL\r\n\r\n*/\r\nexec sp_api_toast N'micro pick V11'\r\ndeclare @scanned_codes nvarchar(max) ; EXEC sp_api_modal_get_value @name='@scanned_codes',@value = @scanned_codes OUT --231211 IPV PREDECLARED\r\n-------------------------------------------------------\r\ndeclare @mob int = @uuid --opgeschoond scan ID \r\ndeclare @no_serials bit = null\r\ndeclare @this_pallet_id int =0 \r\ndeclare @this_pallet_nr int =0\r\ndeclare @this_pal_colli int =0\r\ndeclare @this_xstock_id int =0\r\ndeclare @this_item_lotnr nvarchar(128)\r\ndeclare @this_sku nvarchar(128)\r\ndeclare @this_pallet_type nvarchar(128) --'full, pick, replenish'\r\ndeclare @this_id int --temp table cursor\r\n--execute sp_api_toast '111111111'\r\n----------------------------------------------------------\r\n--\tafdwingen eerst replenishpallets halen en replenishen!\r\n----------------------------------------------------------\r\n\r\n\r\ndrop table if exists #mr \r\ndrop table if exists #list\r\ndeclare @button_gearriveerd_bij_pallet nvarchar(128)\r\n--declare @mob int=(select top 1 id from wms_micro_outbound order by id desc)\r\n--declare @T nvarchar(2000)\r\n\r\nselect --231130 TOP 1, zodat je per container goed bezig bent!\r\n\tp_pick.w_lot_id\r\n\t,pick_pal_id=p_pick.id\r\n\t,w_lot.container_number\r\n\t,adv_full_pos\r\n\t,p_pick.pallet_nr \r\n\t,mol.xstock_id\r\n\t,mol.id\r\n\t,mol.preferred_pallet_ids\r\n\t,mol.scanned_pallet_id\r\n\t,T=concat(N'Ga naar lokatie ',upper(mol.adv_full_pos), ' en haal daar'\r\n\t\t\t\t\t--,' en haal daar Pallet ',p_pick.pallet_nr\r\n\t\t\t\t\t--240122 eventueel willekeurig als de preferred_pallet al in gebruik is.. \r\n\t\t\t\t\t, case \r\n\t\t\t\t\t\twhen exists(select 1 from wms_micro_outbound_lines where scanned_pallet_id=mol.preferred_pallet_ids)\r\n\t\t\t\t\t\tthen ' een Pallet'\r\n\t\t\t\t\t\telse concat(' Pallet ',p_pick.pallet_nr)\r\n\t\t\t\t\t\tend\r\n\t\t\t\t\t\r\n\t\t\t\t\t,' met ',p_pick.colli,' colli' --231130\r\n\t\t\t\t\t,' van container ',upper(w_lot.container_number)\r\n\t\t\t\t\t,'. Artikel: ', upper(mol.lookupcode) \r\n\t\t\t\t\t)--* \r\n\t,remark --is dus 'replenish'\t\t\t\t\r\n\t,mol_amount=mol.amount --231130\r\ninto #mr \r\nfrom q_wms_micro_outbound_lines mol\r\n\t\t\tjoin w_lot on w_lot.id=mol.w_lot_id\r\n\t\t\tjoin w_pallet p_pick \r\n\t\t\t\t\ton p_pick.id=try_cast(preferred_pallet_ids as int) \r\n\t\t\t\t\t\t--dwing af dat de pallet uit de opgegeven mol-container komt\r\n\t\t\t\t\t\tand p_pick.w_lot_id=mol.w_lot_id\r\n\t\t\twhere mol.wms_micro_outbound_id=@mob \r\n\t\t\t\tand remark='replenish' \r\n\t\t\t\tand (\r\n\t\t\t\t\tscanned_pallet_id is null \r\n\t\t\t\t\tor NOT exists( select 1 from w_pallet where id=scanned_pallet_id and micro_pick_allowed=1)\r\n\t\t\t\t\t)\r\n\t\t\t\t\r\n\t\t\t\t--231020 met DENNIS LIVE IN MESONINE !!! (als de items al op de mol zijn toegekend, dan niet meer replenishen , want er waren er kennelijk genoeg\r\n\t\t\t\t-- nu wordt alles tegengehouden.. ook de pallets die wel gereplenished moeten worden..\r\n\t\t\t\tAND\tmol.linked_amount <> mol.amount\r\n\r\n--dev test select * from #modal_report \r\n--live \r\nselect * into #list from #mr\r\nif exists(select 1 from #list) exec sp_api_modal_text N'REPLENISH PALLETS',@class='h1'\r\nset @T = NULL\r\nif exists(select 1 from #mr)\r\nBEGIN\r\n\tSet @T='<ul>'--start lijst\r\nEND\r\n\r\nwhile exists(select 1 from #mr)\r\nBEGIN\r\n\tset @this_id=(select top 1 id from #mr)\r\n\tset @T=concat(@T,'<li>',(select T from #mr where id=@this_id),'</li>')\r\n\tdelete from #mr where id=@this_id\r\nEND\r\nif @T >''--lijst afsluiten\r\nBEGIN\r\nset @t=concat(@T,'</ul>')\r\nexec sp_api_modal_html @T\r\nEND\r\n\r\nWHILE exists(select 1 from #list) --bevat te replenishen pallets\r\nBEGIN -- 231004 REPLENISH PART\r\n\t--exec sp_api_modal_table @tmptable=N'#mr',@print=1,@excel=1 -- output to react client\r\n\tEXEC sp_api_modal_button @name='@button_gearriveerd_bij_pallet',@value = 'Ik ben bij de pallet', @valueout = @button_gearriveerd_bij_pallet OUT,@class='btn-danger',@key='Enter'\r\n\tif @button_gearriveerd_bij_pallet is null RETURN\r\n\t--scan pallet-sticker\r\n\texec sp_api_modal_text N'scan pallet sticker'\r\n\tEXEC sp_api_modal_input @name = '@ps', @value = @ps OUT ,@focus=1\r\n\r\n\tif @ps is null return\r\n\tif left(@ps,3)<>'ps:'\r\n\tBEGIN\r\n\t\texec sp_api_modal_text N'Dit is geen Tracy pallet sticker QR code'\r\n\t\t--exec sp_api_modal_restart--231130\r\n\r\n\t\tRETURN\r\n\tEND\t\r\n\r\n\r\n\tset @this_pallet_id=right(@ps,len(@ps)-3)\r\n\tif  not exists(select * from w_pallet where id=@this_pallet_id and w_lot_id in(select w_lot_id from #list) )\r\n\tBEGIN\r\n\t\tif  exists(select * from wms_micro_outbound_lines where scanned_pallet_id=@this_pallet_id )\r\n\t\tBEGIN --231009 pallet is er al.\r\n\t\t\texec sp_api_modal_text N'Deze pallet is al gescand en toegevoegd.'\r\n\t\tEND\t\r\n\t\telse BEGIN\t\r\n\t\t\texec sp_api_modal_text N'Dit is een pallet uit een ** VERKEERDE ** container'\r\n\t\tEND\r\n\t\texec sp_api_modal_beep 1100, 500 --error !\r\n\t\t--set @T=concat('pallet lot: ',(select w_lot_id from w_pallet where id=@this_pallet_id and w_lot_id in(select w_lot_id from #list) ))\r\n\t\t--exec sp_api_modal_text @T\r\n\t\t--exec sp_api_modal_table @tmptable=N'#modal_report',@print=1,@excel=1 -- output to react client\r\n\t\texec sp_api_modal_restart--231130\r\n\t\tRETURN\r\n\tEND\r\n\r\n\tif  not exists(select * from w_pallet p\r\n\t\t\t\t\twhere p.id=@this_pallet_id \r\n\t\t\t\t\t\t--\tand xstock_id in(select xstock_id from #list) \r\n\t\t\t\t\t\tand exists(select 1 from #list where #list.xstock_id=p.xstock_id and #list.mol_amount <= p.colli) --de gekozen pallet moet voor replenishen voldoende colli hebben 231130!!\r\n\t\t\t\t)\r\n\tBEGIN\r\n\t\texec sp_api_modal_text N'(1)Dit is ** NIET ** de juiste pallet. => Wel juiste container, maar verkeerd artikel of verkeerd colli aantal op de pallet!'\r\n\t\texec sp_api_modal_beep 1100, 500 --error !\r\n\t\t--set @T=concat('pallet lot: ',(select w_lot_id from w_pallet where id=@this_pallet_id and w_lot_id in(select w_lot_id from #list) ))\r\n\t\t--exec sp_api_modal_text @T\r\n\t\t--exec sp_api_modal_table @tmptable=N'#modal_report',@print=1,@excel=1 -- output to react client\r\n\t\t\t--exec sp_api_modal_restart--231130\r\n\t\t\t--EXEC sp_api_modal_values_clear @ignore='@uuid' --231130 KEEP SCANNED QR\r\n\t\t\texec sp_api_modal_value @name=N'@button_gearriveerd_bij_pallet'\r\n\t\t\texec sp_api_modal_value @name=N'@ps' -- er bij\r\n\t\tRETURN\r\n\tEND\r\n\tdeclare @foutinfo nvarchar(max)\r\n\t-- extra check 241213  -------------------------------------\r\n\tif exists(select 1 from mol where scanned_pallet_id=@this_pallet_id and mob_id<>@mob)\r\n\tBEGIN\r\n\t\texec sp_api_modal_ALERT N'FOUT','Deze pallet is al gekoppeld aan een andere outbound!'\r\n\t\texec sp_api_modal_beep 1100, 500 --error !\r\n\t\tdeclare @FOUT_bound int =(select top 1 mob_id from mol where scanned_pallet_id=@this_pallet_id and mob_id<>@mob)-- foute outbound..\r\n\r\n\r\n\t\tSET @foutinfo =\r\n\t\t\tconcat('Bij Outbound met ref: '\r\n\t\t\t\t\t,(select out_ref from mob where id=@mob)\r\n\t\t\t\t\t,' werd pallet id: ', @this_pallet_id\r\n\t\t\t\t\t,' (pal_nr: ', (select pallet_nr from w_pallet where id=@this_pallet_id),' )'\r\n\t\t\t\t\t,' gescand, maar die is (onjuist) gelinkt aan outbound : '\r\n\t\t\t\t\t,(select out_ref from mob where id=@FOUT_bound))\r\n\t\t-- Verstuur de e-mail\r\n\t\tEXEC sp_api_email \r\n\t\t\t@To = 'rick@tracy.nu + mterlouw@rwsbv.com',\r\n\t\t\t@Subject = 'Pallet FOUT ontdekt bij Replenish Scan',\r\n\t\t\t@Body = @foutinfo;\r\n\t\t\r\n\t\texec sp_api_modal_value @name=N'@button_gearriveerd_bij_pallet'\r\n\t\texec sp_api_modal_value @name=N'@ps' -- er bij\r\n\t\tRETURN\r\n\tEND\r\n\t-- einde  241213 extra check------------------------------- \r\n\r\n\r\n\t--we zitten nu absoluut op een pallet uit de juiste container en met het juiste artikel\r\n\t-- voorbereiden op replenishen\r\n\tset @this_pallet_type=N'REPLENISH'\r\n\tset @this_xstock_id=(select xstock_id from w_pallet where id=@this_pallet_id)\r\n\t--#list bevat hier alleen maar replenish regels\r\n\r\n/*\tif exists(select id from #list where scanned_pallet_id=@this_pallet_id) -- de pallet moet nog op MICRO_PICK_ALLOWED worden gezet\r\n\tBEGIN\r\n\t\texec sp_api_modal_text N'zet deze geselecteerde pallet op micro pick allowed....'\r\n\t\treturn\r\n\tEND\r\n*/\r\n/*\tif exists(select id from #list where @this_pallet_id in (select value from string_split(preferred_pallet_ids,','))) -- gewenst\r\n\tBEGIN\r\n\t\tset @T=N'Zet deze gewenste pallet definitief naar \"scanned_pallet_id\" en micro pick allowed....'\r\n\t\texec sp_api_modal_text @T\r\n\t\treturn\r\n\tEND\r\n*/\r\n\tif exists(select id from #list where scanned_pallet_id=@this_pallet_id) -- de pallet moet nog op MICRO_PICK_ALLOWED worden gezet\r\n\t\tOR exists(select id from #list where @this_pallet_id in (select value from string_split(preferred_pallet_ids,','))) -- gewenst\r\n\t\tOR exists(select id from #list where xstock_id=@this_xstock_id and @this_pallet_id not in (select value from string_split(preferred_pallet_ids,','))  ) -- alternatief\r\n\t--*************************\r\n\t-- HET RESPLENISHEN IS HIER\r\n\t--************************* \r\n\tBEGIN\r\n\t\t--231006 zorg dat er een pick pallet is\r\n\t\t--declare @pipa int = null\r\n\t\texec create_outbound_pickpallet --SELECTEERT OF MAAKT NIEUW..\r\n\t\t\t@wms_micro_outbound_id = @mob\r\n\t\t\t,@pallet_id  =@pipa output\r\n\t\t--print @pipa\r\n\r\n\t\tset @pallet_mol_id=(select top 1 id from #list where xstock_id=@this_xstock_id and scanned_pallet_id is null) -- er kan maar 1 replenish zijn voor 1 artikel !\r\n\t\t--set @T=concat(N'Deze pallet (pal.nr. ',(select pallet_nr from w_pallet where id=@this_pallet_id),') als alternatief gebruiken en definitief naar \"scanned_pallet_id\" en micro pick allowed....ipv prefrerred ', (select string_agg(preferred_pallet_ids,' *** ') from #list))\r\n\t\t--exec sp_api_modal_text @T\r\n\r\n\t\tif @replenish_loc is null \r\n\t\tBEGIN\r\n\t\t\tset @replenish_loc=(select pick_position from xstock where id=@this_xstock_id)\r\n\t\tEND\t\r\n\t\t--check of de replenishment al is geregistreerd op de pallet\r\n\t\t-- losse items picken en darvan serienummers scannen is niet hier. dit is alleen replenishen!\r\n\t\tif not exists( select * from w_pallet where id=@this_pallet_id and micro_pick_allowed=1)\r\n\t\tBEGIN\r\n\t\t\tEXEC sp_api_modal_input @name = '@replenish_loc', @value = @replenish_loc OUT \r\n\t\t\tEXEC sp_api_modal_button @name='@button_replenish',@value = 'Replenish NOW', @valueout = @button_replenish OUT,@class='btn-danger'\r\n\t\t\tif @button_replenish is null return\t\r\n\t\t\tif @replenish_loc is NULL\r\n\t\t\tBEGIN\r\n\t\t\t\texec sp_api_modal_text N'De POSITIE CODE voor de replenishmentlokatie is verplicht!'\r\n\t\t\t\treturn\r\n\t\t\tEND\r\n\t\t\t\r\n\t\t\t--update w_pallet set micro_pick_allowed=1,position_code=@replenish_loc where id=@this_pallet_id\r\n\t\t\t--update wms_micro_outbound_lines set scanned_pallet_id=@this_pallet_id where id=@pallet_mol_id\r\n\t\t\t-- is hieronder\r\n\t\t\texec sp_api_modal_clear\r\n\t\t\r\n\t\tEND\r\n\r\n\r\n\t\tupdate top(1) wms_micro_outbound_lines \r\n\t\t\tset scanned_pallet_id = @this_pallet_id\r\n\t\t\t\t,chk=1\r\n\t\t\t\t,remark='pick' --231006 van replenish naar pick\r\n\t\t\twhere ( scanned_pallet_id is null or scanned_pallet_id=@this_pallet_id)\r\n\t\t\t\tand id = @pallet_mol_id\r\n\t\t\r\n\t\tupdate w_pallet \r\n\t\t\tset micro_pick_allowed=1 \r\n\t\t\t\t,position_code=@replenish_loc--'rick'\r\n\t\t\twhere id=@this_pallet_id\t\t\r\n\r\n\t\tdeclare @assign_micro_items int =(select amount from wms_micro_outbound_lines where id=@pallet_mol_id)\r\n\t\twhile isnull(@assign_micro_items,0) >0\r\n\t\tBEGIN\r\n\t\t\tupdate top(1) wms_micro_item set w_pallet_pick_id=@pipa, wms_MICRO_OUTBOUND_LINES_ID=@pallet_mol_id where wms_micro_item.w_pallet_id=@this_pallet_id and w_pallet_pick_id is null\r\n\t\t\t--exec sp_api_toast N'  ** ITEM **'\r\n\t\t\t--exec sp_api_toast @this_pallet_id\r\n\t\t\t--exec sp_api_toast @pipa\r\n\t\t\tset @assign_micro_items = @assign_micro_items -1\r\n\t\tEND\t\r\n\t\treturn\r\n\tEND\r\n\r\n\texec sp_api_modal_text N'gelukt'\r\n\t\r\n\r\n\r\n\tset @this_SP= (select scanned_pallet_id from q_wms_micro_outbound_lines \r\n\t\t\t\t\twhere wms_micro_outbound_id=@mob \r\n\t\t\t\t\t\tand remark='replenish' \r\n\t\t\t\t\t\tand exists( select 1 from w_pallet where id=scanned_pallet_id and micro_pick_allowed=1)\r\n\t\t\t\t\t) \r\n\tif @this_SP is not NULL\r\n\tBEGIN\r\n\t\tdelete from #list where scanned_pallet_id=@this_SP and remark='replenish'\t\t\t\r\n\tEND\t\t\r\n\t\t\t\t\r\n\t\r\n\t----------------------------------------------------------------------------------------------------\r\n\t-- 231002 ALS ER NOG IETS GEREGELD MOET WORDEN BIJ REPLENISHMENT, DAN NIET VERDER. => EERST REGELEN! \r\n\t----------------------------------------------------------------------------------------------------\t\t\t\t\t\r\n\t--exec sp_api_modal_restart--231130\r\n\tEXEC sp_api_modal_value @name='@button_gearriveerd_bij_pallet' --231130 wis allleen deze waarde\r\n\tEXEC sp_api_modal_value @name='@ps' --231130 wis allleen deze waarde\r\n\t--exec sp_api_modal_restart--231130\r\n\treturn\r\nEND --REPLENISH PALLETS HALEN VAN BULK\r\n\r\n\r\n----------------------------------------------------------------------------------------------------\r\n-- 231010 VOLLE PALLETS PAKKEN VAN BULK EN KOPPELEN AAN DE MOL VAN DEZE OUTBOUND\r\n----------------------------------------------------------------------------------------------------\t\t\t\t\t\r\n\r\ndrop table if exists #fpa \r\ndrop table if exists #fpalist\r\n\r\nselect top 1 --231130 2x top 1 !!!\r\n\tp_pick.w_lot_id\r\n\t,pick_pal_id=p_pick.id\r\n\t,w_lot.container_number\r\n\t,adv_full_pos\r\n\t,p_pick.pallet_nr \r\n\t,mol.xstock_id\r\n\t,mol.id\r\n\t,mol.preferred_pallet_ids\r\n\t,mol.scanned_pallet_id\r\n\t,T=concat(N'Ga naar lokatie '\r\n\t\t\t\t--240826,upper(mol.adv_full_pos) --240826 voorheen: dit is een lokatie van een pallet die uit de container komt \r\n\t\t\t\t,isnull ((select position_code from w_pallet where id=p_pick.id) --niew: dit er voor gezet..12:05\r\n\t\t\t\t\t\t,upper(mol.adv_full_pos) --240826 nu baseren op de prefrerred pallet!\r\n\t\t\t\t\t\t)\r\n\t\t\t\t,' en haal daar'\r\n\t\t\t\t\t--240122 was,' en haal daar Pallet ',p_pick.pallet_nr\r\n\t\t\t\t\t--eventueel willekeurig als de preferred_pallet al in gebruik is.. \r\n\t\t\t\t\t, case \r\n\t\t\t\t\t\twhen exists(select 1 from wms_micro_outbound_lines where scanned_pallet_id=mol.preferred_pallet_ids)\r\n\t\t\t\t\t\tthen ' een Pallet'\r\n\t\t\t\t\t\telse concat(' Pallet ',p_pick.pallet_nr)\r\n\t\t\t\t\t\tend\r\n\t\t\t\t\t\r\n\t\t\t\t\t,' met ',p_pick.colli,' colli'--231130\r\n\t\t\t\t\t,' van container ',upper(w_lot.container_number)\r\n\t\t\t\t\t,'. Artikel: ', upper(mol.lookupcode) \r\n\t\t\t\t\t)--* \r\n\t,remark --is dus 'full'\t\t\t\t\t\t\t\r\n\t,mol_amount=mol.amount\t\t--231130\r\ninto #fpa \r\nfrom q_wms_micro_outbound_lines mol\r\n\t\t\tjoin w_lot on w_lot.id=mol.w_lot_id\r\n\t\t\tjoin w_pallet p_pick \r\n\t\t\t\t\ton p_pick.id=try_cast(preferred_pallet_ids as int) \r\n\t\t\t\t\t\t--dwing af dat de pallet uit de opgegeven mol-container komt\r\n\t\t\t\t\t\tand p_pick.w_lot_id=mol.w_lot_id\r\n\t\t\twhere mol.wms_micro_outbound_id=@mob \r\n\t\t\t\tand remark='full' \r\n\t\t\t\tand (\r\n\t\t\t\t\tscanned_pallet_id is null \r\n\t\t\t\t\t-- dit is alleen bij replenishment pallets !!!or NOT exists( select 1 from w_pallet where id=scanned_pallet_id and micro_pick_allowed=1)\r\n\t\t\t\t\t)\r\n--dev test select * from #modal_report \r\n--live \r\nselect * into #fpalist from #fpa  --FULL PALLET LIST\r\nif exists(select 1 from #fpalist) exec sp_api_modal_text N'VOLLE PALLETS OUTBOUND',@class='h1'\r\nset @T = NULL\r\nif exists(select 1 from #fpa)\r\nBEGIN\r\n\tSet @T='<ul>'--start lijst\r\nEND\r\n\r\nwhile exists(select 1 from #fpa)\r\nBEGIN\r\n\tset @this_id=(select top 1 id from #fpa)\r\n\tset @T=concat(@T,'<li>',(select T from #fpa where id=@this_id),'</li>')\r\n\tdelete from #fpa where id=@this_id\r\nEND\r\nif @T >''--lijst afsluiten\r\nBEGIN\r\nset @t=concat(@T,'</ul>')\r\nexec sp_api_modal_html @T\r\nEND\r\n\r\nWHILE exists(select 1 from #fpalist) --bevat volle pallets die op de outbound mee gaan\r\nBEGIN -- 231004 REPLENISH PART\r\n\t--exec sp_api_modal_table @tmptable=N'#mr',@print=1,@excel=1 -- output to react client\r\n\tEXEC sp_api_modal_button @name='@button_gearriveerd_bij_pallet',@value = 'Ik ben bij de pallet', @valueout = @button_gearriveerd_bij_pallet OUT,@class='btn-danger',@key='Enter'\r\n\tif @button_gearriveerd_bij_pallet is null RETURN\r\n\t--scan pallet-sticker\r\n\texec sp_api_modal_text N'scan pallet sticker'\r\n\tEXEC sp_api_modal_input @name = '@ps', @value = @ps OUT ,@focus=1\r\n\r\n\tif @ps is null return\r\n\tif left(@ps,3)<>'ps:'\r\n\tBEGIN\r\n\t\texec sp_api_modal_text N'Dit is geen Tracy pallet sticker QR code'\r\n\t\tRETURN\r\n\tEND\t\r\n\r\n\r\n\tset @this_pallet_id=right(@ps,len(@ps)-3)\r\n\tif  not exists(select * from w_pallet where id=@this_pallet_id and w_lot_id in(select w_lot_id from #fpalist) )\r\n\tBEGIN\r\n\t\tif  exists(select * from wms_micro_outbound_lines where scanned_pallet_id=@this_pallet_id )\r\n\t\tBEGIN --231009 pallet is er al.\r\n\t\t\texec sp_api_modal_text N'Deze pallet is al gescand en toegevoegd.'\r\n\t\tEND\t\r\n\t\telse BEGIN\t\r\n\t\t\texec sp_api_modal_text N'Dit is een pallet uit een ** VERKEERDE ** container'\r\n\t\tEND\r\n\t\texec sp_api_modal_beep 1100, 500 --error !\r\n\t\t--set @T=concat('pallet lot: ',(select w_lot_id from w_pallet where id=@this_pallet_id and w_lot_id in(select w_lot_id from #fpalist) ))\r\n\t\t--exec sp_api_modal_text @T\r\n\t\t--exec sp_api_modal_table @tmptable=N'#modal_report',@print=1,@excel=1 -- output to react client\r\n\t\tRETURN\r\n\tEND\r\n\r\n\tif  not exists(select * from w_pallet p where p.id=@this_pallet_id \r\n\t\t\t\t\t\t--  and xstock_id in(select xstock_id from #fpalist) \r\n\t\t\t\t\t\t--\tand xstock_id in(select xstock_id from #list) \r\n\t\t\t\t\t\tand exists(select 1 from #fpalist where #fpalist.xstock_id=p.xstock_id and #fpalist.mol_amount = p.colli) --de gekozen FULL PALLET pallet exact het opgegeven colli-aantal hebben 231130!!\r\n\t\t\t\t\t)\r\n\tBEGIN\r\n\t\texec sp_api_modal_text N'(2)Dit is ** NIET ** de juiste pallet. => Wel juiste container, maar verkeerd artikel (of CPP onjuist)!'\r\n\t\texec sp_api_modal_beep 1100, 500 --error !\r\n\t\t--set @T=concat('pallet lot: ',(select w_lot_id from w_pallet where id=@this_pallet_id and w_lot_id in(select w_lot_id from #fpalist) ))\r\n\t\t--exec sp_api_modal_text @T\r\n\t\t--exec sp_api_modal_table @tmptable=N'#modal_report',@print=1,@excel=1 -- output to react client\r\n\t\t\t\t\t--exec sp_api_modal_restart --2311390 extra probeersel..\r\n\t\t\t\t\t--EXEC sp_api_modal_values_clear @ignore='@uuid' --231130 KEEP SCANNED QR\r\n\t\t\t\t\texec sp_api_modal_value @name=N'@button_gearriveerd_bij_pallet'\r\n\t\t\t\t\texec sp_api_modal_value @name=N'@ps'\r\n\t\t\t\t\t--exec sp_api_modal_restart--231130 --er bij proberen!!\r\n\t\tRETURN\r\n\tEND\r\n\r\n\r\n\t--we zitten nu absoluut op een pallet uit de juiste container en met het juiste artikel\r\n\t-- voorbereiden op replenishen\r\n\texec sp_api_modal_beep 1800, 200\r\n\tset @this_pallet_type=N'FULL'\r\n\tset @this_xstock_id=(select xstock_id from w_pallet where id=@this_pallet_id)\r\n\tset @this_pal_colli=(select colli from w_pallet where id=@this_pallet_id) -- pallet heeft altijd colli en niet altijd 'items' \r\n\t--#fpalist bevat hier alleen maar full pallet regels (full pallets assignment)\r\n\r\n\r\n\tif  exists(select id from #fpalist where @this_pallet_id in (select value from string_split(preferred_pallet_ids,','))) -- gewenst\r\n\t\tOR exists(select id from #fpalist where xstock_id=@this_xstock_id and @this_pallet_id not in (select value from string_split(preferred_pallet_ids,','))  ) -- alternatief\r\n\t--***********************************\r\n\t-- HET FULL PALLET ASSIGNMENT IS HIER\r\n\t--*********************************** \r\n\tBEGIN\r\n\t\tset @pallet_mol_id=(select top 1 id from #fpalist where xstock_id=@this_xstock_id \r\n\t\t\t\t\t\t\t\tand scanned_pallet_id is null \r\n\t\t\t\t\t\t\t\tand mol_amount=@this_pal_colli --231130 collicheck er bij!\r\n\t\t\t\t\t\t\t) -- er mag maar 1 full pallet zijn voor 1 MOL\r\n\t\t--set @T=concat(N'Deze pallet (pal.nr. ',(select pallet_nr from w_pallet where id=@this_pallet_id),') als alternatief gebruiken en definitief naar \"scanned_pallet_id\" en micro pick allowed....ipv prefrerred ', (select string_agg(preferred_pallet_ids,' *** ') from #fpalist))\r\n\t\t--exec sp_api_modal_text @T\r\n\r\n\t\tif exists( select 1 from wms_micro_outbound_lines where scanned_pallet_id=@this_pallet_id)\r\n\t\tBEGIN --afbreken\r\n\t\t\tset @T=concat('Pallet nummer ',(select pallet_nr from w_pallet where id=@this_pallet_id),' is al gescand')\r\n\t\t\texec sp_api_modal_text @T\r\n\t\t\treturn\r\n\t\tend\r\n\r\n\t\t--=======================================extra 250502============================================================================\r\n\t\tif exists( select 1 from w_pallet_out po where w_pallet_id=@this_pallet_id and xlandfreight_id <> (select lf_id from mob where id=@mob))\r\n\t\tBEGIN --afbreken\r\n\t\t\tset @T=concat('Pallet nummer ',(select pallet_nr from w_pallet where id=@this_pallet_id),' staat gekoppeld aan een andere outbound vracht.')\r\n\t\t\texec sp_api_modal_text @T\r\n\r\n\t\t\t--rick een mailtje!\r\n\t\t\tSET @foutinfo = CONCAT(N'Mob: ',@mob, ' MOL: ',@mol, 'ScannedPallet: ',@this_pallet_id)\r\n\t\t\t\tEXEC sp_api_email @to = 'rick@tracy.nu,gb@tracy.nu',\r\n\t\t\t\t\t@subject = 'RWS - pallet geweigerd. Scanned pallet staat al op andere outbound vracht!',\r\n\t\t\t\t\t@Body = @foutinfo;\r\n\r\n\t\t\treturn\r\n\t\tend\r\n\t\t--=======================================extra 250502============================================================================\r\n\r\n\t\t-------------------------------------------------------------------------------------- A S S I G N   S C A N N E D    P A L L E T\r\n\t\t--oke verder\r\n\t\tupdate top(1) wms_micro_outbound_lines \r\n\t\t\tset scanned_pallet_id = @this_pallet_id\r\n\t\t\t\t,chk=1\r\n\t\t\t\t\r\n\t\t\twhere ( scanned_pallet_id is null or scanned_pallet_id=@this_pallet_id)\r\n\t\t\t\tand id = @pallet_mol_id\r\n\t\t\t\tand remark ='full' -- moet altijd al zo zijn\r\n\t\t--oude items van prefrerred pallet weghalen\r\n\t\t\r\n\t\tIF EXISTS( --GB241216\r\n\t\t\tSELECT * FROM wms_micro_outbound_lines WHERE id <> @pallet_mol_id AND preferred_pallet_ids =\r\n\t\t\t(select preferred_pallet_ids from wms_micro_outbound_lines where id=@pallet_mol_id)\r\n\t\t\t)\r\n\t\t\tBEGIN\r\n\t\t\t\tSET @foutinfo = CONCAT(N'SELECT * FROM wms_micro_outbound_lines WHERE preferred_pallet_ids = ''',\r\n\t\t\t\t\t\t(select preferred_pallet_ids from wms_micro_outbound_lines where id=@pallet_mol_id)\r\n\t\t\t\t\t,'''')\r\n\t\t\t\tEXEC sp_api_email @to = 'rick@tracy.nu,gb@tracy.nu',\r\n\t\t\t\t\t@subject = 'RWS - preferred_pallet_ids probleem!',\r\n\t\t\t\t\t@Body = @foutinfo;\r\n\r\n\t\t\t\t--250408 EVEN niet verder !\r\n\t\t\t\t--EXEC SP_API_MODAL_ALERT N'We breken even af!. Tracy heeft nu een mail om te kijken wat er is' \r\n\t\t\t\t--             RETURN \r\n\t\t\t\t-- 250408--------------------------\r\n\t\t\tEND\r\n\r\n\r\n\t\tupdate w_pallet set wms_micro_outbound_id=null\r\n\t\twhere wms_micro_outbound_id=@mob \r\n\t\tand id in (select preferred_pallet_ids from wms_micro_outbound_lines where id=@pallet_mol_id)\r\n\t\tupdate wms_micro_item \r\n\t\t\tset w_pallet_pick_id=NULL\r\n\t\t\t\t, wms_MICRO_OUTBOUND_LINES_ID=NULL\r\n\t\t\t\t,item_serial_number = null \r\n\t\t\twhere wms_MICRO_OUTBOUND_LINES_ID=@pallet_mol_id \r\n\t\t\t\r\n\r\n\t\t--nieuwe items van gekozen pallet\r\n\t\tupdate w_pallet set wms_micro_outbound_id=@mob where id =@this_pallet_id  --231108 IK NEEM AAN MOB! (er stond MOL )\r\n\t\tupdate wms_micro_item \r\n\t\t\tset w_pallet_pick_id=w_pallet_id\r\n\t\t\t\t, wms_MICRO_OUTBOUND_LINES_ID=@pallet_mol_id \r\n\t\t\twhere wms_micro_item.w_pallet_id=@this_pallet_id\r\n\t\t\t\t and w_pallet_pick_id is null -- in een heel fout geval zou er al een paar items aan een andere outbound kunnen zijn gekoppeld\r\n\t\t-- ?? return\r\n\tEND\r\n\r\n\texec sp_api_modal_text N'gelukt'\r\n\tdelete from #fpalist where id=@pallet_mol_id\r\n\t\r\n\tEXEC sp_api_modal_value @name='@button_gearriveerd_bij_pallet' --231130 wis alleen deze\r\n\tEXEC sp_api_modal_value @name='@ps' --231130 wis allleen deze waarde\r\n\t--exec sp_api_modal_restart--231130 --er bij proberen!!\r\n\treturn\r\n\t--exec sp_api_modal_restart\r\n\t\r\n\t\t\t\t\r\n\t\r\n\t----------------------------------------------------------------------------------------------------\r\n\t-- 231002 ALS ER NOG IETS GEREGELD MOET WORDEN BIJ REPLENISHMENT, DAN NIET VERDER. => EERST REGELEN! \r\n\t----------------------------------------------------------------------------------------------------\t\t\t\t\t\r\n\r\nEND --FULL PALLETS HALEN VOOR DE MICRO OUTBOUND\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n--afkappen na replenish pallets en volle pallets toekennen aan de MOL\r\n--RETURN\r\n\r\n/*\r\n\t--poortwachter\r\n\tif exists(select 1 from q_wms_micro_outbound_lines \r\n\t\t\t\twhere wms_micro_outbound_id=@mob \r\n\t\t\t\t\tand remark='replenish' \r\n\t\t\t\t\tand (\r\n\t\t\t\t\t\tscanned_pallet_id is null \r\n\t\t\t\t\t\tor NOT exists( select 1 from w_pallet where id=scanned_pallet_id and micro_pick_allowed=1)\r\n\t\t\t\t\t\t) \r\n\t\t\t)\r\n\tRETURN -- 231002 ALS ER NOG IETS GEREGELD MOET WORDEN BIJ REPLENISHMENT, DAN NIET VERDER.. EERST REGELEN! \t\t\t\r\n*/\r\n\r\n\r\n--check of er nog VOLLE PALLETS GEHAALD MOETEN WORDEN:\r\n\r\n\r\n--231006\r\nif exists(select 1 from @main_db.dbo.mob_pallets(@mob) where chk=0 or is_processed=0)\r\nbegin\r\n\t--hieronder misschien niet meer nodig.. tot NORMAAL\r\n\t--exec sp_api_toast N'n o r m a a l'\r\n\tgoto NORMAAL --231009 nu gan we serials toevoegen!!!\r\nend\t\r\n\r\n\r\n\r\n\r\n--exec sp_api_toast N'V6'\r\nif exists(select 1 from @main_db.dbo.mob_pallets(@mob) where chk=0 or is_processed=0)\r\nBEGIN\r\n--was\r\n\t--set @T=concat(N'Nog te scannen pallets: ',(select string_agg(concat(plts,' pallets op locatie ',position_code, ' met sku: ',sku, ' en cpp= ',cpp),' - ') from @main_db.dbo.mob_pallets(@mob) where chk=0 ))\r\n\t--exec sp_api_modal_text @T\r\n\t--set @T=concat(N'Scan een opgegeven pallet van de pick-instruction met ref: ',(select UPPER(out_ref) from wms_micro_outbound where id=@mob))\r\n\t--exec sp_api_modal_text @T\r\n--nu\r\n\tif exists(select 1 from wms_micro_outbound_lines where wms_micro_outbound_id=@mob and scanned_pallet_id is null) --231006 was is_processed=0)\r\n\tBEGIN\r\n\t\t--231013 was set @T=concat('Deze pallets zijn nog niet (volledig) op serienummers gescand. Haal de pallet op en Scan de pallet-stickers..','')\r\n\t\tset @T=concat('Deze pallets zijn nog opgehaald en pallet-sticker gescand.','Haal de pallet eerst op. Serienummers scannen komt later.')--niet (volledig) op serienummers gescand. Haal de pallet op en Scan de pallet-stickers..','')\r\n\t\texec sp_api_modal_text @T\r\n\t\tselect [nr~col-1]=pallet_nr\r\n\t\t\t\t,[sku~col-3]= sku\r\n\t\t\t\t--,[lookupcode~col-5]=lookupcode\r\n\t\t\t\t,[amt~col-2]=amount\r\n\t\t\t\t,[st~col-1]=chk\r\n\t\t\t\t,[ser.~col-2]=linked_serials\t\r\n\t\t\t\t,[remark~col-3]=remark\r\n\t\t\t\t\r\n\t\tinto #palnoser from q_wms_micro_outbound_lines where wms_micro_outbound_id=@mob and chk=0 --231013 was (is_processed=0 or chk=0) maar serienummers komen later!\r\n\t\texec sp_api_modal_table @tmptable=N'#palnoser'\r\n\t\t\r\n\r\n\tEND\r\n\r\n\r\nif NOT  exists(select 1 from wms_micro_outbound_lines where wms_micro_outbound_id=@mob and scanned_pallet_id is null) --231006 was is_processed=0)\r\nBEGIN\r\n\t--exec sp_api_modal_alert N'klaar (not)'\r\n\tgoto NORMAAL\r\n\treturn\r\nEND\t\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\tif 1=1\r\n\tbegin\r\n\t\t\r\n\t\tEXEC sp_api_modal_input @name = '@pal_select', @value = @pal_select OUT,@hidden=0,@select=1\r\n\t\tEXEC sp_api_modal_button @name='@pal_select_button',@value = N'Check', @valueout = @pal_select_button OUT,@class='btn-danger',@key='F5' --Enter kan niet verstoort de flow\r\n\t\tif @pal_select_button is null return\r\n\t\tif @pal_select is null return\r\n\t\tif left(@pal_select,3) <> N'ps:'\r\n\t\tBEGIN\r\n\t\t\texec sp_api_modal_text N'Dit is geen palletsticker'\r\n\t\t\treturn\r\n\t\tEND\r\n\t\t\r\n\t\t--oke verder\r\n\t\tset @this_pallet_id=right(@pal_select,len(@pal_select)-3)\r\n\t\tselect \r\n\t\t\t@this_pallet_nr=pallet_nr\r\n\t\t\t,@this_xstock_id=xStock_id\r\n\t\t\t,@this_item_lotnr=pallet_art_lotnr\r\n\t\t\t,@this_pal_colli=colli\r\n\t\tfrom w_pallet where id=@this_pallet_id\r\n\t\t--set @T=concat('scanned pallet stockid: ',@this_xstock_id)\r\n\t\t--exec sp_api_toast @T --231001\r\n\t\tset @this_sku=(select sku from xstock where id=@this_xstock_id)\r\n\t\t--set @T=concat('U heeft gekozen pallet nr: ',@this_pallet_nr)\r\n\t\t--exec sp_api_modal_text @T\r\n\r\n\t\t--declare @pallet_mol_id int =0 -- zoek het mol id die deze pallet als preferred heeft staan \r\n\t\tset @pallet_mol_id=( select top 1 id from wms_micro_outbound_lines \r\n\t\t\t\t\t\t\twhere wms_micro_outbound_id=@uuid \r\n\t\t\t\t\t\t\t\tand (@this_pallet_id in ([preferred_pallet_ids]) \r\n\t\t\t\t\t\t\t\t\tOR @this_pallet_id=[scanned_pallet_id] --(als hij al gekoppeld is aan een MOL)\r\n\t\t\t\t\t\t\t\t\t) \r\n\t\t\t\t\t\t\t)\r\n\t\t\r\n\t\tif @pallet_mol_id is not NULL -- het is een bekende pallet (id stemt overeen met preferred)!\r\n\t\tbegin\r\n\t\t\tset @mol=@pallet_mol_id\r\n\t\t\t----------------------------PICK / FULL / REPLENISH PALLET ?? -------------------\r\n\t\t\tSET @this_pallet_type=(select upper(remark) from wms_micro_outbound_lines where id=@mol)\r\n\t\t\t---------------------------------------------------------------------------------\r\n\t\t\tif (select chk from wms_micro_outbound_lines where id=@pallet_mol_id) =1\r\n\t\t\tBEGIN\r\n\t\t\t\t-- opmerking\r\n\t\t\t\tset @T=concat(N'Deze '\r\n\t\t\t\t\t\t\t\t--,( select UPPER(remark) from wms_micro_outbound_lines where wms_micro_outbound_id=@uuid and @this_pallet_id in ([preferred_pallet_ids]))\r\n\t\t\t\t\t\t\t\t,@this_pallet_type\r\n\t\t\t\t\t\t\t\t,' pallet is al definitief geselecteerd bij deze micro outbound.'\r\n\t\t\t\t\t\t\t)\r\n\t\t\t\texec sp_api_modal_text @T\r\n\t\t\t\t\r\n\r\n\t\t\t\t--inserted 231001 gelijk hier mogelijkheid om serienummers te scannen:\r\n\t\t\t\tif (select is_processed from wms_micro_outbound_lines where id=@pallet_mol_id) =1\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tset @T=concat(N'Deze pallet is volledig gescand (inc. ',(select count(*) from wms_micro_item where wms_micro_outbound_lines_id=@pallet_mol_id and item_serial_number >N''),' serienummers)')\r\n\t\t\t\t\texec sp_api_modal_text @T\r\n\t\t\t\tEND\r\n\t\t\t\telse BEGIN -- go to scan\r\n\t\t\t\t\t\r\n\t\t\t\t\tif @this_pallet_type ='FULL' --> SHOW SCAN BUTTON!\r\n\t\t\t\t\t\tgoto GOFULL\r\n\t\t\t\t\t/*\t\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\tEXEC sp_api_modal_button @name='@button_scan_serials_for_mol',@value = 'Scan serials', @valueout = @button_scan_serials_for_mol OUT,@class='btn-danger'\r\n\t\t\t\t\t\t--tot hier inserted 231001 gelijk hier mogelijkheid om serienummers te scannen:\r\n\t\t\t\t\t\tif @button_scan_serials_for_mol is null return\t\r\n\t\t\t\t\t\tif @button_scan_serials_for_mol='Scan serials' goto add_serials_to_mol --231001\r\n\t\t\t\t\tEND\r\n\t\t\t\t\t*/\t\r\n\r\n\t\t\t\t\tif @this_pallet_type ='REPLENISH' --> SHOW REPLENISH BUTTON!\r\n\t\t\t\t\t\tGOTO GOREPLENISH\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\tif @replenish_loc is null \r\n\t\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\t\tset @replenish_loc=(select pick_position from xstock where id=@this_xstock_id)\r\n\t\t\t\t\t\tEND\t\r\n\t\t\t\t\t\t--check of de replenishment al is geregistreerd op de pallet\r\n\t\t\t\t\t\t-- losse items picken en darvan serienummers scannen is niet hier. dit is alleen replenishen!\r\n\t\t\t\t\t\tif not exists( select * from w_pallet where id=@this_pallet_id and micro_pick_allowed=1)\r\n\t\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\t\tEXEC sp_api_modal_input @name = '@replenish_loc', @value = @replenish_loc OUT \r\n\t\t\t\t\t\t\tEXEC sp_api_modal_button @name='@button_replenish',@value = 'Replenish NOW', @valueout = @button_replenish OUT,@class='btn-danger'\r\n\t\t\t\t\t\t\tif @button_replenish is null return\t\r\n\t\t\t\t\t\t\tif @button_replenish='Replenish NOW' --hier evt jump naar separaat replenishment\r\n\t\t\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\t\t\tupdate w_pallet set micro_pick_allowed=1,position_code=@replenish_loc where id=@this_pallet_id\r\n\t\t\t\t\t\t\t\tupdate wms_micro_outbound_lines set scanned_pallet_id=@this_pallet_id where id=@pallet_mol_id\r\n\t\t\t\t\t\t\t\texec sp_api_modal_clear\r\n\t\t\t\t\t\t\t\t--PICKLOKATIE !!\r\n\t\t\t\t\t\t\t\t--TODO...\r\n\t\t\t\t\t\t\t\t--+ EVENTUEEL HELE REPLENISH KOP\r\n\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tEND\r\n\r\n\t\t\t\t\tEND\r\n\t\t\t\t\t*/\r\n\r\n\r\n\r\n\t\t\t\tEND\r\n\r\n\r\n\r\n\r\n\t\t\tEND\r\n\t\t\tELSE BEGIN -- dus als CHK=0\r\n\t\t\t\tset @T=concat(N'Deze ',( select UPPER(remark) from wms_micro_outbound_lines where wms_micro_outbound_id=@uuid and @this_pallet_id in ([preferred_pallet_ids])),' pallet wordt nu definitief geselecteerd voor deze micro outbound.')\r\n\t\t\t\texec sp_api_modal_text @T\r\n\t\t\t\tupdate wms_micro_outbound_lines \r\n\t\t\t\t\tset chk=1 \r\n\t\t\t\t\t\t,scanned_pallet_id = @this_pallet_id\r\n\t\t\t\twhere id=@pallet_mol_id\r\n\r\n\t\t\t\t--BUSY !\r\n\t\t\t\t--if full dan optioneel serienummers\r\n\t\t\t\t--if replenish dan lokatie\r\n\t\t\t\t\r\n\t\t\t\tEXEC sp_api_modal_button @name='@button_scan_serials_for_mol',@value = 'Scan serials', @valueout = @button_scan_serials_for_mol OUT,@class='btn-danger'\r\n\t\t\t\t\t--tot hier inserted 231001 gelijk hier mogelijkheid om serienummers te scannen:\r\n\t\t\t\t\tif @button_scan_serials_for_mol is null return\t\r\n\t\t\t\t\tif @button_scan_serials_for_mol='Scan serials' goto add_serials_to_mol --231001\r\n\t\t\t\t----231001 JUMP: (2)\r\n\t\t\t\t--set @mol=@pallet_mol_id\r\n\t\t\t\t--goto add_serials_to_mol\r\n\t\t\t\r\n\t\t\tEND\r\n\t\tend\t\r\n\t\telse begin \r\n\t\t\t--\tPallet_mol_id is null, dus gescande pallet-sticker komt niet voor op de instructie.\r\n\t\t\t--\tHet gescande pallet_id komt niet voor in preferred_pallet_id's; kijk of er een mol vrij is om gewisseld te worden\r\n\t\t\t\r\n\t\t\t--\tCheck of er nog wel 'un-assigned' pallets zijn...\r\n\t\t\tif (select count(*) from q_wms_micro_outbound_lines where wms_micro_outbound_id=@mob and isnull(chk,0)=0) =0 --240607 isnull(chk,0)\r\n\t\t\t--alle pallets zijn al toegekend\r\n\t\t\tBEGIN\r\n\t\t\t\texec sp_api_modal_text N'Alle pallets zijn al toegekend, scan de palletsticker om serienummers toe te voegen',@class='h1'\r\n\t\t\tEND\t\r\n\t\t\telse BEGIN\r\n\t\t\t\texec sp_api_modal_text N'Deze pallet staat ** NIET ** in de instructie. Kies de juiste pallet of geef aan welke pallet van de pick-instructie u wilt vervangen.'\r\n\t\t\t\tif NOT exists(select * from wms_micro_outbound_lines where wms_micro_outbound_id=@mob and chk=0 and xstock_id=@this_xstock_id ) --230930 toon alleen een vervangbare pallet_mol als deze hetzelfde artikel heeft!\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\t--set @T=concat(N'Er is ** GEEN ** vervangbare pallet, bevat de zojuist gescande pallet wel het bedoelde artikel? (vergelijk met de pick-instructie)','' )\r\n\t\t\t\t\tset @T=concat(N'Onjuiste pallet!. Scan een ** ANDERE PALLET ** (zie de pick-instructie)','' )\r\n\t\t\t\t\texec sp_api_modal_text @T\r\n\t\t\t\t\treturn --231001\r\n\t\t\t\tEND\r\n\t\t\t\telse BEGIN\r\n\t\t\t\t\tdeclare @replacement_mol_id int --op deze mol wordt een andere pallet uitgeboekt dan oorspronkelijk 'preferred'\r\n\t\t\t\t\t--laat de user een pallet kiezen die op de mol vervangen wordt door de gecande pallet\r\n\t\t\t\t\t/*\t\t--toon tabel:\r\n\t\t\t\t\t\t\texec sp_api_modal_text N'Kies de pallet die u vervangt door de nu gescande pallet:'\r\n\t\t\t\t\t\t\tselect \r\n\t\t\t\t\t\t\t[sku~col-sm-2]=sku\r\n\t\t\t\t\t\t\t,[lookupcode~col-sm-2]=lookupcode\r\n\t\t\t\t\t\t\t,[remark~col-sm-2]=remark\r\n\t\t\t\t\t\t\t,pos=case remark when 'full' then adv_full_pos else adv_pick_pos end\r\n\t\t\t\t\t\t\t,pal_nr=(select pallet_nr from w_pallet where id in (select value from string_split(preferred_pallet_ids,',')))\r\n\t\t\t\t\t\t\tinto #mol \r\n\t\t\t\t\t\t\t\tfrom q_wms_micro_outbound_lines \r\n\t\t\t\t\t\t\t\twhere wms_micro_outbound_id=@mob \r\n\t\t\t\t\t\t\t\t\tand chk=0 \r\n\t\t\t\t\t\t\t\t\tand xstock_id=@this_xstock_id --230930 toon alleen een vervangbare pallet_mol als deze hetzelfde artikel heeft!\r\n\t\t\t\t\t\t\texec sp_api_modal_table @tmptable=N'#mol'\r\n\t\t\t\t\t--*/\t\t\r\n\t\t\t\t\t--/*\r\n\t\t\t\t\t-- maak de keuzelijst van beschikbare micro_outbound_lines die een zelfde artikel bevatten als de gescande pallet en die nog niet aangescand zijn (chk=0)\r\n\t\t\t\t\tdeclare @list nvarchar(4000)\r\n\t\t\t\t\tset @T=concat('thispalcolli: ',@this_pal_colli)\r\n\t\t\t\t\texec sp_api_toast @T\r\n\t\t\t\t\tset @list=(\r\n\t\t\t\t\t\t\tSELECT STRING_AGG(concat(left(concat(mol.id,'          '),10)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t, ' ',upper(mol.remark)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t, ' ',replace(mol.sku,',',';'),' - ',replace(mol.lookupcode,',',';')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,' pal.nr: ',p.pallet_nr\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t,' colli: ',p.colli\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\t\t\t\t, ','\r\n\t\t\t\t\t\t\t\t\t\t\t) --LET OP: GEEN KOMMA GEBRUIKEN !!!\r\n\t\t\t\t\t\t\tFROM q_wms_micro_outbound_lines mol\r\n\t\t\t\t\t\t\tCROSS APPLY STRING_SPLIT(mol.preferred_pallet_ids, ',') split_val\r\n\t\t\t\t\t\t\tJOIN w_pallet p ON p.id = CAST(split_val.value AS INT)\r\n\t\t\t\t\t\t\tWHERE mol.chk = 0 \r\n\t\t\t\t\t\t\t\tAND mol.wms_micro_outbound_id =@mob \r\n\t\t\t\t\t\t\t\t--? dit check ik zondag wel als ik het niet vergeet, want ik moet nu bikkelen met sassie \r\n\t\t\t\t\t\t\t\t--231001\r\n\t\t\t\t\t\t\t\tAND mol.xstock_id =@this_xstock_id --is not null --=@this_xstock_id --230930 toon alleen een vervangbare pallet_mol als deze hetzelfde artikel heeft!\r\n\t\t\t\t\t\t\t\tAND (mol.remark='replenish' OR (mol.amount=@this_pal_colli))\r\n\t\t\t\t\t\t)\r\n\t\t\t\t\t\r\n\t\t\t\t\t--pre declare: @button_choose_pal\r\n\t\t\t\t\tEXEC sp_api_modal_text N'Kies een pallet die vervangen wordt door de gescande pallet:',@class='h1'  --je zie de pallet die oorspronkelijk op de mol bedoeld was; maar eigenlijk kiezen we de MOL om er vervolgens de gescande (alternatieve) pallet aan te koppelen\r\n\t\t\t\t\t\r\n\t\t\t\t\t--/*\r\n\t\t\t\t\t\t-- LIST:EXEC sp_api_modal_choose_list @list = @list\r\n\t\t\t\t\t\t--BUTTONS:\r\n\t\t\t\t\t\tEXEC sp_api_modal_choose @list = @list\r\n\t\t\t\t\t\t,@value = @button_choose_pal OUT\r\n\t\t\t\t\t\t--,@startkey=3 --function key starting number\r\n\t\t\t\t\t\tif @button_choose_pal is not NULL\r\n\t\t\t\t\t\tBEGIN\t\r\n\t\t\t\t\t\t\tset @replacement_mol_id=left(@button_choose_pal,10) --eerste stukje is het mol_id\r\n\t\t\t\t\t\t\t--exec sp_api_toast @button_choose_pal\r\n\t\t\t\t\t\t\tif not exists(select 1 from wms_micro_outbound_lines where id=@replacement_mol_id)\r\n\t\t\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\t\t\texec sp_api_modal_alert N'Er is iets verkeerd gegaan met de selectie!!'\r\n\t\t\t\t\t\t\t\treturn\r\n\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\t\t--oke verder\r\n\t\t\t\t\t\t\tupdate wms_micro_outbound_lines \r\n\t\t\t\t\t\t\t\tset chk=1 \r\n\t\t\t\t\t\t\t\t,scanned_pallet_id = @this_pallet_id\r\n\t\t\t\t\t\t\twhere id=@replacement_mol_id\r\n\t\t\t\t\t\t\tset @mol=@replacement_mol_id\r\n\r\n\t\t\t\t\t\t\tset @this_pallet_type=(select UPPER(remark) from wms_micro_outbound_lines where id=@replacement_mol_id)\r\n\r\n\t\t\t\t\t\tEND\t\r\n\t\t\t\t\t--*/\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\tEND\t\r\n\t\t\tEND --de else\r\n\t\tend\t\r\n\t\t--exec sp_api_modal_alert @this_pallet_id --231001 TEST !!\r\n\t\treturn\r\n\tend\t\t\r\nEND\r\n\r\n\r\n--240607 was: \r\nRETURN -- EVEN AFKAPPEN ..........\r\n--nu:\r\n--if not exists(select 1 from code_mob_serials where mob_id=@uuid and amount<>codes) RETURN\r\n\r\n--240607 nu dus dus doorgaan naar scannen als er nog serienummers niet gekoppeld zijn..\r\n\r\n\r\nNORMAAL:\r\nexec sp_api_modal_text N'Scannen van items:'\r\nEXEC sp_api_modal_choose @list = N'alles,onvoltooid,volle_pallets',@value = @button_choose2 OUT\r\nif @button_choose2 is null return--set @button_choose2='onvoltooid'\t\r\n--exec sp_api_toast @uuid\r\n--MOBILE ACTION EXTRA CODE\r\n--set @button_choose2='onvoltooid'\r\nif @button_choose2='volle_pallets'\r\n\tbegin\r\n\t\texec sp_api_modal_text N'scan de labels van deze volle pallets: '\r\n\t\tselect id, pallet_label into #sfp from pallet_status where id in (select preferred_pallet_ids from wms_micro_outbound_lines where wms_micro_outbound_id=@uuid) --scanned full pallets\r\n\t\texec sp_api_modal_table @tmptable=N'#sfp'\r\n\t\treturn\r\n\tEND\r\nif @button_choose2='alles'\r\n\tbegin\r\n\t\t\r\n/*\t\tset @mol=(select top 1 id from q_wms_micro_outbound_lines mol\r\n\t\t\twhere mol.wms_micro_outbound_id =@uuid\r\n\t\t\t --AND\t(select count(*) from wms_micro_outbound_line_barcode where wms_micro_outbound_lines_id=mol.id)<mol.Amount\r\n\t\t\tand (select scan_serial_number_outbound from xstock where id=(mol.xstock_id)) = 1 -- ER MOET SERIAL GESCAND WORDEN\r\n\t\t\t--ALLES and mol.is_processed =0 -- als deze door de loods op 1 wordt gezet\r\n\t\t\torder by adv_pick_pos\r\n\t\t)  \r\n\t\t\r\n\t\tset @t=concat('mol:',@mol,N' alles')\r\n\t\texec sp_api_modal_text @t\r\n*/\r\n\t\t--exec sp_api_modal_alert @UUID\r\n\t\t--select * into #mol from Q_wms_micro_outbound_lines where wms_micro_outbound_id = @uuid\r\n\t\t/*\r\n\t\tselect  \r\n\t\t\t--is_processed,\r\n\t\t\t--container_number,\r\n\t\t\t--linked_amount,\r\n\t\t\tlinked_SERIALS as [serials@~col-sm-1],\r\n\t\t\tsku\r\n\t\t\t--lookupcode,\r\n\t\t\t\r\n\t\t\t into #mol \r\n\t\t\tfrom q_wms_micro_outbound_lines where wms_micro_outbound_id=@uuid--3297\r\n\t\texec sp_api_modal_table @tmptable=N'#mol'\t,@print=1\r\n\t\treturn\r\n\t\t*/\r\n\r\n\t\tselect [amt~col-2]=items, [sku~col-6]=sku, [ser_head~col-4]=left5 into #mob_info from mob_scan_info where mob_id=@uuid\r\n\t\texec sp_api_modal_table @tmptable=N'#mob_info'\t,@print=1, @orderby=N' order by 2'\r\n\t\treturn\r\n\r\n\t\t--exec sp_api_modal_clear\r\n\r\n\tend\r\n\r\nif @button_choose2='onvoltooid'\r\n\tbegin\r\n\t\t--infolijstje\r\n\t\tselect [mol_id~col-3]=ID -- nozzels per 240611\r\n\t\t\t\t,[pal_nr~col-3]=(select pallet_nr from w_pallet where id=scanned_pallet_id)\r\n\t\t\t\t,[scanned_pallet_id~col-6]=scanned_pallet_id\r\n\t\t\t\tinto #lijstje_onvoltooid\r\n\t\t\t\tfrom q_wms_micro_outbound_lines mol\r\n\t\t\twhere scanned_pallet_id is not NULL --240611 ! erbij moet een scanned pallet zijn voor deze mol selectie!\r\n\t\t\t\tAND remark <> 'pick' --240611 1433\r\n\t\t\t\tAND mol.wms_micro_outbound_id =@uuid\r\n\t\t\t--AND\t(select count(*) from wms_micro_outbound_line_barcode where wms_micro_outbound_lines_id=mol.id)<mol.Amount\r\n\t\t\t-- 230907 items zonder serienummer moeten wel SKU SCAN KRIJGEN... and (select scan_serial_number_outbound from xstock where id=(mol.xstock_id)) = 1 -- ER MOET SERIAL GESCAND WORDEN\r\n\t\t\tand (\r\n\t\t\t\t\tmol.is_processed =0 -- als deze door de loods op 1 wordt gezet\r\n\t\t\t\t\tOR\r\n\t\t\t\t\t--linked_serials <> amount\r\n\t\t\t\t\tlinked_amount <> amount --230901 dit betekent dat de (auto)assign nog niet compleet is (misschien nor replenish pallet maken etc.)\r\n\t\t\t\t)\t\r\n\t\tif (select count(*) from #lijstje_onvoltooid)>0 --if er voorgezet 240611\t\t\r\n\t\tBEGIN\r\n\t\t\texec sp_api_modal_table @tmptable=N'#lijstje_onvoltooid',@print=0\t\t\r\n\t\t\r\n\r\n\t\t\t--scan pallet-sticker\r\n\t\t\texec sp_api_modal_text N'scan de pallet sticker een van de genoemde pallets'\r\n\t\t\tEXEC sp_api_modal_input @name = '@ps', @value = @ps OUT ,@focus=1\r\n\t\t\t--but_10 er bij\r\n\t\t\tEXEC sp_api_modal_button @name='@but_10',@value = 'Check', @valueout = @but_10 OUT,@class='btn-danger',@key='Enter'; if @but_10 is NULL return\r\n\t\t\tif @ps is null return\r\n\t\t\tif left(@ps,3)<>'ps:'\r\n\t\t\tBEGIN\r\n\t\t\t\texec sp_api_modal_text N'Dit is geen Tracy pallet sticker QR code'\r\n\t\t\t\t--exec sp_api_modal_restart--231130\r\n\r\n\t\t\t\tRETURN\r\n\t\t\tEND\t\r\n\t\t\r\n\r\n\t\t\tset @this_pallet_id=right(@ps,len(@ps)-3)\r\n\t\t\tif not exists(select 1 from #lijstje_onvoltooid where [scanned_pallet_id~col-6]=@this_pallet_id)\r\n\t\t\tBEGIN\r\n\t\t\t\texec sp_api_modal_text 'Fout, deze pallet staat niet in de lijst..'\r\n\t\t\t\treturn\r\n\t\t\tEND\r\n\t\t\tELSE\r\n\t\t\tBEGIN\r\n\t\t\t\t-- zet @mol\r\n\t\t\t\tset @mol=(select [mol_id~col-3] from #lijstje_onvoltooid where [scanned_pallet_id~col-6]=@this_pallet_id )\r\n\t\t\tEND\r\n\t\t\t\r\n\t\t\t--einde infolijstje\r\n\t\tEND\r\n\t\tif @mol is null --fallback naar top 1 \r\n\r\n\t\tset @mol=(select top 1 id from q_wms_micro_outbound_lines mol\r\n\t\t\twhere mol.wms_micro_outbound_id =@uuid\r\n\t\t\t--AND\t(select count(*) from wms_micro_outbound_line_barcode where wms_micro_outbound_lines_id=mol.id)<mol.Amount\r\n\t\t\t-- 230907 items zonder serienummer moeten wel SKU SCAN KRIJGEN... and (select scan_serial_number_outbound from xstock where id=(mol.xstock_id)) = 1 -- ER MOET SERIAL GESCAND WORDEN\r\n\t\t\tand (\r\n\t\t\t\t\tmol.is_processed =0 -- als deze door de loods op 1 wordt gezet\r\n\t\t\t\t\tOR\r\n\t\t\t\t\t--linked_serials <> amount\r\n\t\t\t\t\tlinked_amount <> amount --230901 dit betekent dat de (auto)assign nog niet compleet is (misschien nor replenish pallet maken etc.)\r\n\t\t\t\t)\t\r\n\t\t\torder by adv_pick_pos\r\n\t\t)\r\n\t\t--set @t=concat('1:',@mol); exec sp_api_toast @T\r\n\t\tset @no_serials =(select case (select scan_serial_number_outbound from xstock where id=(select xstock_id from wms_micro_outbound_lines where id=@mol)) when 1 then 0 else 1 end)\r\n\t\t\r\n\t\t--set @t=concat('mol:',@mol,N' nog verwerken..',case when @no_serials=1 then '**NO SERIALS**' else '' end) --indicator dat er geen serienummers nodig zijn\r\n\t\t--240610\r\n\t\tset @t=concat('mol:',@mol,N' pallet nr: ',(select pallet_nr from w_pallet where id=(select scanned_pallet_id from wms_micro_outbound_lines where id=@mol)),N' op deze pallet nog ',(select l_items\t- isnull(serial_items,0) from mol where mol_id=@mol),' verwerken..',case when @no_serials=1 then '**NO SERIALS**' else '' end) --indicator dat er geen serienummers nodig zijn\r\n\t\t\r\n\t\texec sp_api_modal_text @T\r\n\t\t \r\n\tend\r\n\r\n\r\n\r\nif @mol is null \r\n\tbegin\r\n\t\texec sp_api_modal_alert N'Scan serienummers is voltooid.' --231130 was sp_api_modal_text\r\n\t\texec sp_api_modal_clear\r\n\t\tRETURN\r\n\tend\t\r\n\r\n--230918 extra dummyscan voor deze @mol, want inmiddels kan een pallet ge-replenished zijn waardoor het aantal micro-items inmiddels volledig beschikbaar is\r\n\texec auto_assign_wms_micro_items_to_wms_micro_outbound_line @LINE_id=@mol\r\n\texec assign_pallets_to_micro_outbound_from_line\t@Line =@mol\r\n------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n\r\nselect @xstock_id=xstock_id, @aantal_serials_nodig = amount  from wms_micro_outbound_lines where id=@mol\r\n\r\nselect * into #registered_serials from wms_micro_outbound_line_barcode where wms_micro_outbound_lines_id=@mol\r\nif (select count(*) from #registered_serials)>=@aantal_serials_nodig\r\n\tbegin\r\n\t\tset @T=concat(N'Er is al gescand.','')\r\n\t\texec sp_api_modal_text @T\r\n\t\tset @T=concat(N'Aantal gescande codes:',(select count(*) from wms_micro_outbound_line_barcode where wms_micro_outbound_lines_id=@mol))\r\n\t\texec sp_api_modal_text @T\r\n\t\t--exec sp_api_modal_table @tmptable=N'#registered_serials'\r\n\t\t--exec sp_api_modal_alert @uuid\r\n\t\tEXEC sp_api_modal_button @name='@button5',@value = 'Meer Scannen', @valueout = @button5 OUT,@class='btn-danger',@key='F9'\r\n\t\tif isnull(@button5,N'')<>N'Meer Scannen'\r\n\t\treturn\r\n\tend\t\r\n\r\n \r\n\r\n\r\nif isnull(@sku_oke,0)\t=0\r\n\tbegin\r\n\t\tset @T=concat(N'pickpositie: ',(select top 1 position_code from pallet_status where micro_pick_allowed=1 and xstock_id=@xstock_id and out_completed is null))\r\n\t\texec sp_api_modal_text @T, @class='h1'\r\n\t\tSET @T=concat(N'Aantal: ',@aantal_serials_nodig,'. Artikelomschrijving: ',(select lookupcode from xstock where id=@xstock_id))\r\n\t\texec sp_api_modal_text @T\r\n\t\tSET @T=concat(N'Scan de SKU: ',(select sku from xstock where id=@xstock_id))--, ' en ', @aantal_serials_nodig,' serienummers'\t)\r\n\t\texec sp_api_modal_text @T\r\n\t\t\r\n\t\tEXEC sp_api_modal_input @name = '@sku_check', @value = @sku_check OUT,@hidden=0,@focus=1 --, @type='textarea',@rows=20--,@inline = 1 -- (multi line input)\r\n\t\tEXEC sp_api_modal_button @name='@button3',@value = N'Check', @valueout = @button3 OUT,@class='btn-danger',@key='F5' --Enter kan niet verstoort de flow\r\n\t\tif @button3 is null return\r\n\t\tif @sku_check is null return\r\n\t\texec sp_api_modal_text @sku_check\r\n\t\t\r\n\tend\t\t\r\nif not exists(select 1 from wms_micro_outbound_lines mol \r\n\t\t\t\tjoin xstock s on s.id= mol.xStock_id \r\n\t\t\t\twhere mol.id=@mol and \r\n\t\t\t\t\t(\r\n\t\t\t\t\t\ttrim(s.sku)=trim(@sku_check) \r\n\t\t\t\t\t\tor \r\n\t\t\t\t\t\t--230912 OOK EAN TOESTAAN I.P.V. SKU ALS ER GEEN SERIENUMMERS GESCAND HOEVEN TE WORDEN\r\n\t\t\t\t\t\t( trim(s.EAN_CODE)>N'' AND @no_serials =1 AND trim(s.EAN_CODE)=trim(@sku_check) )\r\n\t\t\t\t\t)\r\n\t\t\t\t)\r\n\tBEGIN\r\n\t\tset @T=concat(@sku_check,' is de SKU van een verkeerd artikel.')\r\n\t\t--231128 beep er bij\r\n\t\texec sp_api_modal_beep 1100, 500 --error !\r\n\r\n\t\texec sp_api_toast @T --N'* VERKEERD ARTIKEL ! *'\r\n\t\tEXEC sp_api_modal_value @name = '@sku_check',@value = NULL\r\n\t\tEXEC sp_api_modal_value @name = '@button3',@value = NULL\r\n\t\tset @SKU_OKE=0\r\n\t\treturn\r\n\tEND\r\nset @sku_oke=1\r\n\r\n\r\n------231001-------\r\nadd_serials_to_mol:\r\n---- L A B E L ----\r\n--exec sp_api_toast N'serials to mol...'--231130\r\n--231001 als hier heen wordt gesprongen kan het zijn dat @no_serials onbekend is..\r\nset @no_serials =(select case (select scan_serial_number_outbound from xstock where id=(select xstock_id from wms_micro_outbound_lines where id=@mol)) when 1 then 0 else 1 end)\r\n\r\n\r\nset @T=concat(N'NOG: ',@aantal_serials_nodig - (select count(*) from wms_micro_outbound_line_barcode where wms_micro_outbound_lines_id=@mol),' serienummers. (save=bijwerken)')\r\nexec sp_api_modal_text @T\r\n\r\n\r\n--extra 230907\r\nif @no_serials =1 \r\n\tBEGIN\r\n\t\tset @scanned_codes='no serials required'\r\n\t\t--set @button =N'Save'\r\n\tEND\r\n\t\t--oud: voor 230907\r\n--> set @scanned_codes= (select serialnumbers from wms_micro_outbound_lines where id=@mol)\t\t--231211 NIEUW ER VOOR..\r\nEXEC sp_api_modal_input @name = '@scanned_codes', @value = @scanned_codes OUT , @type='textarea',@rows=8, @focus=1 --,@inline = 1 -- (multi line input)\r\nEXEC sp_api_modal_button @name='@button',@value = 'Save', @valueout = @button OUT,@class='btn-danger',@key='F6'\r\nif @button is null return; --231211 extra wacht op button\r\n\r\nif @button='Save' -- opslaan, zodat je ze niet kwijt raakt \r\n\tBEGIN\r\n\t\tif @scanned_codes > N''\r\n\t\t\tBEGIN\r\n\t\t\t\tif @no_serials =0 --NORMALE SITUATIE MET SERIENUMMERS VERPLICHTING\r\n\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\t-- log, is al 2x een lifesaver geweest!\r\n\t\t\t\t\t\tupdate wms_micro_outbound_lines set serialnumbers=concat(serialnumbers,@scanned_codes) where id=@mol--=@ID\r\n\r\n\t\t\t\t\t\t-- unieke barcodes registreren bij de micro outbound line\r\n\t\t\t\t\t\t--declare @scanned_codes nvarchar(max) = (select top 1 serialnumbers from wms_micro_outbound_lines where nullif(trim(serialnumbers),N'') is not null)\r\n\t\t\t\t\t\t--select serialnumbers,*  from wms_micro_outbound_lines where nullif(trim(serialnumbers),N'') is not null\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\t--krijg de unieke codes uit de scans en \r\n\t\t\t\t\t\tselect line from scanresult_as_table(@scanned_codes) \r\n\t\t\t\t\t\t\twhere nullif(trim(line),N'') is not NULL --\tzonder blanco regels!\r\n\t\t\t\t\t\t\t\t-- evt lengrte afdwingen and len(line) >15\r\n\t\t\t\t\t\t\tgroup by line -- maak uniek\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\t--select * from \r\n\t\t\t\t\t\t--declare @mol int=297\r\n\t\t\t\t\t\tinsert into wms_micro_outbound_line_barcode(wms_micro_outbound_lines_id,Line)\r\n\t\t\t\t\t\t\tselect @mol, line\r\n\t\t\t\t\t\t\tfrom _1\r\n\t\t\t\t\t\t\tcross apply ( select line from scanresult_as_table(@scanned_codes) \r\n\t\t\t\t\t\t\t\t\t\t\twhere nullif(trim(line),N'') is not NULL --\tzonder blanco regels!\r\n\t\t\t\t\t\t\t\t\t\t\t\t-- evt lengte afdwingen and len(line) >15\r\n\t\t\t\t\t\t\t\t\t\t\tgroup by line -- maak uniek\r\n\t\t\t\t\t\t\t\t\t\t) sr\r\n\t\t\t\t\t\t\twhere --beter pas bij toekennen beperken, want zo blijft deze scan-actie redelijk universeel  len(sr.line) >13 and --230823 zo hebben we geen last van de EAN CODES VAN AGNEOVO\r\n\t\t\t\t\t\t\t\tnot exists(select 1 from wms_micro_outbound_line_barcode where Line=sr.line)\r\n\r\n\t\t\t\t\t\t-- select * from wms_micro_outbound_line_barcode\r\n\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t--EXEC sp_api_modal_button @name='@button2',@value = 'Klaar', @valueout = @button2 OUT,@class='btn-danger',@key='F7'\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t--set @T=concat(N'Aantal gescande codes:',(select count(*) from wms_micro_outbound_line_barcode where wms_micro_outbound_lines_id=@mol))\r\n\t\t\t\t\t\t--exec sp_api_modal_text @T\r\n\t\t\t\t\t\t\t--select * into #unique from wms_micro_outbound_line_barcode where wms_micro_outbound_lines_id=@mol\r\n\t\t\t\t\t\t\t--exec sp_api_modal_table @tmptable=N'#unique'\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t--GELIJK TOEKENNEN\r\n\t\t\t\t\t\texec assign_scanned_serials_to_micro_items \r\n\t\t\t\t\t\t\t\t@mob=@uuid -- KOPPEL DE MICRO ITEMS (en verwijder eventueel de overscans)\r\n\t\t\t\t\t\t\t\t,@remove_unassigned =1\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tEND\t--(OPLSAAN MET SERIENUMMER VERWERKEN)\r\n\t\t\t\t--AUTOMATISCH KLAARBOEKEN PER MOL\r\n\t\t\t\tif @no_serials =1 --230907 altijd conform bij NO SERIALS\r\n\t\t\t\t\t--bijserienummers moet het aantal overeenkomen\r\n\t\t\t\t\tor exists (select 1 from q_wms_micro_outbound_lines where id=@mol and linked_serials=Amount) -- volledig toegekend! was: @button2=N'Klaar' \r\n\t\t\t\t\tbegin\r\n\t\t\t\t\t\tupdate wms_micro_outbound_lines set is_processed =1 where id=@mol  -- 230824 op processed zetten,zodat de volgende gekozen kan worden..\r\n\t\t\t\t\t\t--230828 dit verwijdert de scans die niet geloppeld zijn aan items.\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t--exec sp_api_modal_alert N'items volledig gescand, scan QR voor eventueel volgende items.'\t\r\n\t\t\t\t\t\texec sp_api_toast N'items volledig gescand, scan QR voor eventueel volgende items.'\t\r\n\t\t\t\t\t\t--exec sp_api_modal_restart --231130 ipv clear\r\n\t\t\t\t\t\t--exec sp_api_modal_value @name=N'@button_gearriveerd_bij_pallet'\r\n\t\t\t\t\t\texec sp_api_modal_clear --231211 er bij\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\t\t--EXEC sp_api_modal_values_clear -- @ignore = N'company'\r\n\t\t\t\t\t\t-- voor alert gezet exec sp_api_modal_clear\r\n\t\t\t\t\t\t--EXEC sp_api_modal_restart --230907 proberen..\r\n\t\t\t\t\tend\t\r\n\t\t\t\t\r\n\t\t\tEND\r\n\t\t--EXEC sp_api_modal_value @name = '@button',@value = NULL \t\t--231211 save button un-clicken\t\r\n\t\t--EXEC sp_api_modal_value @name = '@sku_ok',@value = NULL\t\t\t--231211\r\n\t\t--EXEC sp_api_modal_value @name = '@sku_check',@value = NULL\t\t--231211\r\n\t\t--EXEC sp_api_modal_value @name = '@scanned_codes',@value = NULL\t--231211\r\n\t\t--return\t\r\n\t\texec sp_api_modal_clear --restart--231211 test restart ! clear --230907\t--als je hier niet cleart, dan kan je tussendoor opslaan..\r\n\t\treturn\r\n\tend\r\n\r\n----------------------\r\n-- LABELS\r\n----------------------\r\nexec sp_api_modal_clear -- 231211 TEST ER BIJ \r\nRETURN\r\nGOFULL:\r\nif @this_pallet_type ='FULL' --> SHOW SCAN BUTTON!\r\nBEGIN\r\n\tEXEC sp_api_modal_button @name='@button_scan_serials_for_mol',@value = 'Scan serials', @valueout = @button_scan_serials_for_mol OUT,@class='btn-danger'\r\n\t--tot hier inserted 231001 gelijk hier mogelijkheid om serienummers te scannen:\r\n\tif @button_scan_serials_for_mol is null return\t\r\n\tif @button_scan_serials_for_mol='Scan serials' goto add_serials_to_mol --231001\r\nEND\r\nRETURN --GOFULL\r\n\r\nGOREPLENISH:\r\nif @this_pallet_type ='REPLENISH' --> SHOW REPLENISH BUTTON!\r\nBEGIN\r\n\tif @replenish_loc is null \r\n\tBEGIN\r\n\t\tset @replenish_loc=(select pick_position from xstock where id=@this_xstock_id)\r\n\tEND\t\r\n\t--check of de replenishment al is geregistreerd op de pallet\r\n\t-- losse items picken en darvan serienummers scannen is niet hier. dit is alleen replenishen!\r\n\tif not exists( select * from w_pallet where id=@this_pallet_id and micro_pick_allowed=1)\r\n\tBEGIN\r\n\t\tEXEC sp_api_modal_input @name = '@replenish_loc', @value = @replenish_loc OUT \r\n\t\tEXEC sp_api_modal_button @name='@button_replenish',@value = 'Replenish NOW', @valueout = @button_replenish OUT,@class='btn-danger'\r\n\t\tif @button_replenish is null return\t\r\n\t\tif @button_replenish='Replenish NOW' --hier evt jump naar separaat replenishment\r\n\t\tBEGIN\r\n\t\t\tif nullif(trim(@replenish_loc),N'') is NULL\r\n\t\t\tBEGIN\r\n\t\t\t\texec sp_api_modal_text N'REPLENISHMENT LOCATION REQUIRED'\r\n\t\t\t\tRETURN\r\n\t\t\tEND\r\n\t\t\tupdate w_pallet set micro_pick_allowed=1,position_code=@replenish_loc where id=@this_pallet_id\r\n\t\t\tupdate wms_micro_outbound_lines set scanned_pallet_id=@this_pallet_id where id=@pallet_mol_id\r\n\t\t\texec sp_api_modal_clear\r\n\t\t\t--PICKLOKATIE !!\r\n\t\t\t--TODO...\r\n\t\t\t--+ EVENTUEEL HELE REPLENISH KOP\r\n\t\tEND\r\n\tEND\r\nEND\t\r\nRETURN --GOREPLENISH\r\n\r\n\r\n\t\t\t\t\r\n\r\n\r\n/*\r\n----231001----\r\nreplenish_mol:\r\n----LABEL-----\r\nupdate w_pallet set micro_pick_allowed=1 where id=\r\nreturn\r\n*/\r\n\r\n/* --230821 RESET UITGESCHAKELD\r\nEXEC sp_api_modal_button @name='@button4',@value = 'Reset', @valueout = @button4 OUT,@class='btn-danger',@key='F8'\r\n\r\nif @button4=N'Reset'\r\n\tBEGIN\r\n\t\tdelete from wms_micro_outbound_line_barcode where wms_micro_outbound_lines_id=@mol\r\n\t\tEXEC SP_API_MODAL_CLEAR\r\n\t\tEXEC sp_api_modal_value @name = '@button4',@value = NULL\r\n\tend\r\n*/\r\n-- als het aantal in #unique overeenkomt met het aantal nog te vullen serienummers dan kunnen ze worden toegekend\r\n\t",
            "action_id": 692,
            "action_name": "#qr_action_verwerk_micro_pick_v11",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-----------------------------------------------------------------------------\r\n-- global action check_serial_number; kijkt of een serienummer al is gebruikt\r\n/*\r\n\tpre declare:\r\n\t@item_serial_number, @button\r\n*/\r\n-----------------------------------------------------------------------------\r\nexec #breed100\r\nEXEC sp_api_modal_input @name = '@item_serial_number', @value = @item_serial_number OUT --,@inline = 1\r\nEXEC sp_api_modal_button @name='@button',@value = 'Check', @valueout = @button OUT,@class='btn-danger',@key='Enter'\r\nif @button is not NULL\r\nBEGIN\r\n\tselect top 20\r\n\ti.lookupcode,\ti.sku,\ti.position_code,\ti.container_number,\ti.wms_micro_outbound_id,\ti.out_ref,\ti.item_serial_number,\ti.remark,mol=i.wms_micro_outbound_lines_id,\ti.item_lotnr,mob.date as out_date\r\n\tinto #T\r\n\tfrom q_wms_micro_item i\r\n\t\tleft join q_wms_micro_outbound mob on mob.id=wms_micro_outbound_id\r\n\twhere item_serial_number like concat(@item_serial_number,'%')\r\n\t \r\n\texec sp_api_modal_table @tmptable=N'#T'\r\nEND\t",
            "action_id": 700,
            "action_name": "check_serial_number",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_menu_info_params \t@card_id\r\n\t,@id\r\n\t,@ids\r\n\t,@basetable\r\n\t,@tablename\r\n\t,@identity_column\r\n\t,@parent_card_id\r\n\t,@parent_id\r\n\t,@path\r\n\t,@previous_path\r\n\t,@is_new\r\n\t,@user_id\r\n\t,@is_form\r\n\t,@hostname\r\n\t,@is_picklist\r\n\t,@picklist_fieldname\r\n\t,@picklist_type\r\n\t,@card_field_id\r\n\t,@card_name\r\n\t,@parent_card_name\r\n\t,@parent_parent_id\r\n\t,@user_name\r\n\t,@user\r\n\t,@uri\r\n\t,@selected_field_name\r\n\t,@origin\r\n\t,@current_card_action_id",
            "action_id": 701,
            "action_name": "sys_menu_info_params",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC [sp_sys_menu_info_data_browser] @card_id = @card_id, @id = @id",
            "action_id": 707,
            "action_name": "sys_menu_info_data_browser",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_menu_info_context",
            "action_id": 708,
            "action_name": "sys_menu_info_context",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_menu_info_field_history @tablename = @tablename,@selected_field_name = @selected_field_name,@ids = @ids,@is_form = @is_form",
            "action_id": 709,
            "action_name": "sys_menu_info_field_history",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-----------------------------------------------------------------------------\r\n-- global action check_serial_number; kijkt of een serienummer al is gebruikt\r\n/*\r\n\tpre declare:\r\n\t@item_serial_number, @button\r\n*/\r\n-----------------------------------------------------------------------------\r\nexec #breed100\r\nEXEC sp_api_modal_input @name = '@item_serial_number', @value = @item_serial_number OUT --,@inline = 1\r\nselect w_pallet_id, a=count(*) into #double_out from w_pallet_out group by w_pallet_id having count(*) >1\r\nif exists(select 1 from #double_out)\r\nBEGIN\r\n\texec sp_api_modal_html N'<h2>Er zijn dubbele out-registraties, dan kan/mag nooit</h2>'\r\n\texec sp_api_modal_table @tmptable=N'#double_out' ,@print=1\r\nEND\r\n\r\n\r\nEXEC sp_api_modal_button @name='@button',@value = 'Check', @valueout = @button OUT,@class='btn-danger',@key='Enter'\r\nif @button is not NULL\r\nBEGIN\r\n\tselect top 20\r\n\ti.lookupcode,\ti.sku,\ti.position_code,\ti.container_number,\ti.wms_micro_outbound_id,\ti.out_ref,\ti.item_serial_number,\ti.remark,\ti.item_lotnr,mob.date as out_date\r\n\tinto #T\r\n\tfrom q_wms_micro_item i\r\n\t\tleft join q_wms_micro_outbound mob on mob.id=wms_micro_outbound_id\r\n\twhere item_serial_number like concat(@item_serial_number,'%')\r\n\t \r\n\texec sp_api_modal_table @tmptable=N'#T'\r\nEND\t",
            "action_id": 714,
            "action_name": "check_data",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_menu_admin_add_cards",
            "action_id": 715,
            "action_name": "sys_menu_admin_add_cards",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_children @card_id",
            "action_id": 716,
            "action_name": "sys_children",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--\t_tracy_outbound-scanner-podcast\r\n--\tin main menu, add this: \t```  EXEC sp_api_modal_action @name='RWS-podcast'  ```\r\nexec sp_api_modal_text N'Listen to the deep dive podcast about Rotterdam Warehouse Solutions',@class='h4'\r\nEXEC sp_api_modal_audio @url = N'https://apis.tsql.app/storage/fn7sbi8mls7stkabcoxwpzmukhqwpzh3', @autoplay = 0, @controls = 1\r\n\r\nEXEC sp_api_modal_text N'click Quit/Exit button to end the action.'\r\nDECLARE @ButtonQuit nvarchar(128)\r\nEXEC sp_api_modal_get_value @name='@ButtonQuit', @value=@ButtonQuit OUT;\r\nEXEC sp_api_modal_button \r\n\t@name='quit',\r\n\t@value='Quit this Action', \r\n\t@class='btn-secondary', \r\n\t@valueout=@ButtonQuit OUT;\r\n\r\nIF @ButtonQuit IS NOT NULL\r\nBEGIN\r\n\t--SET @Quit = 1;\r\n\tEXEC sp_api_modal_clear;\r\n\tRETURN;\r\nEND",
            "action_id": 723,
            "action_name": "RWS-podcast",
            "source_table": "api_actions"
        },
        {
            "sql_source": "--241018 niet compleet...\r\n-- 2 bewerkingsactie zijn uitgeschakeld (loskoppelen items en instructie glad trekken)\r\n-- error met select..\r\n\r\n\r\n\r\nEXEC sp_api_modal_text @text=N'TSQL.APP Verwijder micro items van gereedstaande micro outbound',@class='h4'\r\n\r\n\r\n\tEXEC sp_api_modal_text N'kies een outbound'\r\n\tDECLARE @mob_id -- please rename @mob_id to your situation\r\n\t\tNVARCHAR(MAX); EXEC sp_api_modal_get_value @name='@mob_id', @value=@mob_id OUT;\t\r\n\t\r\n\tSELECT id, name=out_ref INTO #tmp FROM wms_micro_outbound\r\n\tEXEC sp_api_modal_select_table @tmptable = '#tmp', @value = @mob_id OUT ,@no_isam = 1\r\n\t\t\r\n/*\t\r\n\tDECLARE @but_mob --(ctrl-f to rename)\r\n\t\t\tNVARCHAR(MAX); EXEC sp_api_modal_get_value @name='@but_mob', @value=@but_mob OUT; \t\t\t\r\n\t\t\r\n\t-- do something and wait for button\r\n\t\t\r\n\tEXEC sp_api_modal_button @name='@but_mob',@value = 'verder...', @valueout = @but_mob OUT, @class='btn-danger' \r\n\t\t--,@key='Enter'\t\t\r\n\tIF @but_mob IS NULL RETURN\t--button needs to be clicked to continue, otherwise action code ends here..\r\n*/\t\t\r\n\t--exec sp_api_modal_alert N'kappen'\r\n\t--er is nu een mob, kies een mol\r\n\tEXEC sp_api_modal_text N'kies een regel van de outbound'\r\n\tDECLARE @mol_id \tNVARCHAR(MAX); EXEC sp_api_modal_get_value @name='@mol_id', @value=@mol_id OUT;\t\r\n\t\r\n\tSELECT id, name=concat(Amount,' - ',sku) INTO #mol FROM q_wms_micro_outbound_lines where wms_micro_outbound_id=@mob_id\r\n\tEXEC sp_api_modal_select_table @tmptable = '#mol', @value = @mol_id OUT ,@no_isam = 1\r\n\t\t\r\n\t\r\n\tDECLARE @but_mol\t\tNVARCHAR(MAX); EXEC sp_api_modal_get_value @name='@but_mol', @value=@but_mol OUT; \t\t\t\r\n\t\t\r\n/*\t\t\r\n\tEXEC sp_api_modal_button @name='@but_mol',@value = 'verder na mol kiezen...', @valueout = @but_mol OUT, @class='btn-danger' \r\n\t\t--,@key='Enter'\t\t\r\n\tIF @but_mol IS NULL RETURN\t--button needs to be clicked to continue, otherwise action code ends here..\r\n*/\t\r\n\r\n\r\n\r\n\r\n\r\n\tDECLARE @t NVARCHAR(MAX) = CONCAT('Selected outbound is : ',(SELECT concat(id,' ',out_ref) from wms_micro_outbound where id=@mob_id))\r\n\tEXEC sp_api_modal_text @text=@t, @class='h2'\r\n\r\n\tIF @mol_id is null -- niet direct een mob geselecteerdopgegeven\r\n\tBEGIN\r\n\t\tEXEC sp_api_modal_text N'of geef een gescand serienummer'\r\n\t\tDECLARE @input nvarchar(max); EXEC sp_api_modal_get_value @name='@input', @value=@input OUT;\t\r\n\t\tDECLARE @input_button \tnvarchar(max); EXEC sp_api_modal_get_value @name='@input_button', @value=@input_button OUT;\t\t\t\r\n\t\tEXEC sp_api_modal_input @name = '@input', @value = @input OUT \r\n\r\n\t\tEXEC sp_api_modal_button @name='@input_button',@value = 'Confirm input', @valueout = @input_button OUT,@class='btn-danger'--,@key='Enter'\t\t\r\n\t\tIF @input_button IS NULL RETURN\t--input is required, otherwise action code ends here..\r\n\t\tEXEC sp_api_toast @input--, @speech=@input\r\n\t\t--input snippet ends here\r\n\r\n\t\t\r\n\t\tselect @mol_id=(select top 1 wms_micro_outbound_lines_id from wms_micro_item where item_serial_number=@input)\r\n\t\t\r\n\t\tif @mol_id is null return\r\n\t\t--exec sp_api_modal_alert @mol_id\r\n\tEND\r\n\tselect * into #u from wms_micro_item where wms_micro_outbound_lines_id=@mol_id\r\n\t--test exec sp_api_modal_table @tmptable=N'#u',@print=1\r\n\r\n\r\n\r\nDECLARE @var01 \r\n\t\tNVARCHAR(MAX); EXEC sp_api_modal_get_value @name='@var01', @value=@var01 OUT;\t\r\nDECLARE @selected_ids nvarchar(128)\r\n\r\nDECLARE @multi bit = 1\r\nDECLARE @use_table bit = 1\r\n\r\n--exit button (action ends)\r\nDECLARE @exit nvarchar(max); EXEC sp_api_modal_get_value @name='@exit',@value = @exit OUT \r\nEXEC sp_api_modal_button @name='@exit',@value = 'Exit', @valueout = @exit OUT,@class='btn-danger',@key='Esc'\r\nIF @exit is not NULL\r\nBEGIN\r\n\tEXEC sp_api_modal_clear\r\nEND\t\r\n--prepare table and list\r\nSELECT id=id, name=item_serial_number, selected=0  INTO #tmptable FROM #u order by item_serial_number\r\n\r\n\r\n\r\nif @use_table =1 -- gebruik dan de table\r\nBEGIN\r\n\tEXEC sp_api_modal_choose \r\n\t\t@value = @var01 OUT \r\n\t\t,@multi = @multi --1 --allow multiple values\r\n\t\t,@tmptable = '#tmptable'\r\n\tSET @T=concat('selected: ',@var01)\r\n\tEXEC sp_api_modal_text @T\t\r\n\tEXEC sp_api_modal_table @tmptable=N'#tmptable'\r\nEND\r\n\r\nIF exists (select 1 from #tmptable where selected=1) \r\nBEGIN\r\n\tDECLARE @but_del_micro \tNVARCHAR(MAX); EXEC sp_api_modal_get_value @name='@but_del_micro', @value=@but_del_micro OUT; \t\t\t\r\n\t\t\r\n\tEXEC sp_api_modal_button @name='@but_del_micro',@value = 'verwijder de geselecteerde micro items van de outbound', @valueout = @but_del_micro OUT, @class='btn-danger' \r\n\t\t--,@key='Enter'\t\t\r\n\tIF @but_del_micro IS NOT NULL\r\n\tBEGIN\r\n\t\tEXEC sp_api_modal_alert N'zeker weten???'\r\n\t\tdeclare @IDS_lijst nvarchar(max)=(select concat(id,',') from #tmptable where selected=1)\r\n\t\tEXEC sp_api_modal_alert @t\r\n\t\t\r\n\t\t\r\n\t\t--------------------------------------------------------------\r\n\t\t-- koppeling_intrekken\r\n\t\t-- action: https://rws.tsql.app/apicard/3545/card_actions/4809\r\n\t\t--\r\n\t\t--------------------------------------------------------------\r\n\t\t/* --aan/uit\r\n\t\tupdate wms_micro_item \r\n\t\t\tset w_pallet_pick_id = NULL\t\r\n\t\t\t\t,wms_micro_outbound_lines_id = NULL\r\n\t\t\t\t,item_serial_number =null\r\n\t\twhere id in ({@IDS_lijst})\t\r\n\t\t--*/\r\n\t\t-- en tevens:\r\n\r\n\t\t--------------------------------------------------------------\r\n\t\t--\thttps://rws.tsql.app/apicard/3570/card_actions/6014\r\n\t\t-- change_amount (met terugkoppeling naar de mob_instruction)\r\n\t\t--\tlet op : mag alleen maar op deze manier!\r\n\t\t-- 240328 open voor directie\r\n\t\t--------------------------------------------------------------\r\n\r\n\t\tif (select remark from wms_micro_outbound_lines where id=@mol_id) = N'full' --@user <> N'rick@tracy.nu'\r\n\t\tbegin\r\n\t\t\texec sp_api_modal_alert N'Mag alleen bij losse items; geen volle pallets...'\r\n\t\t\treturn\r\n\t\tend\t\r\n\r\n\r\n\t\tdeclare @amount int\r\n\t\tif @mob_id is NULL\r\n\t\tBEGIN\r\n\t\t\texec sp_api_toast N'GEEN MICRO OUTBOUND'\r\n\t\t\treturn\r\n\t\tEND\r\n\r\n\t\tset @amount=(select amount from wms_micro_outbound_lines where id=@mol_id) - (select af=count(*) from #tmptable where selected=1)\r\n\t\texec sp_api_modal_alert @amount\r\n\t\tRETURN\r\n\r\n\r\n\t\t--execute sp_api_toast @amount\r\n\t\t/* --TEST !!!!\r\n\t\tif @amount>=0\r\n\t\tBEGIN\r\n\t\t\tupdate wms_micro_outbound_lines set  amount =@amount where id=@id\r\n\t\t\tupdate q_mob_instruction set amount=amount-mol_diff where amount >= 0 AND mol_diff<>0 AND wms_micro_outbound_id=@mob_id\r\n\t\tEND\r\n\t\t*/\r\n\r\n\t\tEXEC sp_api_modal_clear\r\n\t\tRETURN\r\n\r\n\t\t\r\n\tEND\r\n\r\nEND\r\n\r\n\r\n\r\n\r\n\r\n-- Add 'Quit' button\r\nexec sp_api_modal_text N'click Quit/Exit button to end the action.'\r\nDECLARE @ButtonQuit nvarchar(128)\r\nEXEC sp_api_modal_get_value @name='@ButtonQuit', @value=@ButtonQuit OUT;\r\nEXEC sp_api_modal_button \r\n\t@name='quit',\r\n\t@value='Quit this Action', \r\n\t@class='btn-secondary', \r\n\t@valueout=@ButtonQuit OUT;\r\n\r\nIF @ButtonQuit IS NOT NULL\r\nBEGIN\r\n\t--SET @Quit = 1;\r\n\tEXEC sp_api_modal_clear;\r\n\tRETURN;\r\nEND\r\n\t",
            "action_id": 730,
            "action_name": "rick_delete",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_modal_report_from_view",
            "action_id": 731,
            "action_name": "sys_report_from_view",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_select_text",
            "action_id": 732,
            "action_name": "sys_select_text",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-----------------------------------------------------------------------------\r\n-- global action check_serial_number; kijkt of een serienummer al is gebruikt\r\n/*\r\n\tpre declare:\r\n\t@container_number, @button\r\n\r\n\tselect top 50 wms_item_sku, in_completed, out_completed,lf_out_ref,mob_out_ref=mob.out_ref, warehouse_code, pallet_nr,position_code,container_number,pallet_label,* \r\nfrom pallet_status \r\n--left join xlandfreight lfo on lfo.id=lf_out_id\r\nleft join wms_micro_outbound mob on mob.id =wms_micro_outbound_id\r\nwhere in_completed=1\r\n*/\r\n-----------------------------------------------------------------------------\r\nexec #breed100\r\nexec sp_api_modal_text N'# Pallet info per container '\r\n--![](https://apide2.tsql.app/rws/storage/fshtstdkp5n7xgsawybvsbxuoavm2fby)'\r\n,@markdown=1\r\nDECLARE @container_number NVARCHAR(MAX); EXEC sp_api_modal_get_value @name='@container_number', @value=@container_number OUT;\t--rename @container_number to match with your code\r\nDECLARE @button NVARCHAR(MAX); EXEC sp_api_modal_get_value @name='@button', @value=@button OUT;\t--rename @button to match with your code\r\nEXEC sp_api_modal_input @name = '@container_number', @value = @container_number OUT --,@inline = 1\r\n\r\n\r\nEXEC sp_api_modal_button @name='@button',@value = 'Check', @valueout = @button OUT,@class='btn-danger',@key='Enter'\r\n\r\n\r\nif @button is not NULL\r\nBEGIN\r\nselect top 100 [cont**]=container_number, wms_item_sku, [in_compl~col-sm-1-2]=in_completed, [out_compl~col-sm-1-2]=out_completed,lf_out_ref,mob_out_ref=mob.out_ref, warehouse_code, [pal_nr~col-sm-1-2]=pallet_nr,[pos_code~col-sm-1-2]=position_code,container_number,[pal_label~col-sm-3]=pallet_label\r\ninto #t\r\nfrom pallet_status \r\n--left join xlandfreight lfo on lfo.id=lf_out_id\r\nleft join wms_micro_outbound mob on mob.id =wms_micro_outbound_id\r\nwhere container_number like concat('%',@container_number,'%')\r\n\t\r\n\r\nexec sp_api_modal_table @tmptable=N'#T',@print=1, @orderby=N'order by 1'\r\nEND\t",
            "action_id": 742,
            "action_name": "check_pallets",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-----------------------------------------------------------------------------\r\n-- global action check_pallets_in_stock\r\n-----------------------------------------------------------------------------\r\nexec #breed100\r\nexec sp_api_modal_text N'# Pallet Voorraad per container '\r\n--![](https://apide2.tsql.app/rws/storage/fshtstdkp5n7xgsawybvsbxuoavm2fby)'\r\n,@markdown=1\r\nDECLARE @container_number NVARCHAR(MAX); EXEC sp_api_modal_get_value @name='@container_number', @value=@container_number OUT;\t--rename @container_number to match with your code\r\nDECLARE @button NVARCHAR(MAX); EXEC sp_api_modal_get_value @name='@button', @value=@button OUT;\t--rename @button to match with your code\r\nEXEC sp_api_modal_input @name = '@container_number', @value = @container_number OUT --,@inline = 1\r\n\r\ndeclare @klant_id nvarchar(max)\r\nEXEC sp_api_modal_select @card_name = N'klant',@value = @klant_id OUT,@focus = 1\r\n\r\nEXEC sp_api_modal_button @name='@button',@value = 'Check', @valueout = @button OUT,@class='btn-danger',@key='Enter'\r\n--exec sp_api_toast @klant_id\r\n\r\nif @button is not NULL\r\nBEGIN\r\nselect --top 100 \r\n\t[cont**]=concat_ws(N' - ',container_number, (select code from xcompany where id=@klant_id))\r\n\t,[batch_nr]=pallet_art_lotnr\r\n\t, wms_item_sku, [in_compl~col-sm-1-2]=in_completed, [out_compl~col-sm-1-2]=out_completed,lf_out_ref,mob_out_ref=mob.out_ref, warehouse_code, [pal_nr~col-sm-1-2]=pallet_nr,[pos_code~col-sm-1-2]=position_code,container_number,[pal_label~col-sm-3]=pallet_label\r\ninto #t\r\nfrom pallet_status \r\n--left join xlandfreight lfo on lfo.id=lf_out_id\r\nleft join wms_micro_outbound mob on mob.id =wms_micro_outbound_id\r\nwhere \r\n\tnullif(out_completed,0) is NULL \r\n\tand container_number like concat('%',@container_number,'%')\r\n\tand client_id=isnull(@klant_id,client_id)\r\n\tand ( @user like '%RWS%' OR ffa_id IN (SELECT id from xCompany WHERE code IN (SELECT * FROM tvf_getClaim('tenant'))) ) --250107\r\n\r\nexec sp_api_modal_table @tmptable=N'#T',@print=1,@excel=1, @orderby=N'order by 1'\r\nEND\t",
            "action_id": 748,
            "action_name": "check_pallets_in_stock",
            "source_table": "api_actions"
        },
        {
            "sql_source": "-- Main control variables \r\n--DECLARE @uuid INT  =NULL                           -- Input parameter *** MOET PRE DECLARED WANT WORDT INPUT PARAMETER VOOR TMO PROC ***\r\nDECLARE @mob INT = @uuid                             -- Scan ID\r\n--DECLARE @origin NVARCHAR(1024) = NULL               -- Origin information\r\n--EXEC sp_api_modal_get_value @name='@origin', @value=@origin OUT\r\n\r\n-- Button variables\r\nDECLARE @button_choose NVARCHAR(MAX) = NULL         -- Primary choice button\r\nDECLARE @button_choose2 NVARCHAR(MAX) = NULL        -- Secondary choice button\r\nDECLARE @button_choose_pal NVARCHAR(128) = NULL     -- Pallet choice button\r\nDECLARE @button NVARCHAR(MAX) = NULL                -- Generic button\r\nDECLARE @button2 NVARCHAR(MAX) = NULL               -- Second generic button\r\nDECLARE @button3 NVARCHAR(MAX) = NULL               -- Third generic button\r\nDECLARE @button4 NVARCHAR(MAX) = NULL               -- Fourth generic button\r\nDECLARE @button5 NVARCHAR(MAX) = NULL               -- Fifth generic button\r\nDECLARE @b6 NVARCHAR(128) = NULL                    -- Sixth button\r\nDECLARE @but_10 NVARCHAR(128) = NULL                -- Tenth button\r\nDECLARE @pal_select_button NVARCHAR(128) = NULL     -- Pallet selection button\r\nDECLARE @button_scan_serials_for_mol NVARCHAR(128) = NULL  -- Serial scanning button\r\nDECLARE @button_replenish NVARCHAR(128) = NULL      -- Replenish action button\r\n\r\nEXEC sp_api_modal_get_value @name='@button_choose', @value=@button_choose OUT\r\nEXEC sp_api_modal_get_value @name='@button_choose2', @value=@button_choose2 OUT\r\nEXEC sp_api_modal_get_value @name='@button_choose_pal', @value=@button_choose_pal OUT\r\nEXEC sp_api_modal_get_value @name='@button', @value=@button OUT\r\nEXEC sp_api_modal_get_value @name='@button2', @value=@button2 OUT\r\nEXEC sp_api_modal_get_value @name='@button3', @value=@button3 OUT\r\nEXEC sp_api_modal_get_value @name='@button4', @value=@button4 OUT\r\nEXEC sp_api_modal_get_value @name='@button5', @value=@button5 OUT\r\nEXEC sp_api_modal_get_value @name='@b6', @value=@b6 OUT\r\nEXEC sp_api_modal_get_value @name='@but_10', @value=@but_10 OUT\r\nEXEC sp_api_modal_get_value @name='@pal_select_button', @value=@pal_select_button OUT\r\nEXEC sp_api_modal_get_value @name='@button_scan_serials_for_mol', @value=@button_scan_serials_for_mol OUT\r\nEXEC sp_api_modal_get_value @name='@button_replenish', @value=@button_replenish OUT\r\n\r\n-- Scanner and input variables\r\nDECLARE @sampleqrscanner NVARCHAR(MAX) = NULL       -- QR scanner input\r\nDECLARE @scanned_codes NVARCHAR(MAX)                -- Scanned code storage\r\nDECLARE @pal_select NVARCHAR(128) = NULL            -- Pallet selection input\r\nDECLARE @ps NVARCHAR(128) = NULL                    -- Pallet scan input\r\n\r\nEXEC sp_api_modal_get_value @name='@sampleqrscanner', @value=@sampleqrscanner OUT\r\nEXEC sp_api_modal_get_value @name='@scanned_codes', @value=@scanned_codes OUT\r\nEXEC sp_api_modal_get_value @name='@pal_select', @value=@pal_select OUT\r\nEXEC sp_api_modal_get_value @name='@ps', @value=@ps OUT\r\n\r\n-- Pallet-related variables\r\nDECLARE @this_pallet_id INT = 0                     -- Current pallet ID\r\nDECLARE @this_pallet_nr INT = 0                     -- Current pallet number\r\nDECLARE @this_pal_colli INT = 0                     -- Pallet colli count\r\nDECLARE @pallet_mol_id INT = NULL                   -- Micro outbound line pallet ID\r\nDECLARE @pipa INT = NULL                            -- Pallet processing ID\r\n\r\nEXEC sp_api_modal_get_value @name='@pallet_mol_id', @value=@pallet_mol_id OUT\r\nEXEC sp_api_modal_get_value @name='@pipa', @value=@pipa OUT\r\n\r\n-- Stock and item variables\r\nDECLARE @this_xstock_id INT = 0                     -- Stock ID\r\nDECLARE @xstock_id NVARCHAR(MAX) = NULL            -- Stock ID (string format)\r\nDECLARE @this_item_lotnr NVARCHAR(128)             -- Item lot number\r\nDECLARE @this_sku NVARCHAR(128)                    -- SKU identifier\r\nDECLARE @sku_check NVARCHAR(MAX) = NULL            -- SKU validation input\r\nDECLARE @sku_oke NVARCHAR(MAX) = NULL              -- SKU validation result\r\nDECLARE @aantal_serials_nodig NVARCHAR(MAX) = NULL -- Required serial numbers\r\n\r\nEXEC sp_api_modal_get_value @name='@xstock_id', @value=@xstock_id OUT\r\nEXEC sp_api_modal_get_value @name='@sku_check', @value=@sku_check OUT\r\nEXEC sp_api_modal_get_value @name='@sku_oke', @value=@sku_oke OUT\r\nEXEC sp_api_modal_get_value @name='@aantal_serials_nodig', @value=@aantal_serials_nodig OUT\r\n\r\n-- Location and type variables\r\nDECLARE @this_pallet_type NVARCHAR(128)            -- Pallet type (full, pick, replenish)\r\nDECLARE @replenish_loc NVARCHAR(128) = NULL        -- Replenishment location\r\n\r\nEXEC sp_api_modal_get_value @name='@replenish_loc', @value=@replenish_loc OUT\r\n\r\n-- Processing and status variables\r\nDECLARE @this_id INT                               -- Temp table cursor\r\nDECLARE @this_SP INT = NULL                        -- Processing status\r\nDECLARE @mol NVARCHAR(MAX) = NULL                  -- Micro outbound line\r\nDECLARE @no_serials BIT = NULL                     -- Serial number requirement flag\r\n\r\nEXEC sp_api_modal_get_value @name='@this_SP', @value=@this_SP OUT\r\nEXEC sp_api_modal_get_value @name='@mol', @value=@mol OUT\r\n\r\n-- Message and display variables\r\nDECLARE @T NVARCHAR(MAX) = NULL                    -- Temporary message storage\r\n\r\n-- Initialize notification\r\nEXEC sp_api_toast N'micro pick V11-special'\r\n\r\n-- Clear existing temporary tables\r\nDROP TABLE IF EXISTS #mr \r\nDROP TABLE IF EXISTS #list",
            "action_id": 754,
            "action_name": "#qr_action_verwerk_micro_pick_241213",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_menu_info_distinct_fields @card_id",
            "action_id": 755,
            "action_name": "sys_menu_info_distinct_fields",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_menu_info_kill_processes\r\n",
            "action_id": 756,
            "action_name": "sys_menu_info_kill_processes",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_modal_table_builder",
            "action_id": 757,
            "action_name": "sys_table_builder",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_sys_menu_info_whatsapp\r\n",
            "action_id": 758,
            "action_name": "sys_menu_info_whatsapp",
            "source_table": "api_actions"
        },
        {
            "sql_source": "EXEC sp_api_modal_modal @class=N'w100', @printStyle=N'font-size:70%', @landscape=1\r\n-- Eventueel als global action:  CTRL-ALT-E\r\n\r\n/*\r\nThis script creates an Enhanced Entity Relationship Diagram (ERD) generator for TSQL.APP. Let me explain its functionality:\r\n\r\n## Functionality Overview\r\n\r\nThis advanced card action creates an interactive database relationship diagram with accompanying documentation. It analyzes the current card's underlying table structure and visualizes:\r\n\r\n1. The current table (highlighted in red)\r\n2. Parent tables that are referenced by the current table (blue)\r\n3. Child tables that reference the current table (green)\r\n\r\nThe script goes beyond simple table relationships by:\r\n\r\n1. Discovering both database-level foreign key relationships AND application-level relationships defined in TSQL.APP's metadata\r\n2. Presenting an interactive diagram with tooltips showing relationship details\r\n3. Automatically generating markdown documentation describing all relationships\r\n4. Supporting proper navigation with a close button\r\n\r\n## Technical Implementation\r\n\r\nThe script follows TSQL.APP's mandated practices with:\r\n\r\n1. Proper variable declarations at the top\r\n2. Correct error handling with try/catch blocks\r\n3. Clean temporary table management\r\n4. Proper parameter passing to stored procedures\r\n5. Unicode compliance with N prefixes\r\n6. Appropriate state management\r\n\r\nThe diagram is rendered using the GoJS JavaScript library loaded from a CDN, with a force-directed layout that automatically positions nodes appropriately.\r\n\r\n## Key Features\r\n\r\n1. **Interactive Visualization**: The diagram is interactive with tooltips and automatic layout\r\n2. **Dual-level Relationship Discovery**: Detects both database relationships (via sys_foreign_key_columns) and application relationships (via api_card_children)\r\n3. **Color-coded Visual Hierarchy**: Uses different colors to distinguish between the current table, parent tables, and child tables\r\n4. **Comprehensive Documentation**: Auto-generates markdown documentation listing all related tables with counts and explanations\r\n5. **Clean UI**: Includes a color legend and proper navigation controls\r\n\r\nThis script would be especially useful for database administrators, developers, and analysts who need to understand table relationships within a TSQL.APP application.\r\n*/\r\n\r\n-- SECTION 1: Variable declarations (following mandated practices)\r\nDECLARE @text NVARCHAR(MAX);\r\nDECLARE @class NVARCHAR(MAX);\r\nDECLARE @html NVARCHAR(MAX);\r\nDECLARE @ButtonValue NVARCHAR(MAX);\r\nDECLARE @ButtonValueOut NVARCHAR(MAX);\r\nDECLARE @name NVARCHAR(MAX);\r\nDECLARE @description NVARCHAR(MAX);\r\n\r\n-- Business variables\r\nDECLARE @NodesJson NVARCHAR(MAX);\r\nDECLARE @LinksJson NVARCHAR(MAX);\r\nDECLARE @FinalJson NVARCHAR(MAX);\r\nDECLARE @ErrorMsg NVARCHAR(MAX);\r\nDECLARE @Message NVARCHAR(MAX);\r\nDECLARE @Title NVARCHAR(MAX);\r\nDECLARE @CurrentTable NVARCHAR(128);\r\nDECLARE @CardTitle NVARCHAR(MAX);\r\nDECLARE @TempSql NVARCHAR(MAX);\r\nDECLARE @TablesList NVARCHAR(MAX);\r\nDECLARE @RelationshipDescription NVARCHAR(MAX);\r\n\r\n-- Synchronize with modal state\r\nEXEC sp_api_modal_get_value @name=N'@ButtonValue', @value=@ButtonValue OUT;\r\n\r\n-- Begin error handling\r\nBEGIN TRY\r\n    -- Get current card info\r\n    SET @CurrentTable = ISNULL(@basetable, @tablename);\r\n    IF @CurrentTable IS NULL SET @CurrentTable = @card_name;\r\n    \r\n    -- Set title\r\n    SET @CardTitle = ISNULL(@card_name, 'Current Card');\r\n    SET @Title = N'Database ERD for ' + @CardTitle;\r\n    \r\n    -- Create temporary tables for our node and link data\r\n    IF OBJECT_ID('tempdb..#Nodes') IS NOT NULL DROP TABLE #Nodes;\r\n    CREATE TABLE #Nodes (\r\n        TableName NVARCHAR(128),\r\n        TableColor NVARCHAR(50),\r\n        Category NVARCHAR(50),\r\n        ToolTip NVARCHAR(MAX)\r\n    );\r\n    \r\n    IF OBJECT_ID('tempdb..#Links') IS NOT NULL DROP TABLE #Links;\r\n    CREATE TABLE #Links (\r\n        FromTable NVARCHAR(128),\r\n        ToTable NVARCHAR(128)\r\n    );\r\n    \r\n    -- Add the current table\r\n    INSERT INTO #Nodes (TableName, TableColor, Category, ToolTip)\r\n    VALUES (@CurrentTable, 'lightcoral', 'Current', 'Current Table: ' + @CurrentTable);\r\n    \r\n    -- Find parent tables (tables referenced by the current table)\r\n    -- Create a temporary table to store foreign key relationships\r\n    IF OBJECT_ID('tempdb..#ForeignKeyRels') IS NOT NULL DROP TABLE #ForeignKeyRels;\r\n    CREATE TABLE #ForeignKeyRels (\r\n        ParentTable NVARCHAR(128),\r\n        ParentColumn NVARCHAR(128),\r\n        ReferencedTable NVARCHAR(128),\r\n        ReferencedColumn NVARCHAR(128)\r\n    );\r\n    \r\n    -- Using sys_foreign_key_columns to find relationships\r\n    SET @TempSql = N'\r\n    INSERT INTO #ForeignKeyRels (ParentTable, ParentColumn, ReferencedTable, ReferencedColumn)\r\n    SELECT \r\n        c.name AS ParentTable,\r\n        cc.name AS ParentColumn,\r\n        p.name AS ReferencedTable,\r\n        pc.name AS ReferencedColumn\r\n    FROM sys_foreign_key_columns fk\r\n    JOIN sys_columns cc ON cc.object_id = fk.parent_object_id AND fk.parent_column_id = cc.column_id\r\n    JOIN sys_columns pc ON pc.object_id = fk.referenced_object_id AND fk.referenced_column_id = pc.column_id\r\n    JOIN sys_tables c ON c.object_id = fk.parent_object_id\r\n    JOIN sys_tables p ON p.object_id = fk.referenced_object_id\r\n    WHERE c.name = @CurrentTable OR p.name = @CurrentTable';\r\n    \r\n    EXEC sp_executesql @TempSql, N'@CurrentTable NVARCHAR(128)', @CurrentTable;\r\n    \r\n    -- Add parent tables (tables that the current table references)\r\n    INSERT INTO #Nodes (TableName, TableColor, Category, ToolTip)\r\n    SELECT DISTINCT \r\n        ReferencedTable,\r\n        'lightblue',\r\n        'Parent',\r\n        'Parent Table: ' + ReferencedTable + ' (Referenced by column: ' + ParentColumn + ')'\r\n    FROM #ForeignKeyRels\r\n    WHERE ParentTable = @CurrentTable\r\n    AND ReferencedTable <> @CurrentTable;\r\n    \r\n    -- Add links for parent relationships\r\n    INSERT INTO #Links (FromTable, ToTable)\r\n    SELECT DISTINCT \r\n        ParentTable,\r\n        ReferencedTable\r\n    FROM #ForeignKeyRels\r\n    WHERE ParentTable = @CurrentTable\r\n    AND ReferencedTable <> @CurrentTable;\r\n    \r\n    -- Find child tables (tables referencing the current table)\r\n    -- Add child tables (tables that reference the current table)\r\n    INSERT INTO #Nodes (TableName, TableColor, Category, ToolTip)\r\n    SELECT DISTINCT \r\n        ParentTable,\r\n        'lightgreen',\r\n        'Child',\r\n        'Child Table: ' + ParentTable + ' (References current table via column: ' + ParentColumn + ')'\r\n    FROM #ForeignKeyRels\r\n    WHERE ReferencedTable = @CurrentTable\r\n    AND ParentTable <> @CurrentTable;\r\n    \r\n    -- Add links for child relationships\r\n    INSERT INTO #Links (FromTable, ToTable)\r\n    SELECT DISTINCT \r\n        ParentTable,\r\n        ReferencedTable\r\n    FROM #ForeignKeyRels\r\n    WHERE ReferencedTable = @CurrentTable\r\n    AND ParentTable <> @CurrentTable;\r\n    \r\n    -- Look for app-specific relationships in api_card_children\r\n    IF OBJECT_ID('tempdb..#CardChildren') IS NOT NULL DROP TABLE #CardChildren;\r\n    CREATE TABLE #CardChildren (\r\n        ParentCard NVARCHAR(128),\r\n        ChildCard NVARCHAR(128),\r\n        RefColumn NVARCHAR(128)\r\n    );\r\n    \r\n    -- Get relationships from api_card_children\r\n    SET @TempSql = N'\r\n    INSERT INTO #CardChildren (ParentCard, ChildCard, RefColumn)\r\n    SELECT \r\n        p.name AS ParentCard,\r\n        c.name AS ChildCard,\r\n        acc.ref AS RefColumn\r\n    FROM api_card_children acc\r\n    JOIN api_card p ON acc.parent = p.id\r\n    JOIN api_card c ON acc.child = c.id\r\n    WHERE p.name = @CardTitle OR c.name = @CardTitle';\r\n    \r\n    EXEC sp_executesql @TempSql, N'@CardTitle NVARCHAR(128)', @CardTitle;\r\n    \r\n    -- Add TSQL.APP-specific parent relationships\r\n    INSERT INTO #Nodes (TableName, TableColor, Category, ToolTip)\r\n    SELECT DISTINCT \r\n        ParentCard,\r\n        'lightblue',\r\n        'Parent',\r\n        'Parent Card: ' + ParentCard + ' (App relationship via: ' + RefColumn + ')'\r\n    FROM #CardChildren\r\n    WHERE ChildCard = @CardTitle\r\n    AND ParentCard <> @CardTitle\r\n    AND NOT EXISTS (SELECT 1 FROM #Nodes WHERE TableName = ParentCard);\r\n    \r\n    -- Add links for TSQL.APP-specific parent relationships\r\n    INSERT INTO #Links (FromTable, ToTable)\r\n    SELECT DISTINCT \r\n        ChildCard,\r\n        ParentCard\r\n    FROM #CardChildren\r\n    WHERE ChildCard = @CardTitle\r\n    AND ParentCard <> @CardTitle;\r\n    \r\n    -- Add TSQL.APP-specific child relationships\r\n    INSERT INTO #Nodes (TableName, TableColor, Category, ToolTip)\r\n    SELECT DISTINCT \r\n        ChildCard,\r\n        'lightgreen',\r\n        'Child',\r\n        'Child Card: ' + ChildCard + ' (App relationship via: ' + RefColumn + ')'\r\n    FROM #CardChildren\r\n    WHERE ParentCard = @CardTitle\r\n    AND ChildCard <> @CardTitle\r\n    AND NOT EXISTS (SELECT 1 FROM #Nodes WHERE TableName = ChildCard);\r\n    \r\n    -- Add links for TSQL.APP-specific child relationships\r\n    INSERT INTO #Links (FromTable, ToTable)\r\n    SELECT DISTINCT \r\n        ChildCard,\r\n        ParentCard\r\n    FROM #CardChildren\r\n    WHERE ParentCard = @CardTitle\r\n    AND ChildCard <> @CardTitle;\r\n    \r\n    -- Convert to JSON format for the diagram\r\n    SET @NodesJson = (\r\n        SELECT \r\n            TableName AS [key],\r\n            TableColor AS [color],\r\n            Category AS [category],\r\n            ToolTip AS [tooltip]\r\n        FROM #Nodes\r\n        FOR JSON PATH\r\n    );\r\n    \r\n    SET @LinksJson = (\r\n        SELECT \r\n            FromTable AS [from],\r\n            ToTable AS [to]\r\n        FROM #Links\r\n        FOR JSON PATH\r\n    );\r\n    \r\n    -- Combine into final JSON\r\n    SET @FinalJson = N'{';\r\n    SET @FinalJson = @FinalJson + N'\"nodes\": ' + ISNULL(@NodesJson, N'[]') + N',';\r\n    SET @FinalJson = @FinalJson + N'\"links\": ' + ISNULL(@LinksJson, N'[]');\r\n    SET @FinalJson = @FinalJson + N'}';\r\n    \r\n    -- Display the title\r\n    SET @text = @Title;\r\n    EXEC sp_api_modal_text @text=@text, @class=N'h3';\r\n    \r\n    -- Add legend for node colors\r\n    SET @text = N'<div style=\"margin: 10px 0; font-size: 14px;\"><span style=\"background-color: lightcoral; padding: 2px 8px; margin-right: 10px; border: 1px solid #666;\">Current Table</span><span style=\"background-color: lightblue; padding: 2px 8px; margin-right: 10px; border: 1px solid #666;\">Parent Tables</span><span style=\"background-color: lightgreen; padding: 2px 8px; margin-right: 10px; border: 1px solid #666;\">Child Tables</span></div>';\r\n    EXEC sp_api_modal_html @name=N'legend', @html=@text, @iframe=0,@print=1;\r\n    \r\n    -- Show ERD in iframe\r\n    SET @html = N'\r\n    <!DOCTYPE html>\r\n    <html lang=\"en\">\r\n    <head>\r\n        <meta charset=\"UTF-8\">\r\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n        <title>ERD - ' + @CardTitle + N'</title>\r\n        <script src=\"https://cdnjs.cloudflare.com/ajax/libs/gojs/2.3.11/go.js\"></script>\r\n        <style>\r\n            html, body { height: 100%; margin: 0; }\r\n            #diagramDiv { width: 100%; height: 100%; background-color: #f8f9fa; }\r\n        </style>\r\n    </head>\r\n    <body>\r\n        <div id=\"diagramDiv\"></div>\r\n        <script>\r\n            // GoJS initialization\r\n            var $ = go.GraphObject.make;\r\n            var myDiagram = $(go.Diagram, \"diagramDiv\", {\r\n                \"undoManager.isEnabled\": true,\r\n                layout: $(go.ForceDirectedLayout, { \r\n                    defaultSpringLength: 100,\r\n                    defaultElectricalCharge: 100\r\n                })\r\n            });\r\n\r\n            // Define tooltips\r\n            var tooltipTemplate = $(go.Adornment, \"Auto\",\r\n                $(go.Shape, { fill: \"#FFFFCC\" }),\r\n                $(go.TextBlock, { margin: 4 },\r\n                    new go.Binding(\"text\", \"\", function(data) { return data.tooltip; }))\r\n            );\r\n\r\n            // Node template\r\n            myDiagram.nodeTemplate = $(go.Node, \"Auto\",\r\n                { \r\n                    locationSpot: go.Spot.Center,\r\n                    toolTip: tooltipTemplate\r\n                },\r\n                new go.Binding(\"location\", \"loc\"),\r\n                $(go.Shape, \"Rectangle\", { \r\n                    fill: \"lightblue\", \r\n                    strokeWidth: 2,\r\n                    width: 160,\r\n                    height: 40\r\n                },\r\n                new go.Binding(\"fill\", \"color\")),\r\n                $(go.TextBlock, { \r\n                    margin: 10, \r\n                    font: \"bold 14px sans-serif\",\r\n                    stroke: \"black\",\r\n                    width: 140,\r\n                    textAlign: \"center\",\r\n                    wrap: go.TextBlock.WrapFit\r\n                },\r\n                new go.Binding(\"text\", \"key\"))\r\n            );\r\n\r\n            // Link template\r\n            myDiagram.linkTemplate = $(go.Link,\r\n                { routing: go.Link.AvoidsNodes, corner: 5 },\r\n                $(go.Shape, { strokeWidth: 1.5 }),\r\n                $(go.Shape, { toArrow: \"Standard\", stroke: null, fill: \"black\" })\r\n            );\r\n\r\n            // Load the data\r\n            var erdData = ' + @FinalJson + ';\r\n            \r\n            // Position the current table in the center\r\n            if (erdData.nodes && erdData.nodes.length > 0) {\r\n                for (var i = 0; i < erdData.nodes.length; i++) {\r\n                    if (erdData.nodes[i].category === \"Current\") {\r\n                        erdData.nodes[i].loc = new go.Point(0, 0);\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n            \r\n            // Set the model\r\n            myDiagram.model = new go.GraphLinksModel(erdData.nodes, erdData.links);\r\n        </script>\r\n    </body>\r\n    </html>';\r\n    \r\n    -- Display the ERD using HTML iframe\r\n    EXEC sp_api_modal_html \r\n        @name=N'ERD', \r\n        @html=@html, \r\n        @iframe=1, \r\n        @height=N'768px'\r\n        ,@print=1; --'600px';\r\n    \r\n    -- Generate automatic markdown description\r\n    -- Count tables by category\r\n    DECLARE @ParentCount INT = (SELECT COUNT(*) FROM #Nodes WHERE Category = 'Parent');\r\n    DECLARE @ChildCount INT = (SELECT COUNT(*) FROM #Nodes WHERE Category = 'Child');\r\n    DECLARE @RelationshipCount INT = (SELECT COUNT(*) FROM #Links);\r\n    DECLARE @ParentTables NVARCHAR(MAX) = '';\r\n    DECLARE @ChildTables NVARCHAR(MAX) = '';\r\n    \r\n    -- Get list of parent tables\r\n    SELECT @ParentTables = @ParentTables + '- ' + TableName + CHAR(13) + CHAR(10)\r\n    FROM #Nodes \r\n    WHERE Category = 'Parent'\r\n    ORDER BY TableName;\r\n    \r\n    -- Get list of child tables\r\n    SELECT @ChildTables = @ChildTables + '- ' + TableName + CHAR(13) + CHAR(10)\r\n    FROM #Nodes \r\n    WHERE Category = 'Child'\r\n    ORDER BY TableName;\r\n    \r\n    -- Build the markdown description\r\n    SET @description = N'## Database Relationship Diagram for ' + @CurrentTable + CHAR(13) + CHAR(10) + CHAR(13) + CHAR(10);\r\n    SET @description = @description + N'This diagram shows the database relationships for the **' + @CurrentTable + '** table.' + CHAR(13) + CHAR(10) + CHAR(13) + CHAR(10);\r\n    SET @description = @description + N'### Overview' + CHAR(13) + CHAR(10);\r\n    SET @description = @description + N'- **Central table** (shown in red): ' + @CurrentTable + CHAR(13) + CHAR(10);\r\n    \r\n    IF @ParentCount > 0\r\n        SET @description = @description + N'- **Parent tables** (shown in blue): ' + CAST(@ParentCount AS NVARCHAR) + ' tables that ' + @CurrentTable + ' references' + CHAR(13) + CHAR(10);\r\n    ELSE\r\n        SET @description = @description + N'- **Parent tables**: None found' + CHAR(13) + CHAR(10);\r\n    \r\n    IF @ChildCount > 0\r\n        SET @description = @description + N'- **Child tables** (shown in green): ' + CAST(@ChildCount AS NVARCHAR) + ' tables that reference ' + @CurrentTable + CHAR(13) + CHAR(10);\r\n    ELSE\r\n        SET @description = @description + N'- **Child tables**: None found' + CHAR(13) + CHAR(10);\r\n    \r\n    SET @description = @description + N'- **Total relationships**: ' + CAST(@RelationshipCount AS NVARCHAR) + CHAR(13) + CHAR(10) + CHAR(13) + CHAR(10);\r\n    \r\n    IF @ParentCount > 0\r\n    BEGIN\r\n        SET @description = @description + N'### Parent Tables' + CHAR(13) + CHAR(10);\r\n        SET @description = @description + N'The following tables are referenced by ' + @CurrentTable + ':' + CHAR(13) + CHAR(10) + CHAR(13) + CHAR(10);\r\n        SET @description = @description + @ParentTables + CHAR(13) + CHAR(10);\r\n    END\r\n    \r\n    IF @ChildCount > 0\r\n    BEGIN\r\n        SET @description = @description + N'### Child Tables' + CHAR(13) + CHAR(10);\r\n        SET @description = @description + N'The following tables reference ' + @CurrentTable + ':' + CHAR(13) + CHAR(10) + CHAR(13) + CHAR(10);\r\n        SET @description = @description + @ChildTables + CHAR(13) + CHAR(10);\r\n    END\r\n    \r\n    SET @description = @description + N'### How to Read This Diagram' + CHAR(13) + CHAR(10);\r\n    SET @description = @description + N'- **Arrows point from** the table that contains the foreign key **to** the referenced table' + CHAR(13) + CHAR(10);\r\n    SET @description = @description + N'- **Hover over a table** to see additional information' + CHAR(13) + CHAR(10);\r\n    SET @description = @description + N'- **Tables are color-coded**: red (current table), blue (parent tables), green (child tables)' + CHAR(13) + CHAR(10);\r\n    \r\n    -- Display the markdown description\r\n    EXEC sp_api_modal_text @text=@description, @markdown=1;\r\n    \r\n    -- Add a close button\r\n    SET @ButtonValue = N'Close';\r\n    EXEC sp_api_modal_button \r\n        @name=N'@ButtonValue', \r\n        @value=@ButtonValue, \r\n        @valueout=@ButtonValueOut OUT,\r\n        @class=N'btn-secondary';\r\n    \r\n\r\n--------------------------\r\n\r\nexec sp_api_modal_text @text=@FinalJson\r\n    -- Create @MD\r\n    DECLARE @MD NVARCHAR(MAX);\r\n\r\n    -- Initialize @MD with a header\r\n    SET @MD = N'## Relationships for ' + @CurrentTable + CHAR(13) + CHAR(10) + CHAR(13) + CHAR(10);\r\n\r\n    -- Section for Parent Relationships (tables referenced by the current table)\r\n    SET @MD = @MD + N'### Parent Relationships' + CHAR(13) + CHAR(10);\r\n    IF EXISTS (SELECT 1 FROM #ForeignKeyRels WHERE ParentTable = @CurrentTable AND ReferencedTable <> @CurrentTable)\r\n    BEGIN\r\n        SELECT @MD = @MD + '- ' + @CurrentTable + ' references ' + ReferencedTable + ' via ' + ParentColumn + ' to ' + ReferencedColumn + CHAR(13) + CHAR(10)\r\n        FROM #ForeignKeyRels\r\n        WHERE ParentTable = @CurrentTable\r\n        AND ReferencedTable <> @CurrentTable;\r\n    END\r\n    ELSE\r\n    BEGIN\r\n        SET @MD = @MD + '- No parent relationships found' + CHAR(13) + CHAR(10);\r\n    END\r\n\r\n    -- Section for Child Relationships (tables referencing the current table)\r\n    SET @MD = @MD + CHAR(13) + CHAR(10) + N'### Child Relationships' + CHAR(13) + CHAR(10);\r\n    IF EXISTS (SELECT 1 FROM #ForeignKeyRels WHERE ReferencedTable = @CurrentTable AND ParentTable <> @CurrentTable)\r\n    BEGIN\r\n        SELECT @MD = @MD + '- ' + ParentTable + ' references ' + @CurrentTable + ' via ' + ParentColumn + ' to ' + ReferencedColumn + CHAR(13) + CHAR(10)\r\n        FROM #ForeignKeyRels\r\n        WHERE ReferencedTable = @CurrentTable\r\n        AND ParentTable <> @CurrentTable;\r\n    END\r\n    ELSE\r\n    BEGIN\r\n        SET @MD = @MD + '- No child relationships found' + CHAR(13) + CHAR(10);\r\n    END\r\n\r\n    -- Section for App-Specific Relationships (from api_card_children)\r\n    SET @MD = @MD + CHAR(13) + CHAR(10) + N'### App-Specific Relationships' + CHAR(13) + CHAR(10);\r\n    IF EXISTS (SELECT 1 FROM #CardChildren WHERE ChildCard = @CardTitle OR ParentCard = @CardTitle)\r\n    BEGIN\r\n        -- App-specific parent relationships\r\n        IF EXISTS (SELECT 1 FROM #CardChildren WHERE ChildCard = @CardTitle AND ParentCard <> @CardTitle)\r\n        BEGIN\r\n            SET @MD = @MD + '**Parent Relationships:**' + CHAR(13) + CHAR(10);\r\n            SELECT @MD = @MD + '- ' + @CardTitle + ' references ' + ParentCard + ' via ' + RefColumn + CHAR(13) + CHAR(10)\r\n            FROM #CardChildren\r\n            WHERE ChildCard = @CardTitle\r\n            AND ParentCard <> @CardTitle;\r\n        END\r\n\r\n        -- App-specific child relationships\r\n        IF EXISTS (SELECT 1 FROM #CardChildren WHERE ParentCard = @CardTitle AND ChildCard <> @CardTitle)\r\n        BEGIN\r\n            SET @MD = @MD + '**Child Relationships:**' + CHAR(13) + CHAR(10);\r\n            SELECT @MD = @MD + '- ' + ChildCard + ' references ' + @CardTitle + ' via ' + RefColumn + CHAR(13) + CHAR(10)\r\n            FROM #CardChildren\r\n            WHERE ParentCard = @CardTitle\r\n            AND ChildCard <> @CardTitle;\r\n        END\r\n    END\r\n    ELSE\r\n    BEGIN\r\n        SET @MD = @MD + '- No app-specific relationships found' + CHAR(13) + CHAR(10);\r\n    END\r\n\r\n\r\nexec sp_api_modal_text @text=@Md\r\n\r\n-------------------------\r\n\r\n    -- Handle button click\r\n    IF @ButtonValueOut IS NOT NULL\r\n    BEGIN\r\n        SET @Message = N'ERD closed';\r\n        EXEC sp_api_toast @text=@Message, @class=N'btn-info';\r\n        EXEC sp_api_modal_clear;\r\n        RETURN;\r\n    END\r\n    \r\nEND TRY\r\nBEGIN CATCH\r\n    -- Error handling\r\n    SET @ErrorMsg = ERROR_MESSAGE();\r\n    EXEC sp_api_toast @text=@ErrorMsg, @class=N'btn-danger';\r\n    RETURN;\r\nEND CATCH\r\n\r\n-- Clean up temporary tables\r\nIF OBJECT_ID('tempdb..#Nodes') IS NOT NULL DROP TABLE #Nodes;\r\nIF OBJECT_ID('tempdb..#Links') IS NOT NULL DROP TABLE #Links;\r\nIF OBJECT_ID('tempdb..#ForeignKeyRels') IS NOT NULL DROP TABLE #ForeignKeyRels;\r\nIF OBJECT_ID('tempdb..#CardChildren') IS NOT NULL DROP TABLE #CardChildren;",
            "action_id": 766,
            "action_name": "erd-2",
            "source_table": "api_actions"
        }
    ]
}